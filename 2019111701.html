<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="spring boot,unfinished,oauth2,spring security," />





  <link rel="alternate" href="/atom.xml" title="沂水博客" type="application/atom+xml" />






<meta name="description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta name="keywords" content="spring boot,unfinished,oauth2,spring security">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security OAuth2（未完成）">
<meta property="og:url" content="http://linyishui.top/2019111701.html">
<meta property="og:site_name" content="沂水博客">
<meta property="og:description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.jpg">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010138.jpg">
<meta property="og:updated_time" content="2020-01-02T02:23:43.403Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Security OAuth2（未完成）">
<meta name="twitter:description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linyishui.top/2019111701.html"/>





  <title>Spring Security OAuth2（未完成） | 沂水博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">沂水博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">编程和心历记录</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2019111701.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沂水">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沂水博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Security OAuth2（未完成）</h1>
        

        <div class="post-meta">
          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-17T15:53:56+08:00">
                2019-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术文档/" itemprop="url" rel="index">
                    <span itemprop="name">技术文档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,330
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  35
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Spring Security OAuth2实战练习，内容包括：等。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Spring-Security-OAuth2"><a href="#Spring-Security-OAuth2" class="headerlink" title="Spring Security OAuth2"></a><strong>Spring Security OAuth2</strong></h1><h2 id="第一节-简介"><a href="#第一节-简介" class="headerlink" title="第一节 简介"></a><strong>第一节 简介</strong></h2><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.jpg" alt="Spring Security&#39;s OAuth2结构"></p>
<hr>
<h2 id="第二节-Spring新版本迁移"><a href="#第二节-Spring新版本迁移" class="headerlink" title="第二节 Spring新版本迁移"></a><strong>第二节 Spring新版本迁移</strong></h2><p>&emsp;&emsp;OAuth 2.0客户端和资源服务器从Spring Security OAuth 2.x移动到Spring Security 5.2.x的指南。由于<a href="https://github.com/spring-projects/spring-security" title="Title" target="_blank" rel="noopener">Spring Security</a>不提供授权服务器支持，因此迁移<a href="https://github.com/spring-projects/spring-security-oauth" title="Title" target="_blank" rel="noopener">Spring Security OAuth</a>授权服务器超出了本文档的范围</p>
<h3 id="2-1-客户端-Client"><a href="#2-1-客户端-Client" class="headerlink" title="2.1 客户端 Client"></a><strong>2.1 客户端 Client</strong></h3><p>&emsp;&emsp;通过添加@EnableOAuth2Client注释可以启用Spring Security OAuth对Authorization Code flow的支持，而其他的flows则需要构造并公开OAuth2ClientContext实例。</p>
<p>&emsp;&emsp;Spring Security的OAuth 2.0 Client则是通过oauth2Client的DSL方法启用支持的。</p>
<h4 id="2-1-1-RestTemplate-and-WebClient"><a href="#2-1-1-RestTemplate-and-WebClient" class="headerlink" title="2.1.1 RestTemplate and WebClient"></a><strong>2.1.1 RestTemplate and WebClient</strong></h4><p>&emsp;&emsp;Spring Security OAuth扩展了RestTemplate, 引入了OAuth2RestTemplate，这个类需要注册为@Bean并实例化。</p>
<p>&emsp;&emsp;Spring Security则选择了支持组合并提供了OAuth2AuthorizedClientService,用来帮助创建RestTemplate拦截器或WebClient交换过滤器函数。Spring Security同时为基于Servlet-和基于WebFlux-的应用程序提供了ExchangeFilterFunction。</p>
<h4 id="2-1-2-Simplified-Client-Resolution"><a href="#2-1-2-Simplified-Client-Resolution" class="headerlink" title="2.1.2 Simplified Client Resolution"></a><strong>2.1.2 Simplified Client Resolution</strong></h4><p>&emsp;&emsp;在Spring Security OAuth中检索当前授权的客户端，需要自动注入（autowire）OAuth2ClientContext实例。Spring Security OAuth通过Spring MVCs request以及session scope来存储OAuth2ClientContext实例。</p>
<p>&emsp;&emsp;在Spring Security中检索当前授权的客户端，需要@RegisteredOAuth2AuthorizedClient方法参数注解。Spring Security 把已授权的客户端存储在OAuth2AuthorizedClientRepository中。</p>
<h4 id="2-1-3-Enhanced-Client-Resolution"><a href="#2-1-3-Enhanced-Client-Resolution" class="headerlink" title="2.1.3 Enhanced Client Resolution"></a><strong>2.1.3 Enhanced Client Resolution</strong></h4><p>&emsp;&emsp;Spring Security OAuth通过Spring Boot properties配置单个客户端。</p>
<p>&emsp;&emsp;Spring Security使用ClientRegistrationRepository来表示客户端，客户端可以通过Spring Security DSL来提供或仍使用Spring Boot配置。</p>
<h4 id="2-1-4-Simplified-JWT-Support"><a href="#2-1-4-Simplified-JWT-Support" class="headerlink" title="2.1.4 Simplified JWT Support"></a><strong>2.1.4 Simplified JWT Support</strong></h4><p>&emsp;&emsp;Spring Security OAuth通过spring-security-jwt提供JWT支持。</p>
<p>&emsp;&emsp;Spring Security则依赖于Nimbus提供JWT支持。</p>
<h4 id="2-1-5-示例-Examples-Matrix"><a href="#2-1-5-示例-Examples-Matrix" class="headerlink" title="2.1.5 示例 Examples Matrix"></a><strong>2.1.5 示例 Examples Matrix</strong></h4><p>&emsp;&emsp;Spring Security和Spring Security OAuth2都提供了如何配置客户端的示例：</p>
<table>
<thead>
<tr>
<th style="text-align:left">用例</th>
<th style="text-align:left">Spring Security</th>
<th style="text-align:left">Spring Security OAuth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Authorization Code</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Refresh Token</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Client Credentials</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Resource Owner Password Credentials</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
</tbody>
</table>
<h3 id="2-2-登录-Login"><a href="#2-2-登录-Login" class="headerlink" title="2.2 登录 Login"></a><strong>2.2 登录 Login</strong></h3><h4 id="2-2-1-方法变更-Changes-In-Approach"><a href="#2-2-1-方法变更-Changes-In-Approach" class="headerlink" title="2.2.1 方法变更 Changes In Approach"></a><strong>2.2.1 方法变更 Changes In Approach</strong></h4><p>&emsp;&emsp;Spring Security称呼此功能为OAuth 2.0 Login而Spring Security OAuth则称为SSO。</p>
<p>&emsp;&emsp;Spring Security OAuth的SSO支持通过添加@EnableOAuth2Sso注解开启。</p>
<p>&emsp;&emsp;Spring Security的OAuth 2.0 Login支持通过oauth2Login() DSL方法启用的。</p>
<h3 id="2-3-资源服务器-Resource-Server"><a href="#2-3-资源服务器-Resource-Server" class="headerlink" title="2.3 资源服务器 Resource Server"></a><strong>2.3 资源服务器 Resource Server</strong></h3><h4 id="2-3-1-方法变更-Changes-In-Approach"><a href="#2-3-1-方法变更-Changes-In-Approach" class="headerlink" title="2.3.1 方法变更 Changes In Approach"></a><strong>2.3.1 方法变更 Changes In Approach</strong></h4><p>&emsp;&emsp;Spring Security OAuth的资源服务器支持通过添加@EnableResourceServer注解开启。</p>
<p>&emsp;&emsp;Spring Security的资源服务器支持通过oauth2ResourceServer DSL方法启用的。</p>
<p>&emsp;&emsp;Spring Security OAuth为资源服务器提供了两种不同的DSL方法，通过扩展ResourceServerConfigurerAdapter来配置。</p>
<p>&emsp;&emsp;Spring Security通过Spring Security DSL提供相同的功能, 通过扩展WebSecurityConfigurerAdapter来配置。</p>
<p>&emsp;&emsp;Spring Security OAuth为具体授权规则指定了两个位置，第一个是通过ResourceServerConfigurerAdapter - 此处的任意规则都是为存在（present）的bearer token设定，第二个是通过WebSecurityConfigurerAdapter - 此处的任意规则都是为缺席（absent）的bearer token设定。</p>
<p>&emsp;&emsp;Spring Security则标明所有的授权规则都是通过一个或多个WebSecurityConfigurerAdapter配置而来的。</p>
<p>&emsp;&emsp;Spring Security OAuth提供了一个自定义的SpEL变量oauth2。为了基于scope去进行授权请求或方法, 可以编写一个表达式如access(“#oauth2.hasScope(‘scope’)”)。</p>
<p>&emsp;&emsp;Spring Security转换scope遵循授权命名规范。为了基于scope去进行授权请求或方法, 可以编写一个表达式如hasAuthority(“SCOPE_scope”)。</p>
<h4 id="2-3-2-示例-Examples-Matrix"><a href="#2-3-2-示例-Examples-Matrix" class="headerlink" title="2.3.2 示例 Examples Matrix"></a><strong>2.3.2 示例 Examples Matrix</strong></h4><table>
<thead>
<tr>
<th style="text-align:left">用例</th>
<th style="text-align:left">Spring Security</th>
<th style="text-align:left">Spring Security OAuth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JWT + JWK</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-resource-jwt" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">JWT + Key</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver-static" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle/#oauth2-boot-resource-server-jwt-single-key" title="Title" target="_blank" rel="noopener">Doc</a></td>
</tr>
<tr>
<td style="text-align:left">Opaque Token</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver-opaque" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-resource" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">w/ Actuator</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#multiple-httpsecurity" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-actuator" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Audience Validation</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#oauth2resourceserver-jwt-validation-custom" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Authorizing Requests</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#oauth2resourceserver-jwt-authorization" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle/#oauth2-boot-resource-server-authorization" title="Title" target="_blank" rel="noopener">Doc</a></td>
</tr>
</tbody>
</table>
<h4 id="2-3-3-未移植功能-Unported-Features"><a href="#2-3-3-未移植功能-Unported-Features" class="headerlink" title="2.3.3 未移植功能 Unported Features"></a><strong>2.3.3 未移植功能 Unported Features</strong></h4><p>&emsp;&emsp;There are some features that we currently have no plans to port over.</p>
<p>&emsp;&emsp;In Spring Security OAuth, you can configure a UserDetailsService to look up a user that corresponds with the incoming bearer token. There are no plans for Spring Security’s Resource Server support to pick up a UserDetailsService. This is still simple in Spring Security, though, via the jwtAuthenticationConverter DSL method. Notably, one can return a BearerTokenAuthentication which takes an instance of OAuth2AuthenticatedPrincipal for a principal.</p>
<p>&emsp;&emsp;In Spring Security OAuth, you can assign an identifier to the resource server via the ResourceServerSecurityConfigurer#resourceId method. This configures the realm name used by the authentication entry point as well as adds audience validation. No such identifier is planned for Spring Security. However, audience validation and a custom realm name are both simple to achieve by configuring an OAuth2TokenValidator and AuthenticationEntryPoint respectively.</p>
<hr>
<h2 id="第三节-实战：实现单点登录"><a href="#第三节-实战：实现单点登录" class="headerlink" title="第三节 实战：实现单点登录"></a><strong>第三节 实战：实现单点登录</strong></h2><p>&emsp;&emsp;</p>
<hr>
<h2 id="第四节-实战：APP平台第三方应用授权"><a href="#第四节-实战：APP平台第三方应用授权" class="headerlink" title="第四节 实战：APP平台第三方应用授权"></a><strong>第四节 实战：APP平台第三方应用授权</strong></h2><p>&emsp;&emsp;首先在平台官网注册成为开发者。</p>
<p>&emsp;&emsp;然后注册应用信息，并搭建好项目。</p>
<p>&emsp;&emsp;OAuth时序图如下，通过OAuth来对接个人项目和APP平台，之后开发完毕后，只要保证提供一个稳定可用的线上版本即可。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010138.jpg" alt="OAuth时序图"></p>
<p>&emsp;&emsp;官网文档提供了OAuth2.0的authorize接口、access token接口、获取用户信息接口。</p>
<p>&emsp;&emsp;怎么通过Spring Security配置OAuth2 Client？找了一下Spring官网Demo：<a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">OAuth-2.0-Migration-Guide</a>，直接按Demo来实现我们的需求。</p>
<p>&emsp;&emsp;代码就没必要再贴一遍了，了解OAuth2协议流程，对整个技术框架都会比较熟悉了，快速的实现需求后，再慢慢解决遇到的问题。</p>
<p>&emsp;&emsp;以下为部分配置文件内容。</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Spring-Security</span></span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.provider=cpdemo</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-id=15764595791470995</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-secret=trmCkkXvNTEtURIZjqj0yQ0A13PJ90</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.authorization-grant-type=authorization_code</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-name=TEST</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.redirect-uri=&#123;<span class="attribute">baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;</span></span><br><span class="line"><span class="attribute">spring.security.oauth2.client.registration.cpdemo-client.scope=get_user_info</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">spring.security.oauth2.client.provider.cpdemo.authorization-uri=https</span>://www<span class="variable">.cpdemo</span><span class="variable">.com</span>/connect/oauth2/authorize</span><br><span class="line">spring<span class="variable">.security</span><span class="variable">.oauth</span>2<span class="variable">.client</span><span class="variable">.provider</span><span class="variable">.cpdemo</span><span class="variable">.token-uri</span>=https://www<span class="variable">.cpdemo</span><span class="variable">.com</span>/connect/oauth2/token</span><br><span class="line">spring<span class="variable">.security</span><span class="variable">.oauth</span>2<span class="variable">.client</span><span class="variable">.provider</span><span class="variable">.cpdemo</span><span class="variable">.user-info-uri</span>=https://api<span class="variable">.cpdemo</span><span class="variable">.com</span>/user/campus/get_user_info</span><br><span class="line">spring<span class="variable">.security</span><span class="variable">.oauth</span>2<span class="variable">.client</span><span class="variable">.provider</span><span class="variable">.cpdemo</span><span class="variable">.user-name-attribute</span>=user_name</span><br><span class="line"></span><br><span class="line"># 解决  Possible CSRF detected - state parameter was required but no state could be found  问题</span><br><span class="line">server<span class="variable">.servlet</span><span class="variable">.session</span><span class="variable">.cookie</span><span class="variable">.name</span>=OAUTH2CLIENTSESSION</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="第五节-问题记录：得到授权code后无法获取访问令牌"><a href="#第五节-问题记录：得到授权code后无法获取访问令牌" class="headerlink" title="第五节 问题记录：得到授权code后无法获取访问令牌"></a><strong>第五节 问题记录：得到授权code后无法获取访问令牌</strong></h2><h3 id="1-1-问题描述"><a href="#1-1-问题描述" class="headerlink" title="1.1 问题描述"></a><strong>1.1 问题描述</strong></h3><p>&emsp;&emsp;正常访问<a href="http://localhost:7990/，向server发出授权请求，并重定向到一个PC接口需要用APP端扫码二维码，扫码成功后发生异常，返回/login?error页面提示错误msg：[authorization_request_not_found]" target="_blank" rel="noopener">http://localhost:7990/，向server发出授权请求，并重定向到一个PC接口需要用APP端扫码二维码，扫码成功后发生异常，返回/login?error页面提示错误msg：[authorization_request_not_found]</a></p>
<h3 id="1-2-问题跟踪"><a href="#1-2-问题跟踪" class="headerlink" title="1.2 问题跟踪"></a><strong>1.2 问题跟踪</strong></h3><p>&emsp;&emsp;开始调试代码，并记录访问流程。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">--首先客户发起请求，收到rep重定向到/index</span><br><span class="line">http://localhost:<span class="number">7990</span>/</span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response：</span><br><span class="line">        Location: http://localhost:<span class="number">7990</span>/index</span><br><span class="line"></span><br><span class="line">--请求/index，收到rep重定向到/oauth2/authorization/cpdemo-client，并用Cookie保存session：OAUTH2CLIENTSESSION</span><br><span class="line">http://localhost:<span class="number">7990</span>/index</span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response：</span><br><span class="line">        Location: http://localhost:<span class="number">7990</span>/oauth2/authorization/cpdemo-client</span><br><span class="line">        Set-Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA; Path=/; HttpOnly</span><br><span class="line"></span><br><span class="line">--请求/oauth2/authorization/cpdemo-client，携带Cookie，收到rep重定向到www.xxx.com的授权接口，注意此时<span class="keyword">state</span>为WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%<span class="number">3</span>D</span><br><span class="line">http://localhost:<span class="number">7990</span>/oauth2/authorization/cpdemo-client</span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA</span><br><span class="line">    Response：</span><br><span class="line">        Location: https://www.xxx.com/connect/oauth2/authorize?response_type=code&amp;client_id=xxx&amp;scope=get_user_info&amp;<span class="keyword">state</span>=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%<span class="number">3</span>D&amp;redirect_uri=http://localhost:<span class="number">7990</span>/login/oauth2/code/cpdemo-client</span><br><span class="line"></span><br><span class="line">--请求www.cpdemo.com的授权接口，收到rep重定向到/pc/qrcode/index.html，并用保存Cookie：acw_tc，授权服务器检测到PC端访问，跳转到一个二维码界面</span><br><span class="line">https://www.cpdemo.com/connect/oauth2/authorize?response_type=code&amp;client_id=xxx&amp;scope=get_user_info&amp;<span class="keyword">state</span>=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%<span class="number">3</span>D&amp;redirect_uri=http://localhost:<span class="number">7990</span>/login/oauth2/code/cpdemo-client</span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response</span><br><span class="line">        Location: https://www.cpdemo.com/connect/pc/qrcode/index.html?response_type=code&amp;scope=get_user_info&amp;client_id=<span class="number">15764595791470995</span>&amp;redirect_uri=http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Flocalhost%<span class="number">3</span>A7990%<span class="number">2</span>Flogin%<span class="number">2</span>Foauth2%<span class="number">2</span>Fcode%<span class="number">2</span>Fcpdemo-client&amp;<span class="keyword">state</span>=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=&amp;top_redirect=&amp;support_free_login=&amp;_=<span class="number">1577692641980</span><span class="comment">#</span></span><br><span class="line">        Set-Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46;path=/;HttpOnly;Max-Age=<span class="number">2678401</span></span><br><span class="line"></span><br><span class="line">--请求/pc/qrcode/index.html，携带Cookie，获取二维码界面</span><br><span class="line">https://www.cpdemo.com/connect/pc/qrcode/index.html?response_type=code&amp;scope=get_user_info&amp;client_id=xxx&amp;redirect_uri=http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Flocalhost%<span class="number">3</span>A7990%<span class="number">2</span>Flogin%<span class="number">2</span>Foauth2%<span class="number">2</span>Fcode%<span class="number">2</span>Fcpdemo-client&amp;<span class="keyword">state</span>=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=&amp;top_redirect=&amp;support_free_login=&amp;_=xxx</span><br><span class="line">    Status Code: <span class="number">200</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46</span><br><span class="line"></span><br><span class="line">--扫码登陆，并携带新的参数，注意此时<span class="keyword">state</span>值为login</span><br><span class="line">https://www.cpdemo.com/connect/qrcode/jsLogin</span><br><span class="line">    Status Code: <span class="number">200</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46</span><br><span class="line">    Playload：</span><br><span class="line">        clientId: <span class="string">"xxx"</span></span><br><span class="line">        redirectUri: <span class="string">"http://localhost:7990/login/oauth2/code/cpdemo-client"</span></span><br><span class="line">        scope: <span class="string">"get_user_info"</span></span><br><span class="line">        responseType: <span class="string">"code"</span></span><br><span class="line">        <span class="keyword">state</span>: <span class="string">"login"</span></span><br><span class="line">        supportFreeLogin: <span class="string">""</span></span><br><span class="line"></span><br><span class="line">--登陆成功，重定向到redirectUri：/login/oauth2/code/cpdemo-client，并携带授权code和<span class="keyword">state</span>，请求失败，跳转error界面</span><br><span class="line">http://localhost:<span class="number">7990</span>/login/oauth2/code/cpdemo-client?code=cCrxmz1ds745WmV4WPYa1577692667&amp;<span class="keyword">state</span>=login</span><br><span class="line">    Request：</span><br><span class="line">        Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;再看DEBUG日志</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">-本地客户端服务器收到code和state</span></span><br><span class="line"><span class="string">o.a.coyote.http11.Http11InputBuffer</span>      <span class="string">:</span> <span class="string">Received</span> <span class="string">[GET</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Host:</span> <span class="attr">localhost:7990</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="string">max-age=0</span></span><br><span class="line"><span class="attr">Upgrade-Insecure-Requests:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">User-Agent:</span> <span class="string">Mozilla/5.0</span> <span class="string">(Windows</span> <span class="string">NT</span> <span class="number">10.0</span><span class="string">;</span> <span class="string">Win64;</span> <span class="string">x64)</span> <span class="string">AppleWebKit/537.36</span> <span class="string">(KHTML,</span> <span class="string">like</span> <span class="string">Gecko)</span> <span class="string">Chrome/79.0.3945.88</span> <span class="string">Safari/537.36</span></span><br><span class="line"><span class="attr">Accept:</span> <span class="string">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="attr">Sec-Fetch-Site:</span> <span class="string">cross-site</span></span><br><span class="line"><span class="attr">Sec-Fetch-Mode:</span> <span class="string">navigate</span></span><br><span class="line"><span class="attr">Accept-Encoding:</span> <span class="string">gzip,</span> <span class="string">deflate,</span> <span class="string">br</span></span><br><span class="line"><span class="attr">Accept-Language:</span> <span class="string">zh-CN,zh;q=0.9,en;q=0.8</span></span><br><span class="line"><span class="attr">Cookie:</span> <span class="string">OAUTH2CLIENTSESSION=9F0F448755B953A5542B4E2856AC7C54</span></span><br><span class="line"></span><br><span class="line"><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-过滤器校验</span></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">1</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'WebAsyncManagerIntegrationFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">2</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'SecurityContextPersistenceFilter'</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-HttpSessionSecurityContextRepository提示取不到HttpSession</span></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">w.c.HttpSessionSecurityContextRepository</span> <span class="string">:</span> <span class="literal">No</span> <span class="string">HttpSession</span> <span class="string">currently</span> <span class="string">exists</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">w.c.HttpSessionSecurityContextRepository</span> <span class="string">:</span> <span class="literal">No</span> <span class="string">SecurityContext</span> <span class="string">was</span> <span class="string">available</span> <span class="string">from</span> <span class="string">the</span> <span class="attr">HttpSession:</span> <span class="literal">null</span>. <span class="string">A</span> <span class="string">new</span> <span class="string">one</span> <span class="string">will</span> <span class="string">be</span> <span class="string">created.</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">3</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'HeaderWriterFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">4</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'CsrfFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">5</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'LogoutFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.s.w.u.matcher.AntPathRequestMatcher</span>  <span class="string">:</span> <span class="string">Request</span> <span class="string">'GET /login/oauth2/code/cpdemo-client'</span> <span class="string">doesn't</span> <span class="string">match</span> <span class="string">'POST /logout'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">6</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'OAuth2AuthorizationRequestRedirectFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.s.w.u.matcher.AntPathRequestMatcher</span>  <span class="string">:</span> <span class="string">Checking</span> <span class="string">match</span> <span class="string">of</span> <span class="string">request</span> <span class="string">:</span> <span class="string">'/login/oauth2/code/cpdemo-client'</span><span class="string">;</span> <span class="string">against</span> <span class="string">'/oauth2/authorization/&#123;registrationId&#125;'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">org.apache.tomcat.util.http.Parameters</span>   <span class="string">:</span> <span class="string">Set</span> <span class="string">encoding</span> <span class="string">to</span> <span class="string">UTF-8</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">org.apache.tomcat.util.http.Parameters</span>   <span class="string">:</span> <span class="string">Decoding</span> <span class="string">query</span> <span class="literal">null</span> <span class="string">UTF-8</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">org.apache.tomcat.util.http.Parameters</span>   <span class="string">:</span> <span class="string">Start</span> <span class="string">processing</span> <span class="string">with</span> <span class="string">input</span> <span class="string">[code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login]</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.889</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.security.web.FilterChainProxy</span>        <span class="string">:</span> <span class="string">/login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login</span> <span class="string">at</span> <span class="string">position</span> <span class="number">7</span> <span class="string">of</span> <span class="number">15</span> <span class="string">in</span> <span class="string">additional</span> <span class="string">filter</span> <span class="string">chain;</span> <span class="string">firing</span> <span class="attr">Filter:</span> <span class="string">'OAuth2LoginAuthenticationFilter'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.905</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.s.w.u.matcher.AntPathRequestMatcher</span>  <span class="string">:</span> <span class="string">Checking</span> <span class="string">match</span> <span class="string">of</span> <span class="string">request</span> <span class="string">:</span> <span class="string">'/login/oauth2/code/cpdemo-client'</span><span class="string">;</span> <span class="string">against</span> <span class="string">'/login/oauth2/code/*'</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-OAuth2LoginAuthenticationFilter抛出异常OAuth2AuthenticationException：[authorization_request_not_found]</span> </span><br><span class="line"></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.905</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">.s.o.c.w.OAuth2LoginAuthenticationFilter</span> <span class="string">:</span> <span class="string">Request</span> <span class="string">is</span> <span class="string">to</span> <span class="string">process</span> <span class="string">authentication</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.912</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">.s.o.c.w.OAuth2LoginAuthenticationFilter</span> <span class="string">:</span> <span class="string">Authentication</span> <span class="string">request</span> <span class="attr">failed:</span> <span class="string">org.springframework.security.oauth2.core.OAuth2AuthenticationException:</span> <span class="string">[authorization_request_not_found]</span> </span><br><span class="line"></span><br><span class="line"><span class="string">org.springframework.security.oauth2.core.OAuth2AuthenticationException:</span> <span class="string">[authorization_request_not_found]</span> </span><br><span class="line">	<span class="string">at</span> <span class="string">org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter.attemptAuthentication(OAuth2LoginAuthenticationFilter.java:163)</span> <span class="string">~[spring-security-oauth2-client-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line">	<span class="string">at</span> <span class="string">org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:212)</span> <span class="string">~[spring-security-web-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line">	<span class="string">at</span> <span class="string">org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334)</span> <span class="string">[spring-security-web-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.914</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">.s.o.c.w.OAuth2LoginAuthenticationFilter</span> <span class="string">:</span> <span class="string">Updated</span> <span class="string">SecurityContextHolder</span> <span class="string">to</span> <span class="string">contain</span> <span class="literal">null</span> <span class="string">Authentication</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.914</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">.s.o.c.w.OAuth2LoginAuthenticationFilter</span> <span class="string">:</span> <span class="string">Delegating</span> <span class="string">to</span> <span class="string">authentication</span> <span class="string">failure</span> <span class="string">handler</span> <span class="string">org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler@48edcd38</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.914</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">.a.SimpleUrlAuthenticationFailureHandler</span> <span class="string">:</span> <span class="string">Redirecting</span> <span class="string">to</span> <span class="string">/login?error</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.914</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.s.web.DefaultRedirectStrategy</span>        <span class="string">:</span> <span class="string">Redirecting</span> <span class="string">to</span> <span class="string">'/login?error'</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.915</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">o.s.s.w.header.writers.HstsHeaderWriter</span>  <span class="string">:</span> <span class="string">Not</span> <span class="string">injecting</span> <span class="string">HSTS</span> <span class="string">header</span> <span class="string">since</span> <span class="string">it</span> <span class="string">did</span> <span class="string">not</span> <span class="string">match</span> <span class="string">the</span> <span class="string">requestMatcher</span> <span class="string">org.springframework.security.web.header.writers.HstsHeaderWriter$SecureRequestMatcher@93c27ef</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.915</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">w.c.HttpSessionSecurityContextRepository</span> <span class="string">:</span> <span class="string">SecurityContext</span> <span class="string">is</span> <span class="string">empty</span> <span class="string">or</span> <span class="string">contents</span> <span class="string">are</span> <span class="string">anonymous</span> <span class="bullet">-</span> <span class="string">context</span> <span class="string">will</span> <span class="string">not</span> <span class="string">be</span> <span class="string">stored</span> <span class="string">in</span> <span class="string">HttpSession.</span></span><br><span class="line"><span class="number">2019</span><span class="bullet">-12</span><span class="bullet">-30</span> <span class="number">15</span><span class="string">:51:44.915</span> <span class="string">DEBUG</span> <span class="number">20732</span> <span class="meta">---</span> <span class="string">[nio-7990-exec-1]</span> <span class="string">s.s.w.c.SecurityContextPersistenceFilter</span> <span class="string">:</span> <span class="string">SecurityContextHolder</span> <span class="string">now</span> <span class="string">cleared,</span> <span class="string">as</span> <span class="string">request</span> <span class="string">processing</span> <span class="string">completed</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;定位到异常发生的代码，部分源码如下。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OAuth2LoginAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    public <span class="type">Authentication</span> attemptAuthentication(<span class="type">HttpServletRequest</span> request, <span class="type">HttpServletResponse</span> response) <span class="keyword">throws</span> <span class="type">AuthenticationException</span> &#123;</span><br><span class="line">        <span class="type">MultiValueMap</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; params = <span class="type">OAuth2AuthorizationResponseUtils</span>.toMultiMap(request.getParameterMap());</span><br><span class="line">        <span class="keyword">if</span> (!<span class="type">OAuth2AuthorizationResponseUtils</span>.isAuthorizationResponse(params)) &#123;</span><br><span class="line">            <span class="type">OAuth2Error</span> oauth2Error = <span class="keyword">new</span> <span class="type">OAuth2Error</span>(<span class="string">"invalid_request"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">OAuth2AuthenticationException</span>(oauth2Error, oauth2Error.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">OAuth2AuthorizationRequest</span> authorizationRequest = <span class="keyword">this</span>.authorizationRequestRepository.removeAuthorizationRequest(request, response);<span class="comment">//此处获取authorizationRequest为null</span></span><br><span class="line">            <span class="keyword">if</span> (authorizationRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">OAuth2Error</span> oauth2Error = <span class="keyword">new</span> <span class="type">OAuth2Error</span>(<span class="string">"authorization_request_not_found"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">OAuth2AuthenticationException</span>(oauth2Error, oauth2Error.toString());<span class="comment">//此处抛出异常</span></span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;继续跟踪代码。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpSessionOAuth2AuthorizationRequestRepository</span> <span class="keyword">implements</span> <span class="title">AuthorizationRequestRepository</span>&lt;<span class="title">OAuth2AuthorizationRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    public OAuth2AuthorizationRequest removeAuthorizationRequest(HttpServletRequest request) &#123;</span><br><span class="line">        Assert.notNull(request, <span class="string">"request cannot be null"</span>);</span><br><span class="line">        <span class="built_in">String</span> stateParameter = <span class="keyword">this</span>.getStateParameter(request);<span class="comment">//取得state参数值为login</span></span><br><span class="line">        <span class="keyword">if</span> (stateParameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, OAuth2AuthorizationRequest&gt; authorizationRequests = <span class="keyword">this</span>.getAuthorizationRequests(request);<span class="comment">//获得映射："WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=" -&gt; req</span></span><br><span class="line">            OAuth2AuthorizationRequest originalRequest = (OAuth2AuthorizationRequest)authorizationRequests.remove(stateParameter);<span class="comment">//获得originalRequest为null</span></span><br><span class="line">            <span class="keyword">if</span> (!authorizationRequests.isEmpty()) &#123;</span><br><span class="line">                request.getSession().setAttribute(<span class="keyword">this</span>.sessionAttributeName, authorizationRequests);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                request.getSession().removeAttribute(<span class="keyword">this</span>.sessionAttributeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> originalRequest;<span class="comment">//返回null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    private <span class="built_in">String</span> getStateParameter(HttpServletRequest request) &#123;</span><br><span class="line">        <span class="keyword">return</span> request.getParameter(<span class="string">"state"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, OAuth2AuthorizationRequest&gt; getAuthorizationRequests(HttpServletRequest request) &#123;</span><br><span class="line">        HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, OAuth2AuthorizationRequest&gt; authorizationRequests = session == <span class="keyword">null</span> ? <span class="keyword">null</span> : (<span class="built_in">Map</span>)session.getAttribute(<span class="keyword">this</span>.sessionAttributeName);</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">Map</span>)(authorizationRequests == <span class="keyword">null</span> ? <span class="keyword">new</span> HashMap() : authorizationRequests);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们得到的session中有两个attribute：AUTHORIZATION_REQUEST和SPRING_SECURITY_SAVED_REQUEST，前者存储了一组映射（”WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=” -&gt; req），后者则是默认Req：<a href="http://localhost:7990/index。" target="_blank" rel="noopener">http://localhost:7990/index。</a></p>
<p>&emsp;&emsp;所以此处是根据state参数值来获取session中存储的信息，但我们知道在首次请求授权服务器时我们提供的state为：WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=，扫码登陆后又提交了state为：login，但这里需要的是旧的state参数。</p>
<p>&emsp;&emsp;所以要么授权服务器在扫码登陆时不要替换state为login，而是WiSv；要么授权服务器在扫码登陆后返回code和state时给旧值WiSv；要么我们客户端重构。</p>
<p>&emsp;&emsp;联系对方工程师后，回复：“<strong>把state写死试试</strong>”。虽然有点无语，但好吧。</p>
<h3 id="1-3-问题处理"><a href="#1-3-问题处理" class="headerlink" title="1.3 问题处理"></a><strong>1.3 问题处理</strong></h3><h4 id="1-3-1-自定义Authorization-Code-Request"><a href="#1-3-1-自定义Authorization-Code-Request" class="headerlink" title="1.3.1 自定义Authorization_Code_Request"></a><strong>1.3.1 自定义Authorization_Code_Request</strong></h4><p>&emsp;&emsp;写死state，首先要自定义authorization code request，首先自定义OAuth2AuthorizationRequestResolver，覆盖state参数，代码如下。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class CustomAuthorizationRequestResolver implements OAuth2AuthorizationRequestResolver &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AntPathRequestMatcher authorizationRequestMatcher;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringKeyGenerator stateGenerator = <span class="keyword">new</span> Base64StringKeyGenerator(Base64.getUrlEncoder());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringKeyGenerator secureKeyGenerator = <span class="keyword">new</span> Base64StringKeyGenerator(Base64.getUrlEncoder().withoutPadding(), <span class="number">96</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CustomAuthorizationRequestResolver(</span><br><span class="line">            ClientRegistrationRepository clientRegistrationRepository, <span class="keyword">String</span> authorizationRequestBaseUri) &#123;</span><br><span class="line">        Assert.notNull(clientRegistrationRepository, <span class="string">"clientRegistrationRepository cannot be null"</span>);</span><br><span class="line">        Assert.hasText(authorizationRequestBaseUri, <span class="string">"authorizationRequestBaseUri cannot be empty"</span>);</span><br><span class="line">        <span class="keyword">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class="line">        <span class="keyword">this</span>.authorizationRequestMatcher = <span class="keyword">new</span> AntPathRequestMatcher(authorizationRequestBaseUri + <span class="string">"/&#123;"</span> + <span class="string">"registrationId"</span> + <span class="string">"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> OAuth2AuthorizationRequest resolve(HttpServletRequest request) &#123;</span><br><span class="line">        <span class="keyword">String</span> registrationId = <span class="keyword">this</span>.resolveRegistrationId(request);</span><br><span class="line">        <span class="keyword">String</span> redirectUriAction = <span class="keyword">this</span>.getAction(request, <span class="string">"login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.resolve(request, registrationId, redirectUriAction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> OAuth2AuthorizationRequest resolve(HttpServletRequest request, <span class="keyword">String</span> registrationId) &#123;</span><br><span class="line">        <span class="keyword">if</span> (registrationId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">String</span> redirectUriAction = <span class="keyword">this</span>.getAction(request, <span class="string">"authorize"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.resolve(request, registrationId, redirectUriAction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> getAction(HttpServletRequest request, <span class="keyword">String</span> defaultAction) &#123;</span><br><span class="line">        <span class="keyword">String</span> action = request.getParameter(<span class="string">"action"</span>);</span><br><span class="line">        <span class="keyword">return</span> action == <span class="keyword">null</span> ? defaultAction : action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizationRequest resolve(HttpServletRequest request, <span class="keyword">String</span> registrationId, <span class="keyword">String</span> redirectUriAction) &#123;</span><br><span class="line">        <span class="keyword">if</span> (registrationId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ClientRegistration clientRegistration = <span class="keyword">this</span>.clientRegistrationRepository.findByRegistrationId(registrationId);</span><br><span class="line">            <span class="keyword">if</span> (clientRegistration == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid Client Registration with Id: "</span> + registrationId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; attributes = <span class="keyword">new</span> <span class="keyword">HashMap</span>();</span><br><span class="line">                attributes.put(<span class="string">"registration_id"</span>, clientRegistration.getRegistrationId());</span><br><span class="line">                OAuth2AuthorizationRequest.Builder builder;</span><br><span class="line">                <span class="keyword">if</span> (AuthorizationGrantType.AUTHORIZATION_CODE.equals(clientRegistration.getAuthorizationGrantType())) &#123;</span><br><span class="line">                    builder = OAuth2AuthorizationRequest.authorizationCode();</span><br><span class="line">                    Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; additionalParameters = <span class="keyword">new</span> <span class="keyword">HashMap</span>();</span><br><span class="line">                    <span class="keyword">if</span> (!CollectionUtils.isEmpty(clientRegistration.getScopes()) &amp;&amp; clientRegistration.getScopes().contains(<span class="string">"openid"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.addNonceParameters(attributes, additionalParameters);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ClientAuthenticationMethod.NONE.equals(clientRegistration.getClientAuthenticationMethod())) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.addPkceParameters(attributes, additionalParameters);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    builder.additionalParameters(additionalParameters);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!AuthorizationGrantType.IMPLICIT.equals(clientRegistration.getAuthorizationGrantType())) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid Authorization Grant Type ("</span> + clientRegistration.getAuthorizationGrantType().getValue() + <span class="string">") for Client Registration with Id: "</span> + clientRegistration.getRegistrationId());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    builder = OAuth2AuthorizationRequest.implicit();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">String</span> redirectUriStr = expandRedirectUri(request, clientRegistration, redirectUriAction);</span><br><span class="line"><span class="comment">//                OAuth2AuthorizationRequest authorizationRequest = builder.clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(redirectUriStr).scopes(clientRegistration.getScopes()).state(this.stateGenerator.generateKey()).attributes(attributes).build();</span></span><br><span class="line">                <span class="comment">//stateGenerator.generateKey()替换为常量login</span></span><br><span class="line">                OAuth2AuthorizationRequest authorizationRequest = builder.clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(redirectUriStr).scopes(clientRegistration.getScopes()).state(<span class="string">"login"</span>).attributes(attributes).build();</span><br><span class="line">                <span class="comment">//自定义修改请求</span></span><br><span class="line">                <span class="keyword">return</span> customizeAuthorizationRequest(authorizationRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义请求参数</span></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizationRequest customizeAuthorizationRequest(</span><br><span class="line">            OAuth2AuthorizationRequest req) &#123;</span><br><span class="line">        Map&lt;<span class="keyword">String</span>,<span class="keyword">Object</span>&gt; extraParams = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;();</span><br><span class="line">        System.out.<span class="built_in">println</span>(req.getAdditionalParameters());</span><br><span class="line">        extraParams.putAll(req.getAdditionalParameters());</span><br><span class="line">        <span class="comment">//覆盖state</span></span><br><span class="line">        extraParams.put(<span class="string">"state"</span>, <span class="string">"login"</span>);</span><br><span class="line">        <span class="keyword">return</span> OAuth2AuthorizationRequest</span><br><span class="line">                .from(req)</span><br><span class="line">                .additionalParameters(extraParams)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> resolveRegistrationId(HttpServletRequest request) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorizationRequestMatcher.matches(request) ? (<span class="keyword">String</span>)<span class="keyword">this</span>.authorizationRequestMatcher.matcher(request).getVariables().<span class="built_in">get</span>(<span class="string">"registrationId"</span>) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> expandRedirectUri(HttpServletRequest request, ClientRegistration clientRegistration, <span class="keyword">String</span> action) &#123;</span><br><span class="line">        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; uriVariables = <span class="keyword">new</span> <span class="keyword">HashMap</span>();</span><br><span class="line">        uriVariables.put(<span class="string">"registrationId"</span>, clientRegistration.getRegistrationId());</span><br><span class="line">        UriComponents uriComponents = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request)).replacePath(request.getContextPath()).replaceQuery((<span class="keyword">String</span>)<span class="keyword">null</span>).fragment((<span class="keyword">String</span>)<span class="keyword">null</span>).build();</span><br><span class="line">        <span class="keyword">String</span> scheme = uriComponents.getScheme();</span><br><span class="line">        uriVariables.put(<span class="string">"baseScheme"</span>, scheme == <span class="keyword">null</span> ? <span class="string">""</span> : scheme);</span><br><span class="line">        <span class="keyword">String</span> host = uriComponents.getHost();</span><br><span class="line">        uriVariables.put(<span class="string">"baseHost"</span>, host == <span class="keyword">null</span> ? <span class="string">""</span> : host);</span><br><span class="line">        <span class="built_in">int</span> port = uriComponents.getPort();</span><br><span class="line">        uriVariables.put(<span class="string">"basePort"</span>, port == <span class="number">-1</span> ? <span class="string">""</span> : <span class="string">":"</span> + port);</span><br><span class="line">        <span class="keyword">String</span> path = uriComponents.getPath();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(path) &amp;&amp; path.charAt(<span class="number">0</span>) != <span class="string">'/'</span>) &#123;</span><br><span class="line">            path = <span class="string">'/'</span> + path;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uriVariables.put(<span class="string">"basePath"</span>, path == <span class="keyword">null</span> ? <span class="string">""</span> : path);</span><br><span class="line">        uriVariables.put(<span class="string">"baseUrl"</span>, uriComponents.toUriString());</span><br><span class="line">        uriVariables.put(<span class="string">"action"</span>, action == <span class="keyword">null</span> ? <span class="string">""</span> : action);</span><br><span class="line">        <span class="keyword">return</span> UriComponentsBuilder.fromUriString(clientRegistration.getRedirectUriTemplate()).buildAndExpand(uriVariables).toUriString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> addNonceParameters(Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; attributes, Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; additionalParameters) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">String</span> nonce = <span class="keyword">this</span>.secureKeyGenerator.generateKey();</span><br><span class="line">            <span class="keyword">String</span> nonceHash = createHash(nonce);</span><br><span class="line">            attributes.put(<span class="string">"nonce"</span>, nonce);</span><br><span class="line">            additionalParameters.put(<span class="string">"nonce"</span>, nonceHash);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> addPkceParameters(Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; attributes, Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; additionalParameters) &#123;</span><br><span class="line">        <span class="keyword">String</span> codeVerifier = <span class="keyword">this</span>.secureKeyGenerator.generateKey();</span><br><span class="line">        attributes.put(<span class="string">"code_verifier"</span>, codeVerifier);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">String</span> codeChallenge = createHash(codeVerifier);</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge"</span>, codeChallenge);</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge_method"</span>, <span class="string">"S256"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge"</span>, codeVerifier);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> createHash(<span class="keyword">String</span> value) <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">"SHA-256"</span>);</span><br><span class="line">        <span class="built_in">byte</span>[] digest = md.digest(value.getBytes(StandardCharsets.US_ASCII));</span><br><span class="line">        <span class="keyword">return</span> Base64.getUrlEncoder().withoutPadding().encodeToString(digest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在SecurityConfig中配置应用CustomAuthorizationRequestResolver。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> CustomAuthorizationRequestResolver(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; <span class="title">authorizationRequestRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionOAuth2AuthorizationRequestRepository();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//clientRegistrationId集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; clients = Arrays.asList(<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLIENT_PROPERTY_KEY = <span class="string">"spring.security.oauth2.client.registration."</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLIENT_PROVIDER_KEY = <span class="string">"spring.security.oauth2.client.provider."</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientRegistrationRepository <span class="title">clientRegistrationRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Steam获取clients对应ClientRegistration，筛掉空值</span></span><br><span class="line">        List&lt;ClientRegistration&gt; registrations = clients.stream()</span><br><span class="line">                .map(c -&gt; getRegistration(c))</span><br><span class="line">                .filter(registration -&gt; registration != <span class="keyword">null</span>)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryClientRegistrationRepository(registrations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClientRegistration <span class="title">getRegistration</span><span class="params">(String client)</span> </span>&#123;</span><br><span class="line">        String clientId = env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".client-id"</span>);</span><br><span class="line">        <span class="keyword">if</span> (clientId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String clientSecret = env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".client-secret"</span>);</span><br><span class="line">        <span class="keyword">if</span> (client.equals(<span class="string">"cpdemo-client"</span>)) &#123;</span><br><span class="line">            String provider = <span class="string">"cpdemo"</span>;</span><br><span class="line">            ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(client);</span><br><span class="line">            <span class="keyword">return</span> builder.clientId(clientId)</span><br><span class="line">                    .clientSecret(clientSecret)</span><br><span class="line">                    .clientAuthenticationMethod(ClientAuthenticationMethod.BASIC)</span><br><span class="line">                    .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)</span><br><span class="line">                    .redirectUriTemplate(env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".redirect-uri"</span>))</span><br><span class="line">                    .scope(env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".scope"</span>))</span><br><span class="line">                    .authorizationUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".authorization-uri"</span>))</span><br><span class="line">                    .tokenUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".token-uri"</span>))</span><br><span class="line">                    .userInfoUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".user-info-uri"</span>)).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现之前的问题解决，但发现授权平台提供的token请求和响应格式与标准不同，需要自定义修改。</p>
<h4 id="1-3-2-自定义Access-Token-Request和Access-Token-Response"><a href="#1-3-2-自定义Access-Token-Request和Access-Token-Response" class="headerlink" title="1.3.2 自定义Access_Token_Request和Access_Token_Response"></a><strong>1.3.2 自定义Access_Token_Request和Access_Token_Response</strong></h4><p>&emsp;&emsp;首先实现CustomRequestEntityConverter，为token请求增加参数client_id和client_secret。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRequestEntityConverter</span> <span class="title">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">Converter</span>&lt;<span class="title">OAuth2AuthorizationCodeGrantRequest</span>, <span class="title">RequestEntity</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> CLIENT_PROPERTY_KEY = <span class="string">"spring.security.oauth2.client.registration.cpdemo-client."</span>;</span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizationCodeGrantRequestEntityConverter defaultConverter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CustomRequestEntityConverter(Environment env) &#123;</span><br><span class="line">        defaultConverter = <span class="keyword">new</span> <span class="type">OAuth2AuthorizationCodeGrantRequestEntityConverter</span>();</span><br><span class="line">        <span class="built_in">this</span>.env = env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定以请求参数格式，增加client_id和client_secret</span></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> RequestEntity&lt;?&gt; convert(OAuth2AuthorizationCodeGrantRequest req) &#123;</span><br><span class="line">        RequestEntity&lt;?&gt; entity = defaultConverter.convert(req);</span><br><span class="line">        MultiValueMap&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; params = (MultiValueMap&lt;<span class="keyword">String</span>,<span class="keyword">String</span>&gt;) entity.getBody();</span><br><span class="line">        params.add(<span class="string">"client_id"</span>, env.getProperty(CLIENT_PROPERTY_KEY + <span class="string">"client-id"</span>));</span><br><span class="line">        params.add(<span class="string">"client_secret"</span>, env.getProperty(CLIENT_PROPERTY_KEY + <span class="string">"client-secret"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">RequestEntity</span>&lt;&gt;(params, entity.getHeaders(),</span><br><span class="line">                entity.getMethod(), entity.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后实现CustomTokenResponseConverter，为token响应配置参数格式。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CustomTokenResponseConverter</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">Converter</span>&lt;<span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;, <span class="title">OAuth2AccessTokenResponse</span>&gt; </span>&#123;</span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; TOKEN_RESPONSE_PARAMETER_NAMES = Stream.of(</span><br><span class="line">            OAuth2ParameterNames.ACCESS_TOKEN,</span><br><span class="line">            OAuth2ParameterNames.TOKEN_TYPE,</span><br><span class="line">            OAuth2ParameterNames.EXPIRES_IN,</span><br><span class="line">            OAuth2ParameterNames.REFRESH_TOKEN,</span><br><span class="line">            OAuth2ParameterNames.SCOPE).collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义OAuth2AccessTokenResponse返回参数格式</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public OAuth2AccessTokenResponse convert(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; tokenResponseParameters) &#123;</span><br><span class="line">        <span class="built_in">String</span> accessToken = tokenResponseParameters.<span class="keyword">get</span>(OAuth2ParameterNames.ACCESS_TOKEN);</span><br><span class="line"></span><br><span class="line">        long expiresIn = Long.valueOf(tokenResponseParameters.<span class="keyword">get</span>(OAuth2ParameterNames.EXPIRES_IN));</span><br><span class="line">        OAuth2AccessToken.TokenType accessTokenType = OAuth2AccessToken.TokenType.BEARER;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; scopes = Collections.emptySet();</span><br><span class="line">        <span class="keyword">if</span> (tokenResponseParameters.containsKey(OAuth2ParameterNames.SCOPE)) &#123;</span><br><span class="line">            <span class="built_in">String</span> scope = tokenResponseParameters.<span class="keyword">get</span>(OAuth2ParameterNames.SCOPE);</span><br><span class="line">            scopes = Arrays.stream(StringUtils.delimitedListToStringArray(scope, <span class="string">","</span>))</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> OAuth2AccessTokenResponse.withToken(accessToken)</span><br><span class="line">                .tokenType(accessTokenType)</span><br><span class="line">                .expiresIn(expiresIn)</span><br><span class="line">                .scopes(scopes)</span><br><span class="line"><span class="comment">//                .refreshToken(refreshToken)</span></span><br><span class="line"><span class="comment">//                .additionalParameters(additionalParameters)</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后修改SecurityConfig，增加token端点配置。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void configure(<span class="type">HttpSecurity</span> http) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> <span class="type">CustomAuthorizationRequestResolver</span>(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过自定义OAuth2AccessTokenResponseClient来自定义token请求</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    public <span class="type">OAuth2AccessTokenResponseClient</span>&lt;<span class="type">OAuth2AuthorizationCodeGrantRequest</span>&gt; accessTokenResponseClient()&#123;</span><br><span class="line">        <span class="type">DefaultAuthorizationCodeTokenResponseClient</span> accessTokenResponseClient =</span><br><span class="line">                <span class="keyword">new</span> <span class="type">DefaultAuthorizationCodeTokenResponseClient</span>();</span><br><span class="line">        <span class="comment">//自定义req</span></span><br><span class="line">        accessTokenResponseClient.setRequestEntityConverter(<span class="keyword">new</span> <span class="type">CustomRequestEntityConverter</span>(env));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启用OAuth2AccessTokenResponseHttpMessageConverter来转换HTTP消息，获取OAuth2AccessTokenResponse</span></span><br><span class="line">        <span class="type">OAuth2AccessTokenResponseHttpMessageConverter</span> tokenResponseHttpMessageConverter =</span><br><span class="line">                <span class="keyword">new</span> <span class="type">OAuth2AccessTokenResponseHttpMessageConverter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义rep</span></span><br><span class="line">        tokenResponseHttpMessageConverter.setTokenResponseConverter(<span class="keyword">new</span> <span class="type">CustomTokenResponseConverter</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//为Rest Http工具配置适用的HttpMessageConverter</span></span><br><span class="line">        <span class="type">RestTemplate</span> restTemplate = <span class="keyword">new</span> <span class="type">RestTemplate</span>(<span class="type">Arrays</span>.asList(</span><br><span class="line">                <span class="keyword">new</span> <span class="type">FormHttpMessageConverter</span>(), tokenResponseHttpMessageConverter));</span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> <span class="type">OAuth2ErrorResponseErrorHandler</span>());</span><br><span class="line">        accessTokenResponseClient.setRestOperations(restTemplate);</span><br><span class="line">        <span class="keyword">return</span> accessTokenResponseClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现之前的问题解决，但获取用户信息的响应格式需要自定义。</p>
<h4 id="1-3-3-自定义User-Info-Response"><a href="#1-3-3-自定义User-Info-Response" class="headerlink" title="1.3.3 自定义User_Info_Response"></a><strong>1.3.3 自定义User_Info_Response</strong></h4><p>&emsp;&emsp;创建CustomOAuth2User，对应user-info响应消息格式。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOAuth2User</span> <span class="title">implements</span> <span class="title">OAuth2User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities =</span><br><span class="line">            AuthorityUtils.createAuthorityList(<span class="string">"ROLE_USER"</span>);</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attributes;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"campus_user_id"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"campus_id"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"tenant_code"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String tenantCode;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"user_name"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"user_type"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@JsonProperty(required = true,value = <span class="meta-string">"gender"</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String getName() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; getAttributes() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.attributes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.attributes = new HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"id"</span>, <span class="keyword">this</span>.id);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"userId"</span>, <span class="keyword">this</span>.userId);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"tenantCode"</span>, <span class="keyword">this</span>.tenantCode);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"name"</span>, <span class="keyword">this</span>.name);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"type"</span>, <span class="keyword">this</span>.type);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"gender"</span>, <span class="keyword">this</span>.gender);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;修改SecurityConfig，增加customUserType配置。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void configure(<span class="type">HttpSecurity</span> http) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> <span class="type">CustomAuthorizationRequestResolver</span>(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                    .and()</span><br><span class="line">                .userInfoEndpoint()</span><br><span class="line">                    .customUserType(<span class="type">CustomOAuth2User</span>.<span class="keyword">class</span>,<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现get user info流程报错，如下，user-info的响应编码格式为octet-stream，但默认的转换器不支持。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">no</span> suitable HttpMessageConverter found <span class="keyword">for</span> response<span class="built_in"> type </span>[XXX] <span class="keyword">and</span> content<span class="built_in"> type </span>[application/octet-stream]</span><br></pre></td></tr></table></figure>
<h4 id="1-3-4-自定义User-Info-Request"><a href="#1-3-4-自定义User-Info-Request" class="headerlink" title="1.3.4 自定义User_Info_Request"></a><strong>1.3.4 自定义User_Info_Request</strong></h4><p>&emsp;&emsp;自定义OAuth2UserService，为RestTemplate配置支持OCTET_STREAM（CustomOAuth2UserRequestEntityConverter此时还为OAuth2UserRequestEntityConverter）</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserService</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">OAuth2UserService</span></span>&lt;<span class="title">OAuth2UserRequest</span>, <span class="title">OAuth2User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> final Map&lt;<span class="keyword">String</span>, Class&lt;? extends OAuth2User&gt;&gt; customUserTypes;</span><br><span class="line">    <span class="keyword">private</span> Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = <span class="keyword">new</span> <span class="type">CustomOAuth2UserRequestEntityConverter</span>();</span><br><span class="line">    <span class="keyword">private</span> RestOperations restOperations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CustomUserService(Map&lt;<span class="keyword">String</span>, Class&lt;? extends OAuth2User&gt;&gt; customUserTypes) &#123;</span><br><span class="line">        Assert.notEmpty(customUserTypes, <span class="string">"customUserTypes cannot be empty"</span>);</span><br><span class="line">        <span class="built_in">this</span>.customUserTypes = Collections.unmodifiableMap(<span class="keyword">new</span> <span class="type">LinkedHashMap</span>(customUserTypes));</span><br><span class="line">        <span class="comment">//打印RestTemplate的Http请求日志</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> <span class="type">RestTemplate</span>(<span class="keyword">new</span> <span class="type">BufferingClientHttpRequestFactory</span>(<span class="keyword">new</span> <span class="type">SimpleClientHttpRequestFactory</span>()));</span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">        interceptors.add(<span class="keyword">new</span> <span class="type">LoggingRequestInterceptor</span>());</span><br><span class="line">        restTemplate.setInterceptors(interceptors);</span><br><span class="line">        <span class="comment">//解决no suitable HttpMessageConverter found for response type [CustomOAuth2User] and content type [application/octet-stream]</span></span><br><span class="line">        MappingJackson2HttpMessageConverter converter = <span class="keyword">new</span> <span class="type">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">        converter.setSupportedMediaTypes(Arrays.asList(<span class="keyword">new</span> <span class="type">MediaType</span>[]&#123;MediaType.APPLICATION_JSON, MediaType.APPLICATION_OCTET_STREAM&#125;));</span><br><span class="line">        restTemplate.setMessageConverters(Arrays.asList(converter, <span class="keyword">new</span> <span class="type">FormHttpMessageConverter</span>()));</span><br><span class="line">        <span class="built_in">this</span>.restOperations = restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException &#123;</span><br><span class="line">        Assert.notNull(userRequest, <span class="string">"userRequest cannot be null"</span>);</span><br><span class="line">        <span class="keyword">String</span> registrationId = userRequest.getClientRegistration().getRegistrationId();</span><br><span class="line">        Class customUserType;</span><br><span class="line">        <span class="keyword">if</span> ((customUserType = (Class)<span class="built_in">this</span>.customUserTypes.<span class="keyword">get</span>(registrationId)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//添加参数</span></span><br><span class="line">            System.out.println(<span class="string">"此时access token ："</span> + userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            System.out.println(<span class="string">"此时AdditionalParameters ："</span> + userRequest.getAdditionalParameters().toString());</span><br><span class="line"></span><br><span class="line">            RequestEntity request = (RequestEntity)<span class="built_in">this</span>.requestEntityConverter.convert(userRequest);</span><br><span class="line"></span><br><span class="line">            ResponseEntity response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = <span class="built_in">this</span>.restOperations.exchange(request, customUserType);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RestClientException var8) &#123;</span><br><span class="line">                OAuth2Error oauth2Error = <span class="keyword">new</span> <span class="type">OAuth2Error</span>(<span class="string">"invalid_user_info_response"</span>, <span class="string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + var8.getMessage(), (<span class="keyword">String</span>)<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">OAuth2AuthenticationException</span>(oauth2Error, oauth2Error.toString(), var8);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            OAuth2User oauth2User = (OAuth2User)response.getBody();</span><br><span class="line">            <span class="keyword">return</span> oauth2User;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> final void setRequestEntityConverter(Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter) &#123;</span><br><span class="line">        Assert.notNull(requestEntityConverter, <span class="string">"requestEntityConverter cannot be null"</span>);</span><br><span class="line">        <span class="built_in">this</span>.requestEntityConverter = requestEntityConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> final void setRestOperations(RestOperations restOperations) &#123;</span><br><span class="line">        Assert.notNull(restOperations, <span class="string">"restOperations cannot be null"</span>);</span><br><span class="line">        <span class="built_in">this</span>.restOperations = restOperations;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过实现ClientHttpRequestInterceptor接口来对RestTemplate打印日志。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class LoggingRequestInterceptor implements ClientHttpRequestInterceptor &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(LoggingRequestInterceptor.class);</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> ClientHttpResponse intercept(HttpRequest httpRequest, <span class="built_in">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)<span class="keyword">throws</span> UnsupportedEncodingException,IOException &#123;</span><br><span class="line">        traceRequest(httpRequest,bytes);</span><br><span class="line">        ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest,bytes);</span><br><span class="line">        traceResponse(response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> traceRequest(HttpRequest httpRequest, <span class="built_in">byte</span>[] bytes)<span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=============================request begin=============================="</span>);</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"URI            : &#123;&#125;"</span>,httpRequest.getURI());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"Method         : &#123;&#125;"</span>,httpRequest.getMethod());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"Headers        : &#123;&#125;"</span>,httpRequest.getHeaders());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"Body           : &#123;&#125;"</span>,<span class="keyword">new</span> <span class="keyword">String</span>(bytes,<span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=============================request end=============================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> traceResponse(ClientHttpResponse response)<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        StringBuilder inputStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">BufferedReader</span> reader = <span class="keyword">new</span> <span class="keyword">BufferedReader</span>(<span class="keyword">new</span> InputStreamReader(response.getBody(),<span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="keyword">String</span> <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">line</span> != <span class="keyword">null</span>)&#123;</span><br><span class="line">            inputStringBuilder.<span class="built_in">append</span>(<span class="built_in">line</span>);</span><br><span class="line">            inputStringBuilder.<span class="built_in">append</span>(<span class="string">'\n'</span>);</span><br><span class="line">            <span class="built_in">line</span> = reader.readLine();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=============================response begin=============================="</span>);</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"StatusCode     : &#123;&#125;"</span>,response.getStatusCode());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"StatusText     : &#123;&#125;"</span>,response.getStatusText());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"Headers        : &#123;&#125;"</span>,response.getHeaders());</span><br><span class="line">        <span class="built_in">log</span>.debug(<span class="string">"Body           : &#123;&#125;"</span>,inputStringBuilder.toString());</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">"=============================response end=============================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;修改SecurityConfig，增加userService配置。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void configure(<span class="type">HttpSecurity</span> http) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>, <span class="string">"/login**"</span>,<span class="string">"/callback/"</span>, <span class="string">"/webjars/**"</span>, <span class="string">"/error**"</span>, <span class="string">"/oauth2/authorization/**"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span>&lt;<span class="type">String</span>,<span class="type">Class</span>&lt;? <span class="keyword">extends</span> <span class="type">OAuth2User</span>&gt;&gt; customUserTypes = <span class="keyword">new</span> <span class="type">HashMap</span>&lt;&gt;();</span><br><span class="line">        customUserTypes.put(<span class="string">"cpdemo-client"</span>,<span class="type">CustomOAuth2User</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> <span class="type">CustomAuthorizationRequestResolver</span>(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                    .and()</span><br><span class="line">                .userInfoEndpoint()</span><br><span class="line">                    .userService(<span class="keyword">new</span> <span class="type">CustomUserService</span>(customUserTypes))</span><br><span class="line">                    .customUserType(<span class="type">CustomOAuth2User</span>.<span class="keyword">class</span>,<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    public <span class="type">AuthorizationRequestRepository</span>&lt;<span class="type">OAuth2AuthorizationRequest</span>&gt; authorizationRequestRepository() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">HttpSessionOAuth2AuthorizationRequestRepository</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现提示请求Token时未提供所需参数，根据接口文档发现授权服务器要求把授权令牌写入Get_Parm，查看源码可以发现默认Converter会根据请求类别把授权令牌放入HEADER或FORM_PARM。</p>
<p>&emsp;&emsp;自定义转换器CustomOAuth2UserRequestEntityConverter，强行将access_token拼入URL。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOAuth2UserRequestEntityConverter</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Converter</span></span>&lt;<span class="title">OAuth2UserRequest</span>, <span class="title">RequestEntity</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final MediaType DEFAULT_CONTENT_TYPE = MediaType.valueOf(<span class="string">"application/x-www-form-urlencoded;charset=UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CustomOAuth2UserRequestEntityConverter() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> RequestEntity&lt;?&gt; convert(OAuth2UserRequest userRequest) &#123;</span><br><span class="line">        ClientRegistration clientRegistration = userRequest.getClientRegistration();</span><br><span class="line">        HttpMethod httpMethod = HttpMethod.GET;</span><br><span class="line">        <span class="keyword">if</span> (AuthenticationMethod.FORM.equals(clientRegistration.getProviderDetails().getUserInfoEndpoint().getAuthenticationMethod())) &#123;</span><br><span class="line">            httpMethod = HttpMethod.POST;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> <span class="type">HttpHeaders</span>();</span><br><span class="line">        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span><br><span class="line"><span class="comment">//        URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getUserInfoEndpoint().getUri()).build().toUri();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//强行拼接</span></span><br><span class="line">        URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getUserInfoEndpoint().getUri()</span><br><span class="line">                + <span class="string">"?access_token="</span> + userRequest.getAccessToken().getTokenValue()).build().toUri();</span><br><span class="line"></span><br><span class="line">        RequestEntity request;</span><br><span class="line">        <span class="keyword">if</span> (HttpMethod.POST.equals(httpMethod)) &#123;</span><br><span class="line">            headers.setContentType(DEFAULT_CONTENT_TYPE);</span><br><span class="line">            MultiValueMap&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; formParameters = <span class="keyword">new</span> <span class="type">LinkedMultiValueMap</span>();</span><br><span class="line">            formParameters.add(<span class="string">"access_token"</span>, userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            request = <span class="keyword">new</span> <span class="type">RequestEntity</span>(formParameters, headers, httpMethod, uri);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            headers.setBearerAuth(userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            request = <span class="keyword">new</span> <span class="type">RequestEntity</span>(headers, httpMethod, uri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现问题解决，流程跑通。</p>
<hr>
<p><em>参考博客和文章书籍等：</em></p>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-security/wiki/OAuth-2.0-Migration-Guide" title="Title" target="_blank" rel="noopener">OAuth-2.0-Migration-Guide</a></p>
</blockquote>
<blockquote>
<p><a href="https://projects.spring.io/spring-security-oauth/docs/Home.html" title="Title" target="_blank" rel="noopener">spring-security-oauth</a></p>
</blockquote>
<blockquote>
<p><a href="https://mrbird.cc/Spring-Security-OAuth2-Guide.html" title="Title" target="_blank" rel="noopener">Spring Security OAuth2入门</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.jianshu.com/p/cb886f995e86?utm_source=oschina-app" title="Title" target="_blank" rel="noopener">深入理解Spring Cloud Security OAuth2及JWT</a></p>
</blockquote>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/74267287" title="Title" target="_blank" rel="noopener">OAuth2实现单点登录SSO</a></p>
</blockquote>
<blockquote>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/webclient.html" title="Title" target="_blank" rel="noopener">Spring文档-26. WebClient</a></p>
</blockquote>
<blockquote>
<p><a href="https://docs.spring.io/spring-security/site/docs/5.0.7.RELEASE/reference/html/oauth2login-advanced.html#oauth2login-advanced-userinfo-endpoint" title="Title" target="_blank" rel="noopener">Spring文档-31.OAuth 2.0 Login</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.ziyueknow.com/page/spring-security/part06-3.html#oauth2login-advanced-userinfo-endpoint" title="Title" target="_blank" rel="noopener">Spring文档中文翻译</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.cnblogs.com/cjsblog/p/9241217.html" title="Title" target="_blank" rel="noopener">Spring Boot OAuth 2.0 客户端</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.baeldung.com/spring-webclient-oauth2" title="Title" target="_blank" rel="noopener">baeldung：Spring WebClient and OAuth2 Support</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.baeldung.com/spring-security-custom-oauth-requests" title="Title" target="_blank" rel="noopener">baeldung：Customizing Authorization and Token Requests with Spring Security 5.1 Client</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/eugenp/tutorials/tree/master/spring-5-security-oauth" title="Title" target="_blank" rel="noopener">github：spring-5-security-oauth</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">github：spring-security-oauth-5-2-migrate</a></p>
</blockquote>
<blockquote>
<p><a href="https://objectpartners.com/2018/03/01/log-your-resttemplate-request-and-response-without-destroying-the-body/" title="Title" target="_blank" rel="noopener">Log your RestTemplate Request and Response without destroying the body</a></p>
</blockquote>
<blockquote>
<p><a href="https://dzone.com/articles/spring-boot-how-to-solve-oauth2-err-too-many-redir" title="Title" target="_blank" rel="noopener">Spring Boot: Solving OAuth2 ERR_TOO_MANY_REDIRECTS [Snippet]</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/57761917/spring-5-security-oauth2-login-redirect-loop" title="Title" target="_blank" rel="noopener">stackoverflow：Spring 5 Security OAuth2 Login Redirect Loop</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/49315552/authorizationgranttype-cannot-be-null-in-spring-security-5-oauth-client-and-spri" title="Title" target="_blank" rel="noopener">stackoverflow：authorizationGrantType cannot be null in Spring Security 5 OAuth Client and Spring Boot 2.0</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/49062866/spring-boot-resttemplate-response-body-is-null-while-interceptor-clearly-shows-b" title="Title" target="_blank" rel="noopener">stackoverflow：Spring-boot Resttemplate response.body is null while interceptor clearly shows body</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/50908023/using-spring-security-oauth-using-a-custom-oauth-provider-i-get-authorization" title="Title" target="_blank" rel="noopener">stackoverflow：Using Spring security oauth, using a custom OAuth provider, I get [authorization_request_not_found], should I handle the callback method myself?</a><br>y-shows-b “Title”)</p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/7952154/spring-resttemplate-how-to-enable-full-debugging-logging-of-requests-responses" title="Title" target="_blank" rel="noopener">stackoverflow：Spring RestTemplate - how to enable full debugging/logging of requests/responses?</a></p>
</blockquote>
<p><em>因博客主等未标明不可引用，若部分内容涉及侵权请及时告知，我会尽快修改和删除相关内容</em></p>

      
    </div>
    
    
    

    

    

    

    
      <div>
         ﻿<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      </div>
    


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring-boot/" rel="tag"># spring boot</a>
          
            <a href="/tags/unfinished/" rel="tag"># unfinished</a>
          
            <a href="/tags/oauth2/" rel="tag"># oauth2</a>
          
            <a href="/tags/spring-security/" rel="tag"># spring security</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019111601.html" rel="next" title="OAuth2协议框架">
                <i class="fa fa-chevron-left"></i> OAuth2协议框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019111801.html" rel="prev" title="AES加密">
                AES加密 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg"
                alt="沂水" />
            
              <p class="site-author-name" itemprop="name">沂水</p>
              <p class="site-description motion-element" itemprop="description">记录编程点滴，写点生活中的酸甜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">176</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/LAILAIWA" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:linyishui168@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/linyishui618" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5340162234" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo.com"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-OAuth2"><span class="nav-number">1.</span> <span class="nav-text">Spring Security OAuth2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一节-简介"><span class="nav-number">1.1.</span> <span class="nav-text">第一节 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二节-Spring新版本迁移"><span class="nav-number">1.2.</span> <span class="nav-text">第二节 Spring新版本迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-客户端-Client"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 客户端 Client</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-RestTemplate-and-WebClient"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">2.1.1 RestTemplate and WebClient</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-Simplified-Client-Resolution"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">2.1.2 Simplified Client Resolution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-Enhanced-Client-Resolution"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">2.1.3 Enhanced Client Resolution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-Simplified-JWT-Support"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">2.1.4 Simplified JWT Support</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-5-示例-Examples-Matrix"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">2.1.5 示例 Examples Matrix</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-登录-Login"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 登录 Login</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-方法变更-Changes-In-Approach"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.2.1 方法变更 Changes In Approach</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-资源服务器-Resource-Server"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 资源服务器 Resource Server</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-方法变更-Changes-In-Approach"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">2.3.1 方法变更 Changes In Approach</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-示例-Examples-Matrix"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2.3.2 示例 Examples Matrix</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-未移植功能-Unported-Features"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">2.3.3 未移植功能 Unported Features</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三节-实战：实现单点登录"><span class="nav-number">1.3.</span> <span class="nav-text">第三节 实战：实现单点登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四节-实战：APP平台第三方应用授权"><span class="nav-number">1.4.</span> <span class="nav-text">第四节 实战：APP平台第三方应用授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第五节-问题记录：得到授权code后无法获取访问令牌"><span class="nav-number">1.5.</span> <span class="nav-text">第五节 问题记录：得到授权code后无法获取访问令牌</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-问题描述"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.1 问题描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-问题跟踪"><span class="nav-number">1.5.2.</span> <span class="nav-text">1.2 问题跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-问题处理"><span class="nav-number">1.5.3.</span> <span class="nav-text">1.3 问题处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-自定义Authorization-Code-Request"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">1.3.1 自定义Authorization_Code_Request</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-自定义Access-Token-Request和Access-Token-Response"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">1.3.2 自定义Access_Token_Request和Access_Token_Response</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-3-自定义User-Info-Response"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">1.3.3 自定义User_Info_Response</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-4-自定义User-Info-Request"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">1.3.4 自定义User_Info_Request</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沂水</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<!-- 
  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
   <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":true,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":125,"height":250},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script>

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
