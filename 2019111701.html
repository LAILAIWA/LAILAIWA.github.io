<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig Dug.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="mask-icon" href="/images/gamepad playstation.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="spring boot,oauth2,spring security,">





  <link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml">






<meta name="description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta name="keywords" content="spring boot,oauth2,spring security">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security OAuth2">
<meta property="og:url" content="http://linyishui.top/2019111701.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010138.jpg">
<meta property="og:updated_time" content="2020-08-01T14:05:35.716Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Security OAuth2">
<meta name="twitter:description" content="Spring Security OAuth2实战练习，内容包括：等。">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linyishui.top/2019111701.html">





  <title>Spring Security OAuth2 | 俺的部落格</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '[object Object]', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a73137787baf0001a5bc4063855efe8a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">俺的部落格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">俺寻思俺需要记点东西</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2019111701.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="林沂水">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Security OAuth2</h1>
        

        <div class="post-meta">
          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-17T15:53:56+08:00">
                2019-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术文档/" itemprop="url" rel="index">
                    <span itemprop="name">技术文档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,330
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  35
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Spring Security OAuth2实战练习，内容包括：等。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Spring-Security-OAuth2"><a href="#Spring-Security-OAuth2" class="headerlink" title="Spring Security OAuth2"></a><strong>Spring Security OAuth2</strong></h1><h2 id="第一节-简介"><a href="#第一节-简介" class="headerlink" title="第一节 简介"></a><strong>第一节 简介</strong></h2><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010158.png" alt="Spring Security&#39;s OAuth2结构"></p>
<hr>
<h2 id="第二节-Spring新版本迁移"><a href="#第二节-Spring新版本迁移" class="headerlink" title="第二节 Spring新版本迁移"></a><strong>第二节 Spring新版本迁移</strong></h2><p>&emsp;&emsp;OAuth 2.0客户端和资源服务器从Spring Security OAuth 2.x移动到Spring Security 5.2.x的指南。由于<a href="https://github.com/spring-projects/spring-security" title="Title" target="_blank" rel="noopener">Spring Security</a>不提供授权服务器支持，因此迁移<a href="https://github.com/spring-projects/spring-security-oauth" title="Title" target="_blank" rel="noopener">Spring Security OAuth</a>授权服务器超出了本文档的范围</p>
<h3 id="2-1-客户端-Client"><a href="#2-1-客户端-Client" class="headerlink" title="2.1 客户端 Client"></a><strong>2.1 客户端 Client</strong></h3><p>&emsp;&emsp;通过添加@EnableOAuth2Client注释可以启用Spring Security OAuth对Authorization Code flow的支持，而其他的flows则需要构造并公开OAuth2ClientContext实例。</p>
<p>&emsp;&emsp;Spring Security的OAuth 2.0 Client则是通过oauth2Client的DSL方法启用支持的。</p>
<h4 id="2-1-1-RestTemplate-and-WebClient"><a href="#2-1-1-RestTemplate-and-WebClient" class="headerlink" title="2.1.1 RestTemplate and WebClient"></a><strong>2.1.1 RestTemplate and WebClient</strong></h4><p>&emsp;&emsp;Spring Security OAuth扩展了RestTemplate, 引入了OAuth2RestTemplate，这个类需要注册为@Bean并实例化。</p>
<p>&emsp;&emsp;Spring Security则选择了支持组合并提供了OAuth2AuthorizedClientService,用来帮助创建RestTemplate拦截器或WebClient交换过滤器函数。Spring Security同时为基于Servlet-和基于WebFlux-的应用程序提供了ExchangeFilterFunction。</p>
<h4 id="2-1-2-Simplified-Client-Resolution"><a href="#2-1-2-Simplified-Client-Resolution" class="headerlink" title="2.1.2 Simplified Client Resolution"></a><strong>2.1.2 Simplified Client Resolution</strong></h4><p>&emsp;&emsp;在Spring Security OAuth中检索当前授权的客户端，需要自动注入（autowire）OAuth2ClientContext实例。Spring Security OAuth通过Spring MVCs request以及session scope来存储OAuth2ClientContext实例。</p>
<p>&emsp;&emsp;在Spring Security中检索当前授权的客户端，需要@RegisteredOAuth2AuthorizedClient方法参数注解。Spring Security 把已授权的客户端存储在OAuth2AuthorizedClientRepository中。</p>
<h4 id="2-1-3-Enhanced-Client-Resolution"><a href="#2-1-3-Enhanced-Client-Resolution" class="headerlink" title="2.1.3 Enhanced Client Resolution"></a><strong>2.1.3 Enhanced Client Resolution</strong></h4><p>&emsp;&emsp;Spring Security OAuth通过Spring Boot properties配置单个客户端。</p>
<p>&emsp;&emsp;Spring Security使用ClientRegistrationRepository来表示客户端，客户端可以通过Spring Security DSL来提供或仍使用Spring Boot配置。</p>
<h4 id="2-1-4-Simplified-JWT-Support"><a href="#2-1-4-Simplified-JWT-Support" class="headerlink" title="2.1.4 Simplified JWT Support"></a><strong>2.1.4 Simplified JWT Support</strong></h4><p>&emsp;&emsp;Spring Security OAuth通过spring-security-jwt提供JWT支持。</p>
<p>&emsp;&emsp;Spring Security则依赖于Nimbus提供JWT支持。</p>
<h4 id="2-1-5-示例-Examples-Matrix"><a href="#2-1-5-示例-Examples-Matrix" class="headerlink" title="2.1.5 示例 Examples Matrix"></a><strong>2.1.5 示例 Examples Matrix</strong></h4><p>&emsp;&emsp;Spring Security和Spring Security OAuth2都提供了如何配置客户端的示例：</p>
<table>
<thead>
<tr>
<th style="text-align:left">用例</th>
<th style="text-align:left">Spring Security</th>
<th style="text-align:left">Spring Security OAuth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Authorization Code</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Refresh Token</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Client Credentials</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Resource Owner Password Credentials</td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/jgrandja/spring-security-oauth-2-4-migrate" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
</tbody>
</table>
<h3 id="2-2-登录-Login"><a href="#2-2-登录-Login" class="headerlink" title="2.2 登录 Login"></a><strong>2.2 登录 Login</strong></h3><h4 id="2-2-1-方法变更-Changes-In-Approach"><a href="#2-2-1-方法变更-Changes-In-Approach" class="headerlink" title="2.2.1 方法变更 Changes In Approach"></a><strong>2.2.1 方法变更 Changes In Approach</strong></h4><p>&emsp;&emsp;Spring Security称呼此功能为OAuth 2.0 Login而Spring Security OAuth则称为SSO。</p>
<p>&emsp;&emsp;Spring Security OAuth的SSO支持通过添加@EnableOAuth2Sso注解开启。</p>
<p>&emsp;&emsp;Spring Security的OAuth 2.0 Login支持通过oauth2Login() DSL方法启用的。</p>
<h3 id="2-3-资源服务器-Resource-Server"><a href="#2-3-资源服务器-Resource-Server" class="headerlink" title="2.3 资源服务器 Resource Server"></a><strong>2.3 资源服务器 Resource Server</strong></h3><h4 id="2-3-1-方法变更-Changes-In-Approach"><a href="#2-3-1-方法变更-Changes-In-Approach" class="headerlink" title="2.3.1 方法变更 Changes In Approach"></a><strong>2.3.1 方法变更 Changes In Approach</strong></h4><p>&emsp;&emsp;Spring Security OAuth的资源服务器支持通过添加@EnableResourceServer注解开启。</p>
<p>&emsp;&emsp;Spring Security的资源服务器支持通过oauth2ResourceServer DSL方法启用的。</p>
<p>&emsp;&emsp;Spring Security OAuth为资源服务器提供了两种不同的DSL方法，通过扩展ResourceServerConfigurerAdapter来配置。</p>
<p>&emsp;&emsp;Spring Security通过Spring Security DSL提供相同的功能, 通过扩展WebSecurityConfigurerAdapter来配置。</p>
<p>&emsp;&emsp;Spring Security OAuth为具体授权规则指定了两个位置，第一个是通过ResourceServerConfigurerAdapter - 此处的任意规则都是为存在（present）的bearer token设定，第二个是通过WebSecurityConfigurerAdapter - 此处的任意规则都是为缺席（absent）的bearer token设定。</p>
<p>&emsp;&emsp;Spring Security则标明所有的授权规则都是通过一个或多个WebSecurityConfigurerAdapter配置而来的。</p>
<p>&emsp;&emsp;Spring Security OAuth提供了一个自定义的SpEL变量oauth2。为了基于scope去进行授权请求或方法, 可以编写一个表达式如access(“#oauth2.hasScope(‘scope’)”)。</p>
<p>&emsp;&emsp;Spring Security转换scope遵循授权命名规范。为了基于scope去进行授权请求或方法, 可以编写一个表达式如hasAuthority(“SCOPE_scope”)。</p>
<h4 id="2-3-2-示例-Examples-Matrix"><a href="#2-3-2-示例-Examples-Matrix" class="headerlink" title="2.3.2 示例 Examples Matrix"></a><strong>2.3.2 示例 Examples Matrix</strong></h4><table>
<thead>
<tr>
<th style="text-align:left">用例</th>
<th style="text-align:left">Spring Security</th>
<th style="text-align:left">Spring Security OAuth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JWT + JWK</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-resource-jwt" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">JWT + Key</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver-static" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle/#oauth2-boot-resource-server-jwt-single-key" title="Title" target="_blank" rel="noopener">Doc</a></td>
</tr>
<tr>
<td style="text-align:left">Opaque Token</td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security/tree/master/samples/boot/oauth2resourceserver-opaque" title="Title" target="_blank" rel="noopener">Sample</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-resource" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">w/ Actuator</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#multiple-httpsecurity" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"><a href="https://github.com/spring-projects/spring-security-oauth2-boot/tree/master/samples/spring-boot-sample-secure-oauth2-actuator" title="Title" target="_blank" rel="noopener">Sample</a></td>
</tr>
<tr>
<td style="text-align:left">Audience Validation</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#oauth2resourceserver-jwt-validation-custom" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Authorizing Requests</td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#oauth2resourceserver-jwt-authorization" title="Title" target="_blank" rel="noopener">Doc</a></td>
<td style="text-align:left"><a href="https://docs.spring.io/spring-security-oauth2-boot/docs/current/reference/htmlsingle/#oauth2-boot-resource-server-authorization" title="Title" target="_blank" rel="noopener">Doc</a></td>
</tr>
</tbody>
</table>
<h4 id="2-3-3-未移植功能-Unported-Features"><a href="#2-3-3-未移植功能-Unported-Features" class="headerlink" title="2.3.3 未移植功能 Unported Features"></a><strong>2.3.3 未移植功能 Unported Features</strong></h4><p>&emsp;&emsp;There are some features that we currently have no plans to port over.</p>
<p>&emsp;&emsp;In Spring Security OAuth, you can configure a UserDetailsService to look up a user that corresponds with the incoming bearer token. There are no plans for Spring Security’s Resource Server support to pick up a UserDetailsService. This is still simple in Spring Security, though, via the jwtAuthenticationConverter DSL method. Notably, one can return a BearerTokenAuthentication which takes an instance of OAuth2AuthenticatedPrincipal for a principal.</p>
<p>&emsp;&emsp;In Spring Security OAuth, you can assign an identifier to the resource server via the ResourceServerSecurityConfigurer#resourceId method. This configures the realm name used by the authentication entry point as well as adds audience validation. No such identifier is planned for Spring Security. However, audience validation and a custom realm name are both simple to achieve by configuring an OAuth2TokenValidator and AuthenticationEntryPoint respectively.</p>
<hr>
<h2 id="第三节-实战：实现单点登录"><a href="#第三节-实战：实现单点登录" class="headerlink" title="第三节 实战：实现单点登录"></a><strong>第三节 实战：实现单点登录</strong></h2><p>&emsp;&emsp;</p>
<hr>
<h2 id="第四节-实战：APP平台第三方应用授权"><a href="#第四节-实战：APP平台第三方应用授权" class="headerlink" title="第四节 实战：APP平台第三方应用授权"></a><strong>第四节 实战：APP平台第三方应用授权</strong></h2><p>&emsp;&emsp;首先在平台官网注册成为开发者。</p>
<p>&emsp;&emsp;然后注册应用信息，并搭建好项目。</p>
<p>&emsp;&emsp;OAuth时序图如下，通过OAuth来对接个人项目和APP平台，之后开发完毕后，只要保证提供一个稳定可用的线上版本即可。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20191101/201911010138.jpg" alt="OAuth时序图"></p>
<p>&emsp;&emsp;官网文档提供了OAuth2.0的authorize接口、access token接口、获取用户信息接口。</p>
<p>&emsp;&emsp;怎么通过Spring Security配置OAuth2 Client？找了一下Spring官网Demo：<a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">OAuth-2.0-Migration-Guide</a>，直接按Demo来实现我们的需求。</p>
<p>&emsp;&emsp;代码就没必要再贴一遍了，了解OAuth2协议流程，对整个技术框架都会比较熟悉了，快速的实现需求后，再慢慢解决遇到的问题。</p>
<p>&emsp;&emsp;以下为部分配置文件内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Spring-Security</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.provider=cpdemo</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-id=<span class="number">15764595791470995</span></span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-secret=trmCkkXvNTEtURIZjqj0yQ0A13PJ90</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.authorization-grant-type=authorization_code</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.client-name=TEST</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.redirect-uri=&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;</span><br><span class="line">spring.security.oauth2.client.registration.cpdemo-client.scope=get_user_info</span><br><span class="line"></span><br><span class="line">spring.security.oauth2.client.provider.cpdemo.authorization-uri=https:<span class="comment">//www.cpdemo.com/connect/oauth2/authorize</span></span><br><span class="line">spring.security.oauth2.client.provider.cpdemo.token-uri=https:<span class="comment">//www.cpdemo.com/connect/oauth2/token</span></span><br><span class="line">spring.security.oauth2.client.provider.cpdemo.user-info-uri=https:<span class="comment">//api.cpdemo.com/user/campus/get_user_info</span></span><br><span class="line">spring.security.oauth2.client.provider.cpdemo.user-name-attribute=user_name</span><br><span class="line"></span><br><span class="line"># 解决  Possible CSRF detected - state parameter was required but no state could be found  问题</span><br><span class="line">server.servlet.session.cookie.name=OAUTH2CLIENTSESSION</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="第五节-问题记录：得到授权code后无法获取访问令牌"><a href="#第五节-问题记录：得到授权code后无法获取访问令牌" class="headerlink" title="第五节 问题记录：得到授权code后无法获取访问令牌"></a><strong>第五节 问题记录：得到授权code后无法获取访问令牌</strong></h2><h3 id="1-1-问题描述"><a href="#1-1-问题描述" class="headerlink" title="1.1 问题描述"></a><strong>1.1 问题描述</strong></h3><p>&emsp;&emsp;正常访问<a href="http://localhost:7990/，向server发出授权请求，并重定向到一个PC接口需要用APP端扫码二维码，扫码成功后发生异常，返回/login?error页面提示错误msg：[authorization_request_not_found]" target="_blank" rel="noopener">http://localhost:7990/，向server发出授权请求，并重定向到一个PC接口需要用APP端扫码二维码，扫码成功后发生异常，返回/login?error页面提示错误msg：[authorization_request_not_found]</a></p>
<h3 id="1-2-问题跟踪"><a href="#1-2-问题跟踪" class="headerlink" title="1.2 问题跟踪"></a><strong>1.2 问题跟踪</strong></h3><p>&emsp;&emsp;开始调试代码，并记录访问流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">--首先客户发起请求，收到rep重定向到/index</span><br><span class="line">http:<span class="comment">//localhost:7990/</span></span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response：</span><br><span class="line">        Location: http:<span class="comment">//localhost:7990/index</span></span><br><span class="line"></span><br><span class="line">--请求/index，收到rep重定向到/oauth2/authorization/cpdemo-client，并用Cookie保存session：OAUTH2CLIENTSESSION</span><br><span class="line">http:<span class="comment">//localhost:7990/index</span></span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response：</span><br><span class="line">        Location: http:<span class="comment">//localhost:7990/oauth2/authorization/cpdemo-client</span></span><br><span class="line">        Set-Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA; Path=/; HttpOnly</span><br><span class="line"></span><br><span class="line">--请求/oauth2/authorization/cpdemo-client，携带Cookie，收到rep重定向到www.xxx.com的授权接口，注意此时state为WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%<span class="number">3</span>D</span><br><span class="line">http:<span class="comment">//localhost:7990/oauth2/authorization/cpdemo-client</span></span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA</span><br><span class="line">    Response：</span><br><span class="line">        Location: https:<span class="comment">//www.xxx.com/connect/oauth2/authorize?response_type=code&amp;client_id=xxx&amp;scope=get_user_info&amp;state=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%3D&amp;redirect_uri=http://localhost:7990/login/oauth2/code/cpdemo-client</span></span><br><span class="line"></span><br><span class="line">--请求www.cpdemo.com的授权接口，收到rep重定向到/pc/qrcode/index.html，并用保存Cookie：acw_tc，授权服务器检测到PC端访问，跳转到一个二维码界面</span><br><span class="line">https:<span class="comment">//www.cpdemo.com/connect/oauth2/authorize?response_type=code&amp;client_id=xxx&amp;scope=get_user_info&amp;state=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ%3D&amp;redirect_uri=http://localhost:7990/login/oauth2/code/cpdemo-client</span></span><br><span class="line">    Status Code: <span class="number">302</span> </span><br><span class="line">    Response</span><br><span class="line">        Location: https:<span class="comment">//www.cpdemo.com/connect/pc/qrcode/index.html?response_type=code&amp;scope=get_user_info&amp;client_id=15764595791470995&amp;redirect_uri=http%3A%2F%2Flocalhost%3A7990%2Flogin%2Foauth2%2Fcode%2Fcpdemo-client&amp;state=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=&amp;top_redirect=&amp;support_free_login=&amp;_=1577692641980#</span></span><br><span class="line">        Set-Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46;path=/;HttpOnly;Max-Age=<span class="number">2678401</span></span><br><span class="line"></span><br><span class="line">--请求/pc/qrcode/index.html，携带Cookie，获取二维码界面</span><br><span class="line">https:<span class="comment">//www.cpdemo.com/connect/pc/qrcode/index.html?response_type=code&amp;scope=get_user_info&amp;client_id=xxx&amp;redirect_uri=http%3A%2F%2Flocalhost%3A7990%2Flogin%2Foauth2%2Fcode%2Fcpdemo-client&amp;state=WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=&amp;top_redirect=&amp;support_free_login=&amp;_=xxx</span></span><br><span class="line">    Status Code: <span class="number">200</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46</span><br><span class="line"></span><br><span class="line">--扫码登陆，并携带新的参数，注意此时state值为login</span><br><span class="line">https:<span class="comment">//www.cpdemo.com/connect/qrcode/jsLogin</span></span><br><span class="line">    Status Code: <span class="number">200</span> </span><br><span class="line">    Request：</span><br><span class="line">        Cookie: acw_tc=<span class="number">76</span>b20fec15776926419723186e2e77475066dc07c6ab3101e3cd340c96ff46</span><br><span class="line">    Playload：</span><br><span class="line">        clientId: <span class="string">"xxx"</span></span><br><span class="line">        redirectUri: <span class="string">"http://localhost:7990/login/oauth2/code/cpdemo-client"</span></span><br><span class="line">        scope: <span class="string">"get_user_info"</span></span><br><span class="line">        responseType: <span class="string">"code"</span></span><br><span class="line">        state: <span class="string">"login"</span></span><br><span class="line">        supportFreeLogin: <span class="string">""</span></span><br><span class="line"></span><br><span class="line">--登陆成功，重定向到redirectUri：/login/oauth2/code/cpdemo-client，并携带授权code和state，请求失败，跳转error界面</span><br><span class="line">http:<span class="comment">//localhost:7990/login/oauth2/code/cpdemo-client?code=cCrxmz1ds745WmV4WPYa1577692667&amp;state=login</span></span><br><span class="line">    Request：</span><br><span class="line">        Cookie: OAUTH2CLIENTSESSION=<span class="number">907</span>AE53F4C3C1DA967944F7B89E295EA</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;再看DEBUG日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">--本地客户端服务器收到code和state</span><br><span class="line">o.a.coyote.http11.Http11InputBuffer      : Received [GET /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login HTTP/<span class="number">1.1</span></span><br><span class="line"></span><br><span class="line">Host: localhost:<span class="number">7990</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">79.0</span>.3945.88 Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: cross-site</span></span><br><span class="line"><span class="comment">Sec-Fetch-Mode: navigate</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span></span><br><span class="line"><span class="comment">Cookie: OAUTH2CLIENTSESSION=9F0F448755B953A5542B4E2856AC7C54</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--过滤器校验</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 1 of 15 in additional filter chain; firing Filter: 'WebAsyncManagerIntegrationFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 2 of 15 in additional filter chain; firing Filter: 'SecurityContextPersistenceFilter'</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--HttpSessionSecurityContextRepository提示取不到HttpSession</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] w.c.HttpSessionSecurityContextRepository : No HttpSession currently exists</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] w.c.HttpSessionSecurityContextRepository : No SecurityContext was available from the HttpSession: null. A new one will be created.</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 3 of 15 in additional filter chain; firing Filter: 'HeaderWriterFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 4 of 15 in additional filter chain; firing Filter: 'CsrfFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 5 of 15 in additional filter chain; firing Filter: 'LogoutFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.s.w.u.matcher.AntPathRequestMatcher  : Request 'GET /login/oauth2/code/cpdemo-client' doesn't match 'POST /logout'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 6 of 15 in additional filter chain; firing Filter: 'OAuth2AuthorizationRequestRedirectFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/login/oauth2/code/cpdemo-client'; against '/oauth2/authorization/&#123;registrationId&#125;'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] org.apache.tomcat.util.http.Parameters   : Set encoding to UTF-8</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] org.apache.tomcat.util.http.Parameters   : Decoding query null UTF-8</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] org.apache.tomcat.util.http.Parameters   : Start processing with input [code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login]</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.889 DEBUG 20732 --- [nio-7990-exec-1] o.s.security.web.FilterChainProxy        : /login/oauth2/code/cpdemo-client?code=PYd42xxZiDccJH5K6Hmz1577674731&amp;state=login at position 7 of 15 in additional filter chain; firing Filter: 'OAuth2LoginAuthenticationFilter'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.905 DEBUG 20732 --- [nio-7990-exec-1] o.s.s.w.u.matcher.AntPathRequestMatcher  : Checking match of request : '/login/oauth2/code/cpdemo-client'; against '/login/oauth2/code/*'</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--OAuth2LoginAuthenticationFilter抛出异常OAuth2AuthenticationException：[authorization_request_not_found] </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.905 DEBUG 20732 --- [nio-7990-exec-1] .s.o.c.w.OAuth2LoginAuthenticationFilter : Request is to process authentication</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.912 DEBUG 20732 --- [nio-7990-exec-1] .s.o.c.w.OAuth2LoginAuthenticationFilter : Authentication request failed: org.springframework.security.oauth2.core.OAuth2AuthenticationException: [authorization_request_not_found] </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">org.springframework.security.oauth2.core.OAuth2AuthenticationException: [authorization_request_not_found] </span></span><br><span class="line"><span class="comment">	at org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter.attemptAuthentication(OAuth2LoginAuthenticationFilter.java:163) ~[spring-security-oauth2-client-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line"><span class="comment">	at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:212) ~[spring-security-web-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line"><span class="comment">	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:334) [spring-security-web-5.2.1.RELEASE.jar:5.2.1.RELEASE]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.914 DEBUG 20732 --- [nio-7990-exec-1] .s.o.c.w.OAuth2LoginAuthenticationFilter : Updated SecurityContextHolder to contain null Authentication</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.914 DEBUG 20732 --- [nio-7990-exec-1] .s.o.c.w.OAuth2LoginAuthenticationFilter : Delegating to authentication failure handler org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler@48edcd38</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.914 DEBUG 20732 --- [nio-7990-exec-1] .a.SimpleUrlAuthenticationFailureHandler : Redirecting to /login?error</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.914 DEBUG 20732 --- [nio-7990-exec-1] o.s.s.web.DefaultRedirectStrategy        : Redirecting to '/login?error'</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.915 DEBUG 20732 --- [nio-7990-exec-1] o.s.s.w.header.writers.HstsHeaderWriter  : Not injecting HSTS header since it did not match the requestMatcher org.springframework.security.web.header.writers.HstsHeaderWriter$SecureRequestMatcher@93c27ef</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.915 DEBUG 20732 --- [nio-7990-exec-1] w.c.HttpSessionSecurityContextRepository : SecurityContext is empty or contents are anonymous - context will not be stored in HttpSession.</span></span><br><span class="line"><span class="comment">2019-12-30 15:51:44.915 DEBUG 20732 --- [nio-7990-exec-1] s.s.w.c.SecurityContextPersistenceFilter : SecurityContextHolder now cleared, as request processing completed</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;定位到异常发生的代码，部分源码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2LoginAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = OAuth2AuthorizationResponseUtils.toMultiMap(request.getParameterMap());</span><br><span class="line">        <span class="keyword">if</span> (!OAuth2AuthorizationResponseUtils.isAuthorizationResponse(params)) &#123;</span><br><span class="line">            OAuth2Error oauth2Error = <span class="keyword">new</span> OAuth2Error(<span class="string">"invalid_request"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            OAuth2AuthorizationRequest authorizationRequest = <span class="keyword">this</span>.authorizationRequestRepository.removeAuthorizationRequest(request, response);<span class="comment">//此处获取authorizationRequest为null</span></span><br><span class="line">            <span class="keyword">if</span> (authorizationRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">                OAuth2Error oauth2Error = <span class="keyword">new</span> OAuth2Error(<span class="string">"authorization_request_not_found"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<span class="comment">//此处抛出异常</span></span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;继续跟踪代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpSessionOAuth2AuthorizationRequestRepository</span> <span class="keyword">implements</span> <span class="title">AuthorizationRequestRepository</span>&lt;<span class="title">OAuth2AuthorizationRequest</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AuthorizationRequest <span class="title">removeAuthorizationRequest</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(request, <span class="string">"request cannot be null"</span>);</span><br><span class="line">        String stateParameter = <span class="keyword">this</span>.getStateParameter(request);<span class="comment">//取得state参数值为login</span></span><br><span class="line">        <span class="keyword">if</span> (stateParameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, OAuth2AuthorizationRequest&gt; authorizationRequests = <span class="keyword">this</span>.getAuthorizationRequests(request);<span class="comment">//获得映射："WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=" -&gt; req</span></span><br><span class="line">            OAuth2AuthorizationRequest originalRequest = (OAuth2AuthorizationRequest)authorizationRequests.remove(stateParameter);<span class="comment">//获得originalRequest为null</span></span><br><span class="line">            <span class="keyword">if</span> (!authorizationRequests.isEmpty()) &#123;</span><br><span class="line">                request.getSession().setAttribute(<span class="keyword">this</span>.sessionAttributeName, authorizationRequests);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                request.getSession().removeAttribute(<span class="keyword">this</span>.sessionAttributeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> originalRequest;<span class="comment">//返回null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getStateParameter</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request.getParameter(<span class="string">"state"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, OAuth2AuthorizationRequest&gt; <span class="title">getAuthorizationRequests</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">        Map&lt;String, OAuth2AuthorizationRequest&gt; authorizationRequests = session == <span class="keyword">null</span> ? <span class="keyword">null</span> : (Map)session.getAttribute(<span class="keyword">this</span>.sessionAttributeName);</span><br><span class="line">        <span class="keyword">return</span> (Map)(authorizationRequests == <span class="keyword">null</span> ? <span class="keyword">new</span> HashMap() : authorizationRequests);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们得到的session中有两个attribute：AUTHORIZATION_REQUEST和SPRING_SECURITY_SAVED_REQUEST，前者存储了一组映射（”WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=” -&gt; req），后者则是默认Req：<a href="http://localhost:7990/index。" target="_blank" rel="noopener">http://localhost:7990/index。</a></p>
<p>&emsp;&emsp;所以此处是根据state参数值来获取session中存储的信息，但我们知道在首次请求授权服务器时我们提供的state为：WiSvFEChWOuaLw0GtwigPzmRx7ocBPRDGxZJMqzAnkQ=，扫码登陆后又提交了state为：login，但这里需要的是旧的state参数。</p>
<p>&emsp;&emsp;所以要么授权服务器在扫码登陆时不要替换state为login，而是WiSv；要么授权服务器在扫码登陆后返回code和state时给旧值WiSv；要么我们客户端重构。</p>
<p>&emsp;&emsp;联系对方工程师后，回复：“<strong>把state写死试试</strong>”。虽然有点无语，但好吧。</p>
<h3 id="1-3-问题处理"><a href="#1-3-问题处理" class="headerlink" title="1.3 问题处理"></a><strong>1.3 问题处理</strong></h3><h4 id="1-3-1-自定义Authorization-Code-Request"><a href="#1-3-1-自定义Authorization-Code-Request" class="headerlink" title="1.3.1 自定义Authorization_Code_Request"></a><strong>1.3.1 自定义Authorization_Code_Request</strong></h4><p>&emsp;&emsp;写死state，首先要自定义authorization code request，首先自定义OAuth2AuthorizationRequestResolver，覆盖state参数，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomAuthorizationRequestResolver</span> <span class="keyword">implements</span> <span class="title">OAuth2AuthorizationRequestResolver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientRegistrationRepository clientRegistrationRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AntPathRequestMatcher authorizationRequestMatcher;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringKeyGenerator stateGenerator = <span class="keyword">new</span> Base64StringKeyGenerator(Base64.getUrlEncoder());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringKeyGenerator secureKeyGenerator = <span class="keyword">new</span> Base64StringKeyGenerator(Base64.getUrlEncoder().withoutPadding(), <span class="number">96</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomAuthorizationRequestResolver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ClientRegistrationRepository clientRegistrationRepository, String authorizationRequestBaseUri)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(clientRegistrationRepository, <span class="string">"clientRegistrationRepository cannot be null"</span>);</span><br><span class="line">        Assert.hasText(authorizationRequestBaseUri, <span class="string">"authorizationRequestBaseUri cannot be empty"</span>);</span><br><span class="line">        <span class="keyword">this</span>.clientRegistrationRepository = clientRegistrationRepository;</span><br><span class="line">        <span class="keyword">this</span>.authorizationRequestMatcher = <span class="keyword">new</span> AntPathRequestMatcher(authorizationRequestBaseUri + <span class="string">"/&#123;"</span> + <span class="string">"registrationId"</span> + <span class="string">"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AuthorizationRequest <span class="title">resolve</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String registrationId = <span class="keyword">this</span>.resolveRegistrationId(request);</span><br><span class="line">        String redirectUriAction = <span class="keyword">this</span>.getAction(request, <span class="string">"login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.resolve(request, registrationId, redirectUriAction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AuthorizationRequest <span class="title">resolve</span><span class="params">(HttpServletRequest request, String registrationId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (registrationId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String redirectUriAction = <span class="keyword">this</span>.getAction(request, <span class="string">"authorize"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.resolve(request, registrationId, redirectUriAction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getAction</span><span class="params">(HttpServletRequest request, String defaultAction)</span> </span>&#123;</span><br><span class="line">        String action = request.getParameter(<span class="string">"action"</span>);</span><br><span class="line">        <span class="keyword">return</span> action == <span class="keyword">null</span> ? defaultAction : action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OAuth2AuthorizationRequest <span class="title">resolve</span><span class="params">(HttpServletRequest request, String registrationId, String redirectUriAction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (registrationId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ClientRegistration clientRegistration = <span class="keyword">this</span>.clientRegistrationRepository.findByRegistrationId(registrationId);</span><br><span class="line">            <span class="keyword">if</span> (clientRegistration == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid Client Registration with Id: "</span> + registrationId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Map&lt;String, Object&gt; attributes = <span class="keyword">new</span> HashMap();</span><br><span class="line">                attributes.put(<span class="string">"registration_id"</span>, clientRegistration.getRegistrationId());</span><br><span class="line">                OAuth2AuthorizationRequest.Builder builder;</span><br><span class="line">                <span class="keyword">if</span> (AuthorizationGrantType.AUTHORIZATION_CODE.equals(clientRegistration.getAuthorizationGrantType())) &#123;</span><br><span class="line">                    builder = OAuth2AuthorizationRequest.authorizationCode();</span><br><span class="line">                    Map&lt;String, Object&gt; additionalParameters = <span class="keyword">new</span> HashMap();</span><br><span class="line">                    <span class="keyword">if</span> (!CollectionUtils.isEmpty(clientRegistration.getScopes()) &amp;&amp; clientRegistration.getScopes().contains(<span class="string">"openid"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.addNonceParameters(attributes, additionalParameters);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ClientAuthenticationMethod.NONE.equals(clientRegistration.getClientAuthenticationMethod())) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.addPkceParameters(attributes, additionalParameters);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    builder.additionalParameters(additionalParameters);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!AuthorizationGrantType.IMPLICIT.equals(clientRegistration.getAuthorizationGrantType())) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid Authorization Grant Type ("</span> + clientRegistration.getAuthorizationGrantType().getValue() + <span class="string">") for Client Registration with Id: "</span> + clientRegistration.getRegistrationId());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    builder = OAuth2AuthorizationRequest.implicit();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String redirectUriStr = expandRedirectUri(request, clientRegistration, redirectUriAction);</span><br><span class="line"><span class="comment">//                OAuth2AuthorizationRequest authorizationRequest = builder.clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(redirectUriStr).scopes(clientRegistration.getScopes()).state(this.stateGenerator.generateKey()).attributes(attributes).build();</span></span><br><span class="line">                <span class="comment">//stateGenerator.generateKey()替换为常量login</span></span><br><span class="line">                OAuth2AuthorizationRequest authorizationRequest = builder.clientId(clientRegistration.getClientId()).authorizationUri(clientRegistration.getProviderDetails().getAuthorizationUri()).redirectUri(redirectUriStr).scopes(clientRegistration.getScopes()).state(<span class="string">"login"</span>).attributes(attributes).build();</span><br><span class="line">                <span class="comment">//自定义修改请求</span></span><br><span class="line">                <span class="keyword">return</span> customizeAuthorizationRequest(authorizationRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义请求参数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OAuth2AuthorizationRequest <span class="title">customizeAuthorizationRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            OAuth2AuthorizationRequest req)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; extraParams = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        System.out.println(req.getAdditionalParameters());</span><br><span class="line">        extraParams.putAll(req.getAdditionalParameters());</span><br><span class="line">        <span class="comment">//覆盖state</span></span><br><span class="line">        extraParams.put(<span class="string">"state"</span>, <span class="string">"login"</span>);</span><br><span class="line">        <span class="keyword">return</span> OAuth2AuthorizationRequest</span><br><span class="line">                .from(req)</span><br><span class="line">                .additionalParameters(extraParams)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">resolveRegistrationId</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorizationRequestMatcher.matches(request) ? (String)<span class="keyword">this</span>.authorizationRequestMatcher.matcher(request).getVariables().get(<span class="string">"registrationId"</span>) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">expandRedirectUri</span><span class="params">(HttpServletRequest request, ClientRegistration clientRegistration, String action)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; uriVariables = <span class="keyword">new</span> HashMap();</span><br><span class="line">        uriVariables.put(<span class="string">"registrationId"</span>, clientRegistration.getRegistrationId());</span><br><span class="line">        UriComponents uriComponents = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request)).replacePath(request.getContextPath()).replaceQuery((String)<span class="keyword">null</span>).fragment((String)<span class="keyword">null</span>).build();</span><br><span class="line">        String scheme = uriComponents.getScheme();</span><br><span class="line">        uriVariables.put(<span class="string">"baseScheme"</span>, scheme == <span class="keyword">null</span> ? <span class="string">""</span> : scheme);</span><br><span class="line">        String host = uriComponents.getHost();</span><br><span class="line">        uriVariables.put(<span class="string">"baseHost"</span>, host == <span class="keyword">null</span> ? <span class="string">""</span> : host);</span><br><span class="line">        <span class="keyword">int</span> port = uriComponents.getPort();</span><br><span class="line">        uriVariables.put(<span class="string">"basePort"</span>, port == -<span class="number">1</span> ? <span class="string">""</span> : <span class="string">":"</span> + port);</span><br><span class="line">        String path = uriComponents.getPath();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(path) &amp;&amp; path.charAt(<span class="number">0</span>) != <span class="string">'/'</span>) &#123;</span><br><span class="line">            path = <span class="string">'/'</span> + path;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uriVariables.put(<span class="string">"basePath"</span>, path == <span class="keyword">null</span> ? <span class="string">""</span> : path);</span><br><span class="line">        uriVariables.put(<span class="string">"baseUrl"</span>, uriComponents.toUriString());</span><br><span class="line">        uriVariables.put(<span class="string">"action"</span>, action == <span class="keyword">null</span> ? <span class="string">""</span> : action);</span><br><span class="line">        <span class="keyword">return</span> UriComponentsBuilder.fromUriString(clientRegistration.getRedirectUriTemplate()).buildAndExpand(uriVariables).toUriString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNonceParameters</span><span class="params">(Map&lt;String, Object&gt; attributes, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String nonce = <span class="keyword">this</span>.secureKeyGenerator.generateKey();</span><br><span class="line">            String nonceHash = createHash(nonce);</span><br><span class="line">            attributes.put(<span class="string">"nonce"</span>, nonce);</span><br><span class="line">            additionalParameters.put(<span class="string">"nonce"</span>, nonceHash);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPkceParameters</span><span class="params">(Map&lt;String, Object&gt; attributes, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;</span><br><span class="line">        String codeVerifier = <span class="keyword">this</span>.secureKeyGenerator.generateKey();</span><br><span class="line">        attributes.put(<span class="string">"code_verifier"</span>, codeVerifier);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String codeChallenge = createHash(codeVerifier);</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge"</span>, codeChallenge);</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge_method"</span>, <span class="string">"S256"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            additionalParameters.put(<span class="string">"code_challenge"</span>, codeVerifier);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">createHash</span><span class="params">(String value)</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        MessageDigest md = MessageDigest.getInstance(<span class="string">"SHA-256"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] digest = md.digest(value.getBytes(StandardCharsets.US_ASCII));</span><br><span class="line">        <span class="keyword">return</span> Base64.getUrlEncoder().withoutPadding().encodeToString(digest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在SecurityConfig中配置应用CustomAuthorizationRequestResolver。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> CustomAuthorizationRequestResolver(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; <span class="title">authorizationRequestRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionOAuth2AuthorizationRequestRepository();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//clientRegistrationId集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; clients = Arrays.asList(<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLIENT_PROPERTY_KEY = <span class="string">"spring.security.oauth2.client.registration."</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLIENT_PROVIDER_KEY = <span class="string">"spring.security.oauth2.client.provider."</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientRegistrationRepository <span class="title">clientRegistrationRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Steam获取clients对应ClientRegistration，筛掉空值</span></span><br><span class="line">        List&lt;ClientRegistration&gt; registrations = clients.stream()</span><br><span class="line">                .map(c -&gt; getRegistration(c))</span><br><span class="line">                .filter(registration -&gt; registration != <span class="keyword">null</span>)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryClientRegistrationRepository(registrations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClientRegistration <span class="title">getRegistration</span><span class="params">(String client)</span> </span>&#123;</span><br><span class="line">        String clientId = env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".client-id"</span>);</span><br><span class="line">        <span class="keyword">if</span> (clientId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String clientSecret = env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".client-secret"</span>);</span><br><span class="line">        <span class="keyword">if</span> (client.equals(<span class="string">"cpdemo-client"</span>)) &#123;</span><br><span class="line">            String provider = <span class="string">"cpdemo"</span>;</span><br><span class="line">            ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(client);</span><br><span class="line">            <span class="keyword">return</span> builder.clientId(clientId)</span><br><span class="line">                    .clientSecret(clientSecret)</span><br><span class="line">                    .clientAuthenticationMethod(ClientAuthenticationMethod.BASIC)</span><br><span class="line">                    .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)</span><br><span class="line">                    .redirectUriTemplate(env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".redirect-uri"</span>))</span><br><span class="line">                    .scope(env.getProperty(CLIENT_PROPERTY_KEY + client + <span class="string">".scope"</span>))</span><br><span class="line">                    .authorizationUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".authorization-uri"</span>))</span><br><span class="line">                    .tokenUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".token-uri"</span>))</span><br><span class="line">                    .userInfoUri(env.getProperty(CLIENT_PROVIDER_KEY + provider + <span class="string">".user-info-uri"</span>)).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现之前的问题解决，但发现授权平台提供的token请求和响应格式与标准不同，需要自定义修改。</p>
<h4 id="1-3-2-自定义Access-Token-Request和Access-Token-Response"><a href="#1-3-2-自定义Access-Token-Request和Access-Token-Response" class="headerlink" title="1.3.2 自定义Access_Token_Request和Access_Token_Response"></a><strong>1.3.2 自定义Access_Token_Request和Access_Token_Response</strong></h4><p>&emsp;&emsp;首先实现CustomRequestEntityConverter，为token请求增加参数client_id和client_secret。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRequestEntityConverter</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">Converter</span>&lt;<span class="title">OAuth2AuthorizationCodeGrantRequest</span>, <span class="title">RequestEntity</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLIENT_PROPERTY_KEY = <span class="string">"spring.security.oauth2.client.registration.cpdemo-client."</span>;</span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizationCodeGrantRequestEntityConverter defaultConverter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRequestEntityConverter</span><span class="params">(Environment env)</span> </span>&#123;</span><br><span class="line">        defaultConverter = <span class="keyword">new</span> OAuth2AuthorizationCodeGrantRequestEntityConverter();</span><br><span class="line">        <span class="keyword">this</span>.env = env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定以请求参数格式，增加client_id和client_secret</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RequestEntity&lt;?&gt; convert(OAuth2AuthorizationCodeGrantRequest req) &#123;</span><br><span class="line">        RequestEntity&lt;?&gt; entity = defaultConverter.convert(req);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = (MultiValueMap&lt;String,String&gt;) entity.getBody();</span><br><span class="line">        params.add(<span class="string">"client_id"</span>, env.getProperty(CLIENT_PROPERTY_KEY + <span class="string">"client-id"</span>));</span><br><span class="line">        params.add(<span class="string">"client_secret"</span>, env.getProperty(CLIENT_PROPERTY_KEY + <span class="string">"client-secret"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestEntity&lt;&gt;(params, entity.getHeaders(),</span><br><span class="line">                entity.getMethod(), entity.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后实现CustomTokenResponseConverter，为token响应配置参数格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomTokenResponseConverter</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">Converter</span>&lt;<span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt;, <span class="title">OAuth2AccessTokenResponse</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; TOKEN_RESPONSE_PARAMETER_NAMES = Stream.of(</span><br><span class="line">            OAuth2ParameterNames.ACCESS_TOKEN,</span><br><span class="line">            OAuth2ParameterNames.TOKEN_TYPE,</span><br><span class="line">            OAuth2ParameterNames.EXPIRES_IN,</span><br><span class="line">            OAuth2ParameterNames.REFRESH_TOKEN,</span><br><span class="line">            OAuth2ParameterNames.SCOPE).collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义OAuth2AccessTokenResponse返回参数格式</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessTokenResponse <span class="title">convert</span><span class="params">(Map&lt;String, String&gt; tokenResponseParameters)</span> </span>&#123;</span><br><span class="line">        String accessToken = tokenResponseParameters.get(OAuth2ParameterNames.ACCESS_TOKEN);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> expiresIn = Long.valueOf(tokenResponseParameters.get(OAuth2ParameterNames.EXPIRES_IN));</span><br><span class="line">        OAuth2AccessToken.TokenType accessTokenType = OAuth2AccessToken.TokenType.BEARER;</span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; scopes = Collections.emptySet();</span><br><span class="line">        <span class="keyword">if</span> (tokenResponseParameters.containsKey(OAuth2ParameterNames.SCOPE)) &#123;</span><br><span class="line">            String scope = tokenResponseParameters.get(OAuth2ParameterNames.SCOPE);</span><br><span class="line">            scopes = Arrays.stream(StringUtils.delimitedListToStringArray(scope, <span class="string">","</span>))</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> OAuth2AccessTokenResponse.withToken(accessToken)</span><br><span class="line">                .tokenType(accessTokenType)</span><br><span class="line">                .expiresIn(expiresIn)</span><br><span class="line">                .scopes(scopes)</span><br><span class="line"><span class="comment">//                .refreshToken(refreshToken)</span></span><br><span class="line"><span class="comment">//                .additionalParameters(additionalParameters)</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;最后修改SecurityConfig，增加token端点配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> CustomAuthorizationRequestResolver(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过自定义OAuth2AccessTokenResponseClient来自定义token请求</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessTokenResponseClient&lt;OAuth2AuthorizationCodeGrantRequest&gt; <span class="title">accessTokenResponseClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultAuthorizationCodeTokenResponseClient accessTokenResponseClient =</span><br><span class="line">                <span class="keyword">new</span> DefaultAuthorizationCodeTokenResponseClient();</span><br><span class="line">        <span class="comment">//自定义req</span></span><br><span class="line">        accessTokenResponseClient.setRequestEntityConverter(<span class="keyword">new</span> CustomRequestEntityConverter(env));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启用OAuth2AccessTokenResponseHttpMessageConverter来转换HTTP消息，获取OAuth2AccessTokenResponse</span></span><br><span class="line">        OAuth2AccessTokenResponseHttpMessageConverter tokenResponseHttpMessageConverter =</span><br><span class="line">                <span class="keyword">new</span> OAuth2AccessTokenResponseHttpMessageConverter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义rep</span></span><br><span class="line">        tokenResponseHttpMessageConverter.setTokenResponseConverter(<span class="keyword">new</span> CustomTokenResponseConverter());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//为Rest Http工具配置适用的HttpMessageConverter</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(Arrays.asList(</span><br><span class="line">                <span class="keyword">new</span> FormHttpMessageConverter(), tokenResponseHttpMessageConverter));</span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> OAuth2ErrorResponseErrorHandler());</span><br><span class="line">        accessTokenResponseClient.setRestOperations(restTemplate);</span><br><span class="line">        <span class="keyword">return</span> accessTokenResponseClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现之前的问题解决，但获取用户信息的响应格式需要自定义。</p>
<h4 id="1-3-3-自定义User-Info-Response"><a href="#1-3-3-自定义User-Info-Response" class="headerlink" title="1.3.3 自定义User_Info_Response"></a><strong>1.3.3 自定义User_Info_Response</strong></h4><p>&emsp;&emsp;创建CustomOAuth2User，对应user-info响应消息格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOAuth2User</span> <span class="keyword">implements</span> <span class="title">OAuth2User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities =</span><br><span class="line">            AuthorityUtils.createAuthorityList(<span class="string">"ROLE_USER"</span>);</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attributes;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"campus_user_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"campus_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"tenant_code"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tenantCode;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"user_name"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"user_type"</span>)</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@JsonProperty</span>(required = <span class="keyword">true</span>,value = <span class="string">"gender"</span>)</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.attributes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.attributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"id"</span>, <span class="keyword">this</span>.id);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"userId"</span>, <span class="keyword">this</span>.userId);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"tenantCode"</span>, <span class="keyword">this</span>.tenantCode);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"name"</span>, <span class="keyword">this</span>.name);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"type"</span>, <span class="keyword">this</span>.type);</span><br><span class="line">            <span class="keyword">this</span>.attributes.put(<span class="string">"gender"</span>, <span class="keyword">this</span>.gender);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;修改SecurityConfig，增加customUserType配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> CustomAuthorizationRequestResolver(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                    .and()</span><br><span class="line">                .userInfoEndpoint()</span><br><span class="line">                    .customUserType(CustomOAuth2User.class,<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现get user info流程报错，如下，user-info的响应编码格式为octet-stream，但默认的转换器不支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no suitable HttpMessageConverter found <span class="keyword">for</span> response type [XXX] and content type [application/octet-stream]</span><br></pre></td></tr></table></figure>
<h4 id="1-3-4-自定义User-Info-Request"><a href="#1-3-4-自定义User-Info-Request" class="headerlink" title="1.3.4 自定义User_Info_Request"></a><strong>1.3.4 自定义User_Info_Request</strong></h4><p>&emsp;&emsp;自定义OAuth2UserService，为RestTemplate配置支持OCTET_STREAM（CustomOAuth2UserRequestEntityConverter此时还为OAuth2UserRequestEntityConverter）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserService</span> <span class="keyword">implements</span> <span class="title">OAuth2UserService</span>&lt;<span class="title">OAuth2UserRequest</span>, <span class="title">OAuth2User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Class&lt;? extends OAuth2User&gt;&gt; customUserTypes;</span><br><span class="line">    <span class="keyword">private</span> Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = <span class="keyword">new</span> CustomOAuth2UserRequestEntityConverter();</span><br><span class="line">    <span class="keyword">private</span> RestOperations restOperations;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomUserService</span><span class="params">(Map&lt;String, Class&lt;? extends OAuth2User&gt;&gt; customUserTypes)</span> </span>&#123;</span><br><span class="line">        Assert.notEmpty(customUserTypes, <span class="string">"customUserTypes cannot be empty"</span>);</span><br><span class="line">        <span class="keyword">this</span>.customUserTypes = Collections.unmodifiableMap(<span class="keyword">new</span> LinkedHashMap(customUserTypes));</span><br><span class="line">        <span class="comment">//打印RestTemplate的Http请求日志</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(<span class="keyword">new</span> BufferingClientHttpRequestFactory(<span class="keyword">new</span> SimpleClientHttpRequestFactory()));</span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        interceptors.add(<span class="keyword">new</span> LoggingRequestInterceptor());</span><br><span class="line">        restTemplate.setInterceptors(interceptors);</span><br><span class="line">        <span class="comment">//解决no suitable HttpMessageConverter found for response type [CustomOAuth2User] and content type [application/octet-stream]</span></span><br><span class="line">        MappingJackson2HttpMessageConverter converter = <span class="keyword">new</span> MappingJackson2HttpMessageConverter();</span><br><span class="line">        converter.setSupportedMediaTypes(Arrays.asList(<span class="keyword">new</span> MediaType[]&#123;MediaType.APPLICATION_JSON, MediaType.APPLICATION_OCTET_STREAM&#125;));</span><br><span class="line">        restTemplate.setMessageConverters(Arrays.asList(converter, <span class="keyword">new</span> FormHttpMessageConverter()));</span><br><span class="line">        <span class="keyword">this</span>.restOperations = restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2User <span class="title">loadUser</span><span class="params">(OAuth2UserRequest userRequest)</span> <span class="keyword">throws</span> OAuth2AuthenticationException </span>&#123;</span><br><span class="line">        Assert.notNull(userRequest, <span class="string">"userRequest cannot be null"</span>);</span><br><span class="line">        String registrationId = userRequest.getClientRegistration().getRegistrationId();</span><br><span class="line">        Class customUserType;</span><br><span class="line">        <span class="keyword">if</span> ((customUserType = (Class)<span class="keyword">this</span>.customUserTypes.get(registrationId)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//添加参数</span></span><br><span class="line">            System.out.println(<span class="string">"此时access token ："</span> + userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            System.out.println(<span class="string">"此时AdditionalParameters ："</span> + userRequest.getAdditionalParameters().toString());</span><br><span class="line"></span><br><span class="line">            RequestEntity request = (RequestEntity)<span class="keyword">this</span>.requestEntityConverter.convert(userRequest);</span><br><span class="line"></span><br><span class="line">            ResponseEntity response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response = <span class="keyword">this</span>.restOperations.exchange(request, customUserType);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RestClientException var8) &#123;</span><br><span class="line">                OAuth2Error oauth2Error = <span class="keyword">new</span> OAuth2Error(<span class="string">"invalid_user_info_response"</span>, <span class="string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + var8.getMessage(), (String)<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), var8);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            OAuth2User oauth2User = (OAuth2User)response.getBody();</span><br><span class="line">            <span class="keyword">return</span> oauth2User;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRequestEntityConverter</span><span class="params">(Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(requestEntityConverter, <span class="string">"requestEntityConverter cannot be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.requestEntityConverter = requestEntityConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRestOperations</span><span class="params">(RestOperations restOperations)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(restOperations, <span class="string">"restOperations cannot be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.restOperations = restOperations;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过实现ClientHttpRequestInterceptor接口来对RestTemplate打印日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingRequestInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(LoggingRequestInterceptor.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest httpRequest, <span class="keyword">byte</span>[] bytes, ClientHttpRequestExecution clientHttpRequestExecution)</span><span class="keyword">throws</span> UnsupportedEncodingException,IOException </span>&#123;</span><br><span class="line">        traceRequest(httpRequest,bytes);</span><br><span class="line">        ClientHttpResponse response = clientHttpRequestExecution.execute(httpRequest,bytes);</span><br><span class="line">        traceResponse(response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">traceRequest</span><span class="params">(HttpRequest httpRequest, <span class="keyword">byte</span>[] bytes)</span><span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"=============================request begin=============================="</span>);</span><br><span class="line">        log.debug(<span class="string">"URI            : &#123;&#125;"</span>,httpRequest.getURI());</span><br><span class="line">        log.debug(<span class="string">"Method         : &#123;&#125;"</span>,httpRequest.getMethod());</span><br><span class="line">        log.debug(<span class="string">"Headers        : &#123;&#125;"</span>,httpRequest.getHeaders());</span><br><span class="line">        log.debug(<span class="string">"Body           : &#123;&#125;"</span>,<span class="keyword">new</span> String(bytes,<span class="string">"UTF-8"</span>));</span><br><span class="line">        log.info(<span class="string">"=============================request end=============================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">traceResponse</span><span class="params">(ClientHttpResponse response)</span><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        StringBuilder inputStringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(response.getBody(),<span class="string">"UTF-8"</span>));</span><br><span class="line">        String line = reader.readLine();</span><br><span class="line">        <span class="keyword">while</span> (line != <span class="keyword">null</span>)&#123;</span><br><span class="line">            inputStringBuilder.append(line);</span><br><span class="line">            inputStringBuilder.append(<span class="string">'\n'</span>);</span><br><span class="line">            line = reader.readLine();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"=============================response begin=============================="</span>);</span><br><span class="line">        log.debug(<span class="string">"StatusCode     : &#123;&#125;"</span>,response.getStatusCode());</span><br><span class="line">        log.debug(<span class="string">"StatusText     : &#123;&#125;"</span>,response.getStatusText());</span><br><span class="line">        log.debug(<span class="string">"Headers        : &#123;&#125;"</span>,response.getHeaders());</span><br><span class="line">        log.debug(<span class="string">"Body           : &#123;&#125;"</span>,inputStringBuilder.toString());</span><br><span class="line">        log.info(<span class="string">"=============================response end=============================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;修改SecurityConfig，增加userService配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>, <span class="string">"/login**"</span>,<span class="string">"/callback/"</span>, <span class="string">"/webjars/**"</span>, <span class="string">"/error**"</span>, <span class="string">"/oauth2/authorization/**"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated();</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Class&lt;? extends OAuth2User&gt;&gt; customUserTypes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        customUserTypes.put(<span class="string">"cpdemo-client"</span>,CustomOAuth2User.class);</span><br><span class="line"></span><br><span class="line">        http.oauth2Login()</span><br><span class="line">                .authorizationEndpoint()</span><br><span class="line">                    .authorizationRequestRepository(authorizationRequestRepository())</span><br><span class="line">                    .authorizationRequestResolver(<span class="keyword">new</span> CustomAuthorizationRequestResolver(</span><br><span class="line">                                clientRegistrationRepository(), <span class="string">"/oauth2/authorization"</span>))</span><br><span class="line">                    .and()</span><br><span class="line">                .tokenEndpoint()</span><br><span class="line">                    .accessTokenResponseClient(accessTokenResponseClient())</span><br><span class="line">                    .and()</span><br><span class="line">                .userInfoEndpoint()</span><br><span class="line">                    .userService(<span class="keyword">new</span> CustomUserService(customUserTypes))</span><br><span class="line">                    .customUserType(CustomOAuth2User.class,<span class="string">"cpdemo-client"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; <span class="title">authorizationRequestRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpSessionOAuth2AuthorizationRequestRepository();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现提示请求Token时未提供所需参数，根据接口文档发现授权服务器要求把授权令牌写入Get_Parm，查看源码可以发现默认Converter会根据请求类别把授权令牌放入HEADER或FORM_PARM。</p>
<p>&emsp;&emsp;自定义转换器CustomOAuth2UserRequestEntityConverter，强行将access_token拼入URL。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOAuth2UserRequestEntityConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">OAuth2UserRequest</span>, <span class="title">RequestEntity</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType DEFAULT_CONTENT_TYPE = MediaType.valueOf(<span class="string">"application/x-www-form-urlencoded;charset=UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomOAuth2UserRequestEntityConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RequestEntity&lt;?&gt; convert(OAuth2UserRequest userRequest) &#123;</span><br><span class="line">        ClientRegistration clientRegistration = userRequest.getClientRegistration();</span><br><span class="line">        HttpMethod httpMethod = HttpMethod.GET;</span><br><span class="line">        <span class="keyword">if</span> (AuthenticationMethod.FORM.equals(clientRegistration.getProviderDetails().getUserInfoEndpoint().getAuthenticationMethod())) &#123;</span><br><span class="line">            httpMethod = HttpMethod.POST;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span><br><span class="line"><span class="comment">//        URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getUserInfoEndpoint().getUri()).build().toUri();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//强行拼接</span></span><br><span class="line">        URI uri = UriComponentsBuilder.fromUriString(clientRegistration.getProviderDetails().getUserInfoEndpoint().getUri()</span><br><span class="line">                + <span class="string">"?access_token="</span> + userRequest.getAccessToken().getTokenValue()).build().toUri();</span><br><span class="line"></span><br><span class="line">        RequestEntity request;</span><br><span class="line">        <span class="keyword">if</span> (HttpMethod.POST.equals(httpMethod)) &#123;</span><br><span class="line">            headers.setContentType(DEFAULT_CONTENT_TYPE);</span><br><span class="line">            MultiValueMap&lt;String, String&gt; formParameters = <span class="keyword">new</span> LinkedMultiValueMap();</span><br><span class="line">            formParameters.add(<span class="string">"access_token"</span>, userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            request = <span class="keyword">new</span> RequestEntity(formParameters, headers, httpMethod, uri);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            headers.setBearerAuth(userRequest.getAccessToken().getTokenValue());</span><br><span class="line">            request = <span class="keyword">new</span> RequestEntity(headers, httpMethod, uri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;执行后发现问题解决，流程跑通。</p>
<hr>
<p><em>参考博客和文章书籍等：</em></p>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-security/wiki/OAuth-2.0-Migration-Guide" title="Title" target="_blank" rel="noopener">OAuth-2.0-Migration-Guide</a></p>
</blockquote>
<blockquote>
<p><a href="https://projects.spring.io/spring-security-oauth/docs/Home.html" title="Title" target="_blank" rel="noopener">spring-security-oauth</a></p>
</blockquote>
<blockquote>
<p><a href="https://mrbird.cc/Spring-Security-OAuth2-Guide.html" title="Title" target="_blank" rel="noopener">Spring Security OAuth2入门</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.jianshu.com/p/cb886f995e86?utm_source=oschina-app" title="Title" target="_blank" rel="noopener">深入理解Spring Cloud Security OAuth2及JWT</a></p>
</blockquote>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/74267287" title="Title" target="_blank" rel="noopener">OAuth2实现单点登录SSO</a></p>
</blockquote>
<blockquote>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/webclient.html" title="Title" target="_blank" rel="noopener">Spring文档-26. WebClient</a></p>
</blockquote>
<blockquote>
<p><a href="https://docs.spring.io/spring-security/site/docs/5.0.7.RELEASE/reference/html/oauth2login-advanced.html#oauth2login-advanced-userinfo-endpoint" title="Title" target="_blank" rel="noopener">Spring文档-31.OAuth 2.0 Login</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.ziyueknow.com/page/spring-security/part06-3.html#oauth2login-advanced-userinfo-endpoint" title="Title" target="_blank" rel="noopener">Spring文档中文翻译</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.cnblogs.com/cjsblog/p/9241217.html" title="Title" target="_blank" rel="noopener">Spring Boot OAuth 2.0 客户端</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.baeldung.com/spring-webclient-oauth2" title="Title" target="_blank" rel="noopener">baeldung：Spring WebClient and OAuth2 Support</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.baeldung.com/spring-security-custom-oauth-requests" title="Title" target="_blank" rel="noopener">baeldung：Customizing Authorization and Token Requests with Spring Security 5.1 Client</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/eugenp/tutorials/tree/master/spring-5-security-oauth" title="Title" target="_blank" rel="noopener">github：spring-5-security-oauth</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/jgrandja/spring-security-oauth-5-2-migrate" title="Title" target="_blank" rel="noopener">github：spring-security-oauth-5-2-migrate</a></p>
</blockquote>
<blockquote>
<p><a href="https://objectpartners.com/2018/03/01/log-your-resttemplate-request-and-response-without-destroying-the-body/" title="Title" target="_blank" rel="noopener">Log your RestTemplate Request and Response without destroying the body</a></p>
</blockquote>
<blockquote>
<p><a href="https://dzone.com/articles/spring-boot-how-to-solve-oauth2-err-too-many-redir" title="Title" target="_blank" rel="noopener">Spring Boot: Solving OAuth2 ERR_TOO_MANY_REDIRECTS [Snippet]</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/57761917/spring-5-security-oauth2-login-redirect-loop" title="Title" target="_blank" rel="noopener">stackoverflow：Spring 5 Security OAuth2 Login Redirect Loop</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/49315552/authorizationgranttype-cannot-be-null-in-spring-security-5-oauth-client-and-spri" title="Title" target="_blank" rel="noopener">stackoverflow：authorizationGrantType cannot be null in Spring Security 5 OAuth Client and Spring Boot 2.0</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/49062866/spring-boot-resttemplate-response-body-is-null-while-interceptor-clearly-shows-b" title="Title" target="_blank" rel="noopener">stackoverflow：Spring-boot Resttemplate response.body is null while interceptor clearly shows body</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/50908023/using-spring-security-oauth-using-a-custom-oauth-provider-i-get-authorization" title="Title" target="_blank" rel="noopener">stackoverflow：Using Spring security oauth, using a custom OAuth provider, I get [authorization_request_not_found], should I handle the callback method myself?</a><br>y-shows-b “Title”)</p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/7952154/spring-resttemplate-how-to-enable-full-debugging-logging-of-requests-responses" title="Title" target="_blank" rel="noopener">stackoverflow：Spring RestTemplate - how to enable full debugging/logging of requests/responses?</a></p>
</blockquote>
<p><em>因博客主等未标明不可引用，若部分内容涉及侵权请及时告知，我会尽快修改和删除相关内容</em></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    林沂水
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://linyishui.top/2019111701.html" title="Spring Security OAuth2">http://linyishui.top/2019111701.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    
      <div>
         ﻿<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      </div>
    
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring-boot/" rel="tag"># spring boot</a>
          
            <a href="/tags/oauth2/" rel="tag"># oauth2</a>
          
            <a href="/tags/spring-security/" rel="tag"># spring security</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019111601.html" rel="next" title="OAuth2协议框架">
                <i class="fa fa-chevron-left"></i> OAuth2协议框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019111801.html" rel="prev" title="AES加密">
                AES加密 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
     <div class="comments" id="comments">
       

<script src="https://utteranc.es/client.js" repo="LAILAIWA/LAILAIWA.github.io" issue-term="pathname" label="💬Comments" theme="github-light" crossorigin="anonymous" async>
</script>



     </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg" alt="林沂水">
            
              <p class="site-author-name" itemprop="name">林沂水</p>
              <p class="site-description motion-element" itemprop="description">记录编程点滴，写点生活中的酸甜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">305</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">99</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/LAILAIWA" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:linyishui168@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/linyishui618" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/linyishui618" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5340162234" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo.com"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          <div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("07/26/2018 00:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒";
}
function setzero(i) {
    if (i<10) {
        i="0" + i
    };
    return i;
}
show_date_time();
</script>  
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-OAuth2"><span class="nav-number">1.</span> <span class="nav-text">Spring Security OAuth2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一节-简介"><span class="nav-number">1.1.</span> <span class="nav-text">第一节 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二节-Spring新版本迁移"><span class="nav-number">1.2.</span> <span class="nav-text">第二节 Spring新版本迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-客户端-Client"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 客户端 Client</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-RestTemplate-and-WebClient"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">2.1.1 RestTemplate and WebClient</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-Simplified-Client-Resolution"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">2.1.2 Simplified Client Resolution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-Enhanced-Client-Resolution"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">2.1.3 Enhanced Client Resolution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-Simplified-JWT-Support"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">2.1.4 Simplified JWT Support</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-5-示例-Examples-Matrix"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">2.1.5 示例 Examples Matrix</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-登录-Login"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 登录 Login</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-方法变更-Changes-In-Approach"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.2.1 方法变更 Changes In Approach</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-资源服务器-Resource-Server"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 资源服务器 Resource Server</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-方法变更-Changes-In-Approach"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">2.3.1 方法变更 Changes In Approach</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-示例-Examples-Matrix"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2.3.2 示例 Examples Matrix</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-未移植功能-Unported-Features"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">2.3.3 未移植功能 Unported Features</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三节-实战：实现单点登录"><span class="nav-number">1.3.</span> <span class="nav-text">第三节 实战：实现单点登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四节-实战：APP平台第三方应用授权"><span class="nav-number">1.4.</span> <span class="nav-text">第四节 实战：APP平台第三方应用授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第五节-问题记录：得到授权code后无法获取访问令牌"><span class="nav-number">1.5.</span> <span class="nav-text">第五节 问题记录：得到授权code后无法获取访问令牌</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-问题描述"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.1 问题描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-问题跟踪"><span class="nav-number">1.5.2.</span> <span class="nav-text">1.2 问题跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-问题处理"><span class="nav-number">1.5.3.</span> <span class="nav-text">1.3 问题处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-自定义Authorization-Code-Request"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">1.3.1 自定义Authorization_Code_Request</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-自定义Access-Token-Request和Access-Token-Response"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">1.3.2 自定义Access_Token_Request和Access_Token_Response</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-3-自定义User-Info-Response"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">1.3.3 自定义User_Info_Response</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-4-自定义User-Info-Request"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">1.3.4 自定义User_Info_Request</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">林沂水</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
   

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
