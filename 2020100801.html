<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig Dug.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="mask-icon" href="/images/gamepad playstation.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="distributed,mom,rabbitmq,">





  <link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml">






<meta name="description" content="学习RabbitMQ，第六章《运维》，内容来自于《RabbitMQ实战指南》，内容：在 RabbitMQ 使用过程中难免会出现各式各样的异常情况，客户端的异常一般是由于应用代码的缺陷造成的，对于服务端的异常，虽然不能完全杜绝，但是可以采取一些有效的手段去监测、管控、修正等。">
<meta name="keywords" content="distributed,mom,rabbitmq">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ（六）运维">
<meta property="og:url" content="http://linyishui.top/2020100801.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="学习RabbitMQ，第六章《运维》，内容来自于《RabbitMQ实战指南》，内容：在 RabbitMQ 使用过程中难免会出现各式各样的异常情况，客户端的异常一般是由于应用代码的缺陷造成的，对于服务端的异常，虽然不能完全杜绝，但是可以采取一些有效的手段去监测、管控、修正等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010117.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010116.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010118.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010119.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010120.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010121.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010122.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010123.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010124.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010125.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010126.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010127.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010128.png">
<meta property="og:updated_time" content="2020-10-10T08:16:55.435Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RabbitMQ（六）运维">
<meta name="twitter:description" content="学习RabbitMQ，第六章《运维》，内容来自于《RabbitMQ实战指南》，内容：在 RabbitMQ 使用过程中难免会出现各式各样的异常情况，客户端的异常一般是由于应用代码的缺陷造成的，对于服务端的异常，虽然不能完全杜绝，但是可以采取一些有效的手段去监测、管控、修正等。">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010117.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linyishui.top/2020100801.html">





  <title>RabbitMQ（六）运维 | 俺的部落格</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '[object Object]', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">俺的部落格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">俺寻思俺需要记点东西</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2020100801.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="林沂水">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RabbitMQ（六）运维</h1>
        

        <div class="post-meta">
          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-08T23:34:48+08:00">
                2020-10-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术文档/" itemprop="url" rel="index">
                    <span itemprop="name">技术文档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  15,758
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  67
                </span>
              
            </div>
          

          
              <div class="post-description">
                  学习RabbitMQ，第六章《运维》，内容来自于《RabbitMQ实战指南》，内容：在 RabbitMQ 使用过程中难免会出现各式各样的异常情况，客户端的异常一般是由于应用代码的缺陷造成的，对于服务端的异常，虽然不能完全杜绝，但是可以采取一些有效的手段去监测、管控、修正等。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="RabbitMQ（六）运维"><a href="#RabbitMQ（六）运维" class="headerlink" title="RabbitMQ（六）运维"></a>RabbitMQ（六）运维</h1><h2 id="第一节-集群搭建"><a href="#第一节-集群搭建" class="headerlink" title="第一节 集群搭建"></a>第一节 集群搭建</h2><p>单台 RabbitMQ 服务器可以满足每秒 1000 条消息的吞吐量，那么如果应用需要 RabbitMQ 服务满足每秒 10 万条消息的吞吐量呢？购买昂贵的服务器来增强单机 RabbitMQ 务的性能显得捉襟见肘，搭建一个 RabbitMQ 集群才是解决实际问题的关键。</p>
<p>RabbitMQ 集群也不能保证消息的万无一失，即将消息、队列、交换器等都设置为可持久化，生产端和消费端都正确地使用了确认方式。当集群中一个 RabbitMQ 节点崩溃时，该节点上的所有队列中的消息也会丢失。 RabbitMQ 集群中的所有节点都会备份所有的元数据信息， 包括以下内容：</p>
<ul>
<li><strong>队列元数据</strong>：队列的名称及属性； </li>
<li><strong>交换器</strong>：交换器的名称及属性： </li>
<li><strong>绑定关系元数据</strong>：交换器与队列或者交换器与交换器之间的绑定关系； </li>
<li><strong>vhost 元数据</strong>：为 vhost 内的队列、交换器和绑定提供命名空间及安全属性。</li>
</ul>
<p>但是不会备份消息（当然通过特殊的配置比如镜像队列可以解决这个问题）。基于存储空间和性能的考虑，在 RabbitMQ 集群中创建队列，<strong>集群只会在单个节点而不是在所有节点上创建队列的进程并包含完整的队列信息</strong>（元数据、状态、内容）。这样只有队列的宿主节点，即所有者节点知道队列的所有信息，所有其他非所有者节点只知道队列的元数据和指向该队列存在的那个节点的指针。因此当集群节点崩溃时，该节点的队列进程和关联的绑定都会消失。附加在那些队列上的消费者也会丢失其所订阅的信息，井且任何匹配该队列绑定信息的新消息也都会消失。</p>
<p>不同于队列那样拥有自己的进程，交换器其实只是一个名称和绑定列表。当消息发布到交换器时，实际上是由所连接的信道将消息上的路由键同交换器的绑定列表进行比较，然后再路由消息。当创建一个新的交换器时， RabbitMQ 所要做的就是<strong>将绑定列表添加到集群中的所有节点上</strong>。这样，每个节点上的每条信道都可以访问到新的交换器了。</p>
<p>创建集群的过程可以看作向集群中添加节点的过程。</p>
<h3 id="1-1-多机多节点配置"><a href="#1-1-多机多节点配置" class="headerlink" title="1.1 多机多节点配置"></a>1.1 多机多节点配置</h3><p>多机多节点主要是指在每台机器中部署一个 RabbitMQ 服务节点，进而由多台机器组成一个 RabbitMQ 集群。</p>
<p>假设这里一共有三台物理主机，均己正确地安装了 RabbitMQ ，且主机名分别为 node1、node2、node3。RabbitMQ 集群对延迟非常敏感，应当只在本地局域网内使用 。<strong>在广域网中不应该使用集群，而应该使用 Federation 或者 Shovel 来代替</strong>。</p>
<h4 id="1-1-1-配置流程"><a href="#1-1-1-配置流程" class="headerlink" title="1.1.1 配置流程"></a>1.1.1 配置流程</h4><ul>
<li><p>第一步，配置各个节点的 hosts 文件，让各个节点都能互相识别对方的存在。</p>
<ul>
<li><p>比如在 Linux 系统中可以编辑 <code>/etc/hosts</code> 文件，在其上添加地址与节点名称的映射信息：</p>
</li>
<li><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.2</span> <span class="selector-tag">node1</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.3</span> <span class="selector-tag">node2</span></span><br><span class="line">192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.4</span> <span class="selector-tag">node3</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第二步，编辑 RabbitMQ 的 cookie 文件，以确保各个节点的 cookie 文件使用的是同一个值。</p>
<ul>
<li><p>可以读取 node1 节点的 cookie 值，然后将其复制到 node2、node3 节点中。</p>
</li>
<li><p>cookie 文件默认路径为：<code>/var/lib/rabbitmq/.erlang.cookie</code> 或者 <code>$HOME/.erlang.cookie</code> 。</p>
</li>
<li><p>集群中的 RabbitMQ 节点需要通过交换密钥令牌以获得相互认证。</p>
</li>
<li><p>如果节点的密钥令牌不一致，那么在配置节点时就会有如下的报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl join_cluster rabbit@node1</span></span><br><span class="line">Clustering node rabbit@node2 with rabbit@node1</span><br><span class="line">Error: unable to connect to nodes [rabbit@node1]: nodedown </span><br><span class="line"></span><br><span class="line">DIAGNOSTICS </span><br><span class="line">===========</span><br><span class="line"></span><br><span class="line">attempted to contact: [rabbit@node1] </span><br><span class="line"></span><br><span class="line">rabbit@node1:</span><br><span class="line">* connected to epmd (port 4369) on node1</span><br><span class="line">* epmd reports node rabbit runn ng on port 25672</span><br><span class="line">* TCP connection succeeded but Erlang distribution failed </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意此处</span></span><br><span class="line">* Authentication failed (rejected by the remote node), please check the Erlang cookie </span><br><span class="line"></span><br><span class="line">current node details:</span><br><span class="line">- node name: 'rabbitmq-cli-53@node2'</span><br><span class="line">- home dir: /root</span><br><span class="line">- cookie hash: kLtTY75JJGZnZpQF7CqnYg==</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第三步，配置集群。</p>
<ul>
<li><p>配置集群有三种方式 ：</p>
<ul>
<li>通过 rabbitmqctl 工具配置；</li>
<li>通过 rabbitmq.config 配置文件配置；</li>
<li>通过 rabbitmq-autocluster 插件配置。</li>
</ul>
</li>
<li><p>示例通过 rabbitmqctl 工具配置：</p>
<ul>
<li><p>首先启动 node1、node2、node3 这几个节点的 RabbitMQ 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rabbitmq-server -detached</span><br><span class="line">[root@node2 ~]# rabbitmq-server -detached</span><br><span class="line">[root@node3 ~]# rabbitmq-server -detached</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启后这3个节点目前都是以独立节点存在的单个集群，查看各个节点的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rabbitmqctl cluster_status </span><br><span class="line">[root@node2 ~]# rabbitmqctl cluster_status </span><br><span class="line">[root@node3 ~]# rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来为了将这3个节点组成一个集群，需要以 node1 节点为基准，将 node2 和 node3 节点加入 node1 节点的集群中。这3个节点是平等的，如果想调换彼此的加入顺序也未尝不可。</p>
<ol>
<li><p>首先将 node2 节点加入 node1 节点的集群中：（此时再通过 <code>rabbitmqctl cluster_status</code> 可以看到两个节点的信息）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# rabbitmqctl stop app</span><br><span class="line">Stopping rabbit application on node rabbit@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl reset</span><br><span class="line">Resetting node rabb t@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl join cluster rabbit@node1</span><br><span class="line">Clustering node rabbit@node2 with rabbit@node1</span><br><span class="line">[root@node2 ~]# rabbitmqctl start_ app</span><br><span class="line">Starting node rabbit@node2</span><br></pre></td></tr></table></figure>
</li>
<li><p>再将 node3 节点也加入 node1 节点所在的集群中，步骤同上。</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="1-1-2-节点关闭的几种情况"><a href="#1-1-2-节点关闭的几种情况" class="headerlink" title="1.1.2 节点关闭的几种情况"></a>1.1.2 节点关闭的几种情况</h4><ul>
<li><p>如果集群中某个节点关闭了，会使集群处于怎样的状态？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭 node2 节点</span></span><br><span class="line">[root@node2 ~]# rabbitmqctl stop app</span><br><span class="line">Stopping rabbit application on node rabbit@node2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 node1 节点查看集群状态时，会发现 running_nodes 已没有 node2</span></span><br><span class="line">[root@node1 ~]# rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果关闭了集群中的所有节点，则<strong>需要确保在启动的时候最后关闭的那个节点是第一个启动的</strong>。</p>
<ul>
<li>如果第一个启动的不是最后关闭的节点，那么这个节点会等待最后关闭的节点启动。这个等待时间是 30 秒，如果没有等到，那么这个先启动的节点也会失败。</li>
<li>在最新的版本中会有重试机制，默认重试 10 次 30 秒以等待最后关闭的节点启动。</li>
</ul>
</li>
<li><p>如果最后一个关闭的节点最终由于某些异常而无法启动，则可以通过 <code>rabbitmqctl forget_cluster_node</code> 命令来将此节点剔出当前集群。</p>
</li>
<li><p>如果集群中的所有节点由于某些非正常因素，比如断电而关闭，那么集群中的节点都会认为还有其他节点在它后面关闭，此时需要调用 <code>rabbitmqctl force_boot</code> 命令来启动一个节点，之后集群才能正常启动。</p>
</li>
</ul>
<h3 id="1-2-集群节点类型"><a href="#1-2-集群节点类型" class="headerlink" title="1.2 集群节点类型"></a>1.2 集群节点类型</h3><h4 id="1-2-1-两种节点类型"><a href="#1-2-1-两种节点类型" class="headerlink" title="1.2.1 两种节点类型"></a>1.2.1 两种节点类型</h4><p>使用 <code>rabbitmqctl cluster_status</code> 命令来查看集群状态时会有 <code>{nodes, [{disc, [rabbit@node1,rabbit@node2,rabbit@node3]}]</code> 这一项信息，其中的 disc 标注了 RabbitMQ 点的类型。</p>
<p>不论是单一节点还是集群节点，有两种类型：</p>
<ul>
<li><strong>内存节点</strong>：将所有的队列、 交换器、绑定关系、用户、权限和 vhost 的元数据定义都存储在内存中；</li>
<li><strong>磁盘节点</strong>：存放到磁盘中。所以单节点集群只能是磁盘节点，否则重启后会丢失系统的配置信息。</li>
</ul>
<h4 id="1-2-2-如何指定或切换节点类型"><a href="#1-2-2-如何指定或切换节点类型" class="headerlink" title="1.2.2 如何指定或切换节点类型"></a>1.2.2 如何指定或切换节点类型</h4><p>将节点指定为内存节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将 node2 节点加入 node1 节点的时候可以指定 node2 节点的类型为内存节点</span></span><br><span class="line">[root@node2 ~]# rabbitmqctl join_cluster rabbit@node1 --ram</span><br><span class="line">Clustering node rabbit@node2 with rabbit@node1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以在集群搭建好以后再通过 rabbitmqctl change_cluster_node_type &#123;disc, ram&#125;命令切换类型</span></span><br><span class="line">[root@node2 ~]# rabbitmqctl stop_app</span><br><span class="line">Stopping rabbit application on node rabbit@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl change cluster node type disc</span><br><span class="line">Turning rabbit@node2 into a disc node</span><br><span class="line">[root@node2 ~]# rabbitmqctl start app</span><br><span class="line">Starting node rabbit@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>
<h4 id="1-2-3-如何选择内存还是磁盘节点"><a href="#1-2-3-如何选择内存还是磁盘节点" class="headerlink" title="1.2.3 如何选择内存还是磁盘节点"></a>1.2.3 如何选择内存还是磁盘节点</h4><p>在集群中创建队列、交换器或者绑定关系的时候，这些操作直到所有集群节点都成功提交元数据变更后才会返回。对内存节点来说，这意味着将变更写入内存；而对于磁盘节点来说，这意味着昂贵的磁盘写入操作。内存节点可以提供出色的性能，磁盘节点能够保证集群配置信息的高可靠性，如何在这两者之间进行抉择呢？</p>
<ul>
<li>首先集群中至少有一个磁盘节点；</li>
<li>新增或删除节点时需要将变更通知到至少一个磁盘节点；</li>
<li>如果只有一个磁盘节点，而且它刚好崩溃了，集群可以继续发送或者接收消息，但是不能执行创建队列、交换器、绑定关系、用户，以及更改权限、添加或删除集群节点的操作了。<strong>即唯一磁盘节点崩溃时，集群可以继续运行，但不能变更</strong>。</li>
<li>在内存节点重启后，它们会连接到预先配置的磁盘节点，下载当前集群元数据的副本。当在集群中添加内存节点时，确保告知其所有的磁盘节点（内存节点唯一存储到磁盘的元数据信 息是集群中磁盘节点的地址）。只要内存节点可以找到至少一个磁盘节点，那么它就能在重启后重新加入集群中。</li>
<li>除了使用RPC功能时，大多数的操作就是生产或者消费消息。为了确保集群信息的可靠性，或者在不确定使用磁盘节点或者内存节点的时候，<strong>建议全部使用磁盘节点</strong>。</li>
</ul>
<h3 id="1-3-剔除单个节点"><a href="#1-3-剔除单个节点" class="headerlink" title="1.3 剔除单个节点"></a>1.3 剔除单个节点</h3><h4 id="1-3-1-如何从集群中删除一个节点"><a href="#1-3-1-如何从集群中删除一个节点" class="headerlink" title="1.3.1 如何从集群中删除一个节点"></a>1.3.1 如何从集群中删除一个节点</h4><p>两种方案：</p>
<ul>
<li><p>第一种：适合节点不再运行RabbitMQ的情况。</p>
<ul>
<li>首先在 node2 节点上执行 <code>rabbitmqctl stop_app</code> 或者 <code>rabbitmqctl stop</code> 命令来关闭 RabbitMQ 服务；</li>
<li>然后再在 node1 节点或者 node3 节点上执行 <code>rabbitmqctl forget_cluster_node rabbit@node2</code> （可以添加 <code>-offline</code> 即使非运行状态也可以生效）命令将 node2 节点剔除出去。</li>
</ul>
</li>
<li><p>第二种：只是简单的将节点从集群中移出，变成单一节点。</p>
<ul>
<li><p>在 node2 上执行 <code>rabbitmqctl reset</code> 命令。此命令将清空节点的状态，并将其恢复到空白状态，也会和集群中的磁盘节点进行通信，告诉它们该节点正在离开集群。</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# rabbitmqctl stop app</span><br><span class="line">Stopping rabbit application on node rabbit@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl reset</span><br><span class="line">Resetting node rabbit@node2</span><br><span class="line">[root@node2 ~]# rabbitmqctl start app</span><br><span class="line">Starting node rabbit@node2</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="1-4-集群节点的升级"><a href="#1-4-集群节点的升级" class="headerlink" title="1.4 集群节点的升级"></a>1.4 集群节点的升级</h3><h4 id="1-4-1-独立节点的升级"><a href="#1-4-1-独立节点的升级" class="headerlink" title="1.4.1 独立节点的升级"></a>1.4.1 独立节点的升级</h4><p>只须先关闭原来的服务，然后解压新的版本再运行即可。不过要确保原节点的 Mnesia 中的数据不被变更，且新节点中的 Mnesia 路径的指向要与原节点中的相同。</p>
<h4 id="1-4-2-集群节点的升级步骤"><a href="#1-4-2-集群节点的升级步骤" class="headerlink" title="1.4.2 集群节点的升级步骤"></a>1.4.2 集群节点的升级步骤</h4><p>单个节点的升级步骤：</p>
<ol>
<li>关闭所有节点的服务，注意采用 <code>rabbitmqctl stop</code> 命令关闭。</li>
<li>保存各个节点的 Mnesia 数据。</li>
<li>解压新版本的 RabbitMQ 到指定的目录。</li>
<li>指定新版本的 Mnesia 路径为步骤2中保存的 Mnesia 数据路径。</li>
<li>启动新版本的服务，注意先重启原版本中最后关闭的那个节点。</li>
</ol>
<p>步骤4和步骤5可以一起操作，比如执行 <code>RABBITMQ_MNESIA_BASE=/opt/mnesia rabbitmq-server-detached</code> 命令，其中 <code>/opt/mnesia</code> 为原版本保存 Mnesia 数据的路径。</p>
<p><strong>在对不同版本升级的过程中，最好先测试两个版本互通的可能性，然后再在线上环境中实地操作。</strong></p>
<p>如果原集群上的配置和数据都可以舍弃，则可以删除原版本的 RabbitMQ ，然后再重新安装配置即可：如果配置和数据不可丢弃 ，则按照上面所述保存元数据，之后再关闭所有生产者，并等待消费者消费完队列中的所有数据，紧接着关闭所有消费者，然后重新安装 RabbitMQ 重建元数据等。</p>
<p>也可以利用集群迁移直接转为新的集群。</p>
<h3 id="1-5-单机多节点配置"><a href="#1-5-单机多节点配置" class="headerlink" title="1.5 单机多节点配置"></a>1.5 单机多节点配置</h3><p>有时候不得不在单台物理机器上去创建一个多 RabbitMQ 服务节点的集群，需要<strong>确保每个节点都有独立的名称、数据存储位置、端口号（包括插件的端口号）等</strong>。</p>
<p>我们在主机名称为 node1 的机器上创建一个由 rabbit1@node1、rabbit2@node 1 和 rabbit3@node1 这3个节点组成 RabbitMQ 集群。</p>
<ul>
<li><p>为每个 RabbitMQ 服务节点设置不同的端口号和节点名称来启动相应的服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5672 RABBITMQ NODENAME=rabbit1</span><br><span class="line">rabbitmq-server -detached</span><br><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5673 RABBITMQ NODENAME=rabbit2</span><br><span class="line">rabbitmq-server -detached</span><br><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5674 RABBITMQ NODENAME=rabbit3</span><br><span class="line">rabbitmq-server -detached</span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动 rabbit1@node1 节点的服务之后，继续启动 rabbit2@node1 和 rabbit@node1 服务节点会遇到启动失败的情况。</p>
<ul>
<li><p>这种情况大多数是由于配置发生了冲突而造成后面的服务节点启动失 败，需要进一步确认是否开启了某些功能，比如 RabbitMQ Management 插件。</p>
</li>
<li><p>如果开启了 RabbitMQ Management 插件，就需要为每个服务节点配置一个对应插件端口号：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5672 RABBITMQ NODENAME=rabbit1 RABBITMQ_SERVER_START_ARGS="-rabbitmq_management listener [&#123;port,15672)]" rabbitmq-server -detached</span><br><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5673 RABBITMQ NODENAME=rabbit2 RABBITMQ_SERVER_START_ARGS="- rabbitmq_management listener [&#123;port, 15673&#125;]" rabbitmq-server -detached</span><br><span class="line">[root@node1 ~]# RABBITMQ NODE PORT=5674 RABBITMQ NODENAME=rabbit3 RABBITMQ_SERVER_START_ARGS="- rabbitmq_management listener [&#123;port,15674&#125;]" rabbitmq-server -detached</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动各节点服务之后，将 rabbit2@node1 节点加入 rabbit1@node1 集群之中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~] # rabbitmqctl -n rabbit2@node1 stop app</span><br><span class="line">Stopping rabbit application on node rabbit2@node1</span><br><span class="line">[root@node1 ~J # rabbitmqctl -n rabbit2@node1 reset</span><br><span class="line">Resetting node rabbit2@node1</span><br><span class="line">[root@node1 ~]# rabbitmqctl -n rabbit2@node1 join_cluster rabbit1@node1</span><br><span class="line">Clustering node rabbit2@node1 with rabbit1@node1</span><br><span class="line">[root@node1 ~]# rabbitmqctl -n rabbit2@node1 start_app</span><br><span class="line">Starting node rabbit2@node1</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行相似的操作将 rabbit3@node1 也加入进来，并通过 <code>rabbitmqctl cluster_status</code> 命令来查看各个服务节点的集群状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rabbitmqctl -n rabbit1@node1 cluster_status</span><br><span class="line">Cluster status of de rabbit1@node1</span><br><span class="line">[&#123;nodes, [&#123;disc, [rabbit1@node1, rabbit2@node1, rabbit3@node1]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit3@node1, rabbit2@node1, rabbit1@node1]&#125;,</span><br><span class="line">&#123;cluster_name, &lt;&lt;"rabbit1@node1"&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions, []&#125;,</span><br><span class="line">&#123;alarms, [&#123;rabbit3@node1, []&#125;, &#123;rabbit2@node1, []&#125;, &#123;rabbit1@node1, []&#125;]&#125;]</span><br><span class="line">[root@node1 ~]# rabbitmqctl -n rabbit2@node1 cluster_status</span><br><span class="line">Cluster status of node rabbit2@node1</span><br><span class="line">[&#123;nodes, [&#123;disc, [rabbit1@node1, rabbit2@node1, rabbit3@node1]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit3@node1, rabbit1@node1, rabbit2@node1]&#125;,</span><br><span class="line">&#123;cluster_name, &lt;&lt;"rabbit1@node1"&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions, []&#125; ,</span><br><span class="line">&#123;alarms, [&#123;rabbit3@node1, []&#125; , &#123;rabbit1@node1, []&#125;, &#123;rabbit2@node1, []&#125;]&#125;]</span><br><span class="line">[root@node1 ~]# rabbitmqctl -n rabbit3@node1 cluster_status</span><br><span class="line">Cluster status of node rabbit3@node1</span><br><span class="line">[&#123;nodes, [&#123;disc, [rabbit1@node1, rabbit2@node1, rabbit3@node1]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit1@node1, rabbit2@node1, rabbit3@node1]&#125; ,</span><br><span class="line">&#123;cluster_name, &lt;&lt;"rabbit1@node1"&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions, []&#125; ,</span><br><span class="line">&#123;alarms, [&#123;rabbit1@node1, []&#125;, &#123;rabbit2@node1, []&#125;, &#123;rabbit3@node1, []&#125;]&#125;]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>RabbitMQ 单机多节点配置大多用于实验性论证，生产环境还是选用多机多节点的集群。</p>
<h2 id="第二节-查看服务日志"><a href="#第二节-查看服务日志" class="headerlink" title="第二节 查看服务日志"></a>第二节 查看服务日志</h2><p>RabbitMQ 日志中包含各种类型的事件，比如<strong>连接尝试、服务启动、插件安装及解析请求时的错误等</strong>。</p>
<p>RabbitMQ 的日志默认存放在 <code>$RABBITMQ_HOME/var/log/rabbitmq</code> 文件夹内。在这个文件夹内 RabbitMQ 会创建两个日志文件：</p>
<ul>
<li><code>RABBITMQ_NODENAME-sasl.log</code> ：SASL (System Application Support Libraries，系统应用程序支持库）是库的集合，作为 Erlang-OTP 发行版的一部分。提供了一系列标准，其中之一是日志记录格式。<strong>当 RabbitMQ 记录 Erlang 相关信息时，它会将日志写入文件<code>RABBITMQ_NODENAME-sasl.log</code> </strong>。</li>
<li><code>RABBITMQ_NODENAME.log</code> ：RabbitMQ 服务日志指的就是这个文件。</li>
</ul>
<h3 id="2-1-启动RabbitMQ服务"><a href="#2-1-启动RabbitMQ服务" class="headerlink" title="2.1 启动RabbitMQ服务"></a>2.1 启动RabbitMQ服务</h3><ul>
<li>使用 <code>rabbitmq-server -detached</code> 命令启动RabbitMQ服务，顺带会启动 Erlang 虚拟机和RabbitMQ应用服务。</li>
<li>使用 <code>rabbitmqctl start_app</code> 用来启动 RabbitMQ 应用服务（启动成功的前提是 Erlang 虚拟机运转正常）。</li>
<li>如果使用 <code>rabbitmqctl stop_app</code> 命令关闭的 RabbitMQ 应用服务，那么在使用 <code>rabbitmqctl start_app</code> 命令开启 bbitMQ 应用服务时的启动日志和 <code>rabbitmq-server</code> 的启动日志相同。</li>
</ul>
<p>相关服务日志：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RabbitMQ 版本号、Erlang 的版本号</span></span><br><span class="line"><span class="string">Starting</span> <span class="string">RabbitMQ</span> <span class="number">3.6</span><span class="number">.2</span> <span class="string">on</span> <span class="string">Erlang</span> <span class="number">19.1</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(C)</span> <span class="number">2007</span><span class="bullet">-2016</span> <span class="string">Pivotal</span> <span class="string">Software,</span> <span class="string">Inc</span> <span class="string">.</span></span><br><span class="line"><span class="string">Licensed</span> <span class="string">under</span> <span class="string">the</span> <span class="string">MPL.</span> <span class="string">See</span> <span class="attr">http://www.rabbitmq.com/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># INFO REPORT 和 WARNING REPORT 表示日志级别</span></span><br><span class="line"><span class="comment"># RabbitMQ 服务节点名称、cookie 的 hash 值、配置文件地址</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:08</span> <span class="string">===</span></span><br><span class="line"><span class="string">node</span> <span class="string">:</span> <span class="string">rabbit@node1</span></span><br><span class="line"><span class="string">home</span> <span class="string">dir</span> <span class="string">:</span> <span class="string">/root</span></span><br><span class="line"><span class="string">config</span> <span class="string">file(s)</span> <span class="string">:</span> <span class="string">/opt/rabbitmq/etc/rabbitmq/rabbitmq.config</span> <span class="string">(not</span> <span class="string">found)</span></span><br><span class="line"><span class="string">cookie</span> <span class="string">hash</span> <span class="string">:</span> <span class="string">VCwbL3S9/ydrGgVsrLjVkA==</span></span><br><span class="line"><span class="string">log</span> <span class="string">:</span> <span class="string">/opt/rabbitmq/var/log/rabbitmq/rabbit@node1.log</span></span><br><span class="line"><span class="string">sasl</span> <span class="string">log</span> <span class="string">:</span> <span class="string">pt/rabbitmq</span> <span class="string">/var/</span> <span class="string">log/rabbitmq/rabbit@node1-sasl.log</span></span><br><span class="line"><span class="string">database</span> <span class="string">dir</span> <span class="string">:</span> <span class="string">/opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@node1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存限制</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:09</span> <span class="string">===</span> </span><br><span class="line"><span class="string">Memory</span> <span class="string">limit</span> <span class="string">set</span> <span class="string">to</span> <span class="number">3148</span><span class="string">MB</span> <span class="string">of</span> <span class="number">7872</span><span class="string">MB</span> <span class="string">total.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 磁盘限制</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:09</span> <span class="string">===</span></span><br><span class="line"><span class="string">Disk</span> <span class="string">free</span> <span class="string">limit</span> <span class="string">set</span> <span class="string">to</span> <span class="number">50</span><span class="string">MB</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:09</span> <span class="string">===</span></span><br><span class="line"><span class="string">Limiting</span> <span class="string">to</span> <span class="string">approx</span> <span class="number">924</span> <span class="string">file</span> <span class="string">handles</span> <span class="string">(829</span> <span class="string">sockets)</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:09</span> <span class="string">===</span></span><br><span class="line"><span class="string">FHC</span> <span class="string">read</span> <span class="attr">buffering:</span> <span class="string">OFF</span></span><br><span class="line"><span class="string">FHC</span> <span class="string">write</span> <span class="attr">buffering:</span> <span class="string">ON</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:09</span> <span class="string">===</span></span><br><span class="line"><span class="string">Database</span> <span class="string">rectory</span> <span class="string">at</span> <span class="string">/opt/rabbitmq/var/lib/rabbitmq/mnesia/rabbit@node1</span> <span class="string">is</span></span><br><span class="line"><span class="string">empty.</span> <span class="string">Initialising</span> <span class="string">from</span> <span class="string">scratch...</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Priority</span> <span class="string">queues</span> <span class="string">enabled,</span> <span class="string">real</span> <span class="string">BQ</span> <span class="string">is</span> <span class="string">rabbit_variable_queue</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Adding</span> <span class="string">vhost</span> <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认账户 guest 的创建及权限配置</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Creating</span> <span class="string">user</span> <span class="string">'guest'</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Setting</span> <span class="string">user</span> <span class="string">tags</span> <span class="string">for</span> <span class="string">user</span> <span class="string">'guest'</span> <span class="string">to</span> <span class="string">[admistrator]</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Setting</span> <span class="string">permissions</span> <span class="string">for</span> <span class="string">'guest'</span> <span class="string">in</span> <span class="string">to</span> <span class="string">'.*'</span><span class="string">,</span> <span class="string">'.*'</span><span class="string">,</span> <span class="string">'.*'</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">msg_store</span> <span class="attr">transient:</span> <span class="string">using</span> <span class="string">rabbit_msg_store_ets_index</span> <span class="string">to</span> <span class="string">provide</span> <span class="string">index</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">msg_store</span> <span class="string">persistent</span> <span class="string">using</span> <span class="string">rabbit_msg_store_ets_index</span> <span class="string">to</span> <span class="string">provide</span> <span class="string">index</span></span><br><span class="line"></span><br><span class="line"><span class="string">=WARNING</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">msg_store</span> <span class="attr">persistent:</span> <span class="string">rebuilding</span> <span class="string">indices</span> <span class="string">from</span> <span class="string">scratch</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:52:10</span> <span class="string">===</span></span><br><span class="line"><span class="string">started</span> <span class="string">TCP</span> <span class="string">Listener</span> <span class="string">on</span> <span class="string">[::]:5672</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="bullet">-Oct-2017</span> <span class="string">::10:52</span> <span class="string">:</span> <span class="number">10</span> <span class="string">===</span></span><br><span class="line"><span class="string">Server</span> <span class="string">startup</span> <span class="string">complete;</span> <span class="number">0</span> <span class="string">plugins</span> <span class="string">started.</span></span><br></pre></td></tr></table></figure>
<p>日志级别：（通过 <code>rabbitmq.config</code> 配置文件中 <code>log_levels</code> 参数来设置，默认为 <code>[{connection, info}]</code> ）</p>
<ul>
<li>none</li>
<li>error</li>
<li>warning</li>
<li>info</li>
<li>debug</li>
</ul>
<h3 id="2-2-关闭RabbitMQ服务"><a href="#2-2-关闭RabbitMQ服务" class="headerlink" title="2.2 关闭RabbitMQ服务"></a>2.2 关闭RabbitMQ服务</h3><p>如果使用 <code>rabbitmqctl stop</code> 命令，会将 Erlang 虚拟机一同关闭，而 <code>rabbitmqctl stop_app</code> 只关闭 RabbitMQ 应用服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">Stopping</span> <span class="string">RabbitMQ</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">stopped</span> <span class="string">TCP</span> <span class="string">Listener</span> <span class="string">on</span> <span class="string">[::]:5672</span></span><br><span class="line"></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">Stopped</span> <span class="string">RabbitMQ</span> <span class="string">application</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用 rabbitmqctl stop 来进行关闭操作，则会多出下面的日志信息，即关闭 Erlang 虚拟机。</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:10:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">Halting</span> <span class="string">Erlang</span> <span class="string">VM</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3-建立集群"><a href="#2-3-建立集群" class="headerlink" title="2.3 建立集群"></a>2.3 建立集群</h3><p>举例将节点 rabbit@node2 和 rabbit@node1 组成一个集群：</p>
<ul>
<li><p>首先在 rabbit@node2 中执行 <code>rabbitmq-server -detached</code> 开启 Erlang 虚拟机和 RabbitMQ 应用服务，之后再执行 <code>rabbitmqctl stop_app</code> 来关闭 RabbitMQ 应用服务，之后需要重置节点 rabbit@node2 中的数据 <code>rabbitmqctl reset</code> ，在 rabbit@node2 节点输出如下日志：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:11:25:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">Resetting</span> <span class="string">Rabbit</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 rabbit@node2 节点上执行 <code>rabbitmqctl join_clcuster rabbit@node1</code> ，将其加 rabbit@node1 中以组成一个集群，在 rabbit@node2 节点输出如下日志：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:11:30:46</span> <span class="string">===</span></span><br><span class="line"><span class="string">Clustering</span> <span class="string">with</span> <span class="string">[rabbit@node1]</span> <span class="string">as</span> <span class="string">disc</span> <span class="string">node</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>同时在 rabbit@node1 节点输出如下日志：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:11:30:56</span> <span class="string">===</span></span><br><span class="line"><span class="string">node</span> <span class="string">rabbit@node2</span> <span class="string">up</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果此时在 rabbit@node2 节点上执行 <code>rabbitmqctl stop_app</code> 的动作，那么在 <code>rabbit@node1</code> 节点中会有如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:11:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">rabbit</span> <span class="string">on</span> <span class="string">node</span> <span class="string">rabbit@node2</span> <span class="string">down</span></span><br><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">3</span><span class="attr">-Oct-2017:</span> <span class="string">:11:54:01</span> <span class="string">===</span></span><br><span class="line"><span class="string">Keep</span> <span class="string">rabbit@node2</span> <span class="attr">listeners:</span> <span class="string">the</span> <span class="string">node</span> <span class="string">is</span> <span class="string">already</span> <span class="string">back</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-4-其他"><a href="#2-4-其他" class="headerlink" title="2.4 其他"></a>2.4 其他</h3><p>客户端与 RabbitMQ 建立连接：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=INFO</span> <span class="string">REPORT====</span> <span class="number">14</span><span class="bullet">-0</span><span class="attr">ct-2017:</span> <span class="string">:16:24:55</span> <span class="string">===</span></span><br><span class="line"><span class="string">accepting</span> <span class="string">AMQP</span> <span class="string">connection</span> <span class="string">&lt;0.5865.0&gt;</span> <span class="string">(192.168.0.9:61601</span> <span class="bullet">-&gt;</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span><span class="string">:5672)</span></span><br></pre></td></tr></table></figure>
<p>客户端强制中断连接时：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=WARNING</span> <span class="string">REPORT====</span> <span class="number">14</span><span class="attr">-Jul-2017:</span> <span class="string">:16:36:57</span> <span class="string">===</span></span><br><span class="line"><span class="string">closing</span> <span class="string">AMQP</span> <span class="string">connection</span> <span class="string">&lt;0.5909.0&gt;</span> <span class="string">(192.168.0.9:61629</span> <span class="bullet">-&gt;</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span><span class="string">:5672)</span></span><br><span class="line"><span class="string">connection_closed_abruptly</span></span><br></pre></td></tr></table></figure>
<h3 id="2-5-日常积累各种操作对应日志格式"><a href="#2-5-日常积累各种操作对应日志格式" class="headerlink" title="2.5 日常积累各种操作对应日志格式"></a>2.5 日常积累各种操作对应日志格式</h3><p>可以通过尝试各种的操作以收集相应的服务日志，之后组成一个知识集，这个知识集不单单指一个日志列表，需要通过后期的强化训练掌握其规律，让这个知识集了然于心 。在真正遇到异常故障的时候可以通过查看服务日志来迅速定位问题，之后再采取相应的措施以解决问题。</p>
<p>比如在执行任何 RabbitMQ 操作之前，都会打开一个新的窗口运 <code>tail -f $RABBITMQ_HOME/var/log/rabbitmq/rabbit@$HOSTNAME.log -n 200</code> 命令来实时查看相应操作所对应的服务日志是什么，久而久之即可在脑海中建立一个相对完备的“知识集”。</p>
<h3 id="2-6-日志文件管理"><a href="#2-6-日志文件管理" class="headerlink" title="2.6 日志文件管理"></a>2.6 日志文件管理</h3><p>RabbitMQ 中可以通过 <code>rabbitmqctl rotate_logs {suffix}</code> 命令来轮换日志，比如手工切换当前的日志：<code>rabbitmqctl rotate_logs.bak</code> ，之后可以看到在日志目录下会建立新的日志文件，并且将老的日志文件以添加 <code>.bak</code> 后缀的方式进行区分保存：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 rabbitmq]# ls - al</span><br><span class="line">-rw-r--r-- 1 root root     0 Jul 23 00:50 rabbit@node1.log</span><br><span class="line">-rw-r--r-- 1 root root 22646 Jul 23 00:50 rabbit@node1.log.bak</span><br><span class="line">-rw-r--r-- 1 root root     0 Jul 23 00:50 rabbit@node1-sasl.log</span><br><span class="line">-rw-r--r-- 1 root root     0 Jul 23 00:50 rabbit@node1-sasl.log.bak</span><br></pre></td></tr></table></figure>
<p>也可以执行一个定时任务，比如使用 <code>Linux crontab</code> ，以当前日期为后缀，每天执行一次切换日志的任务，这样在后面需要查阅日志的时候可以根据日期快速定位到相应的日志文件。</p>
<p>RabbitMQ 还可以通过程序化的方式来查看相应的日志， 默认会创建一些交换器， 其中 <code>amq.rabbitmq.log</code> 就是用来收集 RabbitMQ 日志的，集群中所有的服务日志都会发往这个交换器中。这个交换器的类型为 topic ，可以收集如前面所说的 debug、info、warning、error 4个级别的日志。</p>
<p>首先确认是否创建 <code>amq.rabbitmq.log</code> 交换器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2zeet6kto8eqx1w7sluzZ ~]# rabbitmqctl list_exchanges</span><br><span class="line">Listing exchanges for vhost / ...</span><br><span class="line">name    type</span><br><span class="line">exchange_demo   direct</span><br><span class="line">amq.fanout      fanout</span><br><span class="line">amq.rabbitmq.trace      topic</span><br><span class="line">myAe    fanout</span><br><span class="line">amq.headers     headers</span><br><span class="line">amq.topic       topic</span><br><span class="line">amq.direct      direct</span><br><span class="line">normalExchange  direct</span><br><span class="line">        direct</span><br><span class="line">amq.match       headers</span><br></pre></td></tr></table></figure>
<p>配置文件 <code>vi /etc/rabbitmq/rabbitmq.conf</code> （没有就新建）开启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.exchange = true</span><br></pre></td></tr></table></figure>
<p>重启下RabbitMQ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2zeet6kto8eqx1w7sluzZ rabbitmq]# rabbitmqctl stop</span><br><span class="line">Stopping and halting node rabbit@iZ2zeet6kto8eqx1w7sluzZ ...</span><br><span class="line">[root@iZ2zeet6kto8eqx1w7sluzZ rabbitmq]# rabbitmq-server restart</span><br><span class="line">Configuring logger redirection</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#  ##      RabbitMQ 3.8.8</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#  ##</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#########  Copyright (c) 2007-2020 VMware, Inc. or its affiliates.</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#####  ##</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">#########  Licensed under the MPL 2.0. Website: https://rabbitmq.com</span></span></span><br><span class="line"></span><br><span class="line">  Doc guides: https://rabbitmq.com/documentation.html</span><br><span class="line">  Support:    https://rabbitmq.com/contact.html</span><br><span class="line">  Tutorials:  https://rabbitmq.com/getstarted.html</span><br><span class="line">  Monitoring: https://rabbitmq.com/monitoring.html</span><br><span class="line"></span><br><span class="line">  Logs: /var/log/rabbitmq/rabbit@iZ2zeet6kto8eqx1w7sluzZ.log</span><br><span class="line">        /var/log/rabbitmq/rabbit@iZ2zeet6kto8eqx1w7sluzZ_upgrade.log</span><br><span class="line"></span><br><span class="line">  Config file(s): /etc/rabbitmq/rabbitmq.conf</span><br><span class="line"></span><br><span class="line">  Starting broker... completed with 4 plugins.</span><br></pre></td></tr></table></figure>
<p>可以看到交换器已启动：</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010117.png" alt></p>
<p>分别创建四个日志队列，并采用相应的路由键来绑定 <code>amq.rabbitmq.log</code> 交换器，如果想用一个日志队列收集所有级别日志可以使用 <code>#</code> 这个路由键。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010116.png" alt></p>
<p>编写代码打印对应级别日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IP_ADDRESS = <span class="string">"101.200.124.26"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">5672</span>;<span class="comment">//RabbitMQ 服务端默认端口号为 5672</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//创建连接</span></span><br><span class="line">            Address[] addresses = <span class="keyword">new</span> Address[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> Address(IP_ADDRESS, PORT)</span><br><span class="line">            &#125;;</span><br><span class="line">            ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            factory.setUsername(<span class="string">"root"</span>);</span><br><span class="line">            factory.setPassword(<span class="string">"root"</span>);</span><br><span class="line">            Connection connection = factory.newConnection(addresses);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建对应日志级别的信道</span></span><br><span class="line">            Channel channelDebug = connection.createChannel();</span><br><span class="line">            Channel channelInfo = connection.createChannel();</span><br><span class="line">            Channel channelWarn = connection.createChannel();</span><br><span class="line">            Channel channelError = connection.createChannel();</span><br><span class="line">            channelDebug.basicQos(<span class="number">1</span>);</span><br><span class="line">            channelInfo.basicQos(<span class="number">1</span>);</span><br><span class="line">            channelWarn.basicQos(<span class="number">1</span>);</span><br><span class="line">            channelError.basicQos(<span class="number">1</span>);</span><br><span class="line">            channelDebug.basicConsume(<span class="string">"queue.debug"</span>, <span class="keyword">false</span>, <span class="string">"DEBUG"</span>, <span class="keyword">new</span> ConsumerThread(channelDebug));</span><br><span class="line">            channelInfo.basicConsume(<span class="string">"queue.info"</span>, <span class="keyword">false</span>, <span class="string">"INFO "</span>, <span class="keyword">new</span> ConsumerThread(channelInfo)) ;</span><br><span class="line">            channelWarn.basicConsume(<span class="string">"queue.warning"</span>, <span class="keyword">false</span>, <span class="string">"WARNING"</span>, <span class="keyword">new</span> ConsumerThread(channelWarn)) ;</span><br><span class="line">            channelError.basicConsume(<span class="string">"queue.error"</span>, <span class="keyword">false</span>, <span class="string">"ERROR"</span>, <span class="keyword">new</span> ConsumerThread(channelError)) ;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | TimeoutException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerThread</span> <span class="keyword">extends</span> <span class="title">DefaultConsumer</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ConsumerThread</span><span class="params">(Channel channel)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(channel);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            String log = <span class="keyword">new</span> String(body);</span><br><span class="line">            System.out.println(<span class="string">"="</span> + consumerTag + <span class="string">" REPORT====\n"</span> + log);</span><br><span class="line">            <span class="comment">//对日志进行处理</span></span><br><span class="line">            getChannel().basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台打印：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=<span class="built_in">INFO</span>  REPORT====</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">09</span> <span class="symbol">16:00</span><span class="symbol">:19</span>.<span class="number">709</span> [<span class="built_in">info</span>] &lt;<span class="number">0.1768</span>.<span class="number">0</span>&gt; accepting AMQP connection &lt;<span class="number">0.1768</span>.<span class="number">0</span>&gt; (<span class="number">115.236</span>.<span class="number">91.15</span><span class="symbol">:64187</span> -&gt; <span class="number">172.17</span>.<span class="number">48.148</span><span class="symbol">:5672</span>)</span><br><span class="line"></span><br><span class="line">=<span class="built_in">INFO</span>  REPORT====</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">09</span> <span class="symbol">16:00</span><span class="symbol">:19</span>.<span class="number">978</span> [<span class="built_in">info</span>] &lt;<span class="number">0.1768</span>.<span class="number">0</span>&gt; connection &lt;<span class="number">0.1768</span>.<span class="number">0</span>&gt; (<span class="number">115.236</span>.<span class="number">91.15</span><span class="symbol">:64187</span> -&gt; <span class="number">172.17</span>.<span class="number">48.148</span><span class="symbol">:5672</span>)<span class="symbol">:</span> user 'root' authenticated <span class="built_in">and</span> granted access to vhost '/'</span><br></pre></td></tr></table></figure>
<p>要注意的是各个节点对应级别的日志是交错在一起的。可以通过检索日志的 running_partitioned_network 关键字来及时地探测到<strong>网络分区</strong>的发生，之后可以迅速采取措施以保证集群服务的鲁棒性。当然对于日志的监控处理也可以采用第3方工具实现，如 Logstash 等。</p>
<h2 id="第三节-单点故障恢复"><a href="#第三节-单点故障恢复" class="headerlink" title="第三节 单点故障恢复"></a>第三节 单点故障恢复</h2><h3 id="3-1-什么是单点故障"><a href="#3-1-什么是单点故障" class="headerlink" title="3.1 什么是单点故障"></a>3.1 什么是单点故障</h3><p>对于集群层面来说，经常遇到的是单点故障。所谓的单点故障是指集群中单个节点发生了故障，有可能会引起集群服务不可用、数据丢失等异常。配置数据节点冗余（镜像队列）可以有效地防止由于单点故障而降低整个集群的可用性、可靠性。</p>
<h3 id="3-2-四种常见的单点故障"><a href="#3-2-四种常见的单点故障" class="headerlink" title="3.2 四种常见的单点故障"></a>3.2 四种常见的单点故障</h3><p>单节点故障包括：</p>
<ul>
<li><strong>机器硬件故障</strong>：包括机器硬盘、内存、主板等故障造成的死机，无法从软件角度来恢复。<ul>
<li>此时需要在集群中的其他节点中执行 <code>rabbitmqctl forget_cluster_node {nodename}</code> 命令来将故障节点剔除，其中 nodename 表示故障机器节点名称。</li>
<li>如果之前有客户端连接到此故障节点上，在故障发生时会有异常报出，此时需要将故障节点的IP地址从连接列表里删除，并让客户端重新与集群中的节点建立连接，以恢复整个应用。</li>
</ul>
</li>
<li><strong>机器掉电</strong>：需要等待电源接通之后重启机器。<ul>
<li>此时这个机器节点上的 RabbitMQ 处于 stop 状态，但是此时不要盲目重启服务，否则可能会引起<strong>网络分区</strong>。</li>
<li>此时需要在集群中的其他节点中执行 <code>rabbitmqctl forget_cluster_node {nodename}</code> 命令来将故障节点剔除。</li>
<li>然后删除当前故障机器的 RabbitMQ 中的 Mnesia 数据（相当于重置）。</li>
<li>然后再重启 RabbitMQ 服务。</li>
<li>最后再将此节点作为一个新的节点加入到当前集群中。</li>
</ul>
</li>
<li><strong>网络异常</strong>：网线松动或者网卡损坏都会引起网络故障的发生。<ul>
<li>对于网线松动，无论是彻底断开，还是“藕断丝连”，只要它不降速， RabbitMQ 集群就没有任何影响。但是为了保险起见，建议先关闭故障机器的 RabbitMQ 进程，然后对网线进行更换或者修复操作，之后再考虑是否重新开启 RabbitMQ 进程。</li>
<li>网卡故障极易引起<strong>网络分区</strong>的发生，如果监控到网卡故障而网络分区尚未发生时，理应第一时间关闭此机器节点上的 RabbitMQ 进程，在网卡修复之前不建议再次开启。 如果己经发生了网络分区，可以参考 10.5 节进行手动恢复网络分区。</li>
</ul>
</li>
<li><strong>服务进程异常</strong>：如 RabbitMQ 进程非预期终止，需要预先思考相关风险是否在可控范围之内。如果风险不可控，可以选择抛弃这个节点。一般情况下，重新启动 RabbitMQ 服务进程即可。</li>
</ul>
<h2 id="第四节-集群迁移"><a href="#第四节-集群迁移" class="headerlink" title="第四节 集群迁移"></a>第四节 集群迁移</h2><p>扩容比较简单，一般向集群中加入新的集群节点即可，不过新的机器节点中是没有队列创建的，只有后面新创建的队列才有可能进入这个新的节点中。或者如果集群配置了镜像队列，可以通过系列操作将原先队列“漂移”到这个新的节点中，具体可以参考第 10.5 节。</p>
<p>迁移同样可以解决扩容的问题，将旧的集群中的数据（包括元数据信息和消息）迁移到新的且容量更大的集群中即可。 RabbitMQ 中的集群迁移更多的是<strong>用来解决集群故障不可短时间内修复而将所有的数据、客户端连接等迁移到新的集群中，以确保服务的可用性</strong>。相比于单点故障而言，集群故障的危害性就大得多，比如 IDC 整体停电、网线被挖断等。这时候就需要通过集群迁移重新建立起一个新的集群。</p>
<h3 id="4-1-准备阶段-元数据重建"><a href="#4-1-准备阶段-元数据重建" class="headerlink" title="4.1 准备阶段-元数据重建"></a>4.1 准备阶段-元数据重建</h3><p>元数据重建是指在新的集群中创建原集群的队列交换器、绑定关系、 host、用户、权限 Parameter 等数据信息。元数据重建是集群迁移前的准备工作，之后才可将原集群中的消息及客户端连接迁移过来。</p>
<p>实现方式：</p>
<ul>
<li>手工创建：</li>
<li>客户端创建：</li>
</ul>
<p>元数据的整理十分繁琐，需要如Web管理工具的辅助：</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010118.png" alt></p>
<p>可以在原集群上点击 <code>Download broker definitions</code> 按钮下载集群的元数据信息文件，此文件是 JSON 文件，比如叫 metadata.json 。</p>
<p>之后再在新集群上的 Web 管理界面中点击 <code>Upload broker definitions</code> 按钮上传 metadata.json 文件。</p>
<p>如果导入成功则会跳转到成功页面，这样就迅速在新集群中创建了元数据信息。如果新集群有数据与 metadata.json 中的数据相冲突，对于交换器、队列及绑定关系这类非可变对象而言会报错，而对于其他可变对象如 Parameter、用户等则会被覆盖，没有发生冲突的则不受影响。如果过程中发生错误，则导入过程终止，导致 metadata.json 中只有部分数据加载成功。</p>
<p>三个问题：</p>
<ol>
<li><p>如果原集群突发故障，又或者开启 RabbitMQ Management 插件的那个节点机器故障不可修复，就无法获取原集群的元数据 metadata.json。</p>
<ul>
<li>这个问题很好解决，采取一个通用的备份任务，在元数据有变更或者达到某个存储周期时将最新的 metadata.json 备份至另一处安全的地方。这样在遇 到需要集群迁移时，可以获取到最新的元数据。</li>
</ul>
</li>
<li><p>如果新旧集群的 RabbitMQ 版本不一致时会出现异常情况。一般情况下 RabbitMQ 是能够做到向下兼容的，在高版本的 RabbitMQ 中可以上传低版本的元数据文件。然而如果在低版本中上传高版本的元数据文件就没有那么顺利了。</p>
<ul>
<li>比如 3.5.7 版本与 3.6.10 版本的加密算法不一样，就会出现用户登录失败的情况，可以简单地在 Shell 控制台输入变更密码的方式来解决这个问题：<code>rabbitmqctl change_password {username} {new_password}</code> 。</li>
<li>如果还是不能成功上传元数据，我们要先清楚对于用户、策略、权限这种元数据来说内容相对固定，且内容较少，手工重建的代价较小。集群中元数据最多且最复杂的要数队列、交换器和绑定这三项的内容，如果采用人工重建的方式代价太大，重建元数据的意义其实就在于重建队列、交换器及绑定这三项的相关信息。</li>
<li>可以将 3.6.10 的元数据从 queues 这一项前面的内容，包括 rabbit_version、users、vhosts、permissions、parameters、global_parameters 和 policies 这几项内容复制后替换 3.5.7 版本中的 queues 这一项前面的所有内容，然后再保存。之后将修改并保存过后的 3.5.7 版本的元数据 JSON 文件上传到新集群 3.6.10 版本的 Web 管理界面中，至此就完成了集群的元数据重建。</li>
</ul>
</li>
<li><p>第三个问题就是如果采用上面的方法将元数据在新集群上重建，则所有的队列都只会落到同一个集群节点上，而其他节点处于空置状态，这样所有的压力将会集中到这单台节点之上。</p>
<p>两种解决方案，都是通过程序或脚本的形式在新集群上建立元数据：</p>
<ul>
<li><p>通过 HTTP API 接口创建相应的数据：</p>
<ul>
<li><p>引入gson：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.google.code.gson/gson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>三个Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String vhost;</span><br><span class="line">	<span class="keyword">private</span> Boolean durable;</span><br><span class="line">	<span class="keyword">private</span> Boolean auto_delete;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; arguments;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exchange</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String vhost;</span><br><span class="line">	<span class="keyword">private</span> String type;</span><br><span class="line">	<span class="keyword">private</span> Boolean durable;</span><br><span class="line">	<span class="keyword">private</span> Boolean auto_delete;</span><br><span class="line">	<span class="keyword">private</span> Boolean internal;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; arguments;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binding</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String source;</span><br><span class="line">	<span class="keyword">private</span> String vhost;</span><br><span class="line">	<span class="keyword">private</span> String destination;</span><br><span class="line">	<span class="keyword">private</span> String destination_type;</span><br><span class="line">	<span class="keyword">private</span> String routing_key;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String , Object&gt; arguments;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解析原集群的 metadata.json 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Queue&gt; queueList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Exchange&gt; exchangeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Binding&gt; bindingList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseJson</span><span class="params">(String filename)</span> </span>&#123;</span><br><span class="line">        JsonParser parser = <span class="keyword">new</span> JsonParser();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JsonObject json = (JsonObject) parser.parse(<span class="keyword">new</span></span><br><span class="line">                    FileReader(filename));</span><br><span class="line">            JsonArray jsonQueueArray = json.get(<span class="string">"queues"</span>).getAsJsonArray();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonQueueArray.size(); i++) &#123;</span><br><span class="line">                JsonObject subObject = jsonQueueArray.get(i).getAsJsonObject();</span><br><span class="line">                Queue queue = parseQueue(subObject);</span><br><span class="line">                queueList.add(queue);</span><br><span class="line">            &#125;</span><br><span class="line">            JsonArray jsonExchangeArray =</span><br><span class="line">                    json.get(<span class="string">"exchanges"</span>).getAsJsonArray();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonExchangeArray.size(); i++) &#123;</span><br><span class="line">                JsonObject subObject = jsonExchangeArray.get(i).getAsJsonObject();</span><br><span class="line">                Exchange exchange = parseExchange(subObject);</span><br><span class="line">                exchangeList.add(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">            JsonArray jsonBindingArray = json.get(<span class="string">"bindings"</span>).getAsJsonArray();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonBindingArray.size(); i++) &#123;</span><br><span class="line">                JsonObject subObject = jsonBindingArray.get(i).getAsJsonObject();</span><br><span class="line">                Binding binding = parseBinding(subObject);</span><br><span class="line">                bindingList.add(binding);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析队列信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Queue <span class="title">parseQueue</span><span class="params">(JsonObject subObject)</span> </span>&#123;</span><br><span class="line">        Queue queue = <span class="keyword">new</span> Queue();</span><br><span class="line">        queue.setName(subObject.get(<span class="string">"name"</span>).getAsString());</span><br><span class="line">        queue.setVhost(subObject.get(<span class="string">"vhost"</span>).getAsString());</span><br><span class="line">        queue.setDurable(subObject.get(<span class="string">"durable"</span>).getAsBoolean());</span><br><span class="line">        queue.setAuto_delete(subObject.get(<span class="string">"auto_delete"</span>).getAsBoolean());</span><br><span class="line">        JsonObject argsObject = subObject.get(<span class="string">"arguments"</span>).getAsJsonObject();</span><br><span class="line">        Map&lt;String, Object&gt; map = parseArguments(argsObject);</span><br><span class="line">        queue.setArguments(map);</span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析交换器信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Exchange <span class="title">parseExchange</span><span class="params">(JsonObject subObject)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//省略，具体参考 parseQueue 方法进行推演</span></span><br><span class="line">        Exchange exchange = <span class="keyword">new</span> Exchange();</span><br><span class="line">        exchange.setName(subObject.get(<span class="string">"name"</span>).getAsString());</span><br><span class="line">        exchange.setVhost(subObject.get(<span class="string">"vhost"</span>).getAsString());</span><br><span class="line">        exchange.setType(subObject.get(<span class="string">"type"</span>).getAsString());</span><br><span class="line">        exchange.setDurable(subObject.get(<span class="string">"durable"</span>).getAsBoolean());</span><br><span class="line">        exchange.setInternal(subObject.get(<span class="string">"internal"</span>).getAsBoolean());</span><br><span class="line">        exchange.setAuto_delete(subObject.get(<span class="string">"auto_delete"</span>).getAsBoolean());</span><br><span class="line">        JsonObject argsObject = subObject.get(<span class="string">"arguments"</span>).getAsJsonObject();</span><br><span class="line">        Map&lt;String, Object&gt; map = parseArguments(argsObject);</span><br><span class="line">        exchange.setArguments(map);</span><br><span class="line">        <span class="keyword">return</span> exchange;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析绑定信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Binding <span class="title">parseBinding</span><span class="params">(JsonObject subObject)</span> </span>&#123;</span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding();</span><br><span class="line">        binding.setSource(subObject.get(<span class="string">"source"</span>).getAsString());</span><br><span class="line">        binding.setVhost(subObject.get(<span class="string">"vhost"</span>).getAsString());</span><br><span class="line">        binding.setDestination(subObject.get(<span class="string">"destination"</span>).getAsString());</span><br><span class="line">        binding.setDestination_type(subObject.get(<span class="string">"destination_type"</span>).getAsString());</span><br><span class="line">        binding.setRouting_key(subObject.get(<span class="string">"routing_key"</span>).getAsString());</span><br><span class="line">        JsonObject argsObject = subObject.get(<span class="string">"arguments"</span>).getAsJsonObject();</span><br><span class="line">        Map&lt;String, Object&gt; map = parseArguments(argsObject);</span><br><span class="line">        binding.setArguments(map);</span><br><span class="line">        <span class="keyword">return</span> binding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析参数 arguments 项内容</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">parseArguments</span><span class="params">(JsonObject argsObject)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Set&lt;Map.Entry&lt;String, JsonElement&gt;&gt; entrySet = argsObject.entrySet();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, JsonElement&gt; mapEntry : entrySet) &#123;</span><br><span class="line">            map.put(mapEntry.getKey(), mapEntry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在解析完队列、交换器及绑定关系之后，只需要遍历 queueList、exchangeList、bindingList ，然后调用 HTTP API 创建相应的数据即可。随机挑选一个节点并明确指明了 node 节点这一参数来创建队列，如此便可解决集群内部队列分布不均匀的问题。当然首先需要确定新集群中节点名称的列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">       </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ip = <span class="string">"192.168.0.2"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String username = <span class="string">"root "</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String password = <span class="string">"rootl23"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; nodeList =<span class="keyword">new</span> ArrayList&lt;String&gt;() &#123;&#123;</span><br><span class="line">    add(<span class="string">"rabbit@node1"</span>);</span><br><span class="line">    add(<span class="string">"rabbit@node2"</span>);</span><br><span class="line">    add(<span class="string">"rabbit@node3"</span>);</span><br><span class="line">&#125;&#125;;</span><br><span class="line">       </span><br><span class="line"><span class="comment">//创建队列</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Boolean <span class="title">createQueues</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; queueList.size(); i++) &#123;</span><br><span class="line">            Queue queue = queueList.get(i);</span><br><span class="line">            <span class="comment">//注意将特殊字符转义, 比如默认的 vhost ,  将其转成 %2F</span></span><br><span class="line">            String url = String.format(<span class="string">"http://%s:l5672/api/queues/%s/%s"</span>, ip,</span><br><span class="line">                    encode(queue.getVhost(), <span class="string">"UTF-8"</span>),</span><br><span class="line">                    encode(queue.getName(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"auto_delete"</span>, queue.getAuto_delete());</span><br><span class="line">            map.put(<span class="string">"durable"</span>, queue.getDurable());</span><br><span class="line">            map.put(<span class="string">"arguments"</span>, queue.getArguments());</span><br><span class="line">            <span class="comment">//随机挑选一个节点, 并在此节点上创建相应的队列</span></span><br><span class="line">            <span class="comment">// int index = (int) (Math.random() * nodeList.size());</span></span><br><span class="line">            <span class="comment">// map.put("node", nodeList.get(index));</span></span><br><span class="line">            Collections.shuffle(nodeList);</span><br><span class="line">            map.put(<span class="string">"node"</span>, nodeList.get(<span class="number">0</span>));</span><br><span class="line">            String data = <span class="keyword">new</span> Gson().toJson(map);</span><br><span class="line">            System.out.println(url);</span><br><span class="line">            System.out.println(data);</span><br><span class="line">            httpPut(url, data, username, password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line"><span class="comment">//创建交换器</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Boolean <span class="title">createExchanges</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exchangeList.size(); i++) &#123;</span><br><span class="line">            Exchange exchange = exchangeList.get(i);</span><br><span class="line">            <span class="comment">//注意将特殊字符转义, 比如默认的 vhost ,  将其转成 %2F</span></span><br><span class="line">            String url = String.format(<span class="string">"http://%s:l5672/api/exchanges/%s/%s"</span>, ip,</span><br><span class="line">                    encode(exchange.getVhost(), <span class="string">"UTF-8"</span>),</span><br><span class="line">                    encode(exchange.getName(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"auto_delete"</span>, exchange.getAuto_delete());</span><br><span class="line">            map.put(<span class="string">"durable"</span>, exchange.getDurable());</span><br><span class="line">            map.put(<span class="string">"type"</span>, exchange.getType());</span><br><span class="line">            map.put(<span class="string">"internal"</span>, exchange.getInternal());</span><br><span class="line">            map.put(<span class="string">"arguments"</span>, exchange.getArguments());</span><br><span class="line">            <span class="comment">//随机挑选一个节点, 并在此节点上创建相应的队列</span></span><br><span class="line">            <span class="comment">// int index = (int) (Math.random() * nodeList.size());</span></span><br><span class="line">            <span class="comment">// map.put("node", nodeList.get(index));</span></span><br><span class="line">            Collections.shuffle(nodeList);</span><br><span class="line">            map.put(<span class="string">"node"</span>, nodeList.get(<span class="number">0</span>));</span><br><span class="line">            String data = <span class="keyword">new</span> Gson().toJson(map);</span><br><span class="line">            System.out.println(url);</span><br><span class="line">            System.out.println(data);</span><br><span class="line">            httpPut(url, data, username, password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line"><span class="comment">//创建绑定关系</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Boolean <span class="title">createBindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//省略, 具体参考 createQueues 方法进行推演, 关键信息如 url</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bindingList.size(); i++) &#123;</span><br><span class="line">            Binding binding = bindingList.get(i);</span><br><span class="line">            <span class="comment">//注意将特殊字符转义, 比如默认的 vhost ,  将其转成 %2F</span></span><br><span class="line">            String url = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//绑定有两种 交换器与队列, 交换器与交换器</span></span><br><span class="line">            <span class="keyword">if</span> (binding.getDestination_type().equals(<span class="string">"queue"</span>) )&#123;</span><br><span class="line">                url = String.format(<span class="string">"http://%s:l5672/api//bindings/%s/e/%s/q/%s"</span>, ip,</span><br><span class="line">                        encode(binding.getVhost(), <span class="string">"UTF-8"</span>),</span><br><span class="line">                        encode(binding.getSource(), <span class="string">"UTF-8"</span>),</span><br><span class="line">                        encode(binding.getDestination(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                url = String.format(<span class="string">"http://%s:l5672/api//bindings/%s/e/%s/e/%s"</span>, ip,</span><br><span class="line">                        encode(binding.getVhost(), <span class="string">"UTF-8"</span>),</span><br><span class="line">                        encode(binding.getSource (), <span class="string">"UTF-8"</span>),</span><br><span class="line">                        encode(binding.getDestination(), <span class="string">"UTF-8"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"destination"</span>, binding.getDestination());</span><br><span class="line">            map.put(<span class="string">"destination_type"</span>, binding.getDestination_type());</span><br><span class="line">            map.put(<span class="string">"routing_key"</span>, binding.getRouting_key());</span><br><span class="line">            map.put(<span class="string">"arguments"</span>, binding.getArguments());</span><br><span class="line">            <span class="comment">//随机挑选一个节点, 并在此节点上创建相应的队列</span></span><br><span class="line">            <span class="comment">// int index = (int) (Math.random() * nodeList.size());</span></span><br><span class="line">            <span class="comment">// map.put("node", nodeList.get(index));</span></span><br><span class="line">            Collections.shuffle(nodeList);</span><br><span class="line">            map.put(<span class="string">"node"</span>, nodeList.get(<span class="number">0</span>));</span><br><span class="line">            String data = <span class="keyword">new</span> Gson().toJson(map);</span><br><span class="line">            System.out.println(url);</span><br><span class="line">            System.out.println(data);</span><br><span class="line">            httpPut(url, data, username, password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line"><span class="comment">// http post</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">httpPut</span><span class="params">(String url, String data, String username, String password)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpClient client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">    client.getState().setCredentials(AuthScope.ANY,</span><br><span class="line">            <span class="keyword">new</span> UsernamePasswordCredentials(username, password));</span><br><span class="line">    PutMethod putMethod = <span class="keyword">new</span> PutMethod(url);</span><br><span class="line">    putMethod.setRequestHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">    putMethod.setRequestEntity(<span class="keyword">new</span> StringRequestEntity(data, <span class="string">"application/json"</span>, <span class="string">"UTF-8"</span>));</span><br><span class="line">    <span class="keyword">int</span> statusCode = client.executeMethod(putMethod);</span><br><span class="line">    <span class="comment">//System.out.println(statusCode);</span></span><br><span class="line">    <span class="keyword">return</span> statusCode;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">httpPost</span><span class="params">(String url, String data, String username, String password)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//省略, 具体参考 httpPut 方法进行推演</span></span><br><span class="line">    HttpClient client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">    client.getState().setCredentials(AuthScope.ANY,</span><br><span class="line">            <span class="keyword">new</span> UsernamePasswordCredentials(username, password));</span><br><span class="line">    PostMethod postMethod = <span class="keyword">new</span> PostMethod(url);</span><br><span class="line">    postMethod.setRequestHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">    postMethod.setRequestEntity(<span class="keyword">new</span> StringRequestEntity(data, <span class="string">"application/json"</span>, <span class="string">"UTF-8"</span>));</span><br><span class="line">    <span class="keyword">int</span> statusCode = client.executeMethod(postMethod);</span><br><span class="line">    <span class="comment">//System.out.println(statusCode);</span></span><br><span class="line">    <span class="keyword">return</span> statusCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过使用 Gson 解析 metadata.json 文件，进而使用 HttpClient 调用相应的 HTTP API 在随机的节点上创建相应的队列进程，从而达到了集群节点负载均衡的目的。</p>
</li>
<li><p>HttpClient需要引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-httpclient/commons-httpclient --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-httpclient<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>通过随机连接集群中不同的节点的IP地址，然后再创建队列。与前一种方式需要节点名称的列表不同，这里需要的是节点IP地址列表：</p>
<ul>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; ipList = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">    add(<span class="string">"192.168.0.2"</span>);</span><br><span class="line">    add(<span class="string">"192.168.0.3"</span>);</span><br><span class="line">    add(<span class="string">"192.168.0.4"</span>); </span><br><span class="line">&#125;&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端通过连接不同的IP地址来创建不同的 connection 和 channel ，然后将 channel 存入一个缓冲池，之后从 channelList 中获取一个 channel ，再根据 queueList 中的信息创建相应的队列。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010119.png" alt></p>
</li>
<li><p>每一个 channel 对应一个 connection，而每一个 connection 又对应一个 IP ，这样串起来就能保证 channelList 中不会遗留任何节点，最终实现与第一种方式相同的功能。对应的队列创建代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createQueuesNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Channel&gt; channelList =<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Connection&gt; connectionList =<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; ipList.size();i++) &#123;</span><br><span class="line">            String ip = ipList.get(i);</span><br><span class="line">            ConnectionFactory connectionFactory =<span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">            connectionFactory.setUsername(username);</span><br><span class="line">            connectionFactory.setPassword(password);</span><br><span class="line">            connectionFactory.setHost(ip);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            Connection connection = connectionFactory.newConnection();</span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">            channelList.add(channel) ;</span><br><span class="line">            connectionList.add(connection);</span><br><span class="line">        &#125;</span><br><span class="line">        createQueueByChannel(channelList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace() ;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connection connection : connectionList) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createQueueByChannel</span><span class="params">(List&lt;Channel&gt; channelList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; queueList.size(); i++) &#123;</span><br><span class="line">        Queue queue = queueList.get(i);</span><br><span class="line">        <span class="comment">//随机获取相应的 channel</span></span><br><span class="line">        Collections.shuffle(channelList);</span><br><span class="line">        Channel channel = channelList.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; mapArgs = queue.getArguments();</span><br><span class="line">            <span class="comment">//do something with mapArgs.</span></span><br><span class="line">            channel.queueDeclare(queue.getName(), queue.getDurable(),</span><br><span class="line">                    <span class="keyword">false</span>, queue.getAuto_delete(), mapArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="4-2-数据迁移和客户端连接的切换"><a href="#4-2-数据迁移和客户端连接的切换" class="headerlink" title="4.2 数据迁移和客户端连接的切换"></a>4.2 数据迁移和客户端连接的切换</h3><p>首先需要将生产者的客户端与原 RabbitMQ 集群的连接断开，然后再与新的集群建立新的连接，这样就可以将新的消息流转入到新的集群中。</p>
<p>之后就需要考虑消费者客户端的事情，一 种是等待原集群中的消息全部消费完之后再将连接断开，然后与新集群建立连接进行消费作业。</p>
<p>当原集群服务不可用或者出现故障造成服务质量下降而需要迅速将消息流切换到新的集群中时，此时就不能等待消费完原集群中的消息，这里需要及时将消费者客户端的连接切换到新的集群中，那么在原集群中就会残留部分未被消费的消息，此时需要做进一步的处理。如果原集群损坏，可以等待修复之后将数据迁移到新集群中，否则会丢失数据。</p>
<p><strong>数据迁移的主要原理</strong>是先从原集群中将数据消费出来，然后存入一个缓存区中，另一个线程读取缓存区中的消息再发布到新的集群中，如此便完成了数据迁移的动作。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010120.png" alt></p>
<p>RabbitMQ提供的 Federation 和 Shovel 都可以实现 ForwardMaker 功能。</p>
<h3 id="4-3-自动化迁移"><a href="#4-3-自动化迁移" class="headerlink" title="4.3 自动化迁移"></a>4.3 自动化迁移</h3><p>要实现集群自动化迁移，需要在使用相关资源时就做好一些准备工作，方便在自动化迁移过程中进行无缝切换。</p>
<h4 id="4-3-1-使用资源的3个部分"><a href="#4-3-1-使用资源的3个部分" class="headerlink" title="4.3.1 使用资源的3个部分"></a>4.3.1 使用资源的3个部分</h4><p>与生产者和消费者客户端相关的是交换器、队列及集群的信息，如果这种类型的资源发生改变时需要让客户端迅速感知，以便进行相应的处理，则可以通过将相应的资源加载到 ZooKeeper 的相应节点中，然后在客户端为对应的资源节点加入 watcher 来感知变化， 当然这个功能使用 etcd 或者集成到公司层面的资源配置中心中会更加标准、高效。</p>
<p>如图将整个 RabbitMQ 集群资源的使用分为3个部分：</p>
<ul>
<li>客户端、</li>
<li>集群、</li>
<li>ZooKeeper 配置管理。</li>
</ul>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010121.png" alt></p>
<h4 id="4-3-2-自动化迁移过程"><a href="#4-3-2-自动化迁移过程" class="headerlink" title="4.3.2 自动化迁移过程"></a>4.3.2 自动化迁移过程</h4><p>在集群中<strong>创建元数据资源</strong>时都需要在 ZooKeeper 中生成相应的配置：</p>
<ul>
<li><p>比如在 cluster1 集群中创建交换器 exchange1 之后，需要在 /rmqNode/exchanges 路径下创建实节点 exchange1。并赋予节点的数据内容为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster=cluster1</span> <span class="comment"># 表示此交换器所在的集群名称</span></span><br><span class="line"><span class="string">exchangeType=direct</span> <span class="comment"># 表示此交换器的类型</span></span><br><span class="line"><span class="string">vhost=vhost1</span> <span class="comment"># 表示此交换器所在的 vhost</span></span><br><span class="line"><span class="string">username=root</span> <span class="comment"># 表示用户名</span></span><br><span class="line"><span class="string">password=root123</span> <span class="comment"># 表示密码</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 cluster1 集群中创建队列 queue1 之后，需要在 /rmqNode/queues 路径下创建实节点 queue1 ，并赋予节点的数据内容为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster=cluster1</span></span><br><span class="line"><span class="string">bindings=exchange1</span> <span class="comment"># 表示此队列所绑定的交换器</span></span><br><span class="line"><span class="comment"># 如果有需要，也可以添加一些其他信息，比如路由键等</span></span><br><span class="line"><span class="string">vhost=vhost1</span></span><br><span class="line"><span class="string">username=root</span></span><br><span class="line"><span class="string">password=root123</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对应集群的数据在 /rmqNode/clusters 路径下，比如 cluster 集群，其对应节点的数据内容包含 IP 地址列表信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ipList=192.168.0.2,</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.3</span><span class="string">,</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.4</span> <span class="comment"># 集群中各个节点的 IP 地址信息</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>客户端程序</strong>如果与其上的交换器或者队列进行交互，那么需要在相应的 <strong>ZooKeeper 节点中添加 watcher</strong> ，以便在数据发生变更时进行相应的变更，从而达到自动化迁移的目的。</p>
<p><strong>生产者客户端</strong>：</p>
<ul>
<li>在发送消息之前需要先连接 ZooKeeper，</li>
<li>然后根据指定的交换器名称如 exchange1 找到相应的路径 /rmqNode/exchanges 中寻找 exchange1 的节点，</li>
<li>之后再读取节点中的数据，井同时对此节点添加 watcher 。</li>
<li>在节点的数据第一条 <code>cluster=cluster1</code> 中找到交换器所在的集群名称，</li>
<li>然后再从路径 /rmqNode/clusters 中寻找 cluster1 节点，</li>
<li>然后读取其对应 IP 地址列表信息。</li>
<li>这样整个发送端所需要的连接串数据 (IP地址列表、vhost、usemame、password 等）都己获取，接下就可以与 RabbitMQ 集群 cluster 建立连接然后发送数据了。 </li>
</ul>
<p>对于<strong>消费者客户端</strong>而言：</p>
<ul>
<li>同样需要连接 ZooKeeper ，</li>
<li>之后根据指定的队列名称（queue1) 到相应的路径 /rmqNode/queues 中寻找 queue1 节点，</li>
<li>继而找到相应的连接串，</li>
<li>然后与 RabbitMQ 集群 cluster1 建立连接进行消费。</li>
<li>当然对 /rmqNode/queues/queue1 节点的 watcher 必不可少。</li>
</ul>
<p>当 cluster1 集群需要迁移到 cluster2 集群时：</p>
<ul>
<li>首先需要将 cluster1 集群中的元数据在 cluster2 集群中重建。</li>
<li>之后通过修改 channel 和 queue 元数据信息：<ul>
<li>比如原 cluster1 集群中有交换 exchange1、exchange2 和队列 queue1、queue2 ，</li>
<li>现在通过脚本或者程序将其中的 <code>cluster=cluster1</code> 数据修改为 <code>cluster=cluster2</code> 。</li>
<li>客户端会立刻感知节点的变化，然后迅速关闭当前连接之后再与新集群 cluster2 建立新的连接后生产和消费消息，在此切换客户端连接的过程中是可以保证数据零丢失的。</li>
</ul>
</li>
<li>迁移之后，生产者和消费者都会与 cluster2 集群进行互通，此时原 cluster 集群中可能还有未被消费完的数据，此时需要使用 RabbitMQ ForwardMaker 工具将 cluster1 集群中未被消费完的数据同步到 cluster2 集群中。</li>
</ul>
<p>如果没有准备 RabbitMQ ForwardMaker 工具，也不想使用 Federation 或者 Shovel 插件，那么在变更完交换器相关的 ZooKeeper 中的节点数据之后，需要等待原集群中的所有队列都消费完全之后，再将队列相关的 ZooKeeper 中的节点数据变更，进而使得消费者的连接能够顺利迁移到新的集群之上。可以通过下面的命令来查看是否有队列中的消息未被消费完：</p>
<p><code>rabbitmqctl list_queues -p / -q | awk &#39;{if($2&gt;0) print $0 }&#39;</code></p>
<h4 id="4-3-3-空闲备份集群解决方案"><a href="#4-3-3-空闲备份集群解决方案" class="headerlink" title="4.3.3 空闲备份集群解决方案"></a>4.3.3 空闲备份集群解决方案</h4><p>上面的自动化迁移立足于将现有集群迁移到空闲的备份集群，如果由于原集群硬件升级等原因迁移也无可厚非。很多情况下，自动化迁移作为容灾手段中的一种，如果有很多个正在运行的 RabbitMQ 集群，为每个集群都配备一个空闲的备份集群无疑是一种资源的浪费。当然可以采取几个集群共用一个备份集群来减少这种浪费，那么有没有更优的解决方案呢？</p>
<p>就以4个 RabbitMQ 集群为例，其被分配4个独立的业务使用。如图 7-8 所示， 当 cluster1 集群中的元数据备份到 cluster2 集群中，而 cluster2 集群中的元数据备份到 cluster3 集群中，如此可以两两互备。<strong>比如在 cluster1 集群中创建了一个交换器 exchange1 ，此时需要在 cluster2 集群中同样创建一个交换器 exchange1</strong> 。在正常情况下，使用的是 cluster1 集群中的 exchange1 ，而 exchange1 在 cluster2 集群中只是一份记录，并不消耗 cluster2 集群的任何性能。而当需要将 cluster1 迁移时，只需要将交换器及队列相对应的 ZooKeeper 节点数据项变更即可完成迁移的工作。如此既不用耗费额外的硬件资源，又不用再迁移的时候重新建立元数据信息。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010122.png" alt></p>
<p>为了更加稳妥起见，也可以准备一个空闲的备份集群以备后用。当 cluster1 集群需要迁移 cluster2 集群中时， cluster2 集群己经发生故障被关闭或者被迁移到 cluster3 集群中了，那么这个空闲的备份集群可以当作 Plan B 来增强整体服务的可靠性。如果既想不浪费多余的硬件资源又想具备更加稳妥的措施，可以参考图 7-9 ，将 cluster1 中的元数据备份到 cluster2、cluster3 中，这样以1备2的方式即可解决这个难题。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010123.png" alt></p>
<p>对于上面介绍的多集群间互备的解决方案需要配套一个完备的实施系统，比如具备资源管理、执行下发、数据校对等功能，并且对于 ZooKeepe 节点中的数据项设计也需要细细斟酌，最好能够根据实际使用情况将这些整合到一个大的平台化系统之中。</p>
<h2 id="第五节-集群监控"><a href="#第五节-集群监控" class="headerlink" title="第五节 集群监控"></a>第五节 集群监控</h2><p>监控不仅可以提供运行时的数据为应用提供依据参考，还可以迅速定位问题、提供预防及告警等功能，很大程度上增强了整体服务的鲁棒性。</p>
<p>RabbitMQ Management 插件就能提供一定的监控功能：如发送速度、确认速度、消费速度、消息总数、磁盘读写速度、句柄数、Socket 连接数、 Connection 数、 Channel 数、内存信息等。但是有一个遗憾就是其难以和公司内部系统平台关联，对于业务资源的使用情况、相应的预防及告警的联动无法顺利贯通。如果在人力、物力等条件允许的情况下，自定义一套监控系统非常有必要。</p>
<h3 id="5-1-通过HTTP-API接口提供监控数据"><a href="#5-1-通过HTTP-API接口提供监控数据" class="headerlink" title="5.1 通过HTTP API接口提供监控数据"></a>5.1 通过HTTP API接口提供监控数据</h3><p>RabbitMQ Management 插件提供了HTTP API接口来提供监控数据。</p>
<p>假设集群中一共有4个节点：nod1、node2、node3、node4 。有一个交换器 exchange 通过同一个路由键“rk”绑定了3个队列 quue1、queue2 和 queue3。</p>
<p>首先可以通过 /api/nodes 接口来收集集群节点的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClusterNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> diskFree;<span class="comment">//磁盘空闲</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> diskFreeLimit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> fdUsed;<span class="comment">//句柄使用数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> fdTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> socketsUsed;<span class="comment">//Socket 使用数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> socketsTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> memoryUsed;<span class="comment">//内存使用值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> memoryLimit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> procUsed;<span class="comment">//Erlang 进程使用数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> procTotal;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;disk_free="</span> + diskFree + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"disk_free_limit="</span> + diskFreeLimit + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"fd_used= "</span> + fdUsed + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"fd_total = "</span> + fdTotal + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"sockets_used= "</span> + socketsUsed + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"sockets_total= "</span> + socketsTotal + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"mem_used= "</span> + memoryUsed + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"mem_limit= "</span> + memoryLimit + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"proc_used="</span> + procUsed + <span class="string">", "</span> +</span><br><span class="line">                <span class="string">"proc_total="</span> + procTotal + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>封装一下HTTP GET，方便后续程序直接调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">httpGet</span><span class="params">(String url, String username, String password)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HttpClient client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">        client.getState().setCredentials(AuthScope.ANY,</span><br><span class="line">                <span class="keyword">new</span> UsernamePasswordCredentials(username, password));</span><br><span class="line">        GetMethod getMethod = <span class="keyword">new</span> GetMethod(url) ;</span><br><span class="line">        <span class="keyword">int</span> ret = client.executeMethod(getMethod);</span><br><span class="line">        String data = getMethod.getResponseBodyAsString();</span><br><span class="line">        System.out.println(data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 HTTP GET 方法获取 <code>http://xx.xxx.xxx.xxx:15672/api/nodes</code> 的 JSON 数据，然后通过 GSON 进行解析， 之后即可采集到感兴趣的数据项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ClusterNode&gt; <span class="title">getClusterData</span><span class="params">(String ip, <span class="keyword">int</span> port,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               String username, String password)</span> </span>&#123;</span><br><span class="line">    List&lt;ClusterNode&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    String url = <span class="string">"http://"</span> + ip + <span class="string">":"</span> + port + <span class="string">"/api/nodes"</span>;</span><br><span class="line">    System.out.println(url);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String urlData = HttpUtils.httpGet(url, username, password);</span><br><span class="line">        parseClusters(urlData, list);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(list);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseClusters</span><span class="params">(String urlData, List&lt;ClusterNode&gt; list)</span> </span>&#123;</span><br><span class="line">    JsonParser parser= <span class="keyword">new</span> JsonParser();</span><br><span class="line">    JsonArray jsonArray =(JsonArray) parser.parse(urlData);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i= <span class="number">0</span> ;i &lt; jsonArray.size(); i++) &#123;</span><br><span class="line">        JsonObject jsonObjectTemp = jsonArray.get(i).getAsJsonObject();</span><br><span class="line">        ClusterNode cluster = <span class="keyword">new</span> ClusterNode();</span><br><span class="line">        cluster.setDiskFree(jsonObjectTemp.get(<span class="string">"disk_free"</span>).getAsLong());</span><br><span class="line">        cluster.setDiskFreeLimit(jsonObjectTemp.get(<span class="string">" disk_free_limit"</span>).</span><br><span class="line">                getAsLong());</span><br><span class="line">        cluster.setFdUsed(jsonObjectTemp.get(<span class="string">"fd_used"</span>).getAsLong());</span><br><span class="line">        cluster.setFdTotal(jsonObjectTemp.get(<span class="string">"fd_total"</span>).getAsLong() );</span><br><span class="line">        cluster.setSocketsUsed(jsonObjectTemp.get(<span class="string">"sockets_used"</span>).getAsLong());</span><br><span class="line">        cluster.setSocketsTotal(jsonObjectTemp.get(<span class="string">"sockets_total"</span>).getAsLong());</span><br><span class="line">        cluster.setMemoryUsed(jsonObjectTemp.get(<span class="string">"mem_used"</span>).getAsLong() );</span><br><span class="line">        cluster.setMemoryLimit(jsonObjectTemp.get(<span class="string">"mem_limit"</span>).getAsLong() );</span><br><span class="line">        cluster.setProcUsed(jsonObjectTemp.get(<span class="string">"proc_used"</span>).getAsLong());</span><br><span class="line">        cluster.setProcTotal(jsonObjectTemp.get(<span class="string">" proc_total"</span>).getAsLong() );</span><br><span class="line">        list.add(cluster);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据来集完之后并没有结束，图 7-10 中简单囊括了从数据采集到用户使用的过程：</p>
<ul>
<li>首先采集程序通过定时调用 HTTP API 接口获取 JSON 数据，</li>
<li>然后进行 JSON 解析之后再进行持久化处理。</li>
<li>对于这种基于时间序列的数据非常适合使用 OpenTSDB（基于 Hbase 的分布式的、可伸缩的时间序列数据库。主要用途就是做监控系统，比如收集大规模集群，包括网络设备、操作系统、应用程序的监控数据并进行存储、查询）来进行存储。</li>
<li>监控管理系统可以根据用户的检索条件来从 OpenTSDB 获取相应的数据并展示到页面之中。</li>
<li>监控管理系统本身还可以具备报表、权限管理等功能，同时也可以实时读取所采集的数据，对其进行分析处理，对于异常的数据需要及时报告给相应的人员。</li>
</ul>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010124.png" alt></p>
<p>对于集群的各节点信息展示可以参考下方，图 7-11 展示了各个节点实时的内存占用情况，图 7-12 展示了各个节点实时的磁盘使用情况。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010125.png" alt></p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010126.png" alt></p>
<p>对于交换器而言的数据采集可以调用 /api/exchanges/vhost/name 接口，比如需要调用虚拟主机为默认的 <code>/</code> 、交换器名称为 exchange 的数据，只需要使用 HTTP GET 方法获取 <code>http://xxx.xxx.xxx.xxx:15672/api/exchanges/%2F/exchange</code> 的数据即可。注意，这里需要将 <code>/</code> 进行 HTML 转义成 <code>%2F</code> ，否则会出错。对应的数据内容可以参考下方：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"message_stats"</span>:&#123;</span><br><span class="line">		<span class="attr">"publish_in_details"</span>: &#123;</span><br><span class="line">			<span class="attr">"rate"</span>: <span class="number">0.4</span> //数据流入的速率</span><br><span class="line">		&#125;,</span><br><span class="line">		"publish_in": 9,//数据流入的总量</span><br><span class="line">		"publish_out_details": &#123;</span><br><span class="line">			"rate": 1.2 //数据流出的速率</span><br><span class="line">			&#125;,</span><br><span class="line">		"publish_out": 27//数据流出的总量</span><br><span class="line">	&#125;,</span><br><span class="line">	"outgoing": [],</span><br><span class="line">	"incoming": [],</span><br><span class="line">	"arguments": &#123;&#125;,</span><br><span class="line">	"internal": false,</span><br><span class="line">	"auto_delete": false,</span><br><span class="line">	"durable": true,</span><br><span class="line">	"type": "direct",</span><br><span class="line">	"vhost": "/",</span><br><span class="line">	"name": "exchange" </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于1个交换器绑定3个队列的情况，向交换器发送1条消息，那么流入就是1条，而流出就是3条。在应用的时候根据实际情况挑选数据流入速率或者数据流出速率作为发送数量， 以及挑选数据流入的量还是数据流出的量作为发送量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JQExchange</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> publishInRate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> publishIn;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> publishOutRate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> publishOut;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;publish_in_rate="</span> + publishInRate +</span><br><span class="line">                <span class="string">", publish_in"</span> + publishIn +</span><br><span class="line">                <span class="string">", publish_out_rate="</span> + publishOutRate +</span><br><span class="line">                <span class="string">", publish_out="</span> + publishOut + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeMonitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getExchangeData(<span class="string">"192.168.0.2"</span>, <span class="number">15672</span>, <span class="string">"root"</span>, <span class="string">"rootl23"</span>, <span class="string">"/"</span>, <span class="string">"exchange"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JQExchange <span class="title">getExchangeData</span><span class="params">(String ip, <span class="keyword">int</span> port, String username,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       String password, String vhost , String exchange)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://"</span> + ip + <span class="string">":"</span> + port + <span class="string">"/api/exchanges"</span></span><br><span class="line">                + encode(vhost, <span class="string">"UTF-8"</span>) + <span class="string">"/"</span> + encode(exchange, <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(url);</span><br><span class="line">        String urlData = HttpUtils.httpGet(url, username, password);</span><br><span class="line">        System.out.println(urlData);</span><br><span class="line">        JQExchange exchangeAns = parseExchange(urlData);</span><br><span class="line">        System.out.println(exchangeAns);</span><br><span class="line">        <span class="keyword">return</span> exchangeAns;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JQExchange <span class="title">parseExchange</span><span class="params">(String urlData)</span> </span>&#123;<span class="comment">//解析程序</span></span><br><span class="line">        JQExchange exchange = <span class="keyword">new</span> JQExchange();</span><br><span class="line">        JsonParser parser = <span class="keyword">new</span> JsonParser();</span><br><span class="line">        JsonObject jsonObject = (JsonObject) parser.parse(urlData);</span><br><span class="line">        JsonObject msgStats =</span><br><span class="line">                jsonObject.get(<span class="string">"message_stats"</span>).getAsJsonObject();</span><br><span class="line">        <span class="keyword">double</span> publish_in_details_rate =</span><br><span class="line">                msgStats.get(<span class="string">"publish_in_details"</span>)</span><br><span class="line">                        .getAsJsonObject().get(<span class="string">"rate"</span>).getAsDouble();</span><br><span class="line">        <span class="keyword">double</span> publish_out_details_rate =</span><br><span class="line">                msgStats.get(<span class="string">"publish_out_details"</span>).</span><br><span class="line">                        getAsJsonObject().get(<span class="string">"rate"</span>).getAsDouble();</span><br><span class="line">        <span class="keyword">long</span> publish_in = msgStats.get(<span class="string">"publish_in"</span>).getAsLong();</span><br><span class="line">        <span class="keyword">long</span> publish_out = msgStats.get(<span class="string">"publish_out"</span>).getAsLong();</span><br><span class="line">        exchange.setPublishInRate(publish_in_details_rate);</span><br><span class="line">        exchange.setPublishOutRate(publish_out_details_rate);</span><br><span class="line">        exchange.setPublishIn(publish_in);</span><br><span class="line">        exchange.setPublishOut(publish_out);</span><br><span class="line">        <span class="keyword">return</span> exchange;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于队列而言的数据来集相关的接口为 /api/queues/vhost/name 。</p>
<h3 id="5-2-通过客户端提供监控数据"><a href="#5-2-通过客户端提供监控数据" class="headerlink" title="5.2 通过客户端提供监控数据"></a>5.2 通过客户端提供监控数据</h3><p>除了 HTTP API 接口可以提供监控数据，Java 版客户端从 3.6.x 版本开始，也在 <code>Channel</code> 接口中提供了两个方法来获取数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">messageCount</span><span class="params">(String var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">consumerCount</span><span class="params">(String var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>messageCount：用来查询队列中的消息个数，可以为监控消息堆积的情况提供数据。</li>
<li>consumerCount：用来查询队列中的消费者个数，可以为监控消费者的情况提供数据。</li>
</ul>
<p>相应监控视图：</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010127.png" alt></p>
<p>还可以通过连接的状态进行监控，<code>Connection</code> 接口提供：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addBlockedListener</span><span class="params">(BlockedListener var1)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BlockedListener <span class="title">addBlockedListener</span><span class="params">(BlockedCallback var1, UnblockedCallback var2)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">removeBlockedListener</span><span class="params">(BlockedListener var1)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearBlockedListeners</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>addBlockedListener：用来监昕连接阻塞信息。</li>
<li>addShutdownListener：用来监昕连接关闭信息。</li>
</ul>
<p>用户客户端还可以自行定义一些数据进行埋点 ，比如客户端成功发送的消息个数和发送失败的消息个数，进一步可以计算发送消息的成功率等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> successCount = <span class="number">0</span>; <span class="comment">//记录发送成功的次数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> failureCount = <span class="number">0</span>; <span class="comment">//记录发送失败的次数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">XXXXXX</span><span class="params">(Channel channel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel.confirmSelect();</span><br><span class="line">        channel.addReturnListener(<span class="keyword">new</span> ReturnListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturn</span><span class="params">(<span class="keyword">int</span> replyCode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     String replyText,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     String exchange,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     String routingKey,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                failureCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        channel.basicPublish(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">true</span>,</span><br><span class="line">                MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                <span class="string">"msg"</span> .getBytes());</span><br><span class="line">        <span class="keyword">if</span> (channel.waitForConfirms() == <span class="keyword">true</span>) &#123;</span><br><span class="line">            successCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            failureCount++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        failureCount++;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        failureCount++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里推荐引入 metrics 工具（比如 <code>com.codahale.metrics.*</code>）来进行埋点，这样既方便又高效。同样的方式也可以统计消费者消费成功的条数和消费失败的条数。</p>
<h3 id="5-3-检测RabbitMQ服务是否健康"><a href="#5-3-检测RabbitMQ服务是否健康" class="headerlink" title="5.3 检测RabbitMQ服务是否健康"></a>5.3 检测RabbitMQ服务是否健康</h3><p>上述两种方式都要基于 RabbitMQ 服务运行正常的情况下，但无法判断 RabbitMQ 是否具备服务外部请求的能力。</p>
<p>三种检查方式：</p>
<ul>
<li>检查RabbitMQ是否运行：<code>ps aux | grep rabbitmq</code> 。</li>
<li>检查5672端口是否开启：<code>telnet xxx.xxx.xxx.xxx 5672</code> 。</li>
<li>使用 AMQP 协议来构建一个类似于 TCP 协议中的 Ping 的检测程序。当这个测试程序与 RabbitMQ 服务无法建立 TCP 协议层面的连接，或者无法构建 AMQP 协议层面的连接，再或者构建连接超时时，则可判定 RabbitMQ 服务处于异常状态而无法正常为外部应用提供相应的服务。</li>
</ul>
<p>AMQPPing实现代码可以参考《RabbitMQ实战指南 7.5.3》。</p>
<p>RabbitMQ Management 插件提供了 /api/aliveness-test/vhost 的 HTTP API 形式的接口，通过3个步骤来验证 RabbitMQ 服务的健康性：</p>
<ul>
<li>创建1个以 <code>aliveness-test</code> 为名称的队列来接收测试消息。</li>
<li>用队列名称 <code>aliveness-test</code> 作为消息的路由键，将消息发往默认交换器。 </li>
<li>到达队列时就消费该消息，否则就报错。</li>
</ul>
<p>检测程序 <code>aliveness-test</code> 运行在 Erlang 虚拟机内部， 因此它不会受到网络问题的影响。</p>
<h3 id="5-4-元数据管理与监控"><a href="#5-4-元数据管理与监控" class="headerlink" title="5.4 元数据管理与监控"></a>5.4 元数据管理与监控</h3><p>确保 RabbitMQ 能够健康运行还不足以让人放松警惕。比如在生产环境误删了一个队列（或者删除交换器、修改绑定信息等），若业务方正在使用这个队列，返回了异常后即使处理还能尽量的减少影响。但如果是深夜执行的定时任务，处理起来就很麻烦了。</p>
<p>许多应用场景是在业务逻辑代码中创建相应的元数据资源（交换器、队列及绑定关系）并使用对于排他的、自动删除的这类非高可靠性要求的元数据资源可以在一定程度上忽略元数据变更的影响。但是对于两个非常重要的且通过消息中间件交互的业务应用，在使用相应的元数据资源时最好进行相应的管控，如果一方或者其他方肆意变更所使用的元数据，必然对另一方造成不小的损失。管控的介入自然会降低消息中间件的灵活度，但是可以增强系统的可靠性。 比如通过专用的“元数据审核系统”来配置相应的元数据资源，提供给业务方使用的用户只有 可读和可写的权限，这样可以进一步降低风险。</p>
<p>RabbitMQ 在创建元数据资源的时候是以一种声明的形式完成的：无则创建、有则不变，不过在对应的元数据存在的情况下，对其再次声明时使用不同的属性会报出相应的错误信息。 我们可以利用这一特性来监控元数据的变更，通过定时程序来将记录中的元数据信息重新声明一次，查看是否有异常报出。不过这种方法非常具有局限性，只能增加元数据的信息而不能减少。比如有一个队列没有消费者且以后也不会被使用，我们对其进行了解绑操作，这样就没有更多的消息流入而造成消息堆积，不过这一变更由于某些局限性没有及时将记录变更以通知到那个定时程序，此时又重新将此队列绑定到原交换器中。</p>
<p>如图 7-15 所示，所有的业务应用都需要通过元数据审核系统来申请创建（当然也可以包含查询、修改及删除）相应的元数据信息。在申请动作完成之后，由专门的人员进行审批，之后在数据库中存储和在 RabbitMQ 集群中创建相应的元数据，这两个步骤可以同时进行，而且也无须为这两个动作添加强一致性的事务逻辑。在数据库和 RabbitMQ 集群之间会有一个元数据一致性校验程序来检测元数据不一致的地方，然后将不一致的数据上送到监控管理系统。监控管理系统中可以显示元数据不一致的记录信息，也可以以告警的形式推送出来，然后相应的管 理人员可以选择手动或者自动地进行元数据修正。这里的不一致有可能是由于数据库的记录未被正确及时地更新，有可能是 RabbitMQ 集群中元数据被异常篡改 元数据修正需慎之又慎，在整个系统修正逻辑完备之前，建议优先采用人工的方式，毕竟不一致的元数据仅占少数，人工修正的工作量并不太大。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201001/202010010128.png" alt></p>
<p>主要的元数据是：queues、exchanges、bindings ，可以分别建立三张表。元数据一致性检测程序可以通过 /api/definitions 的 HTTP API 接口获取集群的元数据信息，通过解析之后与数据库中的记录一一比对，查看是否有不一致的地方。</p>
<hr>
<p>参考：</p>
<p>🔗 《RabbitMQ实战指南》</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    林沂水
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://linyishui.top/2020100801.html" title="RabbitMQ（六）运维">http://linyishui.top/2020100801.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    
      <div>
         ﻿<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      </div>
    
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/distributed/" rel="tag"># distributed</a>
          
            <a href="/tags/mom/" rel="tag"># mom</a>
          
            <a href="/tags/rabbitmq/" rel="tag"># rabbitmq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020100601.html" rel="next" title="RabbitMQ（五）配置">
                <i class="fa fa-chevron-left"></i> RabbitMQ（五）配置
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020101001.html" rel="prev" title="RabbitMQ（七）Federation与Shovel">
                RabbitMQ（七）Federation与Shovel <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
     <div class="comments" id="comments">
       

<script src="https://utteranc.es/client.js" repo="LAILAIWA/LAILAIWA.github.io" issue-term="pathname" label="💬Comments" theme="github-light" crossorigin="anonymous" async>
</script>



     </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg" alt="林沂水">
            
              <p class="site-author-name" itemprop="name">林沂水</p>
              <p class="site-description motion-element" itemprop="description">记录编程点滴，写点生活中的酸甜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">304</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">99</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/LAILAIWA" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:linyishui168@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/linyishui618" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/linyishui618" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5340162234" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo.com"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          <div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("07/26/2018 00:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒";
}
function setzero(i) {
    if (i<10) {
        i="0" + i
    };
    return i;
}
show_date_time();
</script>  
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RabbitMQ（六）运维"><span class="nav-number">1.</span> <span class="nav-text">RabbitMQ（六）运维</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一节-集群搭建"><span class="nav-number">1.1.</span> <span class="nav-text">第一节 集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-多机多节点配置"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 多机多节点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-配置流程"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1.1.1 配置流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-节点关闭的几种情况"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">1.1.2 节点关闭的几种情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-集群节点类型"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 集群节点类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-两种节点类型"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">1.2.1 两种节点类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-如何指定或切换节点类型"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">1.2.2 如何指定或切换节点类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-如何选择内存还是磁盘节点"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">1.2.3 如何选择内存还是磁盘节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-剔除单个节点"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 剔除单个节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-如何从集群中删除一个节点"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">1.3.1 如何从集群中删除一个节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-集群节点的升级"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 集群节点的升级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-独立节点的升级"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">1.4.1 独立节点的升级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-2-集群节点的升级步骤"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">1.4.2 集群节点的升级步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-单机多节点配置"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 单机多节点配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二节-查看服务日志"><span class="nav-number">1.2.</span> <span class="nav-text">第二节 查看服务日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-启动RabbitMQ服务"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 启动RabbitMQ服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-关闭RabbitMQ服务"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 关闭RabbitMQ服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-建立集群"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 建立集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-其他"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 其他</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-日常积累各种操作对应日志格式"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 日常积累各种操作对应日志格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-日志文件管理"><span class="nav-number">1.2.6.</span> <span class="nav-text">2.6 日志文件管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三节-单点故障恢复"><span class="nav-number">1.3.</span> <span class="nav-text">第三节 单点故障恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-什么是单点故障"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 什么是单点故障</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-四种常见的单点故障"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 四种常见的单点故障</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四节-集群迁移"><span class="nav-number">1.4.</span> <span class="nav-text">第四节 集群迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-准备阶段-元数据重建"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 准备阶段-元数据重建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-数据迁移和客户端连接的切换"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 数据迁移和客户端连接的切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-自动化迁移"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.3 自动化迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-使用资源的3个部分"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">4.3.1 使用资源的3个部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-自动化迁移过程"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">4.3.2 自动化迁移过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-空闲备份集群解决方案"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">4.3.3 空闲备份集群解决方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第五节-集群监控"><span class="nav-number">1.5.</span> <span class="nav-text">第五节 集群监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-通过HTTP-API接口提供监控数据"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 通过HTTP API接口提供监控数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-通过客户端提供监控数据"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 通过客户端提供监控数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-检测RabbitMQ服务是否健康"><span class="nav-number">1.5.3.</span> <span class="nav-text">5.3 检测RabbitMQ服务是否健康</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-元数据管理与监控"><span class="nav-number">1.5.4.</span> <span class="nav-text">5.4 元数据管理与监控</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">林沂水</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
   

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
