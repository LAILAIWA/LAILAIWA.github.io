<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig Dug.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="mask-icon" href="/images/gamepad playstation.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="spring cloud," />





  <link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml" />






<meta name="description" content="Spring Cloud Zuul API网关，内容包括：简介，使用Zuul构建微服务网关，Zuul路由配置，Zuul过滤器讲解，Zuul容错和回退，Zuul使用小经验，Zuul高可用。">
<meta name="keywords" content="spring cloud">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud-Zuul API网关">
<meta property="og:url" content="http://linyishui.top/2019111401.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="Spring Cloud Zuul API网关，内容包括：简介，使用Zuul构建微服务网关，Zuul路由配置，Zuul过滤器讲解，Zuul容错和回退，Zuul使用小经验，Zuul高可用。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010161.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010159.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010160.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010162.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010163.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010164.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010165.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010166.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010167.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010168.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010169.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010170.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010171.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010172.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010169.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010173.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010174.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010175.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010176.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010177.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010178.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010179.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010180.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010181.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010182.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010183.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010184.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010185.png">
<meta property="og:updated_time" content="2020-04-02T07:38:34.942Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Cloud-Zuul API网关">
<meta name="twitter:description" content="Spring Cloud Zuul API网关，内容包括：简介，使用Zuul构建微服务网关，Zuul路由配置，Zuul过滤器讲解，Zuul容错和回退，Zuul使用小经验，Zuul高可用。">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010161.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linyishui.top/2019111401.html"/>





  <title>Spring Cloud-Zuul API网关 | 俺的部落格</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">俺的部落格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">俺寻思俺需要记点东西</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            日程表
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2019111401.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Speciosity">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Cloud-Zuul API网关</h1>
        

        <div class="post-meta">
          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-14T17:35:25+08:00">
                2019-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术文档/" itemprop="url" rel="index">
                    <span itemprop="name">技术文档</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8,730
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  41
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Spring Cloud Zuul API网关，内容包括：简介，使用Zuul构建微服务网关，Zuul路由配置，Zuul过滤器讲解，Zuul容错和回退，Zuul使用小经验，Zuul高可用。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Spring-Cloud-Zuul-API网关"><a href="#Spring-Cloud-Zuul-API网关" class="headerlink" title="Spring Cloud-Zuul API网关"></a><strong>Spring Cloud-Zuul API网关</strong></h1><h2 id="第一节-简介"><a href="#第一节-简介" class="headerlink" title="第一节 简介"></a><strong>第一节 简介</strong></h2><h3 id="1-1-什么是API网关"><a href="#1-1-什么是API网关" class="headerlink" title="1.1 什么是API网关"></a><strong>1.1 什么是API网关</strong></h3><p>&emsp;&emsp;API网关是对外服务的一个入口，其隐藏了内部架构的实现，是微服务架构中必不可少的一个组件。API网关可以为我们管理大量的API接口，还可以<strong>对接客户</strong>、<strong>适配协议</strong>、<strong>进行安全认证</strong>、<strong>转发路由</strong>、<strong>限制流量</strong>、<strong>监控日志</strong>、<strong>防止爬虫</strong>、<strong>进行灰度发布</strong>等。</p>
<h3 id="1-2-API网关的作用"><a href="#1-2-API网关的作用" class="headerlink" title="1.2 API网关的作用"></a><strong>1.2 API网关的作用</strong></h3><p>&emsp;&emsp;随着业务发展，服务越来越多，前端用户如何调用微服务就成了一个难题。比如用户评估一个小区，评估完成后需要展示小区详情、房价走势、成交数据、挂牌数据等，这些信息都在不同的服务中，前端系统想要实现这样一个功能就需要和众多的服务进行交互，调用它们提供的接口，这样性能肯定是低的。而且前端的逻辑变得更复杂了，它需要知道所有提供信息的微服务。这个时候API网关的作用就体现出来了，通过API聚合内部服务，提供统一对外的API接口给前端系统，屏蔽内部实现细节。</p>
<h3 id="1-3-Zuul"><a href="#1-3-Zuul" class="headerlink" title="1.3 Zuul"></a><strong>1.3 Zuul</strong></h3><p>&emsp;&emsp;Zuul是Netflix OSS中的一员，是<strong>一个基于JVM路由和服务端的负载均衡器</strong>。提供<strong>路由</strong>、<strong>监控</strong>、<strong>弹性</strong>、<strong>安全</strong>等方面的服务框架。Zuul能够与Eureka、Ribbon、Hystrix等组件配合使用。</p>
<p>&emsp;&emsp;Zuul的核心是过滤器，通过这些过滤器我们可以扩展出很多功能，如下所示。</p>
<blockquote>
<ul>
<li><strong>动态路由</strong>：动态地将客户端的请求路由到后端不同的服务，做一些逻辑处理，比如聚合多个服务的数据返回。</li>
<li><strong>请求监控</strong>：可以对整个系统的请求进行监控，记录详细的请求响应日志，可以实时统计出当前系统的访问量以及监控状态。</li>
<li><strong>认证鉴权</strong>：对每一个访问的请求做认证，拒绝非法请求，保护好后端的服务。</li>
<li><strong>压力测试</strong>：压力测试是一项很重要的工作，像一些电商公司需要模拟更多真实的用户并发量来保证重大活动时系统的稳定。通过Zuul可以动态地将请求转发到后端服务的集群中，还可以识别测试流量和真实流量，从而做一些特殊处理。</li>
<li><strong>灰度发布</strong>：灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</li>
</ul>
</blockquote>
<hr>
<h2 id="第二节-使用Zuul构建微服务网关"><a href="#第二节-使用Zuul构建微服务网关" class="headerlink" title="第二节 使用Zuul构建微服务网关"></a><strong>第二节 使用Zuul构建微服务网关</strong></h2><h3 id="2-1-简单使用"><a href="#2-1-简单使用" class="headerlink" title="2.1 简单使用"></a><strong>2.1 简单使用</strong></h3><p>&emsp;&emsp;创建一个Maven项目zuul-demo，在pom.xml中增加Spring Cloud项目的依赖，然后加入Zuul的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- zuul --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;配置属性文件，增加如下配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=zuul-demo</span><br><span class="line">server.port=2103</span><br><span class="line"></span><br><span class="line">zuul.routes.customname.path=/linyishui/**</span><br><span class="line">zuul.routes.customname.url=http://linyishui.top/</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过zuul.routes配置路由转发，linyishui是自定义的名称，当访问linyishui/**开始的地址时，就会跳转到<a href="http://linyishui.top/">http://linyishui.top/</a></p>
<p>&emsp;&emsp;启动类通过注解@EnableZuulProxy开启路由代理功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulDemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;启动服务，访问<a href="http://localhost:2103/linyishui" target="_blank" rel="noopener">http://localhost:2103/linyishui</a></p>
<p>&emsp;&emsp;最终会跳转至<a href="http://linyishui.top/">http://linyishui.top/</a></p>
<h3 id="2-2-集成Eureka"><a href="#2-2-集成Eureka" class="headerlink" title="2.2 集成Eureka"></a><strong>2.2 集成Eureka</strong></h3><p>&emsp;&emsp;通常的使用中是用Zuul来代理请求转发到内部的服务上去，统一为外部提供服务。内部服务的数量会很多，而且可以随时扩展，我们不可能每增加一个服务就改一次路由的配置，所以也得通过结合Eureka来实现动态的路由转发功能。</p>
<p>&emsp;&emsp;添加Eureka的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Eureka --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;启动类不用再添加@EnableDiscoveryClient，因为@EnableZuulProxy已经包含了前者。只需要增加Eureka地址配置即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.service-url.defaultZone=http://linyishui:123456@localhost:8761/eureka,http://linyishui:123456@localhost:8762/eureka</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启服务，我们可以通过默认的转发规则来访问Eureka中的服务，比如访问hystrix-demo的callHello接口，如下图所示8085端口对应服务。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010161.png" alt=""></p>
<p>&emsp;&emsp;直接访问接口，如下图所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010159.png" alt=""></p>
<p>&emsp;&emsp;通过转发访问接口，如下图所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010160.png" alt=""></p>
<p>&emsp;&emsp;访问的规则为：<strong>API网关地址</strong> + <strong>访问的服务名称</strong> + <strong>接口URI</strong></p>
<hr>
<h2 id="第三节-Zuul路由配置"><a href="#第三节-Zuul路由配置" class="headerlink" title="第三节 Zuul路由配置"></a><strong>第三节 Zuul路由配置</strong></h2><p>&emsp;&emsp;当Zuul集成Eureka之后，其实就可以为Eureka中所有的服务进行路由操作，所以在给服务指定名称时可以尽量的简短一些，这样适合<strong>直接通过默认访问规则来访问</strong>，而不用给每个服务都制定一个路由规则，这样就算新增了服务，API网关也<strong>不需要进行修改和重启</strong>（反之则需要）。</p>
<blockquote>
<p>默认访问规则如下所示：</p>
<ul>
<li>API网关地址：<a href="http://localhost:2103" target="_blank" rel="noopener">http://localhost:2103</a></li>
<li>用户服务名称：user-service</li>
<li>用户登录接口：/user/login</li>
</ul>
<p>所以应该访问：<a href="http://localhost:2103/user-service/user/login" target="_blank" rel="noopener">http://localhost:2103/user-service/user/login</a></p>
</blockquote>
<h3 id="3-1-指定具体服务路由"><a href="#3-1-指定具体服务路由" class="headerlink" title="3.1 指定具体服务路由"></a><strong>3.1 指定具体服务路由</strong></h3><p>&emsp;&emsp;可以为每一个服务都配置一个路由转发规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 为单个服务指定路由转发规则</span><br><span class="line">zuul.routes.eureka-client-hystrix-demo.path=/hystrix-demo/**</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上述将服务eureka-client-hystrix-demo路由地址配置为hystrix-demo，两个星号表示适配任意层级的URL，一个星号则只适配一层。</p>
<p>&emsp;&emsp;重启服务，用新的转发地址访问，如下所示，当然默认的访问地址依旧能用。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010162.png" alt=""></p>
<h3 id="3-2-路由前缀"><a href="#3-2-路由前缀" class="headerlink" title="3.2 路由前缀"></a><strong>3.2 路由前缀</strong></h3><p>&emsp;&emsp;我们可能会想在API前面配置一个统一的前缀，比如xxx.com/user/login这样的接口，变为xxx.com/rest/user/login，也就是在前面加一个rest，通过增加以下配置实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 增加统一前缀</span><br><span class="line">zuul.prefix=/rest</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启服务如下所示，会导致旧的访问路径失效。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010163.png" alt=""></p>
<h3 id="3-3-本地跳转"><a href="#3-3-本地跳转" class="headerlink" title="3.3 本地跳转"></a><strong>3.3 本地跳转</strong></h3><p>&emsp;&emsp;Zuul的API路由还提供了本地跳转功能，通过forward就可以实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 添加本地跳转</span><br><span class="line">zuul.routes.zuul-demo.path=/api/**</span><br><span class="line">zuul.routes.zuul-demo.url=forward:/local</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;上述配置会使访问api的请求路由到本地的local上去，所以我们在项目中添加对应接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/local/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">local</span><span class="params">(@PathVariable String id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启服务并访问，结果如下。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010164.png" alt=""></p>
<hr>
<h2 id="第四节-Zuul过滤器讲解"><a href="#第四节-Zuul过滤器讲解" class="headerlink" title="第四节 Zuul过滤器讲解"></a><strong>第四节 Zuul过滤器讲解</strong></h2><p>&emsp;&emsp;Zuul通过<strong>过滤器</strong>来实现如限流和认证等功能。</p>
<h3 id="4-1-过滤器类型"><a href="#4-1-过滤器类型" class="headerlink" title="4.1 过滤器类型"></a><strong>4.1 过滤器类型</strong></h3><p>&emsp;&emsp;Zuul的过滤器和我们常用的javax.servlet.Filter不一样，javax.servlet.Filter只有一种类型，可以通过配置urlPatterns来拦截对应的请求。而Zuul过滤器总共有4种类型，且每种类型都有对应的使用场景。</p>
<blockquote>
<ul>
<li>pre：可以在请求被路由之前调用。适用于身份认证的场景，认证通过后再继续执行下面的流程。</li>
<li>route：在路由请求时被调用。适用于灰度发布场景，在将要路由的时候可以做一些自定义的逻辑。</li>
<li>post：在route和error过滤器之后被调用。这种过滤器将请求路由到达具体的服务之后执行。适用于需要添加响应头，记录响应日志等应用场景。</li>
<li>error：处理请求时发生错误时被调用。在执行过程中发送错误时会进入error过滤器，可以用来统一记录错误信息。</li>
</ul>
</blockquote>
<h3 id="4-2-请求生命周期"><a href="#4-2-请求生命周期" class="headerlink" title="4.2 请求生命周期"></a><strong>4.2 请求生命周期</strong></h3><p>&emsp;&emsp;过滤器执行生命周期如下图所示，图片来源自<a href="https://github.com/Netflix/zuul/wiki/How-it-Works" title="title" target="_blank" rel="noopener">Zuul GitHub Wiki</a>。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010165.png" alt=""></p>
<p>&emsp;&emsp;请求首先发送到pre过滤器，再到routing过滤器，最后到post过滤器，任意过滤器出现异常都会进入error过滤器。</p>
<p>&emsp;&emsp;通过com.netflix.zuul.http.ZuulServlet源码也可以看到完整的执行顺序，ZuulServlet类似于Spring MVC的DispatcherServlet，所有的Request都要经过ZuulServlet的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3374242278843351500L</span>;</span><br><span class="line">    <span class="keyword">private</span> ZuulRunner zuulRunner;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZuulServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(config);</span><br><span class="line">        String bufferReqsStr = config.getInitParameter(<span class="string">"buffer-requests"</span>);</span><br><span class="line">        <span class="keyword">boolean</span> bufferReqs = bufferReqsStr != <span class="keyword">null</span> &amp;&amp; bufferReqsStr.equals(<span class="string">"true"</span>);</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner = <span class="keyword">new</span> ZuulRunner(bufferReqs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.init((HttpServletRequest)servletRequest, (HttpServletResponse)servletResponse);</span><br><span class="line">            RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">            context.setZuulEngineRan();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//最先经过pre过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.preRoute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var13) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var13);</span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//然后是route过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.route();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var12) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var12);</span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//最后是post过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var11) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var11);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var14) &#123;</span><br><span class="line">            <span class="keyword">this</span>.error(<span class="keyword">new</span> ZuulException(var14, <span class="number">500</span>, <span class="string">"UNHANDLED_EXCEPTION_"</span> + var14.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            RequestContext.getCurrentContext().unset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.postRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.route();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.preRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(HttpServletRequest servletRequest, HttpServletResponse servletResponse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.init(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(ZuulException e)</span> </span>&#123;</span><br><span class="line">        RequestContext.getCurrentContext().setThrowable(e);</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-使用过滤器"><a href="#4-3-使用过滤器" class="headerlink" title="4.3 使用过滤器"></a><strong>4.3 使用过滤器</strong></h3><p>&emsp;&emsp;我们创建一个pre过滤器，来实现IP黑名单的过滤操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// IP黑名单列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blackIpList = Arrays.asList(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IpFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        String ip = getIpAddr(ctx.getRequest());</span><br><span class="line">        <span class="comment">// 黑名单禁用</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(ip) &amp;&amp; blackIpList.contains(ip))&#123;</span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            ResponseData data = ResponseData.fail(<span class="string">" 非法请求"</span>, ResponseCode.NO_AUTH_CODE.getCode());</span><br><span class="line">            ctx.setResponseBody(JsonUtils.toJson(data));</span><br><span class="line">            ctx.getResponse().setContentType(<span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>作者未提供上述部分工具类来源，所以根据功能找了一些替代工具或自己实现</em></p>
<blockquote>
<p>自定义过滤器需要继承抽象类ZuulFilter，并实现以下方法：</p>
<ul>
<li>shouldFilter：是否执行该过滤器，true表示执行，false则不执行。也可以通过配置中心来实现动态的开启和关闭过滤器。</li>
<li>filterType：过滤器类型，可选值包括：pre、route、post、error。</li>
<li>filterOrder：过滤器的执行顺序，数值越小，优先级越高。</li>
<li>run：执行自己的业务逻辑，本段代码中是通过判断请求的IP是否在黑名单中，决定是否进行拦截。通过设置ctx.setSendZuulResponse(false)告诉Zuul不需要将当前请求转发到后端服务，通过setResponseBody返回数据到客户端。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;使用过滤器还需要最后一步，配置类中声明过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IpFilter <span class="title">ipFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IpFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-禁用过滤器"><a href="#4-4-禁用过滤器" class="headerlink" title="4.4 禁用过滤器"></a><strong>4.4 禁用过滤器</strong></h3><blockquote>
<p>禁用过滤器有两种方式:</p>
<ul>
<li>利用shouldFilter方法return false使过滤器不再执行。</li>
<li>通过配置方式禁用过滤器，格式为”zuul.&lt;过滤器类名&gt;.&lt;过滤器类型&gt;.disable=true”。</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zuul.IpFilter.pre.disable=true</span><br></pre></td></tr></table></figure>
<h3 id="4-5-过滤器中传递数据"><a href="#4-5-过滤器中传递数据" class="headerlink" title="4.5 过滤器中传递数据"></a><strong>4.5 过滤器中传递数据</strong></h3><p>&emsp;&emsp;我们可能会有这样的需求，前一个执行的过滤器需要传递数据给后面的过滤器。实现这种传值的方式首先可以想到ThreadLocal，而Zuul也有其解决方案，即通过RequestContext的set方法进行传递，当然RequestContext也是通过ThreadLocal来实现的。</p>
<p>&emsp;&emsp;前一个过滤器如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过滤器间传递数据</span></span><br><span class="line">RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">ctx.set(<span class="string">"msg"</span>,<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;后一个过滤器如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">      ctx.get(<span class="string">"msg"</span>);</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;源码如下，RequestContext继承了ConcurrentHashMap，是一个线程安全的哈希映射集合，通过threadLocal进行线程内访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span> <span class="keyword">extends</span> <span class="title">ConcurrentHashMap</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(RequestContext.class);</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Class&lt;? extends RequestContext&gt; contextClass = RequestContext.class;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RequestContext testContext = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;? extends RequestContext&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;RequestContext&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> RequestContext <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (RequestContext)RequestContext.contextClass.newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var2) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(var2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestContext <span class="title">getCurrentContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (testContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> testContext;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            RequestContext context = (RequestContext)threadLocal.get();</span><br><span class="line">            <span class="keyword">return</span> context;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.put(key, Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.put(key, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-6-过滤器拦截请求"><a href="#4-6-过滤器拦截请求" class="headerlink" title="4.6 过滤器拦截请求"></a><strong>4.6 过滤器拦截请求</strong></h3><p>&emsp;&emsp;在过滤器中对请求进行拦截并返回结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line"><span class="comment">// 告知Zuul不需要将当前请求转发给后端服务，主要是通过shouldFilter来拦截</span></span><br><span class="line">ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 用来拦截本地转发请求，如果我们配置了forward:/local的路由，setSendZuulResponse(false)是不能阻止forward的。</span></span><br><span class="line">ctx.set(<span class="string">"sendForwardFilter.ran"</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">ctx.setResponseBody(<span class="string">" 返回消息 "</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;RibbonRoutingFilter中shouldFilter()方法会同时判断setSendZuulResponse对应的布尔值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">       <span class="keyword">return</span> ctx.getRouteHost() == <span class="keyword">null</span> &amp;&amp; ctx.get(<span class="string">"serviceId"</span>) != <span class="keyword">null</span> &amp;&amp; ctx.sendZuulResponse();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;SendForwardFilter中shouldFilter()方法会同时判断”sendForwardFilter.ran”对应的布尔值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendForwardFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEND_FORWARD_FILTER_RAN = <span class="string">"sendForwardFilter.ran"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SendForwardFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"route"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="keyword">return</span> ctx.containsKey(<span class="string">"forward.to"</span>) &amp;&amp; !ctx.getBoolean(<span class="string">"sendForwardFilter.ran"</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">            String path = (String)ctx.get(<span class="string">"forward.to"</span>);</span><br><span class="line">            RequestDispatcher dispatcher = ctx.getRequest().getRequestDispatcher(path);</span><br><span class="line">            <span class="keyword">if</span> (dispatcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ctx.set(<span class="string">"sendForwardFilter.ran"</span>, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (!ctx.getResponse().isCommitted()) &#123;</span><br><span class="line">                    dispatcher.forward(ctx.getRequest(), ctx.getResponse());</span><br><span class="line">                    ctx.getResponse().flushBuffer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">            ReflectionUtils.rethrowRuntimeException(var4);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;以上确实可以实现拦截请求并返回结果给客户端，但当项目中出现多个过滤器时，假设需要过滤的过滤器是第一个执行，发现非法请求后进行拦截，如果是javax.servlet.Filter进行拦截在chain.doFilter之前返回就可以使过滤器不继续执行，但对于Zuul的过滤器，即使增加了上述配置，后续等待执行的过滤器依然会继续执行。</p>
<p>&emsp;&emsp;通过以下ZuulServlet源码可以得知，service方法执行对应的过滤器，分别通过zuulRunner调用执行过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3374242278843351500L</span>;</span><br><span class="line">    <span class="keyword">private</span> ZuulRunner zuulRunner;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZuulServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(config);</span><br><span class="line">        String bufferReqsStr = config.getInitParameter(<span class="string">"buffer-requests"</span>);</span><br><span class="line">        <span class="keyword">boolean</span> bufferReqs = bufferReqsStr != <span class="keyword">null</span> &amp;&amp; bufferReqsStr.equals(<span class="string">"true"</span>);</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner = <span class="keyword">new</span> ZuulRunner(bufferReqs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// service方法执行对应的过滤器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.init((HttpServletRequest)servletRequest, (HttpServletResponse)servletResponse);</span><br><span class="line">            RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">            context.setZuulEngineRan();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//最先经过pre过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.preRoute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var13) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var13);</span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//然后是route过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.route();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var12) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var12);</span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//最后是post过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.postRoute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ZuulException var11) &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(var11);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var14) &#123;</span><br><span class="line">            <span class="keyword">this</span>.error(<span class="keyword">new</span> ZuulException(var14, <span class="number">500</span>, <span class="string">"UNHANDLED_EXCEPTION_"</span> + var14.getClass().getName()));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            RequestContext.getCurrentContext().unset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分别通过zuulRunner调用执行过滤器</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.postRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.route();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.preRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(HttpServletRequest servletRequest, HttpServletResponse servletResponse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.init(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(ZuulException e)</span> </span>&#123;</span><br><span class="line">        RequestContext.getCurrentContext().setThrowable(e);</span><br><span class="line">        <span class="keyword">this</span>.zuulRunner.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;ZuulRunner中实例化FilterProcessor对象，并调用对应过滤器方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulRunner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> bufferRequests;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZuulRunner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferRequests = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZuulRunner</span><span class="params">(<span class="keyword">boolean</span> bufferRequests)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferRequests = bufferRequests;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(HttpServletRequest servletRequest, HttpServletResponse servletResponse)</span> </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.bufferRequests) &#123;</span><br><span class="line">            ctx.setRequest(<span class="keyword">new</span> HttpServletRequestWrapper(servletRequest));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.setRequest(servletRequest);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.setResponse(<span class="keyword">new</span> HttpServletResponseWrapper(servletResponse));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="comment">//实例化FilterProcessor对象，并调用对应过滤器方法</span></span><br><span class="line">        FilterProcessor.getInstance().postRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">route</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        FilterProcessor.getInstance().route();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        FilterProcessor.getInstance().preRoute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterProcessor.getInstance().error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;FilterProcessor通过统一的runFilters函数，根据过滤器类型参数获取所有此类型的过滤器，并调用ZuulFilter.runFilter()执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preRoute</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.runFilters(<span class="string">"pre"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ZuulException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZuulException(var3, <span class="number">500</span>, <span class="string">"UNCAUGHT_EXCEPTION_IN_PRE_FILTER_"</span> + var3.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">runFilters</span><span class="params">(String sType)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (RequestContext.getCurrentContext().debugRouting()) &#123;</span><br><span class="line">            Debug.addRoutingDebug(<span class="string">"Invoking &#123;"</span> + sType + <span class="string">"&#125; type filters"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> bResult = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 根据过滤器类型参数获取所有此类型的过滤器</span></span><br><span class="line">        List&lt;ZuulFilter&gt; list = FilterLoader.getInstance().getFiltersByType(sType);</span><br><span class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 遍历并</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">                ZuulFilter zuulFilter = (ZuulFilter)list.get(i);</span><br><span class="line">                Object result = <span class="keyword">this</span>.processZuulFilter(zuulFilter);</span><br><span class="line">                <span class="keyword">if</span> (result != <span class="keyword">null</span> &amp;&amp; result <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">                    bResult |= (Boolean)result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bResult;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行ZuulFilter</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">processZuulFilter</span><span class="params">(ZuulFilter filter)</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="keyword">boolean</span> bDebug = ctx.debugRouting();</span><br><span class="line">        String metricPrefix = <span class="string">"zuul.filter-"</span>;</span><br><span class="line">        <span class="keyword">long</span> execTime = <span class="number">0L</span>;</span><br><span class="line">        String filterName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> ltime = System.currentTimeMillis();</span><br><span class="line">            filterName = filter.getClass().getSimpleName();</span><br><span class="line">            RequestContext copy = <span class="keyword">null</span>;</span><br><span class="line">            Object o = <span class="keyword">null</span>;</span><br><span class="line">            Throwable t = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (bDebug) &#123;</span><br><span class="line">                Debug.addRoutingDebug(<span class="string">"Filter "</span> + filter.filterType() + <span class="string">" "</span> + filter.filterOrder() + <span class="string">" "</span> + filterName);</span><br><span class="line">                copy = ctx.copy();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// runFilter()执行过滤器</span></span><br><span class="line">            ZuulFilterResult result = filter.runFilter();</span><br><span class="line">            ExecutionStatus s = result.getStatus();</span><br><span class="line">            execTime = System.currentTimeMillis() - ltime;</span><br><span class="line">            <span class="keyword">switch</span>(s) &#123;</span><br><span class="line">            <span class="keyword">case</span> FAILED:</span><br><span class="line">                t = result.getException();</span><br><span class="line">                ctx.addFilterExecutionSummary(filterName, ExecutionStatus.FAILED.name(), execTime);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SUCCESS:</span><br><span class="line">                o = result.getResult();</span><br><span class="line">                ctx.addFilterExecutionSummary(filterName, ExecutionStatus.SUCCESS.name(), execTime);</span><br><span class="line">                <span class="keyword">if</span> (bDebug) &#123;</span><br><span class="line">                    Debug.addRoutingDebug(<span class="string">"Filter &#123;"</span> + filterName + <span class="string">" TYPE:"</span> + filter.filterType() + <span class="string">" ORDER:"</span> + filter.filterOrder() + <span class="string">"&#125; Execution time = "</span> + execTime + <span class="string">"ms"</span>);</span><br><span class="line">                    Debug.compareContextState(filterName, copy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> t;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.usageNotifier.notify(filter, s);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var15) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bDebug) &#123;</span><br><span class="line">                Debug.addRoutingDebug(<span class="string">"Running Filter failed "</span> + filterName + <span class="string">" type:"</span> + filter.filterType() + <span class="string">" order:"</span> + filter.filterOrder() + <span class="string">" "</span> + var15.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.usageNotifier.notify(filter, ExecutionStatus.FAILED);</span><br><span class="line">            <span class="keyword">if</span> (var15 <span class="keyword">instanceof</span> ZuulException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (ZuulException)var15;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ZuulException ex = <span class="keyword">new</span> ZuulException(var15, <span class="string">"Filter threw Exception"</span>, <span class="number">500</span>, filter.filterType() + <span class="string">":"</span> + filterName);</span><br><span class="line">                ctx.addFilterExecutionSummary(filterName, ExecutionStatus.FAILED.name(), execTime);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;所以虽然第一个过滤器阻止了请求，但后续过滤器依然会被循环调用执行。解决方案就是由前一个过滤器告知后一个过滤器是否要执行，在拦截器run()函数中增加传递数据isSuccess。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.set(<span class="string">"isSuccess"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;后续过滤器通过此布尔值来判断是否需要继续执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">    Object success = ctx.get(<span class="string">"isSuccess"</span>);</span><br><span class="line">    <span class="keyword">return</span> success == <span class="keyword">null</span> ? <span class="keyword">true</span> : Boolean.parseBoolean(success.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-7-过滤器中异常处理"><a href="#4-7-过滤器中异常处理" class="headerlink" title="4.7 过滤器中异常处理"></a><strong>4.7 过滤器中异常处理</strong></h3><p>&emsp;&emsp;过滤器中的异常主要发生在run方法中，可以用try-catch来捕捉处理。Zuul中也为我们提供了一个异常处理的过滤器，当过滤器在执行过程中发生异常，若没有被捕获到就会进入error过滤器中。</p>
<p>&emsp;&emsp;我们可以自定义一个error过滤器来记录异常信息，不要忘记在配置类中声明ErrorFilter的Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ErrorFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        Throwable throwable = ctx.getThrowable();</span><br><span class="line">        logger.error(<span class="string">"Filter Error : &#123;&#125;"</span>, throwable.getCause().getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;然后可以在其他过滤器中模拟一下发生异常，并启动项目观察效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">    RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">    <span class="comment">// 异常代码</span></span><br><span class="line">    System.out.println(<span class="number">2</span>/<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;显式如下500错误白页。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010166.png" alt=""></p>
<p>&emsp;&emsp;控制台也输出了对应日志。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">58</span><span class="variable">.058</span>  WARN <span class="number">7744</span> --- [nio-<span class="number">2103</span>-exec-<span class="number">2</span>] o<span class="variable">.s</span><span class="variable">.c</span><span class="variable">.n</span><span class="variable">.z</span><span class="variable">.filters</span><span class="variable">.post</span><span class="variable">.SendErrorFilter</span>   : Error during filtering</span><br><span class="line"></span><br><span class="line">com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.exception</span><span class="variable">.ZuulException</span>: Filter threw Exception</span><br><span class="line">	at com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.FilterProcessor</span><span class="variable">.processZuulFilter</span>(FilterProcessor<span class="variable">.java</span>:<span class="number">227</span>) ~[zuul-core-<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span><span class="variable">.jar</span>:<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span>]</span><br><span class="line">	at com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.FilterProcessor</span><span class="variable">.runFilters</span>(FilterProcessor<span class="variable">.java</span>:<span class="number">157</span>) ~[zuul-core-<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span><span class="variable">.jar</span>:<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span>]</span><br><span class="line">	at com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.FilterProcessor</span><span class="variable">.preRoute</span>(FilterProcessor<span class="variable">.java</span>:<span class="number">133</span>) ~[zuul-core-<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span><span class="variable">.jar</span>:<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span>]</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Caused by: java<span class="variable">.lang</span><span class="variable">.ArithmeticException</span>: / by zero</span><br><span class="line">	at com<span class="variable">.lai</span><span class="variable">.zuuldemo</span><span class="variable">.IpFilter</span><span class="variable">.run</span>(IpFilter<span class="variable">.java</span>:<span class="number">61</span>) ~[classes/:na]</span><br><span class="line">	at com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.ZuulFilter</span><span class="variable">.runFilter</span>(ZuulFilter<span class="variable">.java</span>:<span class="number">117</span>) ~[zuul-core-<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span><span class="variable">.jar</span>:<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span>]</span><br><span class="line">	at com<span class="variable">.netflix</span><span class="variable">.zuul</span><span class="variable">.FilterProcessor</span><span class="variable">.processZuulFilter</span>(FilterProcessor<span class="variable">.java</span>:<span class="number">193</span>) ~[zuul-core-<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span><span class="variable">.jar</span>:<span class="number">1</span><span class="variable">.3</span><span class="variable">.1</span>]</span><br><span class="line">	... <span class="number">62</span> common frames omitted</span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>-<span class="number">11</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">58</span><span class="variable">.067</span> ERROR <span class="number">7744</span> --- [nio-<span class="number">2103</span>-exec-<span class="number">2</span>] com<span class="variable">.lai</span><span class="variable">.zuuldemo</span><span class="variable">.ErrorFilter</span>             : Filter Error : / by zero</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们的后端都是REST风格的API，返回的数据理应是固定的Json格式，可以通过ErrorController来解决此问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorHandleController</span> <span class="keyword">implements</span> <span class="title">ErrorController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ErrorAttributes errorAttributes;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/error"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseData <span class="title">error</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; errorAttributes = getErrorAttributes(request);</span><br><span class="line">        String message = (String) errorAttributes.get(<span class="string">"message"</span>);</span><br><span class="line">        String trace = (String) errorAttributes.get(<span class="string">"trace"</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(trace))&#123;</span><br><span class="line">            message += String.format(<span class="string">" and trace %s"</span>, trace);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseData.fail(message, ResponseData.Code.SERVER_ERROR_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorAttributes.getErrorAttributes(<span class="keyword">new</span> ServletWebRequest(request), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;ResponseData是返回消息格式，作者未提供代码，所以这边是博主自定义的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseData</span><span class="params">(<span class="keyword">int</span> code, String message, Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseData <span class="title">fail</span><span class="params">(String message,Code code)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseData(code.code,message,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Code &#123;</span><br><span class="line">        SERVER_ERROR_CODE(<span class="number">500</span>),</span><br><span class="line">        NO_AUTH_CODE(<span class="number">203</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">        Code(<span class="keyword">int</span> code) &#123;</span><br><span class="line">            <span class="keyword">this</span>.code = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略了空构造器和Getter/Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启项目，并访问。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010167.png" alt=""></p>
<hr>
<h2 id="第五节-Zuul容错和回退"><a href="#第五节-Zuul容错和回退" class="headerlink" title="第五节 Zuul容错和回退"></a><strong>第五节 Zuul容错和回退</strong></h2><p>&emsp;&emsp;Zuul主要功能是转发，在转发过程中我们无法保证被转发的服务是可用的，所以需要容错机制和回退机制。</p>
<h3 id="5-1-容错机制"><a href="#5-1-容错机制" class="headerlink" title="5.1 容错机制"></a><strong>5.1 容错机制</strong></h3><p>&emsp;&emsp;容错，即<strong>当某个服务不可用时能够切换到其他可用的服务上去</strong>，也就是<strong>重试机制</strong>。</p>
<p>&emsp;&emsp;Zuul中开启重试机制需要spring-retry，首先在项目中引入依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Retry --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;配置文件中增加以下配置开启重试机制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 开启重试，默认为false</span><br><span class="line">zuul.retryable=true</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;也可以指定路由进行重试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 开启重试</span><br><span class="line">zuul.retryable=false</span><br><span class="line"># 通过routes端点指定路由进行重试</span><br><span class="line">zuul.routes.eureka-client-user-service.retryable=true</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;zuul请求是通过Ribbon负载均衡客户端去调用其他服务的，所以我们的重试策略也是在具体的ribbon配置中指定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 设置请求连接的超时时间</span><br><span class="line">ribbon.connectTimeout=500</span><br><span class="line"># 设置请求处理的超时时间</span><br><span class="line">ribbon.readTimeout=5000</span><br><span class="line"># 设置当前实例的重试次数</span><br><span class="line">ribbon.maxAutoRetries=1</span><br><span class="line"># 设置切换实例的最大重试次数</span><br><span class="line">ribbon.maxAutoRetriesNextServer=3</span><br><span class="line"># 设置多所有操作请求都进行重试</span><br><span class="line">ribbon.okToRetryOnAllOperations=true</span><br><span class="line"># 设置对指定的Http响应码进行重试</span><br><span class="line">ribbon.retryableStatusCodes=500,404,502</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;启动两个user-service服务，默认Ribbon的转发规则是轮询，然后停掉其中一个服务。如果没加重试机制，请求接口时必然会有一次被转发到停掉的服务上，返回异常信息。而加了重试机制后，可以尝试循环请求接口，不会返回异常信息，Ribbon会根据重试配置进行重试，把失败的请求转发到可用的服务上。</p>
<p>&emsp;&emsp;服务中心中可以看到开启了两个user-service服务。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010168.png" alt=""></p>
<p>&emsp;&emsp;通过Zuul路由到注册服务接口，调用/user/hello接口，访问7次。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010169.png" alt=""></p>
<p>&emsp;&emsp;8081端口对应user-service打印如下内容。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010170.png" alt=""></p>
<p>&emsp;&emsp;8083端口对应user-service打印如下内容。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010171.png" alt=""></p>
<p>&emsp;&emsp;关闭8083端口对应user-service，继续请求/user/hello接口，会一次成功接着一次失败，如下所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010172.png" alt=""></p>
<p>&emsp;&emsp;开启重试配置，无论多少次请求接口，都不再返还错误结果。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010169.png" alt=""></p>
<h3 id="5-2-回退机制"><a href="#5-2-回退机制" class="headerlink" title="5.2 回退机制"></a><strong>5.2 回退机制</strong></h3><p>&emsp;&emsp;在Spring Cloud中，Zuul默认整合了Hystrix，当后端服务异常时可以为Zuul添加回退功能，返回默认的数据给客户端。</p>
<p>&emsp;&emsp;实现回退机制需要实现FallbackProvider接口，Json工具使用的是阿里巴巴的FastJson。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceConsumerFallbackProvider</span> <span class="keyword">implements</span> <span class="title">FallbackProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ServiceConsumerFallbackProvider.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回*表示对所有服务进行回退操作，指定服务名就可以只针对某个服务进行回退，当然一定要在Eureka中进行注册</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"*"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过ClientHttpResponse构造回退内容</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">(String route, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClientHttpResponse() &#123;</span><br><span class="line">            <span class="comment">// 返回响应的状态码</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getStatusCode().value();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回响应状态码对应的文本</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getStatusCode().getReasonPhrase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回响应的内容</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">""</span>, cause.getCause());</span><br><span class="line">                &#125;</span><br><span class="line">                RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">                ResponseData data = ResponseData.fail(<span class="string">" 服务器内部错误 "</span>, ResponseData.Code.SERVER_ERROR_CODE);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(JSONObject.toJSONBytes(data));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回响应的头信息</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HttpHeaders httpHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">                MediaType mt = <span class="keyword">new</span> MediaType(<span class="string">"application"</span>,<span class="string">"json"</span>, Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">                httpHeaders.setContentType(mt);</span><br><span class="line">                <span class="keyword">return</span> httpHeaders;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启并访问已停掉的服务，如图我们选择eureka-client-hystrix-demo。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010173.png" alt=""></p>
<p>&emsp;&emsp;先正常访问，结果如下。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010174.png" alt=""></p>
<p>&emsp;&emsp;停掉eureka-client-hystrix-demo，返回我们自定义的结果。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010175.png" alt=""></p>
<hr>
<h2 id="第六节-Zuul使用小经验"><a href="#第六节-Zuul使用小经验" class="headerlink" title="第六节 Zuul使用小经验"></a><strong>第六节 Zuul使用小经验</strong></h2><h3 id="6-1-routes端点"><a href="#6-1-routes端点" class="headerlink" title="6.1 /routes端点"></a><strong>6.1 /routes端点</strong></h3><p>&emsp;&emsp;当Zuul和Actuator一起使用时，会增加一个/routes端点，访问/actuator/routes，如下图所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010176.png" alt=""></p>
<h3 id="6-2-filters端点"><a href="#6-2-filters端点" class="headerlink" title="6.2 /filters端点"></a><strong>6.2 /filters端点</strong></h3><p>&emsp;&emsp;访问/actuator/filters会返回Zuul中所有过滤器的信息，可以查看当前有哪些过滤器，以及过滤器是否被禁用等。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010177.png" alt=""></p>
<h3 id="6-3-文件上传"><a href="#6-3-文件上传" class="headerlink" title="6.3 文件上传"></a><strong>6.3 文件上传</strong></h3><p>&emsp;&emsp;新建一个Maven项目zuul-file-demo，并编写一个文件上传接口，然后注册到Eureka。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/file/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fileUpload</span><span class="params">(@RequestParam(value = <span class="string">"file"</span>)</span> MultipartFile file) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = file.getBytes();</span><br><span class="line">        File fileToSave = <span class="keyword">new</span> File(file.getOriginalFilename());</span><br><span class="line">        FileCopyUtils.copy(bytes, fileToSave);</span><br><span class="line">        <span class="keyword">return</span> fileToSave.getAbsolutePath();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如下图所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010178.png" alt=""></p>
<p>&emsp;&emsp;通过Postman测试文件上传，结果如图所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010179.png" alt=""></p>
<p>&emsp;&emsp;现在我们换一个大一点的文件，新的图片大小1.81 MB，结果如图所示</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010180.png" alt=""></p>
<p>&emsp;&emsp;通过Zuul上传文件时会默认限制大小不能超过1MB，所以增加如下配置（注意要同时配置zuul-demo和zuul-file-demo）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 设置Zuul上传文件大小限制，默认1MB</span><br><span class="line">spring.servlet.multipart.max-file-size=1000Mb</span><br><span class="line">spring.servlet.multipart.max-request-size=1000Mb</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启服务，再次上传，如果只配置zuul-demo，结果如下。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010181.png" alt=""></p>
<p>&emsp;&emsp;两个都配置，成功上传。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010182.png" alt=""></p>
<p>&emsp;&emsp;还有一种解决方法是在网关的请求地址前加上/zuul，从而达到绕过Spring DispatcherServlet上传大文件的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 正常地址</span><br><span class="line">http://localhost:2103/zuul-file-demo/file/upload</span><br><span class="line"># 绕过地址</span><br><span class="line">http://localhost:2103/zuul/zuul-file-demo/file/upload</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;虽然这种方法使Zuul不用配置文件上传大小，但接收文件的zuul-file-demo还是要配置文件上传大小。</p>
<p>&emsp;&emsp;还有就是上传大文件的耗时比较长，可以设置合理的超时时间来避免超时导致上传失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 设置超时时间避免大文件上传失败</span><br><span class="line">ribbon.ConnectTimeout=3000</span><br><span class="line">ribbon.RealTimeout=60000</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在Hystrix隔离模式为线程下zuul.ribbon-isolation-strategy=thread，此时需要设置Hystrix超时时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=60000</span><br></pre></td></tr></table></figure>
<h3 id="6-4-请求响应信息输出"><a href="#6-4-请求响应信息输出" class="headerlink" title="6.4 请求响应信息输出"></a><strong>6.4 请求响应信息输出</strong></h3><p>&emsp;&emsp;我们日常使用无法避免通过日志来定位问题所在，所以要在Zuul中输出请求响应的信息。Zuul的四种过滤器每个都有其特定的使用场景，打印日志必然要在请求到达具体的服务后，并返回了才能有数据，所以应该选择<strong>post过滤器</strong>来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(LogFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"post"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123;</span><br><span class="line">        HttpServletRequest req = RequestContext.getCurrentContext().getRequest();</span><br><span class="line">        logger.info(<span class="string">"REQUEST:: "</span> + req.getScheme() + <span class="string">" "</span> + req.getRemoteAddr() + <span class="string">":"</span> + req.getRemotePort());</span><br><span class="line">        StringBuilder params = <span class="keyword">new</span> StringBuilder(<span class="string">"?"</span>);</span><br><span class="line">        <span class="comment">// 获取URL参数</span></span><br><span class="line">        Enumeration&lt;String&gt; names = req.getParameterNames();</span><br><span class="line">        <span class="keyword">if</span>( req.getMethod().equals(<span class="string">"GET"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">                String name = names.nextElement();</span><br><span class="line">                params.append(name);</span><br><span class="line">                params.append(<span class="string">"="</span>);</span><br><span class="line">                params.append(req.getParameter(name));</span><br><span class="line">                params.append(<span class="string">"$="</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(params.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            params.delete(params.length()-<span class="number">1</span>,params.length());</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"REQUEST:: &gt; "</span> + req.getMethod() + <span class="string">" "</span> + req.getRequestURI() + params + <span class="string">" "</span> + req.getProtocol());</span><br><span class="line">        Enumeration&lt;String&gt; headers = req.getHeaderNames();</span><br><span class="line">        <span class="keyword">while</span> (headers.hasMoreElements()) &#123;</span><br><span class="line">            String name = headers.nextElement();</span><br><span class="line">            String value = req.getHeader(name);</span><br><span class="line">            logger.info(<span class="string">"REQUEST:: &gt; "</span> + name + <span class="string">":"</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="comment">// 获取请求体参数</span></span><br><span class="line">        <span class="keyword">if</span> (!ctx.isChunkedRequestBody()) &#123;</span><br><span class="line">            ServletInputStream inp = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inp = ctx.getRequest().getInputStream();</span><br><span class="line">                String body = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(inp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 此处是Apache IOUtils</span></span><br><span class="line">                    body = IOUtils.toString(inp);</span><br><span class="line">                    logger.info(<span class="string">"REQUEST:: &gt; "</span> + body);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;日志输出如下所示。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010183.png" alt=""></p>
<p>&emsp;&emsp;然后是获取响应内容信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取响应消息</span></span><br><span class="line"><span class="comment">// 第一种方式</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Object zuulResponse = RequestContext.getCurrentContext().get(<span class="string">"zuulResponse"</span>);</span><br><span class="line">    <span class="keyword">if</span>(zuulResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RibbonHttpResponse rep = (RibbonHttpResponse) zuulResponse;</span><br><span class="line">        String body = IOUtils.toString(rep.getBody());</span><br><span class="line">        logger.info(<span class="string">"RESPONSE:: &gt; "</span> + body);</span><br><span class="line">        rep.close();</span><br><span class="line">        RequestContext.getCurrentContext().setResponseBody(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第二种方式</span></span><br><span class="line">InputStream stream = RequestContext.getCurrentContext().getResponseDataStream();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stream != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String body = IOUtils.toString(stream);</span><br><span class="line">        logger.info(<span class="string">"RESPONSE:: &gt; "</span> + body);</span><br><span class="line">        RequestContext.getCurrentContext().setResponseBody(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ex)&#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;启动服务并访问，输出如下日志。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010184.png" alt=""></p>
<p>&emsp;&emsp;源码RibbonRoutingFilter或SimpleHostRoutingFilter中，会在run()函数中调用forward方法，拿到响应结果，并通过setResponse方法进行响应的设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonRoutingFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;    </span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">        <span class="keyword">this</span>.helper.addIgnoredHeaders(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RibbonCommandContext commandContext = <span class="keyword">this</span>.buildCommandContext(context);</span><br><span class="line">            ClientHttpResponse response = <span class="keyword">this</span>.forward(commandContext);</span><br><span class="line">            <span class="keyword">this</span>.setResponse(response);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ZuulException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZuulRuntimeException(var4);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZuulRuntimeException(var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResponse</span><span class="params">(ClientHttpResponse resp)</span> <span class="keyword">throws</span> ClientException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 直接把响应内容加到RequestContext</span></span><br><span class="line">        RequestContext.getCurrentContext().set(<span class="string">"zuulResponse"</span>, resp);</span><br><span class="line">        <span class="keyword">this</span>.helper.setResponse(resp.getRawStatusCode(), resp.getBody() == <span class="keyword">null</span> ? <span class="keyword">null</span> : resp.getBody(), resp.getHeaders());</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleHostRoutingFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = context.getRequest();</span><br><span class="line">        MultiValueMap&lt;String, String&gt; headers = <span class="keyword">this</span>.helper.buildZuulRequestHeaders(request);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = <span class="keyword">this</span>.helper.buildZuulRequestQueryParams(request);</span><br><span class="line">        String verb = <span class="keyword">this</span>.getVerb(request);</span><br><span class="line">        InputStream requestEntity = <span class="keyword">this</span>.getRequestBody(request);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getContentLength(request) &lt; <span class="number">0L</span>) &#123;</span><br><span class="line">            context.setChunkedRequestBody();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String uri = <span class="keyword">this</span>.helper.buildZuulRequestURI(request);</span><br><span class="line">        <span class="keyword">this</span>.helper.addIgnoredHeaders(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CloseableHttpResponse response = <span class="keyword">this</span>.forward(<span class="keyword">this</span>.httpClient, verb, uri, request, headers, params, requestEntity);</span><br><span class="line">            <span class="keyword">this</span>.setResponse(response);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZuulRuntimeException(<span class="keyword">this</span>.handleException(var9));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResponse</span><span class="params">(HttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RequestContext.getCurrentContext().set(<span class="string">"zuulResponse"</span>, response);</span><br><span class="line">        <span class="keyword">this</span>.helper.setResponse(response.getStatusLine().getStatusCode(), response.getEntity() == <span class="keyword">null</span> ? <span class="keyword">null</span> : response.getEntity().getContent(), <span class="keyword">this</span>.revertHeaders(response.getAllHeaders()));</span><br><span class="line">    &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;第二种方式通过this.helper.setResponse设置响应内容，同样会把数据写入RequestContext。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyRequestHelper</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResponse</span><span class="params">(<span class="keyword">int</span> status, InputStream entity, MultiValueMap&lt;String, String&gt; headers)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">        context.setResponseStatusCode(status);</span><br><span class="line">        <span class="keyword">if</span> (entity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            context.setResponseDataStream(entity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isOriginResponseGzipped = <span class="keyword">false</span>;</span><br><span class="line">        Iterator var6 = headers.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, List&lt;String&gt;&gt; header = (Entry)var6.next();</span><br><span class="line">            String name = (String)header.getKey();</span><br><span class="line">            Iterator var9 = ((List)header.getValue()).iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">                String value = (String)var9.next();</span><br><span class="line">                context.addOriginResponseHeader(name, value);</span><br><span class="line">                <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">"Content-Encoding"</span>) &amp;&amp; HTTPRequestUtils.getInstance().isGzipped(value)) &#123;</span><br><span class="line">                    isOriginResponseGzipped = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (name.equalsIgnoreCase(<span class="string">"Content-Length"</span>)) &#123;</span><br><span class="line">                    context.setOriginContentLength(value);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isIncludedHeader(name)) &#123;</span><br><span class="line">                    context.addZuulResponseHeader(name, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.setResponseGZipped(isOriginResponseGzipped);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-5-Zuul自带的Debug功能"><a href="#6-5-Zuul自带的Debug功能" class="headerlink" title="6.5 Zuul自带的Debug功能"></a><strong>6.5 Zuul自带的Debug功能</strong></h3><p>&emsp;&emsp;Zuul中自带了一个DebugFilter，源码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DebugFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 开启此过滤器的两个参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicBooleanProperty ROUTING_DEBUG = DynamicPropertyFactory.getInstance().getBooleanProperty(<span class="string">"zuul.debug.request"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DynamicStringProperty DEBUG_PARAMETER = DynamicPropertyFactory.getInstance().getStringProperty(<span class="string">"zuul.debug.parameter"</span>, <span class="string">"debug"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DebugFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只要满足两个条件即可开启此过滤器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpServletRequest request = RequestContext.getCurrentContext().getRequest();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"true"</span>.equals(request.getParameter(DEBUG_PARAMETER.get())) ? <span class="keyword">true</span> : ROUTING_DEBUG.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        ctx.setDebugRouting(<span class="keyword">true</span>);</span><br><span class="line">        ctx.setDebugRequest(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;DynamicBooleanProperty是Netflix的配置管理框架Archaius提供的API，可以从配置中心获得配置，但由于Netflix没有开源Archaius的服务端，所以这边使用的是默认值debug。如果需要动态的获取这个值，可以用携程的Apollo来对接Archaius。</p>
<p>&emsp;&emsp;可以在请求地址追加debug=true来开启这个过滤器，参数名称debug也可以在配置文件中进行覆盖，用zuul.debug.parameter指定，否则就是从Archaius中获取，没有对接Archaius那就是默认值debug。</p>
<p>&emsp;&emsp;第二个条件可以通过zuul.debug.request来决定，可以在配置文件中配置zuul.debug.request=true开启DebugFilter过滤器。</p>
<p>&emsp;&emsp;观察如FilterProcessor会有以下代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterProcessor</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">runFilters</span><span class="params">(String sType)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 当debugRouting为true时，就会添加一些Debug信息到RequestContext中</span></span><br><span class="line">        <span class="keyword">if</span> (RequestContext.getCurrentContext().debugRouting()) &#123;</span><br><span class="line">            Debug.addRoutingDebug(<span class="string">"Invoking &#123;"</span> + sType + <span class="string">"&#125; type filters"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> bResult = <span class="keyword">false</span>;</span><br><span class="line">        List&lt;ZuulFilter&gt; list = FilterLoader.getInstance().getFiltersByType(sType);</span><br><span class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">                ZuulFilter zuulFilter = (ZuulFilter)list.get(i);</span><br><span class="line">                Object result = <span class="keyword">this</span>.processZuulFilter(zuulFilter);</span><br><span class="line">                <span class="keyword">if</span> (result != <span class="keyword">null</span> &amp;&amp; result <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">                    bResult |= (Boolean)result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bResult;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;SendResponseFilter中addResponseHeaders()函数会根据配置来决定是否将RequestContext中所存信息添加到响应头中返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendResponseFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addResponseHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestContext context = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletResponse servletResponse = context.getResponse();</span><br><span class="line">        List zuulResponseHeaders;</span><br><span class="line">        <span class="comment">// 判断配置文件中是否设置debug-header，满足时才会把RequestContext中所存信息添加到响应头中返回</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.zuulProperties.isIncludeDebugHeader()) &#123;</span><br><span class="line">            zuulResponseHeaders = (List)context.get(<span class="string">"routingDebug"</span>);</span><br><span class="line">            <span class="keyword">if</span> (zuulResponseHeaders != <span class="keyword">null</span>) &#123;</span><br><span class="line">                StringBuilder debugHeader = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                Iterator var5 = zuulResponseHeaders.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">                    String it = (String)var5.next();</span><br><span class="line">                    debugHeader.append(<span class="string">"[[["</span> + it + <span class="string">"]]]"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                servletResponse.addHeader(<span class="string">"X-Zuul-Debug-Header"</span>, debugHeader.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zuulResponseHeaders = context.getZuulResponseHeaders();</span><br><span class="line">        <span class="keyword">if</span> (zuulResponseHeaders != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Iterator var7 = zuulResponseHeaders.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var7.hasNext()) &#123;</span><br><span class="line">                Pair&lt;String, String&gt; it = (Pair)var7.next();</span><br><span class="line">                servletResponse.addHeader((String)it.first(), (String)it.second());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.includeContentLengthHeader(context)) &#123;</span><br><span class="line">            Long contentLength = context.getOriginContentLength();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.useServlet31) &#123;</span><br><span class="line">                servletResponse.setContentLengthLong(contentLength);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.isLongSafe(contentLength)) &#123;</span><br><span class="line">                servletResponse.setContentLength(contentLength.intValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;配置文件中添加如下配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zuul.debug.parameter=true</span><br><span class="line">zuul.debug.request=true</span><br><span class="line"># 开启将Zuul Debug信息添加到响应头</span><br><span class="line">zuul.include-debug-header=true</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;重启服务并访问，结果如下。</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010185.png" alt=""></p>
<hr>
<h2 id="第七节-Zuul高可用"><a href="#第七节-Zuul高可用" class="headerlink" title="第七节 Zuul高可用"></a><strong>第七节 Zuul高可用</strong></h2><p>&emsp;&emsp;跟业务相关的服务我们都是注册到Eureka中，通过Ribbon来进行负载均衡，服务可以通过水平扩展来实现高可用。现实使用中，API网关这层往往是给APP、Webapp、客户来调用接口的，如果我们将Zuul也注册到Eureka中是达不到高可用的，因为你不可能让你的客户也去操作你的注册中心。这是最好的办法就是用额外的负载均衡器来实现Zuul的高可用，比如我们最常用的Nginx，或者HAProxy、F5等。</p>
<p>&emsp;&emsp;这种方式也是单体项目最常用的负载方式，当用户请求一个地址的时候，通过Nginx去做转发，当一个服务挂掉的时候，Nginx会把它排除掉。</p>
<p>&emsp;&emsp;如果想要API网关也能随时水平扩展，那么我们可以用脚本来动态修改Nginx的配置，通过脚本操作Eureka，发现有新加入的网关服务或者下线的网关服务，直接修改Nginx的upstream，然后通过重载（reload）配置来达到网关的动态扩容。</p>
<p>&emsp;&emsp;如果不用脚本结合注册中心去做的话，就只能提前规划好N个节点，然后手动配置上去。</p>
<hr>
<p><em>参考博客和文章书籍等：</em></p>
<blockquote>
<p>《Spring Cloud微服务-入门、实战和进阶》</p>
</blockquote>
<p><em>因博客主等未标明不可引用，若部分内容涉及侵权请及时告知，我会尽快修改和删除相关内容</em></p>

      
    </div>
    
    
    

    

    

    

    
      <div>
         ﻿<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      </div>
    
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring-cloud/" rel="tag"># spring cloud</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019111301.html" rel="next" title="Spring Cloud-Hystrix 服务容错处理">
                <i class="fa fa-chevron-left"></i> Spring Cloud-Hystrix 服务容错处理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019111601.html" rel="prev" title="OAuth2协议框架">
                OAuth2协议框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
     <div class="comments" id="comments">
       

<script src="https://utteranc.es/client.js"
        repo="LAILAIWA/LAILAIWA.github.io"
        issue-term="pathname"
        label="💬Comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



     </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg"
                alt="Speciosity" />
            
              <p class="site-author-name" itemprop="name">Speciosity</p>
              <p class="site-description motion-element" itemprop="description">记录编程点滴，写点生活中的酸甜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">238</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/LAILAIWA" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:linyishui168@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/linyishui618" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/linyishui618" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5340162234" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo.com"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-Zuul-API网关"><span class="nav-number">1.</span> <span class="nav-text">Spring Cloud-Zuul API网关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一节-简介"><span class="nav-number">1.1.</span> <span class="nav-text">第一节 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-什么是API网关"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 什么是API网关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-API网关的作用"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 API网关的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Zuul"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Zuul</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二节-使用Zuul构建微服务网关"><span class="nav-number">1.2.</span> <span class="nav-text">第二节 使用Zuul构建微服务网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-简单使用"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 简单使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-集成Eureka"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 集成Eureka</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三节-Zuul路由配置"><span class="nav-number">1.3.</span> <span class="nav-text">第三节 Zuul路由配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-指定具体服务路由"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 指定具体服务路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-路由前缀"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 路由前缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-本地跳转"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 本地跳转</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四节-Zuul过滤器讲解"><span class="nav-number">1.4.</span> <span class="nav-text">第四节 Zuul过滤器讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-过滤器类型"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 过滤器类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-请求生命周期"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 请求生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-使用过滤器"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.3 使用过滤器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-禁用过滤器"><span class="nav-number">1.4.4.</span> <span class="nav-text">4.4 禁用过滤器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-过滤器中传递数据"><span class="nav-number">1.4.5.</span> <span class="nav-text">4.5 过滤器中传递数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-过滤器拦截请求"><span class="nav-number">1.4.6.</span> <span class="nav-text">4.6 过滤器拦截请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-过滤器中异常处理"><span class="nav-number">1.4.7.</span> <span class="nav-text">4.7 过滤器中异常处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第五节-Zuul容错和回退"><span class="nav-number">1.5.</span> <span class="nav-text">第五节 Zuul容错和回退</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-容错机制"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 容错机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-回退机制"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 回退机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第六节-Zuul使用小经验"><span class="nav-number">1.6.</span> <span class="nav-text">第六节 Zuul使用小经验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-routes端点"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 /routes端点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-filters端点"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 /filters端点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-文件上传"><span class="nav-number">1.6.3.</span> <span class="nav-text">6.3 文件上传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-请求响应信息输出"><span class="nav-number">1.6.4.</span> <span class="nav-text">6.4 请求响应信息输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-Zuul自带的Debug功能"><span class="nav-number">1.6.5.</span> <span class="nav-text">6.5 Zuul自带的Debug功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第七节-Zuul高可用"><span class="nav-number">1.7.</span> <span class="nav-text">第七节 Zuul高可用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Speciosity</span>

  
</div>

<div class="powered-by">
  <i class="fa fa-user-md">
  </i>
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
</div>

<!-- 

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
   <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":true,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":125,"height":250},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script>

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
