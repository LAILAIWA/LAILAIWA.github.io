<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad%20playstation.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig%20Dug.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad%20playstation.png">
  <link rel="mask-icon" href="/images/gamepad%20playstation.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"linyishui.top","root":"/","images":"/images","scheme":"Pisces","version":"8.6.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="Oracle和MySql常用功能和指令笔记。">
<meta property="og:type" content="article">
<meta property="og:title" content="Oralce和MySql笔记（持续更新）">
<meta property="og:url" content="http://linyishui.top/2020021801.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="Oracle和MySql常用功能和指令笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010122.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010123.png">
<meta property="article:published_time" content="2020-02-18T03:15:41.000Z">
<meta property="article:modified_time" content="2022-04-07T07:06:16.000Z">
<meta property="article:author" content="Lys">
<meta property="article:tag" content="updating">
<meta property="article:tag" content="sql">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="oracle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010122.png">


<link rel="canonical" href="http://linyishui.top/2020021801.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://linyishui.top/2020021801.html","path":"2020021801.html","title":"Oralce和MySql笔记（持续更新）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Oralce和MySql笔记（持续更新） | 俺的部落格</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">俺的部落格</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">俺寻思俺需要记点东西</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
        <li class="menu-item menu-item-tools"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>工具</a></li>
        <li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书架</a></li>
        <li class="menu-item menu-item-movies"><a href="/movies/" rel="section"><i class="fa fa-video fa-fw"></i>剧院</a></li>
        <li class="menu-item menu-item-games"><a href="/games/" rel="section"><i class="fa fa-gamepad fa-fw"></i>游戏</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Oralce%E5%92%8CMySql%E7%AC%94%E8%AE%B0"><span class="nav-text">Oralce和MySql笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E5%B8%B8%E7%94%A8SQL"><span class="nav-text">一. 常用SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Oracle"><span class="nav-text">1.1 Oracle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="nav-text">（1）表空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-text">（2）表结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-text">（3）性能问题排查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%85%B6%E4%BB%96"><span class="nav-text">（4）其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-MySQL"><span class="nav-text">1.2 MySQL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="nav-text">二. 执行脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Oracle%E8%A1%A8%E7%BB%93%E6%9E%84%E8%B0%83%E6%95%B4"><span class="nav-text">2.1 Oracle表结构调整</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%AD%97%E6%AE%B5%E8%B0%83%E6%95%B4"><span class="nav-text">（1）字段调整</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%B4%A2%E5%BC%95%E8%B0%83%E6%95%B4"><span class="nav-text">（2）索引调整</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E8%A1%A8%E8%B0%83%E6%95%B4"><span class="nav-text">（3）表调整</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-MySQL%E8%A1%A8%E7%BB%93%E6%9E%84%E8%B0%83%E6%95%B4"><span class="nav-text">2.2 MySQL表结构调整</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%AD%97%E6%AE%B5%E8%B0%83%E6%95%B4-1"><span class="nav-text">（1）字段调整</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%B4%A2%E5%BC%95%E8%B0%83%E6%95%B4-1"><span class="nav-text">（2）索引调整</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E8%A1%A8%E8%B0%83%E6%95%B4%EF%BC%9A"><span class="nav-text">（3）表调整：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="nav-text">三. 常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">3.1 常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD"><span class="nav-text">3.1 数据库定时备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Oracle%E6%9F%A5%E7%9C%8B%E4%B8%B4%E6%97%B6%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="nav-text">3.2 Oracle查看临时表空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Oracle%E7%94%9F%E6%88%90AWR%E6%8A%A5%E5%91%8A"><span class="nav-text">3.3 Oracle生成AWR报告</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Oracle%E6%9F%A5%E7%9C%8B%E4%B8%B4%E6%97%B6%E8%A1%A8"><span class="nav-text">3.4 Oracle查看临时表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Oracle%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">3.5 Oracle内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">（1）自动内存管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%87%AA%E5%8A%A8%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">（2）自动共享内存管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%89%8B%E5%8A%A8%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">（3）手动共享内存管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89PGA%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">（4）PGA内存管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E6%89%8B%E5%8A%A8SqlLoder"><span class="nav-text">3.6 手动SqlLoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-MySQL%E5%8D%87%E7%BA%A7%E7%89%88%E6%9C%AC"><span class="nav-text">3.7 MySQL升级版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AE%B0%E5%BD%95"><span class="nav-text">四. 知识点记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89MySQL%E4%B8%AD%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E%E6%95%B0%E5%80%BC%E6%AF%94%E8%BE%83-%E5%B0%8F%E5%BF%83%E9%9A%90%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="nav-text">（1）MySQL中字符串与数值比较-小心隐式转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98"><span class="nav-text">（2）死锁问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E5%A4%A7%E6%89%B9%E9%87%8F%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-text">（3）生成大批量测试数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%B1%82%E7%B4%AF%E8%AE%A1%E9%87%91%E9%A2%9D"><span class="nav-text">（4）求累计金额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%E8%AE%BE%E5%AE%9A%E5%A4%A7%E5%B0%8F"><span class="nav-text">（5）数据库连接池设定大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Oracle-v-sql-%E8%A7%86%E5%9B%BE"><span class="nav-text">（6）Oracle v$sql 视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89%E5%88%A4%E6%96%AD%E4%B8%A4%E4%B8%AA%E6%97%B6%E9%97%B4%E6%AE%B5%E6%9C%89%E4%BA%A4%E9%9B%86"><span class="nav-text">（7）判断两个时间段有交集</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lys"
      src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG">
  <p class="site-author-name" itemprop="name">Lys</p>
  <div class="site-description" itemprop="description">记录编程点滴，写点生活中的酸甜</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">331</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">110</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/LAILAIWA" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LAILAIWA" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:linyishui168@outlook.com" title="E-Mail → mailto:linyishui168@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5340162234" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5340162234" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/linyishui618" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;linyishui618" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/13018339/lin-yishui" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;13018339&#x2F;lin-yishui" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/linyishui618" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;linyishui618" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="far fa-smile-wink fa-fw"></i>
      个人
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://music.163.com/#/user/home?id=68425607" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;68425607" rel="noopener" target="_blank">网易云音乐</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/LAILAIWA" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2020021801.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG">
      <meta itemprop="name" content="Lys">
      <meta itemprop="description" content="记录编程点滴，写点生活中的酸甜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Oralce和MySql笔记（持续更新）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-18 11:15:41" itemprop="dateCreated datePublished" datetime="2020-02-18T11:15:41+08:00">2020-02-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-07 15:06:16" itemprop="dateModified" datetime="2022-04-07T15:06:16+08:00">2022-04-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">开发工具</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

            <div class="post-description">Oracle和MySql常用功能和指令笔记。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Oralce和MySql笔记"><a href="#Oralce和MySql笔记" class="headerlink" title="Oralce和MySql笔记"></a>Oralce和MySql笔记</h1><h2 id="一-常用SQL"><a href="#一-常用SQL" class="headerlink" title="一. 常用SQL"></a>一. 常用SQL</h2><h3 id="1-1-Oracle"><a href="#1-1-Oracle" class="headerlink" title="1.1 Oracle"></a>1.1 Oracle</h3><h4 id="（1）表空间"><a href="#（1）表空间" class="headerlink" title="（1）表空间"></a>（1）表空间</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看表和索引所占空间大小</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> user_segments </span><br><span class="line"><span class="keyword">where</span> segment_type <span class="keyword">in</span> (<span class="string">&#x27;TABLE&#x27;</span> ,<span class="string">&#x27;INDEX&#x27;</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> bytes <span class="keyword">desc</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询索引空间信息</span></span><br><span class="line"><span class="keyword">select</span> s.index_name, s.table_name, s.tablespace_name,</span><br><span class="line">       s.initial_extent, s.next_extent</span><br><span class="line"><span class="keyword">from</span> user_indexes s</span><br><span class="line"><span class="keyword">where</span> s.index_name <span class="operator">=</span> <span class="string">&#x27;PK_XX_XX&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> user_tables;</span><br><span class="line"><span class="comment">-- 查询表空间和用户</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dba_tables <span class="keyword">where</span> owner<span class="operator">=</span><span class="string">&#x27;XX_XX&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dba_tables <span class="keyword">where</span> tablespace_name<span class="operator">=</span><span class="string">&#x27;XX_XX&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> owner;</span><br><span class="line"><span class="comment">-- 查询指定表空间信息</span></span><br><span class="line"><span class="keyword">select</span> file_name,tablespace_name,bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>,autoextensible <span class="keyword">from</span> dba_data_files <span class="keyword">where</span> tablespace_name<span class="operator">=</span><span class="string">&#x27;TB_XXX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询剩余空间</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>) sizeMB <span class="keyword">from</span> dba_free_space z <span class="keyword">where</span> z.tablespace_name<span class="operator">=</span><span class="string">&#x27;TB_XXX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 扩容</span></span><br><span class="line"><span class="keyword">alter</span> database datafile <span class="string">&#x27;/home/oracle/database/oradata/XXXX.dbf&#x27;</span> resize <span class="number">500</span>M;</span><br><span class="line"><span class="comment">-- 开启自动扩容</span></span><br><span class="line"><span class="keyword">alter</span> database datafile <span class="string">&#x27;/u01/app/oracle/12c/dbs/XX_XX.dbf&#x27;</span> autoextend <span class="keyword">on</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> temp_used.tablespace_name, total <span class="operator">-</span> used <span class="keyword">as</span> &quot;Free&quot;, total <span class="keyword">as</span> &quot;Total&quot;, round(nvl(total <span class="operator">-</span> used, <span class="number">0</span>) <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> total, <span class="number">3</span>) &quot;Free percent&quot;</span><br><span class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> tablespace_name, <span class="built_in">SUM</span>(bytes_used)<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span> used <span class="keyword">FROM</span> V$TEMP_SPACE_HEADER <span class="keyword">GROUP</span> <span class="keyword">BY</span> tablespace_name) temp_used,</span><br><span class="line">       (<span class="keyword">SELECT</span> tablespace_name, <span class="built_in">SUM</span>(bytes)<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span> total <span class="keyword">FROM</span> dba_temp_files <span class="keyword">GROUP</span> <span class="keyword">BY</span> tablespace_name) temp_total</span><br><span class="line"><span class="keyword">WHERE</span> temp_used.tablespace_name <span class="operator">=</span> temp_total.tablespace_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> h.tablespace_name tablespace_name,f.autoextensible,</span><br><span class="line">               round(<span class="built_in">sum</span>(nvl(p.bytes_used, <span class="number">0</span>)) <span class="operator">/</span> <span class="built_in">power</span>(<span class="number">2</span>, <span class="number">30</span>), <span class="number">2</span>) used_gb,</span><br><span class="line">               round(<span class="built_in">sum</span>(decode(f.autoextensible, <span class="string">&#x27;YES&#x27;</span>,  f.maxbytes, <span class="string">&#x27;NO&#x27;</span>, f.bytes)) <span class="operator">/</span> <span class="built_in">power</span>(<span class="number">2</span>, <span class="number">30</span>), <span class="number">2</span>) max_gb</span><br><span class="line">          <span class="keyword">from</span> gv$temp_space_header h, gv$temp_extent_pool p, dba_temp_files f</span><br><span class="line">         <span class="keyword">where</span> p.file_id(<span class="operator">+</span>) <span class="operator">=</span> h.file_id</span><br><span class="line">           <span class="keyword">and</span> p.tablespace_name(<span class="operator">+</span>) <span class="operator">=</span> h.tablespace_name</span><br><span class="line">           <span class="keyword">and</span> f.file_id <span class="operator">=</span> h.file_id</span><br><span class="line">           <span class="keyword">and</span> f.tablespace_name <span class="operator">=</span> h.tablespace_name</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> h.tablespace_name,f.autoextensible;</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">				 <span class="keyword">SELECT</span> D.TABLESPACE_NAME,SPACE &quot;SUM_SPACE(M)&quot;,BLOCKS SUM_BLOCKS, </span><br><span class="line">USED_SPACE &quot;USED_SPACE(M)&quot;,ROUND(NVL(USED_SPACE,<span class="number">0</span>)<span class="operator">/</span>SPACE<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>) &quot;USED_RATE(%)&quot;,</span><br><span class="line">NVL(FREE_SPACE,<span class="number">0</span>) &quot;FREE_SPACE(M)&quot;</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> TABLESPACE_NAME,ROUND(<span class="built_in">SUM</span>(BYTES)<span class="operator">/</span>(<span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>),<span class="number">2</span>) SPACE,<span class="built_in">SUM</span>(BLOCKS) BLOCKS</span><br><span class="line"><span class="keyword">FROM</span> DBA_TEMP_FILES</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) D,</span><br><span class="line">(<span class="keyword">SELECT</span> TABLESPACE_NAME,ROUND(<span class="built_in">SUM</span>(BYTES_USED)<span class="operator">/</span>(<span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>),<span class="number">2</span>) USED_SPACE,</span><br><span class="line">ROUND(<span class="built_in">SUM</span>(BYTES_FREE)<span class="operator">/</span>(<span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>),<span class="number">2</span>) FREE_SPACE</span><br><span class="line"><span class="keyword">FROM</span> V$TEMP_SPACE_HEADER</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) F</span><br><span class="line"><span class="keyword">WHERE</span>  D.TABLESPACE_NAME <span class="operator">=</span> F.TABLESPACE_NAME(<span class="operator">+</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">A.TABLESPACE_NAME, </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span>  ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;允许最大值&quot;,</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span>  ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;历史峰值&quot;, </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span> </span><br><span class="line">ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;已使用&quot;,   </span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.BYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/历史峰值&quot;,   </span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.MAXBYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/允许最大值&quot; </span><br><span class="line"> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> F.TABLESPACE_NAME, <span class="built_in">SUM</span>(F.BYTES) BYTES,<span class="built_in">SUM</span>(F.MAXBYTES) MAXBYTES  <span class="keyword">FROM</span> DBA_TEMP_FILES F   <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) A,</span><br><span class="line"> (<span class="keyword">SELECT</span> P.TABLESPACE_NAME, <span class="built_in">SUM</span>(P.BYTES_CACHED) BYTES_CACHED,<span class="built_in">SUM</span>(P.BYTES_USED) BYTES_USED  <span class="keyword">FROM</span> V$TEMP_EXTENT_POOL P  <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME  ) B</span><br><span class="line"> <span class="keyword">WHERE</span> A.TABLESPACE_NAME <span class="operator">=</span> B.TABLESPACE_NAME;</span><br></pre></td></tr></table></figure>



<h4 id="（2）表结构"><a href="#（2）表结构" class="headerlink" title="（2）表结构"></a>（2）表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-----------------------------------------表结构-----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> all_tab_comments <span class="keyword">where</span> table_name <span class="operator">=</span> <span class="string">&#x27;XXX&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> user_tab_columns <span class="keyword">where</span> table_name <span class="operator">=</span> <span class="string">&#x27;XX_XX_XX&#x27;</span> <span class="keyword">AND</span> COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- user_tab_cols 包含oracle创建的隐藏字段</span></span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">FROM</span> user_tab_cols <span class="keyword">where</span> table_name <span class="operator">=</span> <span class="built_in">upper</span>(<span class="string">&#x27;表名&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> TABLE_NAME,COLUMN_NAME,DATA_TYPE,DATA_LENGTH </span><br><span class="line"><span class="keyword">from</span> user_tab_columns </span><br><span class="line"><span class="keyword">where</span> COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> DATA_LENGTH,TABLE_NAME,COLUMN_NAME,DATA_TYPE</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看视图构造SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> DBMS_METADATA.GET_DDL(<span class="string">&#x27;VIEW&#x27;</span>,<span class="string">&#x27;VIEW_NAME&#x27;</span>,<span class="string">&#x27;USER&#x27;</span>) <span class="keyword">FROM</span> DUAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------索引-----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询表所创建索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> user_indexes <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;XX_XX_XX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询索引字段</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> user_ind_columns <span class="keyword">where</span> index_name<span class="operator">=</span><span class="built_in">upper</span>(<span class="string">&#x27;pk_XX_XX&#x27;</span>);</span><br><span class="line"><span class="comment">-- 查询表约束，包括字段</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> user_cons_columns <span class="keyword">where</span> table_name <span class="operator">=</span> <span class="string">&#x27;XX_XX_XX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询表约束</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_constraints <span class="keyword">WHERE</span> table_name<span class="operator">=</span><span class="string">&#x27;XX_XX_XX&#x27;</span> <span class="keyword">AND</span> constraint_name <span class="operator">=</span> <span class="string">&#x27;PK_XX_XX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询视图状态</span></span><br><span class="line"><span class="keyword">select</span> status <span class="keyword">from</span> user_objects <span class="keyword">where</span> object_name <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查询包含字段的表</span></span><br><span class="line"><span class="keyword">select</span> table_name, data_length <span class="keyword">from</span> user_tab_columns <span class="keyword">where</span> column_name <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定表名的索引结构</span></span><br><span class="line"><span class="keyword">select</span> uic.TABLE_NAME,uic.INDEX_NAME,uic.COLUMN_NAME,uic.COLUMN_POSITION </span><br><span class="line"><span class="keyword">from</span> user_ind_columns uic</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> user_indexes ui</span><br><span class="line"><span class="keyword">ON</span> uic.INDEX_NAME <span class="operator">=</span> ui.INDEX_NAME</span><br><span class="line"><span class="keyword">where</span> ui.table_name <span class="keyword">IN</span>(<span class="string">&#x27;XX_XX_XX&#x27;</span>,<span class="string">&#x27;XX_XX_XX&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> uic.TABLE_NAME,uic.INDEX_NAME,uic.COLUMN_POSITION;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（3）性能问题排查"><a href="#（3）性能问题排查" class="headerlink" title="（3）性能问题排查"></a>（3）性能问题排查</h4><p>会话信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看活跃会话信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> V$SESSION <span class="keyword">WHERE</span> USERNAME <span class="operator">=</span> <span class="string">&#x27;XXX&#x27;</span> <span class="keyword">AND</span> STATUS <span class="operator">=</span> <span class="string">&#x27;ACTIVE&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> OSUSER,SCHEMANAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> SID,EVENT,STATE,WAIT_TIME_MICRO,PREV_SQL_ID,OSUSER <span class="keyword">FROM</span> gv$session <span class="keyword">where</span> status <span class="operator">=</span> <span class="string">&#x27;ACTIVE&#x27;</span> <span class="keyword">AND</span> OSUSER <span class="operator">=</span> <span class="string">&#x27;xxxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> SID,EVENT,STATE,WAIT_TIME_MICRO,PREV_SQL_ID,USERNAME,OSUSER </span><br><span class="line"><span class="keyword">FROM</span> gv$session <span class="keyword">where</span> status <span class="operator">=</span> <span class="string">&#x27;ACTIVE&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> USERNAME,OSUSER,EVENT; </span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> SID,blocking_session <span class="keyword">FROM</span> V$SESSION <span class="keyword">WHERE</span> blocking_session <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看阻塞SQL</span></span><br><span class="line"><span class="keyword">select</span> s.inst_id <span class="keyword">as</span> inst,</span><br><span class="line">       s.sid <span class="keyword">as</span> blocked_sid,</span><br><span class="line">       s.username <span class="keyword">as</span> blocked_user,</span><br><span class="line">       sa.sql_id <span class="keyword">as</span> blocked_sql_id,</span><br><span class="line">       trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>) <span class="keyword">as</span> blocking_sid,</span><br><span class="line">       b.username <span class="keyword">as</span> blocking_user,</span><br><span class="line">       b.sql_id <span class="keyword">as</span> blocking_sql_id</span><br><span class="line"><span class="keyword">from</span> gv$session s</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa</span><br><span class="line">  <span class="keyword">on</span> sa.hash_value <span class="operator">=</span> s.p1</span><br><span class="line"><span class="keyword">join</span> gv$session b</span><br><span class="line">  <span class="keyword">on</span> trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>)<span class="operator">=</span>b.sid</span><br><span class="line"> <span class="keyword">and</span> s.inst_id<span class="operator">=</span>b.inst_id</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa2</span><br><span class="line">  <span class="keyword">on</span> b.sql_id<span class="operator">=</span>sa2.sql_id</span><br><span class="line"><span class="keyword">where</span> s.event <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> s.event <span class="operator">&lt;&gt;</span> <span class="string">&#x27;&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>等待事件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询等待的事件</span></span><br><span class="line"><span class="keyword">select</span> inst_id,event,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> gv$session_wait</span><br><span class="line"><span class="keyword">where</span> wait_class <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;Idle&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> inst_id, event <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span> <span class="keyword">desc</span>;</span><br><span class="line"><span class="comment">-- 查询等待事件在执行的SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> b.inst_id,b.sid oracleID,</span><br><span class="line">       b.username 登录Oracle用户名,</span><br><span class="line">       b.serial#,</span><br><span class="line">       spid 操作系统ID,</span><br><span class="line">       paddr,</span><br><span class="line">       sql_text 正在执行的<span class="keyword">SQL</span>,</span><br><span class="line">       sql_fulltext,</span><br><span class="line">       b.machine 计算机名,</span><br><span class="line">       b.EVENT,</span><br><span class="line">       c.SQL_ID,</span><br><span class="line">       c.CHILD_NUMBER</span><br><span class="line"><span class="keyword">FROM</span> gv$process a, gv$session b, gv$<span class="keyword">sql</span> c</span><br><span class="line"><span class="keyword">WHERE</span> a.addr <span class="operator">=</span> b.paddr</span><br><span class="line">   <span class="keyword">AND</span> b.sql_hash_value <span class="operator">=</span> c.hash_value</span><br><span class="line"><span class="keyword">and</span> event <span class="keyword">like</span> <span class="string">&#x27;%pin S wait on X%&#x27;</span></span><br><span class="line">   <span class="keyword">and</span> a.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> b.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> c.inst_id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定等待事件信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> DBA_HIST_ACTIVE_SESS_HISTORY <span class="keyword">where</span> event <span class="keyword">LIKE</span> <span class="string">&#x27;%mutex%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session_wait <span class="keyword">where</span> event <span class="keyword">LIKE</span> <span class="string">&#x27;%mutex%&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>死锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-----------------------------------------------</span></span><br><span class="line"><span class="comment">-- 查看死锁是否存在</span></span><br><span class="line"><span class="keyword">select</span> username,lockwait,status,machine,program,sid <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看死锁的语句</span></span><br><span class="line"><span class="keyword">select</span> sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> <span class="keyword">where</span> hash_value <span class="keyword">in</span> </span><br><span class="line">(<span class="keyword">select</span> sql_hash_value <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看trace文件日志路径</span></span><br><span class="line"> <span class="keyword">select</span> tracefile <span class="keyword">from</span> v$process <span class="keyword">where</span> addr <span class="keyword">in</span> (<span class="keyword">select</span> paddr <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span> (<span class="keyword">select</span> sid <span class="keyword">from</span> v$mystat));</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 查找死锁的进程：</span></span><br><span class="line">sqlplus &quot;/as sysdba&quot; (sys<span class="operator">/</span>change_on_install)</span><br><span class="line"><span class="keyword">SELECT</span> s.username,l.OBJECT_ID,l.SESSION_ID,s.SERIAL#,</span><br><span class="line">l.ORACLE_USERNAME,l.OS_USER_NAME,l.PROCESS </span><br><span class="line"><span class="keyword">FROM</span> V$LOCKED_OBJECT l,V$SESSION S <span class="keyword">WHERE</span> l.SESSION_ID<span class="operator">=</span>S.SID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> sid,type,id1,id2 ,lmode,request,block <span class="keyword">from</span> v$lock <span class="keyword">where</span> type<span class="operator">=</span><span class="string">&#x27;TX&#x27;</span>;</span><br></pre></td></tr></table></figure>



<p>执行计划：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--执行计划</span></span><br><span class="line">EXPLAIN PLAN <span class="keyword">FOR</span> <span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ....;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>(dbms_xplan.display);</span><br><span class="line"></span><br><span class="line"><span class="comment">--根据SQL_ID查看真实执行计划</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>(dbms_xplan.display_cursor(<span class="string">&#x27;7ac05552jb0v9&#x27;</span>,<span class="number">0</span>));</span><br></pre></td></tr></table></figure>



<p>SQL排查，包括硬解析，High Version Count，绑定变量等</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据SQL_ID或SQL内容查看SQL信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> v$<span class="keyword">sql</span> t <span class="keyword">where</span> t.SQL_ID <span class="operator">=</span> <span class="string">&#x27;4r8184hs1fjsk&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v$sql_shared_cursor c <span class="keyword">where</span> c.sql_id <span class="operator">=</span> <span class="string">&#x27;4r8184hs1fjsk&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> v$<span class="keyword">sql</span> t <span class="keyword">where</span> t.sql_text <span class="keyword">like</span> <span class="string">&#x27;%XXX%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> sql_text, hash_value,address <span class="keyword">from</span> v$sqlarea  <span class="keyword">where</span> sql_id<span class="operator">=</span><span class="string">&#x27;d4rra0417m4hz&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> sql_text, hash_value,address <span class="keyword">from</span> v$sqlarea </span><br><span class="line"><span class="keyword">where</span> sql_text <span class="keyword">like</span> <span class="string">&#x27;%SELECT XXX FROM XXX%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看SQL对应子游标个数，为Y的字段表示为何不能共享，如bind_equiv_failure表示绑定变量字段类型与实际不匹配</span></span><br><span class="line"><span class="comment">-- ROLL_INVALID_MISMATCH则与dbms_stats的no_invalidate参数有关，一般大批量sql出现这种情况一般是因为自动收集统计信息导致的。</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sql_shared_cursor <span class="keyword">where</span> address <span class="operator">=</span> <span class="string">&#x27;00000000AEC7BB48&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sql_shared_cursor <span class="keyword">where</span> sql_id<span class="operator">=</span><span class="string">&#x27;d4rra0417m4hz&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看SQL的绑定变量</span></span><br><span class="line"><span class="keyword">select</span> c.sql_id,c.sql_type_mismatch,c.bind_equiv_failure,b.position,b.datatype_string,b.last_captured</span><br><span class="line"><span class="keyword">from</span> v$sql_bind_capture b,v$sql_shared_cursor c</span><br><span class="line"><span class="keyword">where</span> c.sql_id<span class="operator">=</span><span class="string">&#x27;8tw2skzjj73k5&#x27;</span></span><br><span class="line"><span class="keyword">and</span> c.child_address<span class="operator">=</span>b.child_address;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- bind_equiv_failure = &#x27;Y&#x27;的SQL_ID集合</span></span><br><span class="line"><span class="keyword">SELECT</span> sql_id <span class="keyword">FROM</span> (</span><br><span class="line"><span class="keyword">select</span> c.sql_id,c.sql_type_mismatch,c.bind_equiv_failure,b.position,b.datatype_string,b.last_captured</span><br><span class="line"><span class="keyword">from</span> v$sql_bind_capture b,v$sql_shared_cursor c</span><br><span class="line"><span class="keyword">where</span> c.bind_equiv_failure <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span></span><br><span class="line"><span class="keyword">and</span> c.child_address<span class="operator">=</span>b.child_address) TEMP</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sql_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看VERSION_COUNT比较高的SQL信息</span></span><br><span class="line"><span class="keyword">SELECT</span> S.SQL_ID, S.SQL_FULLTEXT,S.VERSION_COUNT ,S.LAST_LOAD_TIME <span class="keyword">FROM</span> v$sqlarea S <span class="keyword">ORDER</span> <span class="keyword">BY</span> S.VERSION_COUNT <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询SQL是否对绑定敏感，是否能根据不同绑定变量值选择执行计划</span></span><br><span class="line"><span class="keyword">select</span> SQL_ID,SQL_TEXT,IS_BIND_SENSITIVE,IS_BIND_AWARE,is_shareable <span class="keyword">from</span> v$<span class="keyword">sql</span> <span class="keyword">where</span> sql_id<span class="operator">=</span><span class="string">&#x27;7ac05552jb0v9&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="（4）其他"><a href="#（4）其他" class="headerlink" title="（4）其他"></a>（4）其他</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 绑定变量敏感等，与ACS相关参数</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$<span class="keyword">parameter</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$parameter2 <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%binds%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$system_parameter <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%binds%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$system_parameter2 <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%binds%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$spparameter <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%binds%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看ACS相关配置</span></span><br><span class="line"><span class="keyword">select</span> name, <span class="keyword">value</span> <span class="keyword">from</span> v$<span class="keyword">parameter</span> <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;optimizer_mode&#x27;</span>, <span class="string">&#x27;optimizer_features_enable&#x27;</span>, <span class="string">&#x27;optimizer_capture_sql_plan_baselines&#x27;</span>, <span class="string">&#x27;cursor_sharing&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需要用SYS</span></span><br><span class="line"><span class="keyword">select</span> a.ksppinm name, </span><br><span class="line">       b.ksppstvl <span class="keyword">value</span>,</span><br><span class="line">      b.ksppstdf  isdefault</span><br><span class="line"><span class="keyword">from</span> sys.x$ksppi a, sys.x$ksppcv b</span><br><span class="line"><span class="keyword">where</span> a.inst_id <span class="operator">=</span> userenv(<span class="string">&#x27;Instance&#x27;</span>) </span><br><span class="line">  <span class="keyword">and</span> b.inst_id <span class="operator">=</span> userenv(<span class="string">&#x27;Instance&#x27;</span>) </span><br><span class="line">  <span class="keyword">and</span> a.indx <span class="operator">=</span> b.indx </span><br><span class="line">  <span class="keyword">and</span> a.ksppinm <span class="keyword">in</span> (<span class="string">&#x27;_optim_peek_user_binds&#x27;</span>, <span class="string">&#x27;_optimizer_adaptive_cursor_sharing&#x27;</span>, <span class="string">&#x27;_optimizer_extended_cursor_sharing&#x27;</span>, <span class="string">&#x27;_optimizer_extended_cursor_sharing_rel&#x27;</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">translate</span>(a.ksppinm, <span class="string">&#x27; _&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="comment">-- _optimizer_adaptive_cursor_sharing=TRUE：</span></span><br><span class="line"><span class="comment">-- _optimizer_extended_cursor_sharing=UDO；</span></span><br><span class="line"><span class="comment">-- _optimizer_extended_cursor_sharing_rel=SIMPLE；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清除缓存</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> FLUSH SHARED_POOL;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> FLUSH BUFFER_CACHE;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> FLUSH <span class="keyword">GLOBAL</span> CONTEXT;</span><br><span class="line"><span class="keyword">exec</span> DBMS_SHARED_POOL.PURGE (<span class="string">&#x27;000000085FD77CF0, 808321886&#x27;</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> nls_database_parameters;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> nls_session_parameters;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> nls_instance_parameters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> nls_language<span class="operator">=</span><span class="string">&#x27;AMERICAN&#x27;</span> <span class="keyword">scope</span><span class="operator">=</span>spfile; </span><br><span class="line"><span class="keyword">alter</span> session <span class="keyword">set</span> nls_language<span class="operator">=</span><span class="string">&#x27;AMERICAN&#x27;</span>;</span><br><span class="line"><span class="keyword">alter</span> session <span class="keyword">set</span> nls_territory<span class="operator">=</span><span class="string">&#x27;AMERICA&#x27;</span>;</span><br></pre></td></tr></table></figure>





<h3 id="1-2-MySQL"><a href="#1-2-MySQL" class="headerlink" title="1.2 MySQL"></a>1.2 MySQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--------------------------------系统--------------------------------</span></span><br><span class="line"><span class="comment">-- 显式系统状态</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据库隔离级别</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@global</span>.tx_isolation,@<span class="variable">@tx</span>_isolation;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询是否锁表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">open</span> tables <span class="keyword">where</span> in_use<span class="operator">&gt;</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看innodb状态，打印死锁日志</span></span><br><span class="line"><span class="keyword">show</span> engine innodb status</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看线程列表</span></span><br><span class="line"><span class="keyword">show</span> PROCESSLIST</span><br><span class="line"><span class="comment">-- 错误日志</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@log</span>_error;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询正在执行的事务：</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX</span><br><span class="line"><span class="comment">-- 查看正在锁的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS; </span><br><span class="line"><span class="comment">-- 查看等待锁的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;AUTOCOMMIT&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;version&#x27;</span></span><br><span class="line"><span class="comment">--------------------------------表结构--------------------------------</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> COLUMNS <span class="keyword">FROM</span> XX_XX_XX;</span><br><span class="line"><span class="keyword">DESC</span> XX_XX_XX;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    TABLE_SCHEMA <span class="keyword">AS</span> <span class="string">&#x27;库名&#x27;</span>,</span><br><span class="line">    TABLE_NAME <span class="keyword">AS</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">    COLUMN_NAME <span class="keyword">AS</span> <span class="string">&#x27;列名&#x27;</span>,</span><br><span class="line">    ORDINAL_POSITION <span class="keyword">AS</span> <span class="string">&#x27;列的排列顺序&#x27;</span>,</span><br><span class="line">    COLUMN_DEFAULT <span class="keyword">AS</span> <span class="string">&#x27;默认值&#x27;</span>,</span><br><span class="line">    IS_NULLABLE <span class="keyword">AS</span> <span class="string">&#x27;是否为空&#x27;</span>,</span><br><span class="line">    DATA_TYPE <span class="keyword">AS</span> <span class="string">&#x27;数据类型&#x27;</span>,</span><br><span class="line">    CHARACTER_MAXIMUM_LENGTH <span class="keyword">AS</span> <span class="string">&#x27;字符最大长度&#x27;</span>,</span><br><span class="line">    NUMERIC_PRECISION <span class="keyword">AS</span> <span class="string">&#x27;数值精度(最大位数)&#x27;</span>,</span><br><span class="line">    NUMERIC_SCALE <span class="keyword">AS</span> <span class="string">&#x27;小数精度&#x27;</span>,</span><br><span class="line">    COLUMN_TYPE <span class="keyword">AS</span> 列类型,</span><br><span class="line">    COLUMN_KEY <span class="string">&#x27;KEY&#x27;</span>,</span><br><span class="line">    EXTRA <span class="keyword">AS</span> <span class="string">&#x27;额外说明&#x27;</span>,</span><br><span class="line">    COLUMN_COMMENT <span class="keyword">AS</span> <span class="string">&#x27;注释&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    information_schema.`COLUMNS`</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span> <span class="keyword">and</span> COLUMN_NAME <span class="operator">=</span> <span class="string">&#x27;XX_XX&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    CHARACTER_MAXIMUM_LENGTH,</span><br><span class="line">		TABLE_NAME;</span><br><span class="line"><span class="comment">--------------------------------索引--------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表所含索引信息</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> XX_XX_XX;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> a.TABLE_SCHEMA,a.TABLE_NAME,a.index_name,GROUP_CONCAT(column_name <span class="keyword">ORDER</span> <span class="keyword">BY</span> seq_in_index) <span class="keyword">AS</span> `Columns`</span><br><span class="line"><span class="keyword">FROM</span> information_schema.statistics a</span><br><span class="line"><span class="keyword">where</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;XX_XX_XX&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a.TABLE_SCHEMA,a.TABLE_NAME,a.index_name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> a.TABLE_NAME <span class="keyword">as</span> 表名,a.index_name <span class="keyword">as</span> 索引名,a.non_unique <span class="keyword">as</span> 非唯一性,GROUP_CONCAT(column_name <span class="keyword">ORDER</span> <span class="keyword">BY</span> seq_in_index) <span class="keyword">AS</span> 字段</span><br><span class="line"><span class="keyword">FROM</span> information_schema.statistics a</span><br><span class="line"><span class="keyword">where</span> TABLE_NAME <span class="keyword">in</span> (<span class="string">&#x27;XX_XX_XX&#x27;</span>)</span><br><span class="line">  <span class="keyword">and</span> index_name <span class="keyword">in</span> (<span class="string">&#x27;idx_XX_XX&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> a.TABLE_SCHEMA,a.TABLE_NAME,a.index_name,a.non_unique</span><br></pre></td></tr></table></figure>



<h2 id="二-执行脚本"><a href="#二-执行脚本" class="headerlink" title="二. 执行脚本"></a>二. 执行脚本</h2><h3 id="2-1-Oracle表结构调整"><a href="#2-1-Oracle表结构调整" class="headerlink" title="2.1 Oracle表结构调整"></a>2.1 Oracle表结构调整</h3><p>注意：省略了exist和notexist判断。</p>
<h4 id="（1）字段调整"><a href="#（1）字段调整" class="headerlink" title="（1）字段调整"></a>（1）字段调整</h4><ul>
<li><p>新增字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加字段</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> column_a varchar2(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27; &#x27;</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>修改字段长度：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改字符串类型字段长度</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX MODIFY (column_a varchar2(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改数字类型字段长度</span></span><br><span class="line"><span class="comment">-- 先判断字段是否存在，然后改名并创建新字段（不在意字段顺序，copy效率不高）</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX RENAME <span class="keyword">COLUMN</span> column_a <span class="keyword">TO</span> column_a_old;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> column_a number(<span class="number">19</span>,<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line">UPDATE XXX <span class="keyword">SET</span> column_a <span class="operator">=</span> round(column_a_old, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> column_a_old;</span><br></pre></td></tr></table></figure></li>
<li><p>修改字段名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--字段改名</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX RENAME <span class="keyword">COLUMN</span> column_a <span class="keyword">TO</span> column_aa;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="（2）索引调整"><a href="#（2）索引调整" class="headerlink" title="（2）索引调整"></a>（2）索引调整</h4><ul>
<li><p>新增索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 新增普通索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_XXX <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span> ,column_c <span class="keyword">ASC</span> ,column_d <span class="keyword">ASC</span>);</span><br><span class="line"><span class="comment">-- 新增唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX idx_XXX <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span>);</span><br><span class="line"><span class="comment">-- 新增主键索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> pk_XXX <span class="keyword">PRIMARY</span> KEY(id);</span><br></pre></td></tr></table></figure></li>
<li><p>修改/删除索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 普通索引，增加或减少字段 / 修改顺序 等</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_XXX;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_XXX <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span> ,column_c <span class="keyword">ASC</span> ,column_d <span class="keyword">ASC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主键索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> pk_XXX;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> pk_XXX <span class="keyword">PRIMARY</span> KEY(column_a, column_b, column_c, column_d);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 未知为主键索引还是唯一索引，主键索引有约束，而唯一索引只创建了索引</span></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">	v_rowcount_delete_index <span class="type">integer</span>;</span><br><span class="line">	v_rowcount_delete_cons <span class="type">integer</span>;</span><br><span class="line">	v_rowcount_add <span class="type">integer</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">into</span> v_rowcount_delete_index <span class="keyword">from</span> USER_INDEXES <span class="keyword">where</span> INDEX_NAME <span class="operator">=</span> <span class="built_in">upper</span>(<span class="string">&#x27;pk_XXX&#x27;</span>);</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">into</span> v_rowcount_delete_cons <span class="keyword">from</span> USER_CONSTRAINTS <span class="keyword">where</span> CONSTRAINT_NAME <span class="operator">=</span> <span class="built_in">upper</span>(<span class="string">&#x27;pk_XXX&#x27;</span>);</span><br><span class="line">	if v_rowcount_delete_cons <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">execute</span> immediate <span class="string">&#x27;ALTER TABLE XXX DROP CONSTRAINT pk_XXX&#x27;</span>;</span><br><span class="line">	elsif v_rowcount_delete_index <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">execute</span> immediate <span class="string">&#x27;DROP INDEX pk_XXX&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">into</span> v_rowcount_add <span class="keyword">from</span> user_indexes <span class="keyword">where</span> index_name <span class="operator">=</span> <span class="built_in">upper</span>(<span class="string">&#x27;pk_XXX&#x27;</span>);</span><br><span class="line">  	if v_rowcount_add <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">  		<span class="keyword">execute</span> immediate <span class="string">&#x27;ALTER TABLE XXX ADD CONSTRAINT pk_XXX PRIMARY KEY(column_a, column_b, column_c)&#x27;</span>;</span><br><span class="line">  	<span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="（3）表调整"><a href="#（3）表调整" class="headerlink" title="（3）表调整"></a>（3）表调整</h4><ul>
<li><p>新增表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure></li>
<li><p>删除表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> XXX;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-2-MySQL表结构调整"><a href="#2-2-MySQL表结构调整" class="headerlink" title="2.2 MySQL表结构调整"></a>2.2 MySQL表结构调整</h3><p>注意：省略了exist和notexist判断。</p>
<h4 id="（1）字段调整-1"><a href="#（1）字段调整-1" class="headerlink" title="（1）字段调整"></a>（1）字段调整</h4><ul>
<li><p>新增字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加字段</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> column_a <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>修改字段长度：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改字符串类型字段长度，MySQL需要指定非空和默认值</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX MODIFY column_a <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改数字类型字段长度</span></span><br><span class="line"><span class="comment">-- 先判断字段是否存在，然后改名并创建新字段（不在意字段顺序，copy效率不高）</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX CHANGE column_a column_a_old <span class="type">decimal</span>(<span class="number">19</span>,<span class="number">12</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> column_a <span class="type">decimal</span>(<span class="number">19</span>,<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="number">0.0</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line">UPDATE XXX <span class="keyword">SET</span> column_a <span class="operator">=</span> round(column_a_old, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> column_a;</span><br></pre></td></tr></table></figure></li>
<li><p>修改字段名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 字段改名</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX CHANGE column_a column_aa <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="（2）索引调整-1"><a href="#（2）索引调整-1" class="headerlink" title="（2）索引调整"></a>（2）索引调整</h4><ul>
<li><p>新增索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 新增普通索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_XXX_2 <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span> ,column_c <span class="keyword">ASC</span> ,column_d <span class="keyword">ASC</span> );</span><br><span class="line"><span class="comment">-- 新增唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX idx_XXX_1 <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span> );</span><br><span class="line"><span class="comment">-- 新增主键索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> pk_XXX <span class="keyword">PRIMARY</span> KEY(id);</span><br></pre></td></tr></table></figure></li>
<li><p>修改/删除索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 普通索引，增加或减少字段 / 修改顺序 等</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_XXX <span class="keyword">ON</span> XXX;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_XXX <span class="keyword">ON</span> XXX(column_a <span class="keyword">ASC</span> ,column_b <span class="keyword">ASC</span> ,column_c <span class="keyword">ASC</span> ,column_d <span class="keyword">ASC</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主键索引</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> XXX <span class="keyword">ADD</span> <span class="keyword">PRIMARY</span> KEY(column_a,column_b,column_c,column_d);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="（3）表调整："><a href="#（3）表调整：" class="headerlink" title="（3）表调整："></a>（3）表调整：</h4><ul>
<li><p>新增表</p>
</li>
<li><p>删除表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> XXX;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="三-常用功能"><a href="#三-常用功能" class="headerlink" title="三. 常用功能"></a>三. 常用功能</h2><h3 id="3-1-常用命令"><a href="#3-1-常用命令" class="headerlink" title="3.1 常用命令"></a>3.1 常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 用DBA用户进入SQLPLUS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sqlplus / as sysdba</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭Oracle服务</span></span><br><span class="line"><span class="meta">SQL&gt;</span><span class="bash"> shutdown immediate</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Oracle服务</span></span><br><span class="line"><span class="meta">SQL&gt;</span><span class="bash"> startup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出SQLPLUS</span></span><br><span class="line"><span class="meta">SQL&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启服务器，需要脚本</span></span><br><span class="line">dbstart </span><br></pre></td></tr></table></figure>



<p>监听：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入到oracle的安装目录</span> </span><br><span class="line">cd $ORACLE_HOME </span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看监听服务状态</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsnrctl status</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动监听服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsnrctl start</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsnrctl stop</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsnrctl reload</span></span><br></pre></td></tr></table></figure>



<p>监听文件 <code>sqlnet.ora</code> ：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># listener.ora Network Configuration <span class="keyword">File</span>: <span class="regexp">/home/</span>oracle<span class="regexp">/app/</span>oracle<span class="regexp">/product/</span><span class="number">11.2</span>.<span class="number">0</span><span class="regexp">/dbhome_1/</span>network<span class="regexp">/admin/</span>listener.ora</span><br><span class="line"># Generated by Oracle configuration tools.</span><br><span class="line"></span><br><span class="line">SID_LIST_LISTENER=</span><br><span class="line">  (SID_LIST=</span><br><span class="line">    (SID_DESC=</span><br><span class="line">      (GLOBAL_DBNAME= orcl)</span><br><span class="line">      (ORACLE_HOME=<span class="regexp">/home/</span>oracle<span class="regexp">/app/</span>oracle<span class="regexp">/product/</span><span class="number">11.2</span>.<span class="number">0</span>/dbhome_1)</span><br><span class="line">      (SID_NAME=orcl)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (<span class="keyword">DESCRIPTION</span> =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">192.168</span>.<span class="number">1.42</span>)(PORT = <span class="number">1521</span>))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">ADR_BASE_LISTENER = <span class="regexp">/home/</span>oracle/app</span><br></pre></td></tr></table></figure>





<h3 id="3-1-数据库定时备份"><a href="#3-1-数据库定时备份" class="headerlink" title="3.1 数据库定时备份"></a>3.1 数据库定时备份</h3><ul>
<li><p>Linux：暂无</p>
</li>
<li><p>Windows：新建一个.bat文件，Windows开启定时任务：【任务管理器】-&gt;【管理工具】-&gt;【任务计划程序中】</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">set</span> <span class="string">&quot;Ymd=%date:~,4%%date:~5,2%%date:~8,2%&quot;</span></span><br><span class="line"><span class="string">&quot;C:\Program Files\MySQL\MySQL Server 5.7\bin\mysqldump&quot;</span> --opt -u root --password=&lt;密码&gt; &lt;数据库名&gt; &gt; E:\db_backup\scwl_%Ymd%.sql</span><br><span class="line">@<span class="built_in">echo</span> on</span><br></pre></td></tr></table></figure></li>
<li><p>Navicat for MySQL：<a target="_blank" rel="noopener" href="https://www.formysql.com/wenti/dingshi-beifen.html" title="Title">Navicat for MySQL 如何创建定时备份</a></p>
</li>
</ul>
<h3 id="3-2-Oracle查看临时表空间"><a href="#3-2-Oracle查看临时表空间" class="headerlink" title="3.2 Oracle查看临时表空间"></a>3.2 Oracle查看临时表空间</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"></span><br><span class="line">A.TABLESPACE_NAME, </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span>  ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;允许最大值&quot;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span>  ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;历史峰值&quot;, </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span>  B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span> </span><br><span class="line"></span><br><span class="line">ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;已使用&quot;,   </span><br><span class="line"></span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.BYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/历史峰值&quot;,   </span><br><span class="line"></span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.MAXBYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/允许最大值&quot; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> F.TABLESPACE_NAME, <span class="built_in">SUM</span>(F.BYTES) BYTES,<span class="built_in">SUM</span>(F.MAXBYTES) MAXBYTES  <span class="keyword">FROM</span> DBA_TEMP_FILES F   <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) A,</span><br><span class="line"></span><br><span class="line"> (<span class="keyword">SELECT</span> P.TABLESPACE_NAME, <span class="built_in">SUM</span>(P.BYTES_CACHED) BYTES_CACHED,<span class="built_in">SUM</span>(P.BYTES_USED) BYTES_USED  <span class="keyword">FROM</span> V$TEMP_EXTENT_POOL P  <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME  ) B</span><br><span class="line"></span><br><span class="line"> <span class="keyword">WHERE</span> A.TABLESPACE_NAME <span class="operator">=</span> B.TABLESPACE_NAME</span><br></pre></td></tr></table></figure>



<h3 id="3-3-Oracle生成AWR报告"><a href="#3-3-Oracle生成AWR报告" class="headerlink" title="3.3 Oracle生成AWR报告"></a>3.3 Oracle生成AWR报告</h3><p>Linux按照sqlplus：<a target="_blank" rel="noopener" href="https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html">Instant Client for Linux x86-64 (64-bit) (oracle.com)</a></p>
<p>下载basic和sqlplus的rpm包后，上传到tmp目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">rpm -ivh oracle-instantclientXXX-basic-XXX-1.x86_64.rpm</span><br><span class="line">rpm -ivh oracle-instantclientXXX-sqlplus-XXX-1.x86_64.rpm</span><br></pre></td></tr></table></figure>



<p>安装完毕后，生成的客户端目录在 <strong>/usr/lib/oracle/12.2/client64</strong> ，在该目录下新建<strong>network</strong>目录，并编写<strong>tnsnames.ora</strong>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir network</span><br><span class="line">vi tnsnames.ora</span><br><span class="line"></span><br><span class="line">testdb =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = XXX.XXX.XXX.XXX)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SID = testdb)</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>修改完成后按下 <code>esc</code> + <code>:wq</code> 保存退出。</p>
<p>配置环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bash_profile</span><br><span class="line"></span><br><span class="line">export  ORACLE_HOME=/usr/lib/oracle/12.2/client64</span><br><span class="line">export  TNS_ADMIN=$ORACLE_HOME/network</span><br><span class="line">export  LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/local/lib:$LD_LIBRARY_PATH:.</span><br><span class="line">export  ORABIN=$ORACLE_HOME/bin</span><br><span class="line">export  NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line">export ORACLE_SID=orcl</span><br><span class="line">PATH=$PATH:$ORACLE_HOME/bin:$ORABIN</span><br><span class="line"></span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>



<p>登陆sqlplus：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sqlplus sys@XXX.XXX.XXX.XXX:1521/orcl AS SYSDBA</span><br><span class="line"><span class="meta">sql&gt;</span><span class="bash"> @/u01/app/oracle/12c/rdbms/admin/awrrpt.sql</span></span><br><span class="line"></span><br><span class="line">Enter value of report_type</span><br><span class="line"><span class="meta">#</span><span class="bash"> 意思是生成报告的格式有两种，html和txt，这里选择html</span></span><br><span class="line">Enter value of num_days</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集几天的报告信息，数字，可以输入1</span></span><br><span class="line">Enter value of begin_snap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入开始快照id，要根据日志打印的快照id范围来填</span></span><br></pre></td></tr></table></figure>



<p>生成的 <code>.lst</code> 文件直接拷贝为html打开即可。</p>
<p>更多内容参考：<a href="../2021123001.html" title="Title">Oracle-AWR报告</a>。</p>
<h3 id="3-4-Oracle查看临时表"><a href="#3-4-Oracle查看临时表" class="headerlink" title="3.4 Oracle查看临时表"></a>3.4 Oracle查看临时表</h3><p>临时表空间可以通过使用 <code>V$TEMP_EXTENT_POOL</code> 视图来实时监控。语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"></span><br><span class="line">A.TABLESPACE_NAME, </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span> ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.MAXBYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;允许最大值&quot;,</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span> ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(A.BYTES<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;历史峰值&quot;, </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>)<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">THEN</span> </span><br><span class="line"></span><br><span class="line">ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">3</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;GB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ELSE</span> ROUND(B.BYTES_USED<span class="operator">/</span><span class="built_in">power</span>(<span class="number">1024</span>,<span class="number">2</span>),<span class="number">4</span>)<span class="operator">||</span><span class="string">&#x27;MB&#x27;</span> <span class="keyword">END</span> &quot;已使用&quot;,  </span><br><span class="line"></span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.BYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/历史峰值&quot;,  </span><br><span class="line"></span><br><span class="line">round((B.BYTES_USED<span class="operator">/</span>A.MAXBYTES)<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>)<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> &quot;已使用/允许最大值&quot; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> F.TABLESPACE_NAME, <span class="built_in">SUM</span>(F.BYTES) BYTES,<span class="built_in">SUM</span>(F.MAXBYTES) MAXBYTES <span class="keyword">FROM</span> DBA_TEMP_FILES F  <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) A,</span><br><span class="line"></span><br><span class="line"> (<span class="keyword">SELECT</span> P.TABLESPACE_NAME, <span class="built_in">SUM</span>(P.BYTES_CACHED) BYTES_CACHED,<span class="built_in">SUM</span>(P.BYTES_USED) BYTES_USED <span class="keyword">FROM</span> V$TEMP_EXTENT_POOL P <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME ) B</span><br><span class="line"></span><br><span class="line"> <span class="keyword">WHERE</span> A.TABLESPACE_NAME <span class="operator">=</span> B.TABLESPACE_NAME</span><br></pre></td></tr></table></figure>



<p>执行一张大表的排序查询，确认查询未完成时的、查询完成后，以及连接释放后的临时表使用情况。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> XXX <span class="keyword">ORDER</span> <span class="keyword">BY</span> XX <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-Oracle内存管理"><a href="#3-5-Oracle内存管理" class="headerlink" title="3.5 Oracle内存管理"></a>3.5 Oracle内存管理</h3><p>Oracle内存管理分类：</p>
<ul>
<li><strong>自动内存管理：</strong>AutomaticMemory Management，指Oracle自动的对SGA和PGA进行管理。启动自动内存管理，只需设置 <code>MEMORY_TARGET</code> 和 <code>MEMORY_MAX_TARGET</code> 即可。<ul>
<li><code>MEMORY_TARGET</code> 用于设置目标内存大小，Oracle会尝试将内存稳定在该值。修改 <code>MEMORY_TARGET</code> 并不需要重启数据库。</li>
<li><code>MEMORY_MAX_TARGET</code> 用于设置最大允许的内存大小，Oracle以此来限制内存使用的最大值。修改该参数，需要重启数据库。</li>
<li>在修改以上两个值时需要特别注意，<strong>MEMORY_MAX_TARGET</strong>必须大于或者等于<strong>MEMORY_TARGET</strong>。</li>
</ul>
</li>
<li><strong>手动内存管理：</strong><ul>
<li><strong>自动共享内存管理：</strong>Automatic Shared Memory Management，简称为ASMM。当启用自动共享内存管理时，Oracle会自动的调整SGA的各个组件的值。如果需要启动自动共享内存管理，需要将 <code>SGA_TARGET</code> 和 <code>SGA_MAX_SIZE</code> 设置为非0值，同时还需要将 <code>MEMORY_TARGET</code> 和 <code>MEMORY_MAX_TARGET</code> 设置为0，否则 <code>MEMORY_TARGET</code> 不为0，Oracle采用的是自动内存管理而不是自动共享内存管理。<ul>
<li>SGA_TARGET用于设置共享内存目标大小，Oracle会努力维持共享内存在此目标值，如果你修改了该参数，你并不需要重启数据库。</li>
<li>SGA_MAX_SIZE用于设置最大允许的共享内存大小，Oracle以此来限制共享内存的最大值，如果你修改了该参数，你需要重启数据库。</li>
<li>在修改以上两个值时需要注意，<strong>SGA_MAX_SIZE****必须大于或者等于SGA_TARGET</strong>。</li>
</ul>
</li>
<li><strong>手动共享内存管理：</strong>Manual Shared Memory Management，要手动管理共享内存，首先必须禁用自动内存管理和自动共享内存管理。因此 <code>MEMORY_TARGET</code> 和 <code>SGA_TARGET</code> 都必须设置为0。同时需要手工设置其他组件的值。<ul>
<li><strong>DB_CACHE_SIZE</strong>：缓冲区缓存，主要用于缓存数据，较大的缓存通常会减少磁盘的读写数量，因此缓冲区缓存的大小对性能影响较为明显，因此设置一个合理的缓冲区缓存尤为重要。</li>
<li><strong>SHARED_POOL_SIZE</strong>：共享池，存储多种类型的数据，例如解析后的SQL，PL/SQL代码，数据字典，查询的结果集缓存等数据。因此在多用户环境下，较大的共享池对于性能提升也是非常有帮助的。</li>
<li><strong>LARGE_POOL_SIZE</strong>：大池是一个可选组件。一般用于备份进程，并行执行等。</li>
<li><strong>JAVA_POOL_SIZE</strong>：JAVA池，JAVA代码所需要的内存将从此分配。</li>
<li><strong>STREAMS_POOL_SIZE</strong>：流池，存储缓冲队列消息的内存池。</li>
</ul>
</li>
<li><strong>自动PGA内存管理：</strong>Automatic PGA Memory Management。当使用自动PGA内存管理时，Oracle会自动的管理实例PGA的内存总量。<ul>
<li>可以通过设置初始化参数 <code>PGA_AGGREGATE_TARGET</code> 为非0值，来开启自动PGA内存管理。</li>
<li>Oracle会尝试确保分配给所有数据库服务器进程和后台进程的PGA内存总量不会超过这个目标，但实际使用时可能超过该设置。</li>
<li>当我们使用自动PGA内存管理时，SQL工作区的大小是自动的，并且会忽略所有*_AREA_SIZE初始化参数</li>
</ul>
</li>
<li><strong>手动PGA内存管理：</strong>Manual PGA Memory Management。当自动内存管理被禁用并且 <code>PGA_AGGREGATE_TARGET</code> 被设置为0时，将启用手动PGA内存管理。<ul>
<li>使用手动PGA内存管理时，意味着你需要手工设置 <code>_AREA_SIZE</code> 初始化参数。</li>
<li><strong>注意：Oracle推荐使用自动PGA内存管理，不推荐使用手动PGA内存管理。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="（1）自动内存管理"><a href="#（1）自动内存管理" class="headerlink" title="（1）自动内存管理"></a>（1）自动内存管理</h4><p><strong>如何调整内存？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> SETMEMORY_MAX_TARGET <span class="operator">=</span> <span class="number">1000</span>M <span class="keyword">SCOPE</span> <span class="operator">=</span> SPFILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> MEMORY_TARGET <span class="operator">=</span><span class="number">1000</span>MSCOPE<span class="operator">=</span> SPFILE;</span><br></pre></td></tr></table></figure>



<p>参数：</p>
<ul>
<li>SCOPE：指修改范围，分别是SPFILE，BOTH和MEMORY。</li>
<li>SPFILE：指修改服务器参数文件中的数据。</li>
<li>MEMORY：指修改内存中的数据，对于要重启数据库才生效的参数，该值不可用</li>
<li>BOTH：指同时修改服务器参数文件和内存中的数据。</li>
</ul>
<p><strong>什么情况下使用自动内存管理？</strong></p>
<p>Oracle官方推荐SGA+PGA的内存总大小如果小于或等于4GB，建议使用自动内存管理。如果你的SGA+PGA大于4G也使用了自动内存管理，那么建议最好设置 <code>SGA_TARGET</code> 和 <code>PGA_AGGREGATE_TARGET</code> 的值。这些值将作为SGA和PGA的最小值。该设置主要是为了避免过大的内存抖动。</p>
<h4 id="（2）自动共享内存管理"><a href="#（2）自动共享内存管理" class="headerlink" title="（2）自动共享内存管理"></a>（2）自动共享内存管理</h4><p><strong>如何调整内存？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> SGA_TARGET <span class="operator">=</span> <span class="number">1000</span>M <span class="keyword">SCOPE</span> <span class="operator">=</span> SPFILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> SGA_MAX_SIZE <span class="operator">=</span> <span class="number">1000</span>M <span class="keyword">SCOPE</span><span class="operator">=</span> SPFILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> MEMORY_MAX_TARGET <span class="operator">=</span> <span class="number">0</span> <span class="keyword">SCOPE</span> <span class="operator">=</span> SPFILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> MEMORY_TARGET <span class="operator">=</span> <span class="number">0</span> <span class="keyword">SCOPE</span> <span class="operator">=</span> SPFILE;</span><br></pre></td></tr></table></figure>



<p><strong>什么情况下使用自动共享内存管理？</strong></p>
<p> Oracle官方推荐SGA+PGA的总大小大于4GB，建议使用自动共享内存管理。如果我们启用了自动共享内存管理，Oracle会自动的调整SGA各组件大小，一般我们并不需要干预。但如果我们知道各组件高峰期时这些值的使用量，那么我们也可以为这些组件设置指定值，这些值将作为组件的最小值。从而避免高峰期时不必要的内存调整。</p>
<h4 id="（3）手动共享内存管理"><a href="#（3）手动共享内存管理" class="headerlink" title="（3）手动共享内存管理"></a>（3）手动共享内存管理</h4><p><strong>什么情况下使用手动共享内存管理？</strong></p>
<p>不推荐使用手动共享内存管理，首先你需要对内存的各参数的作用非常的了解。其次你必须对系统各阶段内存的使用情况非常了解。并且由于不同时期对各个组件内存使用的多少可能有较大的差异，这极大的增加了管理成本。</p>
<h4 id="（4）PGA内存管理"><a href="#（4）PGA内存管理" class="headerlink" title="（4）PGA内存管理"></a>（4）PGA内存管理</h4><p><strong>如何分配内存？</strong></p>
<p>不管是采用自动内存管理还是自动共享内存管理+自动PGA内存管理。在分配内存时，普遍的做法是分配机器总内存的50% ~ 75%。</p>
<p>例如：机器内存是128G，SGA+PGA合计会分配64G ~ 96G。需要注意的是50%~75%只是一个普遍值，但不是个绝对值。机器内存只有4G的情况下，分配50%是很有必要的，但是如果机器内存有512G，对于只部署数据库的机器来说分配75%仍然有大量的内存未使用。</p>
<p>SGA需要多大？PGA需要多大？这个并没有参考的指标，一般需要根据实际情况来分配，一般可以先确定PGA大小，然后剩余内存都分配给SGA。如果你的系统有大量的并发访问，那么PGA分配就需要比较多，而如果你的系统并发访问人数非常少。那么几百MB的PGA就可满足了。而剩下的内存则都可以分配给SGA。</p>
<h3 id="3-6-手动SqlLoder"><a href="#3-6-手动SqlLoder" class="headerlink" title="3.6 手动SqlLoder"></a>3.6 手动SqlLoder</h3><p>测试数据 <code>detail.txt</code> ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123,xxx,xxx,xxx,xxx,0,0,5000,xxx,xxx</span><br></pre></td></tr></table></figure>



<p>控制文件 <code>detail.ctl</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA INFILE &#x27;detail.txt&#x27; APPEND</span><br><span class="line">INTO TABLE XXX FIELDS TERMINATED BY &#x27;,&#x27; OPTIONALLY ENCLOSED BY x&#x27;05&#x27; Trailing Nullcols</span><br><span class="line">(XXX, XXX, XXX, XXX char(4000), XXX, XXX, XXX, XXX, XXX, XXX)</span><br></pre></td></tr></table></figure>



<p>执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sqlldr <span class="string">&quot;用户名/密码@host:port/sid&quot;</span> control=/XXX/detail.ctl</span></span><br></pre></td></tr></table></figure>



<h3 id="3-7-MySQL升级版本"><a href="#3-7-MySQL升级版本" class="headerlink" title="3.7 MySQL升级版本"></a>3.7 MySQL升级版本</h3><p>查看是否安装过MySQL：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep -i mysql</span><br></pre></td></tr></table></figure>



<p>查看安装目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whereis mysql</span><br></pre></td></tr></table></figure>



<p>暂略。</p>
<h2 id="四-知识点记录"><a href="#四-知识点记录" class="headerlink" title="四. 知识点记录"></a>四. 知识点记录</h2><h3 id="（1）MySQL中字符串与数值比较-小心隐式转换"><a href="#（1）MySQL中字符串与数值比较-小心隐式转换" class="headerlink" title="（1）MySQL中字符串与数值比较-小心隐式转换"></a>（1）MySQL中字符串与数值比较-小心隐式转换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">123</span> <span class="operator">&gt;</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;1abc&#x27;</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="number">-1</span> <span class="operator">&gt;</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="number">0</span> <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br></pre></td></tr></table></figure>



<ol>
<li>原因： 当MySQL字段类型和传入条件数据类型不一致时，会进行隐形的数据类型转换（MySQL Implicit conversion）</li>
<li>若字符串是以数字开头，且全部都是数字，则转换为数字结果是整个字符串；部分是数字，则转换为数字结果是截止到第一个不是数字的字符为止。 理解： varchar str = “123dafa”，转换为数字是123 。 SELECT ‘123dafa’+1 ; — 124 。</li>
<li>若字符串不是以数字开头，则转换为数字结果是 0 。 varchar str = “aabb33” ; 转换为数字是 0 。 SELECT ‘aabb33’+100 ; — 100 。</li>
<li>更多隐式转换规则摘录：<ul>
<li>两个参数至少有一个是 NULL 时，比较的结果也是 NULL，例外是使用 &lt;=&gt; 对两个 NULL 做比较时会返回 1，这两种情况都不需要做类型转换</li>
<li>两个参数都是字符串，会按照字符串来比较，不做类型转换</li>
<li>两个参数都是整数，按照整数来比较，不做类型转换</li>
<li>十六进制的值和非数字做比较时，会被当做二进制串</li>
<li>有一个参数是 TIMESTAMP 或 DATETIME，并且另外一个参数是常量，常量会被转换为 timestamp</li>
<li>有一个参数是 decimal 类型，如果另外一个参数是 decimal 或者整数，会将整数转换为 decimal 后进行比较；如果另外一个参数是浮点数，则会把 decimal 转换为浮点数进行比较；所有其他情况下，两个参数都会被转换为浮点数再进行比较。</li>
</ul>
</li>
</ol>
<h3 id="（2）死锁问题"><a href="#（2）死锁问题" class="headerlink" title="（2）死锁问题"></a>（2）死锁问题</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--复现死锁：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--查询1：</span></span><br><span class="line">update XXX <span class="keyword">set</span> column_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">where</span> column_b <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">and</span> column_d <span class="operator">=</span> <span class="string">&#x27;20180430&#x27;</span>;</span><br><span class="line">update XXX <span class="keyword">set</span> column_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">where</span> column_b <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">and</span> column_d <span class="operator">=</span> <span class="string">&#x27;20180531&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--查询2：</span></span><br><span class="line">update XXX <span class="keyword">set</span> column_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">where</span> column_b <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">and</span> BUSS_DATE <span class="operator">=</span> <span class="string">&#x27;20180430&#x27;</span>;</span><br><span class="line">update XXX <span class="keyword">set</span> column_a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">where</span> column_b <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">and</span> BUSS_DATE <span class="operator">=</span> <span class="string">&#x27;20180531&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--执行查询1第一条SQL，不提交</span></span><br><span class="line"><span class="comment">--执行查询2第二条SQL，不提交</span></span><br><span class="line"><span class="comment">--执行查询1第二条SQL，不提交 -&gt; 锁等待</span></span><br><span class="line"><span class="comment">--执行查询2第一条SQL，不提交 -&gt; 死锁</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看死锁是否存在</span></span><br><span class="line"><span class="keyword">select</span> username,lockwait,status,machine,program,sid <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object);</span><br><span class="line"></span><br><span class="line"><span class="comment">--查看死锁的语句</span></span><br><span class="line"><span class="keyword">select</span> sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> <span class="keyword">where</span> hash_value <span class="keyword">in</span> </span><br><span class="line">(<span class="keyword">select</span> sql_hash_value <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object));</span><br><span class="line"></span><br><span class="line"><span class="comment">--查看trace文件日志路径：如/u01/app/oracle/diag/rdbms/orcl/orcl/trace</span></span><br><span class="line"><span class="keyword">select</span> tracefile <span class="keyword">from</span> v$process <span class="keyword">where</span> addr <span class="keyword">in</span> (<span class="keyword">select</span> paddr <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span> (<span class="keyword">select</span> sid <span class="keyword">from</span> v$mystat));</span><br><span class="line"></span><br><span class="line">linux到上述目录下执行：grep &quot;current SQL&quot; <span class="operator">*</span>trc</span><br><span class="line"></span><br><span class="line">找到记录死锁日志的追踪文件，找到发生死锁的<span class="keyword">SQL</span></span><br></pre></td></tr></table></figure>



<p>trc：</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">===============================================================================</span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">51</span>:<span class="number">07.695140</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">Suspected Hangs <span class="keyword">in</span> the System</span><br><span class="line">                     Root       Chain Total               Hang               </span><br><span class="line">  Hang Hang          Inst Root  #hung #hung  Hang   Hang  Resolution         </span><br><span class="line">    ID Type Status   Num  Sess   Sess  Sess  Conf   Span  Action             </span><br><span class="line"> ----- ---- -------- ---- ----- ----- ----- ------ ------ -------------------</span><br><span class="line">     <span class="number">5</span> HANG    VALID    <span class="number">1</span>   <span class="number">230</span>     <span class="number">2</span>     <span class="number">2</span>    LOW  LOCAL Terminate Process  </span><br><span class="line"> </span><br><span class="line">  Inst  Sess   Ser             Proc  Wait    Wait </span><br><span class="line">   Num    ID    Num      OSPID  Name Time(s) <span class="keyword">Event</span></span><br><span class="line">  ----- ------ ----- --------- ----- ------- -----</span><br><span class="line">      <span class="number">1</span>    <span class="number">422</span> <span class="number">46567</span>      <span class="number">2632</span>    FG      <span class="number">94</span> enq: TX - row lock contention</span><br><span class="line">      <span class="number">1</span>    <span class="number">230</span> <span class="number">15556</span>     <span class="number">20325</span>    FG      <span class="number">96</span> SQL*Net message <span class="keyword">from</span> client</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                                                     IO           </span><br><span class="line"> Total  Self-         Total  Total  Outlr  Outlr  Outlr           </span><br><span class="line">  Hung  Rslvd  Rslvd   Wait WaitTm   Wait WaitTm   Wait           </span><br><span class="line">  Sess  Hangs  Hangs  Count   Secs  Count   Secs  Count Wait <span class="keyword">Event</span></span><br><span class="line">------ ------ ------ ------ ------ ------ ------ ------ -----------</span><br><span class="line">     <span class="number">6</span>      <span class="number">0</span>      <span class="number">0</span>    <span class="number">677</span>   <span class="number">2930</span>      <span class="number">8</span>   <span class="number">2688</span>      <span class="number">0</span> enq: TX - row lock contention</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">51</span>:<span class="number">07.695294</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> <span class="type">Short</span> Stack <span class="keyword">of</span> immediate waiter session ID <span class="number">422</span>, OSPID <span class="number">2632</span> <span class="keyword">of</span> hang ID <span class="number">5</span></span><br><span class="line"><span class="type">Short</span> stack dump: </span><br><span class="line">ksedsts()+<span class="number">346</span>&lt;-ksdxfstk()+<span class="number">71</span>&lt;-ksdxcb()+<span class="number">912</span>&lt;-sspuser()+<span class="number">217</span>&lt;-__sighandler()&lt;-semtimedop()+<span class="number">10</span>&lt;-skgpwwait()+<span class="number">200</span>&lt;-ksliwat()+<span class="number">2292</span>&lt;-kslwaitctx()+<span class="number">197</span>&lt;-ksqcmi()+<span class="number">8465</span>&lt;-ksqgtlctx()+<span class="number">4872</span>&lt;-ksqgelctx()+<span class="number">771</span>&lt;-ktuGetTxForXid()+<span class="number">241</span>&lt;-ktcwit1()+<span class="number">378</span>&lt;-kdddgb()+<span class="number">6484</span>&lt;-kdddel()+<span class="number">566</span>&lt;-kaudel()+<span class="number">107</span>&lt;-delrow()+<span class="number">1489</span>&lt;-qerdlFetch()+<span class="number">695</span>&lt;-delexe()+<span class="number">1119</span>&lt;-opiexe()+<span class="number">10904</span>&lt;-kpoal8()+<span class="number">2679</span>&lt;-opiodr()+<span class="number">1229</span>&lt;-ttcpip()+<span class="number">1257</span>&lt;-opitsk()+<span class="number">1940</span>&lt;-opiino()+<span class="number">941</span>&lt;-opiodr()+<span class="number">1229</span>&lt;-opidrv()+<span class="number">1021</span>&lt;-sou2o()+<span class="number">145</span>&lt;-opimai_real()+<span class="number">455</span>&lt;-ssthrdmain()+<span class="number">417</span>&lt;-main()+<span class="number">262</span>&lt;-__libc_start_main()+<span class="number">256</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> current SQL: delete <span class="keyword">from</span> XXX</span><br><span class="line">			 <span class="keyword">where</span> column_a = :p00 <span class="built_in">and</span> column_b = <span class="comment">&#x27;Y&#x27; and column_c &gt;= :p01 and column_c &lt;= :p02</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> <span class="type">Short</span> Stack <span class="keyword">of</span> root session ID <span class="number">230</span>, OSPID <span class="number">20325</span> <span class="keyword">of</span> hang ID <span class="number">5</span></span><br><span class="line"><span class="type">Short</span> stack dump: </span><br><span class="line">ksedsts()+<span class="number">346</span>&lt;-ksdxfstk()+<span class="number">71</span>&lt;-ksdxcb()+<span class="number">912</span>&lt;-sspuser()+<span class="number">217</span>&lt;-__sighandler()&lt;-read()+<span class="number">14</span>&lt;-nttfprd()+<span class="number">368</span>&lt;-nsbasic_brc()+<span class="number">432</span>&lt;-nioqrc()+<span class="number">6340</span>&lt;-opikndf2()+<span class="number">1071</span>&lt;-opitsk()+<span class="number">890</span>&lt;-opiino()+<span class="number">941</span>&lt;-opiodr()+<span class="number">1229</span>&lt;-opidrv()+<span class="number">1021</span>&lt;-sou2o()+<span class="number">145</span>&lt;-opimai_real()+<span class="number">455</span>&lt;-ssthrdmain()+<span class="number">417</span>&lt;-main()+<span class="number">262</span>&lt;-__libc_start_main()+<span class="number">256</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> current SQL: none</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">51</span>:<span class="number">09.761422</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Session <span class="keyword">with</span> ID <span class="number">422</span> serial # <span class="number">46567</span> (FG) <span class="keyword">on</span> <span class="type">single</span> instance <span class="number">1</span> <span class="built_in">is</span> hung</span><br><span class="line">    <span class="built_in">and</span> <span class="built_in">is</span> waiting <span class="keyword">on</span> <span class="comment">&#x27;enq: TX - row lock contention&#x27; for 97 seconds.</span></span><br><span class="line">    Session was previously waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message from client&#x27;.</span></span><br><span class="line">    Final Blocker <span class="built_in">is</span> Session ID <span class="number">230</span> serial# <span class="number">15556</span> <span class="keyword">on</span> instance <span class="number">1</span></span><br><span class="line">     which <span class="built_in">is</span> waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message from client&#x27; for 98 seconds</span></span><br><span class="line">     p1: <span class="comment">&#x27;driver id&#x27;=0x54435000, p2: &#x27;#bytes&#x27;=0x1, p3: &#x27;&#x27;=0x0</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">51</span>:<span class="number">58.864634</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Ignoring LOW confidence LOCAL Hang <span class="keyword">with</span> ID=<span class="number">5</span></span><br><span class="line">    Victim <span class="built_in">is</span> (inst#:sess id:serial#): (<span class="number">1</span>:<span class="number">230</span>:<span class="number">15556</span>) (OSPID:<span class="number">20325</span>)</span><br><span class="line">    involving <span class="number">2</span> total sessions.  Ignore count <span class="built_in">is</span> <span class="number">1</span>.</span><br><span class="line">    Previous hang confidence was LOW.  Hang confidence policy <span class="built_in">is</span> HIGH.</span><br><span class="line">    Hang Ignore Reason: Hang resolution <span class="built_in">is</span> disabled.</span><br><span class="line">    Hang resolution scope <span class="built_in">is</span> <span class="keyword">OFF</span>.  This hang<span class="comment">&#x27;s scope is SESSION.</span></span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">51</span>:<span class="number">58.864731</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> About <span class="keyword">to</span> produce Verified Hang dump</span><br><span class="line"> </span><br><span class="line">Details <span class="keyword">for</span> verified hangs up <span class="keyword">to</span> hang ID=<span class="number">5</span> <span class="keyword">in</span> trace file: /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_dia0_11498_vfy_5.trc</span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">52</span>:<span class="number">06.880582</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Session <span class="keyword">with</span> ID <span class="number">230</span> <span class="keyword">with</span> serial number <span class="number">15556</span> <span class="built_in">is</span> no longer hung</span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">52</span>:<span class="number">06.880681</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> Session ID <span class="number">422</span> serial# <span class="number">46567</span> ospid <span class="number">2632</span> <span class="keyword">on</span> instance <span class="number">1</span> <span class="keyword">in</span> hang ID <span class="number">5</span></span><br><span class="line">    was considered hung but <span class="built_in">is</span> now no longer hung</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> Session ID <span class="number">230</span> serial# <span class="number">15556</span> ospid <span class="number">20325</span> <span class="keyword">on</span> instance <span class="number">1</span> <span class="keyword">in</span> hang ID <span class="number">5</span></span><br><span class="line">    was considered hung but <span class="built_in">is</span> now no longer hung</span><br><span class="line"> </span><br><span class="line"><span class="symbol">HM:</span> Session <span class="keyword">with</span> ID <span class="number">422</span> <span class="keyword">with</span> serial number <span class="number">46567</span> <span class="built_in">is</span> no longer hung</span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">52</span>:<span class="number">45.959966</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Hang ID=<span class="number">3</span> detected at <span class="number">12</span>/<span class="number">30</span>/<span class="number">2020</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">30</span> <span class="keyword">with</span> victim:<span class="number">1</span>/<span class="number">230</span>/<span class="number">15556</span></span><br><span class="line">    Evt:<span class="comment">&#x27;SQL*Net message from client&#x27;, SELF-RESOLVED after 0 matches (0) (4).</span></span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">54</span>:<span class="number">04.127084</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Session <span class="keyword">with</span> ID <span class="number">230</span> serial # <span class="number">15556</span> (FG) <span class="keyword">on</span> <span class="type">single</span> instance <span class="number">1</span> <span class="built_in">is</span> hung</span><br><span class="line">    <span class="built_in">and</span> <span class="built_in">is</span> waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message from client&#x27; for 96 seconds.</span></span><br><span class="line">    Session was previously waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message to client&#x27;.</span></span><br><span class="line">    Session ID <span class="number">230</span> <span class="built_in">is</span> blocking <span class="number">1</span> session</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">54</span>:<span class="number">04.127351</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Session <span class="keyword">with</span> ID <span class="number">612</span> serial # <span class="number">43336</span> (FG) <span class="keyword">on</span> <span class="type">single</span> instance <span class="number">1</span> <span class="built_in">is</span> hung</span><br><span class="line">    <span class="built_in">and</span> <span class="built_in">is</span> waiting <span class="keyword">on</span> <span class="comment">&#x27;enq: TX - row lock contention&#x27; for 96 seconds.</span></span><br><span class="line">    Session was previously waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message from client&#x27;.</span></span><br><span class="line">    Final Blocker <span class="built_in">is</span> Session ID <span class="number">230</span> serial# <span class="number">15556</span> <span class="keyword">on</span> instance <span class="number">1</span></span><br><span class="line">     which <span class="built_in">is</span> waiting <span class="keyword">on</span> <span class="comment">&#x27;SQL*Net message from client&#x27; for 96 seconds</span></span><br><span class="line">     p1: <span class="comment">&#x27;driver id&#x27;=0x54435000, p2: &#x27;#bytes&#x27;=0x1, p3: &#x27;&#x27;=0x0</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">*** <span class="number">2020</span>-<span class="number">12</span>-<span class="number">30</span>T16:<span class="number">54</span>:<span class="number">04.127888</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line"><span class="symbol">HM:</span> Hung Sessions (local detect) - output local chains</span><br></pre></td></tr></table></figure>



<h3 id="（3）生成大批量测试数据"><a href="#（3）生成大批量测试数据" class="headerlink" title="（3）生成大批量测试数据"></a>（3）生成大批量测试数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Oracle</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">i <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">i:<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">WHILE(i<span class="operator">&lt;</span><span class="number">32000</span>) </span><br><span class="line">LOOP</span><br><span class="line">    i:<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> XXX(&quot;XXX_ID&quot;, &quot;XXX_ID&quot;, &quot;XXX_DATE&quot;, &quot;XXX_NO&quot;, &quot;XXX_CODE&quot;, &quot;XXX&quot;, &quot;XXX_PRICE&quot;, &quot;USER_XXX&quot;, &quot;XXX_TIME&quot;, &quot;USER_XXX&quot;, &quot;XXX_TIME&quot;) </span><br><span class="line">	<span class="keyword">SELECT</span> <span class="number">40000</span> <span class="operator">+</span> i, <span class="string">&#x27;100104000&#x27;</span>, <span class="string">&#x27;20210820&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, sys_guid(), <span class="string">&#x27;XXX&#x27;</span>, <span class="string">&#x27;1.032&#x27;</span>, <span class="string">&#x27;149100&#x27;</span>, <span class="string">&#x27;20210820.102314&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;0&#x27;</span> <span class="keyword">from</span> dual;</span><br><span class="line"><span class="keyword">END</span> LOOP; </span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"># MySQL</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> proc_batch_insert;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc_batch_insert()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> pre_name <span class="type">BIGINT</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> ageVal <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">SET</span> i<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">WHILE i <span class="operator">&lt;=</span> <span class="number">3000</span> DO</span><br><span class="line">    </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> xxx(`xxx`, `xxx`) <span class="keyword">VALUES</span> (replace(uuid(),&quot;-&quot;,&quot;&quot;), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">call</span> proc_batch_insert();</span><br></pre></td></tr></table></figure>



<h3 id="（4）求累计金额"><a href="#（4）求累计金额" class="headerlink" title="（4）求累计金额"></a>（4）求累计金额</h3><p>MySQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@csum</span> :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">SELECT</span> account_date, val_price, (<span class="variable">@csum</span> :<span class="operator">=</span> <span class="variable">@csum</span> <span class="operator">+</span> val_price) <span class="keyword">AS</span> 累计利润</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">select</span> account_date,<span class="built_in">sum</span>(val_price) <span class="keyword">as</span> val_price <span class="keyword">from</span> XXX <span class="keyword">group</span> <span class="keyword">by</span> account_date) a) b <span class="keyword">where</span> account_date <span class="operator">&gt;=</span> <span class="number">20180404</span> <span class="keyword">and</span> account_date <span class="operator">&lt;=</span> <span class="number">20180405</span>;</span><br></pre></td></tr></table></figure>



<h3 id="（5）数据库连接池设定大小"><a href="#（5）数据库连接池设定大小" class="headerlink" title="（5）数据库连接池设定大小"></a>（5）数据库连接池设定大小</h3><p>线程并非越多越好，举例：为什么一个只有4个线程的Nginx服务器可以超过，拥有100个进程的Apache服务器？</p>
<ul>
<li><p>网站操作从文件读取静态内容放到网络上传输给请求的用户，这些操作具有等待时间，在服务器处理完请求前都会占用线程时间。</p>
</li>
<li><p>Apache为每个用户提供一个专用线程，采用阻塞式I/O。每次请求都要创建一个新的进程/线程，导致处理器要在进程间频繁进行上下文切换。</p>
</li>
<li><p>Nginx则采用事件驱动的方式，使用一个单线程的非阻塞式I/O来处理请求。即使是一台单核心的CPU也可以“同时”支持几十几百个线程，由OS时间切片实现，核心同时只能执行一个线程，OS切换上下文后再执行另一个线程的代码。CPU调度的规律是<strong>按顺序执行任务A和B总是比按时间切割执行的快</strong>，因为上下文切换是比较昂贵的操作，当线程数量远远超过核心数时，必然会因为增加线程而变慢。</p>
</li>
</ul>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010122.png"></p>
<p>对于数据库来说，还有其它的影响因素：CPU、磁盘、网络和内存。</p>
<ul>
<li>数据库数据大部分存储在磁盘上，传统磁盘由旋转的金属板组成上面有读写头，同一时间只能在一处读写数据，所以会有寻址耗时和旋转成本。</li>
<li>网络也类似，当发送和接收缓冲区填满并停滞时，会产生阻塞现象。</li>
<li>在等待的这段时间，连接/查询/线程只是在磁盘上等待，OS在此期间可以通过执行另一个线程来更好的利用CPU资源。</li>
</ul>
<p>所以由于线程在I/O上被阻塞，可以通过拥有比核心数量更多的线程来完成更多的工作。但具体要多多少？</p>
<p>数据库连接池：</p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010123.png"></p>
<p>如果一个服务，经常有1W个用户连接同时发送数据库请求，每秒约2W个交易。如果为每个请求都建立一个连接，这样的资源消耗是无法想象的。即使是连接池大小设为100也有些过大，我们更想要一个几十个连接的池子让任务排队等待执行。</p>
<p>PostgreSQL提供了一个公式来计算连接池的最佳吞吐量：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">connections</span> = ((core_count \ <span class="number">2</span>) + effective_spindle_count)</span><br></pre></td></tr></table></figure>



<p>为了避免死锁，连接池大小计算公式，参数:</p>
<ul>
<li>Tn：线程的最大数量。</li>
<li>Cm：单个线程同时持有的最大连接数。</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pool</span> size = Tn * (Cm — <span class="number">1</span>) + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>例如，最多有3个线程，每个线程需要4个连接来执行任务，所需连接池=3 * (4 - 1) + 1 = 10，这是避免死锁的最小要求，但不一定是最佳。</p>
<p>网上有案例对Oracle数据库进行了压测，模拟9600个并发线程，每两次操作间休眠550ms。</p>
<ul>
<li>初始时线程池大小为2048：每个请求在连接池平均等待33ms，获得连接后，执行SQL耗时77ms，CPU使用率维持在95%左右。</li>
<li>降低到1024后：等待连接时长基本不变，SQL执行耗时降低了。</li>
<li>降低到96后：平均等待时间降为1ms，执行耗时降为2ms。</li>
</ul>
<p>大部分情况下，我们只需要一个小的连接池，从而让等待连接的线程饱和。</p>
<h3 id="（6）Oracle-v-sql-视图"><a href="#（6）Oracle-v-sql-视图" class="headerlink" title="（6）Oracle v$sql 视图"></a>（6）Oracle v$sql 视图</h3><p><code>V$SQL</code> 列出了没有<code>GROUP BY</code>子句的共享SQL区域的统计数据，并为输入的原始SQL文本的每个子句包含一行。<code>V$SQL</code>中显示的统计数据通常在查询执行结束时更新。然而，对于长期运行的查询，它们每5秒更新一次。这使得我们可以很容易地看到仍在进行中的长期运行的SQL语句的影响。</p>
<table>
<thead>
<tr>
<th align="left">Column</th>
<th align="left">Datatype</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>SQL_TEXT</code></td>
<td align="left"><code>VARCHAR2(1000)</code></td>
<td align="left">当前游标的SQL文本的前1000个字符</td>
</tr>
<tr>
<td align="left"><code>SQL_FULLTEXT</code></td>
<td align="left"><code>CLOB</code></td>
<td align="left">作为<code>CLOB</code>列显式的SQL语句的全文。可以使用此列检索SQL语句的全文，而不是与<code>V$SQL_TEXT</code>动态性能视图连接。</td>
</tr>
<tr>
<td align="left"><code>SQL_ID</code></td>
<td align="left"><code>VARCHAR2(13)</code></td>
<td align="left">库缓存中父游标的SQL标识符</td>
</tr>
<tr>
<td align="left"><code>SHARABLE_MEM</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">子游标所使用的共享内存的数量（单位：字节）</td>
</tr>
<tr>
<td align="left"><code>PERSISTENT_MEM</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">在子游标的生命周期内使用的固定内存量 (单位：字节)</td>
</tr>
<tr>
<td align="left"><code>RUNTIME_MEM</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">在执行子游标时需要的固定内存量</td>
</tr>
<tr>
<td align="left"><code>SORTS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">为子游标做的排序数</td>
</tr>
<tr>
<td align="left"><code>LOADED_VERSIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">表示上下文堆是否被加载</td>
</tr>
<tr>
<td align="left"><code>OPEN_VERSIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">指示子游标是否被锁定</td>
</tr>
<tr>
<td align="left"><code>USERS_OPENING</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">打开该语句的用户数</td>
</tr>
<tr>
<td align="left"><code>FETCHES</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">与SQL语句相关的fetch数</td>
</tr>
<tr>
<td align="left"><code>EXECUTIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">自该对象被载入库缓存以来的执行次数。</td>
</tr>
<tr>
<td align="left"><code>PX_SERVERS_EXECUTIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">并行eXecution服务器执行的总次数。当语句从未被并行执行时，该值为0。</td>
</tr>
<tr>
<td align="left"><code>END_OF_FETCH_COUNT</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">自从游标被载入库缓存以来被完全执行的次数。当游标被部分执行时，该统计值不会递增。根据定义，<code>END_OF_FETCH_COUNT</code>列的值应该小于或者等于<code>EXECUTIONS</code>列的值。</td>
</tr>
<tr>
<td align="left"><code>USERS_EXECUTING</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">执行该语句的用户数</td>
</tr>
<tr>
<td align="left"><code>LOADS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该对象被加载或重新加载的次数</td>
</tr>
<tr>
<td align="left"><code>FIRST_LOAD_TIME</code></td>
<td align="left"><code>VARCHAR2(19)</code></td>
<td align="left">父类创建时间</td>
</tr>
<tr>
<td align="left"><code>INVALIDATIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标已被废止的次数</td>
</tr>
<tr>
<td align="left"><code>PARSE_CALLS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标的解析调用次数</td>
</tr>
<tr>
<td align="left"><code>DISK_READS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标的磁盘读取次数</td>
</tr>
<tr>
<td align="left"><code>DIRECT_WRITES</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标的直接写入数</td>
</tr>
<tr>
<td align="left"><code>BUFFER_GETS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标获得的缓冲区数量</td>
</tr>
<tr>
<td align="left"><code>APPLICATION_WAIT_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">应用程序等待时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>CONCURRENCY_WAIT_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">并发等待时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>CLUSTER_WAIT_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">集群等待时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>USER_IO_WAIT_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">用户I/O等待时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>PLSQL_EXEC_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">PL/SQL 执行时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>JAVA_EXEC_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">Java执行时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>ROWS_PROCESSED</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">解析后的SQL语句返回的总行数</td>
</tr>
<tr>
<td align="left"><code>COMMAND_TYPE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">Oracle命令类型定义</td>
</tr>
<tr>
<td align="left"><code>OPTIMIZER_MODE</code></td>
<td align="left"><code>VARCHAR2(10)</code></td>
<td align="left">执行SQL语句的模式</td>
</tr>
<tr>
<td align="left"><code>OPTIMIZER_COST</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">优化器给出的该查询的成本</td>
</tr>
<tr>
<td align="left"><code>OPTIMIZER_ENV</code></td>
<td align="left"><code>RAW(691)</code></td>
<td align="left">优化器环境</td>
</tr>
<tr>
<td align="left"><code>OPTIMIZER_ENV_HASH_VALUE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">优化器环境的哈希值</td>
</tr>
<tr>
<td align="left"><code>PARSING_USER_ID</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">最初建立这个子游标的用户ID。</td>
</tr>
<tr>
<td align="left"><code>PARSING_SCHEMA_ID</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">最初用于建立这个子游标的Schema ID</td>
</tr>
<tr>
<td align="left"><code>PARSING_SCHEMA_NAME</code></td>
<td align="left"><code>VARCHAR2(30)</code></td>
<td align="left">最初建立这个子游标时使用的Schema名</td>
</tr>
<tr>
<td align="left"><code>KEPT_VERSIONS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">表示这个子游标是否被标记为使用<code>DBMS_SHARED_POOL</code>包在缓存中保持固定。</td>
</tr>
<tr>
<td align="left"><code>ADDRESS</code></td>
<td align="left">`RAW(4</td>
<td align="left">8)`</td>
</tr>
<tr>
<td align="left"><code>TYPE_CHK_HEAP</code></td>
<td align="left"><code>RAW(4)</code></td>
<td align="left">该子游标的类型检查堆的描述符</td>
</tr>
<tr>
<td align="left"><code>HASH_VALUE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">库缓存中父语句的哈希值</td>
</tr>
<tr>
<td align="left"><code>OLD_HASH_VALUE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">旧的SQL哈希值</td>
</tr>
<tr>
<td align="left"><code>PLAN_HASH_VALUE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该游标的SQL计划的数字表示。比较一个 <code>PLAN_HASH_VALUE</code> 和另一个 <code>PLAN_HASH_VALUE</code> 可以很容易地确定两个计划是否相同（而不是逐行比较这两个计划）</td>
</tr>
<tr>
<td align="left"><code>CHILD_NUMBER</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该子游标的数量</td>
</tr>
<tr>
<td align="left"><code>SERVICE</code></td>
<td align="left"><code>VARCHAR2(64)</code></td>
<td align="left">服务名</td>
</tr>
<tr>
<td align="left"><code>SERVICE_HASH</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">在<code>SERVICE</code>中列出名称的哈希值</td>
</tr>
<tr>
<td align="left"><code>MODULE</code></td>
<td align="left"><code>VARCHAR2(64)</code></td>
<td align="left">包含在第一次解析SQL语句时正在执行的模块的名称，它是通过调用 <code>DBMS_APPLICATION_INFO</code>.<code>SET_MODULE</code> 设置的</td>
</tr>
<tr>
<td align="left"><code>MODULE_HASH</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left"><code>MODULE</code> 列中所列模块的哈希值</td>
</tr>
<tr>
<td align="left"><code>ACTION</code></td>
<td align="left"><code>VARCHAR2(64)</code></td>
<td align="left">包含在第一次解析SQL语句时正在执行的动作的名称，它是通过调用 <code>DBMS_APPLICATION_INFO</code>.<code>SET_ACTION</code> 设置的</td>
</tr>
<tr>
<td align="left"><code>ACTION_HASH</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left"><code>ACTION</code> 列中列出的行动的哈希值</td>
</tr>
<tr>
<td align="left"><code>SERIALIZABLE_ABORTS</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">每个游标中，交易无法序列化，产生 <code>ORA-08177</code> 错误的次数</td>
</tr>
<tr>
<td align="left"><code>OUTLINE_CATEGORY</code></td>
<td align="left"><code>VARCHAR2(64)</code></td>
<td align="left">If an outline was applied during construction of the cursor, then this column displays the category of that outline. Otherwise the column is left blank.</td>
</tr>
<tr>
<td align="left"><code>CPU_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该游标用于解析、执行和获取的CPU时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>ELAPSED_TIME</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">该游标用于解析、执行和获取的时间（单位：微秒）</td>
</tr>
<tr>
<td align="left"><code>OUTLINE_SID</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">Outline session identifier</td>
</tr>
<tr>
<td align="left"><code>CHILD_ADDRESS</code></td>
<td align="left">`RAW(4</td>
<td align="left">8)`</td>
</tr>
<tr>
<td align="left"><code>SQLTYPE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">表示该语句使用的SQL语言的版本</td>
</tr>
<tr>
<td align="left"><code>REMOTE</code></td>
<td align="left"><code>VARCHAR2(1)</code></td>
<td align="left">指示游标是否被远程映射</td>
</tr>
<tr>
<td align="left"><code>OBJECT_STATUS</code></td>
<td align="left"><code>VARCHAR2(19)</code></td>
<td align="left">游标的状态：<code>VALID</code> - 有效的，没有错误的授权。<code>VALID_AUTH_ERROR</code> - 有效的，有授权错误的授权。 <code>VALID_COMPILE_ERROR</code> - 有效的，有编译错误的授权。<code>VALID_UNAUTH</code> - 有效的，未授权。<code>INVALID_UNAUTH</code> - 无效的，未授权。<code>INVALID</code> - 无效的，未授权，但保留时间戳。</td>
</tr>
<tr>
<td align="left"><code>LITERAL_HASH_VALUE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">当使用<code>CURSOR_SHARING</code> 时，用系统生成的绑定变量替换的字词的哈希值，并且要进行匹配。这不是SQL语句的哈希值。如果不使用 <code>CURSOR_SHARING</code>，那么这个值是0。</td>
</tr>
<tr>
<td align="left"><code>LAST_LOAD_TIME</code></td>
<td align="left"><code>VARCHAR2(19)</code></td>
<td align="left">查询计划（堆 6）加载到库缓存的时间</td>
</tr>
<tr>
<td align="left"><code>IS_OBSOLETE</code></td>
<td align="left"><code>VARCHAR2(1)</code></td>
<td align="left">表示游标是否已经过时（<code>Y</code>）或没有过时（<code>N</code>）。如果子游标的数量太多，就会发生这种情况</td>
</tr>
<tr>
<td align="left"><code>CHILD_LATCH</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">Child latch number that is protecting the cursor</td>
</tr>
<tr>
<td align="left"><code>SQL_PROFILE</code></td>
<td align="left"><code>VARCHAR2(64)</code></td>
<td align="left">SQL 简介 profile</td>
</tr>
<tr>
<td align="left"><code>PROGRAM_ID</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">程序标识符</td>
</tr>
<tr>
<td align="left"><code>PROGRAM_LINE#</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">程序行号</td>
</tr>
<tr>
<td align="left"><code>EXACT_MATCHING_SIGNATURE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">在规范化的SQL文本上计算的签名。规范化包括去除白色空间和所有非字面字符串的大写字母</td>
</tr>
<tr>
<td align="left"><code>FORCE_MATCHING_SIGNATURE</code></td>
<td align="left"><code>NUMBER</code></td>
<td align="left">当<code>CURSOR_SHARING</code>参数设置为<code>FORCE</code>时使用的签名。</td>
</tr>
<tr>
<td align="left"><code>LAST_ACTIVE_TIME</code></td>
<td align="left"><code>DATE</code></td>
<td align="left">查询计划最后被激活的时间</td>
</tr>
<tr>
<td align="left"><code>BIND_DATA</code></td>
<td align="left"><code>RAW(2000)</code></td>
<td align="left">绑定数据</td>
</tr>
</tbody></table>
<h3 id="（7）判断两个时间段有交集"><a href="#（7）判断两个时间段有交集" class="headerlink" title="（7）判断两个时间段有交集"></a>（7）判断两个时间段有交集</h3><p>首先可以用排列组合列出所有时间段可能情况，用A，B表示目标时间段，用a，b，c表示时间所处的三块时间段区间，其中b是闭合。</p>
<p>列出当前时间段所有可能的组合：</p>
<table><tbody>
    <tr>
        <th style="text-align:center;" colspan="3">A</th>
        <th style="text-align:center;" colspan="3">B</th>
    </tr>
    <tr>
        <td style="text-align:center;" colspan="2"> a |</td>
        <td style="text-align:center;" colspan="2"> b </td>
        <td style="text-align:center;" colspan="2">| c </td>
    </tr>
</tbody></table>  


<table><tbody>
    <tr>
        <th style="text-align:center;">开始</th>
        <th style="text-align:center;">结束</th>
    </tr>
    <tr>
        <td style="text-align:center;">a</td>
        <td style="text-align:center;">a</td>
    </tr>
    <tr>
        <td style="text-align:center;">a</td>
        <td style="text-align:center;">b</td>
    </tr>
    <tr>
        <td style="text-align:center;">a</td>
        <td style="text-align:center;">c</td>
    </tr>
    <tr>
        <td style="text-align:center;">b</td>
        <td style="text-align:center;">a</td>
    </tr>
    <tr>
        <td style="text-align:center;">b</td>
        <td style="text-align:center;">b</td>
    </tr>
    <tr>
        <td style="text-align:center;">b</td>
        <td style="text-align:center;">c</td>
    </tr>
    <tr>
        <td style="text-align:center;">c</td>
        <td style="text-align:center;">a</td>
    </tr>
    <tr>
        <td style="text-align:center;">c</td>
        <td style="text-align:center;">b</td>
    </tr>
    <tr>
        <td style="text-align:center;">c</td>
        <td style="text-align:center;">c</td>
    </tr>
</tbody></table>  


<p>首先排除c-a，c-b，b-a非法开始时间不能大于结束时间，然后排除a-a，c-c和目标时间段没有交集，所以只剩下a-b，a-c，b-b，b-c四种情况。</p>
<table><tbody>
    <tr>
        <th style="text-align:center;">开始</th>
        <th style="text-align:center;">结束</th>
    </tr>
    <tr>
        <td bgcolor="Aqua" style="text-align:center;">a</td>
        <td bgcolor="Aqua" style="text-align:center;">a</td>
    </tr>
    <tr>
        <td style="text-align:center;">a</td>
        <td style="text-align:center;">b</td>
    </tr>
    <tr>
        <td style="text-align:center;">a</td>
        <td style="text-align:center;">c</td>
    </tr>
    <tr>
        <td bgcolor="Gray" style="text-align:center;">b</td>
        <td bgcolor="Gray" style="text-align:center;">a</td>
    </tr>
    <tr>
        <td style="text-align:center;">b</td>
        <td style="text-align:center;">b</td>
    </tr>
    <tr>
        <td style="text-align:center;">b</td>
        <td style="text-align:center;">c</td>
    </tr>
    <tr>
        <td bgcolor="Gray" style="text-align:center;">c</td>
        <td bgcolor="Gray" style="text-align:center;">a</td>
    </tr>
    <tr>
        <td bgcolor="Gray" style="text-align:center;">c</td>
        <td bgcolor="Gray" style="text-align:center;">b</td>
    </tr>
    <tr>
        <td bgcolor="Aqua" style="text-align:center;">c</td>
        <td bgcolor="Aqua" style="text-align:center;">c</td>
    </tr>
</tbody></table> 


<p>得到结果：</p>
<blockquote>
<p>(startTime &lt; A &amp;&amp; endTime &gt;= a) || (startTime &gt;= A &amp;&amp; startTime &lt;= B &amp;&amp; endTime &gt;= A)</p>
</blockquote>
<hr>
<p>参考：</p>
<p>🔗 《<a target="_blank" rel="noopener" href="https://www.formysql.com/wenti/dingshi-beifen.html" title="Title">Navicat for MySQL 如何创建定时备份</a>》</p>
<p>🔗 《<a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/B19306_01/server.102/b14237/dynviews_2113.htm#REFRN30246" title="Title">Oracle-V$SQL</a>》</p>
<p>🔗 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg4OTY2NTk5Mg==&mid=2247483736&idx=1&sn=7496c5d3a63ffca79d16882e2ce736d4&chksm=cfe921fff89ea8e9224daac4c1239aa89a84c260ca4a52c4c41ef476f20ea9d73aa84ab97d18&scene=178&cur_album_id=2004964035275866114#rd">三分钟了解Oracle内存管理方式</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://kwahome.medium.com/database-connections-less-is-more-86c406b6fad">Database Connections: Less is More</a></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2019091401.html" rel="bookmark">SQL规范和优化（持续更新）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021101401.html" rel="bookmark">执行计划（更新中）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021121801.html" rel="bookmark">海量数据处理</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021121201.html" rel="bookmark">优化分页查询</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2020092401.html" rel="bookmark">SqlLoader</a></div>
    </li>
  </ul>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Lys
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://linyishui.top/2020021801.html" title="Oralce和MySql笔记（持续更新）">http://linyishui.top/2020021801.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/updating/" rel="tag"><i class="fa fa-tag"></i> updating</a>
              <a href="/tags/sql/" rel="tag"><i class="fa fa-tag"></i> sql</a>
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
              <a href="/tags/oracle/" rel="tag"><i class="fa fa-tag"></i> oracle</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020021501.html" rel="prev" title="LoadBalanced注解原理">
                  <i class="fa fa-chevron-left"></i> LoadBalanced注解原理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020021901.html" rel="next" title="Linux常用指令（持续更新）">
                  Linux常用指令（持续更新） <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lys</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">3.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">54:03</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"LAILAIWA/LAILAIWA.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>



</body>
</html>
