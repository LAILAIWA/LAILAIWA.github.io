<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>俺的部落格</title>
  
  <subtitle>俺寻思俺需要记点东西</subtitle>
  <link href="http://linyishui.top/atom.xml" rel="self"/>
  
  <link href="http://linyishui.top/"/>
  <updated>2021-09-29T12:24:58.000Z</updated>
  <id>http://linyishui.top/</id>
  
  <author>
    <name>Lys</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RabbitMQ（十）扩展</title>
    <link href="http://linyishui.top/2021092501.html"/>
    <id>http://linyishui.top/2021092501.html</id>
    <published>2021-09-25T06:16:34.000Z</published>
    <updated>2021-09-29T12:24:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ（十）扩展"><a href="#RabbitMQ（十）扩展" class="headerlink" title="RabbitMQ（十）扩展"></a>RabbitMQ（十）扩展</h1><h2 id="一-消息追踪"><a href="#一-消息追踪" class="headerlink" title="一. 消息追踪"></a>一. 消息追踪</h2><p>使用消息中间件过程难免会遇到消息丢失的情况：</p><ul><li>可能是生产者与Broker断开了连接并且也没有任何重试机制；</li><li>可能是消费者在处理消息时发生了异常，但提前进行了ack；</li><li>可能是交换器没有与任何队列进行绑定，生产者感知不到或未采取相应的措施；</li><li>可能是RabbitMQ本身的集群策略导致消息的丢失。</li></ul><p>需要有一个好的机制来跟踪记录消息的投递过程，方便开发和运维人员快速定位问题。</p><h3 id="1-1-Firehose"><a href="#1-1-Firehose" class="headerlink" title="1.1 Firehose"></a>1.1 Firehose</h3><p>Firehose可以记录每一次发送或消费消息的记录。原理是将生产者投递给MQ的消息或MQ投递给消费者的消息按指定的格式发送到默认交换器 <code>amq.rabbitmq.trace</code> 上（topic类型）。路由键为 <code>publish.&#123;exchangename&#125;</code> 和 <code>deliver.&#123;queuename&#125;</code> 。前者对应生产者投递到交换器的消息，后者对应消费者从队列获取的消息。</p><p>开启/关闭Firehose：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl trace_on [-p vhost]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl trace_off [-p vhost]</span></span><br></pre></td></tr></table></figure><p>Firehose（多少会影响一点性能）默认关闭，且重启MQ后重置为默认。</p><p>创建7个队列，2个交换器与其中两个队列绑定，最后将交换器 <code>amq.rabbitmq.trace</code> 与其余5个队列绑定：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010120.png"></p><p>分别用客户端向exchange和exchange.another发送一条消息”trace test payload”，然后再用客户端消费队列queue和queue.another的消息。</p><p>此时queue1中有2条消息，queue2中有2条消息，queue3中有4条消息，而queue4和queue5中只有一条消息。</p><ul><li>在向exchange发送一条消息后，<code>amq.rabbitmq.trace</code> 分别向queue1、queue3和queue4发送一条内部封装消息。</li><li>在向exchange.another发送一条消息后，queue1和queue3多出一条消息。</li><li>消费queue的时候，queue2、queue3和queue5多出一条消息。</li><li>消费queue.another时，queue2和queue3多出一条消息。</li></ul><p>综述：</p><ul><li><code>publish.#</code> 匹配发送到所有交换器的消息。</li><li><code>deliver.#</code> 匹配消费所有队列的消息。</li><li><code>#</code> 则包含前两者。</li></ul><p>当有客户端发送或消费消息时，Firehose会自动封装相应的消息体，并添加详细的headers属性：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010121.png"></p><p>消费queue时，消息会封装为：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010122.png"></p><p>headers：</p><ul><li>exchange_name：发送消息的交换器。</li><li>routing_keys：对应路由键列表。</li><li>properties：消息本身的属性，如delivery_mode为2表示消息需要持久化处理。</li></ul><h3 id="1-2-rabbitmq-tracing插件"><a href="#1-2-rabbitmq-tracing插件" class="headerlink" title="1.2 rabbitmq_tracing插件"></a>1.2 rabbitmq_tracing插件</h3><p>rabbitmq_tracing插件相当于Firehose的GUI版本，同样能跟踪MQ中的消息流入流出，同样对消息进行封装并存入trace文件之中。</p><p>开启/关闭：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_tracing</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">disable</span> rabbitmq_tracing</span></span><br></pre></td></tr></table></figure><p>Web管理界面Admin会多出一栏Tracing：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010123.png"></p><p>添加Trace：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010124.png"></p><ul><li>Name：trace任务名称。</li><li>Format：输出的消息日志格式，有Text和JSON。</li><li>Max payload bytes：每条消息的最大限制，单位为B，达到上限会被截断。</li><li>Pattern：设置匹配的模式，<code>#</code> 匹配所有消息流入流出，<code>publish.#</code> 匹配所有消息流入，<code>deliver.#</code> 匹配所有消息流出。</li></ul><p>TEXT格式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010129.png"></p><p>JSON格式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010130.png"></p><p>添加完毕后，根据匹配的规则将相应的消息日志输出到对应日志文件中，默认路径为 <code>/var/tmp/rabbitmq-tracing</code> ，也可以在页面直接点击Trace log files直接查看对应文件。</p><p>添加两个trace任务：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010125.png"></p><p>对应文件：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010126.png"></p><p>会多出两个队列：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010127.png"></p><p>查看第一个队列，绑定的交换器就是 <code>amq.rabbitmq.trace</code> ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010128.png"></p><p>可以看出 rabbitmq_tracing插件和Firehose如出一辙，只是多了层GUI方便使用和管理。</p><h4 id="（1）开启Tracing日志"><a href="#（1）开启Tracing日志" class="headerlink" title="（1）开启Tracing日志"></a>（1）开启Tracing日志</h4><ol><li><p>使用comp用户连接linux服务器</p></li><li><p>输入指令 <code>rabbitmqctl status</code> 确认MQ状态</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010101.png" alt="image-20210331171126692"></p><p><code>command not found</code>：不能识别命令，需要添加配置信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim .bash_profile</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/home/comp/rabbitmq/rabbitmq_server-3.7.5/sbin</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置信息，后使其生效</span></span><br><span class="line">source .bash_profile</span><br></pre></td></tr></table></figure></li><li><p>通过指令 <code>rabbitmq-plugins list</code> 查看MQ安装的插件，<code>E*</code> 表示已启用。对应文件路径：<code>/home/comp/rabbitmq/rabbitmq_server-3.7.5/sbin</code> </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010102.png" alt="image-20210331171303814"></p></li><li><p>找到 <code>rabbitmq_tracing</code> 确认是否启用，若未启用，则通过指令 <code>rabbitmq-plugins enable rabbitmq_tracing</code> 开启。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010103.png" alt="image-20210331171436966"></p></li><li><p>通过指令 <code>rabbitmqctl trace_on</code> 开启trace。</p></li><li><p>虚拟主机 server 开启trace：<code>rabbitmqctl trace_on -p server</code> ，添加完成后会多一个交换器：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010104.png" alt="image-20210331171813344"></p></li><li><p>RabbitMQ管理平台新建一个Trace，添加trace追踪文件信息：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010105.png" alt="image-20210331172359303"></p></li><li><p>创建的Trace文件：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010106.png" alt="image-20210331172219234"></p><p>若该步骤出错，如：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010107.png" alt="image-20210907173131624"></p><p>MQ的tracing插件默认使用guest用户，给它开下server权限应该就行了</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010108.png" alt="image-20210907183235365"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010109.png" alt="image-20210907183453592"></p><p>MQ日志路径：<code>/home/comp/rabbitmq/log</code> 。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 日志表示账号密码有问题</span></span><br><span class="line">2021-09-07 17:55:17.143 [info] &lt;0.2303.0&gt; Enabling tracing for vhost &#x27;server&#x27;</span><br><span class="line">2021-09-07 17:55:17.173 [error] &lt;0.3847.0&gt; Supervisor &#123;&lt;0.3847.0&gt;,rabbit_tracing_consumer_sup&#125; had child consumer started with rabbit_tracing_consumer:start_link([&#123;vhost,&lt;&lt;&quot;server&quot;&gt;&gt;&#125;,&#123;name,&lt;&lt;&quot;server-trace-log&quot;&gt;&gt;&#125;,&#123;format,&lt;&lt;&quot;text&quot;&gt;&gt;&#125;,&#123;pattern,&lt;&lt;&quot;#&quot;&gt;&gt;&#125;,&#123;&lt;&lt;&quot;for...&quot;&gt;&gt;,...&#125;,...]) at undefined exit with reason no match of right hand value &#123;error,&#123;auth_failure,&quot;Refused&quot;&#125;&#125; in rabbit_tracing_consumer:init/1 line 58 in context start_error</span><br><span class="line">2021-09-07 17:55:17.173 [error] &lt;0.3848.0&gt; CRASH REPORT Process &lt;0.3848.0&gt; with 0 neighbours exited with reason: no match of right hand value &#123;error,&#123;auth_failure,&quot;Refused&quot;&#125;&#125; in rabbit_tracing_consumer:init/1 line 58 in gen_server:init_it/6 line 352</span><br></pre></td></tr></table></figure></li><li><p>重新核算，触发消息发送。</p></li><li><p>查看步骤8的Trace文件，确认消息是否发送。</p></li></ol><p>如果给guest增加权限server仍不能创建Trac，直接重建guest用户：</p><ol><li><p>删除用户guest</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010110.png" alt="image-20210907194009362"></p></li><li><p>再创建用户guest，用户名密码相同。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/%E5%BE%85%E4%B8%8A%E4%BC%A0/202109010111.png" alt="image-20210907194048653"></p><p><img src="C:\Users\hspcadmin\AppData\Roaming\Typora\typora-user-images\image-20210907194122446.png" alt="image-20210907194122446"></p></li><li><p>增加权限：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010112.png" alt="image-20210907194148405"></p></li><li><p>重新创建Tracing：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010113.png" alt="image-20210907194213958"></p><p>创建成功：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010114.png" alt="image-20210907194229913"></p></li></ol><h4 id="（2）测试队列"><a href="#（2）测试队列" class="headerlink" title="（2）测试队列"></a>（2）测试队列</h4><p>除了开启Tracing排查消息是否投递到MQ，还可以新加一个测试Queue，绑定相同的交换器和路由键。因为无消费者，所以消息都堆积在队列中，通过GetMessage(n) + nack来获取所有消息，也可以ack或purge清空消息。</p><h3 id="1-3-案例：可靠性检测"><a href="#1-3-案例：可靠性检测" class="headerlink" title="1.3 案例：可靠性检测"></a>1.3 案例：可靠性检测</h3><p>生产者将消息发送到交换器时，实际上是由生产者所连接的信道将消息上的路由键同交换器的绑定列表比较，之后再路由消息到相应的队列进程中。    </p><p>那么在信道对比完绑定列表后，将消息路由到队列并保存的过程，是否会因为MQ的内部缺陷而引起偶发性的消息丢失？我们可以使用消息追踪机制来验证这一疑问，一个交换器通过同一个路由键绑定多个队列，生产者客户端采用同一个路由键发送消息到交换器，检测绑定的队列是否有消息丢失。</p><h4 id="（1）前期准备"><a href="#（1）前期准备" class="headerlink" title="（1）前期准备"></a>（1）前期准备</h4><ol><li>开启tracing插件。</li><li>创建一个交换器exchange和三个队列，都由同一个路由键rk绑定。</li><li>创建三个trace分别采用 <code>#.queue1</code> ，<code>#.queue2</code> ，<code>#.queue3</code> 的Pattern追踪各个队列。</li><li>创建一个trace：trace_publish采用 <code>publish.exchange</code> 追踪流入交换器的消息。</li></ol><h4 id="（2）验证过程"><a href="#（2）验证过程" class="headerlink" title="（2）验证过程"></a>（2）验证过程</h4><p>开启一个生产者现场，持续发消息到交换器，消息格式为当前时间戳+自增计数，从而在数据丢失时可以快速在trace日志中定位到。注意设置mandatory参数，防止消息路由不到对应队列而造成对消息丢失的误判。</p><p>消息发送前以[msg, QUEUE_NUM]的形式存入一个全局msgMap中，用来在消费端做数据验证，为3表示创建了三个队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, Integer&gt; msgMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;String&gt; log2disk = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProducerThread</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">            channel.addReturnListener((replyCode, replyText, exchange, routingKey, basicProperties, body) -&gt; &#123;</span><br><span class="line">                String errorInfo = <span class="string">&quot;Basic.Return: &quot;</span> + <span class="keyword">new</span> String(body) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log2disk.put(errorInfo);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(errorInfo);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                String message = System.currentTimeMillis() + <span class="string">&quot;-&quot;</span> + count++;</span><br><span class="line">                <span class="comment">// 存储消息一定要在发消息之前，否则消息被消费时msgMap中不一定会有相应的消息</span></span><br><span class="line">                <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                    msgMap.put(message, QUEUE_NUM);</span><br><span class="line">                &#125;</span><br><span class="line">                channel.basicPublish(exchange, routingKey, <span class="keyword">true</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// QPS=10，可以自适应调节，不宜过高防止队列堆积严重</span></span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，开启三个消费者线程分别消费是三个队列的消息，从存储的msgMap中寻找是否有相应消息，若有则计数减一并删除；若无，则报错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="keyword">private</span> String queue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerThread</span><span class="params">(Connection connection, String queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">            channel.basicQos(<span class="number">64</span>);</span><br><span class="line">            channel.basicConsume(<span class="keyword">this</span>.queue, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                    <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (msgMap.containsKey(msg)) &#123;</span><br><span class="line">                            <span class="keyword">int</span> count = msgMap.get(msg);</span><br><span class="line">                            count--;</span><br><span class="line">                            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                msgMap.put(msg, count);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                msgMap.remove(msg);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            String errorInfo = <span class="string">&quot;unknown msg : &quot;</span> + msg + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                log2disk.put(errorInfo);</span><br><span class="line">                                System.out.println(errorInfo);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                                ex.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，开启一个检测进程，每隔10分钟检测一下msgMap中的数据。对比消息中的时间戳和当前时间，如果差值超过10分钟，则说明可能有消息丢失。（该结论的前提是队列没有消息堆积，且消费消息的速度不低于生产消息的速度）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DetectThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MINUTES.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : msgMap.entrySet()) &#123;</span><br><span class="line">                    String msg = entry.getKey();</span><br><span class="line">                    <span class="keyword">if</span> (now - parseTime(msg) &gt;= <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">                        String findLossInfo = <span class="string">&quot;We find loss msg: &quot;</span> +</span><br><span class="line">                                msg + <span class="string">&quot; , now the time is: &quot;</span> + </span><br><span class="line">                                now + <span class="string">&quot;, and this msg still has &quot;</span> +</span><br><span class="line">                                entry.getValue() + <span class="string">&quot; missed\n&quot;</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            log2disk.put(findLossInfo);</span><br><span class="line">                            System.out.println(findLossInfo);</span><br><span class="line">                            msgMap.remove(msg);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                            ex.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">parseTime</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index = msg.indexOf(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    String timeStr = msg.substring(<span class="number">0</span>, index);</span><br><span class="line">    <span class="keyword">return</span> Long.parseLong(timeStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果检测到msgMap有超过10分钟的未处理消息，还不能说明有消息丢失，使用trace，如果看到[msg, count]这条数据有如下情况：</p><ul><li><strong>考虑count=3的情况。</strong>需要检索trace文件trace_publish.log来进一步验证，如果其中没搜到相应的消息说明消息未发送到交换器；如果搜索到消息，则要进一步检索trace1.log、trace2.log和trace3.log。如果3个文件不是全部都有此消息，则说明消息丢失。</li><li><strong>考虑0&lt;count&lt;3的情况。</strong>检索trace1.log、trace2.log和trace3.log。如果3个文件不是全部都有此消息，则说明消息丢失。</li><li><strong>考虑count=0的情况。</strong>说明检查程序异常，可以忽略。</li></ul><p>主线程部分代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Connection connection = connectionFactory.newConnection();</span><br><span class="line"><span class="comment">// 用来读取log2disk这个BlockingQueue中存储的异常日志，然后进行存盘处理，可以用log4j等代替</span></span><br><span class="line">PrintLogThread printLogThread = <span class="keyword">new</span> PrintLogThread(logFileAddr);</span><br><span class="line">ProducerThread producerThread = <span class="keyword">new</span> ProducerThread(connection);</span><br><span class="line">ConsumerThread consumerThread1 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue1&quot;</span>);</span><br><span class="line">ConsumerThread consumerThread2 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue2&quot;</span>);</span><br><span class="line">ConsumerThread consumerThread3 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue3&quot;</span>);</span><br><span class="line">DetectThread detectThread = <span class="keyword">new</span> DetectThread();</span><br><span class="line">System.out.println(<span class="string">&quot;starting check msg loss...&quot;</span>);</span><br><span class="line">ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">executorService.submit(printLogThread);</span><br><span class="line">executorService.submit(producerThread);</span><br><span class="line">executorService.submit(consumerThread1);</span><br><span class="line">executorService.submit(consumerThread2);</span><br><span class="line">executorService.submit(consumerThread3);</span><br><span class="line">executorService.submit(detectThread);</span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></table></figure><h2 id="二-负载均衡"><a href="#二-负载均衡" class="headerlink" title="二. 负载均衡"></a>二. 负载均衡</h2><p>大量业务访问、高并发请求的场景，需要用高性能的服务器来提升MQ的负载能力。假设一个集群中有3个节点，所有客户端都与node1建立TCP连接，则node1的网络负载会大大增加，其他节点又由于没有那么多负载而造成资源浪费。</p><p>对于RabbitMQ，客户端只会和集群中一个节点建立连接而不是整个集群。引入负载均衡后，各个客户端的连接会分摊到各个节点：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010131.png"></p><blockquote><p>负载均衡（Load Balance）是一种计算机网络技术，用于在多个计算机（集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最佳资源使用、最大化吞吐率、最小响应时间及避免过载的目的。</p><p>使用带有负载均衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。</p><p>负载均衡分为：</p><ul><li><strong>软件负载均衡：</strong>在一个或多个交互的网络系统中的多台服务器上安装一个或多个相应的负载均衡软件来实现的一种均衡负载技术。软件安装比较方便，技术配置简单，操作方便，成本很低。</li><li><strong>硬件负载均衡：</strong>多台服务器间安装相应的负载均衡设备，即负载均衡器。相比软件会有更好的负载均衡效果，但成本较高，适用于流量较大的大型网站系统。</li></ul></blockquote><h3 id="2-1-客户端内部实现负载均衡"><a href="#2-1-客户端内部实现负载均衡" class="headerlink" title="2.1 客户端内部实现负载均衡"></a>2.1 客户端内部实现负载均衡</h3><p>客户端连接可以任选一种负载均衡算法实现。</p><h4 id="（1）轮询法"><a href="#（1）轮询法" class="headerlink" title="（1）轮询法"></a>（1）轮询法</h4><p>将请求按顺序轮流分配到后端服务器上，不关心每台服务器实际的连接数和当前系统负载，调用 <code>RoundRobin.getConnectionAddress()</code> 获取连接地址。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 轮询法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ip = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            ip = list.get(pos);</span><br><span class="line">            <span class="keyword">if</span> (++pos &gt;= list.size()) &#123;</span><br><span class="line">                pos = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）加权轮询法"><a href="#（2）加权轮询法" class="headerlink" title="（2）加权轮询法"></a>（2）加权轮询法</h4><p>不同服务器的配置可能和当前系统的负载不同，抗压能力也不相同。所以应该给配置高、负载低的机器配置更高的权重，让其处理更多请求；</p><h4 id="（3）随机法"><a href="#（3）随机法" class="headerlink" title="（3）随机法"></a>（3）随机法</h4><p>通过随机算法，根据服务器列表大小值来任选一台服务器访问。由概率理论可知，随着调用服务端次数增多，实际效果会越来越接近轮询法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 随机法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomAccess</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> pos = random.nextInt(list.size());</span><br><span class="line">        <span class="keyword">return</span> list.get(pos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（4）加权随机法"><a href="#（4）加权随机法" class="headerlink" title="（4）加权随机法"></a>（4）加权随机法</h4><p>与加权轮询法相同，根据机器配置和负载分配不同权重，区别是其按照权重随机分配而非顺序。</p><h4 id="（5）源地址哈希法"><a href="#（5）源地址哈希法" class="headerlink" title="（5）源地址哈希法"></a>（5）源地址哈希法</h4><p>根据获取的客户端IP地址，通过哈希函数计算得到的一个数值，用此数值对服务器列表的大小进行取模运算，得到的结果便是客户端要访问服务器的序号。</p><p>采用该方法，同一IP地址的客户端在服务器列表不变的情况下，每次都会分配给同一台服务器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 源地址哈希法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpHash</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ipHashCode = InetAddress.getLocalHost().getHostAddress().hashCode();</span><br><span class="line">        <span class="keyword">int</span> pos = ipHashCode &amp; list.size();</span><br><span class="line">        <span class="keyword">return</span> list.get(pos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（6）最小连接数法"><a href="#（6）最小连接数法" class="headerlink" title="（6）最小连接数法"></a>（6）最小连接数法</h4><p>由于服务器配置不尽相同，对于请求的处理有快有慢，根据服务器当前连接情况，动态的选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能的提高对服务器的利用效率。</p><h3 id="2-2-使用HAProxy实现负载均衡"><a href="#2-2-使用HAProxy实现负载均衡" class="headerlink" title="2.2 使用HAProxy实现负载均衡"></a>2.2 使用HAProxy实现负载均衡</h3><p>HAProxy提供了高可用性、负载均衡及基于TCP和HTTP应用的代理，支持虚拟主机，是一种免费、快速且可靠的解决方案。实现了一种事件驱动、单一进程模型，支持较大的并发连接数。</p><h4 id="（1）安装"><a href="#（1）安装" class="headerlink" title="（1）安装"></a>（1）安装</h4><p><a href="http://www.haproxy.org/#down">官网下载</a>，<a href="http://www.haproxy.org/#doc1.7">官方文档</a>。</p><p>将下载的压缩包复制到 <code>/opt</code> 目录下，与RabbitMQ同一个目录，并解压：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tar zxvf haproxy-1.7.8.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> haproxy-1.7.8</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make指令将其编译为可执行程序，TARGET选择目标平台</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make TARGET=generic</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译后目录下有名为haproxy的可执行文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改系统配置</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/profile</span></span><br><span class="line">export PATH=$PATH:/opt/haproxy-1.7.8/haproxy</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure><h4 id="（2）配置"><a href="#（2）配置" class="headerlink" title="（2）配置"></a>（2）配置</h4><p>HAProxy使用单一配置文件来定义所有属性：</p><ul><li>HAProxy主机：192.168.0.9:5671</li><li>RabbitMQ1：192.168.0.2:5672</li><li>RabbitMQ2：192.168.0.3:5672</li><li>RabbitMQ3：192.168.0.4:5672</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global</span></span><br><span class="line"><span class="comment"># 日志输出配置，所有日志都记录在本机，通过local0输出</span></span><br><span class="line"><span class="attr">log</span> <span class="string">127.0.0.1 local0 info</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="attr">maxconn</span> <span class="string">4096</span></span><br><span class="line"><span class="comment"># 改变当前的工作目录</span></span><br><span class="line"><span class="attr">chroot</span> <span class="string">/opt/haproxy-1.7.8</span></span><br><span class="line"><span class="comment"># 以指定的UID运行</span></span><br><span class="line"><span class="attr">uid</span> <span class="string">99</span></span><br><span class="line"><span class="comment"># 以指定的GID运行</span></span><br><span class="line"><span class="attr">gid</span> <span class="string">99</span></span><br><span class="line"><span class="comment"># 以守护进程方式运行 #debug #quiet</span></span><br><span class="line"><span class="attr">daemon</span></span><br><span class="line"><span class="comment">#debug</span></span><br><span class="line"><span class="comment"># 当前进程pid文件</span></span><br><span class="line"><span class="attr">pidfile</span> <span class="string">/opt/haproxy-1.7.8/haproxy.pid</span></span><br><span class="line"><span class="comment"># 默认配置</span></span><br><span class="line"><span class="attr">defaults</span></span><br><span class="line"><span class="comment"># 应用全局的日志配置</span></span><br><span class="line"><span class="attr">log</span> <span class="string">global</span></span><br><span class="line"><span class="comment"># 默认的模式mode&#123;tcp|http|health&#125;</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">tcp</span></span><br><span class="line"><span class="comment"># 日志类别tcplog</span></span><br><span class="line"><span class="attr">option</span> <span class="string">tcplog</span></span><br><span class="line"><span class="comment"># 不记录健康检查日志信息</span></span><br><span class="line"><span class="attr">option</span> <span class="string">dontlognull</span></span><br><span class="line"><span class="comment"># 3次失败则认为服务不可用</span></span><br><span class="line"><span class="meta">retries</span> <span class="string">3</span></span><br><span class="line"><span class="comment"># 每个进程可用的最大连接数</span></span><br><span class="line"><span class="attr">maxconn</span> <span class="string">2000</span></span><br><span class="line"><span class="comment"># 连接超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">connect 5s</span></span><br><span class="line"><span class="comment"># 客户端超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">client 120s</span></span><br><span class="line"><span class="comment"># 服务端超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">server 120s</span></span><br><span class="line"><span class="comment"># 绑定配置</span></span><br><span class="line"><span class="meta">listen</span> <span class="string">rabbitmq_cluster :5671</span></span><br><span class="line"><span class="comment"># 配置TCP模式</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">tcp</span></span><br><span class="line"><span class="comment"># 简单的轮询</span></span><br><span class="line"><span class="attr">balance</span> <span class="string">roundrobin</span></span><br><span class="line"><span class="comment"># RabbitMQ集群节点配置</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node1 192.168.0.2:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node2 192.168.0.3:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node3 192.168.0.4:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="comment">#haproxy监控页面地址</span></span><br><span class="line"><span class="meta">listen</span> <span class="string">monitor :8100</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">http</span></span><br><span class="line"><span class="attr">option</span> <span class="string">httplog</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">enabnle</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">uri /stats</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">refresh 5s</span></span><br></pre></td></tr></table></figure><p><code>server rmq_node1 192.168.0.2:5672 check inter 5000 rise 2 fall 3 weight 1</code> ：</p><ul><li><code>server &lt;name&gt;</code> ：定义RabbitMQ服务的内部标识，此处rmq_node1指有含义的字符串名称，而非节点名称。</li><li><code>&lt;ip&gt;:&lt;port&gt;</code> ：定义RabbitMQ服务连接的IP地址和端口号。</li><li><code>check inter &lt;value&gt;</code> ：定义每隔多少毫秒检查RabbitMQ服务是否可用。</li><li><code>rise &lt;value&gt;</code> ：定义RabbitMQ服务在发生故障后，需要多少次健康检查才能被再次确认可用。</li><li><code>fall &lt;value&gt;</code> ：定义需要经历多少次失败的健康检查后，HAProxy才会停止使用此RabbitMQ服务。</li><li><code>weight &lt;value&gt;</code>  ：定义当前RabbitMQ服务的权重。</li></ul><p>调用 <code>haproxy -f haproxy.cfg</code> 命令运行服务后，可以查看相关界面 <code>http://192.168.0.9:8100/stats</code> 。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010132.png"></p><h3 id="2-3-使用Keepalived实现高可靠负载均衡"><a href="#2-3-使用Keepalived实现高可靠负载均衡" class="headerlink" title="2.3 使用Keepalived实现高可靠负载均衡"></a>2.3 使用Keepalived实现高可靠负载均衡</h3><p>如果HAProxy主机突然宕机或网卡失效，MQ集群没有故障，但所有外界客户端的连接都会断开（单点问题），HAProxy无法保证负载均衡服务的可靠性。</p><p>通过Keepalived能够通过自身健康检查、资源接管功能做高可用（双机热备），实现故障转移。</p><p>Keepalived采用VRRP（Vistual Router Redundancy Protocol，虚拟路由冗余协议），以软件的形式实现服务的热备功能。通常将两台Linux服务器组出一个热备组（Master和Backup），同一时间内热备组只有一个Master提供服务，Master会虚拟出一个公用的虚拟IP地址（VIP），只存在于Master上并对外提供服务。当Keepalived检测到Master宕机或服务故障，备份服务器自动接管VIP并成为Master，原Master从热备组中被移除待恢复后再自动加入到热备组，默认再抢占成Master起到故障转移的功能。</p><p>Keepalived工作在OSI的：</p><ul><li>第三层：定期向热备组中的服务器发送一个ICMP数据包来判断某台服务器是否故障，如果故障则从热备组移除。</li><li>第四层：以TCP端口的状态判断服务器是否故障，比如检查MQ端口5672，如果故障则从热备组中移除。</li><li>第七层：根据用户设定的策略（通常是一个自定义的检测脚本）判断服务器上的程序是否正常运行，如果故障则从热备组中移除。</li></ul><h4 id="（1）安装-1"><a href="#（1）安装-1" class="headerlink" title="（1）安装"></a>（1）安装</h4><p><a href="http://keepalived.org/download.html">官网下载</a>。</p><p>解压并安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tar zxvf keepalived-1.3.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> keepalived-1.3.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据系统选择对应的启动方式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/opt/keepalived --with-init=SYSV</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将安装后的keepalived加入系统服务（注意千万不要输错命令）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/sysconfig/keepalived /etc/sysconfig</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/sbin/keepalived /usr/sbin/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x /etc/init.d/keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chkconfig --add keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chkconfig keepalived on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keepalived会默认读取/etc/keepalived/keepalived.conf 配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir /etc/keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/keepalived/keepalived.conf /etc/keepalived</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后就可以重启、启动、关闭和查看keepalived状态</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived restart</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived start</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived stop</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived status</span></span><br></pre></td></tr></table></figure><h4 id="（2）配置-1"><a href="#（2）配置-1" class="headerlink" title="（2）配置"></a>（2）配置</h4><p>安装流程已创建了 <code>/etc/keepalived</code> 目录，并将 <code>keepalived.conf </code> 文件复制到此供keepalived读取。更改此文件使keepalived与HAProxy结合。</p><p>两台keepalived服务器通过VRRP交互，对外虚拟出VIP，keepalived与HAProxy部署在同一台机器上，一一配对，从而通过keepalived来实现HAProxy的双机热备。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010133.png"></p><p>调用链路：</p><ul><li>客户端通过VIP创建通信链路；</li><li>通信链路通过keepalived的Master节点路由到对应的HAProxy上；</li><li>HAProxy通过负载均衡算法将负载分发到集群中各个节点上。</li></ul><p>修改配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># keepalived配置文件</span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id NodeA # 路由ID、主/备的ID不能相同</span><br><span class="line">&#125;</span><br><span class="line"># 自定义监控脚本</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">script &quot;/etc/keepalived/check_haproxy.sh&quot;</span><br><span class="line">interval 5</span><br><span class="line">weight 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER # keepalived的角色</span><br><span class="line">interface eth0 # 指定监测网卡</span><br><span class="line">virtual_router_id 1</span><br><span class="line">priority 100 # 优先级，BACKUP机器上优先级要小于此值</span><br><span class="line">advert_int 1 # 设置主备之间的检测时间，单位为s</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass root123</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; # VIP地址，可以设置多个</span><br><span class="line">192.168.0.10</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>BACKUP机器大致相同，需要修改 <code>global_defs</code> 的 router_id 为如NodeB；修改 <code>vrrp_script chk_haproxy</code> 的state为BACKUP；最后将priority设置为小于100的值。注意virtual_router_id要保持一致。</p><p>为了防止HAProxy挂掉后，keepalived还在正常工作而未切换到Backup，需要补充一个脚本来检测HAProxy的状态。当服务挂掉，脚本自动重启服务，若不成功则关闭keepalived服务，从而可以切换到Backup。该脚本对应 <code>vrrp_script chk_haproxy</code> 中的 script ：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0];<span class="keyword">then</span></span><br><span class="line">   haproxy -f /opt/haproxy-1.7.8/haproxy.cfg</span><br><span class="line"><span class="keyword">fi</span> </span><br><span class="line">sleep 2</span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0];<span class="keyword">then</span></span><br><span class="line">       service keepalived stop</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>如此配置后，使用 <code>service keepalived start</code> 启动两台服务。客户端通过VIP地址 <code>192.168.0.10</code> 来连接MQ服务。</p><h4 id="（3）查看运行情况"><a href="#（3）查看运行情况" class="headerlink" title="（3）查看运行情况"></a>（3）查看运行情况</h4><p>查看Keepalived日志输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tail -f /var/<span class="built_in">log</span>/messages -n 200</span></span><br></pre></td></tr></table></figure><p>查看添加的VIP：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ip add show</span></span><br></pre></td></tr></table></figure><p>一般情况下，双机热备已足够满足应用需求。</p><h3 id="2-4-使用Keepalived-LVS实现负载均衡"><a href="#2-4-使用Keepalived-LVS实现负载均衡" class="headerlink" title="2.4 使用Keepalived+LVS实现负载均衡"></a>2.4 使用Keepalived+LVS实现负载均衡</h3><p>LVS，Linux Virtual Server，即Linux虚拟服务器。LVS是4层负载均衡，建立在OSI模型的传输层之上。LVS支持TCP/UDP的负载均衡，相对于如DNS域名流转解析、应用层负载的调度、客户端的调度等更高效。</p><p>通过LVS可以实现高可伸缩的、高可用的网络服务。LVS主要由3部分组成：</p><ul><li><strong>负载调度器（Load Balancer/Director）：</strong>负责将客户请求发送到一组服务器上执行，客户则认为服务来自一个IP地址。</li><li><strong>服务器池（Server Pool / RealServer）：</strong>一组真正执行客户端请求的服务器。</li><li><strong>共享存储（Shared Storage）：</strong>为服务器池提供一个共享的存储区，方便其拥有相同内容，提供相同服务。</li></ul><p>LVS的负载均衡方式：</p><ul><li><strong>VS/NAT：</strong>Virtual Server via Network Address Translation 的简称，最简单的方式，<strong>所有RealServer只需将自己的网关指向Director</strong>。客户端可以是任意的OS，但该方式下一个Director只能带动有限的RealServer。</li><li><strong>VS/TUN：</strong>Virtual Server via Direct Routing 的简称，IP隧道（IP Tunneling）是将一个IP报文封装在另一个IP报文的技术，<strong>使目标为一个IP地址的数据报文能够封装和转发到另一个IP地址</strong>。IP隧道技术又叫IP封装技术（IP encapsulation）。</li><li><strong>VS/DR：</strong>Virtual Server via Direct Routing 的简称，通过改写报文中的MAC地址部分来实现。Director和RealServer必须在物理上有一个网卡通过不间断的局域网相连。RealServer上绑定的VIP配置在各自Non-ARP网络设备上，Director的VIP地址对外可见；而RealServer则不可见，其地址既可以是内部地址，也可以是真实地址。</li></ul><p>LVS可以代替HAProxy，不需要额外的配置文件，直接集成在Keepalived的配置中，修改 <code>/etc/keepalived/keepalived.conf</code> ：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># keepalived配置文件（Master）</span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id NodeA # 路由ID、主/备的ID不能相同</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER # keepalived的角色</span><br><span class="line">interface eth0 # 指定监测网卡</span><br><span class="line">virtual_router_id 1</span><br><span class="line">priority 100 # 优先级，BACKUP机器上优先级要小于此值</span><br><span class="line">advert_int 1 # 设置主备之间的检测时间，单位为s</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass root123</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; # VIP地址，可以设置多个</span><br><span class="line">192.168.0.10</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">virtual_server 192.168.0.10 5672 &#123; # 设置虚拟服务器</span><br><span class="line">delay_loop 6 # 设置运行情况检查时间，单位为秒</span><br><span class="line"># 设置负载调度算法，有rr、wrr、lc、wlc、lblc、lblcr、dh、sh共8种</span><br><span class="line">lb_algo wrr # 加权轮询</span><br><span class="line">lb_kind DR # 设置LVS实现的负载均衡机制为VS/DR</span><br><span class="line"># 指定在一定的时间内来自统一IP的连接将会被转发到同一RealServer中</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocal TCP # 指定转发协议类型，包括TCP/UDP两种</span><br><span class="line"># LVS三大部分之一，此处特指RabbitMQ服务</span><br><span class="line">real_server 192.168.0.2 5672 &#123; # 配置服务节点</span><br><span class="line">weight 1 # 权重</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.3 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.4 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 为RabbitMQ Management插件设置负载均衡</span><br><span class="line">virtual_server 192.168.0.10 15672 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo wrr</span><br><span class="line">lb_kind DR</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocal TCP</span><br><span class="line">real_server 192.168.0.2 5672 &#123;</span><br><span class="line">weight 1</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.3 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.4 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Backup配置参考上一节。</p><ul><li>LVS主要工作是提供调度算法，把客户端请求按需求调度在RealServer中，</li><li>Keepalived主要工作是提供LVS控制器的一个冗余，并对RealServer进行健康检查，发现不健康的从集群剔除。</li><li>RealServer只负载提供服务。</li></ul><p>VS/DR模式下需要在RealServer上配置VIP，因为LVS把客户端的包转发给RealServer时，因为包的目的IP地址是VIP，在RealServer收到包后发现目的地址不是自己系统的IP会认为其不是发给自己的，就会丢弃此包，需要把这个IP地址绑定到网卡下。当发送应答包给客户端，RealServer就会把包的源和目的地址调换，直接恢复给客户端。</p><p>为所有RealServer的lo:0网卡创建启动脚本（vim /opt/realserver.sh）绑定VIP地址：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">VIP=192.168.0.10</span><br><span class="line">/etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">   /sbin/ipconfig lo:0 <span class="variable">$VIP</span> netmask 255.255.255.255 broadcast <span class="variable">$VIP</span></span><br><span class="line">   /sbin/route add -host <span class="variable">$VIP</span> dev lo:0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">   sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;RealServer Start Ok&quot;</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">   /sbin/ipconfig lo:0 down</span><br><span class="line">   /sbin/route del -host <span class="variable">$VIP</span> dev lo:0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">   islothere=`/sbin/ipconfig lo:0 | grep <span class="variable">$VIP</span> | wc -l`</span><br><span class="line">   isrothere=`netstat -rn | grep <span class="string">&quot;lo:0&quot;</span> | grep <span class="variable">$VIP</span> | wc -l`</span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$islothere</span> -eq 0]</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isrothere</span> -eq 0]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Stoped.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Running.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Running.&quot;</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage:<span class="variable">$0</span>&#123;start|stop&#125;&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p>掩码为 <code>255.255.255.255 </code> 表示广播地址是自身，不会将ARP发送到实际自己该属于的广播域，防止与LVS的VIP冲突而导致IP地址冲突。</p><p>为 <code>/opt/realserver.sh</code> 文件添加可执行权限后，运行 <code>/opt/realserver.sh start</code> 命令后可以通过 <code>ip add show</code> 命令查看网卡lo:0的状态，注意与Keepalived节点的网卡状态进行区分。</p><hr><p>参考：</p><p>🔗 《RabbitMQ实战指南》</p>]]></content>
    
    
    <summary type="html">学习RabbitMQ，第十章《扩展》，内容来自于《RabbitMQ实战指南》，内容：消息追踪，负载均衡等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="mom" scheme="http://linyishui.top/tags/mom/"/>
    
    <category term="rabbitmq" scheme="http://linyishui.top/tags/rabbitmq/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ（九）网络分区</title>
    <link href="http://linyishui.top/2021092201.html"/>
    <id>http://linyishui.top/2021092201.html</id>
    <published>2021-09-22T11:34:01.000Z</published>
    <updated>2021-09-26T06:14:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ（九）网络分区"><a href="#RabbitMQ（九）网络分区" class="headerlink" title="RabbitMQ（九）网络分区"></a>RabbitMQ（九）网络分区</h1><h2 id="一-MQ与网络分区"><a href="#一-MQ与网络分区" class="headerlink" title="一. MQ与网络分区"></a>一. MQ与网络分区</h2><h3 id="1-1-网络分区对RabbitMQ的影响"><a href="#1-1-网络分区对RabbitMQ的影响" class="headerlink" title="1.1 网络分区对RabbitMQ的影响"></a>1.1 网络分区对RabbitMQ的影响</h3><p>网络分区可能会引起消息丢失或服务不可用，可以通过重启或配置自动化处理来解决。</p><p>RabbitMQ一般使用Federation或Shovel来解决广域网中的问题，对于网络分区的容错性不高。局域网环境下也可能会出现网络分区（如中继设备或网卡出现故障）。</p><p>不同分区中的节点会认为不属于自身所在分区的节点都已经挂了，对于队列、交换器、绑定的操作仅对当前分区有效。RabbitMQ 3.1版本后会自动探测网络分区，并提供了相应配置来解决该问题。</p><p>若原集群中配置了镜像队列，其又牵扯到两个或更多网络分区的节点时，每个网络分区都会出现一个master节点，导致每个分区的该队列都相互独立。即使网络恢复，该问题也不能解决。</p><h3 id="1-2-为什么要引入网络分区？"><a href="#1-2-为什么要引入网络分区？" class="headerlink" title="1.2 为什么要引入网络分区？"></a>1.2 为什么要引入网络分区？</h3><p>镜像队列是一种环形的逻辑结构，如下图某队列有4个镜像，假设需要ack一条消息，会先在master节点上执行确认命令，之后转向B节点，再然后是C和D节点，D节点将执行操作返回给A节点，从而真正完成一条消息的确认。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010115.png"></p><p>这种数据一致性复制原理于ZK的Quorum（用于保证数据冗余和最终一致性的投票算法）不同，可以保证更强的一致性，在此模型下出现网络波动或网络故障会使数据链的性能大大降低。比如C节点网络异常，则整个数据链会被阻塞，继而相关服务也会被阻塞，所以需要<strong>引入网络分区来将异常节点剥离出整个分区，以确保RabbitMQ的可用性及可靠性</strong>。等待网络恢复后，再将异常节点加入集群。</p><p>通常网络分区都是由单个节点网络故障导致，所以会形成一个大分区和一个单节点的分区，若之前还配置了镜像，就可以在不影响服务可用性、不丢失消息的情况下从网络分区的情形下恢复。</p><h2 id="二-网络分区的判定"><a href="#二-网络分区的判定" class="headerlink" title="二. 网络分区的判定"></a>二. 网络分区的判定</h2><h3 id="2-1-RabbitMQ内部如何判定出现分区"><a href="#2-1-RabbitMQ内部如何判定出现分区" class="headerlink" title="2.1 RabbitMQ内部如何判定出现分区"></a>2.1 RabbitMQ内部如何判定出现分区</h3><p>RabbitMQ集群节点内部通信端口默认为25672，两两节点间都会进行信息交互。当某个节点出现网络故障、端口不通，导致与此节点的交互中断，此处会有一个<strong>超时判定机制来判定是否网络分区</strong>。</p><ul><li>net_ticktime，默认为60秒。当发生超时会有 <code>net_tick_timeout</code> 的信息报出。<strong>集群内部每个节点间会每隔四分之一个net_ticktime记一次应答</strong>。若有任何数据被写入节点中就认为已应答；<strong>连续4次都未应答的节点认为已处于down状态，其余节点可以将其剥离出当前分区</strong>。</li><li>heartbeat_time指客户端与RabbitMQ服务间通信的心跳时间，注意和net_ticktime的区别。</li></ul><p>连续4次应答的总时间T的取值范围：<code>0.75*net_ticktime &lt; T &lt; 1.25*net_ticktime</code></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010116.png"></p><p>默认情况下，可以再45s &lt; T &lt; 75s间判定出  <code>net_tick_timeout</code> 。</p><h3 id="2-2-判定出现网络分区的方法"><a href="#2-2-判定出现网络分区的方法" class="headerlink" title="2.2 判定出现网络分区的方法"></a>2.2 判定出现网络分区的方法</h3><h4 id="（1）查看RabbitMQ服务日志"><a href="#（1）查看RabbitMQ服务日志" class="headerlink" title="（1）查看RabbitMQ服务日志"></a>（1）查看RabbitMQ服务日志</h4><p>当Mnesia认定发生了网络分区后，会记录到RabbitMQ的服务日志中：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:18</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">Mnesia(&#x27;rabbit@node1&#x27;)<span class="symbol">:</span> ** ERROR ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, &#x27;rabbit@node2&#x27;&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）使用rabbitmqctl工具"><a href="#（2）使用rabbitmqctl工具" class="headerlink" title="（2）使用rabbitmqctl工具"></a>（2）使用rabbitmqctl工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl cluster_status</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 未发生网络分区：集群有三个节点</span></span><br><span class="line">[</span><br><span class="line">&#123;nodes,[&#123;disc, [rabbit@node1,rabbit@node2,rabbit@node3]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit@node2,rabbit@node3,rabbit@node1]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;&quot;rabbit@node1&quot;&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[]&#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发生网络分区：partitions内有相关内容，以下表示节点1和3分别与2发生了分区</span></span><br><span class="line">[</span><br><span class="line">&#123;nodes,[&#123;disc, [rabbit@node1,rabbit@node2,rabbit@node3]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit@node3,rabbit@node1]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;&quot;rabbit@node1&quot;&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[&#123;rabbit@node3,[rabbit@node2]&#125;,&#123;rabbit@node1,[rabbit@node2]&#125;]&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="（3）通过Web管理界面"><a href="#（3）通过Web管理界面" class="headerlink" title="（3）通过Web管理界面"></a>（3）通过Web管理界面</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010117.png"></p><h4 id="（4）通过HTTP-API来获取节点信息"><a href="#（4）通过HTTP-API来获取节点信息" class="headerlink" title="（4）通过HTTP API来获取节点信息"></a>（4）通过HTTP API来获取节点信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -i -u root:root123 -H <span class="string">&quot;content-type:application/json&quot;</span> -X GET http://localhost:15672/api/nodes</span></span><br></pre></td></tr></table></figure><ul><li>localhost：RabbitMQ服务器地址</li><li>/api/nodes：返回一个JSON字符串，其中有partitions相关项，若其中有内容则表示发生了网络分区。</li></ul><h2 id="三-模拟网络分区"><a href="#三-模拟网络分区" class="headerlink" title="三. 模拟网络分区"></a>三. 模拟网络分区</h2><p>通常很难观察到网络分区的发生，所以需要模拟出网络分区，方案有三类：</p><ul><li>iptables封禁/解封IP地址或端口号。</li><li>关闭/开启网卡。</li><li>挂起/恢复操作系统。</li></ul><h3 id="3-1-iptables方式"><a href="#3-1-iptables方式" class="headerlink" title="3.1 iptables方式"></a>3.1 iptables方式</h3><p>RabbitMQ集群内部节点通信端口默认为25672，封禁该端口来模拟出 <code>net_tick_timeout</code> ，再开启此端口让集群判定网络分区的发生。</p><p>假设集群有三个节点，我们在node2上执行如下命令来封禁25672端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> iptables -A INPUT -p tcp --dport 25672 -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -A OUTPUT -p tcp --dport 25672 -j DROP</span></span><br></pre></td></tr></table></figure><p>并同时监测各个节点的服务日志，当出现类似信息时表示已判定出 <code>net_tick_timeout</code> 。</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">10</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:11</span><span class="symbol">:53</span><span class="symbol">:03</span> ===</span><br><span class="line">rabbit on node rabbit@node2 down</span><br><span class="line"></span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">10</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:11</span><span class="symbol">:53</span><span class="symbol">:03</span> ===</span><br><span class="line">rabbit@node2 do<span class="symbol">wn:</span> net_tick_timeout</span><br></pre></td></tr></table></figure><p>或者可以等待75秒之后确保发生了 <code>net_tick_timeout</code> ，此时还需要等待node2网络恢复之后才会判定出现网络分区。</p><p>解封命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D OUTPUT 1</span></span><br></pre></td></tr></table></figure><p>node2节点已恢复与其它节点的通信，此时查看集群状态就可以发现出现了两个独立的分区。</p><p>上述是封禁端口来模拟，也可以封禁IP地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在node2上执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.2 -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.4 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D OUTPUT 1</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以分别在node1或3上执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.3 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br></pre></td></tr></table></figure><p>如果集群的节点部署跨网段，也可以采用封禁整个网络段的方式来模拟：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> node1 102.168.0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node2 102.168.1.3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node3 102.168.0.4</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.0/24 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br></pre></td></tr></table></figure><h3 id="3-2-封禁-解封网卡的方式"><a href="#3-2-封禁-解封网卡的方式" class="headerlink" title="3.2 封禁/解封网卡的方式"></a>3.2 封禁/解封网卡的方式</h3><p>与方式一同为模拟网络故障：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 先用ifconfig来查询当前网卡编号</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifconfig</span></span><br><span class="line">eth0 ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node2上关闭网卡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifdown eth0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待出net_tick_timeout后，再开启网卡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifup eth0</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过以下命令来模拟</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service network stop</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service network start</span></span><br></pre></td></tr></table></figure><h3 id="3-3-挂起-恢复操作系统的方式"><a href="#3-3-挂起-恢复操作系统的方式" class="headerlink" title="3.3 挂起/恢复操作系统的方式"></a>3.3 挂起/恢复操作系统的方式</h3><p>发生挂起的节点不会认为自己已经失败或停止工作，但其它节点会这样认为，比如集群中某个节点运行在一台笔记本上，当笔记本合上此节点就挂起。等待T时间后，出现 <code>net_tick_timeout</code> 后，再恢复挂起的节点即可复现网络分区。</p><h2 id="四-网络分区的影响"><a href="#四-网络分区的影响" class="headerlink" title="四. 网络分区的影响"></a>四. 网络分区的影响</h2><h3 id="4-1-未配置镜像"><a href="#4-1-未配置镜像" class="headerlink" title="4.1 未配置镜像"></a>4.1 未配置镜像</h3><h4 id="（1）对发送端的影响"><a href="#（1）对发送端的影响" class="headerlink" title="（1）对发送端的影响"></a>（1）对发送端的影响</h4><p>假设有三个节点，与交换器绑定关系如下：</p><table><thead><tr><th>节点名称</th><th>交换器</th><th>绑定</th><th>队列</th></tr></thead><tbody><tr><td>node1</td><td>exchange</td><td>rk1</td><td>queue1</td></tr><tr><td>node2</td><td>exchange</td><td>rk2</td><td>queue2</td></tr><tr><td>node3</td><td>exchange</td><td>rk3</td><td>queue3</td></tr></tbody></table><p>网络分区发生前，客户端1和2分别连接node1和node2并向对应队列发送消息，消息存入队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;exchange&quot;</span>, <span class="string">&quot;rk1&quot;</span>, <span class="keyword">true</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br></pre></td></tr></table></figure><p>使用iptables模拟网络分区后（关闭网卡会关闭客户端连接），使node1和node2处于不同分区中，对于客户端来说没有影响。</p><p>如果客户端1连接node1，并向queue2发送消息。模拟分区后，如果客户端在发送消息时将mandatory设置为true，网络分区之后可以通过抓包工具看到有Basic.Return将发送的消息返回，表示<strong>发生网络分区后，client1不能正确的将消息发送到queue2中</strong>。</p><p><strong>保证消息可靠性的方案：客户端若设置了ReturnListener来监听Basic.Return的信息，并附带有消息重传机制，则整个网络分区前后过程可以保证发送端消息不丢失。</strong></p><p>在网络分区发生前，queue1进程存在于node1节点，queue2则于node2节点，网络分区发生后，node1不会创建新的node2，所以client1将消息发送到exchange后并不能路由到queue2。若没有采用上述方案，就会发生消息丢失。不过此时仍可以通过指令看到队列：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl list_queues name</span></span><br><span class="line">...</span><br><span class="line">queue2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="（2）对消费端的影响"><a href="#（2）对消费端的影响" class="headerlink" title="（2）对消费端的影响"></a>（2）对消费端的影响</h4><p>假设网络分区发生前，客户端3和4分别连接node1和2，但分别消费queue2和queue1（不交换的情况和发送端一样无影响）。在网络分区发生后，客户端虽然不会报错，也可以消费到内容。但会有如已消费消息的ack失效等现象发生，网络分区恢复后，数据不会丢失。</p><p>如果分区之后，重启client3或有个新的客户端连接node1来消费queue2，会有报错：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.rabbitmq.client.ShutdownSignalException: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - home node <span class="string">&#x27;rabbit@node2&#x27;</span> <span class="keyword">of</span> durable queue <span class="string">&#x27;queue2&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;/&#x27;</span> <span class="keyword">is</span> down <span class="keyword">or</span> inaccessible, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=20)</span></span></span><br></pre></td></tr></table></figure><p>node1的服务日志中也有相关记录：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">12</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:14</span><span class="symbol">:48</span> ===</span><br><span class="line">Channel error on connection &lt;<span class="number">0.9538</span>.<span class="number">9</span>&gt; (<span class="number">192.168</span>.<span class="number">0.9</span><span class="symbol">:61294</span> -&gt; <span class="number">192.168</span>.<span class="number">0.2</span><span class="symbol">:5672</span>, vho<span class="symbol">st:</span> &#x27;/&#x27;, us<span class="symbol">er:</span> &#x27;root&#x27;), channel <span class="symbol">1:</span></span><br><span class="line">&#123;amqp_error,not_found,<span class="string">&quot;home node &#x27;rabbit@ndoe2&#x27; of durable queue &#x27;queue2&#x27; in vhost &#x27;/&#x27; is down or inaccessible&quot;</span>, &#x27;basic.consume&#x27;&#125;</span><br></pre></td></tr></table></figure><p>未配置镜像的集群，在网络分区发生后，队列也会随着节点而分散在各自的分区中。</p><ul><li>对于消息发送方，可以成功发送消息，但会有路由失败的现象，需要配合mandatory等机制保证消息的可靠性。</li><li>对于消息消费方，可能会有诡异、不可预知的现象发生，如已消费消息的ack失效。</li><li>如果网络分区发生后，客户端与某分区重新建立通信链路，其分区若没有对应得队列进程，则会由异常抛出。</li><li>如果从网络分区中恢复后，数据不会丢失，但客户端会重复消费。</li></ul><h3 id="4-2-已配置镜像"><a href="#4-2-已配置镜像" class="headerlink" title="4.2 已配置镜像"></a>4.2 已配置镜像</h3><p>已配置镜像队列的情况要比未配置复杂得多。假设集群有三个节点，采用iptables方式将集群模拟分裂为两个网络分区[node1, node3]和[node2]。</p><p>镜像队列：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ha-mode</span>:<span class="string">exactly</span></span><br><span class="line"><span class="meta">ha-param</span>:<span class="string">2</span></span><br><span class="line"><span class="meta">ha-sync-mode</span>:<span class="string">automatic</span></span><br></pre></td></tr></table></figure><p>分区之前：</p><table><thead><tr><th>队列</th><th>master</th><th>slave</th></tr></thead><tbody><tr><td>queue1</td><td>node1</td><td>node3</td></tr><tr><td>queue2</td><td>node2</td><td>node3</td></tr><tr><td>queue3</td><td>node3</td><td>node2</td></tr></tbody></table><p>分区之后，[node1, node3]分区中的队列有了新的部署，queue1未发生变化，queue2因为原宿主节点node2被剥离，所以node3提升为master，同时选择node1作为slave。queue3则重新选择node1为新的slave：</p><table border="1" style="margin-top:10">    <tr>        <td rowspan="2" align="center">队列</td>         <td colspan="2" align="center">[node1, node3]分区</td>         <td colspan="2" align="center">[node2]分区</td>    </tr>    <tr>        <td align="center">master</td>            <td align="center">slave</td>            <td align="center">master</td>            <td align="center">slave</td>        </tr>    <tr>        <td align="center">queue1</td>           <td align="center">node1</td>         <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node3</td>     </tr>    <tr>        <td align="center">queue2</td>           <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node2</td>         <td align="center">[]</td>     </tr>    <tr>        <td align="center">queue3</td>           <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node2</td>         <td align="center">[]</td>     </tr></table><p>对于queue1，网络分区前后不会对生产和消费造成影响。</p><p>对于queue2和queue3则会和未配置镜像一样，恢复后有可能会有数据丢失。</p><p>当有新的slave出现时，会自动同步master的数据，在同步的过程中，集群的整个服务都不可用，客户端连接会被阻塞。如果master中有大量的消息堆积，必然会造成slave的同步时间增长，进一步影响了集群服务的可用性。若配置了 <code>ha-sync-mode=manual</code> 在新的slave创建时不会同步master上旧的数据，若master节点发生了异常，则此部分数据会丢失。</p><h3 id="4-3-网络分区造成的消息丢失如何解决？"><a href="#4-3-网络分区造成的消息丢失如何解决？" class="headerlink" title="4.3 网络分区造成的消息丢失如何解决？"></a>4.3 网络分区造成的消息丢失如何解决？</h3><ul><li>首先，消息发送端要有处理 <code>Basic.Return</code> 的能力。</li><li>其次，检测到网络分区发生后，要迅速的挂起所有生产者进程。</li><li>之后，连接每个节点消费分区中的所有队列数据。在消费完之后再处理网络分区。</li><li>最后，再从网络分区中恢复生产者的进程。</li><li>需要注意整个过程会伴有大量的消息重复，消费者客户端要做好相应的幂等性处理。</li></ul><p>还有方案：<strong>集群迁移</strong>，将所有旧集群资源迁移到新集群来解决问题。</p><h2 id="五-如何处理网络分区"><a href="#五-如何处理网络分区" class="headerlink" title="五. 如何处理网络分区"></a>五. 如何处理网络分区</h2><h3 id="5-1-手动处理网络分区"><a href="#5-1-手动处理网络分区" class="headerlink" title="5.1 手动处理网络分区"></a>5.1 手动处理网络分区</h3><p>从网络分区中恢复，首先要挑选一个信任分区，该分区有决定Mnesia内容的权限，发生在其余分区的改变不会记录在Mnesia而直接丢弃。然后重启非信任分区中的节点，若此时还有网络分区的告警，则紧接着重启信任分区中的节点。</p><h4 id="（1）如何挑选信任分区？"><a href="#（1）如何挑选信任分区？" class="headerlink" title="（1）如何挑选信任分区？"></a>（1）如何挑选信任分区？</h4><p>挑选信任分区的优先级由高至低：</p><ul><li>分区中要有disc节点；</li><li>分区中节点数最多；</li><li>分区中队列数最多；</li><li>分区中客户端连接最多。</li></ul><p>（若有多个分区这些条件都相等，则随机挑选）</p><h4 id="（2）如何重启节点？"><a href="#（2）如何重启节点？" class="headerlink" title="（2）如何重启节点？"></a>（2）如何重启节点？</h4><p>重启RabbitMQ的方式：</p><ol><li><code>rabbitmqctl stop</code> 关闭，<code>rabbitmq-server -detached</code> 启动（同时重启Erlang虚拟机和RabbitMQ）；</li><li><code>rabbitmqctl stop_app</code> 关闭，<code>rabbitmqctl start_app</code> 启动（只重启RabbitMQ，从网络分区恢复推荐该种）。</li></ol><h4 id="（3）重启的顺序如何确定？"><a href="#（3）重启的顺序如何确定？" class="headerlink" title="（3）重启的顺序如何确定？"></a>（3）重启的顺序如何确定？</h4><p>配置镜像队列出现的漂移现象：依次关闭节点，导致master最终都漂移到一个节点上，之后重启节点只会增加slave的个数，而不会改变master的分布。对于RabbitMQ来说，除了发布消息其余操作都在master上完成，因此压力都集中到了单个节点，不能很好的负载均衡。</p><p>重启顺序的两种方式：</p><ol><li>停止其它非信任分区中的所有节点，然后再启动每一个节点，如果此时还有网络分区的告警，则再重启信任分区中的节点以清除告警。</li><li>关闭整个集群的节点，然后再启动每一个节点，需要确保第一个节点在信任分区。</li></ol><p>如果采用挨个节点重启的方式，会有Mnesia内容权限归属问题，也有可能引起二次网络分区。</p><p>解决镜像队列漂移问题，可以在重启前先删除镜像队列的配置（需要在每个队列上都删除镜像队列）：</p><ul><li><p>通过命令删除：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl clear_policy [-p vhost] &#123;mirror_queue_name&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>通过HTTP API或WEB界面删除：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -s -u &#123;username:password&#125; -X DELETE http://localhost:15672/api/policies/default/&#123;mirror_queue_name&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（4）如何判断已从网络分区恢复？"><a href="#（4）如何判断已从网络分区恢复？" class="headerlink" title="（4）如何判断已从网络分区恢复？"></a>（4）如何判断已从网络分区恢复？</h4><p>可以参考第二节的内容，如使用 <code>rabbitmqctl cluster_status</code> 命令检测输出的partitions是否有节点信息。也可以通过Web界面或HTTP API的方式。</p><h4 id="（5）总结步骤"><a href="#（5）总结步骤" class="headerlink" title="（5）总结步骤"></a>（5）总结步骤</h4><ol><li>挂起生产者和消费者进程，从而减少消息不必要的丢失，如果进程数过多且情况紧急，可以跳过该步骤。</li><li>删除镜像队列的配置。</li><li>挑选信任分区。</li><li>关闭非信任分区的节点，采用 <code>rabbitmqctl stop_app</code> 关闭。</li><li>启动非信任分区的节点，采用 <code>rabbitmqctl start_app</code> 启动。</li><li>检查网络分区是否恢复，如果已恢复则跳至步骤8，若还有网络分区报警则进行步骤7。</li><li>重启信任分区中的节点。</li><li>添加镜像队列的配置。</li><li>恢复生产者和消费者进程。</li></ol><h3 id="5-2-自动处理网络分区"><a href="#5-2-自动处理网络分区" class="headerlink" title="5.2 自动处理网络分区"></a>5.2 自动处理网络分区</h3><p>RabbitMQ提供了三种自动处理网络分区的方法：</p><ul><li>pause-minority模式</li><li>pause-if-all-down模式</li><li>autoheal模式</li><li>默认为ignore模式，即不自动处理。</li></ul><p>在配置文件 <code>rabbitmq.config</code> 中配置 <code>cluster_partition_handling</code> 参数：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, igbore&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="（1）pause-minority模式"><a href="#（1）pause-minority模式" class="headerlink" title="（1）pause-minority模式"></a>（1）pause-minority模式</h4><p>该模式下，发生网络分区时，集群中的节点观察到某些节点down掉时会自动检测自身是否处于少数派（分区中的节点小于或等于集群中一半的节点数），RabbitMQ会自动关闭这些节点的运作。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, pause-minority&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>根据CAP原理，此处保证了分区耐受性P，确保在发生网络分区的情况下大多数同个分区的节点可以继续运行。少数派的节点在分区开始时关闭，分区结束后启动（只关闭RabbitMQ，不关闭Erlang）。处于关闭的节点每秒检测依次是否可连通到剩余集群，可以时启动自己。</p><p>当集群中只有两个节点时不适合采用该模式，因为任何一个节点失败发生网络分区时，两个节点都会关闭，在网络恢复时两个节点自动恢复网络分区，也有可能保持关闭状态。对于2V2和3V3等对等分裂的情况，在跨机器部署时很有可能发生，会关闭这些分区内所有节点。</p><h4 id="（2）pause-if-all-down模式"><a href="#（2）pause-if-all-down模式" class="headerlink" title="（2）pause-if-all-down模式"></a>（2）pause-if-all-down模式</h4><p>该模式下，集群中的节点在和所配置列表中任何节点不能交互时才会关闭，配置如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, </span><br><span class="line">             &#123;pause_if_all_down, [&#x27;rabbit@node1&#x27;], ignore&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>如果一个节点与node1无法通信，则会关闭自身的RabbitMQ。</li><li>如果是node1本身发生了故障造成网络不可用，其它节点都是正常，则所有节点都要关闭RabbitMQ，等待node1恢复后，各个节点再启动MQ从网络分区中恢复。</li></ul><p>该模式下有ignore和autoheal两种配置，如果出现上一个所述的对等分裂，两台机器部署4个节点，机器间通信异常，但机器上两个节点保持通信，假设又配置了两个机器各一个节点，则这四个节点都不会自行关闭。此时把配置中的ignore改为autoheal可以处理这种情况。</p><h4 id="（3）autoheal模式"><a href="#（3）autoheal模式" class="headerlink" title="（3）autoheal模式"></a>（3）autoheal模式</h4><p>该模式下发生网络分区时，RabbitMQ会自动决定一个获胜的分区，然后重启不在这个分区中的节点来恢复网络分区。</p><p>获胜分区的选择优先级从高到低：</p><ul><li>客户端连接数最多；</li><li>节点数最多；</li><li>节点名称的字典序。</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, autoheal&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>对于pause-minority模式，关闭节点的状态是网络故障时（判断出net_tick_timout）会关闭少数派分区中的节点，等待网络恢复之后（即出现网络分区后）启动关闭的节点来从网络分区中恢复。</li><li>auto模式再判定出net_tick_timout时不做动作，要等到网络恢复后才重启非获胜分区的节点。</li></ul><h4 id="（4）挑选哪种模式"><a href="#（4）挑选哪种模式" class="headerlink" title="（4）挑选哪种模式"></a>（4）挑选哪种模式</h4><p>允许MQ自动处理网络分区并不一定会又正面的效果，如果MQ处于一个不可靠的网络环境下，需要使用Federation或Shovel，就算恢复后也要谨防二次网络分区。</p><ul><li>ignore：发生网络分区时不做任何动作，需要人工介入。</li><li>pause-minority：对于对等分区的处理不够优雅，可能会关闭所有的节点。可以应用于非跨机架、奇数节点数的集群中。</li><li>pause-if-all-down：对于受信节点的选择尤为考究，尤其是集群中所有节点配置相同的情况下，可以处理对等分区的情况。</li><li>autoheal：可以处理各种情况下的网络分区，但如果集群中有节点处于非运行状态，该模式会失效。</li></ul><h2 id="六-多分区的案例"><a href="#六-多分区的案例" class="headerlink" title="六. 多分区的案例"></a>六. 多分区的案例</h2><p>当集群中物理机是多网卡，当某个节点网卡发生故障可能会发生多个分区的情况。</p><p>假设集群有6个节点，每个节点的物理机都是4网卡（eth0到eth3），并采用bind0的绑定模式。当node6的eth0发生故障后，整个集群演变为6个分区，每个节点都是一个独立的分区。</p><p>网络分区前：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010118.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010119.png"></p><p>当node6网被关闭，对于bind0模式，交换机无法感知eth0网卡的故障，但node6节点能够感知本地eth0的故障。对于node3节点，其与node6的eth0网卡建立的长连接没有关闭，node3会向node6重试发送数据，但node6无法回应，除非主动关闭或等待长连接超时（默认7200s，即2小时）链路才会关闭。</p><p>node6网卡关闭后，node1、node3和node6发生变化：</p><ol><li><p>与node6的eth0链路不通，node3等待net_ticktime的超时。node3相关日志：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbit on <span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down</span><br><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down: net_tick_timeout</span><br></pre></td></tr></table></figure></li><li><p>待超时后，主动关闭连接。node3相关日志：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down: connection_closed</span><br></pre></td></tr></table></figure><p>同时Erlang虚拟机尝试让node3与node6重新连接，因为node6其它网卡正常，所以连接可以正确建立。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; up</span><br></pre></td></tr></table></figure></li><li><p>判定node3和node6之间产生了网络分区。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mnesia(<span class="string">&#x27;rabbit@node3&#x27;</span>): ** <span class="builtin-name">ERROR</span> ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, <span class="string">&#x27;rabbit@node6&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>此时node3和node1还处于连通状态，同样node6和node1也处于连通状态，node3日志：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Partial <span class="keyword">partition</span> detected:</span><br><span class="line"><span class="operator">*</span> We saw DOWN <span class="keyword">from</span> rabbit<span class="variable">@node6</span></span><br><span class="line"><span class="operator">*</span> We can still see rabbit<span class="variable">@node1</span> which can see rabbit<span class="variable">@node6</span></span><br><span class="line">We will therefore intentionally <span class="keyword">disconnect</span> <span class="keyword">from</span> rabbit<span class="variable">@node1</span></span><br></pre></td></tr></table></figure><p>表示node3和node6发生了网络分区，但node3发现node1和node6内部通信还未断，此时认为node1和node6处于同一个分区，node3准备主动关闭与node1的通信，所以node1和node3也发生了分区。</p></li><li><p>同时，对于node6来说，node1和node3还处于同一分区，所以node6也要讲node1置于node6本身分区之外，所以三个节点都将处于不同分区。</p><p>node1日志：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:54</span> ===</span><br><span class="line">Partial partition detect<span class="symbol">ed:</span></span><br><span class="line">* We saw DOWN from rabbit@node3</span><br><span class="line">* We can still see rabbit@node4 which can see rabbit@node3</span><br><span class="line">We will therefore intentionally disconnect from rabbit@node4</span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">node &#x27;rabbit@node4&#x27; do<span class="symbol">wn:</span> disconnect</span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">node &#x27;rabbit@node4&#x27; up</span><br><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">Mnesia(&#x27;rabbit@node1&#x27;)<span class="symbol">:</span> ** ERROR ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, &#x27;rabbit@node4&#x27;&#125;</span><br></pre></td></tr></table></figure><p>此时node1察觉node4与node3还有内部通信交换，主动将node4剥离出自身分区。</p></li><li><p>以此下去直到每个节点都分离出自己的分区。</p></li></ol><p>对于这种情况采用自动模式的效果：</p><ul><li>pause_if_all_down：挑选一个节点作为受信节点，重启剩余5个节点恢复。</li><li>autoheal：同样，查看日志可以发现，会等网络分区判定之后罗列出所有分区信息，再重启非获胜分区节点（同样是5个）。</li><li>pause_minority：最优雅，当有节点检测到net_tick_timeout后自行重启当前节点，阻止了网络分区进一步演变，处理效率最高。</li></ul><hr><p>参考：</p><p>🔗 《RabbitMQ实战指南》</p>]]></content>
    
    
    <summary type="html">学习RabbitMQ，第九章《网络分区》，内容来自于《RabbitMQ实战指南》，内容：MQ与网络分区、如何判定网络分区、模拟网络分区、网络分区的影响、如何处理网络分区等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="mom" scheme="http://linyishui.top/tags/mom/"/>
    
    <category term="rabbitmq" scheme="http://linyishui.top/tags/rabbitmq/"/>
    
  </entry>
  
  <entry>
    <title>Java诊断工具-Arthas</title>
    <link href="http://linyishui.top/2021091601.html"/>
    <id>http://linyishui.top/2021091601.html</id>
    <published>2021-09-16T12:51:44.000Z</published>
    <updated>2021-09-22T11:21:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java诊断工具-Arthas"><a href="#Java诊断工具-Arthas" class="headerlink" title="Java诊断工具-Arthas"></a>Java诊断工具-Arthas</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><ul><li>官网：<a href="https://arthas.aliyun.com/zh-cn/">Arthas 应用诊断利器</a></li><li>Alibaba开源的Java诊断工具；在线排查问题，无需重启；动态跟踪Java代码；实时监控JVM状态。</li><li>支持JDK6+；支持Linux/Mac/Windows;命令行式交互模式。</li></ul><p>解决如下问题：</p><ol><li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li><li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li><li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li><li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li><li>是否有一个全局视角来查看系统的运行状况？</li><li>有什么办法可以监控到JVM的实时运行状态？</li><li>怎么快速定位应用的热点，生成火焰图？</li><li>怎样直接从JVM内查找某个类的实例？</li></ol><h2 id="二-教程"><a href="#二-教程" class="headerlink" title="二. 教程"></a>二. 教程</h2><p>内容全部来源自官网。</p><h3 id="2-1-入门"><a href="#2-1-入门" class="headerlink" title="2.1 入门"></a>2.1 入门</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载一个Jar包，并启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://arthas.aliyun.com/math-game.jar</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar math-game.jar</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新窗口下载Arthas的启动Jar包，并启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://arthas.aliyun.com/arthas-boot.jar</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动后列出所有Java进程，输入对应</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dashboard 命令可以查看当前系统的实时数据面板</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dashboard</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入 Q 或者 Ctrl+C 可以退出dashboard命令。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> thread 1 命令会打印线程ID 1的栈。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> thread 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Arthas支持管道，可以用 thread 1 | grep <span class="string">&#x27;main(&#x27;</span> 查找到main class。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到main class是demo.MathGame：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> thread 1 | grep <span class="string">&#x27;main(&#x27;</span></span></span><br><span class="line">    at demo.MathGame.main(MathGame.java:17)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过 sc 命令来查找JVM里已加载的类：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sc -d *MathGame</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过 jad 命令来反编译代码：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> jad demo.MathGame</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过watch命令可以查看函数的参数/返回值/异常信息。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> watch demo.MathGame primeFactors returnObj</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入 Q 或者 Ctrl+C 退出watch命令。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过vmtool命令，可以搜索内存对象。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vmtool --action getInstances --className java.lang.String --<span class="built_in">limit</span> 10</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用 <span class="built_in">exit</span> 或者 quit 命令可以退出Arthas。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出Arthas之后，还可以再次用 java -jar arthas-boot.jar 来连接。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span>/quit命令只是退出当前session，arthas server还在目标进程中运行。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 想完全退出Arthas，可以执行 stop 命令。</span></span><br></pre></td></tr></table></figure><p>安装：<a href="https://arthas.aliyun.com/doc/install-detail.html">Arthas Install — Arthas 3.5.4 文档 (aliyun.com)</a></p><h3 id="2-2-进阶"><a href="#2-2-进阶" class="headerlink" title="2.2 进阶"></a>2.2 进阶</h3><h4 id="2-2-1-查看JVM信息"><a href="#2-2-1-查看JVM信息" class="headerlink" title="2.2.1 查看JVM信息"></a>2.2.1 查看JVM信息</h4><ul><li><p>sysprop：</p><p>可以打印所有的System Properties信息。</p><p>也可以指定单个key： <code>sysprop java.version</code></p><p>也可以通过<code>grep</code>来过滤： <code>sysprop | grep user</code></p><p>可以设置新的value： <code>sysprop testKey testValue</code></p></li><li><p>sysenv：<code>sysenv</code> 命令可以获取到环境变量。和<code>sysprop</code>命令类似。</p></li><li><p>jvm：<code>jvm</code> 命令会打印出<code>JVM</code>的各种详细信息。</p></li><li><p>dashboard：<code>dashboard</code> 命令可以查看当前系统的实时数据面板。输入 <code>Q</code> 或者 <code>Ctrl+C</code> 可以退出dashboard命令。</p></li></ul><h4 id="2-2-2-Tips"><a href="#2-2-2-Tips" class="headerlink" title="2.2.2 Tips"></a>2.2.2 Tips</h4><ul><li><p>help：Arthas里每一个命令都有详细的帮助信息。可以用<code>-h</code>来查看。帮助信息里有<code>EXAMPLES</code>和<code>WIKI</code>链接。比如：<code>sysprop -h</code></p></li><li><p>自动补全：Arthas支持丰富的自动补全功能，在使用有疑惑时，可以输入<code>Tab</code>来获取更多信息。</p><p>比如输入 <code>sysprop java.</code> 之后，再输入<code>Tab</code>，会补全出对应的key：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysprop java.</span></span><br><span class="line">java.runtime.name             java.protocol.handler.pkgs    java.vm.version</span><br><span class="line">java.vm.vendor                java.vendor.url               java.vm.name</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p>readline的快捷键支持：</p><p>Arthas支持常见的命令行快捷键，比如<code>Ctrl + A</code>跳转行首，<code>Ctrl + E</code>跳转行尾。</p><p>更多的快捷键可以用 <code>keymap</code> 命令查看。</p></li><li><p>历史命令的补全：</p><p>如果想再执行之前的命令，可以在输入一半时，按<code>Up/↑</code> 或者 <code>Ddown/↓</code>，来匹配到之前的命令。</p><p>比如之前执行过<code>sysprop java.version</code>，那么在输入<code>sysprop ja</code>之后，可以输入<code>Up/↑</code>，就会自动补全为<code>sysprop java.version</code>。</p><p>如果想查看所有的历史命令，也可以通过 <code>history</code> 命令查看到。</p></li><li><p>pipeline：</p><p>Arthas支持在pipeline之后，执行一些简单的命令，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysprop | grep java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sysprop | wc -l</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2-3-sc-sm-查看已加载的类"><a href="#2-2-3-sc-sm-查看已加载的类" class="headerlink" title="2.2.3 sc/sm 查看已加载的类"></a>2.2.3 sc/sm 查看已加载的类</h4><ul><li><p>sc：</p><p><code>sc</code> 命令可以查找到所有JVM已经加载到的类。</p><p>如果搜索的是接口，还会搜索所有的实现类。比如查看所有的<code>Filter</code>实现类：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc javax.servlet.Filter</span></span><br></pre></td></tr></table></figure><p>通过<code>-d</code>参数，可以打印出类加载的具体信息，很方便查找类加载问题。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d javax.servlet.Filter</span></span><br></pre></td></tr></table></figure><p><code>sc</code>支持通配，比如搜索所有的<code>StringUtils</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc *StringUtils</span></span><br></pre></td></tr></table></figure></li><li><p>sm：</p><p><code>sm</code>命令则是查找类的具体函数。比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm java.math.RoundingMode</span></span><br></pre></td></tr></table></figure><p>通过<code>-d</code>参数可以打印函数的具体属性：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm -d java.math.RoundingMode</span></span><br></pre></td></tr></table></figure><p>也可以查找特定的函数，比如查找构造函数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm java.math.RoundingMode &lt;init&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2-4-Jad反编译代码"><a href="#2-2-4-Jad反编译代码" class="headerlink" title="2.2.4 Jad反编译代码"></a>2.2.4 Jad反编译代码</h4><p>可以通过 <code>jad</code> 命令来反编译代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad com.example.demo.arthas.user.UserController</span></span><br></pre></td></tr></table></figure><p>通过<code>--source-only</code>参数可以只打印出在反编译的源代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad --source-only com.example.demo.arthas.user.UserController</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5-Ognl动态执行代码"><a href="#2-2-5-Ognl动态执行代码" class="headerlink" title="2.2.5 Ognl动态执行代码"></a>2.2.5 Ognl动态执行代码</h4><p>在Arthas里，有一个单独的<code>ognl</code>命令，可以动态执行代码。</p><h5 id="调用static函数"><a href="#调用static函数" class="headerlink" title="调用static函数"></a>调用static函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl <span class="string">&#x27;@java.lang.System@out.println(&quot;hello ognl&quot;)&#x27;</span></span></span><br></pre></td></tr></table></figure><p>可以检查<code>Terminal 1</code>（不是arthas的Terminal 2）里的进程输出，可以发现打印出了<code>hello ognl</code>。</p><h5 id="查找UserController的ClassLoader"><a href="#查找UserController的ClassLoader" class="headerlink" title="查找UserController的ClassLoader"></a>查找UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><p>注意hashcode是变化的，需要先查看当前的ClassLoader信息，提取对应ClassLoader的hashcode。</p><p>如果你使用<code>-c</code>，你需要手动输入hashcode：<code>-c &lt;hashcode&gt;</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ognl -c 1be6f5c3 @com.example.demo.arthas.user.UserController@logger</span><br></pre></td></tr></table></figure><p>对于只有唯一实例的ClassLoader可以通过<code>--classLoaderClass</code>指定class name，使用起来更加方便：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader  @org.springframework.boot.SpringApplication@logger</span><br><span class="line">@Slf4jLocationAwareLog[</span><br><span class="line">    FQCN=@String[org.apache.commons.logging.LogAdapter<span class="variable">$Slf4jLocationAwareLog</span>],</span><br><span class="line">    name=@String[org.springframework.boot.SpringApplication],</span><br><span class="line">    logger=@Logger[Logger[org.springframework.boot.SpringApplication]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>--classLoaderClass</code> 的值是ClassLoader的类名，只有匹配到唯一的ClassLoader实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p><h5 id="获取静态类的静态字段"><a href="#获取静态类的静态字段" class="headerlink" title="获取静态类的静态字段"></a>获取静态类的静态字段</h5><p>获取<code>UserController</code>类里的<code>logger</code>字段：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader @com.example.demo.arthas.user.UserController@logger</span></span><br></pre></td></tr></table></figure><p>还可以通过<code>-x</code>参数控制返回值的展开层数。比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -x 2 @com.example.demo.arthas.user.UserController@logger</span></span><br></pre></td></tr></table></figure><h5 id="执行多行表达式，赋值给临时变量，返回一个List"><a href="#执行多行表达式，赋值给临时变量，返回一个List" class="headerlink" title="执行多行表达式，赋值给临时变量，返回一个List"></a>执行多行表达式，赋值给临时变量，返回一个List</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span></span><br><span class="line">@ArrayList[</span><br><span class="line">    @String[/Library/Java/JavaVirtualMachines/jdk1.8.0_162.jdk/Contents/Home/jre],</span><br><span class="line">    @String[Java(TM) SE Runtime Environment],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h5><p>在Arthas里<code>ognl</code>表达式是很重要的功能，在很多命令里都可以使用<code>ognl</code>表达式。</p><p>一些更复杂的用法，可以参考：</p><ul><li>OGNL特殊用法请参考：<a href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71</a></li><li>OGNL表达式官方指南：<a href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li></ul><h3 id="2-3-案例"><a href="#2-3-案例" class="headerlink" title="2.3 案例"></a>2.3 案例</h3><h4 id="2-3-1-案例-排查函数调用异常"><a href="#2-3-1-案例-排查函数调用异常" class="headerlink" title="2.3.1 案例: 排查函数调用异常"></a>2.3.1 案例: 排查函数调用异常</h4><h5 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h5><p>目前，访问 <a href="http://localhost/user/0">http://localhost/user/0</a> ，会返回500异常：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost/user/0</span></span><br><span class="line">&#123;&quot;timestamp&quot;:1550223186170,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;exception&quot;:&quot;java.lang.IllegalArgumentException&quot;,&quot;message&quot;:&quot;id &lt; 1&quot;,&quot;path&quot;:&quot;/user/0&quot;&#125;</span><br></pre></td></tr></table></figure><p>但请求的具体参数，异常栈是什么呢？</p><h5 id="查看UserController的-参数-异常"><a href="#查看UserController的-参数-异常" class="headerlink" title="查看UserController的 参数/异常"></a>查看UserController的 参数/异常</h5><p>在Arthas里执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><ol><li>第一个参数是类名，支持通配</li><li>第二个参数是函数名，支持通配</li></ol><p>访问 <code>curl http://localhost/user/0</code> ,<code>watch</code>命令会打印调用的参数和异常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost <span class="keyword">in</span> 53 ms.</span><br><span class="line">ts=2019-02-15 01:35:25; [cost=0.996655ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>可以看到实际抛出的异常是<code>IllegalArgumentException</code>。</p><p>可以输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出watch命令。</p><p>如果想把获取到的结果展开，可以用<code>-x</code>参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2</span></span><br></pre></td></tr></table></figure><h5 id="返回值表达式"><a href="#返回值表达式" class="headerlink" title="返回值表达式"></a>返回值表达式</h5><p>在上面的例子里，第三个参数是<code>返回值表达式</code>，它实际上是一个<code>ognl</code>表达式，它支持一些内置对象：</p><ul><li>loader</li><li>clazz</li><li>method</li><li>target</li><li>params</li><li>returnObj</li><li>throwExp</li><li>isBefore</li><li>isThrow</li><li>isReturn</li></ul><p>你可以利用这些内置对象来组成不同的表达式。比如返回一个数组：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params[0], target, returnObj&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p>更多参考： <a href="https://arthas.aliyun.com/doc/advice-class.html">https://arthas.aliyun.com/doc/advice-class.html</a></p><h5 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h5><p><code>watch</code>命令支持在第4个参数里写条件表达式，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * returnObj <span class="string">&#x27;params[0] &gt; 100&#x27;</span></span></span><br></pre></td></tr></table></figure><p>当访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/1">https://2886795326-80-host12nc.environments.katacoda.com/user/1</a> 时，<code>watch</code>命令没有输出</p><p>当访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/101">https://2886795326-80-host12nc.environments.katacoda.com/user/101</a> 时，<code>watch</code>会打印出结果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch com.example.demo.arthas.user.UserController * returnObj <span class="string">&#x27;params[0] &gt; 100&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost <span class="keyword">in</span> 47 ms.</span><br><span class="line">ts=2019-02-13 19:42:12; [cost=0.821443ms] result=@User[</span><br><span class="line">    id=@Integer[101],</span><br><span class="line">    name=@String[name101],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="当异常时捕获"><a href="#当异常时捕获" class="headerlink" title="当异常时捕获"></a>当异常时捕获</h5><p><code>watch</code>命令支持<code>-e</code>选项，表示只捕获抛出异常时的请求：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&quot;&#123;params[0],throwExp&#125;&quot;</span> -e</span></span><br></pre></td></tr></table></figure><h5 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h5><p>watch命令支持按请求耗时进行过滤，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, returnObj&#125;&#x27;</span> <span class="string">&#x27;#cost&gt;200&#x27;</span></span></span><br></pre></td></tr></table></figure><h4 id="2-3-2-案例-热更新代码"><a href="#2-3-2-案例-热更新代码" class="headerlink" title="2.3.2 案例: 热更新代码"></a>2.3.2 案例: 热更新代码</h4><p>下面介绍通过<code>jad</code>/<code>mc</code>/<code>redefine</code> 命令实现动态更新代码的功能。</p><p>目前，访问 <a href="http://localhost/user/0">http://localhost/user/0</a> ，会返回500异常：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost/user/0</span></span><br><span class="line">&#123;&quot;timestamp&quot;:1550223186170,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;exception&quot;:&quot;java.lang.IllegalArgumentException&quot;,&quot;message&quot;:&quot;id &lt; 1&quot;,&quot;path&quot;:&quot;/user/0&quot;&#125;</span><br></pre></td></tr></table></figure><p>下面通过热更新代码，修改这个逻辑。</p><h5 id="jad反编译UserController"><a href="#jad反编译UserController" class="headerlink" title="jad反编译UserController"></a>jad反编译UserController</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span></span><br></pre></td></tr></table></figure><p>jad反编译的结果保存在 <code>/tmp/UserController.java</code>文件里了。</p><p>再打开一个<code>Terminal 3</code>，然后用vim来编辑<code>/tmp/UserController.java</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /tmp/UserController.java</span><br></pre></td></tr></table></figure><p>比如当 user id 小于1时，也正常返回，不抛出异常：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;id: &#123;&#125;&quot;</span>, (Object)id);</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(id, <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">        <span class="comment">// throw new IllegalArgumentException(&quot;id &lt; 1&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(id.intValue(), <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="sc查找加载UserController的ClassLoader"><a href="#sc查找加载UserController的ClassLoader" class="headerlink" title="sc查找加载UserController的ClassLoader"></a>sc查找加载UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d *UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><p>可以发现是 spring boot <code>LaunchedURLClassLoader@1be6f5c3</code> 加载的。</p><p>请记下你的classLoaderHash，后面需要使用它。在这里，它是 <code>1be6f5c3</code>。</p><h5 id="mc"><a href="#mc" class="headerlink" title="mc"></a>mc</h5><p>保存好<code>/tmp/UserController.java</code>之后，使用<code>mc</code>(Memory Compiler)命令来编译，并且通过<code>-c</code>或者<code>--classLoaderClass</code>参数指定ClassLoader：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span></span><br><span class="line">Memory compiler output:</span><br><span class="line">/tmp/com/example/demo/arthas/user/UserController.class</span><br><span class="line">Affect(row-cnt:1) cost in 346 ms</span><br></pre></td></tr></table></figure><p>也可以通过<code>mc -c &lt;classLoaderHash&gt; /tmp/UserController.java -d /tmp</code>，使用<code>-c</code>参数指定ClassLoaderHash:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mc -c 1be6f5c3 /tmp/UserController.java -d /tmp</span><br></pre></td></tr></table></figure><h5 id="redefine"><a href="#redefine" class="headerlink" title="redefine"></a>redefine</h5><p>再使用<code>redefine</code>命令重新加载新编译好的<code>UserController.class</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redefine /tmp/com/example/demo/arthas/user/UserController.class</span></span><br><span class="line">redefine success, size: 1</span><br></pre></td></tr></table></figure><h5 id="热修改代码结果"><a href="#热修改代码结果" class="headerlink" title="热修改代码结果"></a>热修改代码结果</h5><p><code>redefine</code>成功之后，再次访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/0">https://2886795326-80-host12nc.environments.katacoda.com/user/0</a> ，结果是：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-3-案例-动态更新应用Logger-Level"><a href="#2-3-3-案例-动态更新应用Logger-Level" class="headerlink" title="2.3.3 案例: 动态更新应用Logger Level"></a>2.3.3 案例: 动态更新应用Logger Level</h4><p>在这个案例里，动态修改应用的Logger Level。</p><h5 id="查找UserController的ClassLoader-1"><a href="#查找UserController的ClassLoader-1" class="headerlink" title="查找UserController的ClassLoader"></a>查找UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><h5 id="用ognl获取logger"><a href="#用ognl获取logger" class="headerlink" title="用ognl获取logger"></a>用ognl获取logger</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>可以知道<code>UserController@logger</code>实际使用的是logback。可以看到<code>level=null</code>，则说明实际最终的level是从<code>root</code> logger里来的。</p><h5 id="单独设置UserController的logger-level"><a href="#单独设置UserController的logger-level" class="headerlink" title="单独设置UserController的logger level"></a>单独设置UserController的logger level</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger.setLevel(@ch.qos.logback.classic.Level@DEBUG)&#x27;</span></span></span><br></pre></td></tr></table></figure><p>再次获取<code>UserController@logger</code>，可以发现已经是<code>DEBUG</code>了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt=@Integer[10000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="修改logback的全局logger-level"><a href="#修改logback的全局logger-level" class="headerlink" title="修改logback的全局logger level"></a>修改logback的全局logger level</h5><p>通过获取<code>root</code> logger，可以修改全局的logger level：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).setLevel(@ch.qos.logback.classic.Level@DEBUG)&#x27;</span></span></span><br></pre></td></tr></table></figure><h4 id="2-3-4-案例-排查logger冲突问题"><a href="#2-3-4-案例-排查logger冲突问题" class="headerlink" title="2.3.4 案例: 排查logger冲突问题"></a>2.3.4 案例: 排查logger冲突问题</h4><p>在这个案例里，展示排查logger冲突的方法。</p><h5 id="确认应用使用的logger系统"><a href="#确认应用使用的logger系统" class="headerlink" title="确认应用使用的logger系统"></a>确认应用使用的logger系统</h5><p>以<code>UserController</code>为例，它使用的是slf4j api，但实际使用到的logger系统是logback。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="获取logback实际加载的配置文件"><a href="#获取logback实际加载的配置文件" class="headerlink" title="获取logback实际加载的配置文件"></a>获取logback实际加载的配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;#map1=@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).loggerContext.objectMap, #map1.get(&quot;CONFIGURATION_WATCH_LIST&quot;)&#x27;</span></span></span><br></pre></td></tr></table></figure><h5 id="使用classloader命令查找可能存在的logger配置文件"><a href="#使用classloader命令查找可能存在的logger配置文件" class="headerlink" title="使用classloader命令查找可能存在的logger配置文件"></a>使用classloader命令查找可能存在的logger配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span></span><br><span class="line"> jar:file:/Users/hengyunabc/code/java/spring-boot-inside/demo-arthas-spring-boot/target/demo-arthas-spring-boot-0.0.1-SNAPSHOT.jar!/BOOT-INF/classes!/logback-spring.xml</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 13 ms.</span><br></pre></td></tr></table></figure><p>可以知道加载的配置的具体来源。</p><p>可以尝试加载容易冲突的文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback.xml</span><br><span class="line"></span><br><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r log4j.properties</span><br></pre></td></tr></table></figure><h4 id="2-3-5-案例-获取Spring-Context"><a href="#2-3-5-案例-获取Spring-Context" class="headerlink" title="2.3.5 案例: 获取Spring Context"></a>2.3.5 案例: 获取Spring Context</h4><p>在这个案例里，展示获取spring context，再获取bean，然后调用函数。</p><h5 id="使用tt命令获取到spring-context"><a href="#使用tt命令获取到spring-context" class="headerlink" title="使用tt命令获取到spring context"></a>使用tt命令获取到spring context</h5><p><code>tt</code>即 TimeTunnel，它可以记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测。</p><ul><li><a href="https://arthas.aliyun.com/doc/tt.html">https://arthas.aliyun.com/doc/tt.html</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span></span><br></pre></td></tr></table></figure><p>访问：<a href="https://2886795326-80-host12nc.environments.katacoda.com/user/1">https://2886795326-80-host12nc.environments.katacoda.com/user/1</a></p><p>可以看到<code>tt</code>命令捕获到了一个请求：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdaptePress Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 252 ms.</span><br><span class="line"> INDE  TIMESTAMP    COST(  IS-R  IS-  OBJECT     CLASS               METHOD</span><br><span class="line"> X                  ms)    ET    EXP</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line"> 1000  2019-02-15   4.583  <span class="literal">true</span>  fal  0xc93cf1a  RequestMappingHand  invokeHandlerMethod</span><br><span class="line">       15:38:32     923          se              lerAdapter</span><br></pre></td></tr></table></figure><h5 id="使用tt命令从调用记录里获取到spring-context"><a href="#使用tt命令从调用记录里获取到spring-context" class="headerlink" title="使用tt命令从调用记录里获取到spring context"></a>使用tt命令从调用记录里获取到spring context</h5><p>输入 <code>Q</code> 或者 <code>Ctrl + C</code> 退出上面的 <code>tt -t</code>命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tt -i 1000 -w <span class="string">&#x27;target.getApplicationContext()&#x27;</span></span></span><br><span class="line">@AnnotationConfigEmbeddedWebApplicationContext[</span><br><span class="line">    reader=@AnnotatedBeanDefinitionReader[org.springframework.context.annotation.AnnotatedBeanDefinitionReader@2e457641],</span><br><span class="line">    scanner=@ClassPathBeanDefinitionScanner[org.springframework.context.annotation.ClassPathBeanDefinitionScanner@6eb38026],</span><br><span class="line">    annotatedClasses=null,</span><br><span class="line">    basePackages=null,</span><br><span class="line">]</span><br><span class="line">Affect(row-cnt:1) cost in 439 ms.</span><br></pre></td></tr></table></figure><h5 id="获取spring-bean，并调用函数"><a href="#获取spring-bean，并调用函数" class="headerlink" title="获取spring bean，并调用函数"></a>获取spring bean，并调用函数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1000 -w <span class="string">&#x27;target.getApplicationContext().getBean(&quot;helloWorldService&quot;).getHelloMessage()&#x27;</span></span><br><span class="line">@String[Hello World]</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 52 ms.</span><br></pre></td></tr></table></figure><h4 id="2-3-6-案例-排查HTTP请求返回401"><a href="#2-3-6-案例-排查HTTP请求返回401" class="headerlink" title="2.3.6 案例: 排查HTTP请求返回401"></a>2.3.6 案例: 排查HTTP请求返回401</h4><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><p>结果是：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Something</span> went wrong: <span class="number">401</span> Unauthorized</span><br></pre></td></tr></table></figure><p>我们知道<code>401</code>通常是被权限管理的<code>Filter</code>拦截了，那么到底是哪个<code>Filter</code>处理了这个请求，返回了401？</p><h5 id="跟踪所有的Filter函数"><a href="#跟踪所有的Filter函数" class="headerlink" title="跟踪所有的Filter函数"></a>跟踪所有的Filter函数</h5><p>开始trace：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax<span class="selector-class">.servlet</span><span class="selector-class">.Filter</span> *</span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><p>可以在调用树的最深层，找到<code>AdminFilterConfig$AdminFilter</code>返回了<code>401</code>：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+---<span class="literal">[<span class="number">3.806273</span><span class="identifier">ms</span>]</span> javax.servlet.FilterChain:<span class="keyword">do</span><span class="constructor">Filter()</span></span><br><span class="line"><span class="pattern-match">|   `---[3.447472ms] com.example.demo.arthas.<span class="constructor">AdminFilterConfig$AdminFilter</span>:<span class="keyword">do</span><span class="constructor">Filter()</span></span></span><br><span class="line"><span class="pattern-match">|       `---[0.17259ms] javax.servlet.http.<span class="constructor">HttpServletResponse</span>:send<span class="constructor">Error()</span></span></span><br></pre></td></tr></table></figure><h5 id="通过stack获取调用栈"><a href="#通过stack获取调用栈" class="headerlink" title="通过stack获取调用栈"></a>通过stack获取调用栈</h5><p>上面是通过<code>trace</code>命令来获取信息，从结果里，我们可以知道通过<code>stack</code>跟踪<code>HttpServletResponse:sendError()</code>，同样可以知道是哪个<code>Filter</code>返回了<code>401</code></p><p>执行：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack javax<span class="selector-class">.servlet</span><span class="selector-class">.http</span><span class="selector-class">.HttpServletResponse</span> sendError <span class="string">&#x27;params[0]==401&#x27;</span></span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ stack javax.servlet.http.HttpServletResponse sendError <span class="string">&#x27;params[0]==401&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:2 , method-cnt:4) cost <span class="keyword">in</span> 87 ms.</span><br><span class="line">ts=2019-02-15 16:44:06;thread_name=http-nio-8080-exec-6;id=16;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader@8546cd5</span><br><span class="line">    @org.apache.catalina.connector.ResponseFacade.sendError()</span><br><span class="line">        at com.example.demo.arthas.AdminFilterConfig<span class="variable">$AdminFilter</span>.doFilter(AdminFilterConfig.java:38)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br></pre></td></tr></table></figure><h4 id="2-3-7-案例-排查HTTP请求返回404"><a href="#2-3-7-案例-排查HTTP请求返回404" class="headerlink" title="2.3.7 案例: 排查HTTP请求返回404"></a>2.3.7 案例: 排查HTTP请求返回404</h4><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/a.txt">https://2886795326-80-host12nc.environments.katacoda.com/a.txt</a></p><p>结果是：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Something</span> went wrong: <span class="number">404</span> Not Found</span><br></pre></td></tr></table></figure><p>那么到底是哪个Servlet处理了这个请求，返回了404？</p><h5 id="跟踪所有的Servlet函数"><a href="#跟踪所有的Servlet函数" class="headerlink" title="跟踪所有的Servlet函数"></a>跟踪所有的Servlet函数</h5><p>开始trace：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax.servlet.Servlet * &gt; <span class="regexp">/tmp/</span>servlet.txt</span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/a.txt">https://2886795326-80-host12nc.environments.katacoda.com/a.txt</a></p><p>在<code>Terminal 3</code>里，查看<code>/tmp/servlet.txt</code>的内容：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less <span class="regexp">/tmp/</span>servlet.txt</span><br></pre></td></tr></table></figure><p><code>/tmp/servlet.txt</code>里的内容会比较多，需要耐心找到调用树里最长的地方。</p><p>可以发现请求最终是被<code>freemarker</code>处理的：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="operator">---</span>[<span class="number">13</span>.974188ms] org.springframework.web.servlet.<span class="type">ViewResolver</span>:resolveViewName()    <span class="operator">+---</span>[<span class="number">0</span>.045561ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="operator">&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>()    <span class="operator">+---</span>[min<span class="operator">=</span><span class="number">0</span>.045545ms,max<span class="operator">=</span><span class="number">0</span>.074342ms,total<span class="operator">=</span><span class="number">0</span>.119887ms,count<span class="operator">=</span><span class="number">2</span>] org.springframework.web.servlet.view.freemarker.<span class="type">FreeMarkerView</span><span class="variable">$GenericServletAdapter</span>:<span class="operator">&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>()    <span class="operator">+---</span>[<span class="number">0</span>.170895ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    <span class="operator">|</span>   `<span class="operator">---</span>[<span class="number">0</span>.068578ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    <span class="operator">|</span>       `<span class="operator">---</span>[<span class="number">0</span>.021793ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    `<span class="operator">---</span>[<span class="number">0</span>.164035ms] javax.servlet.<span class="type">GenericServlet</span>:getServletContext()</span><br></pre></td></tr></table></figure><h4 id="2-3-8-案例-理解Spring-Boot应用的ClassLoader结构"><a href="#2-3-8-案例-理解Spring-Boot应用的ClassLoader结构" class="headerlink" title="2.3.8 案例: 理解Spring Boot应用的ClassLoader结构"></a>2.3.8 案例: 理解Spring Boot应用的ClassLoader结构</h4><p>下面介绍<code>classloader</code>命令的功能。</p><p>先访问一个jsp网页，触发jsp的加载： <a href="https://2886795326-80-host12nc.environments.katacoda.com/hello">https://2886795326-80-host12nc.environments.katacoda.com/hello</a></p><h5 id="列出所有ClassLoader"><a href="#列出所有ClassLoader" class="headerlink" title="列出所有ClassLoader"></a>列出所有ClassLoader</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ classloader -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             <span class="number">2724</span>         null      null</span><br><span class="line"> com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">411</span>ce1ab               <span class="number">2009</span>         <span class="number">411</span>ce1ab  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">22</span>ae1234               <span class="number">1253</span>         <span class="number">22</span>ae1234  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a                  <span class="number">1</span>            <span class="number">65361</span>d9a  TomcatEmbeddedWebappClassLoader</span><br><span class="line">                                                                                           context: ROOT</span><br><span class="line">                                                                                           delegate: true</span><br><span class="line">                                                                                         ----------&gt; Parent Classloader:</span><br><span class="line">                                                                                         org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line"> TomcatEmbeddedWebappClassLoader                                  <span class="number">0</span>            <span class="number">8546</span>cd5   org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line">   context: ROOT</span><br><span class="line">   delegate: true</span><br><span class="line"> ----------&gt; Parent Classloader:</span><br><span class="line"> org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line"> org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3  <span class="number">5416</span>         <span class="number">1</span>be6f5c3  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">3</span>d4eac69</span><br><span class="line"> sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">3</span>d4eac69                        <span class="number">45</span>           <span class="number">3</span>d4eac69  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528                        <span class="number">4</span>            <span class="number">7494</span>e528  null</span><br></pre></td></tr></table></figure><ul><li>TomcatEmbeddedWebappClassLoader 加载的class数量是0，所以在spring boot embedded tomcat里，它只是一个空壳，所有的类加载都是<code>LaunchedURLClassLoader</code>完成的</li></ul><h5 id="列出ClassLoader里加载的所有类"><a href="#列出ClassLoader里加载的所有类" class="headerlink" title="列出ClassLoader里加载的所有类"></a>列出ClassLoader里加载的所有类</h5><p>列出上面的<code>org.apache.jasper.servlet.JasperLoader</code>加载的类：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">classloader -<span class="selector-tag">a</span> --classLoaderClass org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span><span class="selector-class">.JasperLoader</span></span><br><span class="line">$ classloader -<span class="selector-tag">a</span> --classLoaderClass apache<span class="selector-class">.jasper</span><span class="selector-class">.servlet</span><span class="selector-class">.JasperLoader</span></span><br><span class="line"> hash:<span class="number">1698045338</span>, org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a</span><br><span class="line"> org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span>.hello_jsp</span><br></pre></td></tr></table></figure><ul><li>注：同ognl, 也可用<code>-c &lt;hashcode&gt;</code>而不用<code>--classLoaderClass</code>指定</li></ul><h5 id="反编译jsp的代码"><a href="#反编译jsp的代码" class="headerlink" title="反编译jsp的代码"></a>反编译jsp的代码</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jad org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span><span class="selector-class">.hello_jsp</span></span><br><span class="line">$ jad org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span><span class="selector-class">.hello_jsp</span></span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a</span><br><span class="line">  +-TomcatEmbeddedWebappClassLoader</span><br><span class="line">      context: ROOT</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="查看ClassLoader树"><a href="#查看ClassLoader树" class="headerlink" title="查看ClassLoader树"></a>查看ClassLoader树</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">classloader -t</span><br><span class="line">$ classloader -t</span><br><span class="line">+-BootstrapClassLoader</span><br><span class="line">+-sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">28</span>cbbddd</span><br><span class="line">  +-com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">8</span>c25e55</span><br><span class="line">  +-sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">55</span>f96302</span><br><span class="line">    +-org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line">      +-TomcatEmbeddedWebappClassLoader</span><br><span class="line">          context: ROOT</span><br><span class="line">          delegate: true</span><br><span class="line">        ----------&gt; Parent Classloader:</span><br><span class="line">        org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line">        +-org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">21</span>ae0fe2</span><br></pre></td></tr></table></figure><p>注意：请使用你的classLoaderHash值覆盖 <code>&lt;classLoaderHash&gt;</code> ，然后手动执行下面相关命令：</p><h5 id="列出ClassLoader的urls"><a href="#列出ClassLoader的urls" class="headerlink" title="列出ClassLoader的urls"></a>列出ClassLoader的urls</h5><p>比如上面查看到的spring LaunchedURLClassLoader的 hashcode是<code>1be6f5c3</code>，可以通过<code>-c</code>或者<code>--classLoaderClass</code>参数来列出它的所有urls：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line">$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line">jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>classes!/</span><br><span class="line">jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>lib/spring-boot-starter-aop-<span class="number">1.5</span></span><br><span class="line">.<span class="number">13</span>.RELEASE.jar!/</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="加载指定ClassLoader里的资源文件"><a href="#加载指定ClassLoader里的资源文件" class="headerlink" title="加载指定ClassLoader里的资源文件"></a>加载指定ClassLoader里的资源文件</h5><p>查找指定的资源文件： <code>classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</code></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br><span class="line"> jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>classes!/logback-spring.xml</span><br></pre></td></tr></table></figure><h5 id="尝试加载指定的类"><a href="#尝试加载指定的类" class="headerlink" title="尝试加载指定的类"></a>尝试加载指定的类</h5><p>比如用上面的spring LaunchedURLClassLoader 尝试加载 <code>java.lang.String</code> ：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span><span class="selector-class">.LaunchedURLClassLoader</span> --load java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line">$ classloader --classLoaderClass org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span><span class="selector-class">.LaunchedURLClassLoader</span> --load java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line">load class success.</span><br><span class="line"> class-info        java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line"> code-source</span><br><span class="line"> name              java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line"> isInterface       false</span><br><span class="line"> isAnnotation      false</span><br><span class="line"> isEnum            false</span><br><span class="line"> isAnonymousClass  false</span><br><span class="line"> isArray           false</span><br><span class="line"> isLocalClass      false</span><br><span class="line"> isMemberClass     false</span><br><span class="line"> isPrimitive       false</span><br><span class="line"> isSynthetic       false</span><br><span class="line"> simple-name       String</span><br><span class="line"> modifier          final,public</span><br><span class="line"> annotation</span><br><span class="line"> interfaces        java<span class="selector-class">.io</span><span class="selector-class">.Serializable</span>,java<span class="selector-class">.lang</span><span class="selector-class">.Comparable</span>,java<span class="selector-class">.lang</span><span class="selector-class">.CharSequence</span></span><br><span class="line"> super-class       +-java<span class="selector-class">.lang</span><span class="selector-class">.Object</span></span><br><span class="line"> class-loader</span><br><span class="line"> classLoaderHash   null</span><br></pre></td></tr></table></figure><h4 id="2-3-9-案例：查找Top-N线程"><a href="#2-3-9-案例：查找Top-N线程" class="headerlink" title="2.3.9 案例：查找Top N线程"></a>2.3.9 案例：查找Top N线程</h4><h5 id="查看所有线程信息"><a href="#查看所有线程信息" class="headerlink" title="查看所有线程信息"></a>查看所有线程信息</h5><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span></span><br></pre></td></tr></table></figure><h5 id="查看具体线程的栈"><a href="#查看具体线程的栈" class="headerlink" title="查看具体线程的栈"></a>查看具体线程的栈</h5><p>查看线程ID 16的栈：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> <span class="number">16</span></span><br></pre></td></tr></table></figure><h5 id="查看CPU使用率top-n线程的栈"><a href="#查看CPU使用率top-n线程的栈" class="headerlink" title="查看CPU使用率top n线程的栈"></a>查看CPU使用率top n线程的栈</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> -n <span class="number">3</span></span><br></pre></td></tr></table></figure><h5 id="查看5秒内的CPU使用率top-n线程栈"><a href="#查看5秒内的CPU使用率top-n线程栈" class="headerlink" title="查看5秒内的CPU使用率top n线程栈"></a>查看5秒内的CPU使用率top n线程栈</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> -n <span class="number">3</span> -i <span class="number">5000</span></span><br></pre></td></tr></table></figure><h5 id="查找线程是否有阻塞"><a href="#查找线程是否有阻塞" class="headerlink" title="查找线程是否有阻塞"></a>查找线程是否有阻塞</h5><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -b</span><br></pre></td></tr></table></figure><h3 id="2-4-Web-Console"><a href="#2-4-Web-Console" class="headerlink" title="2.4 Web Console"></a>2.4 Web Console</h3><p>Arthas支持通过Web Socket来连接。</p><h4 id="教程里的Web-Console"><a href="#教程里的Web-Console" class="headerlink" title="教程里的Web Console"></a>教程里的Web Console</h4><p><a href="http://2886795326-8563-host12nc.environments.katacoda.com/?ip=2886795326-8563-host12nc.environments.katacoda.com&amp;port=80">http://2886795326-8563-host12nc.environments.katacoda.com/?ip=2886795326-8563-host12nc.environments.katacoda.com&amp;port=80</a></p><blockquote><p>注意：教程里访问的是80端口，因为做了端口转发。在本地体验时，需要访问8563端口。</p></blockquote><h4 id="本地体验"><a href="#本地体验" class="headerlink" title="本地体验"></a>本地体验</h4><p>当在本地启动时，可以访问 <a href="http://127.0.0.1:8563/">http://127.0.0.1:8563/</a> ，通过浏览器来使用Arthas。</p><p><img src="https://katacoda.com/arthas/scenarios/common-resources/assets/web-console.png" alt="Arthas WebConsole"></p><p>推荐通过“快速入门”来体验： <a href="https://arthas.aliyun.com/doc/quick-start.html">https://arthas.aliyun.com/doc/quick-start.html</a></p><h3 id="2-5-Exit-Stop"><a href="#2-5-Exit-Stop" class="headerlink" title="2.5 Exit/Stop"></a>2.5 Exit/Stop</h3><ul><li><p>reset：Arthas在 watch/trace 等命令时，实际上是修改了应用的字节码，插入增强的代码。显式执行 <code>reset</code> 命令，可以清除掉这些增强代码。</p></li><li><p>退出Arthas：</p><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出Arthas。</p><p>退出Arthas之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p></li><li><p>彻底退出Arthas：</p><p><code>exit/quit</code>命令只是退出当前session，arthas server还在目标进程中运行。</p><p>想完全退出Arthas，可以执行 <code>stop</code> 命令。</p></li></ul><h3 id="2-6-arthas-boot支持的参数"><a href="#2-6-arthas-boot支持的参数" class="headerlink" title="2.6 arthas-boot支持的参数"></a>2.6 arthas-boot支持的参数</h3><p><code>arthas-boot.jar</code> 支持很多参数，可以执行 <code>java -jar arthas-boot.jar -h</code> 来查看。</p><ul><li><p>允许外部访问：</p><p>默认情况下， arthas server侦听的是 <code>127.0.0.1</code> 这个IP，如果希望远程可以访问，可以使用<code>--target-ip</code>的参数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --target-ip</span></span><br></pre></td></tr></table></figure></li><li><p>列出所有的版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --versions</span></span><br></pre></td></tr></table></figure><p>使用指定版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --use-version 3.1.0</span></span><br></pre></td></tr></table></figure></li><li><p>只侦听Telnet端口，不侦听HTTP端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --telnet-port 9999 --http-port -1</span></span><br></pre></td></tr></table></figure></li><li><p>打印运行的详情：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar -v</span></span><br></pre></td></tr></table></figure></li></ul><hr><p>参考：</p><p>🔗 <a href="https://arthas.aliyun.com/">Arthas官网</a></p><p>🔗 <a href="https://arthas.aliyun.com/doc/index.html">Arthas 用户文档 — Arthas 3.5.4 文档 (aliyun.com)</a></p>]]></content>
    
    
    <summary type="html">内容包括：简介，教程（入门、进阶、案例）等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="jvm" scheme="http://linyishui.top/tags/jvm/"/>
    
    <category term="Arthas" scheme="http://linyishui.top/tags/Arthas/"/>
    
  </entry>
  
  <entry>
    <title>Oracle优化器hint</title>
    <link href="http://linyishui.top/2021090601.html"/>
    <id>http://linyishui.top/2021090601.html</id>
    <published>2021-09-06T12:51:44.000Z</published>
    <updated>2021-09-14T01:29:18.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Oracle优化器hint"><a href="#Oracle优化器hint" class="headerlink" title="Oracle优化器hint"></a>Oracle优化器hint</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><p>优化器hint可以与SQL语句一起使用来改变执行计划。在SQL中使用hint来提高性能。hints（除了RULE-hint）会使Oracle使用基于成本的优化器，语法格式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 其中HINT被hint文本所取代，当hint文本的语法不正确时，hint文本被忽略，不会被使用。</span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ HINT */</span> name</span><br><span class="line"><span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">where</span> id <span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>hint可以让你做一些通常由优化器做出的决定。作为开发者，你可能知道一些优化器不知道的数据信息。hint提供了一种机制，指示优化器根据特定的标准选择某种查询执行计划。</p><p>例如，你可能知道某个索引对某些查询更有选择性。基于这些信息，你可能会选择一个比优化器更有效的执行计划。在这种情况下，可以使用hint来指示优化器使用最佳执行计划。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 优化器选择employees.department_id列上的一个索引，来查找其部门ID 超过<span class="number">50</span>的雇员中的前<span class="number">25</span>行。优化器使用从索引中检索到的rowid，从雇员表中检索相应记录，并将其返回给客户端。第一条记录的检索通常几乎是在瞬间即可完成的。</span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FIRST_ROWS(25) */</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> hr.employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&gt;</span> <span class="number">50</span>;</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> Operation <span class="operator">|</span> Name <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT <span class="operator">|</span> <span class="operator">|</span> <span class="number">26</span> <span class="operator">|</span> <span class="number">182</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID <span class="operator">|</span> EMPLOYEES <span class="operator">|</span> <span class="number">26</span> <span class="operator">|</span> <span class="number">182</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">2</span> <span class="operator">|</span> INDEX <span class="keyword">RANGE</span> SCAN <span class="operator">|</span> EMP_DEPARTMENT_IX <span class="operator">|</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"># 无提示<span class="keyword">SELECT</span>语句的执行计划</span><br><span class="line"><span class="keyword">SELECT</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> hr.employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&gt;</span> <span class="number">50</span>;</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> Operation <span class="operator">|</span> Name <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes <span class="operator">|</span> Cos</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT <span class="operator">|</span> <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">VIEW</span> <span class="operator">|</span> index$_join$_001 <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">2</span> <span class="operator">|</span> HASH <span class="keyword">JOIN</span> <span class="operator">|</span> <span class="operator">|</span> <span class="operator">|</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">3</span> <span class="operator">|</span> INDEX <span class="keyword">RANGE</span> SCAN <span class="operator">|</span> EMP_DEPARTMENT_IX <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> INDEX FAST <span class="keyword">FULL</span> SCAN<span class="operator">|</span> EMP_EMP_ID_PK <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"></span><br><span class="line">将两个索引联接以尽可能快的返回请求的记录。优化器并不像上述hint那样多次在表和索引间倒腾，而是在EMP_DEPARTMENT_IX索引上使用范围扫描，找出所有部门ID超过<span class="number">50</span>的行，并将这些行放在一个哈希表中。然后优化器读取EMP_EMP_ID_PK索引。对该索引中的每一行，它探测一次该哈希表，以查找相应的部门id。</span><br><span class="line"></span><br><span class="line">在这种情况下，数据库不能在完成对EMP_DEPARTMENT_IX索引的范围扫描之前向客户端返回第一行。因此，此生成的计划将需要更长的时间返回第一条记录。与示例中按索引rowid访问表的计划不同，计划使用多数据块 I<span class="operator">/</span>O，导致大量读取操作。这种读取使得整个结果集的最后一行会更快地返回。</span><br></pre></td></tr></table></figure><h2 id="二-Hint种类"><a href="#二-Hint种类" class="headerlink" title="二. Hint种类"></a>二. Hint种类</h2><h3 id="2-1-几种hint类别"><a href="#2-1-几种hint类别" class="headerlink" title="2.1 几种hint类别"></a>2.1 几种hint类别</h3><ul><li><p>Single-table：</p><p>单表hint是在一个表或视图上指定的，如：<code>INDEX</code> ，<code>USE_NL</code>。</p></li><li><p>Multi-table</p><p>多表hint与单表hint一样，只是hint可以指定一个或多个表或视图。如： <code>LEADING</code> ，<code>USE_NL(table1 table2)</code> ，<code>USE_NL(table1)</code> ，<code>USE_NL(table2)</code> 。</p></li><li><p>Query block</p><p>查询块hint对单个查询块进行操作，如：<code>STAR_TRANSFORMATION</code> ，<code>UNNEST</code> 。</p></li><li><p>Statement</p><p>语句hint适用于整个SQL语句，如 <code>ALL_ROWS</code> 。</p></li></ul><h3 id="2-2-常见hint"><a href="#2-2-常见hint" class="headerlink" title="2.2 常见hint"></a>2.2 常见hint</h3><p>优化器的hint分为以下几类:</p><ul><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDFIAJD">Hints for Optimization Approaches and Goals</a>：优化方法和目标的hint<ul><li><code>ALL_ROWS</code>：明确地选择了基于成本的方法来优化语句块，目标是最佳吞吐量（即最小的总资源消耗）。</li><li><code>FIRST_ROWS(n)</code>：明确地选择了基于成本的方法来优化语句块，目标是最佳响应时间（返回第一行的最小资源占用）。在较新的Oracle版本中，你应该给这个提示一个参数：<code>FIRST_ROWS(n)</code> 意味着优化器将确定一个执行计划，为返回前n行提供快速响应。</li><li><code>CHOOSE</code>：使优化器在基于规则的方法和基于成本的方法之间选择一个SQL语句，基于该语句所访问的表的统计信息的存在。</li><li><code>RULE</code>：为一个语句块明确地选择了基于规则的优化。这个提示也导致优化器忽略了为语句块指定的任何其他提示。RULE提示在Oracle 10g中不再起作用。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDJDIAH">Hints for Access Paths</a>：访问路径的hint<ul><li><code>FULL</code>：明确地选择了对指定表进行全表扫描。FULL提示的语法是FULL(table)，其中table指定了要进行全表扫描的表的别名（如果别名不存在，则是表名）。</li><li><code>ROWID</code>：明确地选择了对指定表进行ROWID扫描。ROWID提示的语法是 <code>ROWID(table)</code> ，其中table指定了要进行ROWID表访问的表的名称或别名。(这个提示在Oracle 10g中被废弃)</li><li><code>CLUSTER</code>：明确地选择了集群扫描来访问指定的表。CLUSTER提示的语法是 <code>CLUSTER(table)</code> ，其中table指定了要被集群扫描访问的表的名称或别名。</li><li><code>HASH</code>：明确地选择了一个散列扫描来访问指定的表。HASH提示的语法是 <code>HASH(table)</code> ，其中table指定要通过散列扫描访问的表的名称或别名。</li><li><code>HASH_AJ</code>：将一个NOT IN子查询转换为一个哈希反连接，以访问指定的表。HASH_AJ提示的语法是 <code>HASH_AJ(table)</code> ，其中table指定了要访问的表的名称或别名（在Oracle 10g中被废弃）。</li><li><code>INDEX</code>：明确地选择了对指定表的索引扫描。INDEX提示的语法是 <code>INDEX(table index)</code> ，其中:table指定与要扫描的索引相关的表的名称或别名，index指定要进行索引扫描的索引。这个提示可以选择性地指定一个或多个索引。</li><li><code>NO_INDEX</code>：明确地禁止为指定的表建立一组索引。NO_INDEX提示的语法是NO_INDEX(表索引)</li><li><code>INDEX_ASC</code>：明确地选择了对指定表的索引扫描。如果语句使用索引范围扫描，Oracle会按照索引值的升序扫描索引条目。</li><li><code>INDEX_COMBINE</code>：如果没有索引作为INDEX_COMBINE提示的参数，优化器将在表上使用位图索引的任何布尔组合，具有最佳成本估计。如果给出了某些索引作为参数，优化器将尝试使用这些特定位图索引的一些布尔组合。INDEX_COMBINE的语法是INDEX_COMBINE(表索引)。</li><li><code>INDEX_JOIN</code>：明确指示优化器使用一个索引连接作为访问路径。为了使提示产生积极的效果，必须存在足够少的索引，包含解决查询所需的所有列。</li><li><code>INDEX_DESC</code>：明确地选择了对指定表的索引扫描。如果语句使用索引范围扫描，Oracle会按照索引值的降序扫描索引条目。</li><li><code>INDEX_FFS</code>：这个提示导致执行快速的全索引扫描，而不是全表扫描。</li><li><code>NO_INDEX_FFS</code>：不要使用快速全索引扫描（来自Oracle 10g）。</li><li><code>INDEX_SS</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>INDEX_SS_ASC</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>INDEX_SS_DESC</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>NO_INDEX_SS</code>：导致优化器排除对指定表的指定索引进行跳过扫描（来自Oracle 10g）。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDEHFHG">Hints for Query Transformations</a>：查询转换的hint<ul><li><code>NO_QUERY_TRANSFORMATION</code>：防止优化器进行查询转换（来自Oracle 10g）。</li><li><code>USE_CONCAT</code>：强制将查询的WHERE子句中的组合OR条件转化为使用UNION ALL集合操作符的复合查询。通常情况下，只有当使用连接条件的查询成本比不使用连接条件的查询成本低时，才会发生这种转换。</li><li><code>NO_EXPAND</code>：阻止优化器对WHERE子句中具有OR条件或IN列表的查询考虑OR扩展。通常情况下，优化器会考虑使用OR扩展，如果它认为成本比不使用它低，就会使用这种方法。</li><li><code>REWRITE</code>：强制优化器在可能的情况下以物化视图的方式重写查询，而不考虑成本。无论是否有视图列表，都可以使用REWRITE提示。如果你使用REWRITE和一个视图列表，并且该列表包含一个合格的物化视图，那么Oracle会使用该视图，而不考虑其成本。</li><li><code>NOREWRITE / NO_REWRITE</code>：在Oracle 10g中改名为NO_REWRITE。NOREWRITE/NO_REWRITE提示禁用了查询块的查询重写，覆盖了参数 <code>QUERY_REWRITE_ENABLED</code> 的设置。</li><li><code>MERGE</code>：可以让你在一个查询中合并视图。</li><li><code>NO_MERGE</code>：使Oracle不合并可合并的视图。这个提示最常被用来减少查询的可能排列组合的数量，使优化更快。</li><li><code>FACT</code>：表示该表应该被认为是一个事实表。这是在星形转换的背景下使用的。</li><li><code>NO_FACT</code>：在星形转换的上下文中使用，向转换表明提示的表不应该被视为事实表。</li><li><code>STAR_TRANSFORMATION</code>：使优化器使用已使用转换的最佳计划。如果没有这个提示，优化器可以做出查询优化的决定，使用没有转换的最佳计划，而不是转换后的查询的最佳计划。</li><li><code>NO_STAR_TRANSFORMATION</code>：不使用星形转换（来自Oracle 10g）。</li><li><code>UNNEST</code>：指定子查询的不嵌套。</li><li><code>NO_UNNEST</code>：可以关闭特定子查询块的不嵌套。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDGGCHC">Hints for Join Orders</a>：联接顺序的hint<ul><li><code>LEADING</code>：给出这个hint以指示连接中的主导表，将只表示1个表。可以使用ORDERED指定整个表的顺序。语法：<code>LEADING(table)</code> 。</li><li><code>ORDERED</code>：使Oracle按照表在FROM子句中出现的顺序连接表。如果你在执行连接的SQL语句中省略了ORDERED提示，优化器会选择连接表的顺序。如果你知道一些优化器不知道的从每个表中选择的行数，你可能想使用ORDERED提示来指定一个连接顺序。这些信息可以让你比优化器更好地选择内表和外表。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDBAFID">Hints for Join Operations</a>：连接操作的hint<ul><li><code>USE_NL</code>：使Oracle以嵌套循环连接的方式将每个指定的表与另一个记录源连接起来，并以指定的表作为内表。USE_NL提示的语法是 <code>USE_NL(table table)</code> ，其中table是一个表的名称或别名，将被用作嵌套循环连接的内表。</li><li><code>NO_USE_NL</code>：不要使用嵌套循环（来自Oracle 10g）。</li><li><code>USE_NL_WITH_INDEX</code>：指定一个嵌套的循环连接（来自Oracle 10g）。</li><li><code>USE_MERGE</code>：会使Oracle以排序合并连接的方式将每个指定的表与另一个行源连接起来。USE_MERGE提示的语法是 <code>USE_MERGE(table)</code> ，其中table是一个要连接到行源的表，这个行源是用排序合并连接的方式连接前面的表而得到的。</li><li><code>NO_USE_MERGE</code>：不要使用合并（来自Oracle 10g）。</li><li><code>USE_HASH</code>：使Oracle以散列连接的方式将每个指定的表与另一个行源连接。USE_HASH提示的语法是 <code>USE_HASH(table table)</code> ，其中table是一个要连接到行源的表，这个行源是用散列连接的方式连接前面的表而得到的。</li><li><code>NO_USE_HASH</code>：不要使用哈希（来自Oracle 10g）。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDJIGDG">Hints for Parallel Execution</a>：并行执行的hint<ul><li><code>PARALLEL</code>：允许你指定可用于查询的并发查询服务器的数量。语法是PARALLEL(表号数)。如果在查询中指定了别名，PARALLEL提示必须使用表的别名。然后，PARALLEL提示可以取两个值，在表名后面用逗号分隔。第一个值指定给定表的并行程度，第二个值指定该表如何在并行服务器的实例中被分割。指定DEFAULT或没有值表示查询协调器应该检查初始化参数的设置（在后面的章节中描述）以确定默认的并行程度。</li><li><code>NOPARALLEL / NO_PARALLEL</code>：允许你禁用一个表的并行扫描，即使该表是用PARALLEL子句创建的。在Oracle 10g中，这个提示被重新命名为NO_PARALLEL。</li><li><code>PQ_DISTRIBUTE</code>：提高了并行连接操作的性能。通过指定连接表的行应该如何在生产者和消费者查询服务器之间分配来做到这一点。使用这个提示会覆盖优化器通常会做出的决定。</li><li><code>NO_PARALLEL_INDEX</code>：覆盖了一个索引上的PARALLEL属性设置，以避免平行索引扫描操作。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDIDIDI">Additional Hints</a>：其他hint<ul><li><code>APPEND</code>：当APPEND提示与INSERT语句一起使用时，数据被追加到表中。区块中现有的自由空间不被使用。如果一个表或索引被指定为nologging，这个提示与一个插入语句一起使用会产生一个直接的路径插入，从而减少重做的产生。</li><li><code>NOAPPEND</code>：覆盖附加模式。</li><li><code>CACHE</code>：指定当进行全表扫描时，为提示中的表检索的块被放置在缓冲区缓存的LRU列表中最近使用的一端。这个选项对于小的查询表很有用。在下面的例子中，CACHE提示覆盖了表的默认缓存规范。</li><li><code>NOCACHE</code>：当执行全表扫描时，为该表检索的块被放在缓冲区缓存中LRU列表的最近使用的一端。这是缓冲区缓存中块的正常行为。</li><li><code>PUSH_PRED</code>：强制将连接谓词推入视图。</li><li><code>NO_PUSH_PRED</code>：防止将连接谓词推入视图。</li><li><code>PUSH_SUBQ</code>：使非合并子查询在执行计划中尽可能早地被评估。</li><li><code>NO_PUSH_SUBQ</code>：导致非合并子查询作为执行计划的最后一步被评估。</li><li><code>QB_NAME</code>：为一个查询块指定一个名称（来自Oracle 10g）。</li><li><code>CURSOR_SHARING_EXACT</code>：如果安全的话，Oracle可以用绑定变量替换SQL语句中的字面意思。这是由CURSOR_SHARING启动参数控制的。CURSOR_SHARING_EXACT提示使这种行为被关闭。换句话说，Oracle在执行SQL语句时，不会试图用绑定变量替换字面意义。</li><li><code>DRIVING_SITE</code>：强制在与Oracle选择的站点不同的站点上对表执行查询。</li><li><code>DYNAMIC_SAMPLING</code>：可以让你控制动态采样，通过确定表和索引的更精确的谓词选择性和统计数据来提高服务器性能。你可以将DYNAMIC_SAMPLING的值设置为0到10的数值。级别越高，编译器在动态采样方面投入的精力越多，应用也越广泛。除非你指定一个表，否则采样的默认值是游标级。</li><li><code>SPREAD_MIN_ANALYSIS</code>：这个提示省略了一些规则的编译时间优化，主要是详细的依赖图分析，在电子表格上。一些优化，如创建过滤器以有选择地填充电子表格访问结构和有限的规则修剪仍然被使用（来自Oracle 10g）。</li></ul></li><li>Hints with unknown status：hint<ul><li><code>MERGE_AJ</code>：将一个NOT IN子查询转换为一个合并反连接，以访问指定的表。MERGE_AJ提示的语法是 <code>MERGE_AJ(table)</code> ，其中table指定要访问的表的名称或别名。</li><li><code>AND_EQUAL</code>：明确地选择了一个执行计划，该计划使用一个访问路径，合并了几个单列索引的扫描。AND_EQUAL提示的语法是 <code>AND_EQUAL(table index index)</code> ，其中table指定了与要合并的索引相关的表的名称或别名，index指定了一个要进行索引扫描的索引。你必须至少指定两个索引。你不能指定超过五个。(在Oracle 10g中被废弃)</li><li><code>STAR</code>：迫使大表使用索引上的嵌套循环连接最后被连接。优化器将考虑小表的不同排列组合。(在Oracle 10g中被废弃)</li><li><code>BITMAP</code>：<code>BITMAP(table_name index_name)</code> 使用一个位图索引来访问表。(depricated ?)</li><li><code>HASH_SJ</code>：使用 <code>Hash Anti-Join</code> 来评估一个NOT IN子查询。在子查询中使用这个提示，而不是在主查询中。当你的大量NOT IN子查询使用FILTER或NESTED LOOPS连接时，使用这个提示。如果HASH_AJ拒绝工作，请尝试MERGE_AJ。（在Oracle 10g中被废弃）</li><li><code>NL_SJ</code>：在一个子查询中使用嵌套循环。(在Oracle 10g中被废弃)</li><li><code>NL_AJ</code>：在一个子查询中使用反连接。(在Oracle 10g中被废弃)</li><li><code>ORDERED_PREDICATES</code>：(在Oracle 10g中被废弃)</li><li><code>EXPAND_GSET_TO_UNION</code>：(在Oracle 10g中被废弃)</li></ul></li></ul><h2 id="三-hint语句归纳"><a href="#三-hint语句归纳" class="headerlink" title="三. hint语句归纳"></a>三. hint语句归纳</h2><h3 id="3-1-使用列表"><a href="#3-1-使用列表" class="headerlink" title="3.1 使用列表"></a>3.1 使用列表</h3><ol><li> <code>/*+ ALL_ROWS*/</code>：表明对语句块选择基于开销的优化方法，并获得最佳吞吐量，使资源消耗最小化。</li></ol>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ALL_ROWS*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure><ol start="2"><li><p><code>/*+ FIRST_ROWS*/</code>：表明对语句块选择基于开销的优化方法，并获得最佳响应时间，使资源消耗最小化。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FIRST_ROWS*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ CHOOSE*/</code>：表明如果数据字典中有访问表的统计信息，将基于开销的优化方法，并获得最佳的吞吐量;表明如果数据字典中没有访问表的统计信息，将基于规则开销的优化方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ CHOOSE*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ RULE*/</code>：表明对语句块选择基于规则的优化方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ RULE*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ FULL(TABLE)*/</code>：表明对表选择全局扫描的方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(A)*/</span> EMP_NO,EMP_NAM <span class="keyword">FROM</span> BSEMPMS A <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ROWID(TABLE)*/</code>：提示明确表明对指定表根据ROWID进行访问。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ROWID(BSEMPMS)*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> ROWID<span class="operator">&gt;=</span>’AAAAAAAAAAAAAA’ <span class="keyword">AND</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ CLUSTER(TABLE)*/</code>：提示明确表明对指定表选择簇扫描的访问方法，它只对簇对象有效。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ CLUSTER*/</span> BSEMPMS.EMP_NO,DPT_NO <span class="keyword">FROM</span> BSEMPMS,BSDPTMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span>’TEC304′ <span class="keyword">AND</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX(TABLE INDEX_NAME)*/</code>：表明对表选择索引的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX(BSEMPMS SEX_INDEX) USE SEX_INDEX BECAUSE THERE ARE FEWMALE BSEMPMS */</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SEX<span class="operator">=</span>’M<span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_ASC(TABLE INDEX_NAME)*/</code>：表明对表选择索引升序的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_ASC(BSEMPMS PK_BSEMPMS) */</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_COMBINE*/</code>：为指定表选择位图访问路经，如果INDEX_COMBINE中没有提供作为参数的索引，将选择出位图索引的布尔组合方式。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_COMBINE(BSEMPMS SAL_BMI HIREDATE_BMI)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SAL<span class="operator">&lt;</span><span class="number">5000000</span> <span class="keyword">AND</span> HIREDATE</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_JOIN(TABLE INDEX_NAME)*/</code>：提示明确命令优化器使用索引作为访问路径。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_JOIN(BSEMPMS SAL_HMI HIREDATE_BMI)*/</span> SAL,HIREDATE <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SAL<span class="operator">&lt;</span><span class="number">60000</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_DESC(TABLE INDEX_NAME)*/</code>：表明对表选择索引降序的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_DESC(BSEMPMS PK_BSEMPMS)*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;SCOTT&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_FFS(TABLE INDEX_NAME)*/</code>：对指定的表执行快速全索引扫描,而不是全表扫描的办法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_FFS(BSEMPMS IN_EMPNAM)*/</span>  <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TEC305&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ADD_EQUAL TABLE INDEX_NAM1,INDEX_NAM2,...*/</code>：提示明确进行执行规划的选择，将几个单列索引的扫描合起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ADD_EQUAL(BSEMPMS IN_DPTNO,IN_EMPNO,IN_SEX)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span><span class="string">&#x27;SCOTT&#x27;</span> <span class="keyword">AND</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC306&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_CONCAT*/</code>：对查询中的WHERE后面的OR条件进行转换为UNION ALL的组合查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ USE_CONCAT*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC506&#x27;</span> <span class="keyword">AND</span> SEX<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NO_EXPAND*/</code>：对于WHERE后面的OR 或者IN-LIST的查询语句，NO_EXPAND将阻止其基于优化器对其进行扩展。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ NO_EXPAND*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC506&#x27;</span> <span class="keyword">AND</span> SEX<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOWRITE*/</code>：禁止对查询块的查询重写操作。</p></li><li><p><code>/*+ REWRITE*/</code>：可以将视图作为参数。</p></li><li><p><code>/*+ MERGE(TABLE)*/</code>：能够对视图的各个查询进行相应的合并。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ MERGE(V) */</span> A.EMP_NO,A.EMP_NAM,B.DPT_NO </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS A, (SELET DPT_NO,<span class="built_in">AVG</span>(SAL) <span class="keyword">AS</span> AVG_SAL </span><br><span class="line">                 <span class="keyword">FROM</span> BSEMPMS B </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> DPT_NO) V </span><br><span class="line"><span class="keyword">WHERE</span> A.DPT_NO<span class="operator">=</span>V.DPT_NO </span><br><span class="line">  <span class="keyword">AND</span> A.SAL<span class="operator">&gt;</span>V.AVG_SAL;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NO_MERGE(TABLE)*/</code>：对于有可合并的视图不再合并。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ NO_MERGE(V)*/</span> A.EMP_NO,A.EMP_NAM,B.DPT_NO </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS A, (<span class="keyword">SELECT</span> DPT_NO,<span class="built_in">AVG</span>(SAL) <span class="keyword">AS</span> AVG_SAL </span><br><span class="line">                 <span class="keyword">FROM</span> BSEMPMS B </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> DPT_NO) V </span><br><span class="line"><span class="keyword">WHERE</span> A.DPT_NO<span class="operator">=</span>V.DPT_NO </span><br><span class="line">  <span class="keyword">AND</span> A.SAL<span class="operator">&gt;</span>V.AVG_SAL;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ORDERED*/</code>：根据表出现在FROM中的顺序，ORDERED使ORACLE依此顺序对其连接。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ORDERED*/</span> A.COL1,B.COL2,C.COL3 </span><br><span class="line"><span class="keyword">FROM</span> TABLE1 A,TABLE2 B,TABLE3 C </span><br><span class="line"><span class="keyword">WHERE</span> A.COL1<span class="operator">=</span>B.COL1 <span class="keyword">AND</span> B.COL1<span class="operator">=</span>C.COL1;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_NL(TABLE)*/</code>：将指定表与嵌套的连接的行源进行连接，并把指定表作为内部表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ORDERED USE_NL(BSEMPMS)*/</span> BSDPTMS.DPT_NO,BSEMPMS.EMP_NO,BSEMPMS.EMP_NAM </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_MERGE(TABLE)*/</code>：将指定的表与其他行源通过合并排序连接方式连接起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+USE_MERGE(BSEMPMS,BSDPTMS)*/</span> </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_HASH(TABLE)*/</code>：将指定的表与其他行源通过哈希连接方式连接起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+USE_HASH(BSEMPMS,BSDPTMS)*/</span> </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ DRIVING_SITE(TABLE)*/</code>：强制与ORACLE所选择的位置不同的表进行查询执行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+DRIVING_SITE(DEPT)*/</span>  </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,DEPT<span class="variable">@BSDPTMS</span> </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>DEPT.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ LEADING(TABLE)*/</code>：将指定的表作为连接次序中的首表。</p></li><li><p><code>/*+ CACHE(TABLE)*/</code>：当进行全表扫描时，CACHE提示能够将表的检索块放置在缓冲区缓存中最近最少列表LRU的最近使用端。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(BSEMPMS) CAHE(BSEMPMS) */</span> EMP_NAM <span class="keyword">FROM</span> BSEMPMS;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOCACHE(TABLE)*/</code>：当进行全表扫描时，CACHE提示能够将表的检索块放置在缓冲区缓存中最近最少列表LRU的最近使用端。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(BSEMPMS) NOCAHE(BSEMPMS) */</span> EMP_NAM <span class="keyword">FROM</span> BSEMPMS;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ APPEND*/</code>：直接插入到表的最后，可以提高速度。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="comment">/*+ append*/</span> <span class="keyword">into</span> test1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test4;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOAPPEND*/</code>：通过在插入语句生存期内停止并行模式来启动常规插入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="comment">/*+ noappend*/</span> <span class="keyword">into</span> test1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test4;</span><br></pre></td></tr></table></figure></li></ol><table><thead><tr><th align="center"><strong>Optimization Approaches</strong></th><th align="center"><strong>Access Methods</strong></th></tr></thead><tbody><tr><td align="center">ALL_ROWS</td><td align="center">AND_EQUAL</td></tr><tr><td align="center">CHOOSE</td><td align="center">CLUSTER</td></tr><tr><td align="center">FIRST RULES</td><td align="center">FULL</td></tr><tr><td align="center">RULE</td><td align="center">HASH</td></tr><tr><td align="center">Parallel Execution</td><td align="center">HASH_AJ</td></tr><tr><td align="center">APPEND*ORDERED</td><td align="center">HASH_SJ ***</td></tr><tr><td align="center">STAR**</td><td align="center">INDEX</td></tr><tr><td align="center">STAR_TRANSFORMATION*</td><td align="center">INDEX_ASC</td></tr><tr><td align="center">Join Operations</td><td align="center">INDEX_COMBINE*</td></tr><tr><td align="center">DRIVING_SITE*</td><td align="center">INDEX_DESC</td></tr><tr><td align="center">USE_HASH**</td><td align="center">INDEX_FFS*</td></tr><tr><td align="center">USE_MERGE</td><td align="center">MERGE_AJ**</td></tr><tr><td align="center">USE_NL</td><td align="center">MERGE_SJ***</td></tr><tr><td align="center"><strong>Additional Hints</strong></td><td align="center">ROW_ID</td></tr><tr><td align="center">CACHE</td><td align="center">USE_CONCAT</td></tr><tr><td align="center">NOCACHE</td><td align="center">NO_EXPAND***</td></tr><tr><td align="center">PUSH_SUBQ</td><td align="center">REWRITE***</td></tr><tr><td align="center">MERGE***</td><td align="center">NOREWRITE***</td></tr><tr><td align="center">NO_MERGE*</td><td align="center">Join Orders</td></tr><tr><td align="center">PUSH_JOIN_PRED***</td><td align="center"></td></tr><tr><td align="center">NO_PUSH_JOIN_PRED***</td><td align="center">NOAPPEND*</td></tr><tr><td align="center">ORDERED PREDICATES***</td><td align="center">NOPARALLEL</td></tr><tr><td align="center"></td><td align="center">PARALLEL</td></tr><tr><td align="center"></td><td align="center">PARALLEL_INDEX*</td></tr><tr><td align="center"></td><td align="center">NO_PARALLEL_INDEX***</td></tr></tbody></table><h3 id="3-2-使用注意"><a href="#3-2-使用注意" class="headerlink" title="3.2 使用注意"></a>3.2 使用注意</h3><p>使用提示需要遵循的原则：</p><ol><li>仔细检查提示语法。尽量使用完整注释语法 <code>/*+ hint */</code> 。</li><li>使用表别名。如果在查询中指定了表别名，那么提示必须也使用表别名。例如：<code>select /*+ index(e,dept_idx) */ from emp e;</code> 。</li><li>不要在提示中使用模式名称：如果在提示中指定了模式的所有者，那么提示将被忽略。例如：<code>select /*+ index(scott.emp,dept_idx) */ from emp;</code> 。</li><li>检验提示。如果提示指定了不可用的访问路径，那么这个提示将被忽略。</li></ol><p>导致提示无效的条件：</p><table><thead><tr><th>提示</th><th>被忽略的条件</th></tr></thead><tbody><tr><td>cluster</td><td>与非簇表一同使用</td></tr><tr><td>hash</td><td>与非簇表一同使用</td></tr><tr><td>hash_aj</td><td>不存在子查询</td></tr><tr><td>index</td><td>指定的索引不存在</td></tr><tr><td>index_combine</td><td>不存在位图索引</td></tr><tr><td>merge_aj</td><td>不存在子查询</td></tr><tr><td>parallel</td><td>调用的不是TABLE ACCESS FULL计划</td></tr><tr><td>push_subq</td><td>不存在子查询</td></tr><tr><td>star</td><td>事实表中存在不恰当的索引</td></tr><tr><td>use_concat</td><td>在where子句中不存在多个or条件</td></tr><tr><td>use_nl</td><td>表中不存在索引</td></tr></tbody></table><p>几种主要的优化模式：</p><ol><li>all_rows：all_rows是基于成本的优化方法，目的是提供整体最佳的吞吐量和最小的资源消耗。all_rows提示倾向使用全表扫描，而且不适用于OLTP数据库。使用all_rows提示应该保障查询中涉及的表和索引拥有使用analyze命令分析得到的统计资料。</li><li>rule：rule提示使Oracle为查询提供基于规则的优化模式。在怀疑CBO生成了非优化的执行计划时，通常首先尝试使用rule提示。Rule提示忽略表和索引的统计资料，并且使用基本的试探法生成执行计划。</li><li>first_rows：这个提示是基于成本的优化方法，目的是提供最快的反应时间。使用first_rows提示应该保障查询中涉及的表和索引拥有使用analyze命令分析得到的统计资料。</li><li>表的连接提示<ul><li>use_hash提示：use_hash 提示对指定的表进行散列连接。散列连接是Oracle用以驱动表（最小的表）向RAM区中装载记录的方法，RAM区由HASH_AREA_SIZE定义。散列连接适合中间结果比较大的情况。使用散列连接时,HASH_AREA_SIZE对速度影响非常大，如果驱动表不能一次装入内存，那么需要使用TEMP表空间，这种情况下速度比较慢。这个参数可以在session级别动态修改，需要进行散列连接时可以临时增大，速度可能显着增加。</li><li>use_merge 提示：use_merge 提示强制执行一个排序合并操作。排序合并操作通常与并行查询结合使用，因为排序合并操作倾向于全表扫描。该提示适合于生成大型结果集的查询。</li><li>use_nl：use_nl提示将强制对目标表执行嵌套循环连接。use_nl提示很少用于SQL调整，因为CBO和RBO更倾向于使用循环嵌套连接。</li><li>star提示：star 提示强制使用星型查询计划。前提是查询中至少三个表，而且在事实表中存在恰当的索引</li></ul></li><li>表反连接提示：SQL反连接是指在语句中包含NOT IN 或者NOT EXISTS子句时执行的操作。<ul><li>merge_aj：在使用全表访问比索引访问更好的情况下，可以在NOT IN子查询中使用merge_aj提示以便执行反连接。</li><li>hash_aj：hash_aj 提示放在NOT IN 子查询中用来希望执行散列连接时，执行散列反连接。hash_aj和merge_aj要求子查询列非空。</li></ul></li><li>INDEX提示：<ul><li>INDEX提示简介：INDEX提示被用于显示指定表名或表名与索引。如果只指定了表名，那么优化器将使用表中的”最优”索引。在永久优化SQL语句中，建议指定表和索引。</li><li>index_join 提示：index_join 提示明确要求优化器使用索引连接来作为访问路径。</li><li>and_equal 提示：and_equal 提示可以使多个非唯一的索引合并索引，并且使这些索引操作时就象单个连续索引一样。该提示如果被应用，在查询计划中显示的是AND-EQUAL</li><li>index_asc 提示：index_asc 提示使用升序索引。这是默认的优化器行为</li><li>no_index 提示：该提示忽略索引存在，类似full</li><li>index_combine提示：index_combine 提示用来强制使用位图索引作为表的访问路径。</li><li>index_ffs提示：索引快速完全扫描可以在不访问任何记录的情况下完成查询。</li><li>use_concat提示：use_concat提示要求为所有的OR条件使用UNION ALL执行计划，并将这个查询重新书写为多个查询。如果在WHERE子句中存在大量OR条件，可以考虑使用use_concat提示。</li></ul></li></ol><p>总结：</p><ol><li>因为提示放在注释中，所以如果提示通现存的执行计划不兼容，或者提示不正确，有可能被忽略。</li><li>在使用RBO时，可以通过提示将指定的查询更改为CBO。切记要对查询中涉及的所有表和索引进行分析</li><li>在使用CBO的时候，可以通过添加RULE提示或者FIRST_ROWS提示来开始调整一个可以的SQL语句</li><li>提示可以在子查询中使用，但是外部查询的提示不会带入子查询。</li><li>如果在查询计划中发现卡笛尔积（CARTESIAN），则要尽量解决。</li></ol><h2 id="四-深入剖析"><a href="#四-深入剖析" class="headerlink" title="四. 深入剖析"></a>四. 深入剖析</h2><h3 id="4-1-表连接hint"><a href="#4-1-表连接hint" class="headerlink" title="4.1 表连接hint"></a>4.1 表连接hint</h3><p>Oracle提供了各种类型的表连接：</p><ul><li><p>嵌套循环连接（nested loops join）：可以看作两层嵌套的for循环</p><ul><li><strong>访问次数：</strong>驱动表返回几条，被驱动表访问多少次。</li><li><strong>驱动表是否有顺序：</strong>有。</li><li><strong>是否要排序：</strong>否。</li><li><strong>应用场景：</strong><ol><li>关联中有一个表比较小；</li><li>被关联表的关联字段上有索引；</li><li>索引的键值不应该重复率很高</li></ol></li></ul></li><li><p>排序合并连接（sort merge join）</p><ul><li><p><strong>访问次数：</strong>两张表都只会访问0次或1次。</p></li><li><p><strong>驱动表是否有顺序：</strong>无。</p></li><li><p><strong>是否要排序：</strong>是。</p></li><li><p><strong>应用场景：</strong>当结果集已经排过序。</p></li><li><p>如果A表的数据为（2,1,4,5,2）,B表的数据为(2,2,1,3,1) ,首先将A表和B表全扫描后排序，如下：</p><pre><code>          A    B                1     1                2     1                2     2                4     2                5     3</code></pre><p>因为没有驱动表，所以oracle会随机选择一张表驱动，如果选择了A扫描到1，然后扫描B，当扫描=1的时候则管理，当扫描到B=2时，再以B=2为驱动扫描A表，不是从1开始扫，而是从2开始扫描，交替的进行扫描、关联。</p></li></ul></li><li><p>哈希连接（hash join）：先把驱动表的关联字段hash到PGA中（rowid也在PGA中），然后扫描被驱动表，取第一条数据，将关联的字段hash一下探测PGA中的小表，如果匹配则关联，再取第二条…。</p><ul><li><strong>访问次数：</strong>驱动表和被驱动表都只会访问0次或1次。</li><li><strong>驱动表是否有顺序：</strong>有。</li><li><strong>是否要排序：</strong>否。</li><li><strong>应用场景：</strong> <ol><li>一个大表，一个小表的关联；</li><li>表上没有索引；</li><li>返回结果集比较大。</li></ol></li></ul></li><li><p>星形连接（star join）等。</p></li></ul><p>因为表连接是所有Oracle SQL执行步骤中最耗时的，Oracle对表连接的hint经常被用来测试各种连接技术的执行速度。</p><h4 id="（1）use-hash"><a href="#（1）use-hash" class="headerlink" title="（1）use_hash"></a>（1）use_hash</h4><p>use_hash提示要求对指定的表进行散列连接。从本质上讲，散列连接是一种Oracle将驱动表（最小的表，在where子句之后的第一个表）中的行加载到由hash_area_size初始化参数定义的RAM区域的技术。</p><p>Oracle使用散列技术来定位较大的第二个表中的记录。在两个表都非常大的情况下，散列连接经常与并行查询相结合。</p><p>下面的查询是一个被提示强制使用散列连接和并行查询的例子：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+ use_hash(e,b) parallel(e, 4) parallel(b, 4) */</span></span><br><span class="line">   e.ename, hiredate, b.comm</span><br><span class="line"><span class="keyword">from</span> emp e, bonus b</span><br><span class="line"><span class="keyword">where</span> e.ename <span class="operator">=</span> b.ename;</span><br><span class="line"># 下面是哈希连接的执行计划。注意这个连接中的两个表都使用并行查询来获得它们的记录。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">3</span></span><br><span class="line">  HASH <span class="keyword">JOIN</span>                                                          <span class="number">1</span></span><br><span class="line">PARALLEL_TO_SERIAL</span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>           EMP                                  <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>           BONUS                                <span class="number">2</span></span><br></pre></td></tr></table></figure><p>哈希连接通常比嵌套的循环连接更快，特别是在查询的where子句中，驱动表被过滤成少数行的情况下。</p><p>use_hash提示是非常微妙的，有许多条件必须得到满足。发现use_hash提示被忽略的情况并不少见，下面是造成这个问题的一些常见原因：</p><ul><li><strong>检查初始化参数</strong>：确保你对 <code>optimizer_index_cost_adj</code> 、<code>hash_multiblock_io_count</code> 、<code>optimizer_max_permutations</code> 和 <code>hash_area_size</code> 有进行适当的设置。</li><li><strong>验证驱动表</strong>：确保较小的表是驱动表（从句中的第一个表）。这是因为哈希连接使用驱动表建立内存阵列。</li><li><strong>分析CBO统计数据</strong>：检查表的和/或连接的关联表的列是否得到了适当的分析。</li><li><strong>检查偏斜的列（skewed columns ）</strong>：Histograms只建议用于非均匀的列分布。如果有必要，你可以使用 <code>ordered</code> 提示覆盖基于成本的优化器选择的连接顺序。</li><li><strong>检查RAM区域：</strong>确保 <code>hash_area_size</code> 足够大，以便在内存中容纳较小的表。否则，Oracle必须写到TEMP表空间，减慢散列连接的速度。</li></ul><h4 id="（2）use-merge"><a href="#（2）use-merge" class="headerlink" title="（2）use_merge"></a>（2）use_merge</h4><p>use_merge提示强制进行分类合并操作。排序合并操作经常与并行查询一起使用，因为排序合并连接总是对表进行全表扫描。排序合并连接通常最适合于产生非常大的结果集的查询，例如每日报告或表的细节汇总查询，或者在连接键上不具有索引的表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 通过对两个表的并行查询来执行分类合并的</span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ use_merge(e,b) parallel(e, 4) parallel(b, 4) */</span></span><br><span class="line">   e.ename, hiredate, b.comm</span><br><span class="line"><span class="keyword">from</span> emp e, bonus b</span><br><span class="line"><span class="keyword">where</span> e.ename <span class="operator">=</span> b.ename;</span><br><span class="line"># 注意全表扫描和排序合并操作。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">5</span></span><br><span class="line">  <span class="keyword">MERGE</span> <span class="keyword">JOIN</span>                                                         <span class="number">1</span></span><br><span class="line">PARALLEL_TO_SERIAL</span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        <span class="number">1</span></span><br><span class="line">PARALLEL_COMBINED_WITH_PARENT</span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>         EMP                                  <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        <span class="number">2</span></span><br><span class="line">PARALLEL_COMBINED_WITH_PARENT</span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>         BONUS                                <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br></pre></td></tr></table></figure><p>值得注意的是，排序合并连接并不使用索引来连接表。在大多数情况下，索引访问更快，但是排序合并连接可能适合于没有where子句的大型表连接，或者没有可用索引连接表的查询。</p><h3 id="4-2-表反连接hint（Anti-Join）"><a href="#4-2-表反连接hint（Anti-Join）" class="headerlink" title="4.2 表反连接hint（Anti-Join）"></a>4.2 表反连接hint（Anti-Join）</h3><p>SQL的反连接是一种操作，一般在SQL语句中指定 <code>NOT IN</code> 或 <code>NOT EXISTS</code> 子句时使用。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">   customer_name</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">   customer</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">   customer_number <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">       customer_number</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">       bad_credit_history</span><br><span class="line">   )</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>一般不建议使用NOT IN（调用子查询），而是使用NOT EXISTS（调用相关的子查询），因为如果子查询返回的任何记录包含空值，则查询不返回任何记录。</p><h4 id="（1）merge-aj"><a href="#（1）merge-aj" class="headerlink" title="（1）merge_aj"></a>（1）merge_aj</h4><p>merge_aj用于NOT IN子查询中，来执行反连接，表示全表访问优先于索引访问。</p><p>一个NOT IN案例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 查询所有没有销售员的部门的名称。</span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 当子查询中的数据列允许为空值时，这种类型的查询的性能会非常差。子查询对于外部查询块中的每一条记录都要重新执行一次<span class="operator">!</span> 下面是执行计划：</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">1</span></span><br><span class="line">  <span class="keyword">FILTER</span>                                                             <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>             DEPT                               <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID   EMP                                <span class="number">2</span></span><br><span class="line">      INDEX <span class="keyword">RANGE</span> SCAN            JOB_IDX                            <span class="number">1</span></span><br></pre></td></tr></table></figure><p>NOT IN子查询有替代方法，它不会为外层查询块中的每条记录重新生成一次子查询；当外层查询块产生大量的记录时，应该考虑这种方法。</p><p>这个方法只能在子查询列上存在NOT NULL谓词并且你在子查询块中有一个hint时使用。根据所需的连接类型，反连接可以通过hash_aj或merge_aj的hint来执行。</p><p>注意：<strong>反连接提示merge_aj和hash_aj只有在not in子句中要求的列有NOT NULL约束时才会起作用。</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 优化后：</span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> <span class="comment">/*+ merge_aj */</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 查询的执行计划发生了变化，合并反连接被调用，代替了过滤操作。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">5</span></span><br><span class="line">  <span class="keyword">MERGE</span> <span class="keyword">JOIN</span> ANTI                                                    <span class="number">1</span></span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        </span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>                  DEPT                        <span class="number">1</span></span><br><span class="line">    SORT <span class="keyword">UNIQUE</span>                                                      <span class="number">2</span></span><br><span class="line">      <span class="keyword">VIEW</span>                               VW_NSO_1                    <span class="number">1</span></span><br><span class="line">        <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID      EMP                         <span class="number">1</span></span><br><span class="line">          INDEX <span class="keyword">RANGE</span> SCAN               JOB_IDX                     <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="（2）hash-aj"><a href="#（2）hash-aj" class="headerlink" title="（2）hash_aj"></a>（2）hash_aj</h4><p>hash_aj提示被放置在一个not in子查询中，以便在需要散列连接的情况下执行散列反连接。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> <span class="comment">/*+ hash_aj */</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 执行计划指定了一个散列连接，并对部门表进行全表扫描：</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">3</span></span><br><span class="line">  HASH <span class="keyword">JOIN</span> ANTI                                                     <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>               DEPT                             <span class="number">1</span></span><br><span class="line">    <span class="keyword">VIEW</span>                            VW_NSO_1                         <span class="number">2</span></span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID   EMP                              <span class="number">1</span></span><br><span class="line">        INDEX <span class="keyword">RANGE</span> SCAN            JOB_IDX                          <span class="number">1</span></span><br></pre></td></tr></table></figure><p>总之，merge_aj和hash_aj提示可以极大地提高NOT IN子查询的性能，前提是子查询的列是NOT NULL。</p><h2 id="五-案例"><a href="#五-案例" class="headerlink" title="五. 案例"></a>五. 案例</h2><h3 id="5-1-NOT-EXISTS优化"><a href="#5-1-NOT-EXISTS优化" class="headerlink" title="5.1 NOT EXISTS优化"></a>5.1 NOT EXISTS优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_d, e.col_e, e.col_f, e.col_g,e.col_h</span><br><span class="line"><span class="keyword">from</span> Table_A e </span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_c <span class="keyword">in</span> (<span class="keyword">select</span> a.col_c</span><br><span class="line">      <span class="keyword">from</span> Table_A a</span><br><span class="line">                      <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a </span><br><span class="line">    <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                        <span class="keyword">and</span> a.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                        <span class="keyword">and</span> a.col_d <span class="keyword">in</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">                            <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> Table_B b </span><br><span class="line">                            <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                              <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">                              <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b </span><br><span class="line">                              <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"># 修改为：</span><br><span class="line">                  </span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+LEADING(D) NO_MERGE(D)*/</span></span><br><span class="line">   e.col_a, e.col_b, e.col_c,e.col_d, e.col_e, e.col_f, e.col_g, e.col_h</span><br><span class="line"><span class="keyword">from</span> Table_A e, (<span class="keyword">select</span> <span class="keyword">DISTINCT</span> a.col_c</span><br><span class="line"> <span class="keyword">from</span> Table_A a</span><br><span class="line"> <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a</span><br><span class="line">   <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">   <span class="keyword">and</span> a.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                   <span class="keyword">and</span> a.col_d <span class="keyword">in</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">                   <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="comment">/*+ HASH_AJ*/</span><span class="number">1</span></span><br><span class="line">               <span class="keyword">from</span> Table_B b</span><br><span class="line">                                   <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                                     <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c</span><br><span class="line">                                     <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">                                     <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))) D</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">AND</span> e.col_c <span class="operator">=</span> D.col_c;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c.col_a,c.col_b,c.col_c,c.col_e,c.col_g,c.col_f,c.col_i,</span><br><span class="line">c.col_d,c.col_j,c.col_k,c.col_l</span><br><span class="line"><span class="keyword">from</span> Table_A c</span><br><span class="line"><span class="keyword">where</span> c.col_a <span class="operator">=</span> :col_a </span><br><span class="line">  <span class="keyword">and</span> c.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>) </span><br><span class="line">  <span class="keyword">and</span> c.col_b <span class="operator">&lt;=</span> :trade_date </span><br><span class="line">  <span class="keyword">and</span> c.col_c <span class="keyword">in</span> (<span class="keyword">select</span> col_c </span><br><span class="line">                  <span class="keyword">from</span> Table_A a</span><br><span class="line">  <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                    <span class="keyword">and</span> a.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                    <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                    <span class="keyword">and</span> a.col_j <span class="operator">=</span> <span class="number">38</span></span><br><span class="line">                    <span class="keyword">and</span> a.col_d <span class="operator">=</span> <span class="string">&#x27;64&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.col_h <span class="keyword">in</span> (<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>)</span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> Table_B b </span><br><span class="line">                            <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                              <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">                              <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b </span><br><span class="line">                              <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">                    )</span><br><span class="line">                 )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改为：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+LEADING(D) NO_MERGE(D)*/</span> </span><br><span class="line">       C.col_a,</span><br><span class="line">       C.col_b,</span><br><span class="line">       C.col_c,</span><br><span class="line">       C.col_e,</span><br><span class="line">       C.col_g,</span><br><span class="line">       C.col_f,</span><br><span class="line">       C.col_i,</span><br><span class="line">       C.col_d,</span><br><span class="line">       C.col_j,</span><br><span class="line">       C.col_k,</span><br><span class="line">       C.col_l</span><br><span class="line"><span class="keyword">FROM</span> Table_A C,(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> col_c</span><br><span class="line">                <span class="keyword">FROM</span> Table_A A</span><br><span class="line">                <span class="keyword">WHERE</span> A.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                  <span class="keyword">AND</span> A.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                <span class="keyword">AND</span> A.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                <span class="keyword">AND</span> A.col_j <span class="operator">=</span> <span class="number">38</span></span><br><span class="line">                <span class="keyword">AND</span> A.col_d <span class="operator">=</span> <span class="string">&#x27;64&#x27;</span></span><br><span class="line">                <span class="keyword">AND</span> A.col_h <span class="keyword">IN</span> (<span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;16&#x27;</span>)</span><br><span class="line">                <span class="keyword">AND</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">                    <span class="keyword">SELECT</span> <span class="comment">/*+ HASH_AJ*/</span><span class="number">1</span></span><br><span class="line">                    <span class="keyword">FROM</span> Table_B B</span><br><span class="line">                    <span class="keyword">WHERE</span> B.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                      <span class="keyword">AND</span> A.col_c <span class="operator">=</span> B.col_c</span><br><span class="line">                      <span class="keyword">AND</span> A.col_b <span class="operator">=</span> B.col_b</span><br><span class="line">                      <span class="keyword">AND</span> B.TRADE_TYPE <span class="keyword">IN</span> (<span class="number">6</span>,<span class="number">7</span>))) D</span><br><span class="line"><span class="keyword">WHERE</span> C.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">AND</span> C.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">AND</span> C.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">AND</span> C.col_c <span class="operator">=</span> D.col_c</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_e, e.col_g, e.col_f, e.col_i,e.col_n, e.col_o, e.col_d, e.col_p, e.col_q, e.col_r, e.col_s, e.col_t, e.col_u, e.col_j, e.col_v, e.col_w, e.col_k, e.col_x</span><br><span class="line"><span class="keyword">from</span> Table_A e</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_j <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">37</span>)</span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">      <span class="keyword">select</span> <span class="number">1</span> </span><br><span class="line">      <span class="keyword">from</span> Table_B b </span><br><span class="line">      <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">        <span class="keyword">and</span> e.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">        <span class="keyword">and</span> e.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">        <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_y</span><br><span class="line"></span><br><span class="line"># 修改为： </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_e,e.col_g, e.col_f, e.col_i,e.col_n, e.col_o, e.col_d, e.col_p,e.col_q, e.col_r, e.col_s, e.col_t,e.col_u, e.col_j, e.col_v, e.col_w, e.col_k, e.col_x</span><br><span class="line"><span class="keyword">from</span> Table_A e</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_j <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">37</span>)</span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> ( </span><br><span class="line">      <span class="keyword">select</span> <span class="comment">/*+ HASH_AJ*/</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">from</span> Table_B b</span><br><span class="line">      <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a</span><br><span class="line">        <span class="keyword">and</span> e.col_c <span class="operator">=</span> b.col_c</span><br><span class="line">        <span class="keyword">and</span> e.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">        <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_y</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#i17496">Using Optimizer Hints</a></p><p>🔗 <a href="https://www.oradev.com/hints.jsp">Hints for Oracle sql performance</a></p><p>🔗 <a href="https://www.cnblogs.com/sopost/archive/2010/10/11/2190076.html">ORACLE常用SQL优化hint语句</a></p><p>🔗 <a href="https://www.cnblogs.com/emilyyoucan/p/7844795.html">oracle中hint 详解</a></p><p>🔗 <a href="http://www.remote-dba.net/t_op_sql_join_hints.htm">Table Join Hints</a></p><p>🔗 <a href="http://www.remote-dba.net/t_op_sql_anti_join_hints.htm">Table Anti-Join Hints</a></p><p>🔗 <a href="https://blog.csdn.net/stevendbaguo/article/details/13775915">嵌套循环连接(nested loops join)原理</a></p>]]></content>
    
    
    <summary type="html">内容包括：等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>MySql临时表</title>
    <link href="http://linyishui.top/2021082701.html"/>
    <id>http://linyishui.top/2021082701.html</id>
    <published>2021-08-27T03:19:24.000Z</published>
    <updated>2021-08-31T01:14:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="临时表"><a href="#临时表" class="headerlink" title="临时表"></a>临时表</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><p>非压缩的，用户创建的临时表和磁盘内部临时表共享一个存储空间，通过 <code>innodb_temp_data_file_path</code> 变量定义临时表空间数据文件的相对路径、名称、大小和属性。默认为 <code>innodb_data_home_dir</code> 目录下创建一个名为ibtmp1的自动扩展的数据文件，该文件略大于12MB。</p><p><strong>临时表空间会在正常关机或初始化中止时被移除，并在每次服务器启动时被重新创建。如果服务器意外停止，临时表空间不会被删除。在这种情况下，数据库管理员可以手动删除临时表空间，或者重新启动服务器，服务器会自动删除并重新创建临时表空间。</strong></p><p><em>（5.6版本，非压缩的临时表是在临时文件目录中的每个文件的表空间中创建的，在MySQL 5.7中引入的共享临时表空间消除了与为每个临时表创建和删除逐个文件表空间有关的性能成本）</em></p><p>在 MySQL 5.7 之前， SQL 运行中产生的临时表是 MYISAM，而且只能是 MYISAM。MySQL 从 5.7 开始提供了参数 <code>Internal_tmp_mem_storage_engine</code> 来定义内部的临时表引擎，可选值为 MYISAM 和 INNODB 。内部的临时表默认保存在临时表空间 ibtmp1 (可以用参数 <code>innodb_temp_data_file_path</code> 设置大小等)。需要注意控制 ibtmp1 的大小，防止把磁盘撑爆。</p><p>但是MySQL 5.7 之前都没有解决如下问题：</p><ul><li>VARCHAR的变长存储。如果临时表的字段定义是 <code>VARCHAR(200)</code> ，映射到内存里处理的字段变为<code>CHAR(200)</code> ，假设 <code>VARCHAR(200)</code> 只存一个字符会造成浪费。</li><li>大对象的默认磁盘存储，比如 TEXT，BLOB， JSON等，不管里面存放了什么，直接转化为磁盘存储。</li></ul><p>MySQL 8.0 开始，专门实现了一个临时表的引擎 TempTable , 解决了 VARCHAR 字段的边长存储以及大对象的内存存储。由变量 <code>interal_tmp_mem_storage_engine</code> 来控制，可选值为 <code>TempTable</code>（默认）和 <code>Memory</code> ；新引擎的大小由参数 <code>temp_table_max_ram</code> 来控制，默认为1G。超过了则存储在磁盘上（ibtmp1）。并且计数器由性能字典的表 <code>memory_summary_global_by_event_name</code> 来存储。</p><h2 id="二-查看当前临时表信息"><a href="#二-查看当前临时表信息" class="headerlink" title="二. 查看当前临时表信息"></a>二. 查看当前临时表信息</h2><p><code>INFORMATION_SCHEMA.FILES</code> 提供关于InnoDB临时表空间的元数据，这些临时表目前在InnoDB实例中是活跃的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES <span class="keyword">WHERE</span> TABLESPACE_NAME<span class="operator">=</span><span class="string">&#x27;innodb_temporary&#x27;</span>;</span><br></pre></td></tr></table></figure><p>那么这两种临时表的计数器通常用 <code>show global status like &#39;%tmp_%tables%&#39;</code>  来查看。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;%tmp_%tables%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%tmp_%tables%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Created_tmp_disk_tables <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Created_tmp_tables      <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>以上结果分别代表，只创建磁盘上的临时表计数以及临时表的总计数。这两个计数器由参数 <code>tmp_table_size</code> 和 <code>max_heap_table_size</code> 两个取最小值来控制。</p><p><code>memory/ temptable/physical_disk</code> 代表放入磁盘上的临时表计数情况，<code>memory/temptable/physical_ram</code>  代表放入内存的临时表计数情况。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema. memory_summary_global_by_event_name <span class="keyword">WHERE</span> event_name <span class="keyword">like</span> <span class="string">&#x27;%temptable%&#x27;</span>G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>                  EVENT_NAME: <span class="operator">*</span><span class="operator">*</span>memory<span class="operator">/</span>temptable<span class="operator">/</span>physical_disk<span class="operator">*</span><span class="operator">*</span>                 </span><br><span class="line">COUNT_ALLOC: <span class="number">0</span>                  </span><br><span class="line">COUNT_FREE: <span class="number">0</span>   </span><br><span class="line">SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">0</span>    </span><br><span class="line">SUM_NUMBER_OF_BYTES_FREE: <span class="number">0</span>              </span><br><span class="line">LOW_COUNT_USED: <span class="number">0</span>          </span><br><span class="line">CURRENT_COUNT_USED: <span class="number">0</span>             </span><br><span class="line">HIGH_COUNT_USED: <span class="number">0</span>    </span><br><span class="line">LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span>   </span><br><span class="line">HIGH_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>                  EVENT_NAME: <span class="operator">*</span><span class="operator">*</span>memory<span class="operator">/</span>temptable<span class="operator">/</span>physical_ram<span class="operator">*</span><span class="operator">*</span>                 </span><br><span class="line">COUNT_ALLOC: <span class="number">1</span>                  </span><br><span class="line">COUNT_FREE: <span class="number">0</span>   </span><br><span class="line">SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">1048576</span>    </span><br><span class="line">SUM_NUMBER_OF_BYTES_FREE: <span class="number">0</span>              </span><br><span class="line">LOW_COUNT_USED: <span class="number">0</span>          </span><br><span class="line">CURRENT_COUNT_USED: <span class="number">1</span>             </span><br><span class="line">HIGH_COUNT_USED: <span class="number">1</span>    </span><br><span class="line">LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">1048576</span>   </span><br><span class="line">HIGH_NUMBER_OF_BYTES_USED: <span class="number">1048576</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure><h2 id="三-临时表空间大小"><a href="#三-临时表空间大小" class="headerlink" title="三. 临时表空间大小"></a>三. 临时表空间大小</h2><p>默认情况下，临时表空间数据文件是自动扩展的，并根据需要增加大小以适应磁盘上的临时表。例如，如果一个操作创建了一个大小为20MB的临时表，临时表空间数据文件在创建时默认为12MB大小，它的大小会扩展以适应它。当临时表被丢弃时，释放的空间可以重新用于新的临时表，但是<strong>数据文件仍然是扩展的大小</strong>。</p><p>在使用大型临时表或广泛使用临时表的环境中，<strong>自动扩展的临时表空间数据文件可能变得很大</strong>。一个大的数据文件也可能来自使用临时表的长期运行的查询。</p><p>通过检查 <code>innodb_temp_data_file_path</code> 设置确认一个临时表空间数据文件是否是自动扩展的：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> @<span class="variable">@innodb</span>_temp_data_file_path;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb</span>_temp_data_file_path <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> ibtmp1:<span class="number">12</span>M:autoextend        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br></pre></td></tr></table></figure><p>检查临时表空间数据文件的大小：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> FILE_NAME, TABLESPACE_NAME, ENGINE, INITIAL_SIZE, TOTAL_EXTENTS<span class="operator">*</span>EXTENT_SIZE</span><br><span class="line">       <span class="keyword">AS</span> TotalSizeBytes, DATA_FREE, MAXIMUM_SIZE <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES</span><br><span class="line">       <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;innodb_temporary&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      FILE_NAME: .<span class="operator">/</span>ibtmp1</span><br><span class="line">TABLESPACE_NAME: innodb_temporary</span><br><span class="line">         ENGINE: InnoDB</span><br><span class="line">   INITIAL_SIZE: <span class="number">12582912</span></span><br><span class="line"> TotalSizeBytes: <span class="number">12582912</span></span><br><span class="line">      DATA_FREE: <span class="number">6291456</span></span><br><span class="line">   MAXIMUM_SIZE: <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure><p><code>TotalSizeBytes</code> 表示临时表空间数据文件的当前大小。</p><p>临时表相关配置：</p><ul><li><code>tmp_table_size</code> ：指定系统创建的内存临时表最大大小； </li><li><code>max_heap_table_size</code> : 指定用户创建的内存表的最大大小；</li></ul><p>注意：最终的系统创建的内存临时表大小是取上述两个配置值的最小值。</p><h2 id="四-MySQL创建临时表的场景"><a href="#四-MySQL创建临时表的场景" class="headerlink" title="四. MySQL创建临时表的场景"></a>四. MySQL创建临时表的场景</h2><p>MySQL临时表分为<strong>内存临时表</strong>和<strong>磁盘临时表</strong>，其中内存临时表使用MySQL的MEMORY存储引擎，磁盘临时表使用MySQL的MyISAM存储引擎；</p><p>一般情况下，MySQL会先创建内存临时表，但内存临时表超过配置指定的值后，MySQL会将内存临时表导出到磁盘临时表；Linux平台上缺省是/tmp目录，/tmp目录小的系统需要注意。</p><h3 id="4-1-内存临时表"><a href="#4-1-内存临时表" class="headerlink" title="4.1 内存临时表"></a>4.1 内存临时表</h3><p><strong>MySQL在以下几种情况会创建临时表：</strong></p><ol><li>UNION查询；</li><li>用到TEMPTABLE算法或者是UNION查询中的视图；</li><li>ORDER BY和GROUP BY的子句不一样时， 例如：<code>ORDERY BY price GROUP BY name</code> ；</li><li>表连接中，ORDER BY的列不是驱动表中的。在JOIN查询中，ORDER BY或者GROUP BY使用了不是第一个表的列，例如：<code>SELECT * from TableA, TableB ORDER BY TableA.price GROUP by TableB.name</code> ；</li><li>ORDER BY中使用了DISTINCT关键字 <code>ORDERY BY DISTINCT(price)</code> ；</li><li>SQL中用到SQL_SMALL_RESULT选项时，SELECT语句中指定了SQL_SMALL_RESULT关键字，意思就是告诉MySQL结果会很小，请直接使用内存临时表，不需要使用索引排序 SQL_SMALL_RESULT必须和GROUP BY、DISTINCT或DISTINCTROW一起使用 一般情况下，我们没有必要使用这个选项，让MySQL服务器选择即可。</li><li>FROM中的子查询；</li><li>子查询或者semi-join时创建的表；</li></ol><p>EXPLAIN 查看执行计划结果的 Extra 列中，如果包含 <a href="http://imysql.com/2015/06/14/mysql-faq-what-important-information-in-explain.shtml">Using Temporary</a> 就表示会用到临时表。</p><p>当然了，如果临时表中需要存储的数据量超过了上限（ <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_tmp_table_size">tmp-table-size</a> 或 <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_max_heap_table_size">max-heap-table-size</a> 中取其大者），这时候就需要生成基于磁盘的临时表了。</p><h3 id="4-2-磁盘临时表"><a href="#4-2-磁盘临时表" class="headerlink" title="4.2 磁盘临时表"></a>4.2 磁盘临时表</h3><p><strong>在以下几种情况下，会创建磁盘临时表：</strong></p><ol><li>数据表中包含BLOB/TEXT列；</li><li>在 <code>GROUP BY</code> 或者 <code>DISTINCT</code> 的列中有超过512字符的字符类型列（或者超过 512字节的二进制类型列，在5.6.15之前只管是否超过512字节）；</li><li>在 <code>SELECT</code> 、<code>UNION</code> 、<code>UNION ALL</code> 查询中，SELECT子句存在最大长度超过512的列（对于字符串类型是512个字符，对于二进制类型则是512字节）；</li><li>执行 <code>SHOW COLUMNS</code> / <code>FIELDS</code> 、<code>DESCRIBE</code> 等SQL命令，因为它们的执行结果用到了BLOB列类型。</li></ol><p>从5.7.5开始，新增一个系统选项 <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine">internal_tmp_disk_storage_engine</a> 可定义磁盘临时表的引擎类型为 InnoDB，而在这以前，只能使用MyISAM。而在5.6.3以后新增的系统选项 <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_default_tmp_storage_engine">default_tmp_storage_engine</a> 是控制 <code>CREATE TEMPORARY TABLE</code> 创建的临时表的引擎类型，在以前默认是MEMORY，不要把这二者混淆了。</p><p>见下例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;InnoDB&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:22 #sql4b0e_10_0.frm -- InnoDB引擎的临时表</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql 98304 Jul  7 15:22 #sql4b0e_10_0.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:25 #sql4b0e_10_2.frm</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;MyISAM&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql     0 Jul  7 15:25 #sql4b0e_10_2.MYD -- MyISAM引擎的临时表</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  1024 Jul  7 15:25 #sql4b0e_10_2.MYI</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;MEMORY&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:26 #sql4b0e_10_3.frm -- MEMORY引擎的临时表</span></span><br></pre></td></tr></table></figure><p>用户自定义的临时表，比如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> temporary <span class="keyword">table</span> (id <span class="type">int</span>, str1 <span class="type">varchar</span>(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p>SQL执行过程中产生的内部临时表，比如：<code>UNION</code>  , 聚合类 <code>ORDER BY</code> ，派生表，大对象字段的查询，子查询或者半连接的固化等场景。</p><h2 id="五-临时表优化"><a href="#五-临时表优化" class="headerlink" title="五. 临时表优化"></a>五. 临时表优化</h2><p><strong>表的设计原则：</strong>使用临时表一般都意味着性能比较低，特别是使用磁盘临时表，性能更慢，因此我们在实际应用中应该尽量避免临时表的使用。 常见的避免临时表的方法有：</p><ol><li>创建索引：在ORDER BY或者GROUP BY的列上创建索引；</li><li>分拆很长的列：一般情况下，TEXT、BLOB，大于512字节的字符串，基本上都是为了显示信息，而不会用于查询条件， 因此表设计的时候，应该将这些列独立到另外一张表。</li></ol><p><strong>SQL优化：</strong>如果表的设计已经确定，修改比较困难，那么也可以通过优化SQL语句来减少临时表的大小，以提升SQL执行效率。</p><p><strong>常见的优化SQL语句方法如下：</strong></p><ol><li>拆分SQL语句：临时表主要是用于排序和分组，很多业务都是要求排序后再取出详细的分页数据，这种情况下可以将排序和取出详细数据拆分成不同的SQL，以降低排序或分组时临时表的大小，提升排序和分组的效率，我们的案例就是采用这种方法。</li><li>优化业务，去掉排序分组等操作：有时候业务其实并不需要排序或分组，仅仅是为了好看或者阅读方便而进行了排序，例如数据导出、数据查询等操作，这种情况下去掉排序和分组对业务也没有多大影响。</li></ol><p>如何判断使用了临时表？使用 <code>explain</code> 查看执行计划，Extra列看到 <code>Using temporary</code> 就意味着使用了临时表。</p><p>案例：</p><ol><li><p>【问题描述】：定位到一个慢查询，查询时服务器IO飙升，IO占用率达到100%， 执行时间长达7s左右。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.<span class="operator">*</span>, cp.name <span class="keyword">AS</span> cp_name, c.name <span class="keyword">AS</span> category_name, t.name <span class="keyword">AS</span> type_name </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp </span><br><span class="line"><span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c </span><br><span class="line"><span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t </span><br><span class="line"><span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure></li><li><p>【问题分析】：使用explain查看执行计划，结果：<code>Using temporary</code> 和 <code>Using filesort</code> 。这条sql语句的问题其实还是比较明显的：查询了大量数据(包括数据条数、以及g.* )，然后使用临时表order by，但最终又只返回了20条数据。观察到的IO高，是因为sql语句生成了一个巨大的临时表，内存放不下，于是全部拷贝到磁盘，导致IO飙升。</p></li><li><p>【优化方案】：优化的总体思路是拆分sql，将排序操作和查询所有信息的操作分开。</p><ol><li><p>第一条语句：查询符合条件的数据，只需要查询g.id即可：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.id </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp <span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c <span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t <span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> LIMIT <span class="number">20</span> ;</span><br></pre></td></tr></table></figure></li><li><p>第二条语句：查询符合条件的详细数据，将第一条sql的结果使用in操作拼接到第二条的sql：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.<span class="operator">*</span>, cp.name <span class="keyword">AS</span> cp_name,c.name <span class="keyword">AS</span> category_name,t.name <span class="keyword">AS</span> type_name </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp <span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c <span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t <span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> g.id <span class="keyword">in</span>(…………………) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> ;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>【实测效果】：在SATA机器上测试，优化前大约需要50s，优化后第一条0.3s，第二条0.1s，优化后执行速度是原来的100倍以上，IO从100%降到不到1%；在SSD机器上测试，优化前大约需要7s，优化后第一条0.3s，第二条0.1s，优化后执行速度是原来的10倍以上，IO从100%降到不到1%。可以看出，优化前磁盘io是性能瓶颈，SSD的速度要比SATA明显要快，优化后磁盘不再是瓶颈，SSD和SATA性能没有差别。</p></li><li><p>【理论分析】：MySQL在执行SQL查询时可能会用到临时表，一般情况下，用到临时表就意味着性能较低。</p></li></ol><h2 id="六-扩展"><a href="#六-扩展" class="headerlink" title="六. 扩展"></a>六. 扩展</h2><h3 id="6-1-INFORMATION-SCHEMA-FILES-介绍"><a href="#6-1-INFORMATION-SCHEMA-FILES-介绍" class="headerlink" title="6.1 INFORMATION_SCHEMA.FILES 介绍"></a>6.1 INFORMATION_SCHEMA.FILES 介绍</h3><p>表结构:</p><ul><li><p><code>FILE_ID</code> ：</p><ul><li>For <code>InnoDB</code> ：表空间ID，也被称为 <code>space_id</code> 或 <code>fil_space_t::id</code> 。</li><li>For <code>NDB</code> ：一个文件标识符。<code>FILE_ID</code> 列的值是自动生成的。</li></ul></li><li><p><code>FILE_NAME</code> ：</p><ul><li>For <code>InnoDB</code> ：数据文件的名称。<ul><li>表空间包含单个InnoDB表的数据和索引（File-per-table）和一般表空间的文件名扩展名为 <code>.ibd</code> 。</li><li>Undo 表空间的前缀是 <code>undo</code> 。 </li><li>系统表空间的前缀是 <code>ibdata</code> 。 </li><li>临时表空间的前缀是 <code>ibtmp</code> 。 </li><li>文件名包括文件路径，可以是相对于MySQL数据目录 （the value of the <code>datadir</code> system variable）。</li></ul></li><li>For <code>NDB</code> ：由 <code>CREATE LOGFILE GROUP</code> 或 <code>ALTER LOGFILE GROUP</code> 创建的 <code>UNDO</code> 日志文件名； 或由 <code>CREATE TABLESPACE</code> 或 <code>ALTER TABLESPACE</code> 创建的数据文件名。</li></ul></li><li><p><code>FILE_TYPE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：表空间文件的类型。<code>InnoDB</code> 文件有三种可能的文件类型：</p><ul><li><p><code>TABLESPACE</code> 是任何系统的、一般的、或 <code>file-per-table</code> 文件的表空间文件的文件类型，它持有表、索引、或其他形式的用户数据。</p></li><li><p><code>TEMPORARY</code> 是临时表空间的文件类型。</p></li><li><p><code>UNDO LOG</code> 是UNDO表空间的文件类型，用于保存撤销记录。</p></li></ul></li><li><p>For <code>NDB</code> ： <code>UNDO LOG</code> 、<code>DATAFILE</code> 或 <code>TABLESPACE</code> 中的一个。</p></li></ul></li><li><p><code>TABLESPACE_NAME</code> ：与该文件相关的表空间的名称。</p></li><li><p><code>TABLE_CATALOG</code> ：这个值总是空的。</p></li><li><p><code>TABLE_SCHEMA</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>TABLE_NAME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LOGFILE_GROUP_NAME</code> ：</p><ul><li>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</li><li>For <code>NDB</code> ：日志文件或数据文件所属的日志文件组的名称。</li></ul></li><li><p><code>LOGFILE_GROUP_NUMBER</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：对于磁盘数据UNDO日志文件，自动生成的日志文件组的ID号码，该日志文件属于该组。这与 <code>ndbinfo.dict_obj_info</code>表中的 <code>id</code> 列以及 <code>ndbinfo.logspaces</code> 和 <code>ndbinfo.logspaces</code> 表中的 <code>log_id</code> 列所显示的该UNDO日志文件的值相同。</p></li></ul></li><li><p><code>ENGINE</code> ：</p><ul><li>For <code>InnoDB</code> ：这个值总是 <code>InnoDB</code> 。</li><li>For <code>NDB</code> ：这个值总是 <code>ndbcluster</code> 。</li></ul></li><li><p><code>FULLTEXT_KEYS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DELETED_ROWS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>UPDATE_COUNT</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>FREE_EXTENTS</code> ：</p><ul><li>For <code>InnoDB</code> ：当前数据文件中完全空闲的扩展数。</li><li>For <code>NDB</code> ：文件尚未使用的extents的数量。</li></ul></li><li><p><code>TOTAL_EXTENTS</code> ：</p><ul><li>For <code>InnoDB</code> ：在当前数据文件中使用的完整扩展的数量。文件末尾的任何部分范围都不计算在内。</li><li>For <code>NDB</code> ：分配给文件的总扩展数。</li></ul></li><li><p><code>EXTENT_SIZE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：</p><ul><li>对于页面大小为4KB、8KB或16KB的文件，其Extent大小为1048576（1MB）。</li><li>对于页面大小为32KB的文件，Extent大小为2097152字节（2MB）。</li><li>对于页面大小为64KB的文件，Extent大小为4194304字节（4MB）。</li></ul><p><code>FILES</code> 不包括 <code>InnoDB</code> 的页面大小。页面大小是由 <code>innodb_page_size</code> 系统变量统计。也可以从 <code>INNODB_SYS_TABLESPACES</code> 表中检索Extent的大小信息，其中 <code>FILES.FILE_ID = INNODB_SYS_TABLESPACES.SPACE</code> 。</p></li><li><p>For <code>NDB</code> ：文件的范围大小，以字节为单位。</p></li></ul></li><li><p><code>INITIAL_SIZE</code> ：</p><ul><li>For <code>InnoDB</code> ：文件的初始大小，以字节为单位。</li><li>For <code>NDB</code> ：文件的大小，单位是字节。用于创建文件的 <code>CREATE LOGFILE GROUP</code> 、<code>ALTER LOGFILE GROUP</code> 、<code>CREATE TABLESPACE</code> 或 <code>ALTER TABLESPACE</code> 语句的 <code>INITIAL_SIZE</code> 子句中使用的值相同。</li></ul></li><li><p><code>MAXIMUM_SIZE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：文件中允许的最大字节数。除了预定义的系统表空间数据文件，所有数据文件的值都是<code>NULL</code> 。</p><ul><li>最大的系统表空间文件大小是由 <code>innodb_data_file_path</code> 定义的。</li><li>最大的临时表空间文件大小是由 <code>innodb_temp_data_file_path</code> 定义的。</li><li>一个预定义的系统表空间数据文件的 <code>NULL</code> 值表示没有明确定义文件的大小限制。</li></ul></li><li><p>For <code>NDB</code> ：这个值总是与 <code>INITIAL_SIZE</code> 值相同。</p></li></ul></li><li><p><code>AUTOEXTEND_SIZE</code> ：表空间的自动扩展大小。对于<code>NDB</code>，<code>AUTOEXTEND_SIZE</code> 总是 <code>NULL</code> 。</p></li><li><p><code>CREATION_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LAST_UPDATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LAST_ACCESS_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>RECOVER_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>TRANSACTION_COUNTER</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>VERSION</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：文件的版本号。</p></li></ul></li><li><p><code>ROW_FORMAT</code></p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：<code>FIXED</code> 或 <code>DYNAMIC</code> 其中一个。</p></li></ul></li><li><p><code>TABLE_ROWS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>AVG_ROW_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DATA_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>MAX_DATA_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>INDEX_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DATA_FREE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：整个表空间的空闲空间总量（以字节为单位）。预定义的系统表空间，包括系统表空间和临时表空间，可以有一个或多个数据文件。</p></li><li><p>For <code>NDB</code> ：这个值总是 <code>NULL</code> 。</p></li></ul></li><li><p><code>CREATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>UPDATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>CHECK_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>CHECKSUM</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>STATUS</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值默认为 <code>NORMAL</code> 。<code>InnoDB</code> 的 <code>file-per-table</code> 表空间可能为 <code>IMPORTING</code> ，这表明表空间尚未可用。</p></li><li><p>For <code>NDB</code> ：这个值总是 <code>NORMAL</code> 。</p></li></ul></li><li><p><code>EXTRA</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code>：这一列显示了数据文件或 undo 日志文件属于哪个数据节点（每个数据节点都有每个文件的副本）； 对于 undo 日志文件，它还显示了撤销日志缓冲区的大小。假设你在一个有四个数据节点的NDB集群上使用这个语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> LOGFILE <span class="keyword">GROUP</span> mygroup</span><br><span class="line">    <span class="keyword">ADD</span> UNDOFILE <span class="string">&#x27;new_undo.dat&#x27;</span></span><br><span class="line">    INITIAL_SIZE <span class="number">2</span>G</span><br><span class="line">    ENGINE NDB;</span><br></pre></td></tr></table></figure><p>在成功运行 <code>CREATE LOGFILE GROUP</code> 语句后，你应该看到一个类似于，这里显示为针对 <code>FILES</code> 表的查询结果：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> LOGFILE_GROUP_NAME, FILE_TYPE, EXTRA</span><br><span class="line">         <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES</span><br><span class="line">         <span class="keyword">WHERE</span> FILE_NAME <span class="operator">=</span> <span class="string">&#x27;new_undo.dat&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> LOGFILE_GROUP_NAME <span class="operator">|</span> FILE_TYPE <span class="operator">|</span> EXTRA                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">5</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">6</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">7</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">8</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><code>FILES</code> 是一个非标准的 <code>INFORMATION_SCHEMA</code> 表。</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>适用于 <code>InnoDB</code> 数据文件的注意事项：</p><ul><li><p><code>FILES</code> 报告的数据来自于 <code>InnoDB</code> 的内存缓存中的开放文件。相比之下， <code>INNODB_SYS_DATAFILES</code> 报告的数据来自 <code>InnoDB</code> <code>SYS_DATAFILES</code> 内部数据字典表。</p></li><li><p><code>FILES</code>报告的数据包括临时表空间数据。这些数据在 <code>InnoDB</code> 的 <code>SYS_DATAFILES</code> 内部数据字典表中是不可用的，因此  <code>INNODB_SYS_DATAFILES</code> 不会报告。</p></li><li><p>Undo 的表空间数据由 <code>FILES</code> 报告。</p></li><li><p>下面的查询返回所有与 <code>InnoDB</code> 表空间有关的数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  FILE_ID, FILE_NAME, FILE_TYPE, TABLESPACE_NAME, FREE_EXTENTS,</span><br><span class="line">  TOTAL_EXTENTS, EXTENT_SIZE, INITIAL_SIZE, MAXIMUM_SIZE,</span><br><span class="line">  AUTOEXTEND_SIZE, DATA_FREE, STATUS</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES <span class="keyword">WHERE</span> ENGINE<span class="operator">=</span><span class="string">&#x27;InnoDB&#x27;</span>\G</span><br></pre></td></tr></table></figure></li></ul><hr><p>参考：</p><p>🔗 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-temporary-tablespace.html">MySQL :: MySQL 5.7 Reference Manual :: 14.6.3.5 The Temporary Tablespace</a></p><p>🔗 <a href="https://dev.mysql.com/doc/refman/5.7/en/information-schema-files-table.html">MySQL :: MySQL 5.7 Reference Manual :: 24.3.9 The INFORMATION_SCHEMA FILES Table</a></p><p>🔗 <a href="https://programmer.help/blogs/from-mysql-s-ibtmp1-file-is-too-big.html">From MYSQL’s ibtmp1 file is too big (programmer.help)</a></p><p>🔗 <a href="https://blog.csdn.net/yunhua_lee/article/details/12064477">优化临时表使用</a></p>]]></content>
    
    
    <summary type="html">内容包括：临时表简介，查看数据库临时表信息，临时表空间大小，创建临时表的场景，临时表优化，扩展等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Bean验证——Hibernate Validator</title>
    <link href="http://linyishui.top/2021072201.html"/>
    <id>http://linyishui.top/2021072201.html</id>
    <published>2021-07-22T08:11:09.000Z</published>
    <updated>2021-07-28T10:42:48.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hibernate-Validator"><a href="#Hibernate-Validator" class="headerlink" title="Hibernate Validator"></a>Hibernate Validator</h1><h2 id="一-Bean验证"><a href="#一-Bean验证" class="headerlink" title="一. Bean验证"></a>一. Bean验证</h2><h3 id="1-1-什么是Bean验证"><a href="#1-1-什么是Bean验证" class="headerlink" title="1.1 什么是Bean验证"></a>1.1 什么是Bean验证</h3><p>常见的业务校验场景：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (employee.getFirstName() == <span class="keyword">null</span> || employee.getFirstName().trim().length() == <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;validate.employee.firstName&quot;</span>);</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>当业务规则复杂时，类似的条件判断需要很多才能实现。</p><p>Bean验证是一个Java EE的API，用来自动验证在Java bean上声明的业务逻辑。其包含一个元数据模型（一个注解的集合），其中为指定的类声明了业务规则和一个使用验证工具的API。</p><p>通过为字段、方法等添加注解的方式，指定如何在被标注的目标上使用特定的约束。</p><h3 id="1-2-为什么选用Hibernate-Validator"><a href="#1-2-为什么选用Hibernate-Validator" class="headerlink" title="1.2 为什么选用Hibernate Validator"></a>1.2 为什么选用Hibernate Validator</h3><p>Hibernate Validator 5.0 是 JSR 349的参考实现，它兼容于此规范，是Bean验证实现中应用最广泛的。</p><p>Spring Framework自动为使用 Java Bean 验证的、由Spring管理的bean创建代理。它将拦截对添加了注解的方法的调用并进行适当的验证，检查使用者是否提供了有效的参数或该实现的返回值是否有效（常用注解 <code>@javax.validation.Valid</code> ）。</p><h2 id="二-在Spring-Framework容器中配置验证"><a href="#二-在Spring-Framework容器中配置验证" class="headerlink" title="二. 在Spring Framework容器中配置验证"></a>二. 在Spring Framework容器中配置验证</h2><p>手动验证：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">Validator validator = factory.getValidator();</span><br><span class="line">Set&lt;ConstraintViolation&lt;Employee&gt; violations = validator.validate(employee);</span><br><span class="line"><span class="keyword">if</span> (violations.size() &gt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(violations);</span><br></pre></td></tr></table></figure><p>配置Spring Framework开启自动验证，使用依赖注入和代理支持，完成4个配置：</p><ul><li>验证器</li><li>验证器消息的本地化</li><li>方法验证处理器</li><li>Spring MVC表单验证</li></ul><p>Spring Framework在Bean Validation出现之前就提供了 <code>org.springframework.validation.Validator</code> 接口支持对象自动验证，通过注解约束指定验证对象的工具。</p><p>验证错误会使用 <code>org.springframework.validation.Errors</code> 接口，而不是返回一个 <code>Set&lt;javax.validation.ObjectError&gt;</code> 。该接口提供了对一个或多个 <code>ObjectError</code> 和 <code>FieldError</code> 的访问。</p><p>配置Spring Framework的验证时，需要同时实现Validator和Spring Validator，即继承了 <code>org.springframework.validation.beanvalidation.SpringValidatorAdapter</code> 的类，可选：</p><ul><li><code>javax.validation.beanvalidation.CustomValidatorBean</code> </li><li><code>javax.validation.beanvalidation.LocalValidatorFactoryBean</code> ：支持获取底层的Validator，且支持使用应用程序的其他代码用于国际化的相同MessageSource和资源包文件。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalValidatorFactoryBean将自动检测到类路径上的Bean Validation实现，使用ValidatorFactory作为支持工厂，如果有多个实现类则会随机挑选。</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 最简单的返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    <span class="comment">// 动态加载的写法</span></span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setProvider(Class.forName(<span class="string">&quot;org.hibernate.validator.HibernateValidator&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过LocalValidatorFactoryBean设置有效的MessageSource，自动提供一个由MessageSource作为支持的插值器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定错误代码和错误消息</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReloadableResourceBundleMessageSource messageSource = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">    messageSource.setCacheSeconds(-<span class="number">1</span>);</span><br><span class="line">    messageSource.setDefaultEncoding(StandardCharsets.UTF_8.name());</span><br><span class="line">    messageSource.setBasenames(<span class="string">&quot;/WEB-INF/il8n/titles&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/messages&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/errors&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/validation&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> messageSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setValidationMessageSource(<span class="keyword">this</span>.messageSource());</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用方法验证Bean后处理器，可以在容器完成启动过程之前配置、自定义和替换配置中的bean。</p><h2 id="三-为bean添加约束验证注解"><a href="#三-为bean添加约束验证注解" class="headerlink" title="三. 为bean添加约束验证注解"></a>三. 为bean添加约束验证注解</h2><h2 id="四-为方法验证配置Spring-bean"><a href="#四-为方法验证配置Spring-bean" class="headerlink" title="四. 为方法验证配置Spring bean"></a>四. 为方法验证配置Spring bean</h2><h2 id="五-编写自定义验证约束"><a href="#五-编写自定义验证约束" class="headerlink" title="五. 编写自定义验证约束"></a>五. 编写自定义验证约束</h2><h2 id="六-在客户支持应用程序中集成验证"><a href="#六-在客户支持应用程序中集成验证" class="headerlink" title="六. 在客户支持应用程序中集成验证"></a>六. 在客户支持应用程序中集成验证</h2><h2 id="七-使用"><a href="#七-使用" class="headerlink" title="七. 使用"></a>七. 使用</h2><h3 id="7-1-使用Hibernate-Validate"><a href="#7-1-使用Hibernate-Validate" class="headerlink" title="7.1 使用Hibernate Validate"></a>7.1 使用Hibernate Validate</h3><p><strong>引入依赖</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>常用注解说明</strong>：</p><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Length(min=,max=)</td><td>检查所属的字段的长度是否在min和max之间，只能用于字符串</td></tr><tr><td>@Range(min=,max=,message=)</td><td>被注释的元素必须在合适的范围内</td></tr><tr><td>@Max</td><td>该字段的值只能小于或等于该值</td></tr><tr><td>@Min</td><td>该字段的值只能大于或等于该值</td></tr><tr><td>@NotNull</td><td>不能为null</td></tr><tr><td>@NotBlank</td><td>不能为空，检查时会将空格忽略</td></tr><tr><td>@NotEmpty</td><td>不能为空，这里的空是指空字符串</td></tr><tr><td>@Pattern(regex=,flag=)</td><td>被注释的元素必须符合指定的正则表达式</td></tr></tbody></table><p><strong>使用</strong>：</p><p>需要搭配在Controller中搭配@Validated或@Valid注解一起使用，@Validated和@Valid注解区别不是很大，一般情况下任选一个即可，区别如下：</p><table><thead><tr><th>注解</th><th>@Validated</th><th>@Valid</th></tr></thead><tbody><tr><td>所属的包</td><td>属于org.springframework.validation.annotation包下的,是spring提供的</td><td>属于javax.validation包下,是jdk给提供的</td></tr><tr><td>是否支持分组和排序</td><td>是</td><td>否</td></tr></tbody></table><p>虽然@Validated比@Valid更加强大，在@Valid之上提供了分组功能和验证排序功能。Hibernate-validate框架中的注解是需要加在实体中一起使用的：</p><ul><li>定义一个实体：message字段为不符合校验规则时抛出的异常信息</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSetSaveVO</span> </span>&#123;</span><br><span class="line">    <span class="comment">//唯一标识符为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;user uuid is empty&quot;)</span></span><br><span class="line">    <span class="comment">//用户名称只能是字母和数字</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[a-z0-9]+$&quot;, message = &quot;user names can only be alphabetic and numeric&quot;)</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;user uuid length over 48 byte&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userUuid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据集名称只能是字母和数字</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[A-Za-z0-9]+$&quot;, message = &quot;data set names can only be letters and Numbers&quot;)</span></span><br><span class="line">    <span class="comment">//文件名称过长</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;file name too long&quot;)</span></span><br><span class="line">    <span class="comment">//文件名称为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;file name is empty&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据集描述最多为256字节</span></span><br><span class="line">    <span class="meta">@Length(max = 256, message = &quot;data set description length over 256 byte&quot;)</span></span><br><span class="line">    <span class="comment">//数据集描述为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;data set description is null&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Controller层中的方法：在校验的实体DataSetSaveVO旁边添加@Valid或@Validated注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseVO <span class="title">createDataSet</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> DataSetSaveVO dataSetVO)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.success(dataSetService.saveDataSet(dataSetVO));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-使用commons-lang3"><a href="#7-2-使用commons-lang3" class="headerlink" title="7.2 使用commons-lang3"></a>7.2 使用commons-lang3</h3><p><strong>引入依赖</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>常用方法说明</strong>：</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>CollectionUtils.isEmpty</td><td>判断集合是否为空，为null或者size==0，返回true</td></tr><tr><td>CollectionUtils.isNotEmpty</td><td>判断集合是否为非空</td></tr><tr><td>StringUtils.isEmpty</td><td>判断字符串是否为空</td></tr><tr><td>StringUtils.isNotEmpty</td><td>判断字符串是否非空</td></tr><tr><td>StringUtils.isBlank</td><td>判断字符串是否为空，为null或者size==0或者只存在空白字符(如” “)，则返回true</td></tr><tr><td>StringUtils.isNotBlank</td><td>判断字符串是否为非空</td></tr></tbody></table><p>测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//StringUtils.isEmpty</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;  &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"><span class="comment">//StringUtils.isNotEmpty</span></span><br><span class="line">System.out.println(StringUtils.isNotEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//false</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">//StringUtils.isBlank</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//true</span></span><br><span class="line"><span class="comment">//StringUtils.isNotBlank</span></span><br><span class="line">System.out.println(StringUtils.isNotBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; emptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Integer&gt; nullList = <span class="keyword">null</span>;</span><br><span class="line">List&lt;Integer&gt; notEmptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">notEmptyList.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(emptyList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(nullList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(notEmptyList));   <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isNotEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(emptyList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(nullList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(notEmptyList));   <span class="comment">//true</span></span><br></pre></td></tr></table></figure><h3 id="7-3-自定义注解"><a href="#7-3-自定义注解" class="headerlink" title="7.3 自定义注解"></a>7.3 自定义注解</h3><p>当上面的方面都无法满足校验的需求以后，可以考虑使用自定义注解</p><hr><p>参考：</p><p>🔗《Java Web高级编程—涵盖WebSockets、Spring Framework、JPA Hibernate、Spring Security》</p><p>🔗 <a href="https://juejin.cn/post/6913735652806754311">Springboot中如何优雅进行字段校验 </a></p>]]></content>
    
    
    <summary type="html">内容来自于《Java Web高级编程—涵盖WebSockets、Spring Framework、JPA Hibernate、Spring Security》。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="Spring" scheme="http://linyishui.top/tags/Spring/"/>
    
    <category term="Hibernate" scheme="http://linyishui.top/tags/Hibernate/"/>
    
    <category term="Spring Framework" scheme="http://linyishui.top/tags/Spring-Framework/"/>
    
  </entry>
  
  <entry>
    <title>Hexo搭建个人博客 (四) 升级与功能配置（持续更新）</title>
    <link href="http://linyishui.top/2021070101.html"/>
    <id>http://linyishui.top/2021070101.html</id>
    <published>2021-07-01T02:19:15.000Z</published>
    <updated>2021-07-10T09:59:14.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" id=6851165123 server="netease" type="playlist" ></meting-js><h1 id="升级与功能配置"><a href="#升级与功能配置" class="headerlink" title="升级与功能配置"></a>升级与功能配置</h1><h2 id="一-Hexo升级"><a href="#一-Hexo升级" class="headerlink" title="一. Hexo升级"></a>一. Hexo升级</h2><p>从2018年后一直未更新Hexo和Next主题版本，中间跨了好几个大版本，所以尝试直接升级至最新版本。</p><p>当前最新Next主题：<a href="https://github.com/next-theme/hexo-theme-next">hexo-theme-next</a></p><h3 id="1-1-Hexo升级"><a href="#1-1-Hexo升级" class="headerlink" title="1.1 Hexo升级"></a>1.1 Hexo升级</h3><p>执行 <code>npm outdated</code> 查看所有可以升级的插件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-check     //安装npm-check</span><br><span class="line">npm-check                    //查看系统插件是否需要升级</span><br><span class="line">npm install -g npm-upgrade   //安装npm-upgrade</span><br><span class="line">npm-upgrade        //更新package.json</span><br><span class="line">//在执行npm-upgrade命令后会要求输入yes或者no，直接输入Yes或Y即可</span><br><span class="line">npm update -g      //更新全局插件</span><br><span class="line">npm update --save  //更新系统插件</span><br></pre></td></tr></table></figure><h3 id="1-2-主题更新"><a href="#1-2-主题更新" class="headerlink" title="1.2 主题更新"></a>1.2 主题更新</h3><p>在<strong>主题的根目录</strong>（注意不是博客根目录），打开命令行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git pull</span></span><br></pre></td></tr></table></figure><p>Next主题从5.X版本升级，因为差异较大，需要参考官方文档：<a href="https://github.com/theme-next/hexo-theme-next/blob/master/docs/zh-CN/UPDATE-FROM-5.1.X.md">从 NexT v5.1.x 更新</a>。</p><h3 id="1-3-npm更新"><a href="#1-3-npm更新" class="headerlink" title="1.3 npm更新"></a>1.3 npm更新</h3><p>npm更新全局安装的包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm update -g</span><br></pre></td></tr></table></figure><p>npm 更新站点文件夹根目录下安装的依赖包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm update</span></span><br></pre></td></tr></table></figure><p>更新 npm：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install npm -g</span><br></pre></td></tr></table></figure><p>更新 Node.js 到最新版（Linux）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前node版本</span></span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br><span class="line"></span><br><span class="line">npm install -g n</span><br><span class="line"></span><br><span class="line">n latest</span><br></pre></td></tr></table></figure><p>更新 Node.js 到最新版Win10：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看原nodejs安装目录</span></span><br><span class="line">where node </span><br><span class="line">npm config list | findstr location</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载最新nodejs安装包放在原安装目录下</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 官网: https://nodejs.org/en/download/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 淘宝镜像: https://npm.taobao.org/mirrors/node/v14.15.2/</span></span><br></pre></td></tr></table></figure><h3 id="1-4-问题记录"><a href="#1-4-问题记录" class="headerlink" title="1.4 问题记录"></a>1.4 问题记录</h3><p>问题 <code>  err: Error: Cannot find module &#39;hexo-util&#39;</code> 缺少 <a href="https://www.npmjs.com/package/hexo-util">hexo-util</a> ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装hexo-util</span></span><br><span class="line">npm install hexo-util --save</span><br></pre></td></tr></table></figure><p>执行 <code>hexo generator</code> 命令后，<code>themes/next/scripts/events/lib/vendors.js</code> 代码里面解析 <code>local</code> 的 <code>call</code> 一直出现以下错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: TypeError: Cannot read property &#x27;call&#x27; of undefined</span><br><span class="line">      at module.exports (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/lib/vendors.js:27:25)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/index.js:9:27)</span><br><span class="line">      at Hexo.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/method.js:15:34)</span><br><span class="line">      at /home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/hexo/lib/extend/filter.js:67:52</span><br><span class="line">      at tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Object.gotValue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:166:18)</span><br><span class="line">      at Object.gotAccum (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:155:25)</span><br><span class="line">      at Object.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Promise._settlePromiseFromHandler (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">      at Promise._settlePromise (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">      at Promise._settlePromiseCtx (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:641:10)</span><br><span class="line">      at _drainQueueStep (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:97:12)</span><br><span class="line">      at _drainQueue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:86:9)</span><br><span class="line">      at Async._drainQueues (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:102:5)</span><br><span class="line">      at Immediate.Async.drainQueues [as _onImmediate] (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:15:14)</span><br><span class="line">      at processImmediate (internal/timers.js:461:21)</span><br></pre></td></tr></table></figure><p>这个报错是没找到 <code>hexo-util</code> 的 <code>url_for</code> ，可能是 <code>hexo-util</code> 模块更新失败，最终导致代码不兼容。首先检查 <code>hexo-util</code> 模块的版本，然后可以尝试执行以下命令，强制更新 NPM 模块：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入博客的主题目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /boot-root/</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 强制更新</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm update --save --force</span></span><br></pre></td></tr></table></figure><h2 id="二-功能配置-整体"><a href="#二-功能配置-整体" class="headerlink" title="二. 功能配置-整体"></a>二. 功能配置-整体</h2><p>有些旧版的设置，新版因为觉得没必要、或未找到修改方案在菜单中标记了（旧版本）。</p><h3 id="2-1-修改主题风格"><a href="#2-1-修改主题风格" class="headerlink" title="2.1 修改主题风格"></a>2.1 修改主题风格</h3><p>nexT默认 <code>Scheme: Muse</code> ，修改主题配置文件 <code>\themes\next\_config.yml</code> 中的scheme：</p><ul><li><p>Muse - 默认 Scheme，这是 NexT 最初的版本，黑白主调，大量留白</p></li><li><p>Mist - Muse 的紧凑版本，整洁有序的单栏外观</p></li><li><p>Pisces - 双栏 Scheme，小家碧玉似的清新</p></li><li><p>Gemini - 不太清楚，有想法可以试用一下</p></li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280204.png"></p><h3 id="2-2-添加头像"><a href="#2-2-添加头像" class="headerlink" title="2.2 添加头像"></a>2.2 添加头像</h3><p>新建 <code>source/images/</code> 目录，复制进去一些图片（可以是动图Gif），在站点配置文件 <code>\_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 头像</span></span><br><span class="line"><span class="attr">avatar:</span> <span class="string">/images/riho_yoshioka1.jpg</span></span><br></pre></td></tr></table></figure><p>主题配置文件 <code>\themes\next\_config.yml</code> 若设置了，会优先于前者：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">XXX</span></span><br></pre></td></tr></table></figure><p>也可以采用第二种方法：</p><ol><li><p>首先在网上找或者自己PS一张心仪的图片，取名 <code>background.jpg</code> ，把它放在 <code>Hexo\source\image</code> 路径下（或者直接使用图床的图片地址）。</p></li><li><p>进入 <code>Hexo\themes\hexo-theme-next\source\css\_common\components\header</code> 目录，找到 <code>header.styl</code> 文件，双击打开。将第一行默认的 <code>.header &#123; background: $head-bg; &#125;</code> 修改为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的url()里不一定非要填相对路径，填一个能访问的url即可</span></span><br><span class="line">.header &#123; <span class="attr">background</span>: url(<span class="string">&#x27;../image/background.jpg&#x27;</span>); &#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-3-设置头像旋转"><a href="#2-3-设置头像旋转" class="headerlink" title="2.3 设置头像旋转"></a>2.3 设置头像旋转</h3><p>旧版，打开 <code>\themes\next\source\css\_common\components\sidebar\sidebar-author.styl</code> ，在里面添加如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.site-author-image</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding</span>: $site-author-image-padding;</span><br><span class="line">  <span class="attribute">max-width</span>: $site-author-image-width;</span><br><span class="line">  <span class="attribute">height</span>: $site-author-image-height;</span><br><span class="line">  <span class="attribute">border</span>: $site-author-image-border-width solid $site-author-image-border-color;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 头像圆形 */</span></span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -moz-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: inset <span class="number">0</span> -<span class="number">1px</span> <span class="number">0</span> <span class="number">#333</span>sf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置循环动画 [animation: (play)动画名称 (2s)动画播放时长单位秒或微秒 (ase-out)动画播放的速度曲线为以低速结束 </span></span><br><span class="line"><span class="comment">    (1s)等待1秒然后开始动画 (1)动画播放次数(infinite为循环播放) ]*/</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 鼠标经过头像旋转360度 */</span></span><br><span class="line">  -webkit-<span class="attribute">transition</span>: -webkit-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  -moz-<span class="attribute">transition</span>: -moz-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  <span class="attribute">transition</span>: transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="comment">/* 鼠标经过停止头像旋转 </span></span><br><span class="line"><span class="comment">  -webkit-animation-play-state:paused;</span></span><br><span class="line"><span class="comment">  animation-play-state:paused;*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 鼠标经过头像旋转360度 */</span></span><br><span class="line">  -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Z 轴旋转动画 */</span></span><br><span class="line"><span class="keyword">@-webkit-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@-moz-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版可以直接修改主题配置文件 <code>\themes\next\_config.yml</code> ，设置 rotated 属性：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be dispalyed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-4-设置侧栏位置"><a href="#2-4-设置侧栏位置" class="headerlink" title="2.4 设置侧栏位置"></a>2.4 设置侧栏位置</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中的sidebar：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280206.png"></p><p>默认是左边，display设置侧栏在什么情况下显示。</p><h3 id="2-5-设置菜单"><a href="#2-5-设置菜单" class="headerlink" title="2.5 设置菜单"></a>2.5 设置菜单</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> 菜单映射：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280207.png"></p><p>界面所显示的映射value是去 <code>languages/&#123;yourlanguage&#125;.yml</code> 查询的，想要修改时只需去修改 <code>&#123;yourlanguage&#125;.yml</code> 即可，不过要先在主题配置文件中开启这个标签。</p><p>设置菜单的图标: </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280208.png"></p><h4 id="（1）添加标签页面"><a href="#（1）添加标签页面" class="headerlink" title="（1）添加标签页面"></a>（1）添加标签页面</h4><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中的menu选项，可以在主页面的菜单栏添加标签选项，但是此时点击标签，跳转的页面会显示page not found。</p><p>添加标签页面的具体方法是:</p><ul><li><p>新建页面，输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page tags</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在 <code>myBlog/source</code> 下会新生成一个新的文件夹tags，在该文件夹下会有一个 <code>index.md</code> 文件。</p></li><li><p>设置页面类型，在上步新生成的 <code>myBlog/source/tags/index.md</code> 中添加 <code>type: &quot;tags&quot;</code> ，<code>index.md</code> 文件内容如下:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2016-11-15 19:10:05</span><br><span class="line"><span class="section">type: &quot;tags&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>设置具体文章的tags，当要为某一篇文章添加标签，只需在 <code>myBlog/source/_post</code> 目录下的具体文章的tags中添加标签即可，如:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 基于Hexo和Github搭建博客</span><br><span class="line">date: 2016-11-09</span><br><span class="line">tags: [npm, hexo, github]</span><br><span class="line"><span class="section">categories: 搭建博客</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（2）添加分类页面"><a href="#（2）添加分类页面" class="headerlink" title="（2）添加分类页面"></a>（2）添加分类页面</h4><p>步骤与添加标签页面类似，具体如下：</p><ul><li><p>新建页面，输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page categories</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在myBlog/source下会新生成一个新的文件夹categories，在该文件夹下会有一个index.md文件。</p></li><li><p>设置页面类型，在上步新生成的 <code>myBlog/source/categories/index.md</code> 中添加 <code>type: &quot;categories&quot;</code> ， <code>index.md</code> 文件内容如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2016-11-15 19:11:13</span><br><span class="line"><span class="section">type: &quot;categories&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>设置具体文章的categories，当要为某一篇文章添加分类，只需在 <code>myBlog/source/_post</code> 目录下的具体文章的categories中添加分类即可，如：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 基于Hexo和Github搭建博客</span><br><span class="line">date: XXXX-XX-XX</span><br><span class="line">tags: [hexo, github]</span><br><span class="line"><span class="section">categories: 搭建博客</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（3）添加关于我页面"><a href="#（3）添加关于我页面" class="headerlink" title="（3）添加关于我页面"></a>（3）添加关于我页面</h4><p>步骤与添加标签页面类似，具体如下:</p><ul><li><p>新建页面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page about</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在 <code>myBlog/source</code> 下会新生成一个新的文件夹about，在该文件夹下会有一个 <code>index.md</code> 文件。修改 <code>about/index.md</code> ，本站点 <code>index.md</code> 如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: about</span><br><span class="line"><span class="section">date: 2016-11-15 19:08:50</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"><span class="section">## 关于我</span></span><br><span class="line"></span><br><span class="line">XXXX,XXXXXXXXX。</span><br><span class="line"></span><br><span class="line">From XXX</span><br><span class="line"></span><br><span class="line">QQ: XXXXXXX</span><br><span class="line">Email: XXXXXX@XX.com</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-6-设置社交链接"><a href="#2-6-设置社交链接" class="headerlink" title="2.6 设置社交链接"></a>2.6 设置社交链接</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280209.png"></p><p>可以在<a href="https://fontawesome.com/icons?from=io">图标库</a>中搜索图标 ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280210.png"></p><p><strong>将链接设置为居中显示：</strong></p><p>打开文件 <code>themes\next\source\css\_common\components\sidebar\sidebar-author-links.styl</code> ，添加如下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-of-author-item</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-添加友链"><a href="#2-7-添加友链" class="headerlink" title="2.7 添加友链"></a>2.7 添加友链</h3><h4 id="（1）简单方案"><a href="#（1）简单方案" class="headerlink" title="（1）简单方案"></a>（1）简单方案</h4><p>在source目录下新建一个xx.html文件，然后配置menu映射即可。</p><blockquote><p>xx: /xx.html</p><p>xx: /xx</p></blockquote><p>添加如友情链接的方法:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blogrolls </span></span><br><span class="line"><span class="attr">links_title:</span> <span class="string">友情链接</span> </span><br><span class="line"><span class="comment"># links_layout: block </span></span><br><span class="line"><span class="comment">#links_layout: inline </span></span><br><span class="line"><span class="attr">links:</span> <span class="string">Java学习天地:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="attr">ruulai.com:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="string">视听中国:</span> <span class="string">https://wangli0.github.com</span></span><br></pre></td></tr></table></figure><h4 id="（2）Next侧边栏添加"><a href="#（2）Next侧边栏添加" class="headerlink" title="（2）Next侧边栏添加"></a>（2）Next侧边栏添加</h4><p>参考官方文档：<a href="https://theme-next.js.org/docs/theme-settings/sidebar">Sidebar Setting</a></p><p>会在社交下增加任意个超链接，缺点是地方有限，无法放置过多链接；以及没有图标。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blog rolls</span></span><br><span class="line"><span class="attr">links_settings:</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">far</span> <span class="string">fa-smile-wink</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">个人</span></span><br><span class="line">  <span class="comment"># Available values: block | inline</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="string">block</span></span><br><span class="line"></span><br><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="string">网易云音乐:</span> <span class="string">https://music.163.com/#/XXX</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Table of Contents in the Sidebar</span></span><br><span class="line"><span class="comment"># Front-matter variable (unsupport wrap expand_all).</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If true, all words will placed on next lines if header width longer then sidebar width.</span></span><br><span class="line">  <span class="attr">wrap:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, all level of TOC in a post will be displayed, rather than the activated part of it.</span></span><br><span class="line">  <span class="attr">expand_all:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Maximum heading</span></span><br></pre></td></tr></table></figure><h4 id="（3）自定义界面"><a href="#（3）自定义界面" class="headerlink" title="（3）自定义界面"></a>（3）自定义界面</h4><p>参考：<a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/">Hexo NexT 添加友链页面</a></p><p>涉及到的文件：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config<span class="selector-class">.next</span><span class="selector-class">.yml</span></span><br><span class="line">└── source</span><br><span class="line">    ├── _data</span><br><span class="line">    │   └── <span class="selector-tag">body</span>-end<span class="selector-class">.njk</span></span><br><span class="line">    ├── css</span><br><span class="line">    │   └── link<span class="selector-class">.css</span>（也可以放置到主题中相同子路径）</span><br><span class="line">    ├── js</span><br><span class="line">    │   └── link<span class="selector-class">.js</span>（也可以放置到主题中相同子路径）</span><br><span class="line">    └── links</span><br><span class="line">        ├── index<span class="selector-class">.md</span></span><br><span class="line">        └── linklist<span class="selector-class">.json</span></span><br></pre></td></tr></table></figure><h5 id="1-建立页面"><a href="#1-建立页面" class="headerlink" title="1. 建立页面"></a>1. 建立页面</h5><p>执行命令，这会创建 <code>source/links/index.md</code> 文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page links</span><br></pre></td></tr></table></figure><p>文件示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 友情链接</span><br><span class="line">type: links</span><br><span class="line">toc:</span><br><span class="line"><span class="section">  enable: false</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/css/link.css&quot;</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% note info %&#125;</span><br><span class="line"></span><br><span class="line">排名不分先后，每次刷新会随机排列。</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;div class=&quot;link-navigation&quot; id=&quot;links1&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="code">  &lt;/div&gt;</span></span><br><span class="line"><span class="code">&lt;/div&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;&quot;</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate1&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  留言互换友链 o ((&gt;ω&lt;)) o</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate2&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="section">  </span></span><br><span class="line"><span class="section">------</span></span><br><span class="line"></span><br><span class="line">&#123;% note success %&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## 友链格式</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 名称：如鱼饮水，冷暖自知</span><br><span class="line"><span class="bullet">-</span> 网址：[<span class="string">https://wangjiezhe.com</span>](<span class="link">https://wangjiezhe.com</span>)</span><br><span class="line"><span class="bullet">-</span> 头像：[<span class="string">https://gravatar.loli.net/avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>](<span class="link">https://gravatar.loli.net//avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>注意在 Front-Matter 里一定要有 <code>type: links</code> ，这里我还关闭了侧边栏的目录。</p><h5 id="2-存储数据"><a href="#2-存储数据" class="headerlink" title="2. 存储数据"></a>2. 存储数据</h5><p>所有友链的数据都放在 <code>source/links/linklist.json</code> 里，其格式为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>其中 <code>name</code> 为网站的名字，<code>site</code> 为网址，<code>avatar</code> 为头像。头像可以使用 Gravatar，这样可以保证始终可用的。</p><h5 id="3-渲染页面"><a href="#3-渲染页面" class="headerlink" title="3. 渲染页面"></a>3. 渲染页面</h5><p>在 <code>source/_data/body-end.njk</code> 中，引入 <code>link.js</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> page.type === <span class="string">&#x27;links&#x27;</span> %&#125;</span><br><span class="line">  &#123;&#123;- next_js(<span class="string">&#x27;link.js&#x27;</span>, <span class="literal">true</span>) &#125;&#125;</span><br><span class="line">&#123;% endif %</span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中开启自定义配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.njk</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.njk</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.njk</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.njk</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.njk</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.njk</span></span><br><span class="line">  <span class="attr">bodyEnd:</span> <span class="string">source/_data/body-end.njk</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="comment">#style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><p>其中 <code>source/js/link.js</code> 的内容为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 随机排列</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffle</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = arr.length;</span><br><span class="line">  <span class="keyword">while</span> (i) &#123;</span><br><span class="line">    <span class="keyword">let</span> j = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * i--);</span><br><span class="line">    [arr[j], arr[i]] = [arr[i], arr[j]];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderlink</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name, avatar, site, li = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  shuffle(data);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">    name = data[i].name;</span><br><span class="line">    avatar = data[i].avatar;</span><br><span class="line">    site = data[i].site;</span><br><span class="line">    li += <span class="string">&#x27;&lt;div class=&quot;card&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;thumb&quot; style=&quot;background: url( &#x27;</span> + avatar + <span class="string">&#x27;);&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/a&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;card-header&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div&gt;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + name + <span class="string">&#x27;&lt;/a&gt;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">&quot;.link-navigation&quot;</span>).innerHTML = li;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 json 文件</span></span><br><span class="line">fetch(<span class="string">&#x27;/links/linklist.json&#x27;</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> renderlink(res));</span><br></pre></td></tr></table></figure><h5 id="4-创建样式"><a href="#4-创建样式" class="headerlink" title="4. 创建样式"></a>4. 创建样式</h5><p>创建 <code>source/css/link.css</code>，其内容为（这个文件完全来自于网络）：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-content</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1rem</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.link-navigation</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot; &quot;</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">clear</span>: both</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">130px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">transition-duration</span>: .<span class="number">15s</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>);</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f5f5f5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(max-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">16px</span>)/<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">32px</span>)/<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:768px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">48px</span>)/<span class="number">4</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:1200px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">64px</span>)/<span class="number">5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>),<span class="number">0</span> <span class="number">0</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">04</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.thumb</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding-bottom</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span><span class="meta">!important</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.posts-expand</span> <span class="selector-class">.post-body</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1rem</span> .<span class="number">25rem</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  <span class="attribute">white-space</span>: normal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#2bbc8a</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#d480aa</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-添加侧栏"><a href="#5-添加侧栏" class="headerlink" title="5. 添加侧栏"></a>5. 添加侧栏</h5><p>在主题配置文件 <code>\themes\next\_config.yml</code> 中，添加</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || fa fa-home</span><br><span class="line">  tags: /tags/ || fa fa-tags</span><br><span class="line">  categories: /categories/ || fa fa-th</span><br><span class="line">  archives: /archives/ || fa fa-archive</span><br><span class="line"><span class="addition">+  links: /links/ || fa fa-link</span></span><br></pre></td></tr></table></figure><h5 id="6-问题排查"><a href="#6-问题排查" class="headerlink" title="6. 问题排查"></a>6. 问题排查</h5><p>步骤：</p><ol><li>浏览器 F12 查看页面源码，是否有一个 class 是 <code>.link-navigation</code> 的网页元素。</li><li>查看 <code>link.js</code> 是否正常加载了，json 文件是否正常加载了。</li></ol><p>按上述配置后， <code>link.js</code> 加载报错 <code>Unexpected token &#39;&lt;&#39;</code> ，发现是因为启用了音乐播放器APlayer，默认会为文件添加一行标签配置，导致JS和读取Json时报错。</p><p>官方文档：<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">hexo-tag-aplayer</a></p><p>站点配置文件 <code>\_config.yml</code> 中将asset_inject属性设置为false，即可解决问题（可能需要重新编译）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 音乐播放器</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="2-8-设置站点图标"><a href="#2-8-设置站点图标" class="headerlink" title="2.8 设置站点图标"></a>2.8 设置站点图标</h3><p>下载一个32*32的ico图标，修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Put your favicon.ico into `hexo-site/source/` directory.</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br></pre></td></tr></table></figure><h3 id="2-9-修改字体"><a href="#2-9-修改字体" class="headerlink" title="2.9 修改字体"></a>2.9 修改字体</h3><p>在 <a href="https://www.google.com/fonts">Google Fonts</a> 上找到心仪的字体，然后在主题配置文件 <code>\themes\next\_config.yml</code> 中为不同的应用场景配置字体：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Font Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Find fonts on Google Fonts (https://fonts.google.com)</span></span><br><span class="line"><span class="comment"># All fonts set here will have the following styles:</span></span><br><span class="line"><span class="comment">#   light | light italic | normal | normal italic | bold | bold italic</span></span><br><span class="line"><span class="comment"># Be aware that setting too much fonts will cause site running slowly</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Web Safe fonts are recommended for `global` (and `title`):</span></span><br><span class="line"><span class="comment"># Arial | Tahoma | Helvetica | Times New Roman | Courier New | Verdana | Georgia | Palatino | Garamond | Comic Sans MS | Trebuchet MS</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host, e.g. https://fonts.googleapis.com (Default).</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font options:</span></span><br><span class="line">  <span class="comment"># `external: true` will load this font family from `host` above.</span></span><br><span class="line">  <span class="comment"># `family: Times New Roman`. Without any quotes.</span></span><br><span class="line">  <span class="comment"># `size: x.x`. Use `em` as unit. Default: 1 (16px)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global font settings used for all elements inside &lt;body&gt;.</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Monda</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for site title (.site-title).</span></span><br><span class="line">  <span class="attr">title:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for headlines (&lt;h1&gt; to &lt;h6&gt;).</span></span><br><span class="line">  <span class="attr">headings:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Roboto</span> <span class="string">Slab</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for posts (.post-body).</span></span><br><span class="line">  <span class="attr">posts:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for &lt;code&gt; and code blocks.</span></span><br><span class="line">  <span class="attr">codes:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br></pre></td></tr></table></figure><h3 id="2-10-设置首页只显示部分内容"><a href="#2-10-设置首页只显示部分内容" class="headerlink" title="2.10 设置首页只显示部分内容"></a>2.10 设置首页只显示部分内容</h3><p>这个只要在文章中加上 &lt;&#33;–more–&gt; 标记 ，该标记以后部分就不在显示了，只有展开全部才显示，这是hexo定义的。但这样手动配置感觉会很麻烦，所以修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically Excerpt. Not recommand.</span></span><br><span class="line"><span class="comment"># Please use &lt;!-- more --&gt; in the post to control excerpt accurately.</span></span><br><span class="line"><span class="attr">auto_excerpt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">length:</span> <span class="number">150</span></span><br></pre></td></tr></table></figure><p>把enable改为对应的false改为true。</p><p>新版本：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically excerpt description in homepage as preamble text.</span></span><br><span class="line"><span class="attr">excerpt_description:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read more button</span></span><br><span class="line"><span class="comment"># If true, the read more button will be displayed in excerpt section.</span></span><br><span class="line"><span class="attr">read_more_btn:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-11-设置博客背景"><a href="#2-11-设置博客背景" class="headerlink" title="2.11 设置博客背景"></a>2.11 设置博客背景</h3><p>旧版本，打开文件 <code>blog\themes\next\source\css\_custom\custom.styl</code> ：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>:<span class="number">1200px</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>);      //这一行的括号里填背景图片的路径，将图片重命名为<span class="attribute">background</span><span class="selector-class">.jpg</span>放在\themes\next\source\images下，也可填图片的链接。</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed;</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-id">#footer</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>:<span class="number">#eee</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版本，<code>source/_data/styles.styl</code> 文件，添加：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>); // 可以是路径也可以是链接</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat; // 不重复</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed; // 固定住背景图片</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>; // 图片位置：居中</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>; // 图片长宽扩充为<span class="number">100%</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主题配置文件 <code>blog/themes/next/_config.yml</code> ：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Define custom file paths.</span><br><span class="line"># Create your custom files in site directory `source/_data` and uncomment needed files below.</span><br><span class="line">custom_file_path:</span><br><span class="line">  #head: source/_data/head.njk</span><br><span class="line">  #header: source/_data/header.njk</span><br><span class="line">  #sidebar: source/_data/sidebar.njk</span><br><span class="line">  #postMeta: source/_data/post-meta.njk</span><br><span class="line">  #postBodyEnd: source/_data/post-body-end.njk</span><br><span class="line">  #footer: source/_data/footer.njk</span><br><span class="line">  bodyEnd: source/_data/body-end.njk</span><br><span class="line">  #variable: source/_data/variables.styl</span><br><span class="line">  #mixin: source/_data/mixins.styl</span><br><span class="line"><span class="deletion">-  #style: source/_data/styles.styl</span></span><br><span class="line"><span class="addition">+  style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><h3 id="2-12-添加腾讯公益404页面"><a href="#2-12-添加腾讯公益404页面" class="headerlink" title="2.12 添加腾讯公益404页面"></a>2.12 添加腾讯公益404页面</h3><p>在 <code>blog\themes\next\source\</code> 路径下新建 <code>404.html</code> 文件，添加如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;content-type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge,chrome=1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;all&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;index,follow&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/style/404style.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/plain&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://www.qq.com/404/search_children.js&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> <span class="attr">homePageUrl</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">homePageName</span>=<span class="string">&quot;回到我的主页&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/data.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/page.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，开启 <code>commonweal</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || calendar</span></span><br><span class="line">  <span class="attr">sitemap:</span> <span class="string">/sitemap.xml</span> <span class="string">||</span> <span class="string">sitemap</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">/404/</span> <span class="string">||</span> <span class="string">heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable/Disable menu icons.</span></span><br><span class="line"><span class="attr">menu_icons:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Icon Mapping</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">about</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">archive</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">heartbeat</span></span><br></pre></td></tr></table></figure><h3 id="2-13-添加版权声明"><a href="#2-13-添加版权声明" class="headerlink" title="2.13 添加版权声明"></a>2.13 添加版权声明</h3><p>旧版本，修改主题配置文件 <code>\themes\next\_config.xml</code> ，找到 <code>post_copyright</code> 开启 <code>enable</code> ：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Declare license on posts</span></span><br><span class="line"><span class="attr">post_copyright:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">CC</span> <span class="string">BY-NC-SA</span> <span class="number">3.0</span></span><br><span class="line">  <span class="attr">license_url:</span> <span class="string">https://creativecommons.org/licenses/by-nc-sa/3.0/</span></span><br></pre></td></tr></table></figure><p>修改根目录配置文件：确认 <code>url</code> 属性有配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">http://linyishui.top</span></span><br></pre></td></tr></table></figure><p>新版本，修改主题配置文件 <code>\themes\next\_config.xml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># See: https://creativecommons.org/about/cclicenses/</span></span><br><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="comment"># Available values: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | cc-zero</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="comment"># Available values: big | small</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">small</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># You can set a language value if you prefer a translated version of CC license, e.g. deed.zh</span></span><br><span class="line">  <span class="comment"># CC licenses are available in 39 languages, you can find the specific and correct abbreviation you need on https://creativecommons.org</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">deed.zh</span></span><br></pre></td></tr></table></figure><h3 id="2-14-页脚增加建站时间"><a href="#2-14-页脚增加建站时间" class="headerlink" title="2.14 页脚增加建站时间"></a>2.14 页脚增加建站时间</h3><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，找到since：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">since:</span> <span class="number">2018</span></span><br></pre></td></tr></table></figure><h3 id="2-15-侧栏增加已运行时间（旧版本）"><a href="#2-15-侧栏增加已运行时间（旧版本）" class="headerlink" title="2.15 侧栏增加已运行时间（旧版本）"></a>2.15 侧栏增加已运行时间（旧版本）</h3><p>打开文件 <code>blog/themes/next/layout/_custom/sidebar.swig</code> ，增加如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;days&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">show_date_time</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.setTimeout(<span class="string">&quot;show_date_time()&quot;</span>, <span class="number">1000</span>);</span></span><br><span class="line"><span class="javascript">    BirthDay=<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">&quot;07/26/2018 00:00:00&quot;</span>);</span></span><br><span class="line"><span class="javascript">    today=<span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">    timeold=(today.getTime()-BirthDay.getTime());</span></span><br><span class="line"><span class="javascript">    sectimeold=timeold/<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    secondsold=<span class="built_in">Math</span>.floor(sectimeold);</span></span><br><span class="line"><span class="javascript">    msPerDay=<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    e_daysold=timeold/msPerDay</span></span><br><span class="line"><span class="javascript">    daysold=<span class="built_in">Math</span>.floor(e_daysold);</span></span><br><span class="line"><span class="javascript">    e_hrsold=(e_daysold-daysold)*<span class="number">24</span>;</span></span><br><span class="line"><span class="javascript">    hrsold=setzero(<span class="built_in">Math</span>.floor(e_hrsold));</span></span><br><span class="line"><span class="javascript">    e_minsold=(e_hrsold-hrsold)*<span class="number">60</span>;</span></span><br><span class="line"><span class="javascript">    minsold=setzero(<span class="built_in">Math</span>.floor((e_hrsold-hrsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    seconds=setzero(<span class="built_in">Math</span>.floor((e_minsold-minsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;days&#x27;</span>).innerHTML=<span class="string">&quot;已运行 &quot;</span>+daysold+<span class="string">&quot; 天 &quot;</span>+hrsold+<span class="string">&quot; 小时 &quot;</span>+minsold+<span class="string">&quot; 分 &quot;</span>+seconds+<span class="string">&quot; 秒&quot;</span>;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">setzero</span>(<span class="params">i</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (i&lt;<span class="number">10</span>) &#123;</span></span><br><span class="line"><span class="javascript">        i=<span class="string">&quot;0&quot;</span> + i</span></span><br><span class="line"><span class="javascript">    &#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> i;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript">show_date_time();</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后打开文件 <code>blog/themes/next/layout/_macro/sidebar.swig</code>（修改位置，可不修改）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  &#123;# Blogroll #&#125;</span><br><span class="line">  &#123;% if theme.links %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll motion-element &#123;&#123; &quot;</span><span class="attr">links-of-blogroll-</span>&quot; + <span class="attr">theme.links_layout</span> | <span class="attr">default</span>(&#x27;<span class="attr">inline</span>&#x27;) &#125;&#125;&quot;&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        &#123;&#123; theme.links_title &#125;&#125;<span class="symbol">&amp;nbsp;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-list&quot;</span>&gt;</span></span><br><span class="line">        &#123;% for name, link in theme.links %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-item&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; link &#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123; name &#125;&#125;&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">   &#123;% include &#x27;../_custom/sidebar.swig&#x27; %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以通过文件 <code>blog/themes/next/source/css/_custom/custom.styl</code> ，修改时间栏样式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 自定义的侧栏时间样式 */</span></span><br><span class="line"><span class="selector-id">#days</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">7</span>, <span class="number">179</span>, <span class="number">155</span>);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-16-侧栏头像点击返回首页（旧版本）"><a href="#2-16-侧栏头像点击返回首页（旧版本）" class="headerlink" title="2.16 侧栏头像点击返回首页（旧版本）"></a>2.16 侧栏头像点击返回首页（旧版本）</h3><p>修改文件 <code>blog/themes/next/layout/_macro/sidebar.swig</code> ：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;site-author-image&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;image&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for( theme.avatar | default(theme.images + &#x27;/avatar.gif&#x27;) ) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">alt</span>=<span class="string">&quot;&#123;&#123; theme.author &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-17-页脚增加会跳动的心（旧版本）"><a href="#2-17-页脚增加会跳动的心（旧版本）" class="headerlink" title="2.17 页脚增加会跳动的心（旧版本）"></a>2.17 页脚增加会跳动的心（旧版本）</h3><p>首先修改主题配置文件 <code>blog\themes\next\_config.yml</code> ，找到icon：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">footer:</span></span><br><span class="line">  <span class="comment"># Icon between year and copyright info.</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">heart</span></span><br></pre></td></tr></table></figure><p>然后修改文件 <code>blog/themes/next/layout/_partials/footer.swig</code> ，找到 <code>with-love</code> ，增加id：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;heart&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-&#123;&#123; theme.footer.icon &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最后修改文件 <code>blog/themes/next/source/css/_custom/custom.styl</code> ，增加以下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 自定义页脚跳动的心样式 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> heartAnimate &#123;</span><br><span class="line">    <span class="number">0%</span>,<span class="number">100%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1</span>);&#125;</span><br><span class="line">    <span class="number">10%</span>,<span class="number">30%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">0.9</span>);&#125;</span><br><span class="line">    <span class="number">20%</span>,<span class="number">40%</span>,<span class="number">60%</span>,<span class="number">80%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">    <span class="number">50%</span>,<span class="number">70%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#heart</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">    <span class="attribute">animation</span>: heartAnimate <span class="number">1.33s</span> ease-in-out infinite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-18-隐藏网页底部powered-By（旧版本）"><a href="#2-18-隐藏网页底部powered-By（旧版本）" class="headerlink" title="2.18 隐藏网页底部powered By（旧版本）"></a>2.18 隐藏网页底部powered By（旧版本）</h3><p>打开 <code>themes/next/layout/_partials/footer.swig</code> ，使用 “&lt;&#33;–&gt;” 隐藏之间的代码即可，或者直接删除，位置如图:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280213.png"></p><h3 id="2-19-自定义鼠标样式（旧版本）"><a href="#2-19-自定义鼠标样式（旧版本）" class="headerlink" title="2.19 自定义鼠标样式（旧版本）"></a>2.19 自定义鼠标样式（旧版本）</h3><p>打开 <code>themes/next/source/css/_custom/custom.styl</code> ，在里面写下如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 鼠标样式</span><br><span class="line">  * &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword2.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword1.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>其中 url 里面必须是 ico 图片，替换后发现实际点触和鼠标图标是有偏差的，所以我取消了鼠标的样式。</p><h3 id="2-20-博文压缩（旧版本）"><a href="#2-20-博文压缩（旧版本）" class="headerlink" title="2.20 博文压缩（旧版本）"></a>2.20 博文压缩（旧版本）</h3><p>在站点的根目录下执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp -g</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp --save</span></span><br></pre></td></tr></table></figure><p>根目录下新建 <code>gulpfile.js</code> ，并填入以下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">&#x27;gulp-minify-css&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">&#x27;gulp-uglify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlmin = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlmin&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlclean = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlclean&#x27;</span>);</span><br><span class="line"><span class="comment">// 压缩 public 目录 css</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-css&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.css&#x27;</span>)</span><br><span class="line">        .pipe(minifycss())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩 public 目录 html</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-html&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.html&#x27;</span>)</span><br><span class="line">    .pipe(htmlclean())</span><br><span class="line">    .pipe(htmlmin(&#123;</span><br><span class="line">         <span class="attr">removeComments</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyJS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyCSS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyURLs</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">    .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩 public/js 目录 js</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-js&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.js&#x27;</span>)</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 执行 gulp 命令时执行的任务</span></span><br><span class="line">gulp.task(<span class="string">&#x27;default&#x27;</span>, [</span><br><span class="line">    <span class="string">&#x27;minify-html&#x27;</span>,<span class="string">&#x27;minify-css&#x27;</span>,<span class="string">&#x27;minify-js&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>生成博文是执行 <code>hexo g &amp;&amp; gulp</code> 就会根据 <code>gulpfile.js</code> 中的配置，对 public 目录中的静态资源文件进行压缩。</p><h3 id="2-21-添加主页文章阴影效果（旧版本）"><a href="#2-21-添加主页文章阴影效果（旧版本）" class="headerlink" title="2.21 添加主页文章阴影效果（旧版本）"></a>2.21 添加主页文章阴影效果（旧版本）</h3><p>打开 <code>\themes\next\source\css\_custom\custom.styl</code> ，向里面加入：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 主页文章添加阴影效果</span><br><span class="line"> <span class="selector-class">.post</span> &#123;</span><br><span class="line">   <span class="attribute">margin-top</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">margin-bottom</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">   -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">203</span>, .<span class="number">5</span>);</span><br><span class="line">   -moz-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, .<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-22-添加动态背景（旧版本）"><a href="#2-22-添加动态背景（旧版本）" class="headerlink" title="2.22 添加动态背景（旧版本）"></a>2.22 添加动态背景（旧版本）</h3><p>如果next主题在5.1.1以上的话，直接在主题配置文件 <code>\themes\next\_config.yml</code> 中找到 <code>canvas_nest: false</code> ，把它改为 <code>canvas_nest: true</code> 就行了（注意分号后面要加一个空格）。</p><h2 id="三-功能配置-博文"><a href="#三-功能配置-博文" class="headerlink" title="三. 功能配置-博文"></a>三. 功能配置-博文</h2><h3 id="3-1-开启图片灯箱"><a href="#3-1-开启图片灯箱" class="headerlink" title="3.1 开启图片灯箱"></a>3.1 开启图片灯箱</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class="line"><span class="comment"># For more information: https://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-2-修改标签图标"><a href="#3-2-修改标签图标" class="headerlink" title="3.2 修改标签图标"></a>3.2 修改标签图标</h3><p>默认情况下标签前缀是 <code>#</code> 字符，旧版本中用户可以通过修改主题源码将标签的字符前缀改为图标前缀，在 <code>themes\next\layout\_macro\post.swig  </code> 文章布局模板中找到文末标签相关代码段，将 <code>#</code> 换成 <code>&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt;</code> 即可：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer class=&quot;post-footer&quot;&gt;</span><br><span class="line">    &#123;% if post.tags and post.tags.length and not is_index %&#125;</span><br><span class="line">      &lt;div class=&quot;post-tags&quot;&gt;</span><br><span class="line">        &#123;% for tag in post.tags %&#125;</span><br><span class="line"><span class="deletion">-          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;# &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line"><span class="addition">+          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt; &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/footer&gt;</span><br></pre></td></tr></table></figure><p>Next 中使用 <a href="https://fontawesome.com/v4.7.0/icons/">FontAwesome</a> 作为图标库，用户可以在 FontAwesome 上找到心仪的图标来替换标签的字符前缀。</p><p>新版直接修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use icon instead of the symbol # to indicate the tag at the bottom of the post</span></span><br><span class="line"><span class="attr">tag_icon:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-3-开启相关文章推荐"><a href="#3-3-开启相关文章推荐" class="headerlink" title="3.3 开启相关文章推荐"></a>3.3 开启相关文章推荐</h3><p>该功能由 <a href="https://github.com/tea3/hexo-related-popular-posts">hexo-related-popular-posts</a> 插件提供，在站点根目录中执行以下命令安装依赖：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-related-popular-posts --save</span></span><br></pre></td></tr></table></figure><p>在主题配置文件中 <code>\themes\next\_config.yml</code> 开启相关文章推荐功能：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Related popular posts</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/tea3/hexo-related-popular-posts</span></span><br><span class="line"><span class="attr">related_posts:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">title:</span> <span class="comment"># Custom header, leave empty to use the default one</span></span><br><span class="line">  <span class="attr">display_in_home:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">maxCount:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment">#PPMixingRate: 0.0</span></span><br><span class="line">    <span class="comment">#isDate: false</span></span><br><span class="line">    <span class="comment">#isImage: false</span></span><br><span class="line">    <span class="comment">#isExcerpt: false</span></span><br></pre></td></tr></table></figure><p>会在每篇文章结尾根据标签相关性和内容相关性来推荐相关文章。事实上并非每篇文章都需要开启该功能，可在文章 Front-Matter 中设置 <code>related_posts</code> 字段来控制是否在文末显示相关文章，然后修改文章布局模板中相关的判定条件 <code>themes/next/layout/_macro/post.njk</code> ：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) %&#125;</span></span><br><span class="line"><span class="addition">+     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) and post.related_posts %&#125;</span></span><br><span class="line">      &#123;&#123; partial(&#x27;_partials/post/post-related.njk&#x27;) &#125;&#125;</span><br></pre></td></tr></table></figure><p>为了方便可在草稿模板 <code>\scaffolds\draft.md</code> 中统一添加 <code>related_posts</code> 字段默认值：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="addition">+ related_posts: true</span></span><br></pre></td></tr></table></figure><h3 id="3-4-修改代码块自定义样式"><a href="#3-4-修改代码块自定义样式" class="headerlink" title="3.4 修改代码块自定义样式"></a>3.4 修改代码块自定义样式</h3><p>旧版本，打开 <code>\themes\next\source\css\_custom\custom.styl</code> ，向里面加入：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Custom styles.</span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ff7600</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fbf7f8</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br><span class="line">// 大代码块的自定义样式</span><br><span class="line"><span class="selector-class">.highlight</span>, pre &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.highlight</span>, <span class="selector-tag">code</span>, pre &#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d6d6d6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版本，主题配置文件中 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># Code Highlight theme</span></span><br><span class="line">  <span class="comment"># All available themes: https://theme-next.js.org/highlight/</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">tomorrow-night</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="comment"># Add copy button on codeblock</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">mac</span></span><br></pre></td></tr></table></figure><h3 id="3-5-添加顶部加载条"><a href="#3-5-添加顶部加载条" class="headerlink" title="3.5 添加顶部加载条"></a>3.5 添加顶部加载条</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 将 <code>pace: false</code> 改为 <code>pace: true</code> ，还可以换不同样式的加载条，如下图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280212.png"></p><p>查看不同主题效果：<a href="https://codebyzach.github.io/pace/">Pace-Themes</a></p><p>V8版本之后好像废弃了Pace，代替为nprogress，但没有样式可以选，而且似乎会和阅读进度条冲突：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Progress bar in the top during page loading.</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rstacruz/nprogress</span></span><br><span class="line"><span class="attr">nprogress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">spinner:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-6-开启顶部阅读进度"><a href="#3-6-开启顶部阅读进度" class="headerlink" title="3.6 开启顶部阅读进度"></a>3.6 开启顶部阅读进度</h3><p>主题配置文件中 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Reading progress bar</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available values: left | right</span></span><br><span class="line">  <span class="attr">start_at:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment"># Available values: top | bottom</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">top</span></span><br><span class="line">  <span class="attr">reversed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37acc6&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">3px</span></span><br></pre></td></tr></table></figure><h3 id="3-7-右上角添加bookmark记录阅读进度"><a href="#3-7-右上角添加bookmark记录阅读进度" class="headerlink" title="3.7 右上角添加bookmark记录阅读进度"></a>3.7 右上角添加bookmark记录阅读进度</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bookmark Support</span></span><br><span class="line"><span class="attr">bookmark:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Customize the color of the bookmark.</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#222&quot;</span></span><br><span class="line">  <span class="comment"># If auto, save the reading progress when closing the page or clicking the bookmark-icon.</span></span><br><span class="line">  <span class="comment"># If manual, only save it by clicking the bookmark-icon.</span></span><br><span class="line">  <span class="attr">save:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><h3 id="3-8-右上角添加-Follow-Me-On-GitHub"><a href="#3-8-右上角添加-Follow-Me-On-GitHub" class="headerlink" title="3.8 右上角添加 Follow Me On GitHub"></a>3.8 右上角添加 Follow Me On GitHub</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `Follow me on GitHub` banner in the top-right corner.</span></span><br><span class="line"><span class="attr">github_banner:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">permalink:</span> <span class="string">https://github.com/LAILAIWA</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Follow</span> <span class="string">me</span> <span class="string">on</span> <span class="string">GitHub</span></span><br></pre></td></tr></table></figure><h3 id="3-9-返回顶部按钮添加百分比"><a href="#3-9-返回顶部按钮添加百分比" class="headerlink" title="3.9 返回顶部按钮添加百分比"></a>3.9 返回顶部按钮添加百分比</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-10-取消目录生成的自动序号"><a href="#3-10-取消目录生成的自动序号" class="headerlink" title="3.10 取消目录生成的自动序号"></a>3.10 取消目录生成的自动序号</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中number属性为false即可。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Table Of Contents in the Sidebar</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="3-11-添加底部访问量（旧版本）"><a href="#3-11-添加底部访问量（旧版本）" class="headerlink" title="3.11 添加底部访问量（旧版本）"></a>3.11 添加底部访问量（旧版本）</h3><p>打开 <code>\themes\next\layout\_partials\footer.swig</code> 文件，在copyright前加上这句话：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;https://dn-</span></span></span><br><span class="line"><span class="string"><span class="tag">lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>2019/07/16更新：<a href="http://busuanzi.ibruce.info/" title="Title">不蒜子官网</a>提示原地址已失效，请把dn-lbstatics.qbox.me 域名更换为 busuanzi.ibruce.info</p></blockquote><p>然后在合适的位置添加显示统计的代码:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280215.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;powered-by&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-user-md&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  本站访客数:<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这里有两中不同计算方式的统计代码：</p><ul><li><p>pv的方式，单个用户连续点击n篇文章，记录n次访问量：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span></span><br><span class="line">    本站总访问量<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_pv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>次</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>uv的方式，单个用户连续点击n篇文章，只记录1次访客数：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  本站总访问量<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>次</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>添加之后再执行 <code>hexo d -g</code> ，然后再刷新页面就能看到效果。</p><h3 id="3-12-添加博文末尾标记（旧版本）"><a href="#3-12-添加博文末尾标记（旧版本）" class="headerlink" title="3.12 添加博文末尾标记（旧版本）"></a>3.12 添加博文末尾标记（旧版本）</h3><p>在 <code>\themes\next\layout\_macro</code> 中新建 <code>passage-end-tag.swig</code> 文件，并添加以下内容:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if not is_index %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;color: #ccc;font-size:14px;&quot;</span>&gt;</span>-------------本文结束<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-paw&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>感谢您的阅读-------------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接着打开 <code>\themes\next\layout\_macro\post.swig</code> 文件，在post-body 之后， post-footer 之前添加如下画红色部分代码（post-footer之前两个DIV）:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280211.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">    &#123;% include &#x27;passage-end-tag.swig&#x27; %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后打开主题配置文件 <code>\themes\next\_config.yml</code> ，在末尾添加:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文章末尾添加“本文结束”标记</span></span><br><span class="line"><span class="attr">passage_end_tag:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>完成以上设置之后，在每篇文章之后都会添加如上效果图的样子。</p><h3 id="3-13-MarkDown常用"><a href="#3-13-MarkDown常用" class="headerlink" title="3.13 MarkDown常用"></a>3.13 MarkDown常用</h3><p>代码新增删除变色：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">​<span class="code">```diff</span></span><br><span class="line"><span class="code">+</span></span><br><span class="line"><span class="code">-</span></span><br><span class="line"><span class="code">​```</span></span><br></pre></td></tr></table></figure><h2 id="四-新增插件"><a href="#四-新增插件" class="headerlink" title="四. 新增插件"></a>四. 新增插件</h2><h3 id="4-1-统计功能"><a href="#4-1-统计功能" class="headerlink" title="4.1 统计功能"></a>4.1 统计功能</h3><p>实现统计功能，首先在根目录下安装 <code>hexo-wordcount</code> ，运行:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-wordcount --save</span></span><br></pre></td></tr></table></figure><p>然后在主题配置文件 <code>\themes\next\_config.yml</code> 中，配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/willin/hexo-wordcount</span></span><br><span class="line"><span class="attr">post_wordcount:</span></span><br><span class="line">  <span class="attr">item_text:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wordcount:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">min2read:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>新版本，在根目录下安装 <code>hexo-word-counter</code> ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-word-counter</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br></pre></td></tr></table></figure><p>根目录配置文件 <code>\_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字数统计</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># 开启当前页面字数统计</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 开启当前页面估计阅读时间</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 页脚添加全站字数统计</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 页脚添加全站估计阅读时间</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 平均字长</span></span><br><span class="line">  <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># 每分钟的平均字数</span></span><br><span class="line">  <span class="attr">wpm:</span> <span class="number">275</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># 是否在同一行</span></span><br><span class="line">  <span class="attr">separated_meta:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 是否在页脚显式</span></span><br><span class="line">  <span class="attr">item_text_total:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="4-2-增加搜索功能"><a href="#4-2-增加搜索功能" class="headerlink" title="4.2 增加搜索功能"></a>4.2 增加搜索功能</h3><p>安装 <code>hexo-generator-searchdb</code> ，在站点的根目录下执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-generator-searchdb --save</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，找到 <code>local_search</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Local search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/flashlab/hexo-generator-search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># if auto, trigger search by changing input</span></span><br><span class="line">  <span class="comment"># if manual, trigger search by pressing enter key or search button</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="4-3-夜晚模式"><a href="#4-3-夜晚模式" class="headerlink" title="4.3 夜晚模式"></a>4.3 夜晚模式</h3><p>安装 <code>hexo-next-darkmode</code> 插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-next-darkmode --save</span></span><br></pre></td></tr></table></figure><p>在主题配置文件 <code>\themes\next\_config.yml</code> 里添加以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Darkmode JS</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rqh656418510/hexo-next-darkmode, https://github.com/sandoche/Darkmode.js</span></span><br><span class="line"><span class="attr">darkmode_js:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bottom:</span> <span class="string">&#x27;64px&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">right:</span> <span class="string">&#x27;unset&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">left:</span> <span class="string">&#x27;32px&#x27;</span> <span class="comment"># default: &#x27;unset&#x27;</span></span><br><span class="line">  <span class="attr">time:</span> <span class="string">&#x27;0.5s&#x27;</span> <span class="comment"># default: &#x27;0.3s&#x27;</span></span><br><span class="line">  <span class="attr">mixColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">backgroundColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorDark:</span> <span class="string">&#x27;#100f2c&#x27;</span> <span class="comment"># default: &#x27;#100f2c&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorLight:</span> <span class="string">&#x27;#fff&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">isActivated:</span> <span class="literal">false</span> <span class="comment"># default false</span></span><br><span class="line">  <span class="attr">saveInCookies:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">&#x27;🌓&#x27;</span> <span class="comment"># default: &#x27;&#x27;</span></span><br><span class="line">  <span class="attr">autoMatchOsTheme:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="comment"># Set custom library cdn url for Darkmode.js</span></span><br></pre></td></tr></table></figure><ul><li><code>isActivated: true</code>：默认激活暗黑 / 夜间模式，请始终与 <code>saveInCookies: false</code>、<code>autoMatchOsTheme: false</code> 一起使用</li></ul><p>确保 Next 原生的 <code>darkmode</code> 选项设置为 <code>false</code>，在主题配置文件 <code>\themes\next\_config.yml</code> 中更改以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">darkmode:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>夜晚模式激活后，<code>hexo-next-darkmode</code> 插件会将 <code>darkmode--activated</code> CSS 类添加到 <code>body</code> 标签，可以利用它覆盖插件默认自带的 CSS 样式（如下所示）；这样就可以实现暗黑模式 CSS 样式的高度自定义，包括代码块颜色自定义切换等。更多配置内容介绍可以参考<a href="https://github.com/rqh656418510/hexo-next-darkmode/blob/main/README_CN.md">官方文档</a>，实现原理分析可以看<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90">这里</a>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.darkmode--activated</span> &#123;</span><br><span class="line">  --<span class="selector-tag">body</span>-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="attribute">content</span>-bg-<span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  --card-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --text-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --<span class="selector-tag">blockquote</span>-<span class="attribute">color</span>: <span class="number">#bbb</span>;</span><br><span class="line">  --link-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --link-hover-<span class="attribute">color</span>: <span class="number">#eee</span>;</span><br><span class="line">  --brand-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --brand-hover-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-odd-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-hover-bg-<span class="attribute">color</span>: <span class="number">#363636</span>;</span><br><span class="line">  --<span class="selector-tag">menu</span>-item-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-bg: <span class="number">#222</span>;</span><br><span class="line">  --btn-default-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-<span class="attribute">border-color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-hover-bg: <span class="number">#666</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">border-color</span>: <span class="number">#666</span>;</span><br><span class="line">  --highlight-<span class="attribute">background</span>: <span class="number">#282b2e</span>;</span><br><span class="line">  --highlight-foreground: <span class="number">#a9b7c6</span>;</span><br><span class="line">  --highlight-gutter-<span class="attribute">background</span>: <span class="number">#34393d</span>;</span><br><span class="line">  --highlight-gutter-foreground: <span class="number">#9ca9b6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.75</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#69dbdc</span>;</span><br><span class="line">  <span class="attribute">background</span>: transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hexo 重新构建生成静态文件后，点击页面上的按钮即可切换暗黑模式，最终演示效果可以看<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E6%9C%80%E7%BB%88%E6%BC%94%E7%A4%BA%E6%95%88%E6%9E%9C">这里</a>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo g -d</span></span><br></pre></td></tr></table></figure><h3 id="4-4-豆瓣阅读-电影-游戏"><a href="#4-4-豆瓣阅读-电影-游戏" class="headerlink" title="4.4 豆瓣阅读 / 电影 / 游戏"></a>4.4 豆瓣阅读 / 电影 / 游戏</h3><p>为站点添加豆瓣阅读 / 电影 / 游戏页面，在根目录下执行以下命令安装相关依赖：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-douban --save</span></span><br></pre></td></tr></table></figure><p>在站点配置文件 <code>/_config.yml</code> 中添加以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">douban:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="comment"># 个人豆瓣ID</span></span><br><span class="line">  <span class="attr">builtin:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">book:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my book title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my book quote&quot;</span></span><br><span class="line">  <span class="attr">movie:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my movie title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my movie quote&quot;</span></span><br><span class="line">  <span class="attr">game:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my game title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my game quote&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure><ul><li>user: 填写豆瓣 ID。登陆豆瓣后点击<strong>个人主页</strong>，此时 url 中最后一段即是用户 ID，一般情况下会是一段数字，如果设置了个人域名的话，则个人域名即为 ID。</li><li>builtin: 是否将生成页面的功能嵌入 <code>hexo s</code> 和 <code>hexo g</code> 中。</li><li>timeout: 爬取数据的超时时间。</li></ul><p>如果只想生成某一个页面（比如只生成读书页面），把其他的配置项注释掉即可。</p><p>在主题配置文件 <code>\themes\next\_config.yml</code> 中新增菜单入口：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: / || home</span><br><span class="line">    tags: /tags/ || tags</span><br><span class="line">    categories: /categories/ || th</span><br><span class="line">    archives: /archives/ || tasks</span><br><span class="line"><span class="addition">+   books: /books/ || book</span></span><br><span class="line"><span class="addition">+   movies: /movies/ || video-camera</span></span><br><span class="line"><span class="addition">+   games: /games/ || gamepad</span></span><br></pre></td></tr></table></figure><p>在语言包 <code>themes\next\language\zh_CN.yml</code> 中新增菜单中文：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: 首页</span><br><span class="line">    archives: 归档</span><br><span class="line">    categories: 分类</span><br><span class="line">    tags: 标签</span><br><span class="line"><span class="addition">+   movies: 电影</span></span><br><span class="line"><span class="addition">+   books: 读书</span></span><br><span class="line"><span class="addition">+   games: 游戏</span></span><br></pre></td></tr></table></figure><p>然后在根目录下执行以下命令生成豆瓣阅读 / 电影 / 游戏页面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo douban</span></span><br></pre></td></tr></table></figure><p>可选参数:</p><ul><li>-b | –books: 只生成豆瓣读书页面</li><li>-m | –movies: 只生成豆瓣电影页面</li><li>-g | –games: 只生成豆瓣游戏页面</li></ul><p>执行命令后，插件会根据用户提供的 ID 爬取豆瓣中的数据信息并在 <code>public</code> 目录下生成对应的页面，当服务器启动或部署后会将页面显示在对应的菜单路由下。</p><p>如果在站点配置中设置了 <code>douban.builtin: false</code>，则每次豆瓣数据变动后需要手动执行一次 <code>hexo douban</code> 来刷新页面数据。如果设置了 <code>douban.builtin: true</code>，则每次执行 <code>hexo s</code> 和 <code>hexo g</code> 的时候将会自动同时执行 <code>hexo douban</code> 命令，但这样可能会增加打包编译的时间。建议如果豆瓣数据变动不频繁的情况下该项设为 <code>false</code> 即可。</p><p>普遍会用 <code>hexo d</code> 来作为 <code>hexo deploy</code> 命令的简化，但是当安装了 <code>hexo douban</code> 之后， <code>hexo d</code> 就会有歧义而无法执行，因为 <code>hexo douban</code> 跟 <code>hexo deploy</code> 的 Alias 都是 <code>hexo d</code>。</p><p>以下问题需要重装Node到12.18.x的版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  0 books have been loaded in 1223 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 movies have been loaded in 1743 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 games have been loaded in 1133 ms, because you are offline or your network is bad</span><br></pre></td></tr></table></figure><h3 id="4-5-留言板"><a href="#4-5-留言板" class="headerlink" title="4.5 留言板"></a>4.5 留言板</h3><p>Next 支持多款评论系统：</p><ul><li><a href="https://disqus.com/">Disqus</a>：欧美 UI 风格，支持 Tweet、Facebook 等国外社交软件的三方登陆和一键分享； <a href="https://blog.disqus.com/disqus-welcomes-the-spruce">Demo</a>；</li><li><a href="https://github.com/imsun/gitment">gitment</a>：必须用 github 账号登陆才能评论，支持 Markdown 语法，与 github issues 页面风格一致；<a href="https://imsun.github.io/gitment/">Demo</a>；</li><li><a href="https://valine.js.org/">Valine</a>：支持匿名评论，支持 Markdown 语法，界面简洁美观；</li><li><a href="http://changyan.kuaizhan.com/">畅言</a>：国产评论系统，可区分热评和最新评论，论坛贴吧风；</li><li><a href="https://www.livere.com/">来必力</a>：支持插入图片和 GIF，支持国内外多种社交媒体的三方登陆 <a href="https://www.livere.com/city-demo">Demo</a>；</li></ul><h4 id="（1）utterances"><a href="#（1）utterances" class="headerlink" title="（1）utterances"></a>（1）utterances</h4><blockquote><p>为什么选用utterances？</p><ol><li>没有广告</li><li>不会追踪用户隐私</li><li>搭建于GitHub，不需要再注册账号才能使用</li></ol></blockquote><p><a href="https://github.com/apps/utterances" title="title">安装utterances</a>-&gt;【Install】-&gt;【Only Select Repositories】选择博客所在repo-&gt;【填写owner/repo】-&gt;【设置issue标题如何开】-&gt;【填写Issue Label】-&gt;【选择主题样式】-&gt;【复制生成的代码】。</p><p>首先在博客对应的Repository中增加要使用的label：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010186.png"></p><p>如图所示，新增了一个💬Comments：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010187.png"></p><p>修改 <code>blog\themes\next\layout\_third-party\comments\utterances.swig</code> (请注意此处有漏掉label的配置，后续才发现，可以参考下文中正确内容)：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>修改 <code>blog\themes\next\layout\_partials\comments.swig</code> ：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% elseif theme.valine.appid and theme.valine.appkey %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% elseif theme.utterances.enable %&#125;</span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">     &#123;% include &#x27;../_third-party/comments/utterances.swig&#x27; %&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>然后在主题的配置文件中，增加如下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加留言板功能</span></span><br><span class="line"><span class="comment"># Demo: https://utteranc.es/  http://trumandu.github.io/about/</span></span><br><span class="line">  <span class="comment"># pathname, url, title, og:title [ISSUE NUMBER] or [SPECIFIC TERM]</span></span><br><span class="line">  <span class="comment"># theme: github-light,github-dark,github-dark-orange</span></span><br><span class="line">  <span class="comment"># The label must exist in your repo</span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">LAILAIWA/LAILAIWA.github.io</span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">💬Comments</span> </span><br></pre></td></tr></table></figure><p>更新博客，并任意打开一篇文章：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010188.png"></p><p>需要授权GitHub账户信息才能正常使用：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010189.png"></p><p>尝试评论一次，测试功能是否正常：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010190.png"></p><p>回到GitHub-issues，可以发现多了刚刚添加的回复，但很明显没有使用我们创建的label：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010191.png"></p><p>检查以上步骤，发现 <code>utterances.swig</code> 粘贴copy的代码时，当时页面未填写label，补充完整：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">label</span>=<span class="string">&quot;💬Comments&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>更新博客，并再次评论，然后确认是否使用正确的label，结果如下，修改成功：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010192.png"></p><p>2019年8月1日更新的NexT 7.3.0 版本集成了utterances评论</p><p>使用命令安装：<code>npm install theme-next/hexo-next-utteranc</code></p><p>配置部分和之前类似，<a href="http://chaih.com/2021/02/04/utterances-comment-for-Hexo-theme-nexT/">使用Hexo theme nexT并加入utterances comment</a>。</p><h4 id="（2）gitalk"><a href="#（2）gitalk" class="headerlink" title="（2）gitalk"></a>（2）gitalk</h4><p><a href="https://www.cnblogs.com/qisi007/p/13731562.html">hexo博客添加gitalk评论系统</a></p><h3 id="4-6-文章评分"><a href="#4-6-文章评分" class="headerlink" title="4.6 文章评分"></a>4.6 文章评分</h3><p><a href="https://widgetpack.com/">widgetpack</a> 是一款轻量级的插件，提供四项具体的功能：</p><ul><li>Comments: 评论系统，类似于留言板</li><li>Reviews: 评价系统，类似于商品评价</li><li>Rating: 星级评分系统</li><li>Google Reviews: 关联展示 Google Rating</li></ul><p>Next 主题中已经集成了 widgetpack 的星级评分系统，用户无须再安装或引入插件脚本，只需在 widgetpack 中注册账号并修改主题配置即可，应用效果如下：</p><p><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rating.png" alt="文章评分组件"></p><p>在 <a href="https://widgetpack.com/">widgetpack</a> 中注册账号，根据引导填写应用名称和域名创建应用，创建后可在页面左上角看到应用 id。</p><p>在主题配置文件 <code>themes\next_config.yml</code> 中开启评分功能，填写应用 id，并设置评分颜色：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Star rating support to each article.</span></span><br><span class="line"><span class="comment"># To get your ID visit https://widgetpack.com</span></span><br><span class="line"><span class="attr">rating:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">id:</span> <span class="comment">#&lt;app_id&gt;</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">fadb14</span></span><br></pre></td></tr></table></figure><p>此时刷新浏览器即可在文章末尾看到空的评分栏了。点击评分发现需要以社交账号登陆，而这些社交账号基本都是 facebook、twitter 等墙外的社交软件，限制了评分系统可用性，我们可以在 widgetpack 控制台中修改评分认证机制。</p><p>在控制台中点击左上角展开菜单，在 <strong>Rating</strong> -&gt; <strong>Setting</strong> 中将 Vote via 选项改为 Device(cookie) 以开启匿名评分，该选项将基于设备认证访问者身份：</p><p><a href="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png"><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png" alt="开启匿名评分"></a></p><p>用户还可以在该页面设定 star 数量和大小。修改后记得勾选右下角的 SAVE SETTING 才会生效。</p><p>在实际使用过程中，并非每篇文章都需要开启评分。此时可在 Front-Matter 中设定变量 rating 用于控制是否开启评分。修改文章布局模板中相关代码，使得只有当主题配置文件 <code>themes\next\layout_macro\post.swig</code> 中 <code>rating.enable</code> 字段和 <code>page.rating</code> 字段同时为 <code>true</code> 才会插入评分组件：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">-  &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">+  &#123;% if (theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> and post<span class="selector-class">.rating</span>) or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;post-widgets&quot;&gt;</span><br><span class="line">    &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> %&#125;</span><br><span class="line">      &lt;<span class="selector-tag">div</span> class=&quot;wp_rating&quot;&gt;</span><br><span class="line">        &lt;<span class="selector-tag">div</span> id=&quot;wpac-rating&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">      &lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>为了批量为每篇新文章设定该变量并赋默认值，可以修改草稿模板内容 <code>scaffolds\draft.md</code> ，这样以来每篇草稿发布后都会默认开启评分：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="bullet">+</span> rating: true</span><br></pre></td></tr></table></figure><p>站点上线后，可以在控制台菜单的 <strong>Site</strong> -&gt; <strong>Setting</strong> 中勾选 Private，使得组件只对应用内指定的域名上生效，这样以来即时别人错填了你的 id 也不会将评分数据误提交到你的应用中了。</p><p>widgetpack 与前文提到的 hotjar 在评价反馈功能上的侧重点不一样，widgetpack 更侧重于对文章的评分，而 hotjar 侧重于对整个页面的评分，并提供了文字和截图反馈的渠道。</p><h3 id="4-7-博文加密"><a href="#4-7-博文加密" class="headerlink" title="4.7 博文加密"></a>4.7 博文加密</h3><p>首先安装插件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-blog-encrypt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span> </span><br><span class="line">yarn add hexo-blog-encrypt</span><br></pre></td></tr></table></figure><p>MD文件信息头中添加password：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password: &lt;密码&gt; # 为空表示无密码</span><br></pre></td></tr></table></figure><p>标准内容如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line">tags:</span><br><span class="line"><span class="bullet">-</span> 作为日记加密</span><br><span class="line">date: 2016-03-30 21:12:21</span><br><span class="line">password: mikemessi</span><br><span class="line">abstract: 有东西被加密了, 请输入密码查看.</span><br><span class="line">message: 您好, 这里需要密码.</span><br><span class="line">wrong<span class="emphasis">_pass_</span>message: 抱歉, 这个密码看着不太对, 请再试试.</span><br><span class="line"><span class="section">wrong<span class="emphasis">_hash_</span>message: 抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><p>可以直接在配置文件中统一设置 <code>blog/_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Security</span></span><br><span class="line"><span class="attr">encrypt:</span> <span class="comment"># hexo-blog-encrypt</span></span><br><span class="line">  <span class="attr">abstract:</span> <span class="string">这篇文章被加密了,</span> <span class="string">请输入密码查看.</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">您好,</span> <span class="string">这里需要密码.</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">密码A</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">密码B</span>&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;div</span> <span class="string">id=&quot;hexo-blog-encrypt&quot;</span> <span class="string">data-wpm=&quot;&#123;&#123;hbeWrongPassMessage&#125;&#125;&quot;</span> <span class="string">data-whm=&quot;&#123;&#123;hbeWrongHashMessage&#125;&#125;&quot;&gt;&lt;div</span> <span class="string">class=&quot;hbe-input-container&quot;&gt;&lt;input</span> <span class="string">type=&quot;password&quot;</span> <span class="string">id=&quot;hbePass&quot;</span> <span class="string">placeholder=&quot;&#123;&#123;hbeMessage&#125;&#125;&quot;</span> <span class="string">/&gt;&lt;label&gt;&#123;&#123;hbeMessage&#125;&#125;&lt;/label&gt;&lt;div</span> <span class="string">class=&quot;bottom-line&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;script</span> <span class="string">id=&quot;hbeData&quot;</span> <span class="string">type=&quot;hbeData&quot;</span> <span class="string">data-hmacdigest=&quot;&#123;&#123;hbeHmacDigest&#125;&#125;&quot;&gt;&#123;&#123;hbeEncryptedData&#125;&#125;&lt;/script&gt;&lt;/div&gt;</span></span><br><span class="line">  <span class="attr">wrong_pass_message:</span> <span class="string">抱歉,</span> <span class="string">这个密码看着不太对,</span> <span class="string">请再试试.</span></span><br><span class="line">  <span class="attr">wrong_hash_message:</span> <span class="string">抱歉,</span> <span class="string">这个文章不能被校验,</span> <span class="string">不过您还是能看看解密后的内容.</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">default_abstract:</span> <span class="string">此文章已被加密，需要输入密码访问。</span>  <span class="string">//首页文章列表中加密文章的默认描述文案</span></span><br><span class="line">  <span class="attr">default_message:</span> <span class="string">请输入密码以阅读这篇私密文章。</span>  <span class="string">//文章详情页的密码输入框上的默认描述文案</span></span><br></pre></td></tr></table></figure><p>然后在文章 Front-Matter 中添加 <code>password</code> 字段用于设置文章访问密码。重启服务器，这个时候可能需要经历较长一段时间的加密过程，请耐心等待，加密完成后刷新页面将会显示密码输入框，输入密码后才能继续访问文章内容。</p><p>该功能只会加密文章正文，其他内容如打赏、版权信息、标签等则不会被加密隐藏，这样看起来有点奇怪，所以建议加密文章隐藏掉打赏和版权信息内容。</p><p>密码输入错误时将会显示浏览器默认告警弹窗，可以使用 <a href="https://sweetalert.js.org/">sweetalert</a> 来美化错误提示。在主题自定义布局文件 <code>themes\next\layout_custom\custom.swig</code> 中添加如下代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/sweetalert/dist/sweetalert.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果 <code>custom.swig</code> 文件不存在，需要手动新建并在布局页面 <code>themes\next\layout_layout.swig</code> 中 body 末尾引入：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      ...</span><br><span class="line">      &#123;% include &#x27;_third-party/exturl.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/bookmark.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/copy-code.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+     &#123;% include &#x27;_custom/custom.swig&#x27; %&#125;</span></span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在 <code>node_modules</code> 依赖库 <code>node_modules\hexo-blog-encrypt\lib\blog.encrypt.js</code> 中修改 <code>hexo-blog-encrypt</code> 源码：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line"><span class="deletion">-   alert(decryptionError);</span></span><br><span class="line"><span class="addition">+   swal(&#123;</span></span><br><span class="line"><span class="addition">+     text: &quot;密码错误!&quot;,</span></span><br><span class="line"><span class="addition">+     icon: &quot;error&quot;,</span></span><br><span class="line"><span class="addition">+     className: &quot;password-error&quot;,</span></span><br><span class="line"><span class="addition">+     timer: 1000,</span></span><br><span class="line"><span class="addition">+     button: false</span></span><br><span class="line"><span class="addition">+   &#125;);</span></span><br><span class="line">    console.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>在自定义样式文件 <code>themes/next/source/css/_custom/custom.styl</code> 中添加如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//密码错误sweetalert弹框样式修改</span><br><span class="line"><span class="selector-class">.swal-overlay</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.password-error</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">4px</span> <span class="number">12px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.15</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于是在 <code>node_module</code> 中修改的依赖文件，一旦更新或者重装依赖都会覆盖修改，需要重新修改一遍</p><h3 id="4-8-添加-Google-Analytics-监控-GitHub-Pages-访问流量"><a href="#4-8-添加-Google-Analytics-监控-GitHub-Pages-访问流量" class="headerlink" title="4.8 添加 Google Analytics 监控 GitHub Pages 访问流量"></a>4.8 添加 Google Analytics 监控 GitHub Pages 访问流量</h3><p>在谷歌的<a href="https://analytics.google.com/">Google Analytics</a>中注册个人账户，配置网站信息获得衡量ID（或者使用百度统计）：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201201/202012280109.png"></p><p>在博客目录主题下的 <code>_config.yml</code> 中配置（注意非根目录）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google Analytics</span></span><br><span class="line"><span class="attr">google_analytics:</span></span><br><span class="line">  <span class="attr">tracking_id:</span> <span class="string">XXX</span></span><br><span class="line">  <span class="attr">localhost_ignored:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">baidu_analytics:</span> <span class="string">XXX（&quot;https://hm.baidu.com/hm.js?____________________&quot;）</span></span><br></pre></td></tr></table></figure><p>修改 <code>\themes\next\layout\_third-party\analytics\google-analytics.swig</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> theme.google_analytics.tracking_id %&#125;</span><br><span class="line">  &lt;script <span class="keyword">async</span> src=<span class="string">&quot;https://www.googletagmanager.com/gtag/js?id=&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">var</span> host = <span class="built_in">window</span>.location.hostname;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">if</span> (host !== <span class="string">&quot;localhost&quot;</span> || !&#123;&#123;theme.google_analytics.localhost_ignored&#125;&#125;) &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="built_in">window</span>.dataLayer = <span class="built_in">window</span>.dataLayer || [];</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="function"><span class="keyword">function</span> <span class="title">gtag</span>(<span class="params"></span>)</span>&#123;dataLayer.push(<span class="built_in">arguments</span>);&#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;js&#x27;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&#x27;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h3 id="4-9-音乐播放器"><a href="#4-9-音乐播放器" class="headerlink" title="4.9 音乐播放器"></a>4.9 音乐播放器</h3><p>音乐播放器使用：<a href="https://github.com/grzhan/hexo-tag-aplayer">hexo-tag-aplayer</a></p><p>内容来自官方文档：<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">MetingJS</a></p><h4 id="（1）APlayer"><a href="#（1）APlayer" class="headerlink" title="（1）APlayer"></a>（1）APlayer</h4><p>安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-tag-aplayer</span><br></pre></td></tr></table></figure><p>依赖版本：</p><ul><li>APlayer.js &gt; 1.8.0</li><li>Meting.js &gt; 1.1.1</li></ul><p>Markdown文档中使用：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer title author url [picture<span class="emphasis">_url, narrow, autoplay, width:xxx, lrc:xxx] %&#125;</span></span><br></pre></td></tr></table></figure><p>参数：</p><ul><li><code>title</code> : 曲目标题</li><li><code>author</code>: 曲目作者</li><li><code>url</code>: 音乐文件 URL 地址</li><li><code>picture_url</code>: (可选) 音乐对应的图片地址</li><li><code>narrow</code>: （可选）播放器袖珍风格</li><li><code>autoplay</code>: (可选) 自动播放，移动端浏览器暂时不支持此功能</li><li><code>width:xxx</code>: (可选) 播放器宽度 (默认: 100%)</li><li><code>lrc:xxx</code>: （可选）歌词文件 URL 地址</li></ul><p>当开启 Hexo 的 <a href="https://hexo.io/zh-cn/docs/asset-folders.html#%E6%96%87%E7%AB%A0%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%A4%B9">文章资源文件夹</a> 功能时，可以将图片、音乐文件、歌词文件放入与文章对应的资源文件夹中，然后直接引用：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer &quot;Caffeine&quot; &quot;Jeff Williams&quot; &quot;caffeine.mp3&quot; &quot;picture.jpg&quot; &quot;lrc:caffeine.txt&quot; %&#125;</span><br></pre></td></tr></table></figure><p>除了使用标签 <code>lrc</code> 选项来设定歌词，你也可以直接使用 <code>aplayerlrc</code> 标签来直接插入歌词文本在博客中：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlrc &quot;title&quot; &quot;author&quot; &quot;url&quot; &quot;autoplay&quot; %&#125;</span><br><span class="line">[00:00.00]lrc here</span><br><span class="line">&#123;% endaplayerlrc %&#125;</span><br></pre></td></tr></table></figure><p>播放列表：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlist %&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;narrow&quot;</span>: <span class="literal">false</span>,                          <span class="comment">// （可选）播放器袖珍风格</span></span><br><span class="line">    <span class="attr">&quot;autoplay&quot;</span>: <span class="literal">true</span>,                         <span class="comment">// （可选) 自动播放，移动端浏览器暂时不支持此功能</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;random&quot;</span>,                         <span class="comment">// （可选）曲目循环类型，有 &#x27;random&#x27;（随机播放）, &#x27;single&#x27; (单曲播放), &#x27;circulation&#x27; (循环播放), &#x27;order&#x27; (列表播放)， 默认：&#x27;circulation&#x27; </span></span><br><span class="line">    <span class="attr">&quot;showlrc&quot;</span>: <span class="number">3</span>,                             <span class="comment">// （可选）歌词显示配置项，可选项有：1,2,3</span></span><br><span class="line">    <span class="attr">&quot;mutex&quot;</span>: <span class="literal">true</span>,                            <span class="comment">// （可选）该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停</span></span><br><span class="line">    <span class="attr">&quot;theme&quot;</span>: <span class="string">&quot;#e6d0b2&quot;</span>,                      <span class="comment">// （可选）播放器风格色彩设置，默认：#b7daff</span></span><br><span class="line">    <span class="attr">&quot;preload&quot;</span>: <span class="string">&quot;metadata&quot;</span>,                    <span class="comment">// （可选）音乐文件预载入模式，可选项： &#x27;none&#x27; &#x27;metadata&#x27; &#x27;auto&#x27;, 默认: &#x27;auto&#x27;</span></span><br><span class="line">    <span class="attr">&quot;listmaxheight&quot;</span>: <span class="string">&quot;513px&quot;</span>,                 <span class="comment">// (可选) 该播放列表的最大长度</span></span><br><span class="line">    <span class="attr">&quot;music&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;CoCo&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Jeff Williams&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;caffeine.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;caffeine.jpeg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lrc&quot;</span>: <span class="string">&quot;caffeine.txt&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;アイロニ&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;鹿乃&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;irony.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;irony.jpg&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endaplayerlist %&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）MeingJS-支持-3-0-新功能"><a href="#（2）MeingJS-支持-3-0-新功能" class="headerlink" title="（2）MeingJS 支持 (3.0 新功能)"></a>（2）MeingJS 支持 (3.0 新功能)</h4><p><a href="https://github.com/metowolf/MetingJS">MetingJS</a> 是基于<a href="https://github.com/metowolf/Meting">Meting API</a> 的 APlayer 衍生播放器，引入 MetingJS 后，播放器将支持对于 QQ音乐、网易云音乐、虾米、酷狗、百度等平台的音乐播放。</p><p>如果想在本插件中使用 MetingJS，请在 Hexo 配置文件 <code>_config.yml</code> 中设置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>接着就可以通过 <code>&#123;% meting ...%&#125;</code> 在文章中使用 MetingJS 播放器了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 简单示例 (id, server, type)  --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- 进阶示例 --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; &quot;autoplay&quot; &quot;mutex:false<span class="string">&quot; &quot;</span>listmaxheight:<span class="number">340px</span><span class="string">&quot; &quot;</span>preload:none<span class="string">&quot; &quot;</span>theme:<span class="number">#ad7a86</span><span class="string">&quot;%&#125;</span></span><br></pre></td></tr></table></figure><p>有关 <code>&#123;% meting %&#125;</code> 的选项列表如下：</p><table><thead><tr><th>选项</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td><strong>必须值</strong></td><td>歌曲 id / 播放列表 id / 相册 id / 搜索关键字</td></tr><tr><td>server</td><td><strong>必须值</strong></td><td>音乐平台: <code>netease</code>, <code>tencent</code>, <code>kugou</code>, <code>xiami</code>, <code>baidu</code></td></tr><tr><td>type</td><td><strong>必须值</strong></td><td><code>song</code>, <code>playlist</code>, <code>album</code>, <code>search</code>, <code>artist</code></td></tr><tr><td>fixed</td><td><code>false</code></td><td>开启固定模式</td></tr><tr><td>mini</td><td><code>false</code></td><td>开启迷你模式</td></tr><tr><td>loop</td><td><code>all</code></td><td>列表循环模式：<code>all</code>, <code>one</code>,<code>none</code></td></tr><tr><td>order</td><td><code>list</code></td><td>列表播放模式： <code>list</code>, <code>random</code></td></tr><tr><td>volume</td><td>0.7</td><td>播放器音量</td></tr><tr><td>lrctype</td><td>0</td><td>歌词格式类型</td></tr><tr><td>listfolded</td><td><code>false</code></td><td>指定音乐播放列表是否折叠</td></tr><tr><td>storagename</td><td><code>metingjs</code></td><td>LocalStorage 中存储播放器设定的键名</td></tr><tr><td>autoplay</td><td><code>true</code></td><td>自动播放，移动端浏览器暂时不支持此功能</td></tr><tr><td>mutex</td><td><code>true</code></td><td>该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停</td></tr><tr><td>listmaxheight</td><td><code>340px</code></td><td>播放列表的最大长度</td></tr><tr><td>preload</td><td><code>auto</code></td><td>音乐文件预载入模式，可选项： <code>none</code>, <code>metadata</code>, <code>auto</code></td></tr><tr><td>theme</td><td><code>#ad7a86</code></td><td>播放器风格色彩设置</td></tr></tbody></table><p>关于如何设置自建的 Meting API 服务器地址，以及其他 MetingJS 配置，请参考章节<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE30-%E6%96%B0%E5%8A%9F%E8%83%BD">自定义配置</a>。</p><p>若在 Hexo 中使用了 PJAX，可能需要自己手动清理 APlayer 全局实例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">&#x27;pjax:start&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.aplayers) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">window</span>.aplayers.length; i++) &#123;</span><br><span class="line">            <span class="built_in">window</span>.aplayers[i].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">window</span>.aplayers = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="（3）自定义配置（3-0-新功能）"><a href="#（3）自定义配置（3-0-新功能）" class="headerlink" title="（3）自定义配置（3.0 新功能）"></a>（3）自定义配置（3.0 新功能）</h4><p>现在你可以在 Hexo 配置文件 <code>_config.yml</code> 中配置本插件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">script_dir:</span> <span class="string">some/place</span>                        <span class="comment"># Public 目录下脚本目录路径，默认: &#x27;assets/js&#x27;</span></span><br><span class="line">  <span class="attr">style_dir:</span> <span class="string">some/place</span>                         <span class="comment"># Public 目录下样式目录路径，默认: &#x27;assets/css&#x27;</span></span><br><span class="line">  <span class="attr">cdn:</span> <span class="string">http://xxx/aplayer.min.js</span>                <span class="comment"># 引用 APlayer.js 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">style_cdn:</span> <span class="string">http://xxx/aplayer.min.css</span>         <span class="comment"># 引用 APlayer.css 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span>                                  <span class="comment"># MetingJS 支持</span></span><br><span class="line">  <span class="attr">meting_api:</span> <span class="string">http://xxx/api.php</span>                <span class="comment"># 自定义 Meting API 地址</span></span><br><span class="line">  <span class="attr">meting_cdn:</span> <span class="string">http://xxx/Meing.min.js</span>           <span class="comment"># 引用 Meting.js 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">true</span>                            <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">externalLink:</span> <span class="string">http://xxx/aplayer.min.js</span>       <span class="comment"># 老版本参数，功能与参数 cdn 相同</span></span><br></pre></td></tr></table></figure><h4 id="（4）故障排除"><a href="#（4）故障排除" class="headerlink" title="（4）故障排除"></a>（4）故障排除</h4><h5 id="1-标签参数空格问题"><a href="#1-标签参数空格问题" class="headerlink" title="1. 标签参数空格问题"></a>1. 标签参数空格问题</h5><p>在 Hexo 标签中，用户可能无法直接在标签参数中<a href="https://github.com/hexojs/hexo/issues/1455">加入空格</a></p><p>如果遇到这类问题，请直接将参数用双引号括起来使用，如下所示：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="meta">%</span> aplayer <span class="string">&quot;Caffeine&quot;</span> <span class="string">&quot;Jeff Williams&quot;</span> <span class="string">&quot;caffeine.mp3&quot;</span> <span class="string">&quot;autoplay&quot;</span> <span class="string">&quot;width:70%&quot;</span> <span class="string">&quot;lrc:caffeine.txt&quot;</span> <span class="meta">%</span>&#125;</span><br></pre></td></tr></table></figure><h5 id="2-重复载入-Aplayer-js-资源脚本问题"><a href="#2-重复载入-Aplayer-js-资源脚本问题" class="headerlink" title="2. 重复载入 Aplayer.js 资源脚本问题"></a>2. 重复载入 Aplayer.js 资源脚本问题</h5><p>本插件通过 <code>after_render:html</code>过滤器 , 将 <code>APlayer.js</code> 和 <code>Meting.js</code> 插入到使用了本插件标签 的 HTML 文件中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/aplayer.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/meting.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是 <code>after_render:html</code> 在一些情形下可能无法被正常触发：</p><ul><li><a href="https://github.com/hexojs/hexo-inject/issues/1">Does not work with hexo-renderer-jade</a></li><li><code>after_render:html</code> 似乎在 Hexo 服务器模式默认配置中无法被调用 (<code>hexo server</code>), 遇到这种情况用户可能需要使用 <code>hexo-server</code> 的静态文件解析模式 ( <code>hexo server -s</code>) .</li></ul><p>如果在博客生成过程中，插件发现 <code>after_render:html</code> 没有被调用，那么插件将会通过 <code>after_post_render</code> 过滤器来植入脚本。但是使用 <code>after_post_render</code> 会有重复载入 <code>APlayer.js</code> 的情况（例如当一个页面中存在多篇博客时），以及一些非文章页面将无法使用本插件。</p><p>如果想完全解决这个问题，用户可能需要自己在主题文件中手动加入 <code>Aplayer.js</code> 与 <code>Meting.js</code>，同时关闭插件的自动脚本插入功能：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 音乐播放器</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="4-10-视频播放器"><a href="#4-10-视频播放器" class="headerlink" title="4.10 视频播放器"></a>4.10 视频播放器</h3><p><a href="https://github.com/NextMoe/hexo-tag-dplayer">hexo-tag-dplayer</a></p><h3 id="4-11-hexo-tag-mmedia"><a href="#4-11-hexo-tag-mmedia" class="headerlink" title="4.11 hexo-tag-mmedia"></a>4.11 hexo-tag-mmedia</h3><p>因APlayer自动引入JS依赖会导致一些全局文件出错，配置关闭后单个页面开启又很麻烦，所以寻找替代工具。</p><p><code>hexo-tag-mmedia</code> 集成了多种音视频播放器，可以参考 <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmedia文档</a> ，目前支持：</p><ul><li><input checked="" disabled="" type="checkbox"> Audio</li><li><input checked="" disabled="" type="checkbox"> Video</li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/APlayer">Aplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/metowolf/MetingJS">MetingJS</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/DPlayer">Dplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.bilibili.com/">哔哩哔哩</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.ixigua.com/">西瓜视频</a></li><li><input disabled="" type="checkbox"> <a href="https://www.npmjs.com/package/hexo-tag-mmedia">YouTube</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/zhw2590582/ArtPlayer">ArtPlayer</a></li></ul><p>效果参考：<a href="http://demo.hexo-tag-mmedia.u2sb.com/">DEMO</a></p><p>安装插件：</p><ol><li><p>删除已安装的几个插件，以防冲突。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall hexo-tag-aplayer</span><br><span class="line">npm uninstall hexo-tag-dplayer</span><br><span class="line">npm uninstall hexo-tag-bilibili</span><br></pre></td></tr></table></figure></li><li><p>安装 <code>hexo-tag-mmedia</code> 。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-mmedia@1 --save</span><br></pre></td></tr></table></figure></li></ol><p>根目录配置文件 <code>/_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default 为默认配置，在 _config.yml 中填写就不需要在每个标签全部写入了，所有允许在 mmedia 标签上写入的配置项，均可在 default 下配置。default 下 contents 项，用于设置 JSON 类型的默认配置，注意要使用 yaml 格式写默认配置。</span></span><br><span class="line"><span class="attr">mmedia:</span></span><br><span class="line">  <span class="attr">audio:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">video:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">aplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js</span></span><br><span class="line">    <span class="attr">css:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">meting:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js</span></span><br><span class="line">    <span class="attr">api:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">dplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dplayer@1/dist/DPlayer.min.js</span></span><br><span class="line">    <span class="attr">hls_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js</span></span><br><span class="line">    <span class="attr">dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js</span></span><br><span class="line">    <span class="attr">shaka_dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.compiled.js</span></span><br><span class="line">    <span class="attr">flv_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js</span></span><br><span class="line">    <span class="attr">webtorrent_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">bilibili:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">page:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">danmaku:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">xigua:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">autoplay:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">startTime:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><h4 id="（1）MarkDown引入"><a href="#（1）MarkDown引入" class="headerlink" title="（1）MarkDown引入"></a>（1）MarkDown引入</h4><p>MarkDown 内可以使用两种标签作为插件，分别是 <code>mmedia</code> 和 <code>mmedias</code> ，使用方式为：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">或</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedias</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><p>只使用 <code>args</code> 作为传参方式时，两种标签均可使用，当需要使用 <code>contents</code> 传参时，只能使用 <code>mmedias</code> 。后面第一个参数用于标记标签，可选（以详细文档为主，持续更新中）：<code>audio</code> <code>video</code> <code>meting</code> <code>aplayer</code> <code>dplayer</code> <code>bilibili</code> <code>xigua</code> 再后面的参数将直接作为 <code>args</code> 参数直接传入插件。</p><h4 id="（2）参数"><a href="#（2）参数" class="headerlink" title="（2）参数"></a>（2）参数</h4><p>传入标签的参数可以写入到三个位置，分别为： <code>_config.yml</code> ， <code>args</code> ， <code>contents</code> ，其中只有部分插件可使用 <code>contents</code> 配置，具体看详细文档，如有冲突项，覆盖规则为（后面的会被前面发覆盖）：<code>contents</code> -&gt; <code>args</code> -&gt; <code>_config.yml</code> -&gt; <code>插件默认</code></p><p>写入到 <code>args</code> 上的参数，有两种写法，分别是使用 <code>:</code> 和 <code>=</code> 分割，两种写法是等效的，在遇到第一个 <code>:</code> 或 <code>=</code> 时会自动分割，例如：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1hb4y1R7xf&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid=BV1hb4y1R7xf&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>两种写法是等效的。</p><p>如果遇到布尔类型的参数，可以简写：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:true&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>两种写法等效，但需要注意， <code>:</code> 或 <code>=</code> 一定不能省略。</p><h4 id="（3）JSON-传参"><a href="#（3）JSON-传参" class="headerlink" title="（3）JSON 传参"></a>（3）JSON 传参</h4><p>支持 JSON 方式传参，其中 JSON 为 <a href="https://json5.org/">JSON5</a> 规范。示例：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedias</span> &quot;aplayer&quot; &quot;autoplay:false&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;</span></span><br><span class="line"><span class="xml">  &quot;volume&quot;: 0.8,</span></span><br><span class="line"><span class="xml">  &quot;audio&quot;:</span></span><br><span class="line"><span class="xml">  [</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url1.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover1.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc1.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#ebd0c2&quot;</span></span><br><span class="line"><span class="xml">    &#125;,</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url2.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover2.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc2.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#46718b&quot;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  ]</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><h4 id="（4）MetingJS"><a href="#（4）MetingJS" class="headerlink" title="（4）MetingJS"></a>（4）MetingJS</h4><p>规则：</p><ul><li>使用 <code>:</code> 或 <code>=</code> 分割。</li><li>所有 <code>&lt;meting-js&gt;</code> 标签的参数均可添加，只要能写进去就可以。</li></ul><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;auto=https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;server=netease&quot;&quot;type=playlist&quot;&quot;id=60198&quot; %&#125;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" server="netease" type="song" id=603259 ></meting-js><h4 id="（5）BiliBili"><a href="#（5）BiliBili" class="headerlink" title="（5）BiliBili"></a>（5）BiliBili</h4><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; &quot;danmaku:false&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>使用 <code>:</code> 或 <code>=</code> 分割，详细参数表：</p><table><thead><tr><th align="left">参数</th><th align="left">默认</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">aid</td><td align="left">-</td><td align="left">aid</td></tr><tr><td align="left">bvid</td><td align="left">-</td><td align="left">bvid，与 aid 同时出现时以 bvid 为准</td></tr><tr><td align="left">page</td><td align="left">1</td><td align="left">page</td></tr><tr><td align="left">danmaku</td><td align="left">true</td><td align="left">是否有弹幕 ture or false</td></tr><tr><td align="left">allowfullscreen</td><td align="left">allowfullscreen</td><td align="left">允许全屏， allowfullscreen 或 true 允许，其他选项不允许</td></tr><tr><td align="left">sandbox</td><td align="left">见 <a href="https://www.u2sb.com/pages/19d343/#%E9%85%8D%E7%BD%AE">配置</a></td><td align="left">iframe sandbox</td></tr><tr><td align="left">width</td><td align="left">100%</td><td align="left">css 属性</td></tr><tr><td align="left">max_width</td><td align="left">850px</td><td align="left">css 属性</td></tr><tr><td align="left">margin</td><td align="left">auto</td><td align="left">css 属性</td></tr></tbody></table><style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-btWErXUqwvOldvmU" src="https://player.bilibili.com/player.html?bvid=BV1AE411a7Nw&page=1&high_quality=1&danmaku=false" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-btWErXUqwvOldvmU").style.height=document.getElementById("mmedia-btWErXUqwvOldvmU").scrollWidth*0.76+"px";    window.onresize = function(){      document.getElementById("mmedia-btWErXUqwvOldvmU").style.height=document.getElementById("mmedia-btWErXUqwvOldvmU").scrollWidth*0.76+"px";    }; </script><h3 id="4-12-添加看板娘（旧版本）"><a href="#4-12-添加看板娘（旧版本）" class="headerlink" title="4.12 添加看板娘（旧版本）"></a>4.12 添加看板娘（旧版本）</h3><ul><li>效果预览： <a href="https://huaji8.top/post/live2d-plugin-2.0/">https://huaji8.top/post/live2d-plugin-2.0/</a></li><li>源代码地址： <a href="https://github.com/EYHN/hexo-helper-live2d">https://github.com/EYHN/hexo-helper-live2d</a></li></ul><p>首先根目录打开命令工具，输入如下代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -save hexo-helper-live2d</span><br></pre></td></tr></table></figure><p>然后打开 <code>Hexo/blog/themes/next/layout</code> 的 <code>_layout.swig</code> ，将下面代码放到 <code>&lt;/body&gt;</code> 之前：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">live2d</span>() &#125;&#125;</span></span><br></pre></td></tr></table></figure><p>然后在根目录配置文件 <code>\_config.yml</code> 中添加参数：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态妹子</span></span><br><span class="line"><span class="attr">live2d:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scriptFrom:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">tagMode:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">model:</span></span><br><span class="line">    <span class="attr">use:</span> <span class="string">live2d-widget-model-shizuku</span></span><br><span class="line">  <span class="attr">display:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">right</span></span><br><span class="line">    <span class="attr">width:</span> <span class="number">150</span></span><br><span class="line">    <span class="attr">height:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">mobile:</span></span><br><span class="line">    <span class="attr">show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果出现下面这个问题:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280214.png"></p><p>首先删除hexo 下面的 <code>.deploy_git</code> 文件夹，然后执行下列代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></table></figure><p>新版本，有点卡卡的，而且没地方放了，不加了：<a href="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a></p><p>Edit <code>source/_data/head.njk</code> in site root directory and add the following content：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Then uncomment <code>head</code> under the <code>custom_file_path</code> section in theme config file.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">head:</span> <span class="string">source/_data/head.njk</span></span><br></pre></td></tr></table></figure><h2 id="五-异常记录"><a href="#五-异常记录" class="headerlink" title="五. 异常记录"></a>五. 异常记录</h2><h3 id="（1）unknown-block-tag-endif"><a href="#（1）unknown-block-tag-endif" class="headerlink" title="（1）unknown block tag: endif"></a>（1）unknown block tag: endif</h3><p>一次更新博客（hexo g）时，出现以下异常：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200401/202004010101.png"></p><p>google了一下，看到有类似问题的是因为在’{‘和’%’之间多写了空格这种语法错误，所以花了一些时间去找项目中的swig文件，因为刚好这次更新也有增加一些博客功能，怀疑是不是修改swig文件时也写错了。(<a href="https://52heartz.top/articles/hexo-template-render-error/" title="title">Hexo 的 Template render error 错误</a> 和 <a href="https://github.com/hexojs/hexo/issues/3346" title="title">hexo 在markdown文档中出现<code>&#123;-% %-&#125;</code>语法会报错，提示“Template render error: (unknown path) </a>)</p><p>但很快便发现没有找到异常，所以思考了一下，既然代码文件中的endif没有问题，会不会是其他地方也写了endif，突然想到这次提交也更新了MD文件，记录我这次更新，其中也直接记录了 <code>\&#123;\% endif \%\&#125;</code>，所以就修改了相关描述。</p><p>重试了一下，问题解决。</p><hr><p>参考：</p><p>🔗 <a href="http://www.wuxubj.cn/2016/08/Hexo-nexT-build-personal-blog/" title="title">Hexo+nexT主题搭建个人博客</a></p><p>🔗 <a href="https://www.jianshu.com/p/5d5931289c09" title="title">nexT主题配置</a></p><p>🔗 <a href="http://theme-next.iissnan.com/theme-settings.html" title="title">nexT官方文档</a></p><p>🔗 <a href="https://segmentfault.com/a/1190000009544924" title="title">自定义配置nexT</a></p><p>🔗 <a href="https://fontawesome.com/icons?from=io" title="title">图标库</a></p><p>🔗 <a href="https://www.techgrow.cn/posts/d1f06120.html" title="title">Hexo 与 Next 版本升级教程</a></p><p>🔗 <a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/" title="title">Hexo NexT 添加友链页面</a></p><p>🔗 <a href="http://yearito.cn/posts/hexo-advanced-settings.html" title="title">Hexo 搭建个人博客系列：进阶设置篇</a></p><p>🔗 <a href="https://www.techgrow.cn/posts/abf4aee1.html" title="title">Hexo Next 8.x 主题添加可切换的暗黑模式</a></p><p>🔗 <a href="https://www.gaficat.com/posts/353df0b0.html" title="title">给你的hexo插入音乐视频</a></p><p>🔗 <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmedia文档</a></p>]]></content>
    
    
    <summary type="html">Hexo升级版本和功能配置，持续更新中。</summary>
    
    
    
    <category term="搭建博客" scheme="http://linyishui.top/categories/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/"/>
    
    
    <category term="hexo" scheme="http://linyishui.top/tags/hexo/"/>
    
    <category term="updating" scheme="http://linyishui.top/tags/updating/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-请求处理和数据存储（未完成）</title>
    <link href="http://linyishui.top/2021062001.html"/>
    <id>http://linyishui.top/2021062001.html</id>
    <published>2021-06-20T14:33:08.000Z</published>
    <updated>2021-07-20T14:55:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="八-请求处理"><a href="#八-请求处理" class="headerlink" title="八. 请求处理"></a>八. 请求处理</h2><h3 id="8-1-会话创建请求"><a href="#8-1-会话创建请求" class="headerlink" title="8.1 会话创建请求"></a>8.1 会话创建请求</h3><p>ZooKeeper服务器对于会话创建的处理，大体分为6大环节：</p><ul><li>请求接收</li><li>会话创建</li><li>预处理</li><li>事务处理</li><li>事务应用</li><li>会话响应</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010153.png"></p><p>其中事务处理部分流程：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010154.png"></p><ul><li><strong>请求接收：</strong><ol><li>I/O层接收来自客户端的请求。</li><li>判断是否是客户端会话创建请求。</li><li>反序列化ConnectRequest请求。</li><li>判断是否是ReadOnly客户端。</li><li>检查客户端ZXID。</li><li>协商sessionTimeout。</li><li>判断是否需要重新创建会话。</li></ol></li><li><strong>会话创建：</strong><ol start="8"><li>为客户端生成sessionID。</li><li>注册会话。</li><li>激活会话。</li><li>生成会话密码。</li></ol></li><li><strong>预处理：</strong><ol start="12"><li>将请求交给ZK的PrepRequestProcessor处理器进行处理。</li><li>创建请求事务头。</li><li>创建请求事务体。</li><li>注册与激活会话。</li></ol></li><li><strong>事务处理：</strong><ol start="16"><li>将请求交给ProposalRequestProcessor处理器。</li></ol></li></ul><h3 id="8-2-SetData请求"><a href="#8-2-SetData请求" class="headerlink" title="8.2 SetData请求"></a>8.2 SetData请求</h3><h3 id="8-3-事务请求转发"><a href="#8-3-事务请求转发" class="headerlink" title="8.3 事务请求转发"></a>8.3 事务请求转发</h3><h3 id="8-4-GetData请求"><a href="#8-4-GetData请求" class="headerlink" title="8.4 GetData请求"></a>8.4 GetData请求</h3><h2 id="九-数据与存储"><a href="#九-数据与存储" class="headerlink" title="九. 数据与存储"></a>九. 数据与存储</h2><h3 id="9-1-内存数据"><a href="#9-1-内存数据" class="headerlink" title="9.1 内存数据"></a>9.1 内存数据</h3><h3 id="9-2-事务日志"><a href="#9-2-事务日志" class="headerlink" title="9.2 事务日志"></a>9.2 事务日志</h3><h3 id="9-3-snapshot—数据快照"><a href="#9-3-snapshot—数据快照" class="headerlink" title="9.3 snapshot—数据快照"></a>9.3 snapshot—数据快照</h3><h3 id="9-4-初始化"><a href="#9-4-初始化" class="headerlink" title="9.4 初始化"></a>9.4 初始化</h3><h3 id="9-5-数据同步"><a href="#9-5-数据同步" class="headerlink" title="9.5 数据同步"></a>9.5 数据同步</h3><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：会话创建、SetData、GetData请求，事务请求转发，内存数据，事务日志，snapshot，初始化，数据同步等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>《社会心理学》读书笔记（一）导论</title>
    <link href="http://linyishui.top/2021061501.html"/>
    <id>http://linyishui.top/2021061501.html</id>
    <published>2021-06-15T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="导论"><a href="#导论" class="headerlink" title="导论"></a>导论</h1><h2 id="一-什么是社会心理学"><a href="#一-什么是社会心理学" class="headerlink" title="一. 什么是社会心理学"></a>一. 什么是社会心理学</h2><blockquote><p>人类是情境中的生物，情境塑造了我们，决定我们未来的诸多可能性，我们便不可独立于它而存在。</p></blockquote><p>社会心理学是一门<strong>研究我们周围情境力量</strong>的科学，尤其是我们<strong>如何看待他人、如何影响他人、又如何互相关联</strong>。、</p><p>我们的社会行为不仅取决于<strong>客观情境</strong>，还取决于我们如何对其进行<strong>主观建构</strong>。</p><h3 id="研究的问题"><a href="#研究的问题" class="headerlink" title="研究的问题"></a>研究的问题</h3><p>社会心理学研究三类问题：</p><ul><li><strong>社会思维：</strong><ul><li>我们如何知觉自我和他人</li><li>我们的信念是什么</li><li>我们所做的判断</li><li>我们的态度</li></ul></li><li><strong>社会影响：</strong><ul><li>文化与生物从众的压力</li><li>说服</li><li>团体</li></ul></li><li><strong>社会关系：</strong><ul><li>偏见</li><li>攻击</li><li>吸引力和亲密关系</li><li>助人</li></ul></li></ul><p>我们的社交生活在多大程度上存在于我们的头脑之中？如果被要求听命行事，你会用残忍的方式行动吗？选择助人还是助己？</p><h3 id="社会心理学的观点"><a href="#社会心理学的观点" class="headerlink" title="社会心理学的观点"></a>社会心理学的观点</h3><ul><li>社会思维：<ol><li><strong>我们构建起社会现实。</strong>人类的通性是想要解释行为，使其归因变得次序井然，具有可预见性，能够被掌握。我们会习惯解释他人的行为，将其“人格”归类。看待自己是乐观或悲观，习惯高人一等还是低人一等？</li><li><strong>我们的社会直觉的力量是强大的，但有时是危险的。</strong>我们的直觉影响我们某些时刻的选择，人的心灵或许是无意识的，一个由直觉所操控的。思维、记忆和态度都是同时在两个水平上运行的，一个有意识和意图，一个无意识和自动，即<strong>双重加工</strong>。我们自己的直觉时常会出错，太过于相信自己的记忆力，错误的解读自己的心理，错误估计自己的未来。大部分场景中，快捷省力的速食型判断方式足以满足需求，但一些需要<strong>准确性</strong>的特殊场景下，我们最好使用<strong>批判性思维</strong>来抑制直觉冲动。</li><li><strong>态度塑造行为。</strong>我们对某些事情的态度会左右相关的行为，态度也同样依附于行为。</li></ol></li><li>社会影响：<ol start="4"><li><strong>社会影响塑造行为。</strong>我们是社会动物，会对周围环境做出反应。有时，某些社会情境具有的影响力会引发我们做出背离自己态度的举动。比如伊拉克战争爆发时，美国和以色列的群众会更倾向于战争，而世界其他国家的群众则反对战争。我们对女性美的定义取决于我们所在的文化环境等等。<strong>环境无时无刻不在影响个人。</strong></li><li><strong>性格倾向塑造行为。</strong>面对同样的情境，不同性格的人会做出不同的选择。<strong>作为社会个体，我们不仅仅是社会的产物，也同样是社会的创造者。</strong>（相互影响）</li></ol></li><li>社会关系：<ol start="6"><li><strong>社会行为同样也是生物性行为。</strong>人类是先天与后天共同作用的生物，遗传得到的天性是我们做出有利于繁衍的行为，我们遗传了这些使得血脉得以延续的基因。进化心理学研究的是自然选择如何影响我们的一些行为与反应。大脑、心灵和行为是如何共同作用成为一个相互协调的工作系统，这是社会认知神经科学关注的问题。</li><li><strong>对他人的感受和做出的行为有时是积极，有时则是消极的。</strong></li></ol></li></ul><h2 id="二-社会心理学与相关学科"><a href="#二-社会心理学与相关学科" class="headerlink" title="二. 社会心理学与相关学科"></a>二. 社会心理学与相关学科</h2><ul><li><p><strong>社会学：</strong>社会学家研究<strong>团体</strong>—从小团体到大团体（社会与其发展趋势）；社会心理学家研究<strong>个体</strong>—个体在某个特定时间对他人的看法，个体之间的相互影响及关系。比如亲密关系的研究中，社会学关系婚姻关系、离婚以及同居比例，社会心理学则关心个体如何被另一个个体吸引。</p></li><li><p><strong>人格心理学：</strong>二者都关注个体，社会心理学更多关注社会因素，人格心理学则关注个体内部功能以及个体间的差异。社会心理学关注个体间的相同点，人格心理学关注个体间的差异点。</p></li></ul><h2 id="三-价值观与事后聪明"><a href="#三-价值观与事后聪明" class="headerlink" title="三. 价值观与事后聪明"></a>三. 价值观与事后聪明</h2><blockquote><p>心理学无法解释人类存在的目的，也无法解释人类生活的意义，以及人类的最终命运。社会心理学只是我们看待自我，了解自我的其中一个视角。</p></blockquote><p>如果大脑没有预先设定你将知觉到某个物体，它便会将其阻隔在你的一视之外。我们对现实的知觉会为我们的预期所左右。<strong>客观现实的确存在，但我们总是透过信念与价值观的眼镜观察它们。</strong></p><p>每个人都难以脱离个人主观的影响，因此社会心理学的概念也会被隐含的价值观渗入。我们生活中也会有这种问题，当别人赞美国家和人民时我们称其为民族主义，当我们这样做时就叫爱国主义。一个卷入婚外情的人是追求婚姻解放还是通奸，取决于我们个人价值观。雄心勃勃的男人与盛气凌人的女人，小心谨慎的男孩子与怯生生的女孩子等。</p><p>社会心理学不是旨在事后分析，而是能够预测。当得知结果后就会觉得显而易见，比如股市震荡或大选落定，大部分评论对此并不感到意外。绝大多数的心理学实验得到结论看起来都像常识，这是因为我们提前知道了结果（事后聪明）。</p><blockquote><p>将一群人分为两组，一组告知其无论交友还是坠入爱河，性格与我们不同的人更有吸引力，俗话说异性相吸；另一组则告知其性格相似的人最有吸引力，俗话说物以类聚、人以群分。</p><p>无论哪种说法，甚至是相反的论点都会让我们觉得很有道理，比如“堕落的人不能帮助另一个堕落的人”与“堕落的人能够帮助另一个堕落的人”这种双重格言。</p></blockquote><h2 id="四-研究方法"><a href="#四-研究方法" class="headerlink" title="四. 研究方法"></a>四. 研究方法</h2><hr><p>参考：</p><p>🔗 《社会心理学》</p>]]></content>
    
    
    <summary type="html">内容来自《社会心理学》。</summary>
    
    
    
    <category term="编程之外" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="心理学" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>《社会心理学》读书笔记</title>
    <link href="http://linyishui.top/2021061401.html"/>
    <id>http://linyishui.top/2021061401.html</id>
    <published>2021-06-14T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:28.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="社会心理学"><a href="#社会心理学" class="headerlink" title="社会心理学"></a>社会心理学</h1><h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一. 前言"></a>一. 前言</h2><p><a href="../2021061501.html" title="Title">《社会心理学》读书笔记（一）导论</a></p><h2 id="二-社会思维"><a href="#二-社会思维" class="headerlink" title="二. 社会思维"></a>二. 社会思维</h2><h2 id="三-社会影响"><a href="#三-社会影响" class="headerlink" title="三. 社会影响"></a>三. 社会影响</h2><h2 id="四-社会关系"><a href="#四-社会关系" class="headerlink" title="四. 社会关系"></a>四. 社会关系</h2><h2 id="五-实际应用"><a href="#五-实际应用" class="headerlink" title="五. 实际应用"></a>五. 实际应用</h2><hr><p>参考：</p><p>🔗 《社会心理学》</p>]]></content>
    
    
    <summary type="html">内容来自《社会心理学》。</summary>
    
    
    
    <category term="编程之外" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="心理学" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-服务器启动流程和Leader选举</title>
    <link href="http://linyishui.top/2021061301.html"/>
    <id>http://linyishui.top/2021061301.html</id>
    <published>2021-06-13T15:29:15.000Z</published>
    <updated>2021-07-20T14:30:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="五-服务器启动"><a href="#五-服务器启动" class="headerlink" title="五. 服务器启动"></a>五. 服务器启动</h2><p>ZooKeeper服务端架构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010134.png"></p><h3 id="5-1-单机版服务器启动"><a href="#5-1-单机版服务器启动" class="headerlink" title="5.1 单机版服务器启动"></a>5.1 单机版服务器启动</h3><p>ZK服务器启动步骤：</p><ol><li>配置文件解析。</li><li>初始化数据管理器。</li><li>初始化网络I/O管理器。</li><li>数据恢复和对外服务。</li></ol><p>单机模式下ZK服务器的启动流程图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010135.png"></p><h4 id="（1）预启动"><a href="#（1）预启动" class="headerlink" title="（1）预启动"></a>（1）预启动</h4><ol><li><p>统一由QuorumPeerMain作为启动类。</p><p>单机/集群模式，在 <code>zkServer.cmd</code> 和 <code>zkServer.sh</code> 两个脚本中都配置了 <code>org.apache.zookeeper.server.quorum.QuorumPeerMain</code> 作为启动入口类。</p></li><li><p>解析配置文件 <code>zoo.cfg</code> 。</p><p>该文件配置了ZK运行时的基本参数，包括tickTime、dataDir和clientPort等参数。</p></li><li><p>创建并启动历史文件清理器 DatadirCleanupManager 。</p><p>ZK从3.4.0版本后增加了自动清理历史数据文件的机制，包括对事务日志和快照数据文件进行定时清理。</p></li><li><p>判断当前是集群模式还是单机模式的启动。</p><p>ZooKeeper根据步骤2解析出的集群服务器地址列表判断当前是单机还是集群模式。单机模式委托给ZooKeeperServerMain进行启动处理。</p></li><li><p>再次进行配置文件 <code>zoo.cfg</code> 的解析。</p></li><li><p>创建服务器实例 ZooKeeperServer 。</p><p><code>org.apache.zookeeper.server.ZooKeeperServer</code> 是单机版服务端最核心的实体类。ZK服务器会首先进行服务器实例的创建，然后对实例进行初始化，包括连接器、内存数据库和请求处理器等组件的初始化。</p></li></ol><h4 id="（2）初始化"><a href="#（2）初始化" class="headerlink" title="（2）初始化"></a>（2）初始化</h4><ol><li><p>创建服务器统计器 ServerStats 。</p><p>ServerStats 是ZK服务器运行时的统计器：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010136.png"></p></li><li><p>创建ZooKeeper数据管理器 FileTxnSnapLog 。</p><p>FileTxnSnapLog 是ZK上层服务器和底层数据存储之间的对接层，提供了一系列操作数据文件的接口，包括事务日志文件和快照数据文件。ZK根据 zoo.cfg 文件中解析出的快照数据目录 dataDir 和事务日志目录 dataLogDir 来创建 FileTxnSnapLog 。</p></li><li><p>设置服务器tickTime和会话超时时间限制。</p></li><li><p>创建ServerCnxnFactory。</p><p>3.4.0版本引入Netty代替自实现的NIO框架，通过配置系统属性 <code>zookeeper.serverCnxnFactory</code> 来选择所使用的服务端网络连接工厂。</p></li><li><p>初始化ServerCnxnFactory。</p><p>首先初始化一个Thread来作为ServerCnxnFactory的主线程，然后再初始化NIO服务器。</p></li><li><p>启动ServerCnxnFactory主线程。</p><p>启动步骤5已经初始化的主线程ServerCnxnFactory的run方法，虽然此时NIO服务器已对外开放端口，客户端能够访问2181，但服务器实际无法处理客户端请求。</p></li><li><p>恢复本地数据。</p><p>每次在ZK启动的时候，都需要从本地快照数据文件和事务日志文件中进行数据恢复。</p></li><li><p>创建并启动会话管理器。</p><p>会话管理器 SessionTracker 负责服务端的会话管理，创建SessionTracker的时候，会初始化 expirationInterval、nextExpirationTime 和 sessionWithTimeout（用于保存每个会话的超时时间），同时还会计算出一个初始化的 sessionID 。</p><p>SessionTracker初始化完毕，ZK就会立即开始会话管理器的会话超时检查。</p></li><li><p>初始化ZooKeeper的请求处理链。</p><p>ZK的请求处理方式是典型的责任链模式的实现，在服务器上会有多个请求处理器一次来处理一个客户端请求。服务器启动时将这些请求处理器串联起来形成一个请求处理链。单机版包括 PrepRequestProcessor、SyncRequestProcessor 和 FinalRequestProcessor 三个请求处理器</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010137.png"></p></li><li><p>注册JMX服务。</p><p>ZK将服务器运行时的一些信息以JMX的方式暴露给外部。</p></li><li><p>注册ZooKeeper服务器实例。</p><p>此前端口开放但不能处理客户端请求，因为网络层尚未能访问ZK实例。经过后续步骤后，ZK服务器已初始化完毕，只需注册给ServerCnxnFactory就可以对外提供正常的服务。</p></li></ol><h3 id="5-2-集群版服务器启动"><a href="#5-2-集群版服务器启动" class="headerlink" title="5.2 集群版服务器启动"></a>5.2 集群版服务器启动</h3><p>集群模式下ZK服务器的启动流程图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010138.png"></p><h4 id="（1）预启动-1"><a href="#（1）预启动-1" class="headerlink" title="（1）预启动"></a>（1）预启动</h4><ol><li><p>统一由QuorumPeerMain作为启动类。</p></li><li><p>解析配置文件 <code>zoo.cfg</code> 。</p></li><li><p>创建并启动历史文件清理器 DatadirCleanupManager 。</p></li><li><p>判断当前是集群模式还是单机模式的启动。</p><p>ZooKeeper根据步骤2解析出的集群服务器地址列表判断当前是单机还是集群模式。</p></li></ol><h4 id="（2）初始化-1"><a href="#（2）初始化-1" class="headerlink" title="（2）初始化"></a>（2）初始化</h4><ol><li><p>创建ServerCnxnFactory。</p></li><li><p>初始化ServerCnxnFactory。</p></li><li><p>创建ZooKeeper数据管理器 FileTxnSnapLog 。</p></li><li><p>创建QuorumPeer实例。</p><p>QuorumPeer是集群模式特有的对象，是ZK服务器实例的托管者，从集群层面看，QuorumPeer代表了ZK集群中一台机器。运行期间，QuorumPeer 会不断检测当前服务器实例的运行状态，同时根据情况发起Leader选举。</p></li><li><p>创建内存数据库ZKDatabase。</p><p>负责管理ZooKeeper的所有会话记录以及DataTree和事务日志的存储。</p></li><li><p>初始化QuorumPeer。</p><p>一些核心组件注册到QuorumPeer中去，包括FileTxnSnapLog、ServerCnxnFactory 和 ZKDatabase 。同时ZK还会对QuorumPeer配置一些参数，包括服务器地址列表、Leader 选举算法和会话超时时间限制。</p></li><li><p>恢复本地数据。</p></li><li><p>启动ServerCnxnFactory主线程。</p></li></ol><h4 id="（3）Leader选举"><a href="#（3）Leader选举" class="headerlink" title="（3）Leader选举"></a>（3）Leader选举</h4><p>步骤：</p><ol><li><p><strong>初始化Leader选举。</strong></p><p>ZK根据自身的SID（服务器ID）、lastLoggedZxid（最新ZXID）和当前服务器epoch（currentEpoch）来生成一个初始化的投票，每个服务器都投自己。</p><p>然后ZK根据 <code>zoo.cfg</code> 的配置，创建对应的Leader选举算法实现。默认可选三种实现，使用 <code>electionAlg</code> 属性0~3指定：</p><ul><li><strong>LeaderElection：</strong>3.4.0版本废弃。</li><li><strong>AuthFastLeaderElection：</strong>3.4.0版本废弃。</li><li><strong>FastLeaderElection：</strong>当前唯一选择。</li></ul><p>初始化阶段，ZK首先创建Leader选举所需的网络I/O层QuorumCnxManager，同时启动对Leader选举端口的监听，等待集群中其他服务器创建连接。</p></li><li><p><strong>注册JMX服务。</strong></p></li><li><p><strong>检测当前服务器状态。</strong></p><p>QuorumPeer是ZK服务器实例的托管者，其核心不断的检查当前服务器的状态并做出处理。正常情况下，ZK服务器状态在 LOOKING、LEADING和FOLLOWING/OBSERVING 之间切换。<strong>启动阶段，QuorumPeer的初始状态为LOOKING，此时进行Leader选举。</strong></p></li><li><p><strong>Leader选举。</strong></p><p>一个集群中所有的机器相互之间进行一系列投票，选举最合适的机器成为Leader，其余则是Follower或Observer。<strong>集群中哪个机器处理的数据最新（根据服务器处理过的最大ZXID来比较新旧）就越有可能成为Leader</strong>。当所有服务器处理的ZXID一致，SID最大的会成为Leader。</p></li></ol><h4 id="（4）Leader和Follow启动期交互过程"><a href="#（4）Leader和Follow启动期交互过程" class="headerlink" title="（4）Leader和Follow启动期交互过程"></a>（4）Leader和Follow启动期交互过程</h4><p>Leader和Follower启动期交互过程步骤：</p><ol><li><p><strong>创建Leader服务器和Follower服务器。</strong></p><p>完成Leader选举后，每个服务器都会根据自己的角色创建对应的服务器实例，开始自己的主流程。</p></li><li><p><strong>Leader服务器启动Follower接收器LearnerCnxAcceptor。</strong></p><p>ZK集群运行期间，Leader服务器需要和其余服务器（Learner服务器）保持连接来确定其存活情况。LearnerCnxAcceptor负责接收所有非Leader服务器的连接请求。</p></li><li><p><strong>Learner服务器开始和Leader建立连接。</strong></p><p>所有Learner服务器启动完毕后，从投票结果得到Leader服务器信息，并与其建立连接。</p></li><li><p><strong>Leader服务器创建LearnerHandler。</strong></p><p>Leader接收到连接创建请求后，创建一个对应的LearnerHandler实例表示二者间的连接，并负责所有的消息通信和数据同步。</p></li><li><p><strong>向Leader注册。</strong></p><p>建立好连接后，Learner向Leader注册，发送自己的LearnerInfo，包括服务器SID和处理的最新ZXID。</p></li><li><p><strong>Leader解析Learner信息，计算新的epoch。</strong></p><p>Leader根据解析出的SID和ZXID，获取对应的 <code>epoch_of_learner</code> ，与当前服务器的 <code>epoch_of_leader</code> 进行比较，如果Learner更大的话就更新Leader的epoch：<code>epoch_of_leader = epoch_of_learner + 1</code> 。</p><p>然后LearnerHandler会进行等待，等到过半的Learner已经向Leader进行了注册，同时更新了 <code>epoch_of_leader</code> 之后，Leader就可以确定当前集群的epoch了。</p></li><li><p><strong>发送Leader状态。</strong></p><p>计算出新的epoch后，Leader会将其以一个LEADERINFO消息的形式发送给Learner，同时等待其响应。</p></li><li><p><strong>Learner发送ACK信息。</strong></p><p>Follower收到LEADERINFO消息后，解析出epoch和ZXID，并向Leader反馈一个ACKEPOCH响应。</p></li><li><p><strong>数据同步。</strong></p><p>Leader服务器接收到ACK后，开始与其进行数据同步。</p></li><li><p><strong>启动Leader和Learner服务器。</strong></p><p>当过半的Learner已经完成了数据同步，Leader和Learner服务器的实例可以开始启动了。</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010139.png"></p><p>Leader和Follower启动的步骤：</p><ol><li>创建并启动会话管理器。</li><li>初始化ZK的请求处理链。</li><li>注册JMX服务。</li></ol><h2 id="六-Leader选举"><a href="#六-Leader选举" class="headerlink" title="六. Leader选举"></a>六. Leader选举</h2><h3 id="6-1-概述"><a href="#6-1-概述" class="headerlink" title="6.1 概述"></a>6.1 概述</h3><p>Leader选举是保证分布式数据一致性的关键所在。</p><h4 id="（1）服务器启动时期的Leader选举"><a href="#（1）服务器启动时期的Leader选举" class="headerlink" title="（1）服务器启动时期的Leader选举"></a>（1）服务器启动时期的Leader选举</h4><p>假设集群有三台机器，集群初始化阶段只有一台机器启动时还不能进行Leader选举，只有当第二台机器启动并能互相通信时，才能进入选举流程：</p><ol><li><p><strong>每个Server会发出一个投票。</strong></p><p>每台机器都投自己，每次投票包含最基本元素：所推举的服务器的myid和ZXID。</p><p>所以结果是两个投票(1, 0)和(2, 0)分别发送给集群的其他机器。</p></li><li><p><strong>接收来自各个服务器的投票。</strong></p><p>每个服务器收到投票后，先判断投票的有效性，包括检查是否为本轮投票、是否来自LOOKING状态的服务器。</p></li><li><p><strong>处理投票。</strong></p><p>每一个投票，服务器都要将其与自己的投票进行PK，规则：</p><ul><li>优先检查ZXID，较大的服务器优先作为Leader。</li><li>ZXID相同时比较myid，较大的服务器优先作为Leader。</li></ul><p>所以步骤1的两个投票中后者myid较大，服务器1将自己的投票更新为(2, 0)，服务器2则重复再发一次投票信息。</p></li><li><p><strong>统计投票。</strong></p><p>每次投票后，服务器都会统计所有投票，判断是否已有过半的机器收到相同的投票信息。</p></li><li><p><strong>改变服务器状态。</strong></p><p>一旦确定了Leader，每个服务器都会更新自己的状态，Follower更新为FOLLOWING，Leader更新为LEADING。</p></li></ol><h4 id="（2）服务器运行期间的Leader选举"><a href="#（2）服务器运行期间的Leader选举" class="headerlink" title="（2）服务器运行期间的Leader选举"></a>（2）服务器运行期间的Leader选举</h4><p>当Leader所在服务器挂掉，会进入新一轮的Leader选举：</p><ol><li><p><strong>变更状态。</strong></p><p>Leader挂了，所有非Observer服务器将自己状态更新为LOOKING。</p></li><li><p><strong>每个Server会发出一个投票。</strong></p><p>生成投票信息(myid, ZXID)，此时服务器1和3产生投票(1, 123)和(3, 122)，发送给各个机器。</p></li><li><p><strong>接收来自各个服务器的投票。</strong></p></li><li><p><strong>处理投票。</strong></p><p>和启动阶段规则一致，服务器1会被选为Leader。</p></li><li><p><strong>统计投票。</strong></p></li><li><p><strong>改变服务器状态。</strong></p></li></ol><h3 id="6-2-算法分析"><a href="#6-2-算法分析" class="headerlink" title="6.2 算法分析"></a>6.2 算法分析</h3><p>ZK提供了三种选举算法，在 <code>zoo.cfg</code> 的配置中使用 <code>electionAlg</code> 属性指定：</p><ul><li><strong>LeaderElection：</strong>数字0，纯UDP实现。</li><li><strong>AuthFastLeaderElection：</strong>数字2，UDP版本，授权模式。</li><li><strong>FastLeaderElection：</strong>数字1表示UDP版本，非授权模式；数字3表示，TCP版本，当前唯一选择。</li></ul><h4 id="（1）术语"><a href="#（1）术语" class="headerlink" title="（1）术语"></a>（1）术语</h4><ul><li><strong>SID（服务器ID）：</strong>唯一标识一台机器，与myid的值一致。</li><li><strong>ZXID（事务ID）：</strong>唯一标识一次服务器状态的变更，集群中每台机器的不一定一致。</li><li><strong>Vote（投票）：</strong>当机器发现自己无法检测到Leader时，就会尝试开始Leader选举。</li><li><strong>Quorum（过半机器数）：</strong>集群中机器数为n，则 <code>quorum = (n / 2 + 1)</code> 。</li></ul><h4 id="（2）何时进入Leader选举"><a href="#（2）何时进入Leader选举" class="headerlink" title="（2）何时进入Leader选举"></a>（2）何时进入Leader选举</h4><p>当某台机器出现任一情况：</p><ul><li>服务器初始化启动。</li><li>服务器运行期间无法和Leader保持连接。</li></ul><p>当一台机器进入选举流程时，集群可能处于两种状态之一：</p><ul><li><p>集群本身存在一个Leader。</p><p>可能因为某台机器启动较晚，此时选举流程已结束，所以当其尝试选举Leader时会被告知当前Leader服务器的信息。机器仅需和Leader建立连接并同步状态即可。</p></li><li><p>集群确实已不存在Leader。</p></li></ul><h4 id="（3）开始第一次投票"><a href="#（3）开始第一次投票" class="headerlink" title="（3）开始第一次投票"></a>（3）开始第一次投票</h4><p>导致集群中不存在Leader：</p><ul><li>服务器刚初始化启动，尚未产生一台Leader服务器。</li><li>运行期间Leader服务器挂掉。</li></ul><p>此时集群所有机器都处于LOOKING状态，尝试寻找Leader。当一台机器处于此状态，会向集群其它机器发送投票消息(SID, ZXID)。</p><p>首次投票所有机器都会选举自己。</p><h4 id="（4）变更投票"><a href="#（4）变更投票" class="headerlink" title="（4）变更投票"></a>（4）变更投票</h4><p>每台机器发送完自己的投票，也会接收到其它机器的投票。根据投票规则判断是否需要变更自己的投票。</p><p>术语：</p><ul><li><strong>vote_sid：</strong>接收到的投票中的服务器SID。</li><li><strong>vote_zxid：</strong>接收到的投票中的服务器ZXID。</li><li><strong>self_sid：</strong>服务器自己的SID。</li><li><strong>self_zxid：</strong>服务器自己的ZXID。</li></ul><p>规则：</p><ol><li>如果vote_zxid大于self_zxid，认可当前收到的投票，再次将其发送出去代表自己新一轮的投票。</li><li>如果vote_zxid小于self_zxid，坚持自己的投票，不做任何变更。</li><li>如果vote_zxid等于self_zxid，对比二者的SID，如果vote_sid大于self_sid，认可当前收到的投票，再次将其发送出去代表自己新一轮的投票。</li><li>如果vote_zxid等于self_zxid，且vote_sid小于self_sid，坚持自己的投票，不做任何变更。</li></ol><p>假设集群有5台机器，SID为(1,2,3,4,5)，ZXID为(9,9,9,8,8)，此时SID为2的机器为Leader，且1和2同时挂掉，由此开始Leader选举：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010140.png"></p><h4 id="（5）确定Leader"><a href="#（5）确定Leader" class="headerlink" title="（5）确定Leader"></a>（5）确定Leader</h4><p>经过第二次投票后，集群中每台机器都会再次收到其他机器的投票，并进行统计，当一台机器收到了超过半数相同的投票，其就称为新的Leader。</p><p>上述案例中quorum为3，只要收到3个即可。</p><h3 id="6-3-实现细节"><a href="#6-3-实现细节" class="headerlink" title="6.3 实现细节"></a>6.3 实现细节</h3><p>上述FastLeaderElection选举算法并不复杂，但实际实现有很多问题需要解决。</p><h4 id="（1）服务器状态"><a href="#（1）服务器状态" class="headerlink" title="（1）服务器状态"></a>（1）服务器状态</h4><p><code>org.apache.zookeeper.server.quorum.QuorumPeer.ServerState</code> 类中列举了4种服务器状态：</p><ul><li><strong>LOOKING：</strong>寻找Leader状态，服务器在此状态时会认为集群没有Leader，需要进入Leader选举流程。</li><li><strong>FOLLOWING：</strong>跟随者状态，表示当前机器为Follower。</li><li><strong>LEADING：</strong>领导者状态，表示当前机器为Leader。</li><li><strong>OBSERVING：</strong>观察者状态，表示当前机器为Observer。</li></ul><h4 id="（2）投票的数据结构"><a href="#（2）投票的数据结构" class="headerlink" title="（2）投票的数据结构"></a>（2）投票的数据结构</h4><p><code>org.apache.zookeeper.server.quorum.Vote</code> 类的数据结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010142.png"></p><h4 id="（3）QuorumCnxManager-网络I-O管理者"><a href="#（3）QuorumCnxManager-网络I-O管理者" class="headerlink" title="（3）QuorumCnxManager-网络I/O管理者"></a>（3）QuorumCnxManager-网络I/O管理者</h4><p>ClientCnxn是ZK客户端中用于处理网络I/O的管理器，Leader选举中类似角色就是QuorumCnxManager，负责各台服务器之间的底层Leader选举过程中的网络通信。</p><p>其内部维护了一系列的队列，用来保存接收到的、待发送的消息，以及消息的发送器。每个队列都按SID分组形成队列集合，保证每台服务器之间互不干扰。</p><ul><li><strong>recvQueue：</strong>消息接收队列，存放从其他服务器接收到的消息。</li><li><strong>queueSendMap：</strong>消息发送队列，存放待发送的消息。该Map按SID进行分组，为集群中每台机器分配一个单独的队列，保证机器之间的消息互不影响。</li><li><strong>senderWorkerMap：</strong>发送器集合，每个SendWorker消息发送器，都对应一台远程ZooKeeper服务器，负责消息的发送。也按SID进行了分组。</li><li><strong>lastMessageSent：</strong>最近发送过的消息，为每个SID保留最近发送过的一个消息。</li></ul><p>ZK中所有机器都要两两创建网络连接，所以QuorumCnxManager启动时会创建一个<strong>ServerSocket</strong>监听Leader选举的通信端口（默认3888），服务器会不断接收到其它服务器的创建连接请求。这类TCP连接请求会<strong>交由receiveConnection方法进行处理</strong>。</p><p>为了避免两条机器重复创建TCP连接，ZK设计了规则：<strong>只允许SID大的服务器主动和其他服务器建立连接，否则断开连接</strong>。所以receiveConnection方法中会比对自己和远程服务器的SID值，当自己更大时断开连接并主动发送连接请求，否则接受连接请求。</p><p>一旦连接建立，就会根据远程服务器的SID创建对应的消息发送器SendWorker和接收器RecvWorker并启动。</p><ul><li><strong>消息接收：</strong>RecvWorker从对应TCP连接收到消息，将其放到recvQueue中。</li><li><strong>消息发送：</strong>SendWorker不断从queueSendMap对应消息队列取出一个消息发送，同时将其放入lastMessageSent记录。（注意：<strong>当消息发送队列为空时，会从lastMessageSent取出一个最近发送的消息再次发送，主要为了解决分布式问题：接收方在消息接收前或接收到消息后挂掉，导致消息还未被正确处理。当然ZK也保证了接收方对重复消息进行了正确的处理</strong>）</li></ul><h4 id="（4）FastLeaderElection核心"><a href="#（4）FastLeaderElection核心" class="headerlink" title="（4）FastLeaderElection核心"></a>（4）FastLeaderElection核心</h4><p>术语：</p><ul><li><strong>外部投票：</strong>其他服务器发来的投票。</li><li><strong>内部投票：</strong>服务器自身当前的投票。</li><li><strong>选举轮次：</strong>Leader选举的轮次，即logicalClock。</li><li><strong>PK：</strong>指对内部和外部投票进行对比，来确认是否需要变更内部投票。</li></ul><p>选票管理：</p><ul><li><strong>sendqueue：</strong>选票发送队列，保存待发送的选票。</li><li><strong>recvqueue：</strong>选票接收队列，保存接收到的外部投票。</li><li><strong>WorkerReceiver：</strong>选票接收器，不断从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换为一个选票，并保存到recvqueue。<ul><li>在选票接收过程中，如果发现其选举轮次小于当前服务器就直接忽略，并立即发送内部投票。</li><li>当前服务器不是LOOKING状态，表示已选出Leader，同样直接忽略，并立即发送内部投票。</li><li>接收到的消息来自于Observer，同样直接忽略，并立即发送内部投票。</li></ul></li><li><strong>WorkerSender：</strong>选票发送器，不断从sendqueue获取选票并将其传递给底层QuorumCnxManager。</li></ul><p>选票管理与QuorumCnxManager在Leader选举中的关系：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010143.png"></p><p>Leader选举算法整体流程：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010144.png"></p><p>上述其实是 lookForLeader方法的内部逻辑：</p><ol><li><p><strong>自增选举轮次。</strong></p><p>FastLeaderElection的实现中有一个属性logicalclock，用于标识当前Leader的选举轮次，开始新一轮投票时会先将其自增。</p></li><li><p><strong>初始化选票。</strong></p><p>开始新一轮投票前，每台服务器要先初始化自己的选票，也就是初始化Vote的各个属性。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010145.png"></p></li><li><p><strong>发送初始化选票。</strong></p><p>完成选票的初始化后，就会发起第一次投票。选票被放入sendqueue中，由WorkerSender负责发送出去。</p></li><li><p><strong>接收外部投票。</strong></p><p>每台服务器会不断从recvqueue中获取外部投票，当服务器发现自己无法获取任何外部投票，会立刻确认自己是否和集群其它服务器保持连接。若没有就立即建立连接，如已有则再次发送自己的内部投票。</p></li><li><p><strong>判断选举轮次。</strong></p><p>发送完初始化选票，就要处理外部投票。需要根据选举轮次的不同进行不同的处理：</p><ul><li><strong>外部投票的轮次大于内部投票：</strong>立即更新自己的选举轮次，并清空所有已经收到的投票，然后使用初始化投票进行PK来确定是否变更内部投票，最终再将投票发送出去。</li><li><strong>外部投票的轮次小于内部投票：</strong>直接忽略该投票，返回步骤4。</li><li><strong>外部投票的轮次等于内部投票：</strong>进行选票PK。</li></ul></li><li><p><strong>选票PK。</strong></p><p>即 <code>FastLeaderElection.totalOrderPredicate</code> 方法的核心逻辑。主要从选举轮次、ZXID和SID三个因素考虑：</p><ul><li>如果外部投票中被推举的Leader服务器的选举轮次大于内部投票，需要进行投票变更。</li><li>选举轮次一致，则对比ZXID，如果外部投票较大就需要进行投票变更。</li><li>ZXID一致，则对比SID，如果外部投票较大就需要进行投票变更。</li></ul></li><li><p><strong>变更投票。</strong></p><p>选票PK后确定如果需要进行投票变更，要将外部投票的选票信息覆盖内部投票。变更完成后再将其发送出去。</p></li><li><p><strong>选票归档。</strong></p><p>无论是否进行了投票变更，都要将收到的外部投票放入recvset中进行归档。其用于记录当前服务器在本轮次收到的所有外部投票，并会按SID进行区分，如 <code>&#123;(1, vote1),(2, vote2),...&#125;</code> 。</p></li><li><p><strong>统计投票。</strong></p><p>完成选票归档后，可以开始投票的统计。一旦统计出有过半服务器认可了当前内部投票，就终止投票，否则返回步骤4。</p></li><li><p><strong>更新服务器状态。</strong></p><p>当统计投票确定可以终止投票，开始更新服务器状态。如果判断过半服务器认可，就会更新为LEADING。否则根据具体情况更新为FOLLOWING或OBSERVING。步骤9到步骤10可能会有一段时间延迟来确认是否有新的更优的投票（默认200毫秒）。</p></li></ol><h2 id="七-各服务器角色介绍"><a href="#七-各服务器角色介绍" class="headerlink" title="七. 各服务器角色介绍"></a>七. 各服务器角色介绍</h2><h3 id="7-1-Leader"><a href="#7-1-Leader" class="headerlink" title="7.1 Leader"></a>7.1 Leader</h3><p>Leader的主要工作：</p><ul><li>事务请求的唯一调度和处理者，保证集群事务处理的顺序性。</li><li>集群内部各服务器的调度者。</li></ul><p>ZK使用<strong>责任链模式</strong>处理每个客户端请求，请求处理链：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010146.png"></p><blockquote><p>事务请求：指会改变服务器状态的一系列请求，如创建节点、更新数据、删除节点以及创建会话等。</p></blockquote><ul><li><p><strong>PrepRequestProcessor：</strong>请求预处理器，是第一个请求处理器。其能识别出当前客户端请求是否为事务请求。如果是则进行一系列预处理，如创建请求事务头、事务体、会话检查、ACL检查和版本检查等。</p></li><li><p><strong>ProposalRequestProcessor：</strong>事务投票处理器，Leader服务器事务处理流程的发起者。</p><ul><li>其会将非事务请求流转到CommitProcessor，不再做其他处理；</li><li>事务请求除了交给CommitProcessor外，还会根据请求类型创建对应的Proposal提议，并发送给所有的Follower服务器从而发起一次集群内事务投票。</li><li>同时还会将事务请求交付给SyncRequestProcessor进行事务日志的记录。</li></ul></li><li><p><strong>SyncRequestProcessor：</strong>事务日志记录处理器，主要用来将事务请求记录到事务日志文件中，同时触发ZK进行数据快照。</p></li><li><p><strong>AckRequestProcessor：</strong>负责在SyncRequestProcessor处理器完成事务日志记录后，向Proposal的投票收集器发送ACK反馈，以通知投票收集器当前服务器已经完成了对该Proposal的事务日志记录。</p></li><li><p><strong>CommitProcessor：</strong> 事务提交处理器，使服务器都可以控制对事务请求的顺序处理。</p><ul><li>非事务请求，该处理器会直接将其交付给下一级处理器；</li><li>事务请求，其会等待集群内针对Proposal的投票直到其可被提交。</li></ul></li><li><p><strong>ToBeCommitProcessor：</strong>特殊的处理器，有一个toBeApplied队列，专门用来存储已被CommitProcessor处理过的可被提交的Proposal。</p><p>将这些请求逐个交付给FinalRequestProcessor进行处理，待其处理完毕后再从toBeApplied中移除。</p></li><li><p><strong>FinalRequestProcessor：</strong>最后一个请求处理器，主要用来进行客户端请求返回之前的收尾工作，包括创建客户端请求的响应；针对事务请求，该处理器还会负责将事务应用到内存数据库中。</p></li></ul><p>Leader服务器会与所有其他服务器创建一个TCP长连接，同时为每个服务器创建一个名为LearnerHandler的实体，是ZK集群中Learner服务器的管理器，负责Learner服务器与Leader服务器之间的一系列网络通信，包括数据同步、请求转发和Proposal提议的投票等。</p><h3 id="7-2-Follower"><a href="#7-2-Follower" class="headerlink" title="7.2 Follower"></a>7.2 Follower</h3><p>主要工作：</p><ul><li>处理客户端非事务请求，转发事务请求给Leader服务器。</li><li>参与事务请求Proposal的投票。</li><li>参与Leader选举投票。</li></ul><p>Follower也采用责任链模式组装的请求处理链来处理每一个客户端请求，但不需要负责事务请求的投票处理。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010147.png"></p><p>与Leader服务器有差异的两个处理器：</p><ul><li><strong>FollowerRequestProcessor：</strong>第一个请求处理器，主要工作是识别当前请求是否是事务请求。事务请求会将其转发给Leader服务器。</li><li><strong>SendAckRequestProcessor：</strong>同样负责事务日志记录反馈的角色，完成日志记录后，会向Leader服务器发送ACK消息表示自己完成了事务日志的记录工作。与AckRequestProcessor的唯一区别是，后者与Leader服务器在同台服务器，因此其ACK反馈仅仅是一个本地操作；前者位于Follower服务器上，通过ACK消息的形式来向Leader服务器进行反馈。</li></ul><h3 id="7-3-Observer"><a href="#7-3-Observer" class="headerlink" title="7.3 Observer"></a>7.3 Observer</h3><p>主要工作：</p><ul><li>观察ZK集群的最新状态变化并将状态变更同步过来。</li><li>与Follower一样，处理非事务请求，事务请求则转交给Leader服务器。但Observer不参与任何投票，包括事务请求Proposal的投票和Leader选举投票。</li><li>只提供非事务服务，通常用于不影响集群事务处理能力的前提下提升集群的非事务处理能力。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010148.png"></p><p>虽然组装了SyncRequestProcessor处理器，但Leader服务器不会将事务请求的投票转发给Observer。</p><h3 id="7-4-集群间消息通信"><a href="#7-4-集群间消息通信" class="headerlink" title="7.4 集群间消息通信"></a>7.4 集群间消息通信</h3><p>ZK的消息类型可以分为四类：</p><ul><li>数据同步型</li><li>服务器初始化型</li><li>请求处理型</li><li>会话管理型</li></ul><h4 id="（1）数据同步型"><a href="#（1）数据同步型" class="headerlink" title="（1）数据同步型"></a>（1）数据同步型</h4><p>数据同步型消息是指在Learner和Leader服务器进行数据同步时，网络通信所用到的消息。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010149.png"></p><h4 id="（2）服务器初始化型"><a href="#（2）服务器初始化型" class="headerlink" title="（2）服务器初始化型"></a>（2）服务器初始化型</h4><p>服务器初始化型消息是指整个集群或是某些新机器初始化的时候，Learner和Leader服务器之间相互通信所使用的消息类型。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010150.png"></p><h4 id="（3）请求处理型"><a href="#（3）请求处理型" class="headerlink" title="（3）请求处理型"></a>（3）请求处理型</h4><p>请求处理型消息是在请求处理的过程中，Learner和Leader服务器之间相互通信所使用的消息类型。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010151.png"></p><h4 id="（4）会话管理型"><a href="#（4）会话管理型" class="headerlink" title="（4）会话管理型"></a>（4）会话管理型</h4><p>会话管理型消息是ZK进行会话管理过程中，与Learner服务器之间进行通信使用的消息。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010152.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：单机版和集群版服务器的启动流程，Leader选举算法分析和具体实现细节，Leader、Follower、Observer等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-会话</title>
    <link href="http://linyishui.top/2021061201.html"/>
    <id>http://linyishui.top/2021061201.html</id>
    <published>2021-06-12T10:24:16.000Z</published>
    <updated>2021-07-18T15:35:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="四-会话"><a href="#四-会话" class="headerlink" title="四. 会话"></a>四. 会话</h2><p>临时节点的生命周期、客户端请求顺序执行以及Watcher通知机制等都和会话息息相关。</p><h3 id="4-1-会话状态"><a href="#4-1-会话状态" class="headerlink" title="4.1 会话状态"></a>4.1 会话状态</h3><p>客户端与服务端完成连接的创建后，就建立了一个会话。会话的生命周期中会有多种状态：</p><ul><li><strong>CONNECTING：</strong>客户端开始创建ZK对象时进入此状态，同时从服务器地址列表逐个选取IP地址来尝试进行网络连接。</li><li><strong>CONNECTED：</strong>当成功连接上服务器时更新为此状态。</li><li>RECONNECTING/CONNECTING：网络问题等会使连接断开，ZK客户端会自动进行重连操作。</li><li>RECONNECTED/CONNECTED：运行期间，客户端状态总是会介于CONNECTING与CONNECTED之间。</li><li><strong>CLOSE：</strong>会话超时、权限检查失败或客户端主动退出。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010130.png"></p><h3 id="4-2-会话创建"><a href="#4-2-会话创建" class="headerlink" title="4.2 会话创建"></a>4.2 会话创建</h3><p>Session基本属性：</p><ul><li><strong>sessionID：</strong>会话ID，全局唯一标识一个会话。</li><li><strong>TimeOut</strong>：会话超时时间，客户端向服务端发送此超时时间，服务器根据自己超时时间限制最终确定会话的超时时间。</li><li><strong>TickTime：</strong>下次会话超时时间点，便于ZK对会话进行“分桶策略”管理，也为了高效低耗的实现会话的超时检查和清理。13位的long型数据，接近于当时间加上TimeOut。</li><li><strong>isClosing：</strong>标记会话是否已经关闭，确保服务端不再处理来自该会话的请求。</li></ul><p>生成SessionID，高8位确定了所在机器，后56位为当前时间来进行随机：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">initializeNextSession</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> nextSid = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">// 获取当前毫秒格式时间，左移24位，低24位用0补齐，再右移8位，高8位用0补齐</span></span><br><span class="line">       <span class="comment">// 左移24位将高位的1移出避免了负数出现（特殊的时间节点如2022年0408日仍会得到负数），所以3.4.6版本修复为 &gt;&gt;&gt; 8</span></span><br><span class="line">       nextSid = (System.currentTimeMillis() &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">       <span class="comment">// 再添加机器标识，当前ZK服务器的SID值，左移56位</span></span><br><span class="line">       <span class="comment">// 将两者|操作得到一个单机唯一的序列号</span></span><br><span class="line">       nextSid = nextSid | (id &lt;&lt; <span class="number">56</span>);</span><br><span class="line">       <span class="keyword">return</span> nextSid;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>SessionTracker是会话的管理器，负责会话创建、管理和清理等工作，每个会话在其中都保留3份：</p><ul><li><strong>sessionsById</strong>：根据sessionID来管理session实体，<code>HashMap&lt;Long, SessionImpl&gt;</code> 数据结构。</li><li><strong>sessionsWithTimeout</strong>：根据sessionID来管理session超时时间，<code>HashMap&lt;Long, Integer&gt;</code> 数据结构。其与ZK内存数据库相连，会被定期持久化到快照文件。</li><li><strong>sessionSets</strong>：根据下次会话超时时间来管理归档session，<code>HashMap&lt;Long, SessionSet&gt;</code> 数据结构。便于进行会话管理和超时检查。</li></ul><p>创建会话连接：</p><ul><li><strong>处理ConnectRequest请求：</strong>由NIOServerCnxn负责接收客户端的会话创建请求，反序列化出ConnectRequest请求，根据ZK服务端的配置完成会话超时时间的协商。</li><li><strong>会话创建</strong>：SessionTracker为会话分配一个SessionID，将其注册到sessionsById和sessionsWithTimeout，同时进行会话的激活。会话请求还会在ZK服务端各请求处理器直接进行顺序流转。</li><li><strong>处理器链路处理</strong></li><li><strong>会话响应</strong></li></ul><h3 id="4-3-会话管理"><a href="#4-3-会话管理" class="headerlink" title="4.3 会话管理"></a>4.3 会话管理</h3><h4 id="（1）分桶策略"><a href="#（1）分桶策略" class="headerlink" title="（1）分桶策略"></a>（1）分桶策略</h4><p>分桶策略指将类似的会话放在同一区块中进行管理，以便于ZK对会话进行不同区块的隔离处理以及同一区块的统一处理：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010131.png"></p><p>分配的原则是每个会话的下次超时时间点（ExpirationTime）最近一次可能超时的时间点，计算方式：<code>ExpirationTime = CurrentTime + SessionTimeout</code> ，当前时间+超时时间。</p><p>ZK的Leader服务器在运行期间会定时进行会话超时检查，间隔是ExpirationInterval，默认值为TickTime（2000毫秒），完整的公式：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExpirationTime_ = CurrentTime + SessionTimeout</span><br><span class="line">ExpirationTime = (ExpirationTime_ / ExpirationInterval + 1) * ExpirationInterval</span><br><span class="line">// 假设当前时间为1370907000000毫秒，客户端设置超时时间为15000毫秒，服务器TickTime为2000毫秒</span><br><span class="line">ExpirationTime_ = 1370907000000 + 15000 = 1370907015000</span><br><span class="line">ExpirationTime = (1370907015000 / 2000 + 1) = 1370907016000</span><br></pre></td></tr></table></figure><h4 id="（2）会话激活"><a href="#（2）会话激活" class="headerlink" title="（2）会话激活"></a>（2）会话激活</h4><p>客户端在会话运行期间向服务端发送PING请求来保持会话有效，服务端要不断接收这类心跳检测，并重新激活对应客户端会话，即TouchSession，一次心跳检测对应一次会话激活：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010132.png"></p><ol><li>检验会话是否已关闭。</li><li>计算改会话新的超时时间。</li><li>定位改会话当前的区块。根据会话老的超时时间定位其所在区块。</li><li>迁移会话。放入新的超时时间对应区块。</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010133.png"></p><p>发生会话激活的两种情况：</p><ul><li>客户端发送请求，包括读写，触发一次会话激活。</li><li>客户端发现在sessionTimeout/3时间内未和服务器进行通信，主动发起一次PING请求，服务端收到后触发一次会话激活。</li></ul><h4 id="（3）会话超时检查"><a href="#（3）会话超时检查" class="headerlink" title="（3）会话超时检查"></a>（3）会话超时检查</h4><p>SessionTracker中有一个单独的线程专门进行会话超时检查，其工作机制的核心思路非常简单，逐个依次对会话桶中剩下的会话进行清理。</p><p>会话分桶策略中将ExpirationInterval的倍数作为时间点来分布会话，超时检查线程只要在这些指定的时间点进行检查即可，这样可以批量清理有很好的性能。</p><h3 id="4-4-会话清理"><a href="#4-4-会话清理" class="headerlink" title="4.4 会话清理"></a>4.4 会话清理</h3><p>SessionTracker的超时检查出已经过期的会话后，开始进行会话清理：</p><ol><li><p><strong>标记会话状态为“已关闭”</strong>。</p><p>清理过程需要一段时间，首先要将会话的isClosing设置为true，在此期间不再处理该客户端的请求。</p></li><li><p><strong>发起“会话关闭”请求</strong>。</p><p>提交此请求使会话关闭在整个服务器集群中生效，立即交付给PrepRequestProcessor处理器。</p></li><li><p><strong>收集需要清理的临时节点</strong>。</p><p>会话失效后，相关的临时节点都要一并清除掉，所以要先整理出和会话相关的临时节点。</p><p>ZK内存数据库中每个会话都单独保存了一份由该会话维护的临时节点集合，只需根据sessionID取到这份列表即可。</p><p>实际应用中，ZK处理会话关闭请求前可能有两类请求到达了服务端并正在处理：</p><ul><li>节点删除请求，删除的目标节点正好是集合中的一个。</li><li>临时节点创建请求，创建的的目标节点正好是集合中的一个。</li></ul><p>共同点是事务尚未完成，还未应用到内存数据库，所以获取临时节点列表时可能会有不一致的情况。前者需要从获取的列表中也移除，后者要将所有请求对应的路径节点加到集合中，以删除这些将要创建的节点。</p></li><li><p><strong>添加“节点删除”事务变更</strong>。</p><p>完成临时节点收集后，ZK逐个将临时节点转换为节点删除请求，并放入事务变更队列outstandingChanges中去。</p></li><li><p><strong>删除临时节点</strong>。</p><p>FinalRequestProcessor处理器会触发内存数据库，删除该会话对应的所有临时节点。</p></li><li><p><strong>移除会话</strong>。</p><p>完成节点删除后，要将会话从SessionTracker中移除。主要是从三个数据结构sessionsById、sessionsWithTimeout和sessionSets中移除。</p></li><li><p><strong>关闭NIOServerCnxn</strong>。</p><p>从NIOServerCnxnFactory中找到并关闭NIOServerCnxn。</p></li></ol><h3 id="4-5-会话重连"><a href="#4-5-会话重连" class="headerlink" title="4.5 会话重连"></a>4.5 会话重连</h3><p>客户端与服务端网络连接断开时，ZK客户端会自动进行反复的重连，直到最终成功连接到一台服务器，再次连上的客户端可能处于两个状态之一：</p><ul><li><strong>CONNECTED：</strong>会话超时时间内重新连接上，就是重连成功。</li><li><strong>EXPIRED：</strong>超时时间以外则服务端已进行了会话清理操作，此时连上的会话是非法会话。</li></ul><p>当客户端与服务端连接断开后，客户端可能会看到两类异常：</p><ul><li><strong>CONNECTION_LOSS</strong>（连接断开）：立即收到事件None-Disconnected通知，同时抛出异常 ConnectionLossException 。ZK客户端自动从地址列表重新逐个选取新的地址并尝试重新连接。重连后收到事件None-SyncConnected通知，此时可以重试出错的操作。</li><li><strong>SESSION_EXPIRED</strong>（会话过期）：重连时间过长，超过了会话超时时间，服务器认定这个会话已经结束并执行会话清理，但客户端并不知道会话已经失效，其客户端状态还是DISCONNECTED。之后客户端可能会重新连上服务器，并被告知会话已失效，用户要重新实例化一个ZK对象，并决定是否和如何恢复临时数据。</li></ul><p><strong>SESSION_MOVED</strong>（会话转移）：客户端与服务器1断开连接后，与服务器2连接上并延续了有效会话。3.2.0版本之前没有此概念，会有异常情况，向前一个服务器发送的请求被处理后覆盖了向后一个服务器的相同请求。3.2.0版本后提出了会话转移的概念，并封装了SessionMovedException异常。之后处理客户端请求使，首先检查会话的所有者是否是当前服务器，不是就抛出此异常，但因为客户端已和服务器断开了连接，所以无法收到这个异常的响应。只有多个客户端使用相同的sessionId/sessionPasswd创建会话时才会收到，一旦一个客户端会话创建成功，服务器就认为该sessionId对应的会话已发生转移，于是等到第二个客户端连上此服务器后就被认为是会话转移的情况。</p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：会话状态、会话创建、会话管理（分桶策略、会话激活、会话超时检查）、会话清理、会话重连等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-客户端</title>
    <link href="http://linyishui.top/2021061101.html"/>
    <id>http://linyishui.top/2021061101.html</id>
    <published>2021-06-11T03:45:26.000Z</published>
    <updated>2021-07-18T15:35:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="三-客户端"><a href="#三-客户端" class="headerlink" title="三. 客户端"></a>三. 客户端</h2><p>客户端核心组件：</p><ul><li><strong>ZooKeeper实例：</strong>客户端入口。</li><li><strong>ClientWatchManager：</strong>客户端Watcher管理器。</li><li><strong>HostProvider：</strong>客户端地址列表管理器。</li><li><strong>ClientCnxn：</strong>客户端核心线程，内部包含两个线程 SendThread 和EventThread ，前者是I/O线程负责客户端和服务端间的I/O通信，后者是事件线程负责对服务端事件进行处理。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010123.png"></p><p>构造函数API：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br></pre></td></tr></table></figure><p>客户端初始化和启动步骤：</p><ol><li>设置默认Watcher。</li><li>设置ZooKeeper服务器地址列表、</li><li>创建ClientCnxn。</li></ol><h3 id="3-1-一次会话的创建过程"><a href="#3-1-一次会话的创建过程" class="headerlink" title="3.1 一次会话的创建过程"></a>3.1 一次会话的创建过程</h3><p><strong>初始化阶段：</strong></p><ol><li><p><strong>初始化ZK对象。</strong></p><p>通过调用ZK的构造函数实例化一个ZK对象，初始化过程创建一个客户端的Watcher管理器：ClientWatcherManager。</p></li><li><p><strong>设置默认会话Watcher。</strong></p><p>如果在构造方法中传入了一个Watcher对象，客户端将其作为默认Watcher保存在ClientWatcherManager中。</p></li><li><p><strong>构造ZK服务器地址列表管理器：HostProvider。</strong></p><p>客户端将构造函数传入的服务器地址存放到服务器地址列表管理器HostProvider中。</p></li><li><p><strong>创建并初始化客户端网络连接器：ClientCnxn。</strong></p><p>首先创建一个网络连接器ClientCnxn，用来管理客户端和服务器的网络交互。同时还会初始化客户端的两个核心队列 outgoingQueue 和 pendingQueue ，分别作为客户端的请求发送队列和服务端响应的等待队列。</p><p>同时还会创建ClientCnxn的底层I/O处理器ClientCnxnSocket。</p></li><li><p><strong>初始化SendThread和EventThread。</strong></p><p>前者是I/O线程负责客户端和服务端间的I/O通信，后者是事件线程负责对服务端事件进行处理。</p><p>同时将ClientCnxnSocket分配给SendThread作为底层网络I/O处理器，并初始化EventThread的待处理事件队列waitingEvents，用于存放所有等待被客户端处理的事件。</p></li></ol><p><strong>会话创建阶段：</strong></p><ol start="6"><li><p><strong>启动SendThread和EventThread。</strong></p><p>SendThread首先判断当前客户端状态，进行一系列请理性工作，为客户端发送“会话创建”做准备。</p></li><li><p><strong>获取一个服务器地址。</strong></p><p>创建TCP连接前，SendThread首先需要获取一个ZK服务器的目标地址，通常从HostProvider随机取一个，委托给ClientCnxnSocket创建TCP连接。</p></li><li><p><strong>创建TCP连接。</strong></p><p>ClientCnxnSocket负责和服务器创建一个TCP长连接。</p></li><li><p><strong>构造ConnectRequest请求。</strong></p><p>TCP连接创建后，只是从网络TCP层面完成了客户端和服务端间的Socket连接，但还未完成会话创建。</p><p>SendThread根据当前客户端的实际设置，构造出一个ConnectRequest请求，代表了客户端试图与服务器创建一个会话。</p><p>同时ZK客户端进一步将请求包装成网络I/O层的Packet对象，放入请求发送队列 outgoingQueue 中去。</p></li><li><p><strong>发送请求。</strong></p><p>客户端请求准备完毕，开始向服务端发送请求。ClientCnxnSocket从outgoingQueue中取出一个待发送的Packet对象，将其序列化成ByteBuffer后，向服务端进行发送。</p></li></ol><p><strong>响应处理阶段：</strong></p><ol start="11"><li><p><strong>接收服务端响应。</strong></p><p>ClientCnxnSocket接收到服务端响应，首先判断当前客户端状态是否为“已初始化”，若尚未初始化完，认定该响应是会话创建请求的响应，直接交由 readConnectResult 方法来处理。</p></li><li><p><strong>处理Response。</strong></p><p>ClientCnxnSocket对接收到的服务端响应进行反序列化，得到ConnectResponse对象，从中获取到ZK服务器分配的SessionId。</p></li><li><p><strong>连接成功。</strong></p><p>连接成功，一方面通知SendThread线程，进一步对客户端进行会话参数设置，包括readTimeout和connectTimeout等，并更新客户端状态；</p><p>另一方面，通知地址管理器HostProvider当前成功连接的服务器地址。</p></li><li><p><strong>生成事件SyncConnected-None。</strong></p><p>SendThread生成事件SyncConnected-None让上层应用感知到会话成功创建，将其传递给EventThread线程。</p></li><li><p><strong>查询Watcher。</strong></p><p>EventThread收到事件后，从ClientWatcherManager中查询出对应的Watcher，针对SyncConnected-None事件直接找出步骤2存储的默认Watcher，将其放到EventThread的waitingEvents队列。</p></li><li><p><strong>处理事件。</strong></p><p>EventThread不断从waitingEvents队列中取出待处理的Watcher对象，直接调用此对象的process接口方法，以达到触发Watcher的目的。</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010124.png"></p><h3 id="3-2-服务器地址列表"><a href="#3-2-服务器地址列表" class="headerlink" title="3.2 服务器地址列表"></a>3.2 服务器地址列表</h3><p>ZK构造函数中的服务器地址列表参数<strong>connectString</strong>，通常是一个使用英文逗号分隔的多个IP和端口组成的字符串：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span></span><br></pre></td></tr></table></figure><p>ZK客户端收到服务器地址列表后，首先将其放入ConnectStringParser对象封装起来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectStringParser</span> </span>&#123;</span><br><span class="line">    String chrootPath;</span><br><span class="line">    ArrayList&lt;InetSocketAddress&gt; serverAddresses = <span class="keyword">new</span> ArrayList&lt;InetSocketAddress&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（1）客户端隔离命名空间—Chroot"><a href="#（1）客户端隔离命名空间—Chroot" class="headerlink" title="（1）客户端隔离命名空间—Chroot"></a>（1）客户端隔离命名空间—Chroot</h4><p>ZooKeeper 3.2.0版本引入Chroot特性，允许每个客户端为自己设置一个命名空间（Namespace），<strong>设置了Chroot的客户端对服务器的任何操作都会被限制在命名空间下</strong>。</p><p>例如，我们要为应用X分配 <code>/apps/X</code> 下的所有子节点，应用可以将其所有ZK客户端的Chroot设置为 <code>/apps/X</code> 。对于客户端来说，节点路径都是以 <code>/apps/X</code> 为根节点，它和ZK发起的节点路径都是以这个根节点构建的相对路径。这种设计对于实现不同应用间的相互隔离很有帮助。</p><p>可以在connectString后添加后缀来设置Chroot，可以解析出Chroot保存在chrootPath属性：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span>/apps/X</span><br></pre></td></tr></table></figure><h4 id="（2）地址列表管理器—HostProvider"><a href="#（2）地址列表管理器—HostProvider" class="headerlink" title="（2）地址列表管理器—HostProvider"></a>（2）地址列表管理器—HostProvider</h4><p>ConnectStringParser会对服务器地址做简单处理，封装成InetSocketAddress对象，最后经过处理的地址列表会进一步的封装到<strong>StaticHostProvider</strong>中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HostProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> InetSocketAddress <span class="title">next</span><span class="params">(<span class="keyword">long</span> spinDelay)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010125.png"></p><p>HostProvider三要素：</p><ul><li><p><strong>next()方法必须要有合法的返回值。</strong></p><p>凡是对该方法的调用，必须要返回一个合法的InetSocketAddress对象，不能为null或不合法对象。</p></li><li><p><strong>next()方法必须返回已解析的InetSocketAddress对象。</strong></p><p>服务器地址列表保存在 <code>ConnectStringParser.serverAddresses</code> 中是没有被解析的InetSocketAddress，传递到HostProvider后才会被解析，不一定是在next()中解析，但next()返回的必须是已解析的InetSocketAddress对象。</p></li><li><p><strong>size()方法不能返回0。</strong></p><p>HostProvider必须至少有一个服务器地址。</p></li></ul><h4 id="（3）StaticHostProvider"><a href="#（3）StaticHostProvider" class="headerlink" title="（3）StaticHostProvider"></a>（3）StaticHostProvider</h4><p>StaticHostProvider是HostProvider接口的默认实现，数据结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010126.png"></p><ul><li><p><strong>解析服务器地址：</strong>对 <code>ConnectStringParser.serverAddresses</code> 中没有被解析的服务器地址逐个进行解析，再放到 serverAddresses 集合中。同时使用Collections工具类的shuffle方法来将其随机打散。</p></li><li><p><strong>获取可用的服务器地址：</strong>调用 next() 方法获取一个可用的服务器地址，其并非是简单的从集合中一次获取地址，而是将打散的地址列表先拼装成一个环形循环队列：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010127.png"></p><p>服务器地址列表可能会较少，所以当两个游标值相同时，会进行spinDelay毫秒时间的等待。</p></li></ul><h4 id="自定义HostProvider"><a href="#自定义HostProvider" class="headerlink" title="自定义HostProvider"></a>自定义HostProvider</h4><ul><li><strong>配置文件方式：</strong>ZK默认实现中是传入服务器地址列表到构造函数，可以自定义实现一个HostProvider在应用启动时加载配置文件来实现地址列表的获取。</li><li><strong>动态变更的地址列表管理器：</strong>ZK集群的整体迁移或个别机器变更，会导致大批客户端应用也要一起变更，因为我们将IP地址写死在程序中。可以实现一个HostProvider能定时从DNS或配置管理中心上解析出ZK服务器地址列表，当地址列表变更时，同步更新到serverAddresses集合。</li><li><strong>实现同机房优先策略：</strong>项目规模扩大到一定程度，可能出现多机房或异地机房，如何解决不同机房之间的延时（通常可能会达到几十毫秒）？引入同机房优先策略，服务的消费者优先消费同一个机房的服务，实现一个HostProvider能优先和同机房的ZK服务器创建会话。</li></ul><h3 id="3-3-ClientCnxn-网络I-O"><a href="#3-3-ClientCnxn-网络I-O" class="headerlink" title="3.3 ClientCnxn-网络I/O"></a>3.3 ClientCnxn-网络I/O</h3><p>ClientCnxn负责客户端与服务端之间的网络连接并进行一系列网络通信。</p><h4 id="（1）Packet"><a href="#（1）Packet" class="headerlink" title="（1）Packet"></a>（1）Packet</h4><p>Packet是对协议层的封装，作为请求和响应的载体，ClientCnxn的静态内部类，结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010128.png"></p><p>Packet的createBB()方法负责对Packet对象进行序列化，最终生成用于网络传输的ByteBuffer对象。这个过程<strong>只会将 requestHeader、request和readOnly三个属性序列化</strong>，其余都保存在客户端的上下文中不会参与网络传输。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Packet</span> </span>&#123;</span><br><span class="line">    RequestHeader requestHeader;</span><br><span class="line">    ReplyHeader replyHeader;</span><br><span class="line">    Record request;</span><br><span class="line">    Record response;</span><br><span class="line">    ByteBuffer bb;</span><br><span class="line">    String clientPath;</span><br><span class="line">    String serverPath;</span><br><span class="line">    <span class="keyword">boolean</span> finished;</span><br><span class="line">    AsyncCallback cb;</span><br><span class="line">    Object ctx;</span><br><span class="line">    WatchRegistration watchRegistration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> readOnly;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">            boa.writeInt(-<span class="number">1</span>, <span class="string">&quot;len&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.requestHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// requestHeader被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.requestHeader.serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.request <span class="keyword">instanceof</span> ConnectRequest) &#123;</span><br><span class="line">                <span class="comment">// request和readOnly被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">                boa.writeBool(<span class="keyword">this</span>.readOnly, <span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// request被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="keyword">this</span>.bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line">            <span class="keyword">this</span>.bb.putInt(<span class="keyword">this</span>.bb.capacity() - <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.bb.rewind();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Ignoring unexpected exception&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）outgoingQueue和pendingQueue"><a href="#（2）outgoingQueue和pendingQueue" class="headerlink" title="（2）outgoingQueue和pendingQueue"></a>（2）outgoingQueue和pendingQueue</h4><ul><li>outgoingQueue：客户端请求发送队列，存储那些需要发送到服务端的Packet集合。</li><li>pendingQueue：服务端响应等待队列，存储已经从客户端发送到服务端，但需要等待响应的Packet集合。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressFBWarnings(&#123;&quot;EI_EXPOSE_REP&quot;, &quot;EI_EXPOSE_REP2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxn.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SET_WATCHES_MAX_LENGTH = <span class="number">131072</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> disableAutoWatchReset = Boolean.getBoolean(<span class="string">&quot;zookeeper.disableAutoWatchReset&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;ClientCnxn.AuthData&gt; authInfo;</span><br><span class="line">    <span class="comment">// 链表结构</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; pendingQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; outgoingQueue;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><h4 id="（3）底层Socket通信层—ClientCnxnSocket"><a href="#（3）底层Socket通信层—ClientCnxnSocket" class="headerlink" title="（3）底层Socket通信层—ClientCnxnSocket"></a>（3）底层Socket通信层—ClientCnxnSocket</h4><p>3.4.0版本后，从ClientCnxn中抽离出ClientCnxnSocket（抽象类），使客户端代码结构更清晰的同时也便于对底层Socket通信层进行扩展（如使用Netty实现）。</p><p>可以通过在 <code>zookeeper.clientCnxnSocket</code> 这个系统变量中配置 ClientCnxnSocket 实现类的全类名，来指定自定义实现：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZK默认实现即ClientCnxnSocketNIO，使用Java原生的NIO接口，核心是doIO逻辑，负责对请求的发生和响应接收过程</span></span><br><span class="line"><span class="meta">-Dzookeeper.clientCnxnSocket</span>=<span class="string">org.apache.zookeeper.ClientCnxnSocketNIO</span></span><br></pre></td></tr></table></figure><ul><li><p><strong>请求发送：</strong></p><ul><li>从outgoingQueue队列提取出一个可发送的Packet对象，同时生成一个客户端请求序号XID并将其设置到Packet请求头中，再将其序列化后发送。</li><li>可发送是指，检测到客户端与服务端之间正在处理SASL权限时，不包含请求头（requestHeader）的Packet（如会话创建请求）可以被发送，其余都无法发送。</li><li>发送完毕，会立即将Packet保存到pendingQueue队列。</li></ul></li><li><p><strong>响应接收：</strong>客户端收到服务端的完整响应数据后，不同的客户端请求类型会进行不同的处理</p><ul><li>如果检测到<strong>当前客户端尚未进行初始化</strong>，说明当前客户端与服务端之间正在进行会话创建，直接将接收到的ByteBuffer（incomingBuffer）序列化为ConnectResponse对象。</li><li>如果当前客户端已经处于正常的会话周期，且<strong>接收到的服务端响应是一个事件</strong>，将接收到的ByteBuffer（incomingBuffer）序列化为WatcherEvent对象，并将其放入待处理队列中。</li><li>如果是一个<strong>常规的请求响应</strong>（Create、GetData和Exist等操作请求），会从pendingQueue队列中取出一个Packet来进行相应的处理。客户端首先通过检验服务端响应中包含的XID值来确保请求处理的顺序性，然后再将接收到的ByteBuffer（incomingBuffer）序列化为相应的Response对象。</li></ul><p>最终会在 ClientCnxn.finishPacket 方法中处理 Watcher 注册等逻辑。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(ClientCnxn.Packet p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 错误码不为0则将Watcher添加到clientPath为key的数组</span></span><br><span class="line">        p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有回调函数，更新Packet为终止，唤醒等待的线程</span></span><br><span class="line">        <span class="keyword">synchronized</span>(p) &#123;</span><br><span class="line">            p.finished = <span class="keyword">true</span>;</span><br><span class="line">            p.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 有回调函数，更新Packet为终止，增加到事件队列</span></span><br><span class="line">        p.finished = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.eventThread.queuePacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010129.png"></p><p>抽象类ClientCnxnSocket定义了一些抽象方法，和readConnectResult的默认实现等：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocket.class);</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ByteBuffer lenBuffer = ByteBuffer.allocateDirect(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">protected</span> ByteBuffer incomingBuffer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sentCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> recvCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastHeard;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastSend;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> now;</span><br><span class="line">    <span class="keyword">protected</span> SendThread sendThread;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sessionId;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocket() &#123;</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">        <span class="keyword">this</span>.sentCount = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">this</span>.recvCount = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">introduce</span><span class="params">(SendThread sendThread, <span class="keyword">long</span> sessionId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sendThread = sendThread;</span><br><span class="line">        <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = Time.currentElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleRecv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastHeard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getSentCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getRecvCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.recvCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSendAndHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="keyword">this</span>.incomingBuffer.getInt();</span><br><span class="line">        <span class="keyword">if</span> (len &gt;= <span class="number">0</span> &amp;&amp; len &lt; ClientCnxn.packetLen) &#123;</span><br><span class="line">            <span class="keyword">this</span>.incomingBuffer = ByteBuffer.allocate(len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Packet len&quot;</span> + len + <span class="string">&quot; is out of range!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readConnectResult</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;0x[&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] var2 = <span class="keyword">this</span>.incomingBuffer.array();</span><br><span class="line">            <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">                <span class="keyword">byte</span> b = var2[var4];</span><br><span class="line">                buf.append(Integer.toHexString(b) + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buf.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            LOG.trace(<span class="string">&quot;readConnectResult &quot;</span> + <span class="keyword">this</span>.incomingBuffer.remaining() + <span class="string">&quot; &quot;</span> + buf.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ConnectResponse conRsp = <span class="keyword">new</span> ConnectResponse();</span><br><span class="line">        conRsp.deserialize(bbia, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isRO = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isRO = bbia.readBool(<span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Connected to an old server; r-o mode will be unavailable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sessionId = conRsp.getSessionId();</span><br><span class="line">        <span class="keyword">this</span>.sendThread.onConnected(conRsp.getTimeOut(), <span class="keyword">this</span>.sessionId, conRsp.getPasswd(), isRO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> var1, List&lt;Packet&gt; var2, LinkedList&lt;Packet&gt; var3, ClientCnxn var4)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认实现ClientCnxnSocketNIO：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocketNIO</span> <span class="keyword">extends</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocketNIO.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector = Selector.open();</span><br><span class="line">    <span class="keyword">private</span> SelectionKey sockKey;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocketNIO() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sockKey != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doIO</span><span class="params">(List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">int</span> rc = sock.read(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException(<span class="string">&quot;Unable to read additional data from server sessionid 0x&quot;</span> + Long.toHexString(<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, likely server has closed socket&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.incomingBuffer.hasRemaining()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.incomingBuffer.flip();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.incomingBuffer == <span class="keyword">this</span>.lenBuffer) &#123;</span><br><span class="line">                        ++<span class="keyword">this</span>.recvCount;</span><br><span class="line">                        <span class="keyword">this</span>.readLength();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.readConnectResult();</span><br><span class="line">                        <span class="keyword">this</span>.enableRead();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                        <span class="keyword">this</span>.initialized = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendThread.readResponse(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isWritable()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                    Packet p = <span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress());</span><br><span class="line">                    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastSend();</span><br><span class="line">                        <span class="keyword">if</span> (p.bb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                p.requestHeader.setXid(cnxn.getXid());</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            p.createBB();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        sock.write(p.bb);</span><br><span class="line">                        <span class="keyword">if</span> (!p.bb.hasRemaining()) &#123;</span><br><span class="line">                            ++<span class="keyword">this</span>.sentCount;</span><br><span class="line">                            outgoingQueue.removeFirstOccurrence(p);</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span>(pendingQueue) &#123;</span><br><span class="line">                                    pendingQueue.add(p);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !p.bb.hasRemaining()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Packet <span class="title">findSendablePacket</span><span class="params">(LinkedList&lt;Packet&gt; outgoingQueue, <span class="keyword">boolean</span> clientTunneledAuthenticationInProgress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((Packet)outgoingQueue.getFirst()).bb == <span class="keyword">null</span> &amp;&amp; clientTunneledAuthenticationInProgress) &#123;</span><br><span class="line">                ListIterator iter = outgoingQueue.listIterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">                    Packet p = (Packet)iter.next();</span><br><span class="line">                    <span class="keyword">if</span> (p.requestHeader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        iter.remove();</span><br><span class="line">                        outgoingQueue.add(<span class="number">0</span>, p);</span><br><span class="line">                        <span class="keyword">return</span> p;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">&quot;deferring non-priming packet: &quot;</span> + p + <span class="string">&quot;until SASL authentication completes.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (Packet)outgoingQueue.getFirst();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">            <span class="keyword">this</span>.sockKey.cancel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownInput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown input&quot;</span>, var7);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownOutput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown output&quot;</span>, var6);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during socket close&quot;</span>, var5);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during channel close&quot;</span>, var4);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var3) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;SendThread interrupted during sleep, ignoring&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sockKey = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Doing client selector close&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.selector.close();</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Closed client selector&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Ignoring exception during selector close&quot;</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketChannel <span class="title">createSock</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = SocketChannel.open();</span><br><span class="line">        sock.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        sock.socket().setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">        sock.socket().setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> sock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerAndConnect</span><span class="params">(SocketChannel sock, InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey = sock.register(<span class="keyword">this</span>.selector, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">boolean</span> immediateConnect = sock.connect(addr);</span><br><span class="line">        <span class="keyword">if</span> (immediateConnect) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = <span class="keyword">this</span>.createSock();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.registerAndConnect(sock, addr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Unable to open socket to &quot;</span> + addr);</span><br><span class="line">            sock.close();</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initialized = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getRemoteSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getLocalSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> waitTimeOut, List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.select((<span class="keyword">long</span>)waitTimeOut);</span><br><span class="line">        Set selected;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            selected = <span class="keyword">this</span>.selector.selectedKeys();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.updateNow();</span><br><span class="line">        Iterator var6 = selected.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">            SelectionKey k = (SelectionKey)var6.next();</span><br><span class="line">            SocketChannel sc = (SocketChannel)k.channel();</span><br><span class="line">            <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">8</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sc.finishConnect()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateLastSendAndHeard();</span><br><span class="line">                    <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">5</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.doIO(pendingQueue, outgoingQueue, cnxn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sendThread.getZkState().isConnected()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        selected.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;testableCloseSocket() called&quot;</span>);</span><br><span class="line">        ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i &amp; -<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey.interestOps(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Selector <span class="title">getSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.selector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.createBB();</span><br><span class="line">            ByteBuffer pbb = p.bb;</span><br><span class="line">            sock.write(pbb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（4）SendThread"><a href="#（4）SendThread" class="headerlink" title="（4）SendThread"></a>（4）SendThread</h4><p>SendThread是客户端ClientCnxn内部一个核心的I/O调度线程，维护了客户端与服务端之间的会话生命周期，通过在一定的周期频率内向服务端发送一个PING包来实现心跳检测。会话周期内一旦TCP连接断开，就会自动且透明化的完成重连操作。</p><p>管理了客户端所有请求发送和响应接收操作，将上层客户端API操作转换为相应的请求协议并发送到服务端，完成对同步调用的返回和异步调用的回调。还负责将来自服务端的事件传递给EventThread处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastPingSentNs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientCnxnSocket clientCnxnSocket;</span><br><span class="line">    <span class="keyword">private</span> Random r = <span class="keyword">new</span> Random(System.nanoTime());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstConnect = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> InetSocketAddress rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> minPingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> maxPingRwTimeout = <span class="number">60000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RETRY_CONN_MSG = <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取响应信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ReplyHeader replyHdr = <span class="keyword">new</span> ReplyHeader();</span><br><span class="line">        replyHdr.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">        <span class="comment">// 请求和响应序号为负值的几种特殊情况，-1为通知，-2为ping请求，-4权限</span></span><br><span class="line">        <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got ping response for sessionid: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; after &quot;</span> + (System.nanoTime() - <span class="keyword">this</span>.lastPingSentNs) / <span class="number">1000000L</span> + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (replyHdr.getErr() == Code.AUTHFAILED.intValue()) &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got auth sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got notification sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建监听事件，将响应内容反序列化</span></span><br><span class="line">            WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">            event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="comment">// 如果相对路径不为空，处理下路径</span></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String serverPath = event.getPath();</span><br><span class="line">                <span class="keyword">if</span> (serverPath.compareTo(ClientCnxn.<span class="keyword">this</span>.chrootPath) == <span class="number">0</span>) &#123;</span><br><span class="line">                    event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; ClientCnxn.<span class="keyword">this</span>.chrootPath.length()) &#123;</span><br><span class="line">                    event.setPath(serverPath.substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Got server path &quot;</span> + event.getPath() + <span class="string">&quot; which is too short for chroot path &quot;</span> + ClientCnxn.<span class="keyword">this</span>.chrootPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// WatcherEvent再封装为WatchedEvent，并加入eventThread队列</span></span><br><span class="line">            WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got &quot;</span> + we + <span class="string">&quot; for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(we);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.clientTunneledAuthenticationInProgress()) &#123;</span><br><span class="line">            <span class="comment">// 开启SASL</span></span><br><span class="line">            GetSASLRequest request = <span class="keyword">new</span> GetSASLRequest();</span><br><span class="line">            request.deserialize(bbia, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.respondToServer(request.getToken(), ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非特殊情况</span></span><br><span class="line">            ClientCnxn.Packet packet;</span><br><span class="line">            <span class="comment">// 锁住响应队列，移出Packet</span></span><br><span class="line">            <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.pendingQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Nothing in the queue, but got &quot;</span> + replyHdr.getXid());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                packet = (ClientCnxn.Packet)ClientCnxn.<span class="keyword">this</span>.pendingQueue.remove();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 响应序号和请求序号不匹配，抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (packet.requestHeader.getXid() != replyHdr.getXid()) &#123;</span><br><span class="line">                    packet.replyHeader.setErr(Code.CONNECTIONLOSS.intValue());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xid out of order. Got Xid &quot;</span> + replyHdr.getXid() + <span class="string">&quot; with err &quot;</span> + replyHdr.getErr() + <span class="string">&quot; expected Xid &quot;</span> + packet.requestHeader.getXid() + <span class="string">&quot; for a packet with details: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将响应反序列化出的header信息塞入Packet对象</span></span><br><span class="line">                packet.replyHeader.setXid(replyHdr.getXid());</span><br><span class="line">                packet.replyHeader.setErr(replyHdr.getErr());</span><br><span class="line">                packet.replyHeader.setZxid(replyHdr.getZxid());</span><br><span class="line">                <span class="keyword">if</span> (replyHdr.getZxid() &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.lastZxid = replyHdr.getZxid();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// response反序列化塞入Packet对象</span></span><br><span class="line">                <span class="keyword">if</span> (packet.response != <span class="keyword">null</span> &amp;&amp; replyHdr.getErr() == <span class="number">0</span>) &#123;</span><br><span class="line">                    packet.response.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    ClientCnxn.LOG.debug(<span class="string">&quot;Reading reply sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, packet:: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 最终注册下Watch等</span></span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.finishPacket(packet);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SendThread(ClientCnxnSocket clientCnxnSocket) &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-SendThread()&quot;</span>));</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket = clientCnxnSocket;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">States <span class="title">getZkState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ClientCnxnSocket <span class="title">getClientCnxnSocket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.clientCnxnSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">primeConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Socket connection established to &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, initiating session&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.isFirstConnect = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">long</span> sessId = ClientCnxn.<span class="keyword">this</span>.seenRwServerBefore ? ClientCnxn.<span class="keyword">this</span>.sessionId : <span class="number">0L</span>;</span><br><span class="line">        ConnectRequest conReq = <span class="keyword">new</span> ConnectRequest(<span class="number">0</span>, ClientCnxn.<span class="keyword">this</span>.lastZxid, ClientCnxn.<span class="keyword">this</span>.sessionTimeout, sessId, ClientCnxn.<span class="keyword">this</span>.sessionPasswd);</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.disableAutoWatchReset) &#123;</span><br><span class="line">                List&lt;String&gt; dataWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getDataWatches();</span><br><span class="line">                List&lt;String&gt; existWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getExistWatches();</span><br><span class="line">                List&lt;String&gt; childWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getChildWatches();</span><br><span class="line">                <span class="keyword">if</span> (!dataWatches.isEmpty() || !existWatches.isEmpty() || !childWatches.isEmpty()) &#123;</span><br><span class="line">                    Iterator&lt;String&gt; dataWatchesIter = <span class="keyword">this</span>.prependChroot(dataWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; existWatchesIter = <span class="keyword">this</span>.prependChroot(existWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; childWatchesIter = <span class="keyword">this</span>.prependChroot(childWatches).iterator();</span><br><span class="line">                    <span class="keyword">long</span> setWatchesLastZxid = ClientCnxn.<span class="keyword">this</span>.lastZxid;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(dataWatchesIter.hasNext() || existWatchesIter.hasNext() || childWatchesIter.hasNext()) &#123;</span><br><span class="line">                        List&lt;String&gt; dataWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; existWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; childWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">                        String watch;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> batchLength = <span class="number">0</span>; batchLength &lt; <span class="number">131072</span>; batchLength += watch.length()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (dataWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)dataWatchesIter.next();</span><br><span class="line">                                dataWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (existWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)existWatchesIter.next();</span><br><span class="line">                                existWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!childWatchesIter.hasNext()) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                watch = (String)childWatchesIter.next();</span><br><span class="line">                                childWatchesBatch.add(watch);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        SetWatches sw = <span class="keyword">new</span> SetWatches(setWatchesLastZxid, dataWatchesBatch, existWatchesBatch, childWatchesBatch);</span><br><span class="line">                        RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">                        h.setType(<span class="number">101</span>);</span><br><span class="line">                        h.setXid(-<span class="number">8</span>);</span><br><span class="line">                        ClientCnxn.Packet packet = <span class="keyword">new</span> ClientCnxn.Packet(h, <span class="keyword">new</span> ReplyHeader(), sw, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">                        ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(packet);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Iterator var22 = ClientCnxn.<span class="keyword">this</span>.authInfo.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var22.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet((RequestHeader)<span class="keyword">null</span>, (ReplyHeader)<span class="keyword">null</span>, conReq, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>, ClientCnxn.<span class="keyword">this</span>.readOnly));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ClientCnxn.AuthData id = (ClientCnxn.AuthData)var22.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet(<span class="keyword">new</span> RequestHeader(-<span class="number">4</span>, <span class="number">100</span>), (ReplyHeader)<span class="keyword">null</span>, <span class="keyword">new</span> AuthPacket(<span class="number">0</span>, id.scheme, id.data), (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.enableReadWriteOnly();</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">            ClientCnxn.LOG.debug(<span class="string">&quot;Session establishment request sent on &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">prependChroot</span><span class="params">(List&lt;String&gt; paths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span> &amp;&amp; !paths.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.size(); ++i) &#123;</span><br><span class="line">                String clientPath = (String)paths.get(i);</span><br><span class="line">                String serverPath;</span><br><span class="line">                <span class="keyword">if</span> (clientPath.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath + clientPath;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                paths.set(i, serverPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run()调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastPingSentNs = System.nanoTime();</span><br><span class="line">        <span class="comment">// 序号固定为-2</span></span><br><span class="line">        RequestHeader h = <span class="keyword">new</span> RequestHeader(-<span class="number">2</span>, <span class="number">11</span>);</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.queuePacket(h, (ReplyHeader)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (AsyncCallback)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始连接，run()调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startConnect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.setName(<span class="keyword">this</span>.getName().replaceAll(<span class="string">&quot;\\(.*\\)&quot;</span>, <span class="string">&quot;(&quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort() + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="comment">// SASL开启时，实例化客户端</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient = <span class="keyword">new</span> ZooKeeperSaslClient(SaslServerPrincipal.getServerPrincipal(addr));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LoginException var3) &#123;</span><br><span class="line">                ClientCnxn.LOG.warn(<span class="string">&quot;SASL configuration failed: &quot;</span> + var3 + <span class="string">&quot; Will continue connection to Zookeeper server without SASL authentication, if Zookeeper server allows it.&quot;</span>);</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">                <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.logStartConnect(addr);</span><br><span class="line">        <span class="comment">// 注册并连接Socket</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.connect(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logStartConnect</span><span class="params">(InetSocketAddress addr)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="string">&quot;Opening socket connection to server &quot;</span> + addr;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg = msg + <span class="string">&quot;. &quot;</span> + ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getConfigStatus();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ClientCnxnSocket构建会话和Thread，更新几个参数属性</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.introduce(<span class="keyword">this</span>, ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">        <span class="keyword">long</span> lastPingRwServer = Time.currentElapsedTime();</span><br><span class="line">        <span class="keyword">int</span> MAX_SEND_PING_INTERVAL = <span class="keyword">true</span>;</span><br><span class="line">        InetSocketAddress serverAddress = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态存活一直循环</span></span><br><span class="line">        <span class="keyword">while</span>(ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Socket还未连接上，则更具</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.clientCnxnSocket.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// 当前非首次连接就休眠等待(0到1000的随机数)，等待连接建立</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.isFirstConnect) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep((<span class="keyword">long</span>)<span class="keyword">this</span>.r.nextInt(<span class="number">1000</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">                            ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var10);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果已经结束则跳出循环</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing || !ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取服务器地址</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.rwServerAddress != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        serverAddress = <span class="keyword">this</span>.rwServerAddress;</span><br><span class="line">                        <span class="keyword">this</span>.rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        serverAddress = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">1000L</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 调用startConnect建立连接</span></span><br><span class="line">                    <span class="keyword">this</span>.startConnect(serverAddress);</span><br><span class="line">                    <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> to;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// 当前已连接</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> sendAuthEvent = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getSaslState() == SaslState.INITIAL) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.initialize(ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (SaslException var9) &#123;</span><br><span class="line">                                ClientCnxn.LOG.error(<span class="string">&quot;SASL authentication with Zookeeper Quorum member failed: &quot;</span> + var9);</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        KeeperState authState = ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getKeeperState();</span><br><span class="line">                        <span class="keyword">if</span> (authState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (authState == KeeperState.AuthFailed) &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authState == KeeperState.SaslAuthenticated) &#123;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (sendAuthEvent) &#123;</span><br><span class="line">                            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, authState, (String)<span class="keyword">null</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.readTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 当前还未连接</span></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.connectTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 会话超时</span></span><br><span class="line">                <span class="keyword">if</span> (to &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    String warnInfo = <span class="string">&quot;Client session timed out, have not heard from server in &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv() + <span class="string">&quot;ms for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">                    ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionTimeoutException(warnInfo);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 已连接则定时发送Ping</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> timeToNextPing = ClientCnxn.<span class="keyword">this</span>.readTimeout / <span class="number">2</span> - <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() - (<span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &gt; <span class="number">1000</span> ? <span class="number">1000</span> : <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (timeToNextPing &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &lt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (timeToNextPing &lt; to) &#123;</span><br><span class="line">                            to = timeToNextPing;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendPing();</span><br><span class="line">                        <span class="keyword">this</span>.clientCnxnSocket.updateLastSend();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// CONNECTED_READ_ONLY状态，更新to</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state == States.CONNECTEDREADONLY) &#123;</span><br><span class="line">                    <span class="keyword">long</span> now = Time.currentElapsedTime();</span><br><span class="line">                    <span class="keyword">int</span> idlePingRwServer = (<span class="keyword">int</span>)(now - lastPingRwServer);</span><br><span class="line">                    <span class="keyword">if</span> (idlePingRwServer &gt;= <span class="keyword">this</span>.pingRwTimeout) &#123;</span><br><span class="line">                        lastPingRwServer = now;</span><br><span class="line">                        idlePingRwServer = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">this</span>.pingRwTimeout = Math.min(<span class="number">2</span> * <span class="keyword">this</span>.pingRwTimeout, <span class="number">60000</span>);</span><br><span class="line">                        <span class="keyword">this</span>.pingRwServer();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = Math.min(to, <span class="keyword">this</span>.pingRwTimeout - idlePingRwServer);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用底层传输接口</span></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.doTransport(to, ClientCnxn.<span class="keyword">this</span>.pendingQueue, ClientCnxn.<span class="keyword">this</span>.outgoingQueue, ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        ClientCnxn.LOG.debug(<span class="string">&quot;An exception was thrown while closing send thread for session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()) + <span class="string">&quot; : &quot;</span> + var11.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionExpiredException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionTimeoutException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.EndOfStreamException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.RWServerFoundException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> SocketException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(<span class="string">&quot;Socket error occurred: &#123;&#125;: &#123;&#125;&quot;</span>, serverAddress, var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Session 0x&#123;&#125; for server &#123;&#125;, unexpected error&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()), serverAddress, <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>, var11&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.cleanup();</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环结束，终止状态</span></span><br><span class="line">        <span class="keyword">this</span>.cleanup();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.close();</span><br><span class="line">        <span class="comment">// 若此时状态还是存活，发送断开连接事件</span></span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZooTrace.logTraceMessage(ClientCnxn.LOG, ZooTrace.getTextTraceLevel(), <span class="string">&quot;SendThread exited loop for session: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pingRwServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientCnxn.RWServerFoundException, UnknownHostException </span>&#123;</span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line">        InetSocketAddress addr = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">0L</span>);</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Checking server &quot;</span> + addr + <span class="string">&quot; for being r/w. Timeout &quot;</span> + <span class="keyword">this</span>.pingRwTimeout);</span><br><span class="line">        Socket sock = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sock = <span class="keyword">new</span> Socket(addr.getHostName(), addr.getPort());</span><br><span class="line">            sock.setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">            sock.setSoTimeout(<span class="number">1000</span>);</span><br><span class="line">            sock.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">            sock.getOutputStream().write(<span class="string">&quot;isro&quot;</span>.getBytes());</span><br><span class="line">            sock.getOutputStream().flush();</span><br><span class="line">            sock.shutdownOutput();</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(sock.getInputStream()));</span><br><span class="line">            result = br.readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConnectException var21) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var22) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Exception while seeking for r/w server &quot;</span> + var22.getMessage(), var22);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var20) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var20);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var19) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var19);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;rw&quot;</span>.equals(result)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">            <span class="keyword">this</span>.rwServerAddress = addr;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.RWServerFoundException(<span class="string">&quot;Majority server found at &quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.cleanup();</span><br><span class="line">        Iterator var2;</span><br><span class="line">        ClientCnxn.Packet p;</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.pendingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.pendingQueue.clear();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.outgoingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.outgoingQueue.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(<span class="keyword">int</span> _negotiatedSessionTimeout, <span class="keyword">long</span> _sessionId, <span class="keyword">byte</span>[] _sessionPasswd, <span class="keyword">boolean</span> isRO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout = _negotiatedSessionTimeout;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Expired, (String)<span class="keyword">null</span>));</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEventOfDeath();</span><br><span class="line">            String warnInfo = <span class="string">&quot;Unable to reconnect to ZooKeeper service, session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; has expired&quot;</span>;</span><br><span class="line">            ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionExpiredException(warnInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.<span class="keyword">this</span>.readOnly &amp;&amp; isRO) &#123;</span><br><span class="line">                ClientCnxn.LOG.error(<span class="string">&quot;Read/write client got connected to read-only server&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.readTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.connectTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout / ClientCnxn.<span class="keyword">this</span>.hostProvider.size();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.hostProvider.onConnected();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionId = _sessionId;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionPasswd = _sessionPasswd;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = isRO ? States.CONNECTEDREADONLY : States.CONNECTED;</span><br><span class="line">            ClientCnxn var10000 = ClientCnxn.<span class="keyword">this</span>;</span><br><span class="line">            var10000.seenRwServerBefore |= !isRO;</span><br><span class="line">            ClientCnxn.LOG.info(<span class="string">&quot;Session establishment complete on server &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, sessionid = 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, negotiated timeout = &quot;</span> + ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout + (isRO ? <span class="string">&quot; (READ-ONLY mode)&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            KeeperState eventState = isRO ? KeeperState.ConnectedReadOnly : KeeperState.SyncConnected;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, eventState, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.wakeupCnxn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.testableCloseSocket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">clientTunneledAuthenticationInProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.saslLoginFailed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient == <span class="keyword">null</span> ? <span class="keyword">true</span> : ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.clientTunneledAuthenticationInProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(ClientCnxn.Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.sendPacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="（5）EventThread"><a href="#（5）EventThread" class="headerlink" title="（5）EventThread"></a>（5）EventThread</h4><p>EventThread是ClientCnxn的内部类，负责客户端的事件处理，并触发客户端注册的Watcher监听。EventThread中有一个waitingEvents队列，用于临时存放那些需要被触发的Object，包括客户端注册的Watcher和异步接口中注册的回调器 AsyncCallback。</p><p>EventThread会不断从waitingEvents中取出Object，识别出其具体类型，并分别调用process和processResult接口方法来实现对事件的触发和回调。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EventThread线程不断的从waitingEvents这个队列中取出Object，识别出其具体类型Watcher或者AsyncCallback，并分别调用process和processResult接口方法来实现对事件的触发和回调。</span></span><br><span class="line"><span class="comment">// watcher就是数据变更通知</span></span><br><span class="line"><span class="comment">// AsyncCallback是ZooKeeper客户端的API命令中的异步API，ZooKeeper客户端的API，创建节点、删除节点、检测节点是否存在、权限控制、获取子节点、获取数据内容、设置权限、设置数据内容都有相应的异步方式，有StringCallback、VoidCallback、StatCallback、ACLCallback、ChildrenCallback、Children2Callback、DataCallback七种</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;Object&gt; waitingEvents = <span class="keyword">new</span> LinkedBlockingQueue();</span><br><span class="line">    <span class="comment">//这实际上是队列中的会话状态，直到EventThread事件线程实际处理该事件并将其交给watcher为止。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> KeeperState sessionState;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> wasKilled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">    EventThread() &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-EventThread&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.sessionState = KeeperState.Disconnected;</span><br><span class="line">        <span class="keyword">this</span>.wasKilled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将WatchedEvent加入到waitingEvents队列中</span></span><br><span class="line">    <span class="comment">//在SendThread线程的readResponse(ByteBuffer incomingBuffer)读取从服务器端的response</span></span><br><span class="line">    <span class="comment">//如果是事件，则解析反序列化还原成WatchedEvent，调用该方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getType() != EventType.None || <span class="keyword">this</span>.sessionState != event.getState()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionState = event.getState();</span><br><span class="line">            ClientCnxn.WatcherSetEventPair pair = <span class="keyword">new</span> ClientCnxn.WatcherSetEventPair(ClientCnxn.<span class="keyword">this</span>.watcher.materialize(event.getState(), event.getType(), event.getPath()), event);</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(pair);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queuePacket</span><span class="params">(ClientCnxn.Packet packet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isRunning) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.processEvent(packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEventOfDeath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingEvents.add(ClientCnxn.<span class="keyword">this</span>.eventOfDeath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.isRunning = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//一直循环，从waitingEvents队列中取出WatchedEvent或者Packet</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                Object event = <span class="keyword">this</span>.waitingEvents.take();</span><br><span class="line">                <span class="keyword">if</span> (event == ClientCnxn.<span class="keyword">this</span>.eventOfDeath) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wasKilled = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//处理event</span></span><br><span class="line">                    <span class="keyword">this</span>.processEvent(event);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.waitingEvents.isEmpty()) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var5) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Event thread exiting due to interruption&quot;</span>, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;EventThread shut down for session: 0x&#123;&#125;&quot;</span>, Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//watcher监听事件</span></span><br><span class="line">            <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ClientCnxn.WatcherSetEventPair) &#123;</span><br><span class="line">                <span class="comment">// each watcher will process the event</span></span><br><span class="line">                ClientCnxn.WatcherSetEventPair pair = (ClientCnxn.WatcherSetEventPair)event;</span><br><span class="line">                <span class="comment">//循环watcher集合，调用watcher的回调方法(WatchedEvent event)处理该事件</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">                    Watcher watcher = (Watcher)var3.next();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//还记得Watcher接口中对于watcher实现类都要实现的一个process(WatchedEvent event)方法，就是这个</span></span><br><span class="line">                        watcher.process(pair.event);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                        ClientCnxn.LOG.error(<span class="string">&quot;Error while calling watcher &quot;</span>, var11);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//异步回调</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                ClientCnxn.Packet p = (ClientCnxn.Packet)event;</span><br><span class="line">                <span class="comment">//ResultCode服务器端响应码，常见码如下</span></span><br><span class="line">                <span class="comment">//0：接口调用成功 -4客户端与服务器端连接已断开</span></span><br><span class="line">                <span class="comment">//-110指定节点已存在 -112会话已过期</span></span><br><span class="line">                <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">                String clientPath = p.clientPath;</span><br><span class="line">                <span class="keyword">if</span> (p.replyHeader.getErr() != <span class="number">0</span>) &#123;</span><br><span class="line">                    rc = p.replyHeader.getErr();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Somehow a null cb got to EventThread!&quot;</span>);</span><br><span class="line">                &#125; </span><br><span class="line"><span class="comment">//如果是exists/setData/setAcl命令异步方式的服务器端响应</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!(p.response <span class="keyword">instanceof</span> ExistsResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetDataResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetACLResponse)) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//getData命令异步方式的服务器异步响应</span></span><br><span class="line">                    <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetDataResponse) &#123;</span><br><span class="line">                        DataCallback cbxxxx = (DataCallback)p.cb;</span><br><span class="line">                        GetDataResponse rspxxx = (GetDataResponse)p.response;</span><br><span class="line"><span class="comment">//rc==0表示接口调用成功</span></span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, rspxxx.getData(), rspxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, (<span class="keyword">byte</span>[])<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">//getACL命令异步方式的服务器异步响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetACLResponse) &#123;</span><br><span class="line">                        ACLCallback cbxxxxx = (ACLCallback)p.cb;</span><br><span class="line">                        GetACLResponse rspxxxx = (GetACLResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, rspxxxx.getAcl(), rspxxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildren命令的服务器响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildrenResponse) &#123;</span><br><span class="line">                        ChildrenCallback cbxxxxxx = (ChildrenCallback)p.cb;</span><br><span class="line">                        GetChildrenResponse rspxxxxx = (GetChildrenResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, rspxxxxx.getChildren());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildren命令异步方式的服务器异步响应，与上面的区别在与stat信息更新</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildren2Response) &#123;</span><br><span class="line">                        Children2Callback cbxxxxxxx = (Children2Callback)p.cb;</span><br><span class="line">                        GetChildren2Response rsp = (GetChildren2Response)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, rsp.getChildren(), rsp.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//create命令异步方式的服务器异步响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> CreateResponse) &#123;</span><br><span class="line">                        StringCallback cb = (StringCallback)p.cb;</span><br><span class="line">                        CreateResponse rspx = (CreateResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, ClientCnxn.<span class="keyword">this</span>.chrootPath == <span class="keyword">null</span> ? rspx.getPath() : rspx.getPath().substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, (String)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//MultiResponse</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> MultiResponse) &#123;</span><br><span class="line">                        MultiCallback cbx = (MultiCallback)p.cb;</span><br><span class="line">                        MultiResponse rspxx = (MultiResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            List&lt;OpResult&gt; results = rspxx.getResultList();</span><br><span class="line">                            <span class="keyword">int</span> newRc = rc;</span><br><span class="line">                            Iterator var9 = results.iterator();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">                                OpResult result = (OpResult)var9.next();</span><br><span class="line">                                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ErrorResult &amp;&amp; Code.OK.intValue() != (newRc = ((ErrorResult)result).getErr())) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            cbx.processResult(newRc, clientPath, p.ctx, results);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb <span class="keyword">instanceof</span> VoidCallback) &#123;</span><br><span class="line">                        VoidCallback cbxx = (VoidCallback)p.cb;</span><br><span class="line">                        cbxx.processResult(rc, clientPath, p.ctx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    StatCallback cbxxx = (StatCallback)p.cb;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> ExistsResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((ExistsResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetDataResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetDataResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetACLResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetACLResponse)p.response).getStat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cbxxx.processResult(rc, clientPath, p.ctx, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Caught unexpected throwable&quot;</span>, var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：一次会话的创建过程、服务器地址列表、ClientCnxn网络I/O（Packet、outgoingQueue和pendingQueue、ClientCnxnSocket、SendThread、EventThread）等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-系统模型和序列化协议</title>
    <link href="http://linyishui.top/2021061001.html"/>
    <id>http://linyishui.top/2021061001.html</id>
    <published>2021-06-10T07:03:45.000Z</published>
    <updated>2021-07-18T15:35:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="一-系统模型"><a href="#一-系统模型" class="headerlink" title="一. 系统模型"></a>一. 系统模型</h2><h3 id="1-1-数据模型"><a href="#1-1-数据模型" class="headerlink" title="1.1 数据模型"></a>1.1 数据模型</h3><p>ZooKeeper的数据模型为 ZNode，即数据节点，可以保存数据，同事可以挂载子节点，因此构成了一个层次化的命名空间，一个树结构。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010101.png"></p><p>ZooKeeper中的事务指能够改变ZK服务器状态的操作，一般包括数据节点的创建和删除、数据节点内容更新和客户端会话创建与失效等操作。每个事务会被分配一个全局唯一的事务ID，即ZXID，通常是一个64位的数字，每个ZXID对应一次更新操作，而且可以间接看出ZK处理这些请求的全局顺序。</p><h3 id="1-2-节点特性"><a href="#1-2-节点特性" class="headerlink" title="1.2 节点特性"></a>1.2 节点特性</h3><h4 id="（1）节点类型"><a href="#（1）节点类型" class="headerlink" title="（1）节点类型"></a>（1）节点类型</h4><ul><li><strong>持久节点（PERSISTENT）：</strong>数据节点创建后就会一直存在于ZK服务器上，直到由删除操作主动清除此节点。</li><li><strong>持久顺序节点（PERSISTENT_SEQUENTIAL）：</strong>有额外的顺序性特点，每个父节点都会为它的一级子节点维护一份顺序，创建子节点时可以设置这个标记，ZK会自动给节点名后加一个数字后缀。</li><li><strong>临时节点（EPHEMERAL）：</strong>此节点的生命周期与客户端会话绑定，当会话失效，节点就会被自动清理掉（非TCP连接断开），临时节点只能作为叶子节点，不能创建子节点。</li><li><strong>临时顺序节点（EPHEMERAL_SEQUENTIAL）：</strong>额外有了顺序性。</li></ul><h4 id="（2）状态信息"><a href="#（2）状态信息" class="headerlink" title="（2）状态信息"></a>（2）状态信息</h4><p>通过get命令获取一个数据节点的内容：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010102.png"></p><p>第一行是数据内容，后面就是节点的状态信息，其实就是数据节点的Stat对象的格式化输出：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010103.png"></p><p>Stat类包含上一个数据节点的所有状态信息（事务ID、版本信息和子节点个数等）：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010104.png"></p><h3 id="1-3-版本—乐观锁保证分布式数据原子性操作"><a href="#1-3-版本—乐观锁保证分布式数据原子性操作" class="headerlink" title="1.3 版本—乐观锁保证分布式数据原子性操作"></a>1.3 版本—乐观锁保证分布式数据原子性操作</h3><p>每个数据节点都有三种类似新的版本信息：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010105.png"></p><p>当节点创建后，version值为0，当对此节点进行更新后，更新为1，代表变更次数。通过版本号实现的乐观锁来实现在数据并发竞争不大、事务冲突较少的应用场景。</p><p>ZK的PrepRequestProcessor处理器类中，处理每个数据更新请求（setDataRequest）时，会进行如下版本检查：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version = setDataRequest.getVersion();</span><br><span class="line"><span class="comment">// 获取当前服务器上该数据的最新版本</span></span><br><span class="line"><span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</span><br><span class="line"><span class="comment">// -1表示客户端不要求使用乐观锁</span></span><br><span class="line"><span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</span><br><span class="line">   &#125;</span><br><span class="line">version = currentVersion + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="1-4-Watcher"><a href="#1-4-Watcher" class="headerlink" title="1.4 Watcher"></a>1.4 Watcher</h3><p>ZK通过Watcher机制来实现发布/订阅的分布式通知功能，当服务端指定事件触发了Watcher，就会向指定客户端发送一个事件通知：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010106.png"></p><h4 id="1-4-1-结构"><a href="#1-4-1-结构" class="headerlink" title="1.4.1 结构"></a>1.4.1 结构</h4><p>Watcher对象存储在客户端的WatchManager中，收到通知后从中取出对应的Watcher对应来执行回调逻辑。</p><p>接口类Watcher表示一个标准的事件处理器，包含KeeperState和EventType两个枚举类，分别表示通知状态和事件类型，同时定义了事件的回调方法：<code>process(WatchedEvent event)</code> 。</p><p>Watcher事件常见的通知状态和事件类型：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010107.png"></p><p>内容变更包括节点的数据内容和数据的版本号dataVersion，即使相同数据内容，一旦有客户端调用数据更新的接口，触发的更新一样会发送相应通知。</p><p>AuthFailed是授权失败触发，使用错误的Auth只会抛出NoAuthException异常，而使用错误的Scheme则会抛出AuthFailedException，并且收到事件通知(AuthFailed, None)。</p><p>回调方法 <code>process()</code> ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WatchedEvent对象封装服务端事件并传递给Watcher</span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span></span>;</span><br></pre></td></tr></table></figure><p>WatchedEvent包含每个事件的三个基本属性：通知状态（KeeperState）、事件类型（eventType）和节点路径（path）：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010108.png"></p><p>相对的WatcherEvent实现了序列号接口，可以用于网络传输：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010109.png"></p><p>服务端生成WatchedEvent事件后，会调用getWrapper方法将自己包装成一个可序列化的WatcherEvent事件，通过网络传输给客户端。客户端收到事件对象后会先将WatcherEvent还原为WatchedEvent，并传递给process方法处理。二者对于事件的封装都很简单，比如节点数据变更，客户端无法直接获取到原始数据和变更后数据：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">KeeperState:</span> SyncConnected</span><br><span class="line"><span class="symbol">EventType:</span> NodeDataChanged</span><br><span class="line"><span class="symbol">Path:</span> /zk-book</span><br></pre></td></tr></table></figure><p>Watcher内部各组件间关系：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010110.png"></p><h4 id="1-4-2-客户端注册Watcher"><a href="#1-4-2-客户端注册Watcher" class="headerlink" title="1.4.2 客户端注册Watcher"></a>1.4.2 客户端注册Watcher</h4><p>注册Watcher：</p><ul><li><p>创建ZK客户端实例时，可以给定一个默认的Watcher，它会一直保存在客户端ZKWatchManager的defaultWatcher中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>客户端也可以通过 <code>getData()</code> 、<code>getChildren()</code> 和 <code>exist()</code> 三个接口来注册Watcher，例如getData：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  通过布尔参数标识是否使用前面的默认Watcher来进行注册</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getData(String path, <span class="keyword">boolean</span> watch, Stat stat);</span><br><span class="line"><span class="comment">// 直接提供Watcher</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getData(<span class="keyword">final</span> String path, Watcher watcher, Stat stat);</span><br></pre></td></tr></table></figure></li></ul><p>客户端首先会对当前客户端请求request进行标记，设置为“使用Watcher监听”，同时封装一个Watcher注册信息WatchRegistration对象，临时保存数据节点的路径和Watcher的关系：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">getData</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Stat stat)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       WatchRegistration wcb = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (watcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">           wcb = <span class="keyword">new</span> DataWatchRegistration(watcher, clientPath);</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">       request.setWatch(watcher != <span class="keyword">null</span>);</span><br><span class="line">       ReplyHeader r = cnxn.submitRequest(h, request, response, wcb);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>Packet可以看作是ZK中最小的通信协议单元，用于进行客户端与服务端之间的网络传输，任何需要传输的对象都需要包装成一个Packet对象。ClientCnxn的WatchRegistration也会封装到Packet中，再放入发送队列中等待客户端发送。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Packet <span class="title">queuePacket</span><span class="params">(RequestHeader h, ReplyHeader r, Record request, Record response, AsyncCallback cb, String clientPath, String serverPath, Object ctx, WatchRegistration watchRegistration)</span> </span>&#123;</span><br><span class="line">       Packet packet = <span class="keyword">null</span>;</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">           packet = <span class="keyword">new</span> Packet(h, r, request, response, watchRegistration);</span><br><span class="line">       ...</span><br><span class="line">           outgoingQueue.add(packet);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>随后，客户端发送请求，同时等待请求返回。完成发送后，由客户端SendThread线程的readResponse方法负责接收来自服务端的响应，finishPacket方法从Packet中取出对应的Watcher并注册到ZKWatchManager中去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(Packet p)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">           p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Map&lt;String, Set&lt;Watcher&gt;&gt; getWatches(<span class="keyword">int</span> rc) &#123;</span><br><span class="line">       <span class="keyword">return</span> watchManager.dataWatches;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端将暂时保存的Watcher转交给ZKWatchManager，最终保存到dataWatches</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (shouldAddWatch(rc)) &#123;</span><br><span class="line">           Map&lt;String, Set&lt;Watcher&gt;&gt; watches = getWatches(rc);</span><br><span class="line">           <span class="keyword">synchronized</span>(watches) &#123;</span><br><span class="line">               Set&lt;Watcher&gt; watchers = watches.get(clientPath);</span><br><span class="line">               <span class="keyword">if</span> (watchers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   watchers = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line">                   watchers.put(clientPath, watchers);</span><br><span class="line">               &#125;</span><br><span class="line">               watchers.add(watcher);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>流程图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010111.png"></p><p>极端情况下，客户端每调用一次 <code>getData()</code> 接口，就会注册一个Watcher，但这些Watcher并不会都随着客户端请求发送到服务端造成内存紧张等性能问题。ZK底层实际的网络传输序列化过程中并没有将WatchRegistration对象完全的序列化到底层字节数组中，Packet内部序列化过程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">           BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">           <span class="comment">// We&#x27;ll fill this in later</span></span><br><span class="line">           boa.writeInt(-<span class="number">1</span>, <span class="string">&quot;len&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (requestHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">               requestHeader.serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ConnectRequest) &#123;</span><br><span class="line">               request.serialize(boa, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">               <span class="comment">// append &quot;am-I-allowed-to-be-readonly&quot; flag</span></span><br><span class="line">               boa.wirteBool(readOnly, <span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">               request.serialize(boa, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>只有requestHeader和request进行了序列化，所以尽管WatchRegistration被封装到了Packet中，但并没有序列化到底层字节数组，因此不会进行网络传输。</strong></p><h4 id="1-4-3-服务端处理Watcher"><a href="#1-4-3-服务端处理Watcher" class="headerlink" title="1.4.3 服务端处理Watcher"></a>1.4.3 服务端处理Watcher</h4><p>客户端并不会将Watcher对象真正的传递到服务端，服务端如何完成客户端的Watcher注册？</p><h5 id="（1）ServerCnxn存储"><a href="#（1）ServerCnxn存储" class="headerlink" title="（1）ServerCnxn存储"></a>（1）ServerCnxn存储</h5><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010112.png"></p><p>服务端收到请求后，在 <code>FinalRequestProcessor.processRequest()</code> 中判断当前请求是否需要注册Watcher：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> OpCode.getData: &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 当getDtatRequest.getWatch()为True时，将当前ServerCnxn对象和数据节点路径传入getData方法，最终存储在WatchManager的watchTable和watch2Paths中</span></span><br><span class="line">    <span class="keyword">byte</span> b[] = zks.getZKDatabase().getData(getDataRequest.getPath(), stat, getDtatRequest.getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">    rsp = <span class="keyword">new</span> GetDataResponse(b, stat);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerCnxn是一个ZooKeeper客户端和服务器之间的连接接口，代表了一个二者间的连接。默认实现是NIOServerCnxn，3.4.0版本开始引入了基于Netty的实现NettyServerCnxn。都实现了Watcher的process接口，所以ServerCnxn也可以看作是一个Watcher。</p><p>WatchManager是ZK服务端Watcher的管理者，内部两种存储结构对应不同维度：</p><ul><li><strong>watchTable：</strong>从数据节点路径的粒度来托管Watcher。</li><li><strong>watch2Paths：</strong>从Watcher的粒度控制事件触发需要触发的数据节点。</li></ul><p>WatchManager还负责Watcher事件的触发，移除掉已被触发的Watcher。服务端DataTree会托管两个WatchManager（dataWatches和childWatches，对应数据变更和子节点变更）。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010113.png"></p><h5 id="（2）Watcher触发"><a href="#（2）Watcher触发" class="headerlink" title="（2）Watcher触发"></a>（2）Watcher触发</h5><p>服务端如何触发Watcher</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">setData</span><span class="params">(String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version, <span class="keyword">long</span> zxid, <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> KeeperException.NoNodeException </span>&#123;</span><br><span class="line">       DataNode n = nodes.get(path);</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">byte</span> lasdtdata[] = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">synchronized</span> (n) &#123;</span><br><span class="line">           lastdata = n.data;</span><br><span class="line">           n.data = data;</span><br><span class="line">           n.stat.setMtime(time);</span><br><span class="line">           n.stat.setMzxid(zxid);</span><br><span class="line">           n.stat.setVersion(version);</span><br><span class="line">           n.copyStat(s);</span><br><span class="line">       &#125;</span><br><span class="line">       ......</span><br><span class="line">       <span class="comment">// 指定节点数据更新后，调用WatchManager的triggerWatch来触发相关事件</span></span><br><span class="line">       dataWatches.triggerWatch(path, EventType.NodeDataChanged);</span><br><span class="line">       <span class="keyword">return</span> s;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> triggerWatch(path, type, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type, Set&lt;Watcher&gt; supress)</span> </span>&#123;</span><br><span class="line">       WatchedEvent e = <span class="keyword">new</span> WatchedEvent(type, KeeperState.SyncConnected, path);</span><br><span class="line">       HashSet&lt;Watcher&gt; watchers;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           watchers = watchTable.remove(path);</span><br><span class="line">           ......</span><br><span class="line">           <span class="comment">// 如果不存在Watcher，直接返回</span></span><br><span class="line">           <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">               HashSet&lt;String&gt; paths = watch2Paths.get(w);</span><br><span class="line">               <span class="keyword">if</span> (paths != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   paths.remove(path);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">           <span class="keyword">if</span> (supress != <span class="keyword">null</span> &amp;&amp; supress.contains(w)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           w.process(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> watchers;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>WatchManager的触发逻辑：</p><ol><li><p><strong>封装WatchedEvent：</strong>先将通知状态（KeeperState）、事件类型（EventType）和节点路径封装成一个WatchedEvent对象。</p></li><li><p><strong>查询Watcher：</strong>根据节点路径从watchTable中取出对应的Watcher，若没找到则说明没有客户端在该节点注册过Watcher，直接退出；若找到了则将其提取出来，同时直接从watchTable和watch2Paths中将其删除（<strong>Watcher在服务端是一次性的，用完及删</strong>）。</p></li><li><p><strong>调用process方法来触发Watcher：</strong>逐个调用步骤2找到的Watcher的process方法，即请求中的ServerCnxn对应方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOServerCnxn</span> <span class="keyword">extends</span> <span class="title">ServerCnxn</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 请求头标记-1，标识当前是一个通知</span></span><br><span class="line">        ReplyHeader h -= <span class="keyword">new</span> ReplyHeader(-<span class="number">1</span>, -<span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Convert WatchedEvent to a type that can be sent over the write</span></span><br><span class="line">        <span class="comment">// WatchedEvent包装为WatcherEvent方便网络传输序列化</span></span><br><span class="line">        WatcherEvent e = event.getWrapper();</span><br><span class="line">        <span class="comment">// 向客户端发送通知</span></span><br><span class="line">        sendResponse(h, e, <span class="string">&quot;notification&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerCnxn中的process不包含业务逻辑，真正的Watcher回调和业务逻辑都在客户端</p></li></ol><h5 id="（3）客户端回调Watcher"><a href="#（3）客户端回调Watcher" class="headerlink" title="（3）客户端回调Watcher"></a>（3）客户端回调Watcher</h5><ul><li><p><strong>SendThread接收事件通知：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZK客户端如何接收事件通知</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 服务端响应统一处理</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> throw IOException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// -1 means notification 通知类型的响应</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 1.将字节流转换为WatcherEvent对象</span></span><br><span class="line">            WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">            event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="comment">// 2.处理chrootPath</span></span><br><span class="line">            <span class="comment">// convert from a server path to a client path</span></span><br><span class="line">            <span class="keyword">if</span> (chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 对服务端传过来的完整字节路径进行处理，生成客户端一个相对节点路径</span></span><br><span class="line">                String serverPath = event.getPath();</span><br><span class="line">                <span class="keyword">if</span> (serverPath.compareTo(chrootPath) == <span class="number">0</span>)</span><br><span class="line">                    event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; chrootPath.length())</span><br><span class="line">                    event.setPath(serverPath.substring(chrootPath.length()));</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.还原WatchedEvent，适配process接口参数</span></span><br><span class="line">            WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 4.回调Watcher，将WatchedEvent交给EventThread线程，在下一个轮询周期进行Watcher回调</span></span><br><span class="line">            eventThread.queueEvent(we);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>EventThread处理事件通知：</strong></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010114.png"></p><p>SentThread通过 <code>EventThread.queueEvent()</code> 将事件传给EventThread线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (event.getType() == EventType.None &amp;&amp; sessionState == event.getState()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       sessionState = event.getState();</span><br><span class="line">       <span class="comment">// materialize the watchers based on the event</span></span><br><span class="line">       WatcherSetEventPair pair = <span class="keyword">new</span> WatcherSetEventPair();</span><br><span class="line">       watcher.materialize(event.getState(), event.getType(), event.getPath(), event));</span><br><span class="line">       <span class="comment">// queue the pair (watch set &amp; event) for later processing</span></span><br><span class="line">       <span class="comment">// 取出所有相关Watcher后，放入waitingEvents队列</span></span><br><span class="line">       waitingEvents.add(pair);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 根据通知事件，从ZKWatchManager中取出所有相关Watcher</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">materialize</span><span class="params">(Watcher.Event.KeeperState state, Watcher.Event.EventType type, String clientPath)</span> </span>&#123;</span><br><span class="line">       Set&lt;Watcher&gt; result = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line">       <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">       ...</span><br><span class="line">           <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">           <span class="keyword">case</span> NodeCreated:</span><br><span class="line">               <span class="comment">// 从相应的Watcher存储中去除对应的Watcher，客户端的Watcher也是一次性的</span></span><br><span class="line">               <span class="keyword">synchronized</span> (dataWatches) &#123;</span><br><span class="line">                   addTo(dataWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">synchronized</span> (existWatches) &#123;</span><br><span class="line">                   addTo(existWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTo</span><span class="params">(Set&lt;Watcher&gt; from, Set&lt;Watcher&gt; to)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (from != <span class="keyword">null</span>) &#123;</span><br><span class="line">           to.addAll(from);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>EventThread的run方法不断对waitingEvents队列进行处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           isRunning = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">               Object event = waitingEvents.take();</span><br><span class="line">               <span class="keyword">if</span> (event == eventOfDeath) &#123;</span><br><span class="line">                   wasKilled = <span class="keyword">true</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   processEvent(event);</span><br><span class="line">               &#125;</span><br><span class="line">               ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (event <span class="keyword">instanceof</span> WatcherSetEventPair) &#123;</span><br><span class="line">               <span class="comment">// each watcher will process the event</span></span><br><span class="line">               WatcherSetEventPair pair = (WatcherSetEventPair) event;</span><br><span class="line">               <span class="comment">// 每次从waitingEvents中取出一个Watcher并进行串行同步处理</span></span><br><span class="line">               <span class="keyword">for</span> (Watcher watcher : pair.watchers) &#123;</span><br><span class="line">                   <span class="keyword">try</span>&#123;</span><br><span class="line">                       <span class="comment">// 调用process完成回调</span></span><br><span class="line">                       watcher.process(pair.event);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           ...</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li></ul><h4 id="1-4-4-Watcher特性"><a href="#1-4-4-Watcher特性" class="headerlink" title="1.4.4 Watcher特性"></a>1.4.4 Watcher特性</h4><ul><li><strong>一次性：</strong>无论是服务端还是客户端，一旦Watcher被触发，就会从ZK存储中删除，所以使用时要反复注册，这样能够减轻服务器的压力。</li><li><strong>客户端串行执行：</strong>客户端Watcher回调时一个串行同步过程，保证了执行顺序。</li><li><strong>轻量：</strong>WatchedEvent是Watcher通知机制的最小通知单元，只包含三部分内容（通知状态、事件类型和节点路径），客户端需要主动去获取更新数据。客户端向服务端注册Watcher时，没有把真实Watcher对象传给服务端，只是在请求中使用Boolean类型标记，服务端仅仅保存了当前连接的ServerCnxn对象。</li></ul><h3 id="1-5-ACL—保障数据安全"><a href="#1-5-ACL—保障数据安全" class="headerlink" title="1.5 ACL—保障数据安全"></a>1.5 ACL—保障数据安全</h3><h4 id="1-5-1-权限模式-Scheme"><a href="#1-5-1-权限模式-Scheme" class="headerlink" title="1.5.1 权限模式-Scheme"></a>1.5.1 权限模式-Scheme</h4><p>权限模式用来确定权限验证过程中使用的检验策略，常用的四种权限模式：</p><ul><li><p><strong>IP：</strong>通过IP地址粒度进行权限控制，也支持按网段的方式进行配置，如 <code>ip:192.168.0.1/24</code> 表示针对 <code>192.168.0.*</code> IP段进行权限控制。</p></li><li><p><strong>Digest：</strong></p><ul><li><p>最常用的模式，类似于 <code>username:password</code> 形式的权限表示进行权限控制来区分不同应用。</p></li><li><p>ZK先后会进行两次编码处理，<strong>SHA-1算法加密</strong>和<strong>BASE64编码</strong>，由 <code>DigestAuthenticationProvider.generateDigest(String idPassword)</code> 函数进行封装。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DigestAuthenticationProviderUsage</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        System.out.println(DigestAuthenticationProvider.generateDigest(<span class="string">&quot;foo:zk-book&quot;</span>));</span><br><span class="line">        <span class="comment">// 输出：foo:kWN6aNS.... 混淆无序的字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>World：</strong>最开放的模式，数据节点访问对所有用户开放，只有一个权限标识 <code>world:anyone</code> 。</p></li><li><p><strong>Super：</strong>超级用户模式，可以对任意ZK节点进行任意操作。</p></li></ul><h4 id="1-5-2-授权对象-ID"><a href="#1-5-2-授权对象-ID" class="headerlink" title="1.5.2 授权对象-ID"></a>1.5.2 授权对象-ID</h4><p>授权对象指权限赋予的用户或一个指定实体，如IP地址或机器：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010115.png"></p><h4 id="1-5-3-权限-Permission"><a href="#1-5-3-权限-Permission" class="headerlink" title="1.5.3 权限-Permission"></a>1.5.3 权限-Permission</h4><p>权限指通过权限检查后允许执行的操作，分为5类：</p><ul><li><strong>CREATE：</strong>数据节点的创建权限，允许授权对象在该数据节点下创建子节点。</li><li><strong>DELETE：</strong>子节点的删除权限，允许授权对象删除该数据节点的子节点。</li><li><strong>READ：</strong>数据节点的读取权限，允许授权对象访问该数据节点并读取其数据内容或子节点列表等。</li><li><strong>WRITE：</strong>数据节点的更新权限，允许授权对象对该数据节点进行更新操作。</li><li><strong>ADMIN：</strong>数据节点的管理权限，允许授权对象对该数据节点进行ACL相关的设置操作。</li></ul><h4 id="1-5-4-自定义扩展"><a href="#1-5-4-自定义扩展" class="headerlink" title="1.5.4 自定义扩展"></a>1.5.4 自定义扩展</h4><p>ZK允许开发人员用过指定方式对ZK进行扩展，即 Pluggable ZooKeeper Authentication 机制，实现接口AuthenticationProvider：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZK默认的几种权限模式对应DigestAuthenticationProvider和IPAuthenticationProvider</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getScheme</span><span class="params">()</span></span>;</span><br><span class="line">    KeeperException.<span class="function">Code <span class="title">handleAuthentication</span><span class="params">(ServerCnxn cnxn, <span class="keyword">byte</span> authData[])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String id, String aclExpr)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现自定义权限控制器后，需要将其注册到ZK中，有两种方式：</p><ul><li><p><strong>系统属性：</strong>启动参数添加配置信息</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-Dzookeeper.authProvider.1</span>=<span class="string">com.zkbook.CustomAuthenticationProvider</span></span><br></pre></td></tr></table></figure></li><li><p><strong>配置文件：</strong><code>zoo.cfg</code> 中添加配置信息</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">authProvider.1</span>=<span class="string">com.zkbook.CustomAuthenticationProvider</span></span><br></pre></td></tr></table></figure></li></ul><p>权限控制器注册采用了<strong>延迟加载</strong>的策略，第一次处理包含权限控制请求时才会进行权限控制器的初始化，同时ZK将所有控制器注册到ProviderRegistry中，顺序为：DigestAuthenticationProvider和IPAuthenticationProvider先初始化，然后扫描 <code>zookeeper.authProvider</code> 获取自定义控制器并初始化。</p><h4 id="1-5-5-ACL管理"><a href="#1-5-5-ACL管理" class="headerlink" title="1.5.5 ACL管理"></a>1.5.5 ACL管理</h4><p>通过zkCli脚本登录ZK服务器后，通过两种方式设置ACL：</p><ul><li><p><strong>数据节点创建的同时进行ACL权限的设置：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 命令格式</span></span><br><span class="line">create [-s] [-e] path data acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e /zk-book init digest: foo:MiHs3Eiylp......</span></span><br><span class="line">Created /zk-book</span><br><span class="line"><span class="meta">$</span><span class="bash"> getAcl /zk-book</span></span><br><span class="line">&#x27;digest,&#x27;foo:MiHs3Eiylp......</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 <code>setAcl</code> 命令单独对已经存在的数据节点进行ACL设置：</strong>，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">setAcl path acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e /zk-book init</span></span><br><span class="line">Created /zk-book</span><br><span class="line"><span class="meta">$</span><span class="bash"> setAcl /zk-book digest:foo:MiHs3Eiylp......</span></span><br><span class="line">cZxid = 0x400000042</span><br><span class="line">ctime = ......</span><br><span class="line">mZxid = 0x400000042</span><br><span class="line">mtime = ......</span><br><span class="line">pZxid = 0x400000042</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 1</span><br><span class="line">ephemeralOwner = 0x1472ff49b020003</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br><span class="line"><span class="meta">$</span><span class="bash"> getAcl /zk-book</span></span><br><span class="line">&#x27;digest,&#x27;foo:MiHs3Eiylp......</span><br></pre></td></tr></table></figure></li></ul><p>一旦对一个数据节点设置了ACL权限控制，没有授权的ZK客户端就无法访问该数据节点，但如果一个持久数据节点包含了ACL权限控制，其创建客户端已不再使用，这些数据节点如何清理？<strong>Super模式</strong>下使用超级管理员权限。</p><p>ZK服务器启动时添加如下系统属性：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># foo表示管理员名，后续字符串由管理员自主配置</span></span><br><span class="line"><span class="meta">-Dzookeeper.DigestAuthenticationProvider.superDigest</span>=<span class="string">foo:MiHs3Eiylp......</span></span><br></pre></td></tr></table></figure><p>应用中使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSampleSuper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String PATH = <span class="string">&quot;/zk-book&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ZooKeeper zk1 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">5000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk1.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:true&quot;</span>.getBytes());</span><br><span class="line">        zk1.create(PATH, <span class="string">&quot;init&quot;</span>.getBytes(), Ids.CREATOR_ALL_ACL, CreateMode.EPHEMERAL);</span><br><span class="line">        ZooKeeper zk2 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">50000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk2.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:zk-book&quot;</span>.getBytes());</span><br><span class="line">        System.out.println(zk2.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">        ZooKeeper zk3 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">50000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk3.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:false&quot;</span>.getBytes());</span><br><span class="line">        System.out.println(zk3.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 org.apache.zookeeper.KeeperException$NoAuthException: KeeperErrorCode = NoAuth for /zk-book foo:false无法通过权限校验，foo:zk-book超级管理员可以随意进行操作</span></span><br></pre></td></tr></table></figure><h2 id="二-序列化与协议"><a href="#二-序列化与协议" class="headerlink" title="二. 序列化与协议"></a>二. 序列化与协议</h2><p>网络通信的首要问题是解决数据的序列号和反序列化操作。</p><h3 id="2-1-Jute简介"><a href="#2-1-Jute简介" class="headerlink" title="2.1 Jute简介"></a>2.1 Jute简介</h3><p>Jute即ZK中的序列号组件，前身是Hadoop Record IO中的序列化组件，后来由于Apache Avro序列化框架有出色的跨语言特性、丰富的数据结构和对MapReduce的天然支持，且非常方便用于RPC调用，所以在0.21.0版本代替了Record IO。</p><p>ZooKeeper也曾尝试使用Apache Avro、Thrift或Google的protobuf来替换Jute，但考虑新老版本的兼容而未能推进，并且Jute的序列化能力一直都不是ZK的性能瓶颈。</p><h3 id="2-2-Jute使用"><a href="#2-2-Jute使用" class="headerlink" title="2.2 Jute使用"></a>2.2 Jute使用</h3><p>使用Jute来对Java对象进行序列化和反序列化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockReqHeader</span> <span class="keyword">implements</span> <span class="title">Record</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sessionId;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutputArchive a_, String tag)</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        a_.startRecord(<span class="keyword">this</span>, tag);</span><br><span class="line">        a_.writeLong(sessionId, <span class="string">&quot;sessionId&quot;</span>);</span><br><span class="line">        a_.writeLong(type, <span class="string">&quot;type&quot;</span>);</span><br><span class="line">        a_.endRecord(<span class="keyword">this</span>, tag);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(InputArchive a_, String tag)</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        a_.startRecord(tag);</span><br><span class="line">        sessionId = a_.readLong(<span class="string">&quot;sessionId&quot;</span>);</span><br><span class="line">        type = a_.readLong(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        a_.endRecord(tag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始序列化</span></span><br><span class="line">ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">   BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line"><span class="keyword">new</span> MockReqHeader(<span class="number">0x34221eccb92a34el</span>, <span class="string">&quot;ping&quot;</span>).serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line"><span class="comment">// 此处通常是TCP网络传输对象</span></span><br><span class="line">ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line"><span class="comment">// 开始反序列化</span></span><br><span class="line">ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(bb);</span><br><span class="line">BinaryInputArchive bbia = BinaryOutputArchive.getArchive(bbis);</span><br><span class="line"><span class="keyword">new</span> MockReqHeader();</span><br><span class="line">header2.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">bbis.close();</span><br><span class="line">baos.close();</span><br></pre></td></tr></table></figure><p>流程：</p><ol><li>实体类实现Record接口的serialize和deserialize方法。</li><li>构建一个序列化器BinaryOutputArchive。</li><li>序列化，调用实体类的serialize方法，将对象序列化到指定tag。</li><li>反序列化，调用实体类的deserialize方法，从指定tag中反序列化出数据内容。</li></ol><h3 id="2-3-Jute深入"><a href="#2-3-Jute深入" class="headerlink" title="2.3 Jute深入"></a>2.3 Jute深入</h3><h4 id="（1）Record接口"><a href="#（1）Record接口" class="headerlink" title="（1）Record接口"></a>（1）Record接口</h4><p>暂无。</p><h4 id="（2）OutputArchive和InputArchive"><a href="#（2）OutputArchive和InputArchive" class="headerlink" title="（2）OutputArchive和InputArchive"></a>（2）OutputArchive和InputArchive</h4><p>暂无。</p><h3 id="2-4-通信协议"><a href="#2-4-通信协议" class="headerlink" title="2.4 通信协议"></a>2.4 通信协议</h3><p>ZK基于TCP/IP协议实现通信协议，请求和响应结构如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010116.png"></p><h4 id="（1）请求和响应结构"><a href="#（1）请求和响应结构" class="headerlink" title="（1）请求和响应结构"></a>（1）请求和响应结构</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010117.png"></p><ul><li><p><strong>请求头（RequestHeader）：</strong></p><ul><li><strong>xid：</strong>记录客户端请求发起的先后序号，确保单个客户端请求的响应顺序。</li><li><strong>type：</strong>请求的操作类型，定义在 OpCode 中<ul><li>OpCode.create：创建节点</li><li>OpCode.delete：删除节点</li><li>OpCode.getData：获取节点数据</li><li>……</li></ul></li></ul></li><li><p><strong>请求体（Request）：</strong>请求的主体，包含所有操作内容。不同请求类型的请求体结构是不同的。</p><ul><li><p><strong>会话创建（ConnectRequest）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 协议版本号</span></span><br><span class="line">        <span class="keyword">int</span> protocolVersion;</span><br><span class="line">        <span class="comment">// 最近一次收到的服务器ZXID</span></span><br><span class="line">        <span class="keyword">long</span> lastZxidSeen;</span><br><span class="line">        <span class="comment">// 会话超时时间</span></span><br><span class="line">        <span class="keyword">int</span> timeOut;</span><br><span class="line">        <span class="comment">// 会话标识</span></span><br><span class="line">        <span class="keyword">long</span> sessionId;</span><br><span class="line">        <span class="comment">// 会话密码</span></span><br><span class="line">        buffer passwd;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>获取节点数据（GetDataRequest）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetDataRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 数据节点的节点路径</span></span><br><span class="line">        ustring path;</span><br><span class="line">        <span class="comment">// 是否注册Watcher</span></span><br><span class="line">        <span class="keyword">boolean</span> watch;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>更新节点数据（SetDataRequest）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SetDataRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 数据节点的节点路径</span></span><br><span class="line">        ustring path;</span><br><span class="line">        <span class="comment">// 数据内容</span></span><br><span class="line">        buffer data;</span><br><span class="line">        <span class="comment">// 节点数据的期望版本号</span></span><br><span class="line">        <span class="keyword">int</span> version;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>响应头（ReplyHeader）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplyHeader</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对应请求发起的先后序号，原值返回</span></span><br><span class="line">        <span class="keyword">int</span> xid;</span><br><span class="line">        <span class="comment">// ZK服务器上的最新事务ID</span></span><br><span class="line">        <span class="keyword">long</span> zxid;</span><br><span class="line">        <span class="comment">// 错误码，出现异常时标识出来</span></span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>响应体（Response）：</strong></p><ul><li><p><strong>会话创建（ConnectResponse）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 协议版本号</span></span><br><span class="line">        <span class="keyword">int</span> protocolVersion;</span><br><span class="line">        <span class="comment">// 会话超时时间</span></span><br><span class="line">        <span class="keyword">int</span> timeOut;</span><br><span class="line">        <span class="comment">// 会话标识</span></span><br><span class="line">        <span class="keyword">long</span> sessionId;</span><br><span class="line">        <span class="comment">// 会话密码</span></span><br><span class="line">        buffer passwd;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>获取节点数据（GetDataResponse）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetDataResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 数据内容</span></span><br><span class="line">        buffer data;</span><br><span class="line">        <span class="comment">// 节点状态</span></span><br><span class="line">        org.apache.zookeeper.data.Stat stat;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>更新节点数据（SetDataResponse）：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SetDataResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 节点状态</span></span><br><span class="line">        org.apache.zookeeper.data.Stat stat;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010120.png"></p><h4 id="（2）实例"><a href="#（2）实例" class="headerlink" title="（2）实例"></a>（2）实例</h4><p>请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASimpleGetDataRequest</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ZooKeeper zk = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper&quot;</span>, <span class="number">5000</span>, <span class="keyword">new</span> ASimpleGetDataRequest());</span><br><span class="line">        <span class="comment">// 获取节点数据</span></span><br><span class="line">        zk.getData(<span class="string">&quot;/$7_2_4/get_data&quot;</span>, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Wireshark获取到其发送的网络TCP包。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010118.png"></p><p>十六进制表示含义如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010119.png"></p><p>响应：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010121.png"></p><p>十六进制表示含义如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010122.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：数据模型ZNode、节点类型、Watcher、ACL、Jute和通信协议等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（四）应用场景与实现</title>
    <link href="http://linyishui.top/2021052001.html"/>
    <id>http://linyishui.top/2021052001.html</id>
    <published>2021-05-20T07:03:45.000Z</published>
    <updated>2021-07-18T15:36:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（四）应用场景与实现"><a href="#ZooKeeper（四）应用场景与实现" class="headerlink" title="ZooKeeper（四）应用场景与实现"></a>ZooKeeper（四）应用场景与实现</h1><h2 id="一-典型应用场景"><a href="#一-典型应用场景" class="headerlink" title="一. 典型应用场景"></a>一. 典型应用场景</h2><p>ZooKeeper是一个高可用的基于发布/订阅模式的分布式数据管理和协调框架，基于ZAB算法，ZK可以很好的保证分布式环境的数据一致性。</p><h3 id="1-1-数据发布-订阅"><a href="#1-1-数据发布-订阅" class="headerlink" title="1.1 数据发布/订阅"></a>1.1 数据发布/订阅</h3><p>数据发布/订阅（配置中心）：<strong>发布者将数据发布到ZK的一个或一系列节点上，订阅者进行订阅，从而动态的获取数据，实现配置信息的集中式管理和数据的动态更新</strong>。</p><p>发布/订阅系统一般都包含两种设计模式：<strong>推和拉模式</strong>。推模式下服务端主动将数据更新发送给所有订阅的客户端，拉模式下则是由客户端主动发起请求获取最新数据（轮询）。ZK将推拉结合，<strong>客户端向服务端注册自己感兴趣的节点，当节点数据变更，服务端发送Watcher事件通知，客户端收到消息后主动获取最新数据</strong>。</p><p>案例：系统中需要一些通用的配置信息，如机器列表信息、运行时的开关配置、数据库配置信息等，这些全局的配置信息通常有3个特性：</p><ul><li>数据量较小</li><li>数据内容会在运行时发生动态变化</li><li>集群中各机器共享，配置一致</li></ul><p>单机系统通常会采用本地配置文件或内存变量（JMX来实现对系统运行时内存变量的更新）的方式，但对于分布式系统来说这两张方式比较难管理。</p><ul><li><p><strong>配置存储：</strong></p><p>首先将初始化配置存放在ZK上，选取一个数据节点，如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010101.png"></p><p>写入配置信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#DBCP</span></span><br><span class="line"><span class="string">dbcp.driverClassName=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">dbcp.dbJDBCUrl=jdbc:mysql://1.1.1.1:3306/taokeeper</span></span><br><span class="line"><span class="string">dbcp.characterEncoding=GBK</span></span><br><span class="line"><span class="string">dbcp.username=xiaoming</span></span><br><span class="line"><span class="string">dbcp.password=123456</span></span><br><span class="line"><span class="string">dbcp.maxActive=30</span></span><br><span class="line"><span class="string">dbcp.maxIdle=10</span></span><br><span class="line"><span class="string">dbcp.maxWait=10000</span></span><br></pre></td></tr></table></figure></li><li><p><strong>配置获取：</strong>每个客户端启动时从ZK节点上读取配置信息，并且在该配置节点上注册一个数据变更的Watcher监听，一旦数据发生变更，所有订阅的客户端都能收到通知。</p></li><li><p><strong>配置变更：</strong>运行时可能要切换数据库，此时只需对ZK节点上的配置信息进行更改。</p></li></ul><h3 id="1-2-负载均衡"><a href="#1-2-负载均衡" class="headerlink" title="1.2 负载均衡"></a>1.2 负载均衡</h3><p>负载均衡即对多台机器、网络连接、CPU、磁盘驱动或其他资源进行分配负载，以达到优化资源使用、最大化吞吐率、最小化响应时间和避免过载的目的。</p><p>分布式系统具有对等性，为了保证系统的高可用性，通常采用副本的方式来对数据和服务进行部署，对于消费者而言需要在这些对等的服务提供方选择一个来执行业务逻辑。</p><p>典型的负载均衡如<strong>DNS</strong>，即<strong>域名系统</strong>（Domain Name System），可以看作是一个超大规模的分布式映射表，用于将域名和IP地址进行一一映射，方便用户使用域名来访问互联网站点。</p><p>我们只能注册有限的域名，当系统规模变大，很难通过统一的DNS配置来管理。可以使用本地HOST绑定来实现域名解析的工作，解决了域名紧张的问题，可以随时修改域名和IP的映射，但机器规模扩大时，系统上线前要在每台机器上绑定域名会非常不方便，如果需要临时更新域名还需要到每台机器上变更。</p><h4 id="（1）动态DNS服务"><a href="#（1）动态DNS服务" class="headerlink" title="（1）动态DNS服务"></a>（1）动态DNS服务</h4><ul><li><p><strong>配置管理：</strong></p><p>首先要在ZK上创建一个节点进行域名配置：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010102.png"></p><p>每个应用都可以创建一个属于自己的数据节点作为域名配置的根节点，配置清单：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#单个IP:PORT</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br><span class="line"><span class="comment">#多个IP:PORT</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080,</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure></li><li><p><strong>域名解析：</strong></p><p>传统DNS解析的工作由操作系统的域名和IP地址映射机制或域名解析服务器完成。而ZK实现的DDNS则需要每个应用自己从ZK数据节点上获取一份IP地址和端口的配置，并自行解析。每个应用都会在域名节点注册一个数据变更Watcher监听。</p></li><li><p><strong>域名变更：</strong></p><p>运行过程中要更新IP地址或端口时，只需对指定的域名节点进行更新操作，ZK会向订阅的客户端发送通知。</p></li></ul><h4 id="（2）自动化的DNS服务"><a href="#（2）自动化的DNS服务" class="headerlink" title="（2）自动化的DNS服务"></a>（2）自动化的DNS服务</h4><p>上述实现在域名变更的环节还是需要人为的介入取修改域名节点上的IP地址和端口，ZK实现了自动化的DNS服务为了实现服务的自动化定位，系统架构如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010103.png"></p><p>重要的组件：</p><ul><li><strong>Register：</strong>集群负责域名的动态注册</li><li><strong>Dispatcher：</strong>集群负责域名解析</li><li><strong>Scanner：</strong>集群负责检测以及维护服务状态（探测服务的可用性、屏蔽异常服务节点等）</li><li><strong>SDK：</strong>提供各种语言的系统接入协议，提供服务注册以及查询接口</li><li><strong>Monitor：</strong>负责收集服务信息以及对DDNS自身状态的监控</li><li><strong>Controller：</strong>后台管理的Console，负责授权管理、流量控制、静态配置服务和手动屏蔽服务等功能，运维人员可以在上面管理Register、Dispatcher、Scanner等集群。</li></ul><p>自动化DNS流程：</p><ul><li><p><strong>域名注册：</strong></p><p>服务提供者在启动过程把自己的域名信息注册到 Register 集群中去</p><ol><li>服务提供者通过SDK提供的API接口，将域名、IP地址和端口发送给 Register 集群。</li><li> Register 收到后根据域名将信息写入相应的ZK域名节点中。</li></ol></li><li><p><strong>域名解析：</strong>与域名注册过程相反，服务消费者在使用域名时，会向 Dispatcher 发出域名解析请求。Dispatcher 收到请求后，会从ZK上指定域名节点读取相应的IP:PORT列表，通过一定的策略选取一个返回给前端应用。</p></li><li><p><strong>域名探测：</strong></p><p>指DDNS系统对域名下所有注册的IP地址和端口进行可用性检测/健康度检测，一般有两种方式：</p><ol><li>服务端主动发起健康度心跳检测，需要在服务端和客户端之间建立起一个TCP长链接；</li><li>客户端主动向服务端发起健康度心跳检测。</li></ol><p>DDNS架构中的域名检测使用的是服务提供者主动定时向Scanner进行状态汇报的模式（第二种）。Scanner负责记录每个服务提供者最近一次的状态汇报时间，一旦超过5秒没有收到状态汇报就认定此IP和端口不可用，并进行域名清理过程。</p><p>域名清理，Scanner会在ZK中找到对于域名节点，并将IP和端口配置从节点内容中移除。</p></li></ul><h3 id="1-3-命名服务"><a href="#1-3-命名服务" class="headerlink" title="1.3 命名服务"></a>1.3 命名服务</h3><p>分布式系统中被命名的实体通常是集群中的机器、提供的服务地址或远程对象等，较常见的是一些分布式服务框架RPC或RMI中的服务地址列表，通过命名服务，客户端应用能够根据指定名字来获取资源的实体、服务地址和提供者的信息等。</p><ul><li>Java的JNDI（Java命名与目录接口，Java Naming and Directory Interface）是一种典型的命名服务，标准的J2EE容器都提供了对JNDI规范的实现，可以用来完成数据源的配置和管理。</li><li>ZK的命名服务，上层应用只需一个全局唯一的名字，类似于唯一主键。</li></ul><p>使用ZK来实现一套分布式全局唯一ID的分配机制：数据库的单库单表可以使用自带的 <code>auto_increment</code> 属性来自动为每条记录生成一个唯一ID，但随着数据库数据规模不断增大，分库分表后这个属性就只能针对单一表中记录自动生成ID。</p><p>UUID（通用唯一识别码，Universally Unique Identifier）在分布式系统中常用于作唯一标识元素标准，一个标准的UUID是一个包含32位字符和4个短线的字符串。</p><p>UUID的缺点：</p><ul><li>长度过长：生成的字符串过长，相比INT类型存储开销更大。</li><li>含义不明：字符串本身没有含义。</li></ul><p>可以通过ZK节点来生成全局唯一ID：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010104.png"></p><p>ZK中每个数据节点都能维护一份子节点的顺序队列，当客户端创建一个顺序子节点时，ZK会自动以后缀的形式在子节点上添加一个序号：</p><ol><li>所有客户端根据自己的任务类型，在指定类型的任务下通过调用 <code>create()</code> 接口来创建一个顺序节点（如“job-”节点）。</li><li>节点创建完毕， <code>create()</code> 返回一个完整的节点名（如“job-0000000003”）。</li><li>客户端拿到返回值后，拼接上type类型（如“type2-job-0000000003”）作为全局唯一ID。</li></ol><h3 id="1-4-分布式协调-通知"><a href="#1-4-分布式协调-通知" class="headerlink" title="1.4 分布式协调/通知"></a>1.4 分布式协调/通知</h3><p>分布式系统需要引入一个协调者（Coordinator）控制整个系统的运行流程（如分布式事务的处理或机器间的互相协调等）便于将分布式协调的职责从应用本身抽离，减少系统间的耦合性，提供可扩展性。</p><p>基于ZK实现的分布式协调/通知通常做法：不同的客户端都对ZK上同一个数据节点进行Watcher注册，监听数据节点的变化，如果发生变化，所有订阅的客户端都能收到并处理。</p><h4 id="（1）MySQL数据复制总线-Mysql-Replicator"><a href="#（1）MySQL数据复制总线-Mysql-Replicator" class="headerlink" title="（1）MySQL数据复制总线-Mysql_Replicator"></a>（1）MySQL数据复制总线-Mysql_Replicator</h4><p>MySQL数据复制总线是一个实时数据复制框架，<strong>用于在不同的MySQL数据库实例之间进行异步数据复制合数据变化通知</strong>。</p><p>系统是由一个MySQL数据库集群、消息队列系统、任务管理监控平台以及ZK集群等组件共同构成的一个包含数据生产者、复制管道和数据消费者等部分的数据总线系统：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010105.png"></p><p>ZK负责一系列的分布式协调工作，根据功能将数据复制组件划分为三个核心模块，每个模块作为独立的进程运行在服务端，运行时数据和配置信息保存在ZK上：</p><ul><li><strong>Core：</strong>实现了数据复制的核心逻辑，将数据复制封装成管道，并抽象出生产者和消费者两个概念，生产者通常是MySQL的Binlog日志。</li><li><strong>Server：</strong>负责启动和停止复制任务。</li><li><strong>Monitor：</strong>负责监控任务的运行状态，如果在数据复制期间发生异常或故障会告警。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010106.png"></p><h4 id="（2）Core进行分布式协调的流程"><a href="#（2）Core进行分布式协调的流程" class="headerlink" title="（2）Core进行分布式协调的流程"></a>（2）Core进行分布式协调的流程</h4><ol><li><p><strong>任务注册：</strong></p><p>Core进程启动时，首先向 <code>/mysql_replicator/tasks</code> 节点（任务列表节点）注册任务。当注册过程发现子节点已存在，表示已有其他Task机器注册了该任务，以下为“复制热门商品”的任务：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010107.png"></p></li><li><p><strong>任务热备份：</strong></p><ul><li>复制组件采用热备份的容灾方式来应对复制任务可能会遇到的故障，即0将同一个复制任务部署在不同的主机上，主备机器通过ZK互相检测运行健康状况。</li><li>实现热备方案，不管第一步是否创建了任务节点，每台任务机器都要在 <code>/mysql_replicator/tasks/copy_hot_item/instances</code> 节点上将自己的主机名注册上去。注册的是一个临时的顺序节点 <code>/mysql_replicator/tasks/copy_hot_item/instances/[Hostname]-1</code> 最后的序列号是临时顺序节点的精华。</li><li>完成子节点创建后，每台机器都可以通过对比自己是否是所有子节点序号中最小的，如果是就将自己的运行状态置为 RUNNING，其余的机器则设置为 STANDBY，即<strong>小序号优先</strong>。</li></ul></li><li><p><strong>热备切换：</strong></p><ul><li>任务机器在完成状态标识后就可以工作了，RUNNING进行数据复制，STANDBY则进入待命状态，一旦RUNNING的机器出现故障，取一个待命状态最小的机器替补执行。</li><li>所以待命的机器都要在 <code>/mysql_replicator/tasks/copy_hot_item/instances</code> 节点注册一个Watcher监听子节点列表变更，订阅所有任务机器的变化情况，RUNNING机器宕机与ZK断开连接后节点会消失，其余机器收到通知后开启新一轮的RUNNING选举。</li></ul></li><li><p><strong>记录执行状态：</strong>RUNNING机器需要将运行时的上下文保留给STANDBY机器，MySQL选择 <code>/mysql_replicator/tasks/copy_hot_item/lastCommit</code> 作为Binlog日志消费位点的存储节点， RUNNING定时写入当前信息。</p></li></ol><h4 id="（3）Server管理Core组件"><a href="#（3）Server管理Core组件" class="headerlink" title="（3）Server管理Core组件"></a>（3）Server管理Core组件</h4><ol><li><p><strong>控制台协调：</strong>Server的主要工作是通过ZK来对不同任务进行控制和协调，Server将每个复制任务对于生产者的元数据（库名、表名、用户名和密码等数据库信息以及消费者相关信息）以配置的形式写入任务节点 <code>/mysql_replicator/tasks/copy_hot_item</code> 使任务的所有机器都能能共享配置。</p></li><li><p><strong>冷备切换：</strong></p><p>在一定规模的分布式项目中，往往有许多MySQL实例需要进行数据复制，每个实例都要对应一个复制任务，如果每个任务都进行双机热备份会消耗太多的机器。</p><p>根据这个问题设计一种新的冷备份的方案，它对所有任务进行分组：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010108.png"></p><p>Core进程被配置了所属Group，<strong>冷备份扫描</strong>：</p><ul><li>假如一个Core进程被标记了group1，启动后会获取对应节点下所有的Task列表。</li><li>如果找到了任务 <code>copy_hot_item</code> 会遍历instances节点，若没有子节点则创建一个临时的顺序节点 <code>copy_hot_item/instances/[Hostname]-1</code> 。</li><li>类似于热备份的小序号优先，<strong>最小的Core进程标记为RUNNING，不同的是其他Core进程会自动将创建的子节点删除，然后继续遍历下一个Task节点</strong>。</li></ul></li><li><p><strong>冷热备份对比：</strong></p><ul><li>热备份：针对一个任务使用两台机器做备份，由于Watcher通知和临时顺序节点的特性，可以实时的进行协调；机器资源消耗较大。</li><li>冷备份：使用了扫描机制，虽然降低了实时性，但节省了机器资源。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010109.png"></p></li></ol><h4 id="（4）机器间通信方式"><a href="#（4）机器间通信方式" class="headerlink" title="（4）机器间通信方式"></a>（4）机器间通信方式</h4><p>常见分布式系统机器间通信方式：</p><ul><li><strong>心跳检测：</strong>不同机器之间检测彼此是否在正常运行，使用ZK的临时节点实现而不同于常规的PING或TCP长连接。所有机器在ZK的一个指定节点下创建临时子节点，机器之间可以根据临时节点判断对应机器是否存活，这样机器之间不需要直接交互。</li><li><strong>工作进度汇报：</strong>任务分发到不同机器上执行后，需要实时的将自己的执行进度汇报给分发系统，每个任务客户端在指定节点下创建临时子节点：<ul><li>通过判断临时节点是否存在判断对应任务机器是否存活；</li><li>各个任务机器实时的将自己的任务执行进度写入临时节点，中心系统定时的获取。</li></ul></li><li><strong>系统调度：</strong>控制台将指令发送给所有客户端，实际是改ZK节点的数据，数据变更的通知再发送给客户端。</li></ul><p>用ZK来实现分布式通信可以降低系统间的耦合和减少底层网络通信以及协议设计上的重复工作。</p><h3 id="1-5-集群管理"><a href="#1-5-集群管理" class="headerlink" title="1.5 集群管理"></a>1.5 集群管理</h3><p>集群管理包括：</p><ul><li>集群监控：侧重对集群运行时状态的收集</li><li>集群控制：侧重对集群进行操作与控制</li></ul><h4 id="（1）传统Agent的弊端"><a href="#（1）传统Agent的弊端" class="headerlink" title="（1）传统Agent的弊端"></a>（1）传统Agent的弊端</h4><p>传统基于Agent的分布式集群管理体系，每台机器部署一个Agent，负责主动向指定的监控中心汇报状态，来实现集群监控，其弊端：</p><ul><li><strong>大规模升级困难：</strong>大规模升级的情况下，客户端形式的Agent非常麻烦。</li><li><strong>统一的Agent无法满足多样的需求：</strong>Agent可以满足如CPU使用率、负载、内存使用率、网络吞吐以及磁盘容量等基本物理状态的监控，但如果要深入到业务状态（比如监控每个消费者对消息的消费状态，或是分布式任务调度每台任务机器上的任务执行情况）就不适合由统一的Agent来提供。</li><li><strong>编程语言多样性：</strong>传统的Agent需要提供各种语言版的客户端。</li></ul><h4 id="（2）分布式日志收集系统"><a href="#（2）分布式日志收集系统" class="headerlink" title="（2）分布式日志收集系统"></a>（2）分布式日志收集系统</h4><p>分布式日志收集系统要解决的问题：</p><ul><li><strong>变化的日志源机器：</strong>每个应用的机器几乎每天都是变化的，可能是因为</li><li><strong>变化的收集器机器：</strong>日志收集系统自身也会有机器的变更和扩容。</li></ul><p>流程：</p><ul><li><p><strong>注册收集器机器：</strong>在ZK上创建一个节点作为收集器的根节点，每个收集器机器启动时都会在收集器节点下创建自己的节点。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010110.png"></p></li><li><p><strong>任务分发：</strong>待所有收集器都创建好自己的节点，根据子节点数目将所有日志源机器分为对应的若干组，然后将分组后的机器列表分别写到收集器创建的子节点上，每台收集器都可以从自己的节点上获取日志源机器列表。</p></li><li><p><strong>状态汇报：</strong>我们要考虑到机器有随时挂掉的可能，所以要有一个收集器的状态汇报机制，每个收集器机器在创建完自己的节点后还要再对应的子节点上创建一个状态子节点，定期向该节点写入自己的状态信息（类似于心跳检测）。</p></li><li><p><strong>动态分配：</strong>如果收集器挂掉或者扩容，需要动态的进行收集任务的分配。在运行过程中，日志系统始终关注着 <code>/logs/collector</code> 节点下所有子节点的变更，一旦检测到有收集器停止汇报或有新的收集器加入就会进行任务的重新分配。</p><p>将之前分配的任务转移的方法：</p><ul><li><strong>全局动态分配：</strong>系统根据新的收集器机器列表，将所有日志源机器重新进行分组，重新分配给当前所有收集器。</li><li><strong>局部动态分配：</strong>在小范围内进行任务的动态分配，每个收集器在汇报状态的同时也携带自己的负载（非CPU负载而是当前任务的综合评估），当收集器挂掉，就优先分配给负载较低的机器，新的机器加入时也会把负载较高的机器部分任务转移过去。</li></ul></li></ul><p>注意事项：</p><ul><li><strong>节点类型：</strong>每个代表收集器的子节点如果是临时节点，当节点失效时会被立即删除，记录的日志源机器列表也会随之消失，所以应该是持久节点。</li><li><strong>日志系统节点监听：</strong>实际生产运行中，收集器更改状态节点的频率可能很高（小于1秒），且收集器数量会很大，日志系统如果要监听所有节点变化，对应的数据量太过庞大，所以日志系统并没有实时的接收每次节点状态变更，大部分都是没什么用的，而是采用<strong>主动轮询</strong>的方案，只是有一点延时。</li></ul><h4 id="（3）在线云主机管理"><a href="#（3）在线云主机管理" class="headerlink" title="（3）在线云主机管理"></a>（3）在线云主机管理</h4><p>集群机器的监控，对机器的状态尤其是机器在线率统计有较高要求，并能对机器变更有快速的响应：</p><ol><li>如何快速统计出当前生产环境一共有多少台机器？</li><li>如何快速获取到机器上下线情况？</li><li>如何实时监控集群中每台主机的运行时状态？</li></ol><ul><li><p><strong>机器上下线：</strong>新增机器时，先将指定的Agent部署到机器，部署启动后向ZK指定节点进行注册，创建一个临时子节点：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010111.png"></p><p>创建完子节点后，对 <code>/XAE/machines</code> 节点关注的监控中心会收到“子节点变更”的事件，即上线通知；同理也可以收到下线通知。</p></li><li><p><strong>机器监控：</strong>运行过程中，Agent会定时将主机的运行状态信息写入ZK对应主机节点，监控中心通过订阅这些节点数据变更来获取运行时信息。</p></li></ul><h3 id="1-6-Master选举"><a href="#1-6-Master选举" class="headerlink" title="1.6 Master选举"></a>1.6 Master选举</h3><p>分布式系统中，常常需要Master节点来协调其他单元，如一些读写分离的应用场景，客户端的写请求往往是由Master来处理的。</p><p>分布式环境常见场景：集群中所有系统单元需要对前端业务提供数据，如一个经过一系列海量数据处理计算得到的商品ID，让一台机器计算后共享给其他机器来减少重复劳动，系统可以分为客户端集群、分布式缓存系统、海量数据处理总线和ZooKeeper四个部分：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010112.png"></p><p>Client集群每台定时通过ZK完成Master选举，选出的Master进行一系列海量数据处理得到一个结果，将其放置在一个内存/数据库中，并通知其他客户端来获取。</p><p>我们对Master选举的需求是从所有机器中选择一台机器，通常情况下可以使用数据库主键来实现：所有机器插入一条相同主键的记录，成功的一台为Master。但这种方案没法应对Master挂掉的问题，因为关系型数据库无法通知这一事件。</p><p>利用ZooKeeper的强一致性，我们在分布式高并发场景下可以创建一个全局唯一的节点，所以我们可以实现：<strong>每天所有客户端定时创建一个临时节点 <code>/master_election/2013-09-20/binding</code> ，只有一个会成功创建，其就成为了Master，没有创建成功的再次节点上注册一个节点变更的Watcher，监控当前的Master机器是否存活，一旦挂掉就重新进行选举</strong>。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010113.png"></p><h3 id="1-7-分布式锁"><a href="#1-7-分布式锁" class="headerlink" title="1.7 分布式锁"></a>1.7 分布式锁</h3><p>不同主机共享一组资源，需要互斥手段防止彼此的干扰来保证一致性，此时使用分布式锁。关系型数据库本身具有排他性，来实现不同进程的互斥，但容易导致性能瓶颈。</p><h4 id="（1）排他锁"><a href="#（1）排他锁" class="headerlink" title="（1）排他锁"></a>（1）排他锁</h4><p>排他锁（Exclusive Locks，即X锁）又叫写锁或独占锁，当事务A对数据对象O加排他锁，在持有锁期间只允许事务A对O进行读取和更新操作。</p><ul><li><p><strong>定义锁：</strong>Java常用 synchronized 或 ReentrantLock 来定义锁，ZK没有类似的API来使用，而是直接用一个数据节点来表示一个锁（如 <code>/exclusive_lock/lock</code> ）</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010114.png"></p></li><li><p><strong>获取锁：</strong>客户端通过调用 <code>create()</code> 接口在 <code>/exclusive_lock</code> 节点下创建临时子节点，最终只有一个可以创建成功，即获取到了锁，没有获取到的客户端在 <code>/exclusive_lock</code> 节点注册一个子节点变更的Watcher监听。</p></li><li><p><strong>释放锁：</strong>因为锁是一个临时节点，有两种情况会释放锁：</p><ul><li>当前获取锁的客户端集群宕机，ZK上此临时节点会被移除。</li><li>正常执行完业务逻辑，客户端主动删除自己创建的临时节点。</li></ul><p>节点删除后，其他客户端收到通知再次发起分布式锁的获取，整个流程如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010115.png"></p></li></ul><h4 id="（2）共享锁"><a href="#（2）共享锁" class="headerlink" title="（2）共享锁"></a>（2）共享锁</h4><p>共享锁（Shared Locks，简称S锁）又叫读锁，事务A对数据对象O加上共享锁，其他事务只能对O进行读操作和加共享锁，直到所有共享锁释放。</p><ul><li><p><strong>定义锁：</strong>直接用一个数据节点来表示一个锁（如 <code>/shared_lock/192.168.0.1-R-000000001</code> ）</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010116.png"></p></li><li><p><strong>获取锁：</strong>客户端到 <code>/shared_lock</code> 节点下创建一个临时顺序节点，若当前是读请求，就创建R类节点；如果是写请求，就创建W类节点。</p></li><li><p><strong>判断读写顺序：</strong></p><ol><li>创建完节点后，获取 <code>/shared_lock</code> 节点下所有子节点，并注册Watcher变更监听。</li><li>确定自己的节点序号在所有子节点中的顺序。</li><li>读写两种情况：<ul><li>读请求：如果没有比自己序号小的子节点，或是小的节点都是读请求，表示自己已经获取到共享锁，同时开始执行读取逻辑。</li><li>写请求：如果自己不是序号最小的子节点，就要进入等待。</li></ul></li><li>接收到Watcher通知后，重复步骤1。</li></ol></li><li><p><strong>释放锁：</strong>流程同排他锁。</p><p>整个流程如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010117.png"></p></li></ul><h5 id="羊群效应"><a href="#羊群效应" class="headerlink" title="羊群效应"></a>羊群效应</h5><p>上述共享锁实现可以满足机器规模较小的场景（10台以内），当机器规模较大时，针对判断读写顺序步骤结合下图实例，猜想实际运行的情况。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010118.png"></p><p>实际运行：</p><ol><li>192.168.0.1机器首先进行读操作，完成后将首个子节点删除。</li><li>余下4台机器均受到节点移除的通知，重新从 <code>/shared_lock</code> 节点上获取一份新的子节点列表。</li><li>每个机器判断自己的读写顺序，其中192.168.0.2这台机器检测到自己已经是最小机器了，于是开始读操作，而其他机器发现未轮到自己就继续等待。</li><li>继续….</li></ol><p>其中步骤3，该通知发给了所有机器，但实际上只对192.168.0.2这台机器有用，整个流程大量的Watcher通知和子节点列表获取操作重复运行，大部分机器判断的结果都是需要继续等待。<strong>在集群规模较大的场景下，不仅会对ZooKeeper服务器造成巨大的性能影响和网络冲击</strong>，更为严重的是，<strong>若同一时间有多个节点对应的客户端完成事务或是事务中断引起节点消失，ZK服务器就会在短时间内向其余客户端发送大量的事件通知—即羊群效应</strong>。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">经济学里经常用“羊群效应”来描述经济个体的从众跟风心理。“羊群效应”就是比喻人都有一种从众心理，从众心理很容易导致盲从，而盲从往往会陷入骗局或遭到失败。</span><br></pre></td></tr></table></figure><p>产生问题的原因在于没有找准客户端真正的关注点，每个客户端只需关注比自己小的那一个节点的变更情况即可：</p><ol><li>客户端调用 <code>create()</code> 方法创建一个类似于 <code>/shared_lock/[hostname]-请求类型-序号</code> 的临时顺序节点。</li><li>客户端调用 <code>getChildren()</code> 接口来获取所有已经创建的子节点列表，这里不再注册任何Watcher。</li><li>如果无法获取共享锁，就调用 <code>exist()</code> 来对比自己小的那个节点注册Watcher，读写请求情况不一样：<ul><li>读请求：向比自己序号小的最后一个写请求节点注册</li><li>写请求：向比自己序号小的最后一个节点注册</li></ul></li><li>等待Watcher通知，继续进入步骤2。</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010119.png"></p><h3 id="1-8-分布式队列"><a href="#1-8-分布式队列" class="headerlink" title="1.8 分布式队列"></a>1.8 分布式队列</h3><p>分布式队列如常见的消息队列：ActiveMQ、Metamorphosis、Kafka和HornetQ等。分为两大类：常规的先入先出队列、等到队列元素集聚后才统一安排的Barrier模型。</p><h4 id="（1）FIFO-先入先出"><a href="#（1）FIFO-先入先出" class="headerlink" title="（1）FIFO-先入先出"></a>（1）FIFO-先入先出</h4><p>使用ZooKeeper实现FIFO队列类似于全写的共享锁模型，所有客户端到 <code>/queue_fifo</code> 节点下创建一个临时顺序节点。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010120.png"></p><p>创建完节点后，确定执行顺序的步骤：</p><ol><li>通过调用 <code>getChildren()</code> 接口来获取 <code>/queue_fifo</code> 节点下所有的子节点，也就是获取队列中所有的元素。</li><li>确定自己的节点序号在所有子节点中的顺序。</li><li>如果自己不是序号最小的子节点，进入等待，同时向比自己序号小的最后一个节点注册Watcher监听。</li><li>接收到Watcher通知，重复步骤1。</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010121.png"></p><h4 id="（2）Barrier：分布式屏障"><a href="#（2）Barrier：分布式屏障" class="headerlink" title="（2）Barrier：分布式屏障"></a>（2）Barrier：分布式屏障</h4><p>Barrier原意障碍物，在分布式系统中指系统间的一个协调条件，规定一个队列的元素必须都集聚后才能统一进行安排，否则一直等待。</p><p>开始时，<code>/queue_barrier</code> 节点是一个已存在的默认节点，并将其节点的数据内容赋值为一个数字n来代表Barrier值，当子节点数达到n后才能打开Barrier，所有客户端都要到此节点下创建一个临时节点。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010122.png"></p><p>创建完节点后，确定执行顺序的步骤：</p><ol><li>通过调用 <code>getData()</code> 接口获取 <code>/queue_barrier</code> 节点的数据内容：10。</li><li>通过调用 <code>getChildren()</code> 接口获取 <code>/queue_barrier</code> 节点下所有子节点，即获取队列中所有元素，同时注册对子节点列表变更的Watcher监听。</li><li>统计子节点的个数。</li><li>如果子节点个数不足10个，需要进入等待。</li><li>接收到Watcher通知后，重复步骤2。</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010123.png"></p><h2 id="二-大型分布式系统的应用"><a href="#二-大型分布式系统的应用" class="headerlink" title="二. 大型分布式系统的应用"></a>二. 大型分布式系统的应用</h2><p>ZK因为便捷的使用方式、卓越的运行性能和良好的稳定性，已经被广泛的应用在越来越多的大型分布式系统中，用来解决如配置管理、分布式通知/协调、集群管理和Master选举等一系列分布式问题。</p><h3 id="2-1-Hadoop"><a href="#2-1-Hadoop" class="headerlink" title="2.1 Hadoop"></a>2.1 Hadoop</h3><p>Hadoop是Apache开源的一个大型分布式计算框架，定义了一种能够开发和运行处理海量数据的软件规范，用来实现一个在大规模集群中对海量数据进行分布式计算的软件平台。<strong>核心是HDFS和MapReduce，分别提供了对海量数据的存储和计算能力</strong>。0.23.0版本后又引入全新一代MapReduce框架YARN。</p><p>在Hadoop中，ZooKeeper注意用于实现HA（High Availability，高可用）集中于Hadoop Common中的HA模块，HDFS的NameNode与YARN的ResourceManager都是基于此HA模块实现自己的HA功能，YARN还用ZooKeeper来存储应用的运行状态。</p><h4 id="（1）YARN"><a href="#（1）YARN" class="headerlink" title="（1）YARN"></a>（1）YARN</h4><p>YARN是Hadoop为了提高计算节点Master的扩展性，同时为了支持多计算模型和提供资源的细粒度调度而引入的全新一代分布式调度框架。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010124.png"></p><p>YARN由四部分组成：</p><ul><li><strong>ResourceManager（RM）：</strong>核心模块，全局资源管理器，负责整个系统的资源管理和分配，同时接收各个节点（NodeManager）的资源汇报信息，并将信息按照一定的策略分配给各个应用程序（ApplicationMaster）。其内部维护了各个应用程序的ApplicationMaster信息、NodeManager信息以及资源使用信息等。</li><li><strong>NodeManager（NM）</strong></li><li><strong>ApplicationMaster（AM）</strong></li><li><strong>Container</strong></li></ul><h4 id="（2）ResourceManager单点问题"><a href="#（2）ResourceManager单点问题" class="headerlink" title="（2）ResourceManager单点问题"></a>（2）ResourceManager单点问题</h4><p>上述架构可以明显看出存在一个问题：ResourceManager单点问题。YARN设计了一套 <strong>Active/Standby 模式的 ResourceManager HA 架构</strong>：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010125.png"></p><p>运行期间有多个RM并存，只有一个处于Active状态，另外则处于Standby状态，当Active节点无法正常工作时，其余节点通过竞争选举出新的Active节点。</p><p>YARN使用基于ZooKeeper实现的ActiveStandbyElector组件来确定RM的状态，从而实现多个RM的主备切换：</p><ol><li><strong>创建锁节点：</strong>ZK上会有一个类似于 <code>/yarn-leader-election/pseudo-yarn-rm-cluster</code> 的锁节点，所有RM在启动时，都会去竞争写一个Lock子节点 <code>../ActiveStandbyElectorLock</code> ，该子节点类型是临时节点，创建成功的RM切换为Active状态，没有的切换为Standby状态。</li><li><strong>注册Watcher监听：</strong>Standby状态的RM向 <code>../ActiveStandbyElectorLock</code> 节点注册一个Watcher监听节点变更。</li><li><strong>主备切换：</strong>当Active状态的节点出现异常情况，其创建的Lock节点会随之删除，所有Standby状态的RM收到通知后重复步骤1操作。</li></ol><p>HDFS中的NameNode和ResourceManager都使用该组件来实现各自的HA。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010126.png"></p><h4 id="（3）Fencing隔离"><a href="#（3）Fencing隔离" class="headerlink" title="（3）Fencing隔离"></a>（3）Fencing隔离</h4><p>分布式环境中，机器会由于网络闪断或自身负载过高（GC占用时间过长或CPU负载过高）导致无法正常的对外进行及时响应，即“<strong>假死</strong>”的情况。当Active状态的RM1机器发生假死情况，主备切换后RM2成为Active状态，而RM1恢复正常后依然会认为自己处于Active状态，即<strong>分布式脑裂现象</strong>（Brain-Split）。</p><p>Fencing机制利用ZK数据节点的ACL权限控制机制来实现不同RM之间的隔离，多个RM之间通过竞争创建锁节点来实现主备状态的确定，改进为创建的根节点必须携带ZK的ACL信息，目的是为了独占该根节点，防止其他RM对节点进行更新。</p><p>当RM1出现假死后，ZK会将其创建的锁节点移除，RM2创建相应的锁节点并切换为Active状态。RM1恢复之后会试图更新ZK的相关数据，但发现没有权限，说明当前节点不是自己创建的，于是自动切换回Standby状态。</p><h4 id="（4）ResourceManager状态存储"><a href="#（4）ResourceManager状态存储" class="headerlink" title="（4）ResourceManager状态存储"></a>（4）ResourceManager状态存储</h4><p>在ResourceManager中，RMStateStore能够存储一些RM的内部状态信息，包括Application和它们的Attempts信息、Delegation Token及Version Information等，大部分状态信息因为很容易从上下文信息中重构出来所以不需要持久化存储，所以存储的设计方案有：</p><ul><li>基于内存实现，一般用于日常开发测试。</li><li>基于文件系统实现，如HDFS。</li><li>基于ZooKeeper实现。</li></ul><p>Hadoop官方建议使用ZooKeeper来实现，存放在 <code>/rmstore</code> 节点下，RMAppRoot节点下存放的是与各个Application相关的信息，RMDTSecretManagerRoot存放的是安全相关的Token等信息：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010127.png"></p><p>每个Active状态的RM在初始化阶段会从ZK上读取这些状态信息。</p><h3 id="2-2-HBase"><a href="#2-2-HBase" class="headerlink" title="2.2 HBase"></a>2.2 HBase</h3><p>HBase，即 Hadoop Database，是 Google Bigtable 的开源实现，基于Hadoop文件系统设计的面向海量数据的高可靠性、高性能、面向列、可伸缩的分布式存储系统。</p><p>与大部分分布式NoSQL数据库不同的是，HBase针对数据写入具有强一致性的特性，甚至包括索引列也实现了强一致性。</p><p>HBase在实现上遵守了 Google BigTable 论文的设计思想，BigTable使用Chubby来负责分布式状态的协调，Chubby是Google实现的一种基于Paxos算法的分布式锁服务，HBase则采用了开源的ZooKeeper服务来完成对整个系统的分布式协调工作。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010128.png"></p><h4 id="（1）系统冗错"><a href="#（1）系统冗错" class="headerlink" title="（1）系统冗错"></a>（1）系统冗错</h4><p>启动时，每个RegionServer服务器都会到ZK的 <code>/hbase/rs</code> 节点下创建一个信息节点（rs状态节点），同时HMaster对这个节点注册监听。某个RS挂掉，ZK因为一段时间无法收到心跳信息，而删除掉其对应的rs状态节点。</p><p>同时HMaster收到ZK的NodeDelete通知，从而感知到某个节点断开，并立即开始冗错工作，将该RS处理的数据分片Region重新路由到其他节点上，并记录到Meta信息中供客户端查询。</p><p>HMaster不直接通过心跳机制管理RS的状态，因为会随着系统容量的不断增加其管理负担会越来越重。</p><h4 id="（2）RootRegion管理"><a href="#（2）RootRegion管理" class="headerlink" title="（2）RootRegion管理"></a>（2）RootRegion管理</h4><p>数据存储的位置信息记录在元数据分片RootRegion，每次客户端发起请求要知道数据的位置，先要查询RootRegion（存储在ZK上的 <code>/hbase/root-region-server</code> 节点），RootRegion发生变化，如Region的手工移动、Balance或RootRegion所在服务器发生故障，能够通过ZK来感知变化并执行容灾措施，从而保证客户端总能拿到正确的RootRegion信息。</p><h4 id="（3）Region状态管理"><a href="#（3）Region状态管理" class="headerlink" title="（3）Region状态管理"></a>（3）Region状态管理</h4><p>Region是HBase中数据的物理切片，每个Region记录全局数据的一小部分，不同Region间数据不重复。但对于分布式系统来说，Region是会经常因为系统故障、负载均衡、配置修改、Region分裂和合并等发生变更。一旦Region移动就会尽力Offline和重新Online的过程。</p><p>Offline期间数据不能被访问，并且Region的状态变化需要让全局知晓，否则可能导致某些事务性异常。对于HBase集群，Region的数量可能达到10万级别，所以需要依赖ZK来做到。</p><h4 id="（4）分布式SplitLog任务管理"><a href="#（4）分布式SplitLog任务管理" class="headerlink" title="（4）分布式SplitLog任务管理"></a>（4）分布式SplitLog任务管理</h4><p>某台RegionServer服务器挂掉时，总有一部分新写入的数据还没有持久化到HFile中，因此迁移该RegionServer服务时要从HLog中恢复这部分还在内存中的数据，最关键的一步是SplitLog，即HMaster需要遍历该RegionServer服务器的HLog，并按Region切分成小块移动到新的地址下，再进行数据的Replay。</p><p>单个RegionServer的日志量相对庞大（数千个Region，上GB的日志），但又需要系统快速的完成日志的恢复工作，一个可行的方案是将处理HLog的任务分配给多台RegionServer服务器来共同处理，需要一个持久化组件辅助HMaster完成任务的分配。</p><p>HMaster会在ZK上创建一个 <code>/hbase/splitlog</code> 的节点，将哪个RegionServer处理哪个Region这样的信息以列表的形式存放在该节点，各个RegionServer服务器自行到该节点上领取任务并在任务执行成功或失败后更新该节点的信息，以通知HMaster继续进行后续步骤。ZK负责分布式集群中相互通知和信息持久化的角色。</p><h4 id="（5）Replication管理"><a href="#（5）Replication管理" class="headerlink" title="（5）Replication管理"></a>（5）Replication管理</h4><p>HBase通过Replication实现实时的主备同步，从而拥有了容灾和分流等关系型数据库拥有的功能。与传统Replication不同的是，HBase中Replication是多对多的，且每个节点随时都有可能挂掉。</p><p>在ZK上记录一个 <code>/hbase/replication</code> 节点，然后把不同的RegionServer服务器对应的HLog文件名称记录到相应的节点上，HMaster集群会将新增的数据推送给Slave集群，并同时将推送信息记录到ZK上（断点记录），重复以上过程。服务器挂掉时，因为ZK上已经保存了断点信息，只要用这些信息协调推送HLog数据的主节点服务器就可以继续复制。</p><h4 id="（6）ZooKeeper部署"><a href="#（6）ZooKeeper部署" class="headerlink" title="（6）ZooKeeper部署"></a>（6）ZooKeeper部署</h4><p>HBase的启动脚本（hbase-env.sh）中可以选择由HBase启动其自带的默认ZK还是使用一个已有的外部ZK集群。一般建议后者，可以方便多个HBase复用一套ZK集群，但要为每个HBase集群明确指定对应的ZK根节点配置（配置项zookeeper.znode.parent）确保HBase集群间互不干扰。</p><p>对应HBase客户端只要指定ZK的集群地址和对应HBase根节点配置即可。HBase集群启动时会在ZK上逐个添加对应的初始化节点，并在HMaster以及RegionServer进程中进行相应节点的Watcher注册。</p><h3 id="2-3-Kafka"><a href="#2-3-Kafka" class="headerlink" title="2.3 Kafka"></a>2.3 Kafka</h3><p>Kafka是由社交公司LinkedIn于2010年12月份开源的分布式消息系统，由Scala语言开发，广泛运用在Twitter、Netflix和Tumblr等大型互联网站点上。</p><ul><li>主要用于<strong>实现低延迟的发送和收集大量的事件和日志数据</strong>（活跃数据，如网站的PV数和用户访问记录），这些数据以日志的形式记录下来，然后由一个专门的系统进行日志的收集与统计。</li><li>吞吐量极高，整体设计是典型的发布与订阅模式系统。集群中所有服务器都是对等的，可以在不做任何配置更改的情况下实现服务器的添加与删除，消息的生产者和消费者也能做到随意重启和机器上下线。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010129.png"></p><h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><ul><li><strong>消息生产者：</strong>即Producer，生成消息并发送到Kafka服务器上。</li><li><strong>消息消费者：</strong>即Consumer，负责消费Kafka服务器上的消息。</li><li><strong>主题：</strong>即Topic，由用户定义并配置在Kafka服务端，用于建立生产者和消费者之间的订阅关系：生产者发送消息到指定topic下，消费者从该topic消费消息。</li><li><strong>消息分区：</strong>即Partition，一个topic下分多个分区，如topic1分10个分区，由两台服务器提供，每台5个分区，服务器ID为0和1，分区为0-0到0-4和1-0到1-4。消息分区机制和分区数量与消费者的负载均衡机制有很大关系。</li><li><strong>Broker：</strong>即Kafka的服务器，用于存储消息。</li><li><strong>消费者分组：</strong>即Group，用于归组同类消费者，多个消费者可以共同消费一个topic下的消息，这些消费者组成一个分组/集群。</li><li><strong>Offset：</strong>消息存储在Kafka的Broker上，消费者拉取消息数据的过程需要在文件中的偏移量。</li></ul><h4 id="Broker注册"><a href="#Broker注册" class="headerlink" title="Broker注册"></a>Broker注册</h4><p>Broker、Producer和Consumer是分布式部署，Broker虽然相互独立运行但需要一个注册系统统一管理所有节点。ZK上配置一个Broker节点 <code>/broker/ids</code> ，每个Broker服务器启动时都先会到ZK上进行注册 <code>/broker/ids/[0...N]</code> 一个临时节点。</p><p>使用全局唯一ID（Broker  ID）来指代每台Broker服务器，创建完节点后每个Broker会将自己的IP地址和端口等信息写入此节点。</p><h4 id="Topic注册"><a href="#Topic注册" class="headerlink" title="Topic注册"></a>Topic注册</h4><p>Kafka中将同一个Topic的消息分为多个分区并分布到多个Broker上，这些分区信息和Broker的对应信息也由ZK维护，记录在节点 <code>/brokers/topics</code> ，即Topic节点。每个Topic都会对应一个节点 <code>/brokers/topics/[topic]</code> 。</p><p>Broker服务器启动后，会到对应的Topic节点下注册自己的Broker ID，并写入针对该Topic的分区总数 。如临时节点 <code>/brokers/topics/login3-&gt;2</code> 表明Broker ID为3的一台服务器对应，login这个主题的消息提供了2个分区进行消息存储。 </p><h4 id="生产者负载均衡"><a href="#生产者负载均衡" class="headerlink" title="生产者负载均衡"></a>生产者负载均衡</h4><p>因为一个Topic会进行分区并分布到不同的Broker服务器，所以生产者要合理的将消息发送到对应的Broker上，如何进行生产者的负载均衡？</p><ul><li><strong>四层负载均衡：</strong><ul><li>根据生产者的IP地址和端口为器确定一个相关联的Broker，一个生产者对应一个Broker，其消息都发送给此Broker。</li><li>优点：整体架构简单，每个生产者只需维护和Broker的单个TCP链接。</li><li>缺点：无法做到真正的负载均衡，生产者也无法实时感知到Broker的新增和删除，也就无法做到动态的负载均衡。</li></ul></li><li><strong>ZooKeeper负载均衡：</strong><ul><li>生产者通过Broker节点的变化动态感知到Broker服务器列表的变更，生产者注册对“Broker增加与减少”、“Topic的新增与减少”和“Broker与Topic关联关系的变化”等事件注册Watcher监听。</li><li>开发人员可以控制生产者根据一定规则来进行数据分区，而不仅仅是随机算法。即语义分区。</li></ul></li></ul><h4 id="消费者负载均衡"><a href="#消费者负载均衡" class="headerlink" title="消费者负载均衡"></a>消费者负载均衡</h4><p>每个消费者分组都会分配一个全局唯一的Group ID，每个消费者分配一个全局唯一的Consumer ID，格式为 <code>Hostname:UUID</code> 。</p><h5 id="ZK记录消息分区与消费者关系"><a href="#ZK记录消息分区与消费者关系" class="headerlink" title="ZK记录消息分区与消费者关系"></a>ZK记录消息分区与消费者关系</h5><p>每个消息分区有且只能同事有一个消费者进行消息的消费。所以要在ZK上记录下消息分区与消费者之间的对应关系。当消费者确定了对一个分区的消费权利，要将其Consumer ID写入对应分区的临时节点上，如 <code>/consumers/[group_id]/owners/[topic]/[broker_id-partition_id]</code> 最后即消息分区的标识，节点内容就是消费该分区上消息的消费者的Consumer ID。</p><h5 id="ZK记录消费进度Offset"><a href="#ZK记录消费进度Offset" class="headerlink" title="ZK记录消费进度Offset"></a>ZK记录消费进度Offset</h5><p>消费者对分区进行消费时，要定时的将分区消息的消费进度/Offset（节点为 <code>/consumers/[group_id]/offsets/[topic]/[broker_id-partition_id]</code> ，内容为Offset值）记录到ZK上去，以便该消费者重启或其他消费者重新接管该消息分区消费后，能够从之前的进度开始继续消费。</p><h5 id="消费者注册"><a href="#消费者注册" class="headerlink" title="消费者注册"></a>消费者注册</h5><p>消费者服务器初始化启动时加入消费者分组的过程：</p><ol><li><strong>注册到消费者分组Group：</strong><ul><li>消费者启动时，在ZK注册自己的临时节点 <code>/consumers/[group_id]/ids/[consumer_id]</code> </li><li>完成创建后，消费者将自己订阅的Topic信息写入该节点。</li></ul></li><li><strong>对Group中消费者的变化注册监听：</strong>每个消费者会关注所属Group中消费者服务器的变化情况，对 <code>/consumers/[group_id]/ids</code> 节点注册子节点变化的Watcher监听，当消费者发生变化，会触发消费者的负载均衡。</li><li><strong>对Broker服务器的变化注册监听：</strong>消费者对 <code>/broker/ids/[0...N]</code> 中的节点进行监听注册，当Broker服务器列表发生变化，会根据具体情况决定是否需要进行消费者的负载均衡。</li><li><strong>进行消费者负载均衡：</strong>让同一个Topic下不同分区的消息尽量均衡的呗多个消费者消费，当一个Group组内消费者服务器发生变更，或Broker服务器发生变更会触发消费者负载均衡。</li></ol><h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5><p>一个消费者分组中每个消费者记为C<del>1</del>，C<del>2</del>，…，C<del>i</del> ，…. ，C<del>G</del> 。对于消费者C<del>i</del>其对应的消息分区分配策略为：</p><ol><li>设置P<del>T</del>为指定Topic所有的消息分区。</li><li>设置C<del>G</del>为同一个消费者分组中所有的消费者。</li><li>对P<del>T</del>进行排序，使分布在同一个Broker服务器上的分区尽量靠在一起。</li><li>对C<del>G</del>进行排序。</li><li>设置i为C<del>i</del>在C<del>G</del>中位置的索引值，同事hi设置 N = size(P<del>T</del>) / size(C<del>G</del>) 。</li><li>将编号为 <code>i*N~(I+1)*N-1</code> 的消息分区分配给消费者C<del>i</del> 。</li><li>重写更新ZooKeeper上消息分区与消费者 C<del>i</del> 的关系。</li></ol><h2 id="三-阿里巴巴的应用实践"><a href="#三-阿里巴巴的应用实践" class="headerlink" title="三. 阿里巴巴的应用实践"></a>三. 阿里巴巴的应用实践</h2><p>未完待续。</p><h3 id="3-1-消息中间件-Metamorphosis"><a href="#3-1-消息中间件-Metamorphosis" class="headerlink" title="3.1 消息中间件-Metamorphosis"></a>3.1 消息中间件-Metamorphosis</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010130.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010131.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010132.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010133.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010134.png"></p><h3 id="3-2-RPC服务框架-Dubbo"><a href="#3-2-RPC服务框架-Dubbo" class="headerlink" title="3.2 RPC服务框架-Dubbo"></a>3.2 RPC服务框架-Dubbo</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010135.png"></p><h3 id="3-3-基于MySQL-Binlog的增量订阅和消费组件-Canal"><a href="#3-3-基于MySQL-Binlog的增量订阅和消费组件-Canal" class="headerlink" title="3.3 基于MySQL Binlog的增量订阅和消费组件-Canal"></a>3.3 基于MySQL Binlog的增量订阅和消费组件-Canal</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010136.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010137.png"></p><h3 id="3-4-分布式数据库同步系统-Otter"><a href="#3-4-分布式数据库同步系统-Otter" class="headerlink" title="3.4 分布式数据库同步系统-Otter"></a>3.4 分布式数据库同步系统-Otter</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010138.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010139.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010140.png"></p><h3 id="3-5-轻量级分布式通用搜索平台-终搜"><a href="#3-5-轻量级分布式通用搜索平台-终搜" class="headerlink" title="3.5 轻量级分布式通用搜索平台-终搜"></a>3.5 轻量级分布式通用搜索平台-终搜</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010142.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010143.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010144.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010145.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010146.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010147.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010148.png"></p><h3 id="3-6-实时计算引擎-JStorm"><a href="#3-6-实时计算引擎-JStorm" class="headerlink" title="3.6 实时计算引擎-JStorm"></a>3.6 实时计算引擎-JStorm</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010149.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：应用场景（数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁、分布式队列），分布式系统应用（Hadoop、HBase、Kafka），阿里巴巴应用等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（三）开源客户端ZkClient和Curator</title>
    <link href="http://linyishui.top/2021051601.html"/>
    <id>http://linyishui.top/2021051601.html</id>
    <published>2021-05-16T06:35:20.000Z</published>
    <updated>2021-07-18T15:36:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（三）开源客户端"><a href="#ZooKeeper（三）开源客户端" class="headerlink" title="ZooKeeper（三）开源客户端"></a>ZooKeeper（三）开源客户端</h1><h2 id="一-ZkClient"><a href="#一-ZkClient" class="headerlink" title="一. ZkClient"></a>一. ZkClient</h2><p>ZkClient是GitHub上的一个开源的ZooKeeper客户端，它在ZK原生API接口上进行了包装，同时内部实现了诸如Session超时重连、Watcher反复注册等功能。</p><h3 id="1-1-引入依赖"><a href="#1-1-引入依赖" class="headerlink" title="1.1 引入依赖"></a>1.1 引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zookeeper.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.sgroschupf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zkclient.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-创建会话"><a href="#1-2-创建会话" class="headerlink" title="1.2 创建会话"></a>1.2 创建会话</h3><p>构造函数API：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String serverstring)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> sessionTimeout, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> sessionTimeout, <span class="keyword">int</span> connectionTimeout, ZkSerializer zkSerializer)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection, <span class="keyword">int</span> connectionTimeout, ZkSerializer zkSerializer)</span></span>;</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>zkServers</td><td>指ZooKeeper服务器列表，由英文状态逗号分开的host:port字符串组成，每一个都代表一台ZooKeeper机器，例如，192.168.1.1:2181,192.168.1.2:2181,192.168.1.3:2181</td></tr><tr><td>sessionTimeout</td><td>会话超时时间，单位为毫秒，默认是30000ms</td></tr><tr><td>connectionTimeout</td><td>连接创建超时时间，单位为毫秒。此参数表明如果在这个时间段内还是无法和ZooKeeper建立连接，就抛出异常</td></tr><tr><td>connection</td><td>IZkConnection接口的实现类</td></tr><tr><td>zkSerializer</td><td>自定义序列化器</td></tr></tbody></table><ul><li>ZooKeeper会话的建立是一个异步的过程，开发人员需要自己来进行等待处理，ZkClient通过内部包装，将这个异步的会话创建过程同步化了，方便开发者使用。</li><li>IZkConnection接口是对ZooKeeper原生接口最直接的包装和交互层，包含了增删改查一系列接口的定义，有两种默认实现 <code>ZkConnection</code> 和 <code>InMemoryConnection</code> 。</li><li>ZkClient中定义了ZkSerializer接口允许用户传入一个序列化实现，如Hessian或Kryo，默认情况下会使用Java自带的序列化方式。</li><li>ZkClient不再需要提供Watcher参数，其引入了Listener来实现Watcher的注册。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建ZK客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Create_Session_Sample</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        ZkClient zkClient = <span class="keyword">new</span> ZkClient(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ZooKeeper session established.&quot;</span>)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-创建节点"><a href="#1-3-创建节点" class="headerlink" title="1.3 创建节点"></a>1.3 创建节点</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200140.png"></p><p><code>createEphemeral</code> 接口是创建临时节点，<code>createPersistentSequential</code> 则是创建持久顺序节点。</p><p>ZK原生API无法递归创建节点，只能在父节点存在时创建子节点，所以每次都要检查父节点是否存在。ZkClient通过 <code>createParents</code> 参数在内部帮助我们递归建立父节点。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200142.png"></p><h3 id="1-4-删除节点"><a href="#1-4-删除节点" class="headerlink" title="1.4 删除节点"></a>1.4 删除节点</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200143.png"></p><p><code>deleteRecursive</code> 自动完成逐层遍历删除节点的操作。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200144.png"></p><h3 id="1-5-读取数据"><a href="#1-5-读取数据" class="headerlink" title="1.5 读取数据"></a>1.5 读取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path)</span></span>;</span><br><span class="line"><span class="comment">// 注册事件监听</span></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">subscribeChildChanges</span><span class="params">(String path, IZkChildListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IZkChildListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IZkChildListener 参数：</p><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>parentPath</td><td>子节点变更通知对应的父节点的节点路径</td></tr><tr><td>currentChilds</td><td>子节点的相对路径列表，如果没有子节点，会传入null</td></tr></tbody></table><p>节点注册监听后会收到如下事件通知：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200145.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200146.png"></p><ul><li>客户端可以对一个不存在的节点进行子节点变更的监听。</li><li>一旦客户端对一个节点注册子节点列表变更监听之后，当该节点的子节点列表发送变更时，服务端都会通知并将最新的子节点列表发送给客户端。</li><li>该节点本身的创建或删除也会通知到客户端。</li><li>ZkClient的Listener不同于Watcher，一旦注册就会一直生效。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path)</span></span>;</span><br><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path, <span class="keyword">boolean</span> returnNullIfPathNotExists)</span></span>;</span><br><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path, Stat stat)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200147.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同样通过注册Listener来实现监听</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IZkDataListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String dataPath, Object data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildDeleted</span><span class="params">(String dataPath)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>dataPath</td><td>事件通知对应的节点路径</td></tr><tr><td>data</td><td>最新的数据内容</td></tr></tbody></table><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200148.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200149.png"></p><h3 id="1-6-更新数据"><a href="#1-6-更新数据" class="headerlink" title="1.6 更新数据"></a>1.6 更新数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeData</span><span class="params">(String path, Object data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeData</span><span class="params">(<span class="keyword">final</span> String path, Object data, <span class="keyword">final</span> <span class="keyword">int</span> expectedVersion)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200150.png"></p><p>检测指定节点是否存在：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="二-Curator"><a href="#二-Curator" class="headerlink" title="二. Curator"></a>二. Curator</h2><p>Curator是由Netflix开发的一套ZooKeeper客户端框架，和ZkClient一样解决了非常底层的细节开发工作，包括连接重连、反复注册Watcher和NodeExistsException异常等。Curator在ZK原生API的基础上进行了包装，提供了一套易用性和可读性更强的Fluent风格的API框架。除此之外，Curator还提供了ZooKeeper各种应用场景（Recipe，如共享锁服务、Master选举机制和分布式计数器）的抽象封装。</p><h3 id="2-1-引入依赖"><a href="#2-1-引入依赖" class="headerlink" title="2.1 引入依赖"></a>2.1 引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-创建会话"><a href="#2-2-创建会话" class="headerlink" title="2.2 创建会话"></a>2.2 创建会话</h3><ol><li><p>使用 <code>CuratorFrameworkFactory</code> 工厂类的两个静态方法来创建一个客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> CuratorFramework <span class="title">newClient</span><span class="params">(String connectString, RetryPolicy retryPolicy)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> CuratorFramework <span class="title">newClient</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeoutMs, <span class="keyword">int</span> connectionTimeoutMs, RetryPolicy retryPolicy)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>通过调用 <code>CuratorFramework</code> 中的 <code>start()</code> 方法来启动会话。</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200151.png"></p><p>Curator通过接口 <code>RetryPolicy</code> 来让用户自定义重试策略：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">allowRetry</span><span class="params">(<span class="keyword">int</span> retryCount, <span class="keyword">long</span> elapsedTimeMs, RetrySleeper sleeper)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200152.png"></p><p>使用Curator创建一个ZK客户端会话：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200153.png"></p><p><code>ExponentialBackoffRetry</code> 是默认重试策略之一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExponentialBackoffRetry(<span class="keyword">int</span> baseSleepTimeMs, <span class="keyword">int</span> maxRetries);</span><br><span class="line">ExponentialBackoffRetry(<span class="keyword">int</span> baseSleepTimeMs, <span class="keyword">int</span> maxRetries, <span class="keyword">int</span> maxSleepMs);</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200154.png"></p><p>给定一个初始sleep时间baseSleepTimeMs，在此基础上结合重试次数，通过以下公式计算出当前需要sleep的时间：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当前sleep时间 = baseSleepTimeMs<span class="operator"> * </span><span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(<span class="number">1</span>, random.next<span class="constructor">Int(1 &lt;&lt; (<span class="params">retryCount</span> + 1)</span>))</span><br></pre></td></tr></table></figure><p>使用Fluent风格的API接口创建会话：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200155.png"></p><p>使用Curator创建含隔离命名空间的会话：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现不同ZK业务之间的隔离，需要给每个业务分配一个独立的命名空间，即指定一个ZK根路径：</span></span><br><span class="line">    CuratorFrameworkFactory.builder()</span><br><span class="line">                           .connectString(<span class="string">&quot;domain.book.zookeeper:2181&quot;</span>)</span><br><span class="line">                           .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                           .retryPolicy(retryPolicy)</span><br><span class="line">                           .namespace(<span class="string">&quot;base&quot;</span>)</span><br><span class="line">                           .build();</span><br></pre></td></tr></table></figure><h3 id="2-3-创建节点"><a href="#2-3-创建节点" class="headerlink" title="2.3 创建节点"></a>2.3 创建节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CreateBuilder <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ProtectACLCreateModePathAndBytesable&lt;String&gt; <span class="title">creatingParentsIfNeeded</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateModable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withMode</span><span class="params">(CreateMode mode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>创建一个节点，初始内容为空</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>创建一个节点，附带初始内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(path, <span class="string">&quot;init&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure></li><li><p>创建一个临时节点，初始内容为空</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().withMode(CreateMode.EPHEMERAL).forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>创建一个临时节点，并自动递归创建父节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200156.png"></p><h3 id="2-4-删除节点"><a href="#2-4-删除节点" class="headerlink" title="2.4 删除节点"></a>2.4 删除节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeleteBuilder <span class="title">delete</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Versionable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withVersion</span><span class="params">(<span class="keyword">int</span> version)</span></span>;</span><br><span class="line"><span class="comment">// DeleteBuilder</span></span><br><span class="line"><span class="comment">// 客户端执行一个删除节点的操作，可能由于网络原因导致删除失败，在某些场景中这种异常是致命的，比如Master选举。当调用guaranteed()，会记录下这次失败的删除操作，只要客户端会话有效，就会在后台反复重试直到节点删除成功</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeleteBuilderBase <span class="title">guaranteed</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>删除一个节点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此接口只能删除叶子节点</span></span><br><span class="line">client.delete().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点，并递归删除其所有子节点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().deletingChildrenIfNeeded().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点，强制指定版本进行删除：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().withVersion(version).forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>删除一个节点，强制保证删除：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().guaranteed().forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200157.png"></p><h3 id="2-5-读取数据"><a href="#2-5-读取数据" class="headerlink" title="2.5 读取数据"></a>2.5 读取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GetDataBuilder <span class="title">getData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Statable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">storingStatIn</span><span class="params">(Stat stat)</span></span>;</span><br><span class="line"><span class="comment">// Pathable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>读取一个节点的数据内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回值为byte[]</span></span><br><span class="line">client.getData().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>读取一个节点的数据内容，同时获取到该节点的stat：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Curator通过传入一个旧的stat变量的方式来存储服务端返回的最新的节点状态信息</span></span><br><span class="line">client.getData().storingStatIn(stat).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200158.png"></p><h3 id="2-6-更新数据"><a href="#2-6-更新数据" class="headerlink" title="2.6 更新数据"></a>2.6 更新数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SetDataBuilder <span class="title">setData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Versionable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withVersion</span><span class="params">(<span class="keyword">int</span> version)</span></span>;</span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>更新一个节点的数据内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个stat对象</span></span><br><span class="line">client.setData().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>更新一个节点的数据内容，强制指定版本进行更新：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// withVersion用来实现CAS，version通常由一个旧的stat对象获取到</span></span><br><span class="line">client.setData().withVersion(version).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>示例：第一次使用最新的stat变量进行更新操作，第二次则使用了过期的stat变量。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200159.png"></p><h3 id="2-7-异步接口"><a href="#2-7-异步接口" class="headerlink" title="2.7 异步接口"></a>2.7 异步接口</h3><p>以上API皆为Curator的同步接口，Curator引入了 <code>BackgroundCallback</code> 接口，用来处理异步接口调用之后服务端返回的结果信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BackgroundCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>client</td><td>当前客户端实例</td></tr><tr><td>event</td><td>服务端事件，CuratorEvent定义了ZK服务端发送到客户端的一系列事件参数</td></tr></tbody></table><p>CuratorEvent中比较重要的两个参数：</p><ul><li><strong>事件类型（CuratorEventType）：</strong><code>getType()</code> 代表本次事件的类型<ul><li>CREATE：<code>CuratorFramework#create()</code></li><li>DELETE：<code>CuratorFramework#delete()</code></li><li>EXISXTS：<code>CuratorFramework#checkExists()</code></li><li>GET_DATA：<code>CuratorFramework#getData()</code></li><li>SET_DATA：<code>CuratorFramework#setData()</code></li><li>CHILDREN：<code>CuratorFramework#getChildren()</code></li><li>SYNC：<code>CuratorFramework#sync()</code></li><li>GET_ACL：<code>CuratorFramework#getACL()</code></li><li>WATCHED：<code>Watchable#usingWatcher(Watcher) / Watchable#watched()</code></li><li>CLOSING：ZK客户端与服务端连接断开事件</li></ul></li><li><strong>响应码（int）：</strong>定义在<code>org.apache.zookeeper.KeeperException.Code</code> 中，常见的有：<ul><li>0（OK）接口调用成功</li><li>-4（ConnectionLoss）客户端与服务端连接断开</li><li>-110（NodeExists）指定节点已存在</li><li>-112（SessionExpired）会话已过期</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Backgroudable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(Object context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Object context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Executor executor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Object context, Executor executor)</span></span>;</span><br></pre></td></tr></table></figure><p>在ZooKeeper中，所有异步通知事件处理都由EventThread线程来处理，其串行处理机制在绝大部分应用场景下能够保证对事件处理的顺序性，但也有弊端就是一旦碰到一个复杂的处理单元，就会消耗过长的处理时间，从而影响到对其他事件的处理。因此接口会让用户传入一个Executor实例，把复杂的事件处理放到一个专门的线程池中，如 <code>Executors.newFixedThreadPool(2)</code> 。</p><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200160.png"></p><h3 id="2-8-典型使用场景"><a href="#2-8-典型使用场景" class="headerlink" title="2.8 典型使用场景"></a>2.8 典型使用场景</h3><p>参考案例都在recipes包中，需要单独引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="（1）事件监听"><a href="#（1）事件监听" class="headerlink" title="（1）事件监听"></a>（1）事件监听</h4><p>Curator引入了Cache来实现对ZK服务端事件的监听，Cache可以看作是一个本地缓存视图和远程ZooKeeper视图的对比过程，同时自动处理反复监听。<strong>Cache分为两种：节点监听（NodeCache）和子节点监听（PathChildrenCache）。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NodeCache用于监听指定ZK数据节点本身的变化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NodeCache</span><span class="params">(CuratorFramework client, String path)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NodeCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NodeCache定义了事件处理的回调接口NodeCacheListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NodeCacheListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">voidnodeChanged</span><span class="params">()</span> throw Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数名</th><th>说明</th></tr></thead><tbody><tr><td>client</td><td>Curator客户端实例</td></tr><tr><td>path</td><td>数据节点的节点路径</td></tr><tr><td>dataIsCompressed</td><td>是否进行数据压缩</td></tr></tbody></table><p>示例： </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200161.png"></p><p><code>start()</code> 有个布尔类型参数，默认为false，当设置为true时NodeCache首次启动会立即从ZK上读取对应节点的数据内容，并保存在Cache中。NodeCache不仅可以用于监听数据节点的内容变更，也能监听节点是否存在。若原本节点不存在，Cache会在节点创建后触发NodeCacheListener。</p><p><code>PathChildrenCache</code> 用于监听指定ZK数据节点的子节点变化情况：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> cacheData)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> cacheData, ThreadFactory threadFactory)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, ThreadFactory threadFactory)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, <span class="keyword">final</span> ExecutorService executorService)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, <span class="keyword">final</span> CloseableExecutorService executorService)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件处理的回调接口，子节点发生变化时回调方法，事件类型包括：新增子节点、数据变更、子节点删除三类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PathChildrenCacheListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200162.png"></p><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200163.png"></p><h4 id="（2）Master选举"><a href="#（2）Master选举" class="headerlink" title="（2）Master选举"></a>（2）Master选举</h4><p>分布式系统常见场景：一个复杂的任务，仅需从集群中选举出一台仅需处理即可。</p><p>大致思路：选择一个根节点，如 <code>/master_select</code> ，多台机器同时向该节点创建一个子节点 <code>/master_select/lock</code> 最终只有一台机器能创建成功，就相当于被选为Master。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200164.png"></p><p>监听器 LeaderSelectorListenerAdapter 需要自行实现，Curator会在成功获取Master权利后回调此监听器：执行完方法会立即释放权利，重新开始下一轮选举</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200165.png"></p><h4 id="（3）分布式锁"><a href="#（3）分布式锁" class="headerlink" title="（3）分布式锁"></a>（3）分布式锁</h4><p>为了保证分布式环境的数据一致，需要在程序某个运行节点进行同步控制，比如用时间戳来生成流水号，以下示例展示这种典型的并发问题：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200166.png"></p><p>因为没有同步导致了上述的数据重复问题，可以使用Curator来实现分布式锁：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200167.png"></p><h4 id="（4）分布式计数器"><a href="#（4）分布式计数器" class="headerlink" title="（4）分布式计数器"></a>（4）分布式计数器</h4><p>统计系统的在线人数，我们可以指定一个ZK数据节点作为计数器，多个应用实例在分布式锁的控制下，通过更新该数据节点来实现计数（可以直接使用封装的 DistributedAtomicInteger）。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200168.png"></p><h4 id="（5）分布式Barrier"><a href="#（5）分布式Barrier" class="headerlink" title="（5）分布式Barrier"></a>（5）分布式Barrier</h4><p>Barrier是一种用来控制多线程之间同步的经典方法，JDK自带CyclicBarrier实现：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200169.png"></p><p>多线程在并发情况下，都会准确的等待所有先都处于就绪状态后才开始同时执行其他业务逻辑，但分布式系统有多个JVM，此时可以使用Curator提供的DistributedBarrier：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200170.png"></p><p>上述为主线程触发Barrier释放不同，Curator还提供了另一种线程自发的触发Barrier释放：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200171.png"></p><h4 id="（6）Curator提供的工具"><a href="#（6）Curator提供的工具" class="headerlink" title="（6）Curator提供的工具"></a>（6）Curator提供的工具</h4><p>较常用的有 ZKPaths 和 EnsurePath，前者可以来构建ZNode路径、递归创建和删除节点等：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200172.png"></p><p>后者提供了一种能确保数据节点存在的机制，有些场景我们要做某些操作必须先要确保节点存在，若不存在就要先创建节点，但分布式环境中可能有其他机器也在尝试创建该节点，就导致我们创建时得到“节点已存在”的异常。</p><p>EnsurePath采取了静默的节点创建方式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200173.png"></p><h4 id="（7）单元测试-TestingServer"><a href="#（7）单元测试-TestingServer" class="headerlink" title="（7）单元测试 TestingServer"></a>（7）单元测试 TestingServer</h4><p>引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200174.png"></p><h4 id="（8）集群测试-TestingCluster"><a href="#（8）集群测试-TestingCluster" class="headerlink" title="（8）集群测试 TestingCluster"></a>（8）集群测试 TestingCluster</h4><p>使用示例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200175.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：ZkClient的API和使用示例，Curator的API和使用示例等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（二）Java客户端API</title>
    <link href="http://linyishui.top/2021051501.html"/>
    <id>http://linyishui.top/2021051501.html</id>
    <published>2021-05-15T04:11:16.000Z</published>
    <updated>2021-07-18T15:36:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（二）Java客户端API"><a href="#ZooKeeper（二）Java客户端API" class="headerlink" title="ZooKeeper（二）Java客户端API"></a>ZooKeeper（二）Java客户端API</h1><h2 id="一-创建会话"><a href="#一-创建会话" class="headerlink" title="一. 创建会话"></a>一. 创建会话</h2><p>通过构建一个ZooKeeper对象来创建会话，这是一个异步过程，构造函数会在处理完客户端初始化后立即返回，此时会话处于CONNECTING状态。会话真正创建完毕后，服务端向客户端发送一个事件通知。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数API</span></span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly);</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200115.png"></p><p>实例代码如图：重写了process方法负责处理收到的Watcher通知，收到服务端发送的SyncConnected事件后，解除主程序在CountDownLatch上的等待阻塞。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200116.png"></p><p>复用sessionId，维持之前会话：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200117.png"></p><h2 id="二-创建节点"><a href="#二-创建节点" class="headerlink" title="二. 创建节点"></a>二. 创建节点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步创建节点</span></span><br><span class="line"><span class="function">String <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl, CreateMode createMode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步创建节点</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl, CreateMode createMode, StringCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p>ZooKeeper节点内容只支持字节数组类型（byte[]），即ZooKeeper不负责为节点内容进行序列化，需要开发人员自己使用序列化工具操作。</p><p>默认不需要关注权限参数，只需在acl中传入 <code>Ids.OPEN_ACL_UNSAFE</code> ，表示不受权限控制。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200118.png"></p><p>创建同步节点，分别创建临时节点和临时顺序节点，二者返回值不一样。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200119.png"></p><p>创建异步节点，只需要实现 <code>AsyncCallback.StringCallback()</code> 接口即可。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200120.png"></p><p>AsyncCallback包括七种不同的回调接口：</p><ul><li>StatCallback</li><li>DataCallback</li><li>ACLCallback</li><li>ChildrenCallback</li><li>Children2Callback</li><li>StringCallback</li><li>VoidCallback</li></ul><p>同步接口调用过程需要关注抛出异常的可能，异步接口本身不抛出异常，素有异常都在回调函数中通过响应码（Result Code）体现。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200121.png"></p><h2 id="三-删除节点"><a href="#三-删除节点" class="headerlink" title="三. 删除节点"></a>三. 删除节点</h2><p>ZooKeeper只允许删除叶子节点，即如果节点存在子节点就无法被直接删除。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version, VoidCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200122.png"></p><h2 id="四-读取数据"><a href="#四-读取数据" class="headerlink" title="四. 读取数据"></a>四. 读取数据</h2><h3 id="（1）getChildren"><a href="#（1）getChildren" class="headerlink" title="（1）getChildren"></a>（1）getChildren</h3><p>获取一个节点下的所有子节点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Stat stat)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, Stat stat)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Children2Callback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, Children2Callback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200123.png"></p><p>当有子节点被添加或删除时，服务端会向客户端发送一个 <code>NodeChildrenChanged(EventType.NodeChildrenChanged)</code> 类型的事件通知。要注意该通知不包含最新的节点列表，客户端必须主动重新获取。</p><p>使用同步接口获取子节点列表：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200124.png"></p><p>注意，Watcher通知是一次性的，一旦触发一次通知，该Watcher就失效了，因此客户端需要反复注册Watcher。</p><p>使用异步接口获取子节点列表：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200125.png"></p><p>异步接口经常被应用在这样的使用场景：应用启动时获取一些配置信息，如“机器列表”，这些配置通常较大，并且不希望配置的获取影响应用的主流程。</p><h3 id="（2）getData"><a href="#（2）getData" class="headerlink" title="（2）getData"></a>（2）getData</h3><p>获取一个节点的数据内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] getData(<span class="keyword">final</span> String path, Watcher watcher, Stat stat);</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] getData(String path, <span class="keyword">boolean</span> watcher, Stat stat);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, DataCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, DataCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200126.png"></p><p>当节点的状态发生变更，ZooKeeper服务端向客户端发送一个 <code>NodeDataChanged(EventType.NodeDataChanged)</code> 的事件通知。节点的数据内容和数据版本变化都被看作是节点的变化。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200127.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200128.png"></p><h2 id="五-更新数据"><a href="#五-更新数据" class="headerlink" title="五. 更新数据"></a>五. 更新数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Stat <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version, StatCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200129.png"></p><p><code>getData</code> 读取数据接口并未提供根据指定数据版本来获取数据的接口，<code>setData</code> 此处的version类似于CAS比较并交换原理，对应预期值表示针对此版本更新，这样在一个客户端读取并修改中间其他客户端的修改会使这次修改无效，从而避免并发问题。</p><p>分别使用不同的version进行了三次更新操作：数据版本从0开始，-1非合法的数据版本，这里用来告诉服务端，客户端要基于最新版本进行更新操作。第三次操作使用了之前的数据版本1所以导致更新失败。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200130.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200131.png"></p><h2 id="六-检测节点是否存在"><a href="#六-检测节点是否存在" class="headerlink" title="六. 检测节点是否存在"></a>六. 检测节点是否存在</h2><p>检测节点是否存在，返回一个stat对象，当节点被创建、被删除或数据被更新会通过Watcher通知客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, StatCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, StatCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200132.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200133.png"></p><p>上述示例中，先后进行了如下操作：</p><ol><li>通过exists接口检测是否存在指定节点，同时注册了一个Watcher。</li><li>创建节点/zk-book，此时服务端马上会向客户端发送一个事件通知：NodeCreated。客户端收到该事件通知后，再次调用exists接口，同时注册Watcher。</li><li>更新该节点的数据，这个时候，服务端又会向客户端发送一个事件通知：NodeDataChanged。客户端收到该事件通知后，继续调用exists接口，同时注册Watcher。</li><li>创建子节点/zk-book/c1。</li><li>删除子节点/zk-book/c1。</li><li>删除节点/zk-book。此时客户端会收到服务端的事件通知：NodeDeleted。</li></ol><p>综上所述，可以得知：</p><ul><li>无论指定节点是否存在，通过调用exists接口都可以注册Watcher。</li><li>exists接口中注册的Watcher，能够对节点创建、节点删除和节点数据更新事件进行监听。</li><li>对于指定节点的子节点的各种变化，都不会通知客户端。</li></ul><h2 id="七-权限控制"><a href="#七-权限控制" class="headerlink" title="七. 权限控制"></a>七. 权限控制</h2><p>集群模式下的ZooKeeper，不同的应用之间往往是不会存在共享数据的使用场景的，因此需要解决不同应用之间的权限问题。</p><p>通过设置服务端上数据节点的ACL，来控制客户端对该节点的访问权限。ZooKeeper提供了多种权限控制模式：</p><ul><li>world</li><li>auth</li><li>digest：主要讲解该模式</li><li>ip</li><li>super</li></ul><p>客户端在会话创建后，调用 <code>addAuthInfo(String scheme, byte[] auth)</code> 接口进行权限信息的设置：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200134.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200135.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200136.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200137.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200139.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：创建会话、节点，删除节点，读取、更新数据，检测节点是否存在，权限控制等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（一）概述和ZAB协议</title>
    <link href="http://linyishui.top/2021051001.html"/>
    <id>http://linyishui.top/2021051001.html</id>
    <published>2021-05-10T13:27:05.000Z</published>
    <updated>2021-07-18T15:36:48.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（一）概述和ZAB协议"><a href="#ZooKeeper（一）概述和ZAB协议" class="headerlink" title="ZooKeeper（一）概述和ZAB协议"></a>ZooKeeper（一）概述和ZAB协议</h1><h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h2><h3 id="1-1-什么是ZooKeeper？"><a href="#1-1-什么是ZooKeeper？" class="headerlink" title="1.1 什么是ZooKeeper？"></a>1.1 什么是ZooKeeper？</h3><ul><li>Apache ZooKeeper 由 Apache Hadoop 子项目发展而来。</li><li>ZooKeeper是一个开源的分布式协调服务，由雅虎创建，Google Chubby 的开源实现。</li><li>设计目标是将那些复杂易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。</li><li>ZooKeeper 为分布式应用提供了高效且可靠的分布式协调服务，提供了诸如<strong>统一命名服务</strong>、<strong>配置关联</strong>和<strong>分布式锁</strong>等分布式的基础服务。</li><li>ZooKeeper并没有直接采用 Paxos 算法，而是一种被称为 ZAB（ZooKeeper Atomic Broadcast）的一致性协议。</li></ul><p>ZooKeeper 是一个典型的分布式数据一致性的解决方案，应用可以基于它实现诸如<strong>数据发布/订阅</strong>、<strong>负载均衡</strong>、<strong>命名服务</strong>、<strong>分布式协调/通知</strong>、<strong>集群管理</strong>、<strong>Master选举</strong>、<strong>分布式锁</strong>和<strong>分布式队列</strong>等功能。</p><h3 id="1-2-特性"><a href="#1-2-特性" class="headerlink" title="1.2 特性"></a>1.2 特性</h3><ul><li><strong>顺序一致性：</strong>从同一客户端发起的事务请求，将会严格的按照发送顺序被应用到ZooKeeper中。</li><li><strong>原子性：</strong>所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，要么整个集群所有机器都成功应用了某个事务，要么都没有应用。</li><li><strong>单一视图：</strong>无论客户端连接哪个ZooKeeper服务器，看到的服务端数据模型都是一致的。</li><li><strong>可靠性：</strong>一旦服务端成功应用了一个事务，并完成对客户端的响应，事务引起的服务端状态一直保留到下个事务进行变更。</li><li><strong>实时性：</strong>ZooKeeper仅保证在一定时间段内，客户端最终一定能够从服务端读取到最新的数据状态。</li></ul><h3 id="1-3-设计目标"><a href="#1-3-设计目标" class="headerlink" title="1.3 设计目标"></a>1.3 设计目标</h3><ol><li><strong>简单的数据模型：</strong>分布式程序通过一个共享的、树型结构的名字空间来相互协调</li><li><strong>可以构建集群：</strong>一般3~5台机器可以组成一个可用的ZooKeeper集群，每台机器都会在内存中维护当前的服务器状态，机器之间互相都保持着通信。ZooKeeper客户端会与任意一台机器创建一个TCP连接，一旦连接断开，客户端会自动连接到其他机器。</li><li><strong>顺序访问：</strong>ZooKeeper为客户端的每个更新请求分配一个全局唯一的递增编号，反映了事务操作的先后顺序。</li><li><strong>高性能：</strong>ZooKeeper将全量数据存储在内存中，直接服务于客户端的所有非事务请求，非常适合于读操作为主的场景。</li></ol><h3 id="1-4-核心概念"><a href="#1-4-核心概念" class="headerlink" title="1.4 核心概念"></a>1.4 核心概念</h3><ul><li><p><strong>集群角色：</strong></p><ul><li>最典型的集群模式是Master/Slave（主备模式），能够处理所有写操作的是Master机器，所有通过异步复制方式获取最新数据，并提供读服务的机器是Slave机器。</li><li>ZooKeeper并没有采用这种模式，而是引入了新的三个角色：<ul><li><strong>Leader：</strong>集群中所有机器通过选举过程选定一个Leader，其为客户端提供读和写服务。</li><li><strong>Follower：</strong>提供读服务。</li><li><strong>Observer：</strong>提供读服务，不参与Leader选举过程，也不参与写操作的“过半写成功”策略，因此Observer可以在不影响写性能的情况下提高集群的读性能。</li></ul></li></ul></li><li><p><strong>会话（Session）：</strong></p><ul><li>在ZooKeeper中，一个客户端连接是指客户端和服务器之间的一个TCP长连接。</li><li>ZooKeeper对外的服务端口默认是2181，客户端启动时首先会与服务器建立一个TCP连接，从第一次连接建立开始，客户端会话的生命周期也开始，客户端通过这个连接进行心跳检测与服务器保持有效的会话，也能够向ZooKeeper服务器发送请求并接收响应，同时还能通过该连接接收服务器的Watch事件通知。</li><li>sessionTimeout值用来设置一个客户端会话的超时时间。因服务器压力过大、网络故障或客户端主动断开连接等导致的连接断开，只要在sessionTimeout规定时间内重新连上一台服务器，之前创建的会话仍会有效。</li></ul></li><li><p><strong>数据节点（ZNode）：</strong>分布式中节点即每台机器，在ZooKeeper中，节点分为两类：</p><ul><li><strong>机器节点：</strong>构成集群的机器</li><li><strong>数据节点：</strong>数据模型中的数据单元，即ZNode，又可以分为<ul><li><strong>持久节点：</strong>一旦此ZNode被创建，除非主动进行移除操作，否则将一直保存。</li><li><strong>临时节点：</strong>生命周期和客户端会话绑定，一旦客户端会话失效，该客户端创建的所有临时节点都会被移除。</li></ul></li></ul><p>数据模型是一棵树，由斜杠（<code>/</code>）进行分割的路径，就是一个ZNode，如 <code>/foo/path1</code> 。每个ZNode上都会保存自己的数据内容，以及一系列属性信息。</p><p>ZooKeeper允许用户为每个节点添加一个特殊的属性：SEQUENTIAL，当节点标记此属性，在节点创建时会自动在节点名后追加一个由父节点维护的自增整型数字。</p></li><li><p><strong>版本：</strong>ZooKeeper的每个ZNode都会维护一个叫做 <strong>Stat</strong> 的数据结构，Stat中记录了节点的三个数据版本：</p><ul><li>version：当前ZNode的版本</li><li>cversion：当前ZNode子节点的版本</li><li>aversion：当前ZNode的ACL版本</li></ul></li><li><p><strong>Watcher：</strong>即事件监听器，用户可以在指定节点上注册一些Watcher，在一些特定事件触发时，ZooKeeper服务端会将事件通知到感兴趣的客户端上。</p></li><li><p><strong>ACL：</strong>ZooKeeper采用 Access Control Lists 策略来进行权限控制，类似于UNIX文件系统的权限控制，定义了5种权限：</p><ul><li><strong>CREATE：</strong>创建子节点的权限</li><li><strong>READ：</strong>获取节点数据和子节点列表的权限</li><li><strong>WRITE：</strong>更新节点数据的权限</li><li><strong>DELETE：</strong>删除子节点的权限</li><li><strong>ADMIN：</strong>设置节点ACL的权限</li></ul></li></ul><h2 id="二-ZAB-协议"><a href="#二-ZAB-协议" class="headerlink" title="二. ZAB 协议"></a>二. ZAB 协议</h2><h3 id="2-1-什么是ZAB协议？"><a href="#2-1-什么是ZAB协议？" class="headerlink" title="2.1 什么是ZAB协议？"></a>2.1 什么是ZAB协议？</h3><p>ZooKeeper并没有完全采用 Paxos 算法，而是使用了一个称为 ZooKeeper Atomic Broadcast（ZAB，ZooKeeper<strong>原子消息广播协议</strong>）的协议来作为其数据一致性的核心算法。</p><p>ZAB协议是一种支持崩溃恢复的原子广播协议，最初只是为雅虎公司内部一些<strong>高吞吐量、低延迟、健壮、简单</strong>的分布式系统场景设计的，并不像Paxos算法那样通用和可扩展。</p><p>基于该协议，ZooKeeper实现了一种<strong>主备模式</strong>的系统架构来保持集群中各副本之间的数据一致性。ZooKeeper使用一个单一的主进程来接收并处理客户端所有的事务请求，通过ZAB的原子广播协议将服务器的数据状态以事务Proposal的形式广播到所有的副本进程。该主备模型保证了<strong>同一时刻集群中只能有一个主进程来广播服务器的状态变更</strong>，因此能够很好的处理客户端大量的并发请求。并且<strong>支持分布式环境中对于顺序状态的需求</strong>（有些状态变更必须依赖于比它早生成的状态变更），保证了一个全局的变更序列被顺序应用。因为主进程随时可能崩溃或重启，还要做到主进程有问题时仍能正常工作。</p><p>所有事务请求必须由一个全局唯一的服务器来协调处理，即Leader服务器，余下的服务器成为Follower服务器。Leader服务器负责将一个客户端事务请求转换为一个事务 Proposal（提议），并将该提议分发给集群中所有的Follower服务器。之后Leader服务器等待所有Follower服务器的反馈，一旦超过半数进行了正确的反馈，Leader服务器再次向所有的Follower服务器分发Commit消息，要求将前一个提议提交。</p><h3 id="2-2-协议介绍"><a href="#2-2-协议介绍" class="headerlink" title="2.2 协议介绍"></a>2.2 协议介绍</h3><p>ZAB协议包含两种基本模式：</p><ul><li><strong>崩溃恢复：</strong><ul><li>当整个服务框架在启动过程，或是Leader服务器出现网络中断、崩溃退出与重启等异常情况时，ZAB进入该模式选举产生新的Leader服务器。</li><li>选出新的Leader，且集群中已有过半的机器与新的Leader完成状态同步（指数据同步，用来保证过半机器与Leader保持一致）之后，ZAB退出该模式。</li></ul></li><li><strong>消息广播：</strong><ul><li>集群中有过半的Follower服务器完成了与Leader服务器的状态同步，服务框架进入该模式。</li><li>当一台遵守ZAB协议的服务器启动并加入集群时，若此时已存在Leader服务器，它会自觉的进入数据恢复模式：找到Leader所在服务器，并与其进行数据同步，然后一起参与到消息广播流程中。</li></ul></li></ul><h4 id="（1）消息广播"><a href="#（1）消息广播" class="headerlink" title="（1）消息广播"></a>（1）消息广播</h4><p>消息广播的过程类似于二阶段提交：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200111.png"></p><p>ZAB没有中断逻辑，所以Follower服务器反馈Ack后就可以提交事务Proposal，这种简化模型自然存在Leader单点故障引起的数据不一致问题。ZAB协议通过崩溃恢复模式来解决这个问题。</p><p>整个消息广播协议基于具有FIFO特性的TCP协议来进行网络通信，很容易保证消息接收和发送的顺序性。Leader为每个事务Proposal分配一个全局单调递增的事务ID（ZXID），每个事务按照ZXID的先后顺序进行排序和处理。</p><p>Leader服务器为每个Follower服务器各自分配一个队列，将需要广播的事务Proposal依次放入队列中，根据FIFO的策略进行消息发送。每个Follower服务器收到事务Proposal后，首先以事务日志的形式写入到本地磁盘中，在成功写入后反馈给Leader一个Ack响应。收到超过半数的Ack响应后，Leader会广播一个Commit消息给所有Follower服务器以通知进行事务提交，同时Leader完成自己的事务提交。</p><h4 id="（2）崩溃恢复"><a href="#（2）崩溃恢复" class="headerlink" title="（2）崩溃恢复"></a>（2）崩溃恢复</h4><p>进入崩溃恢复模式后，需要选举出一个新的Leader服务器，这需要一个高效且可靠的选举算法，不仅需要让新Leader自己知道已被选举为Leader，还要让集群中所有机器快速感知到这点。</p><p><strong>ZAB协议要确保那些已经在Leader服务器上提交的事务最终被所有服务器提交。</strong></p><p>假设一个事务已在Leader服务器提交，但在将Commit消息发送给所有Follower之前，Leader挂掉了：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200112.png"></p><p><strong>ZAB协议要确保丢弃那些只在Leader服务器上被提出的事务。</strong></p><p>相反，在崩溃恢复过程中出现一个需要被丢弃的提案，在崩溃恢复结束后需要跳过该事务Proposal：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200113.png"></p><p>针对以上两点，如果Leader选举算法能够保证新选举出来的Leader服务器拥有集群中所有机器最高编号（ZXID）的事务Proposal，就可以保证新选举出的Leader一定具有所有已经提交的提案，还可以省区Leader服务器检查Proposal的提交和丢弃工作这一步。</p><p>完成Leader选举后，在正式工作前，Leader服务器首先要确认事务日志中所有的Proposal是否都已经被集群中过半的机器提交了，即<strong>是否完成数据同步</strong>。</p><ul><li>Leader为每个Follower准备一个队列，将没有被各Follower同步的事务以Proposal消息的形式逐个发送给Follower，并每个都跟着发送一个Commit消息。</li><li>等到所有Follower都将其尚未同步的事务Proposal从Leader上同步过来并成功应用到本地数据库后，Leader将该Follower加如到真正可用的Follower列表，并开始之后流程。</li></ul><p><strong>如何处理需要丢弃的事务Proposal？</strong></p><p>ZXID时一个64位的数字，低32位可以看作简单的递增计数器，高32位则代表了Leader周期epoch的编号，每当选举产生一个新的Leader服务器，就会从Leader上取出其本地日志中最大事务Proposal的ZXID，解析出epoch值并加1，将此编号作为新的epoch，并将低32位置0。</p><p>这样可以区分开不同的Leader周期变化，从而避免不同的Leader服务器错误的使用相同的ZXID提出不同的事务Proposal。</p><p>当一个包含了上个周期尚未提交的事务Proposal的服务器启动时，其肯定无法成为Leader。因为当前集群一定包含一个Quorum集合，集合中的机器一定包含了更高epoch的事务Proposal，因此该机器肯定非最高编号事务。当其连接上Leader后，Leader根据自己记录的最后被提交的Proposal对比，并要求Follower进行一个回退操作—回退到一个确实已经被集群过半机器提交的最新的事务Proposal（如上图4-4 Server1连接后，会被要求去除P3）。</p><h3 id="2-3-深入剖析"><a href="#2-3-深入剖析" class="headerlink" title="2.3 深入剖析"></a>2.3 深入剖析</h3><p>未完待续…</p><h4 id="（1）-系统模型"><a href="#（1）-系统模型" class="headerlink" title="（1） 系统模型"></a>（1） 系统模型</h4><h4 id="（2）-问题描述"><a href="#（2）-问题描述" class="headerlink" title="（2） 问题描述"></a>（2） 问题描述</h4><h4 id="（3）-算法描述"><a href="#（3）-算法描述" class="headerlink" title="（3） 算法描述"></a>（3） 算法描述</h4><h4 id="（4）-运行分析"><a href="#（4）-运行分析" class="headerlink" title="（4） 运行分析"></a>（4） 运行分析</h4><h3 id="2-4-ZAB与Paxos算法的异同"><a href="#2-4-ZAB与Paxos算法的异同" class="headerlink" title="2.4 ZAB与Paxos算法的异同"></a>2.4 ZAB与Paxos算法的异同</h3><ul><li><p>二者都存在一个Leader进程角色，负责协调多个Follower进程的运行。</p></li><li><p>Leader进程都会等待超过半数的Follower进程正确反馈后，才会将提案提交。</p></li><li><p>ZAB协议中标识Leader周期的epoch值，Paxos算法中叫Ballot。</p></li></ul><p>二者的本质区别在于设计目标不同，ZAB协议用于构建一个高可用的分布式数据主备系统，而Paxos算法则用于构建一个分布式的一致性状态机系统。</p><h2 id="三-简单使用"><a href="#三-简单使用" class="headerlink" title="三. 简单使用"></a>三. 简单使用</h2><h3 id="3-1-部署与运行"><a href="#3-1-部署与运行" class="headerlink" title="3.1 部署与运行"></a>3.1 部署与运行</h3><p>ZooKeeper使用Java语言编写，所以需要1.6以上版本的Java环境。ZooKeeper包含集群和单机两种运行模式。</p><h4 id="（1）部署"><a href="#（1）部署" class="headerlink" title="（1）部署"></a>（1）部署</h4><ol><li><p>下载安装包并解压：<code>http:zookeeper.apache.org/releases.html</code></p></li><li><p>配置文件 <code>zoo.cfg</code> ：</p><p><code>%ZK_HOME%/conf</code> 目录下 <code>zoo_sample.cfg</code> 重命名为 <code>zoo.cfg</code> </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">tickTime=2000</span></span><br><span class="line"><span class="string">dataDir=/var/lib/zookeeper/</span></span><br><span class="line"><span class="string">clientPort=2181</span></span><br><span class="line"><span class="string">initLimit=5</span></span><br><span class="line"><span class="string">syncLimit=2</span></span><br><span class="line"><span class="comment"># server.id=host:port:port 用来感知集群由哪些机器构成，id表示机器序号，dataDir目录下需要有一个myid文件，内容为一个数字对应此id</span></span><br><span class="line"><span class="string">server.1=&lt;IP1&gt;:2888:3888</span></span><br><span class="line"><span class="string">server.2=&lt;IP2&gt;:2888:3888</span></span><br><span class="line"><span class="string">server.3=&lt;IP3&gt;:2888:3888</span></span><br></pre></td></tr></table></figure><ul><li>集群模式下所有cfg文件都应是一致的，最好使用代码仓库管理起来。</li><li>id取值范围为 ：1~255。</li></ul></li><li><p>创建 <code>myid</code> 文件，在dataDir指定目录下，内容为数字id</p></li><li><p>为所有机器配置2和3步内容</p></li><li><p>启动服务器：使用 <code>%ZK_HOME%/bin</code> 目录下的 <code>zkServer.sh</code> 脚本启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh zkServer.sh start</span></span><br><span class="line">JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper-3.4.3/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure></li><li><p>验证服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> telnet 127.0.0.1 2181</span></span><br><span class="line">stat</span><br></pre></td></tr></table></figure></li></ol><p>单机模式与集群模式只是在 <code>zoo.cfg</code> 的配置上有些差异，<code>server.id</code> 只有一项 <code>server.1</code> 。</p><h4 id="（2）运行和停止"><a href="#（2）运行和停止" class="headerlink" title="（2）运行和停止"></a>（2）运行和停止</h4><p>启动服务：</p><ul><li>Java命令行：在 <code>%ZK_HOME%</code> 目录下执行命令 <code>java -cp zookeeper -3.4.3 jar:lib/ slf4j-api-1.6. 1. jar:lib/slf4j- log4j12-1.6.1.jar:lib/log4j-1.2.15.jar:conf org. apache. zookeeper. server.quorum.QuorumPeerMain conf/zoo.cfg</code> 注意log4j和slf4j版本</li><li>自带的启动脚本</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200114.png"></p><p>停止服务：<code>sh zkServer.sh stop</code></p><h4 id="（3）常见异常"><a href="#（3）常见异常" class="headerlink" title="（3）常见异常"></a>（3）常见异常</h4><ul><li><strong>端口被占用：</strong><code>java.net.BindException: Address already in use</code> 异常是因为2181端口被其他进程占用，关闭对应进程并重启ZK即可。</li><li><strong>磁盘没有剩余空间：</strong><code>java.io.IOException: No space left on device</code> 遇到此异常，ZK会立即执行Failover策略，从而退出进程。清理磁盘空间，为了避免后续再次遇到此问题，最好加上对ZK服务器磁盘使用的监控和ZK日志的自动清理。</li><li><strong>无法找到 <code>myid</code> 文件：</strong>缺少此文件，创建即可。</li><li><strong>集群中其他机器Leader选举端口未开：</strong> <code>Cannot open channel to 2 at election adress /xx.xx.xx.xx:3888</code> 这是由于启动过程中，虽然当前机器启动了，但其他机器还未启动完。ZK使用3888端口进行Leader选举过程的投票通信。</li></ul><h3 id="3-2-客户端脚本"><a href="#3-2-客户端脚本" class="headerlink" title="3.2 客户端脚本"></a>3.2 客户端脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入bin目录，确认是否连接上ZK服务器</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh zkCli.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接指定ZK服务器</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh zkCli.sh -server ip:port</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个ZK节点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> s或e分别指定节点特性顺序或临时节点，不加则默认为持久节点；acl进行权限控制，默认不加控制</span></span><br><span class="line">create [-s] [-e] path data acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在根节点下创建一个叫/zk-book的节点，内容为123</span></span><br><span class="line">create /zk-book 123</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls列出ZK指定节点下所有子节点</span></span><br><span class="line">ls path [watch]</span><br><span class="line">ls /</span><br><span class="line"><span class="meta">#</span><span class="bash"> get命令获取指定节点的数据内容和属性信息</span></span><br><span class="line">get path [watch]</span><br><span class="line">get /zk-book</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新指定节点的数据内容，version参数指定本次更新基于ZNode哪个数据版本进行</span></span><br><span class="line">set path data [version]</span><br><span class="line">set /zk-book 456</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除，要删除节点，其不能包含子节点</span></span><br><span class="line">delete path [version]</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：概述，ZAB协议，简单使用等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>分布式事务</title>
    <link href="http://linyishui.top/2021042101.html"/>
    <id>http://linyishui.top/2021042101.html</id>
    <published>2021-04-21T13:27:05.000Z</published>
    <updated>2021-05-13T08:27:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h2 id="一-从ACID到CAP-BASE"><a href="#一-从ACID到CAP-BASE" class="headerlink" title="一. 从ACID到CAP/BASE"></a>一. 从ACID到CAP/BASE</h2><h3 id="1-1-ACID"><a href="#1-1-ACID" class="headerlink" title="1.1 ACID"></a>1.1 ACID</h3><p>数据库事务和ACID可以参看：<a href="2020120801.html">《高性能MySQL》（一）架构和历史</a> 中事务章节。</p><h3 id="1-2-什么是分布式事务"><a href="#1-2-什么是分布式事务" class="headerlink" title="1.2 什么是分布式事务"></a>1.2 什么是分布式事务</h3><p>分布式数据库中，数据分散在不同的机器上，分布式事务中事务的参与者、支持事务的服务器、资源服务器以及事务管理器可能分别位于不同的节点上。</p><p>思考如何实现分布式的事务处理？</p><p>首先我们要把分布式事务看作一组分布式的操作序列，即一组子事务，所以分布式事务也具有ACID的事务特性。</p><p>实现分布式事务，保证数据的严格一致性时必然要牺牲掉部分系统可用性。</p><h3 id="1-3-CAP"><a href="#1-3-CAP" class="headerlink" title="1.3 CAP"></a>1.3 CAP</h3><p>CAP理论：一个分布式系统不可能同时满足<strong>一致性</strong>（Consistency）、<strong>可用性</strong>（Availability）和<strong>分区容错性</strong>（Partition tolerance），最多同时满足其中两项。</p><ul><li>一致性：分布式中指数据在多个副本间能否保持一致。对一个数据更新且执行成功后，所有用户都要能读到最新的值。</li><li>可用性：系统服务必须一直处于可用的状态，用户的每个操作请求总是能在<strong>有限的时间</strong>内<strong>返回结果</strong>。系统存在一个合理的响应时间，否则就会使用户对系统失望。</li><li>分区容错性：分布式系统在遇到任何网络分区故障时，仍要保证对外提供满足一致性和可用性的服务。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200102.png"></p><p>对于分布式系统来说，分区容错性是一个最基本的要求，因为分布式必然要把组件部署到不同的节点，网络问题必定会出现，所以架构设计师往往需要把精力花在如何根据业务特点在一致性和可用性之间寻求平衡。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200101.png"></p><h3 id="1-4-BASE理论"><a href="#1-4-BASE理论" class="headerlink" title="1.4 BASE理论"></a>1.4 BASE理论</h3><p>BASE 是 <strong>Basically Available（基本可用），Soft state（软状态）和 Eventually consistent（最终一致性）</strong>，是对CAP中一致性和可用性权衡的结果，核心思想是即使无法做到强一致性（Strong consistency），每个应用都可以根据自身业务特点采用适当的方式来使系统最终一致性（Eventual consistency）。</p><p><strong>基本可用</strong>，指分布式系统在出现不可预知的故障时，允许损失部分可用性，但这不等价于系统不可用：</p><ul><li><strong>响应时间上的损失</strong>：如正常情况下，搜索引擎要在0.5秒内返回给用户查询结果，但由于故障导致响应时间增加到1到2秒。</li><li><strong>功能上的损失</strong>：如正常情况下，消费者能在商城平台顺利完成每一笔订单，但在一些节日购物高峰为了保证系统稳定，部分消费者可能被引导到一个降级页面。</li></ul><p><strong>弱状态</strong>：也叫软状态，指允许系统中的数据存在中间状态，并认为该中间状态的存在不影响系统整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程出现延时。</p><p><strong>最终一致性</strong>：系统中所有的数据副本，经过一段时间的同步后，最终能够达到一个一致的状态。最终一致性的5种变种：</p><ul><li><strong>因果一致性（Causial consistency）：</strong>进程A在更新完某个数据后通知了进程B，进程B能读取到A更新后的最新值，如果B要对数据进行更新要基于此最新值，即不能发生丢失更新的情况；而与此无关的进程C无此限制。</li><li><strong>读己之所写（Read your writes）：</strong>进程A更新一个数据后，自己总能访问更新后的最新值，是一种特殊的因果一致性。</li><li><strong>会话一致性（Session consistency）：</strong>系统保证在同一个有效的会话中实现读己之所写的一致性。</li><li><strong>单调读一致性（Monotonic read consistency）：</strong>如果一个进程从系统中读出一个数据后，系统对于该进程后续的任何数据访问都不应该返回更旧的值。</li><li><strong>单调写一致性（Monotonic write consistency）：</strong>系统保证来自同一个进程的写操作被顺序的执行。</li></ul><p>现代的关系型数据库中，往往会采用同步和一步的方式来实现主备数据复制技术：</p><ul><li>同步方式：数据的复制过程通常是更新事务的一部分，因此在事务完成后，主备数据库的数据就会达到一致。</li><li>异步方式：备库的更新往往存在延时，取决于事务日志在主备数据库之间传输的时间长短，如果时间过久或传输中出现异常导致无法及时将事务应用到备库，就会导致数据不一致。</li></ul><p>BASE理论不同于传统事务ACID的强一致性模型，提出牺牲强一致性来获得可用性，允许数据在一段时间内不一致，但最终达到一致性状态。</p><h2 id="二-一致性协议"><a href="#二-一致性协议" class="headerlink" title="二. 一致性协议"></a>二. 一致性协议</h2><p>有很多的经典的一致性协议和算法来解决分布式一致性问题，最著名的有<strong>二阶段提交协议</strong>、<strong>三阶段提交协议</strong>和<strong>Paxos算法</strong>。</p><h3 id="2-1-二阶段提交-2PC"><a href="#2-1-二阶段提交-2PC" class="headerlink" title="2.1 二阶段提交-2PC"></a>2.1 二阶段提交-2PC</h3><p>2PC，即二阶段提交，Two-Phase Commit 的缩写，为了使分布式系统下所有的节点在进行事务处理过程中能保持<strong>原子性</strong>和<strong>一致性</strong>而设计的算法。目前大部分关系型数据库都采用2PC来完成分布式事务处理。</p><p>执行流程：</p><ul><li><strong>阶段一：提交事务请求</strong>（也叫投票阶段）<ol><li><strong>事务询问：</strong>协调者向所有参与者发送事务内容，询问是否可以执行事务提交操作，等待各参与者响应。</li><li><strong>执行事务：</strong>各参与者执行事务操作，并将 <code>Undo</code> 和 <code>Redo</code> 信息记入事务日志。</li><li><strong>各参与者向协调者反馈事务询问的响应：</strong>参与者成功执行了事务操作，反馈给协调者Yes响应，表示事务可以执行；若未执行成功，反馈No。</li></ol></li><li><strong>阶段二：执行事务提交</strong>（所有参与者都反馈Yes，进行阶段二）<ol><li><strong>发送提交请求：</strong>协调者向所有参与者节点发出 <code>Commit</code> 请求。</li><li><strong>事务提交：</strong>参与者收到 <code>Commit</code> 请求，正式执行事务提交操作，在完成提交后释放事务资源。</li><li><strong>反馈事务提交结果：</strong>参与者在完成事务提交之后，向协调者发送 <code>Ack</code> 消息。</li><li><strong>完成事务：</strong>协调者收到所有参与者的 <code>Ack</code> 消息后，完成事务。</li></ol></li><li><strong>中断事务：</strong>当某个参与者反馈了No响应、或等待接收所有参与者反馈超时之后，执行中断事务<ol><li><strong>发送回滚请求：</strong>协调者向所有参与者节点发出 <code>Rollback</code> 请求。</li><li><strong>事务回滚：</strong>参与者接收到 <code>Rollback</code> 请求后，利用其在阶段一中记录的 <code>Undo</code> 信息来执行事务回滚操作，并释放事务占用资源。</li><li><strong>反馈事务回滚结果：</strong>参与者完成回滚后，向协调者发送 <code>Ack</code> 消息。</li><li><strong>中断事务：</strong>协调者收到所有参与者反馈的 <code>Ack</code> 消息后，完成事务中断。</li></ol></li></ul><p>2PC的核心是每个事务都采用<strong>先尝试后提交</strong>的处理方式，可以看作一个强一致性算法。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200104.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200105.png"></p><p>优缺点：</p><ul><li>优点：原理简单，实现方便。</li><li>缺点：同步阻塞、单点问题、脑裂、太过保守<ul><li><strong>同步阻塞：</strong>在二阶段的提交过程，所有参与该事务操作的逻辑都处于阻塞状态，各个参与者在等待其他参与者响应的过程无法进行其他操作。</li><li><strong>单点问题：</strong>协调者太过重要，一旦出现问题整个流程就无法运作，如果是在阶段二出现问题，更会导致参与者都处于锁定事务资源的状态。</li><li><strong>数据不一致：</strong>在阶段二执行事务提交时，当协调者向所有参与者发生Commit请求后，发生局部网络异常或是协调者自身未发送完即崩溃，导致只有部分参与者收到了Commit请求。收到的提交事务，未收到的无法提交，出现数据不一致现象。</li><li><strong>太过保守：</strong>参与者出现故障而导致协调者始终无法获取到所有响应，此时只能依靠协调者自身的超时机制来判断是否需要中断事务，显得过于保守，没有完善的容错机制，导致一个节点的失败导致整个事务失败。</li></ul></li></ul><h3 id="2-2-三阶段提交-3PC"><a href="#2-2-三阶段提交-3PC" class="headerlink" title="2.2 三阶段提交-3PC"></a>2.2 三阶段提交-3PC</h3><p>3PC，即三阶段提交，Three-Phase Commit的缩写，针对2PC的缺陷进行了优化，将2PC的提交事务请求过程一分为2。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200106.png"></p><p>执行阶段：</p><ul><li><strong>阶段一：CanCommit</strong><ol><li><strong>事务询问：</strong>协调者向所有参与者发送一个包含事务内容的 <code>canCommit</code> 请求，询问是否可以执行事务提交操作，并开始等待各参与者响应。</li><li><strong>各参与者向协调者反馈事务询问的响应：</strong>参与者接收到 <code>canCommit</code> 请求后，若判断自己可以顺利执行事务则反馈Yes响应，并进入预备状态，否则反馈No响应。</li></ol></li><li><strong>阶段二：PreCommit</strong><ul><li><strong>执行事务预提交：</strong>协调者收到所有Yes反馈<ol><li><strong>发送预提交请求：</strong>协调者向所有参与者发送一个包含事务内容的 <code>preCommit</code> 请求，并进入 <code>Prepared</code> 阶段。</li><li><strong>事务预提交：</strong>参与者接收到 <code>preCommit</code> 请求后，执行事务操作，并将 <code>Undo</code> 和 <code>Redo</code> 信息记入事务日志。</li><li><strong>各参与者向协调者反馈事务执行的响应：</strong>参与者成功执行了事务操作，反馈给协调者 <code>Ack</code> 响应，同时等待最终指令（commit或abort）。</li></ol></li><li><strong>中断事务：</strong>任意一个参与者反馈了No响应、或等待超时后仍未收到所有参与者的反馈响应<ol><li><strong>发送中断请求：</strong>协调者向所有参与者发送 <code>abort</code> 请求。</li><li><strong>中断事务：</strong>无论是收到协调者的 <code>abort</code> 请求，或是等待协调者请求超时，参与者都会中断事务。</li></ol></li></ul></li><li><strong>阶段三：doCommit</strong><ul><li><strong>执行提交：</strong>协调者处于正常状态，且收到了所有参与者的 <code>Ack</code> 响应<ol><li><strong>发送提交请求：</strong>协调者将从预提交状态转换为提交状态，并向所有参与者发送 <code>doCommit</code> 请求。</li><li><strong>事务提交：</strong>参与者收到 <code>doCommit</code> 请求，正式执行事务提交操作，完成提交后释放事务资源。</li><li><strong>反馈事务提交结果：</strong>参与者完成事务提交后，向协调者发送 <code>Ack</code> 消息。</li><li><strong>完成事务：</strong>协调者收到所有参与者的 <code>Ack</code> 消息后，完成事务。</li></ol></li><li><strong>中断事务：</strong>协调者处于正常状态，且有任一的参与者反馈了No响应，或者等待超时后仍未收到所有参与者响应<ol><li><strong>发送中断请求：</strong>协调者向所有参与者发送 <code>abort</code> 请求。</li><li><strong>事务回滚：</strong>参与者接收到 <code>abort</code> 请求后，利用其在阶段二中记录的 <code>Undo</code> 信息来执行事务回滚操作，并释放事务占用资源。</li><li><strong>反馈事务回滚结果：</strong>参与者完成回滚后，向协调者发送 <code>Ack</code> 消息。</li><li><strong>中断事务：</strong>协调者收到所有参与者反馈的 <code>Ack</code> 消息后，完成事务中断。</li></ol></li></ul></li></ul><p>进入阶段三后可能会出现两种故障：</p><ul><li>协调者出现问题</li><li>协调者和参与者之间网络出现故障</li></ul><p>最终都会导致参与者无法及时收到 <code>doCommit</code> 请求或 <code>abort</code> 请求，这时参与者会在等待超时后继续进行事务提交。</p><p>优缺点：</p><ul><li>优点：相较2PC降低了参与者的阻塞范围，能够在出现单点故障后达成一致。</li><li>缺点：3PC在去除阻塞的同时也带来了新问题，就是在参与者收到 <code>preCommit</code> 请求后，如果网络出现分区，这时协调者所在的节点和参与者无法进行正常的网络通信，这个参与者仍会进行事务的提交，导致了数据不一致性。</li></ul><h3 id="2-3-Paxos-算法"><a href="#2-3-Paxos-算法" class="headerlink" title="2.3 Paxos 算法"></a>2.3 Paxos 算法</h3><p>Paxos 算法由 Leslie Lamport 于1990年提出的一种基于消息传递且具有高度容错特性的一致性算法，是目前公认的解决分布式一致性问题的最有效算法之一。Paxos 算法解决了分布式系统中发生任何的机器宕机或网络异常，都不会破坏整个系统的一致性。</p><p>Paxos算法支持分布式节点角色之间的轮换，避免了分布式单点的出现，既解决了无限期等待问题，也解决了脑裂问题。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">拜占庭将军问题：</span><br><span class="line"></span><br><span class="line">拜占庭帝国有多支军队，不同军队的将军之间需要制定一个统一的行动计划，从而做出进攻或撤退的决定，各个将军在地理上被分割开，只能依靠通讯员进行联络。通讯员中可能存在叛徒，可以任意的篡改消息。</span><br></pre></td></tr></table></figure><p>理论上来说，在异步系统和不可靠通道上来达到一致性状态是不可能的，因此往往假设信道是可靠的。现实中，大部分系统都部署在同一个局域网，消息被篡改的情况比较罕见；硬件或网络原因导致的消息不完整问题，只需一套简单的校验算法即可避免。因此实际工程实践中，可以假设不存在拜占庭将军问题，我们需要什么样的算法来保证一致性？</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">古希腊有一个叫 Paxos 的小岛，岛上采用议会的形式来通过法令，议员间通过信使进行消息的传递，议员或信使都是兼职的，随时可能离开议会厅，信使可能会重复的传递消息，也可能一去不回。议会协议要保证在这种情况下仍能正确的产生法令，并且不出现冲突。</span><br></pre></td></tr></table></figure><p>Paxos算法的核心是一个一致性算法，即 Lamport 的论文 The Part-Time Parliament 中提到的 synod 算法。</p><h4 id="2-3-1-问题描述"><a href="#2-3-1-问题描述" class="headerlink" title="2.3.1 问题描述"></a>2.3.1 问题描述</h4><p>对于一个一致性算法来说要保证几点：</p><ul><li>在这些被提出的提案中，只有一个会被选定。</li><li>如果没有提案被提出，就不会有被选定的提案。</li><li>当一个提案被选定后，进程应该可以获取被选定的提案信息。</li></ul><p>一致性的安全性需求：（Paxos的目标就是保证最终有一个提案被选定）</p><ul><li>只有被提出的提案才能被选定。</li><li>只能有一个值被选定。</li><li>如果某个进程认为某个提案被选定了，这个提案必须是真的被选定的那个。</li></ul><p>在该一致性算法中，有三种参与角色：Proposer（提议人）、Acceptor（接收人）和 Learner ，一个进程可能充当不只一种角色，假设不同参与者之间可以通过收发消息来进行通信：</p><ul><li>每个参与者以任意的速度执行，可能会因为出错而停止，也可能会重启。即使一个提案被选定后，所有参与者也有可能失败或重启，因此除非失败或重启的参与者可以记录某些信息，否则将无法确定最终的值。</li><li>消息在传输过程中可能会出现不可预知的延迟，也可能会重复或丢失，但是消息不会被损坏，即消息内容不会被篡改。</li></ul><h4 id="2-3-2-提案的选定"><a href="#2-3-2-提案的选定" class="headerlink" title="2.3.2 提案的选定"></a>2.3.2 提案的选定</h4><p>选定一个唯一提案，最简单的方案是只允许一个 Acceptor 存在，Proposer 只能发送提案给它，Acceptor 选择它接收到的第一个提案，这种方案存在单点故障。</p><p>存在多个 Acceptor ：Proposer 向一个 Acceptor 集合发送提案，集合中每个 Acceptor 都可能会批准该提案，当有足够多的 Acceptor 批准这个提案时，就可以认为它被选定了。</p><h4 id="2-3-3-推导过程"><a href="#2-3-3-推导过程" class="headerlink" title="2.3.3 推导过程"></a>2.3.3 推导过程</h4><p>需求：在没有失败和消息丢失的情况下，即使只有一个提案被提出，也要选出一个提案。</p><p>这就意味着<strong>P1：一个 Acceptor 必须批准它收到的第一个提案</strong>。这可能会导致每个 Acceptor 都批准了第一个提案，但没有一个提案是多数人批准的。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200107.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200108.png"></p><p>一个提案需要由半数以上的 Acceptor 批准的需求暗示着<strong>一个 Acceptor 必须能够批准不止一个提案</strong>。</p><p>Paxos 使用一个<strong>全局编号</strong>来唯一标识每一个被 Acceptor 批准的提案，当一个具有某 Value 值的提案被半数以上的 Acceptor 批准后，即该 Value 被选定了和该提案被选定了。提案变成了一个由编号和 Value 组成的组合体 “【编号, Value】”。</p><p><strong>P2：如果编号为M<del>0</del>、Value值为V<del>0</del>的提案被选定了，那么所有比编号M<del>0</del>更高的，且被选定的（被 Acceptor 批准的）提案，其Value值必须也是V<del>0</del></strong></p><p>通信是异步的，一个提案可能会在某个 Acceptor 还未收到任何提案时就被选定了，所以仍需要P1来保证提案会被选定。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200109.png"></p><p><strong>P2b：如果一个提案[M<del>0</del>, V<del>0</del>]被选定后，那么之后任何 Proposer 产生的编号更高的提案，其Value值必须也是V<del>0</del></strong></p><p>因为一个提案必须在被 Proposer 提出后才能被 Acceptor 批准，所以P2b包含P2。</p><h4 id="2-3-4-数学归纳法证明"><a href="#2-3-4-数学归纳法证明" class="headerlink" title="2.3.4 数学归纳法证明"></a>2.3.4 数学归纳法证明</h4><p>需要证明结论：**假设某个提案[M<del>0</del>, V<del>0</del>]被选定了，证明任何编号M<del>n</del>&gt;M<del>0</del>的提案，其Value值都是V<del>0</del>**。</p><p>我们可以通过对M<del>n</del>进行第二数学归纳法进行证明，即证明：**假设编号在M<del>0</del>到M<del>n-1</del>之间的提案，其Value值都是V<del>0</del>，证明编号为M<del>n</del>的提案的Value值也为V<del>0</del>**。</p><p>因为M<del>0</del>的提案已被选定，意味着肯定存在一个由半数以上的 Acceptor 组成的集合C，都批准了提案。**C中的每个 Acceptor 都批准了在M<del>0</del>到M<del>n-1</del>范围内的提案，并且每个编号在M<del>0</del>到M<del>n-1</del>之间的被批准的提案，其Value值都是V<del>0</del>**。</p><p>因为任何包含半数以上的 Acceptor 组成的集合都至少包含一个C的成员，所以如果保持下面P2c的不变性，可以认为编号为M<del>n</del>的提案的Value值也为V<del>0</del>。</p><p><strong>P2c：对于任意的M<del>n</del>和V<del>n</del>，如果提案[M<del>n</del>, V<del>n</del>]被提出，那么肯定存在一个由半数以上的 Acceptor 组出的集合S，满足以下两个两个条件中的任意一个：</strong></p><ul><li>要么，S中不存在任何批准过编号小于M<del>n</del>的提案的 Acceptor。</li><li>要么，选取S中所有 Acceptor 批准的编号小于 M<del>n</del> 的提案，其中编号最大的哪个提案其 Value 值是 V<del>n</del> 。</li></ul><p>P2c=&gt;P2b=&gt;P2，通过P2和P1保证一致性。</p><p>假设提案[M<del>0</del>, V<del>0</del>]被选定了，需要证明在P2c的前提下，对于所有的[M<del>n</del>, V<del>n</del>]，存在 V<del>n</del> = V<del>0</del> ：（第二数学归纳法）</p><ol><li>当 M<del>n</del> = M<del>0</del> + 1 时，因为[M<del>0</del>, V<del>0</del>]被选定了，一定会存在一个 Acceptor 的子集S，S中的 Acceptor 已批准了小于 M<del>n</del> 的提案，因此 V<del>n</del> 只能是S中编号小于  M<del>n</del> 但为最大编号的提案。因为 M<del>n</del> = M<del>0</del> + 1 ，所以提案是 [M<del>0</del>, V<del>0</del>] ；同时由于S和通过[M<del>0</del>, V<del>0</del>]的集合都是多数集，所以二者一定存在交集，这样 Proposer 在确定 V<del>n</del> 取值时一定会选择 V<del>0</del> 。</li><li>编号在 M<del>0</del> + 1 到 M<del>n</del> - 1 之间的Value值都为 V<del>0</del> ，要证明编号为 M<del>n</del> 的提案的Value值也为 V<del>0</del> 。根据P1c，一定会存在一个 Acceptor 的子集S，S中的 Acceptor 已批准了小于 M<del>n</del> 的提案，那么编号为 M<del>n</del> 的提案的Value值只能是S中编号小于 M<del>n</del> 但为最大编号的提案的值。只要编号落在 M<del>0</del> + 1 到 M<del>n</del> - 1 之间，那么Value值就是 V<del>0</del> ；如果不落在区间内，那肯定是 M<del>0</del> ，因为S肯定会和批准[M<del>0</del>, V<del>0</del>]的集合有交集，如果编号为 M<del>0</del> ，那么其Value值也为 V<del>0</del> 。</li></ol><h4 id="2-3-5-Proposer-生成提案"><a href="#2-3-5-Proposer-生成提案" class="headerlink" title="2.3.5 Proposer 生成提案"></a>2.3.5 Proposer 生成提案</h4><p>对于 Proposer 来说，获取已经被通过的提案远比预测未来可能被通过的提案简单。因此 <strong>Proposer 在产生一个编号为 M<del>n</del> 的提案时，必须要知道当前一个将要或已经被半数以上 Acceptor 批准的编号小于 M<del>n</del> 的最大提案编号。并且 Proposer 会要求所有 Acceptor 不再批准任何编号小于 M<del>n</del> 的提案</strong>。  </p><p><strong>提案生成算法</strong>：</p><ol><li>Proposer 选择一个新的提案编号 M<del>n</del> ，然后向某个 Acceptor 集合的成员发送请求（即编号为 M<del>n</del> 的提案的 Prepare 请求），要求该集合中的 Acceptor 做出如下回应。<ul><li>向 Proposer 承诺，保证不再批准任何编号小于 M<del>n</del> 的提案。</li><li>如果 Acceptor 已经批准过任何提案，那么其就向 Proposer 反馈当前该 Acceptor 已经批准的编号小于 M<del>n</del> 但为最大编号的那个提案的值。</li></ul></li><li>如果 Proposer 收到了来自半数以上的 Acceptor 的响应结果，那么它可以产生编号为 M<del>n</del> 、Value值为 V<del>n</del> 的提案，V<del>n</del> 是所有响应中编号最大的提案的 Value 值。还有一种情况，即半数以上都未批准过任何提案，也即响应中不包含任何提案，此时 V<del>n</del> 值可以由 Proposer 任意选择。</li></ol><p>Proposer 发送给 Acceptor 选定的提案期望获得批准的请求叫Accept请求。接受请求的 Acceptor 集合不一定是之前响应Prepare请求的那一个。</p><h4 id="2-3-6-Acceptor-批准提案"><a href="#2-3-6-Acceptor-批准提案" class="headerlink" title="2.3.6 Acceptor 批准提案"></a>2.3.6 Acceptor 批准提案</h4><p>一个 Acceptor 可能接收到两种来自 Proposer 的请求：</p><ul><li><strong>Prepare请求：</strong>Acceptor 可以在任何时候响应。</li><li><strong>Accept请求：</strong>在不违背Accept现有承诺的前提下，任意响应Accept请求。</li></ul><p><strong>P1a：一个 Acceptor 只要尚未响应过任何编号大于 M<del>n</del> 的Prepare请求，它就可以接受这个编号为 M<del>n</del> 的提案。</strong></p><h4 id="2-3-7-算法优化"><a href="#2-3-7-算法优化" class="headerlink" title="2.3.7 算法优化"></a>2.3.7 算法优化</h4><p>假设一个 Acceptor 收到了一个编号为 M<del>n</del> 的Prepare请求，但此时它已经对大于 M<del>n</del> 的Prepare请求做出了响应，因此它肯定不会再批准编号 M<del>n</del> 的提案，所以 Acceptor 没有必要对此请求做出响应，可以选择忽略这种Prepare请求。同理还可以忽略已经批准过的提案的Prepare请求。</p><p>这样 Acceptor 只需记住它已经批准的提案的最大编号和它已经做出Prepare请求响应的提案的最大编号，以便再出现故障或节点重启时也能保证P2c的不变性。</p><p>对于 Proposer 来说，只要保证不会产生相同编号的提案，可以丢弃任意提案和运行时状态信息。</p><h4 id="2-3-8-算法陈述"><a href="#2-3-8-算法陈述" class="headerlink" title="2.3.8 算法陈述"></a>2.3.8 算法陈述</h4><p>综上所述，可以得到一个类似二阶段提交的算法执行过程：</p><ul><li>阶段一<ol><li>Proposer 选择一个提案编号 M<del>n</del> ，然后向 Acceptor 的某个超过半数的子集成员发送编号为 M<del>n</del> 的Prepare请求。</li><li>如果一个 Acceptor 收到一个编号为 M<del>n</del> 的Prepare请求，且编号 M<del>n</del> 大于它已经响应的所有Prepare请求的编号，那么它会将它已经批准过的最大编号的提案作为响应反馈给 Proposer ，同时承诺不会再批准小于编号 M<del>n</del> 的任何提案。</li></ol></li><li>阶段二<ol><li>如果 Proposer 收到来自半数以上的 Acceptor 对于其发出的编号为 M<del>n</del> 的Prepare请求的响应，它就会发送一个针对[M<del>n</del>, V<del>n</del>]提案的 Accept 请求给 Acceptor （ V<del>n</del> 为收到的响应中编号最大的提案的值，若响应中不包含提案，它可以是任意值）。</li><li>如果 Acceptor 收到此 Accept 请求，只要该 Acceptor 尚未对编号大于 M<del>n</del> 的Prepare请求做出响应，它就可以通过这个提案。</li></ol></li></ul><h4 id="2-3-9-提案的获取"><a href="#2-3-9-提案的获取" class="headerlink" title="2.3.9 提案的获取"></a>2.3.9 提案的获取</h4><p>Learner 获取提案的几种方案：</p><ol><li>Learner 获取提案的前提是此提案已被半数以上的 Acceptor 批准。因此最简单的做法是一旦 Acceptor 批准了提案，就把其发送给所有的 Learner 。这种做法会让每个 Acceptor 与所有的 Learner 通信，通信次数至少为二者个数的乘积。</li><li>让所有的 Acceptor 对提案的批准情况统一发送给一个<strong>主Learner</strong>，主Learner 被通知一个提案已被选定后会负责通知其他 Learner 。此方案通过多加一个步骤，大大减少了通信次数，但带来了主Learner可能发生故障这个隐患。</li><li>针对方案二，将主Learner扩大为特定的Learner集合，从而提高可靠性。</li></ol><h4 id="2-3-10-通过选取主Proposer保证算法的活性"><a href="#2-3-10-通过选取主Proposer保证算法的活性" class="headerlink" title="2.3.10 通过选取主Proposer保证算法的活性"></a>2.3.10 通过选取主Proposer保证算法的活性</h4><p>Paxos算法可能会出现多个Proposer相互导致对方提案请求被忽略的死循环：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200110.png"></p><p>解决方案：选定一个主Proposer，并规定只有主Proposer才能提出议案。</p><p><strong>基于Best Efforts 1PC模式的事务</strong>，参考spring-data-neo4j的实现。鉴于Best Efforts 1PC模式的性能优势，以及相对简单的实现方式，它被大多数的sharding框架和项目采用</p><p><strong>事务补偿（幂等值）</strong></p><p>对于那些对性能要求很高，但对一致性要求并不高的系统，往往并不苛求系统的实时一致性，只要在一个允许的时间周期内达到最终一致性即可，这使得事务补偿机制成为一种可行的方案。事务补偿机制最初被提出是在“长事务”的处理中，但是对于分布式系统确保一致性也有很好的参考意义。笼统地讲，与事务在执行中发生错误后立即回滚的方式不同，事务补偿是一种事后检查并补救的措施，它只期望在一个容许时间周期内得到最终一致的结果就可以了。事务补偿的实现与系统业务紧密相关，并没有一种标准的处理方式。一些常见的实现方式有：对数据进行对帐检查;基于日志进行比对;定期同标准数据来源进行同步，等等。</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/24036067">https://zhuanlan.zhihu.com/p/24036067</a></p><p>事务支持：我们是将整个订单领域聚合体切分，维度一致，所以对聚合体的事务是支持的。</p><p>复杂查询：垂直切分后，就跟join说拜拜了；水平切分后，查询的条件一定要在切分的维度内，比如查询具体某个用户下的各位订单等；禁止不带切分的维度的查询，即使中间件可以支持这种查询，可以在内存中组装，但是这种需求往往不应该在在线库查询，或者可以通过其他方法转换到切分的维度来实现。</p></blockquote><p>一旦数据库被切分到多个物理结点上，我们将不能再依赖数据库自身的主键生成机制。一方面，某个分区数据库自生成的ID无法保证在全局上是唯一的；另一方面，应用程序在插入数据之前需要先获得ID,以便进行SQL路由。</p><ol><li>利用数据库自增ID和UUID</li></ol><p>优点：最简单。</p><p>缺点：单点风险、单机性能瓶颈。</p><blockquote><p>使用UUID作主键是最简单的方案，但是缺点也是非常明显的。由于UUID非常的长，除占用大量存储空间外，最主要的问题是在索引上，在建立索引和基于索引进行查询时都存在性能问题。</p></blockquote><ol start="2"><li>结合数据库维护一个Sequence表</li></ol><p>此方案的思路也很简单，在数据库中建立一个Sequence表，表的结构类似于：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`SEQUENCE`</span> (  </span><br><span class="line">    <span class="symbol">`table_name`</span> varchar(<span class="number">18</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    <span class="symbol">`nextid`</span> bigint(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`table_name`</span>)  </span><br><span class="line">) ENGINE=InnoDB</span><br></pre></td></tr></table></figure><p>每当需要为某个表的新纪录生成ID时就从Sequence表中取出对应表的nextid,并将nextid的值加1后更新到数据库中以备下次使用。此方案也较简单，但缺点同样明显：由于所有插入任何都需要访问该表，该表很容易成为系统性能瓶颈，同时它也存在单点问题，一旦该表数据库失效，整个应用程序将无法工作。有人提出使用Master-Slave进行主从同步，但这也只能解决单点问题，并不能解决读写比为1:1的访问压力问题。</p><ol start="3"><li>利用数据库集群并设置相应的步长（Flickr方案）</li></ol><p>优点：高可用、ID较简洁。</p><p>缺点：需要单独的数据库集群。</p><ol start="4"><li>Twitter Snowflake</li></ol><p>优点：高性能高可用、易拓展。</p><p>缺点：需要独立的集群以及ZK。</p><blockquote><p><a href="http://blog.sina.com.cn/s/blog_6b7c2e660102vbi2.html" title="Title">Twitter的分布式自增ID算法Snowflake</a></p><p>在分布式系统中，需要生成全局UID的场合还是比较多的，twitter的snowflake解决了这种需求，实现也还是很简单的，除去配置信息，核心代码就是毫秒级时间41位 机器ID 10位 毫秒内序列12位。</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">*</span> <span class="comment">10</span>--<span class="literal">-</span><span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0</span> --<span class="literal">-</span> <span class="comment">00000</span> --<span class="literal">-</span><span class="comment">00000</span> --<span class="literal">-</span><span class="comment">000000000000</span></span><br></pre></td></tr></table></figure><p>在上面的字符串中，第一位为未使用（实际上也可作为long的符号位），接下来的41位为毫秒级时间，然后5位datacenter标识位，5位机器ID（并不算标识符，实际是为线程标识），然后12位该毫秒内的当前毫秒内的计数，加起来刚好64位，为一个Long型。</p><p>这样的好处是，整体上按照时间自增排序，并且整个分布式系统内不会产生ID碰撞（由datacenter和机器ID作区分），并且效率较高，经测试，snowflake每秒能够产生26万ID左右，完全满足需要。</p></blockquote><ol start="5"><li>一大波GUID、Random算法</li></ol><p>优点：简单。</p><p>缺点：生成ID较长，有重复几率。</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/24036067">https://zhuanlan.zhihu.com/p/24036067</a> 博主团队采用的策略是：时间戳+用户标识码+随机数</p><p>优点有：</p><ul><li><p>方便、成本低。</p></li><li><p>基本无重复的可能。</p></li><li><p>自带分库规则，这里的用户标识码即为用户ID的后四位，在查询的场景下，只需要订单号就可以匹配到相应的库表而无需用户ID，只取四位是希望订</p></li><li><p>单号尽可能的短一些，并且评估下来四位已经足够。</p></li><li><p>可排序，因为时间戳在最前面。</p></li></ul><p>当然也有一些缺点，比如长度稍长，性能要比int/bigint的稍差等。</p></blockquote><p><a href="https://www.cnblogs.com/mayundalao/p/11798502.html">分布式事务的四种解决方案</a></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">简单整理了分布式事务相关知识，内容包括：ACID到CAP/BASE，2PC二阶段提交，3PC三阶段提交，Paxos算法等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="transaction" scheme="http://linyishui.top/tags/transaction/"/>
    
  </entry>
  
  <entry>
    <title>分布式锁</title>
    <link href="http://linyishui.top/2021042001.html"/>
    <id>http://linyishui.top/2021042001.html</id>
    <published>2021-04-20T13:26:57.000Z</published>
    <updated>2021-05-13T08:26:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="幂等"><a href="#幂等" class="headerlink" title="幂等"></a>幂等</h2><p>我们先了解一下什么叫幂等？在分布式应用中，幂等是非常重要的，也就是相同条件下对一个业务的操作，不管操作多少次，结果都是一样。</p><p>为什么要有幂等这种场景？因为在大的系统中，都是分布式部署，如：订单业务 和 库存业务有可能都是独立部署的，都是单独的服务。用户下订单，会调用到订单服务和库存服务。</p><p><img src="https://p6-tt.byteimg.com/origin/pgc-image/ee6b8a81617a444fb8bac512ee7d3ebd?from=pc" alt="海量订单产生的业务高峰期，如何避免消息的重复消费？"></p><p>因为分布式部署，很有可能在调用库存服务时，因为网络等原因，订单服务调用失败，但其实库存服务已经处理完成，只是返回给订单服务处理结果时出现了异常。这个时候一般系统会作补偿方案，也就是订单服务再此放起库存服务的调用,库存减1.</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> <span class="built_in">count</span> = <span class="built_in">count</span> <span class="number">-1</span> <span class="keyword">where</span> good_id=<span class="number">2</span></span><br></pre></td></tr></table></figure><p>这样就出现了问题，其实上一次调用已经减了1，只是订单服务没有收到处理结果。现在又调用一次，又要减1，这样就不符合业务了，多扣了。</p><p>幂等这个概念就是，不管库存服务在相同条件下调用几次，处理结果都一样。这样才能保证补偿方案的可行性。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="乐观锁方案"><a href="#乐观锁方案" class="headerlink" title="乐观锁方案"></a>乐观锁方案</h3><p>借鉴数据库的乐观锁机制，如：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update t_goods <span class="keyword">set</span> <span class="built_in">count</span> = <span class="built_in">count</span> <span class="number">-1</span> , <span class="built_in">version</span> = <span class="built_in">version</span> + <span class="number">1</span> <span class="keyword">where</span> good_id=<span class="number">2</span> <span class="keyword">and</span> <span class="built_in">version</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>根据version版本，也就是在操作库存前先获取当前商品的version版本号，然后操作的时候带上此version号。我们梳理下，我们第一次操作库存时，得到version为1，调用库存服务version变成了2；但返回给订单服务出现了问题，订单服务又一次发起调用库存服务，当订单服务传如的version还是1，再执行上面的sql语句时，就不会执行；因为version已经变为2了，where条件就不成立。这样就保证了不管调用几次，只会真正的处理一次。</p><h3 id="唯一ID-指纹码"><a href="#唯一ID-指纹码" class="headerlink" title="唯一ID + 指纹码"></a>唯一ID + 指纹码</h3><p>原理就是利用数据库主键去重，业务完成后插入主键标识</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> t_check <span class="keyword">where</span> ID<span class="operator">=</span>唯一ID <span class="operator">+</span> 指纹码</span><br></pre></td></tr></table></figure><ul><li>唯一ID就是业务表的唯一的主键，如商品ID</li><li>指纹码就是为了区别每次正常操作的码，每次操作时生成指纹码；可以用时间戳+业务编号的方式。</li></ul><p>上面的sql语句：</p><ul><li>返回如果为0 表示没有操作过，那业务操作后就可以insert into t_check(唯一ID+指纹码)</li><li>返回如果大于0 表示操作过，就直接返回</li></ul><p>好处：实现简单</p><p>坏处：高并发下数据库瓶颈</p><p>解决方案：根据ID进行分库分表进行算法路由</p><h3 id="redis原子操作"><a href="#redis原子操作" class="headerlink" title="redis原子操作"></a>redis原子操作</h3><p>利用redis的原子操作，做个操作完成的标记。这个性能就比较好。但会遇到一些问题。</p><p>第一：我们是否需要把业务结果进行数据落库，如果落库，关键解决的问题时数据库和redis操作如何做到原子性？</p><blockquote><p>这个意思就是库存减1了，但redis进行操作完成标记时，失败了怎么办？也就是一定要保证落库和redis 要么一起成功，要么一起失败</p></blockquote><p>第二：如果不进行落库，那么都存储到缓存中，如何设置定时同步策略？</p><blockquote><p>这个意思就是库存减1，不落库，直接先操作redis操作完成标记，然后由另外的同步服务进行库存落库，这个就是增加了系统复杂性，而且同步策略如何设置</p></blockquote><ul><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/zhishixingqiu/?zhihu">《Java 2019 超神之路》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Dubbo/good-collection/?zhihu">《Dubbo 实现原理与源码解析 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring/good-collection/?zhihu">《Spring 实现原理与源码解析 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/MyBatis/good-collection/?zhihu">《MyBatis 实现原理与源码解析 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring-MVC/good-collection/?zhihu">《Spring MVC 实现原理与源码解析 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring-Boot/good-collection/?zhihu">《Spring Boot 实现原理与源码解析 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Entity/good-collection/?zhihu">《数据库实体设计合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Interview/good-collection/?zhihu">《Java 面试题 —— 精品合集》</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Interview/good-collection/?zhihu">《Java 学习指南 —— 精品合集》</a></li></ul><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">简单整理了分布式锁相关知识，内容包括：等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="lock" scheme="http://linyishui.top/tags/lock/"/>
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
  </entry>
  
</feed>
