<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ä¿ºçš„éƒ¨è½æ ¼</title>
  
  <subtitle>ä¿ºå¯»æ€ä¿ºéœ€è¦è®°ç‚¹ä¸œè¥¿</subtitle>
  <link href="http://linyishui.top/atom.xml" rel="self"/>
  
  <link href="http://linyishui.top/"/>
  <updated>2021-07-28T10:42:48.000Z</updated>
  <id>http://linyishui.top/</id>
  
  <author>
    <name>Lys</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BeanéªŒè¯â€”â€”Hibernate Validator</title>
    <link href="http://linyishui.top/2021072201.html"/>
    <id>http://linyishui.top/2021072201.html</id>
    <published>2021-07-22T08:11:09.000Z</published>
    <updated>2021-07-28T10:42:48.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hibernate-Validator"><a href="#Hibernate-Validator" class="headerlink" title="Hibernate Validator"></a>Hibernate Validator</h1><h2 id="ä¸€-BeanéªŒè¯"><a href="#ä¸€-BeanéªŒè¯" class="headerlink" title="ä¸€. BeanéªŒè¯"></a>ä¸€. BeanéªŒè¯</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯BeanéªŒè¯"><a href="#1-1-ä»€ä¹ˆæ˜¯BeanéªŒè¯" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯BeanéªŒè¯"></a>1.1 ä»€ä¹ˆæ˜¯BeanéªŒè¯</h3><p>å¸¸è§çš„ä¸šåŠ¡æ ¡éªŒåœºæ™¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (employee.getFirstName() == <span class="keyword">null</span> || employee.getFirstName().trim().length() == <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;validate.employee.firstName&quot;</span>);</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>å½“ä¸šåŠ¡è§„åˆ™å¤æ‚æ—¶ï¼Œç±»ä¼¼çš„æ¡ä»¶åˆ¤æ–­éœ€è¦å¾ˆå¤šæ‰èƒ½å®ç°ã€‚</p><p>BeanéªŒè¯æ˜¯ä¸€ä¸ªJava EEçš„APIï¼Œç”¨æ¥è‡ªåŠ¨éªŒè¯åœ¨Java beanä¸Šå£°æ˜çš„ä¸šåŠ¡é€»è¾‘ã€‚å…¶åŒ…å«ä¸€ä¸ªå…ƒæ•°æ®æ¨¡å‹ï¼ˆä¸€ä¸ªæ³¨è§£çš„é›†åˆï¼‰ï¼Œå…¶ä¸­ä¸ºæŒ‡å®šçš„ç±»å£°æ˜äº†ä¸šåŠ¡è§„åˆ™å’Œä¸€ä¸ªä½¿ç”¨éªŒè¯å·¥å…·çš„APIã€‚</p><p>é€šè¿‡ä¸ºå­—æ®µã€æ–¹æ³•ç­‰æ·»åŠ æ³¨è§£çš„æ–¹å¼ï¼ŒæŒ‡å®šå¦‚ä½•åœ¨è¢«æ ‡æ³¨çš„ç›®æ ‡ä¸Šä½¿ç”¨ç‰¹å®šçš„çº¦æŸã€‚</p><h3 id="1-2-ä¸ºä»€ä¹ˆé€‰ç”¨Hibernate-Validator"><a href="#1-2-ä¸ºä»€ä¹ˆé€‰ç”¨Hibernate-Validator" class="headerlink" title="1.2 ä¸ºä»€ä¹ˆé€‰ç”¨Hibernate Validator"></a>1.2 ä¸ºä»€ä¹ˆé€‰ç”¨Hibernate Validator</h3><p>Hibernate Validator 5.0 æ˜¯ JSR 349çš„å‚è€ƒå®ç°ï¼Œå®ƒå…¼å®¹äºæ­¤è§„èŒƒï¼Œæ˜¯BeanéªŒè¯å®ç°ä¸­åº”ç”¨æœ€å¹¿æ³›çš„ã€‚</p><p>Spring Frameworkè‡ªåŠ¨ä¸ºä½¿ç”¨ Java Bean éªŒè¯çš„ã€ç”±Springç®¡ç†çš„beanåˆ›å»ºä»£ç†ã€‚å®ƒå°†æ‹¦æˆªå¯¹æ·»åŠ äº†æ³¨è§£çš„æ–¹æ³•çš„è°ƒç”¨å¹¶è¿›è¡Œé€‚å½“çš„éªŒè¯ï¼Œæ£€æŸ¥ä½¿ç”¨è€…æ˜¯å¦æä¾›äº†æœ‰æ•ˆçš„å‚æ•°æˆ–è¯¥å®ç°çš„è¿”å›å€¼æ˜¯å¦æœ‰æ•ˆï¼ˆå¸¸ç”¨æ³¨è§£ <code>@javax.validation.Valid</code> ï¼‰ã€‚</p><h2 id="äºŒ-åœ¨Spring-Frameworkå®¹å™¨ä¸­é…ç½®éªŒè¯"><a href="#äºŒ-åœ¨Spring-Frameworkå®¹å™¨ä¸­é…ç½®éªŒè¯" class="headerlink" title="äºŒ. åœ¨Spring Frameworkå®¹å™¨ä¸­é…ç½®éªŒè¯"></a>äºŒ. åœ¨Spring Frameworkå®¹å™¨ä¸­é…ç½®éªŒè¯</h2><p>æ‰‹åŠ¨éªŒè¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">Validator validator = factory.getValidator();</span><br><span class="line">Set&lt;ConstraintViolation&lt;Employee&gt; violations = validator.validate(employee);</span><br><span class="line"><span class="keyword">if</span> (violations.size() &gt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(violations);</span><br></pre></td></tr></table></figure><p>é…ç½®Spring Frameworkå¼€å¯è‡ªåŠ¨éªŒè¯ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥å’Œä»£ç†æ”¯æŒï¼Œå®Œæˆ4ä¸ªé…ç½®ï¼š</p><ul><li>éªŒè¯å™¨</li><li>éªŒè¯å™¨æ¶ˆæ¯çš„æœ¬åœ°åŒ–</li><li>æ–¹æ³•éªŒè¯å¤„ç†å™¨</li><li>Spring MVCè¡¨å•éªŒè¯</li></ul><p>Spring Frameworkåœ¨Bean Validationå‡ºç°ä¹‹å‰å°±æä¾›äº† <code>org.springframework.validation.Validator</code> æ¥å£æ”¯æŒå¯¹è±¡è‡ªåŠ¨éªŒè¯ï¼Œé€šè¿‡æ³¨è§£çº¦æŸæŒ‡å®šéªŒè¯å¯¹è±¡çš„å·¥å…·ã€‚</p><p>éªŒè¯é”™è¯¯ä¼šä½¿ç”¨ <code>org.springframework.validation.Errors</code> æ¥å£ï¼Œè€Œä¸æ˜¯è¿”å›ä¸€ä¸ª <code>Set&lt;javax.validation.ObjectError&gt;</code> ã€‚è¯¥æ¥å£æä¾›äº†å¯¹ä¸€ä¸ªæˆ–å¤šä¸ª <code>ObjectError</code> å’Œ <code>FieldError</code> çš„è®¿é—®ã€‚</p><p>é…ç½®Spring Frameworkçš„éªŒè¯æ—¶ï¼Œéœ€è¦åŒæ—¶å®ç°Validatorå’ŒSpring Validatorï¼Œå³ç»§æ‰¿äº† <code>org.springframework.validation.beanvalidation.SpringValidatorAdapter</code> çš„ç±»ï¼Œå¯é€‰ï¼š</p><ul><li><code>javax.validation.beanvalidation.CustomValidatorBean</code> </li><li><code>javax.validation.beanvalidation.LocalValidatorFactoryBean</code> ï¼šæ”¯æŒè·å–åº•å±‚çš„Validatorï¼Œä¸”æ”¯æŒä½¿ç”¨åº”ç”¨ç¨‹åºçš„å…¶ä»–ä»£ç ç”¨äºå›½é™…åŒ–çš„ç›¸åŒMessageSourceå’Œèµ„æºåŒ…æ–‡ä»¶ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalValidatorFactoryBeanå°†è‡ªåŠ¨æ£€æµ‹åˆ°ç±»è·¯å¾„ä¸Šçš„Bean Validationå®ç°ï¼Œä½¿ç”¨ValidatorFactoryä½œä¸ºæ”¯æŒå·¥å‚ï¼Œå¦‚æœæœ‰å¤šä¸ªå®ç°ç±»åˆ™ä¼šéšæœºæŒ‘é€‰ã€‚</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœ€ç®€å•çš„è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    <span class="comment">// åŠ¨æ€åŠ è½½çš„å†™æ³•</span></span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setProvider(Class.forName(<span class="string">&quot;org.hibernate.validator.HibernateValidator&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡LocalValidatorFactoryBeanè®¾ç½®æœ‰æ•ˆçš„MessageSourceï¼Œè‡ªåŠ¨æä¾›ä¸€ä¸ªç”±MessageSourceä½œä¸ºæ”¯æŒçš„æ’å€¼å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šé”™è¯¯ä»£ç å’Œé”™è¯¯æ¶ˆæ¯</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReloadableResourceBundleMessageSource messageSource = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">    messageSource.setCacheSeconds(-<span class="number">1</span>);</span><br><span class="line">    messageSource.setDefaultEncoding(StandardCharsets.UTF_8.name());</span><br><span class="line">    messageSource.setBasenames(<span class="string">&quot;/WEB-INF/il8n/titles&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/messages&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/errors&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/validation&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> messageSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setValidationMessageSource(<span class="keyword">this</span>.messageSource());</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹æ³•éªŒè¯Beanåå¤„ç†å™¨ï¼Œå¯ä»¥åœ¨å®¹å™¨å®Œæˆå¯åŠ¨è¿‡ç¨‹ä¹‹å‰é…ç½®ã€è‡ªå®šä¹‰å’Œæ›¿æ¢é…ç½®ä¸­çš„beanã€‚</p><h2 id="ä¸‰-ä¸ºbeanæ·»åŠ çº¦æŸéªŒè¯æ³¨è§£"><a href="#ä¸‰-ä¸ºbeanæ·»åŠ çº¦æŸéªŒè¯æ³¨è§£" class="headerlink" title="ä¸‰. ä¸ºbeanæ·»åŠ çº¦æŸéªŒè¯æ³¨è§£"></a>ä¸‰. ä¸ºbeanæ·»åŠ çº¦æŸéªŒè¯æ³¨è§£</h2><h2 id="å››-ä¸ºæ–¹æ³•éªŒè¯é…ç½®Spring-bean"><a href="#å››-ä¸ºæ–¹æ³•éªŒè¯é…ç½®Spring-bean" class="headerlink" title="å››. ä¸ºæ–¹æ³•éªŒè¯é…ç½®Spring bean"></a>å››. ä¸ºæ–¹æ³•éªŒè¯é…ç½®Spring bean</h2><h2 id="äº”-ç¼–å†™è‡ªå®šä¹‰éªŒè¯çº¦æŸ"><a href="#äº”-ç¼–å†™è‡ªå®šä¹‰éªŒè¯çº¦æŸ" class="headerlink" title="äº”. ç¼–å†™è‡ªå®šä¹‰éªŒè¯çº¦æŸ"></a>äº”. ç¼–å†™è‡ªå®šä¹‰éªŒè¯çº¦æŸ</h2><h2 id="å…­-åœ¨å®¢æˆ·æ”¯æŒåº”ç”¨ç¨‹åºä¸­é›†æˆéªŒè¯"><a href="#å…­-åœ¨å®¢æˆ·æ”¯æŒåº”ç”¨ç¨‹åºä¸­é›†æˆéªŒè¯" class="headerlink" title="å…­. åœ¨å®¢æˆ·æ”¯æŒåº”ç”¨ç¨‹åºä¸­é›†æˆéªŒè¯"></a>å…­. åœ¨å®¢æˆ·æ”¯æŒåº”ç”¨ç¨‹åºä¸­é›†æˆéªŒè¯</h2><h2 id="ä¸ƒ-ä½¿ç”¨"><a href="#ä¸ƒ-ä½¿ç”¨" class="headerlink" title="ä¸ƒ. ä½¿ç”¨"></a>ä¸ƒ. ä½¿ç”¨</h2><h3 id="7-1-ä½¿ç”¨Hibernate-Validate"><a href="#7-1-ä½¿ç”¨Hibernate-Validate" class="headerlink" title="7.1 ä½¿ç”¨Hibernate Validate"></a>7.1 ä½¿ç”¨Hibernate Validate</h3><p><strong>å¼•å…¥ä¾èµ–</strong>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å¸¸ç”¨æ³¨è§£è¯´æ˜</strong>ï¼š</p><table><thead><tr><th>æ³¨è§£</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>@Length(min=,max=)</td><td>æ£€æŸ¥æ‰€å±çš„å­—æ®µçš„é•¿åº¦æ˜¯å¦åœ¨minå’Œmaxä¹‹é—´ï¼Œåªèƒ½ç”¨äºå­—ç¬¦ä¸²</td></tr><tr><td>@Range(min=,max=,message=)</td><td>è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»åœ¨åˆé€‚çš„èŒƒå›´å†…</td></tr><tr><td>@Max</td><td>è¯¥å­—æ®µçš„å€¼åªèƒ½å°äºæˆ–ç­‰äºè¯¥å€¼</td></tr><tr><td>@Min</td><td>è¯¥å­—æ®µçš„å€¼åªèƒ½å¤§äºæˆ–ç­‰äºè¯¥å€¼</td></tr><tr><td>@NotNull</td><td>ä¸èƒ½ä¸ºnull</td></tr><tr><td>@NotBlank</td><td>ä¸èƒ½ä¸ºç©ºï¼Œæ£€æŸ¥æ—¶ä¼šå°†ç©ºæ ¼å¿½ç•¥</td></tr><tr><td>@NotEmpty</td><td>ä¸èƒ½ä¸ºç©ºï¼Œè¿™é‡Œçš„ç©ºæ˜¯æŒ‡ç©ºå­—ç¬¦ä¸²</td></tr><tr><td>@Pattern(regex=,flag=)</td><td>è¢«æ³¨é‡Šçš„å…ƒç´ å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼</td></tr></tbody></table><p><strong>ä½¿ç”¨</strong>ï¼š</p><p>éœ€è¦æ­é…åœ¨Controllerä¸­æ­é…@Validatedæˆ–@Validæ³¨è§£ä¸€èµ·ä½¿ç”¨ï¼Œ@Validatedå’Œ@Validæ³¨è§£åŒºåˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä»»é€‰ä¸€ä¸ªå³å¯ï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ³¨è§£</th><th>@Validated</th><th>@Valid</th></tr></thead><tbody><tr><td>æ‰€å±çš„åŒ…</td><td>å±äºorg.springframework.validation.annotationåŒ…ä¸‹çš„,æ˜¯springæä¾›çš„</td><td>å±äºjavax.validationåŒ…ä¸‹,æ˜¯jdkç»™æä¾›çš„</td></tr><tr><td>æ˜¯å¦æ”¯æŒåˆ†ç»„å’Œæ’åº</td><td>æ˜¯</td><td>å¦</td></tr></tbody></table><p>è™½ç„¶@Validatedæ¯”@Validæ›´åŠ å¼ºå¤§ï¼Œåœ¨@Validä¹‹ä¸Šæä¾›äº†åˆ†ç»„åŠŸèƒ½å’ŒéªŒè¯æ’åºåŠŸèƒ½ã€‚Hibernate-validateæ¡†æ¶ä¸­çš„æ³¨è§£æ˜¯éœ€è¦åŠ åœ¨å®ä½“ä¸­ä¸€èµ·ä½¿ç”¨çš„ï¼š</p><ul><li>å®šä¹‰ä¸€ä¸ªå®ä½“ï¼šmessageå­—æ®µä¸ºä¸ç¬¦åˆæ ¡éªŒè§„åˆ™æ—¶æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSetSaveVO</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡è¯†ç¬¦ä¸ºç©º</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;user uuid is empty&quot;)</span></span><br><span class="line">    <span class="comment">//ç”¨æˆ·åç§°åªèƒ½æ˜¯å­—æ¯å’Œæ•°å­—</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[a-z0-9]+$&quot;, message = &quot;user names can only be alphabetic and numeric&quot;)</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;user uuid length over 48 byte&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userUuid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ•°æ®é›†åç§°åªèƒ½æ˜¯å­—æ¯å’Œæ•°å­—</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[A-Za-z0-9]+$&quot;, message = &quot;data set names can only be letters and Numbers&quot;)</span></span><br><span class="line">    <span class="comment">//æ–‡ä»¶åç§°è¿‡é•¿</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;file name too long&quot;)</span></span><br><span class="line">    <span class="comment">//æ–‡ä»¶åç§°ä¸ºç©º</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;file name is empty&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ•°æ®é›†æè¿°æœ€å¤šä¸º256å­—èŠ‚</span></span><br><span class="line">    <span class="meta">@Length(max = 256, message = &quot;data set description length over 256 byte&quot;)</span></span><br><span class="line">    <span class="comment">//æ•°æ®é›†æè¿°ä¸ºç©º</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;data set description is null&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Controllerå±‚ä¸­çš„æ–¹æ³•ï¼šåœ¨æ ¡éªŒçš„å®ä½“DataSetSaveVOæ—è¾¹æ·»åŠ @Validæˆ–@Validatedæ³¨è§£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseVO <span class="title">createDataSet</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> DataSetSaveVO dataSetVO)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.success(dataSetService.saveDataSet(dataSetVO));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-ä½¿ç”¨commons-lang3"><a href="#7-2-ä½¿ç”¨commons-lang3" class="headerlink" title="7.2 ä½¿ç”¨commons-lang3"></a>7.2 ä½¿ç”¨commons-lang3</h3><p><strong>å¼•å…¥ä¾èµ–</strong>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å¸¸ç”¨æ–¹æ³•è¯´æ˜</strong>ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>CollectionUtils.isEmpty</td><td>åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©ºï¼Œä¸ºnullæˆ–è€…size==0ï¼Œè¿”å›true</td></tr><tr><td>CollectionUtils.isNotEmpty</td><td>åˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºéç©º</td></tr><tr><td>StringUtils.isEmpty</td><td>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º</td></tr><tr><td>StringUtils.isNotEmpty</td><td>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦éç©º</td></tr><tr><td>StringUtils.isBlank</td><td>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºï¼Œä¸ºnullæˆ–è€…size==0æˆ–è€…åªå­˜åœ¨ç©ºç™½å­—ç¬¦(å¦‚â€ â€œ)ï¼Œåˆ™è¿”å›true</td></tr><tr><td>StringUtils.isNotBlank</td><td>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºéç©º</td></tr></tbody></table><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//StringUtils.isEmpty</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;  &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"><span class="comment">//StringUtils.isNotEmpty</span></span><br><span class="line">System.out.println(StringUtils.isNotEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//false</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">//StringUtils.isBlank</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//true</span></span><br><span class="line"><span class="comment">//StringUtils.isNotBlank</span></span><br><span class="line">System.out.println(StringUtils.isNotBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; emptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Integer&gt; nullList = <span class="keyword">null</span>;</span><br><span class="line">List&lt;Integer&gt; notEmptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">notEmptyList.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(emptyList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(nullList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(notEmptyList));   <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isNotEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(emptyList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(nullList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(notEmptyList));   <span class="comment">//true</span></span><br></pre></td></tr></table></figure><h3 id="7-3-è‡ªå®šä¹‰æ³¨è§£"><a href="#7-3-è‡ªå®šä¹‰æ³¨è§£" class="headerlink" title="7.3 è‡ªå®šä¹‰æ³¨è§£"></a>7.3 è‡ªå®šä¹‰æ³¨è§£</h3><p>å½“ä¸Šé¢çš„æ–¹é¢éƒ½æ— æ³•æ»¡è¶³æ ¡éªŒçš„éœ€æ±‚ä»¥åï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£</p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”—ã€ŠJava Webé«˜çº§ç¼–ç¨‹â€”æ¶µç›–WebSocketsã€Spring Frameworkã€JPA Hibernateã€Spring Securityã€‹</p><p>ğŸ”— <a href="https://juejin.cn/post/6913735652806754311">Springbootä¸­å¦‚ä½•ä¼˜é›…è¿›è¡Œå­—æ®µæ ¡éªŒ </a></p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªäºã€ŠJava Webé«˜çº§ç¼–ç¨‹â€”æ¶µç›–WebSocketsã€Spring Frameworkã€JPA Hibernateã€Spring Securityã€‹ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="Spring" scheme="http://linyishui.top/tags/Spring/"/>
    
    <category term="Hibernate" scheme="http://linyishui.top/tags/Hibernate/"/>
    
    <category term="Spring Framework" scheme="http://linyishui.top/tags/Spring-Framework/"/>
    
  </entry>
  
  <entry>
    <title>Hexoæ­å»ºä¸ªäººåšå®¢ (å››) å‡çº§ä¸åŠŸèƒ½é…ç½®ï¼ˆæŒç»­æ›´æ–°ï¼‰</title>
    <link href="http://linyishui.top/2021070101.html"/>
    <id>http://linyishui.top/2021070101.html</id>
    <published>2021-07-01T02:19:15.000Z</published>
    <updated>2021-07-10T09:59:12.624Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" id=6851165123 server="netease" type="playlist" ></meting-js><h1 id="å‡çº§ä¸åŠŸèƒ½é…ç½®"><a href="#å‡çº§ä¸åŠŸèƒ½é…ç½®" class="headerlink" title="å‡çº§ä¸åŠŸèƒ½é…ç½®"></a>å‡çº§ä¸åŠŸèƒ½é…ç½®</h1><h2 id="ä¸€-Hexoå‡çº§"><a href="#ä¸€-Hexoå‡çº§" class="headerlink" title="ä¸€. Hexoå‡çº§"></a>ä¸€. Hexoå‡çº§</h2><p>ä»2018å¹´åä¸€ç›´æœªæ›´æ–°Hexoå’ŒNextä¸»é¢˜ç‰ˆæœ¬ï¼Œä¸­é—´è·¨äº†å¥½å‡ ä¸ªå¤§ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°è¯•ç›´æ¥å‡çº§è‡³æœ€æ–°ç‰ˆæœ¬ã€‚</p><p>å½“å‰æœ€æ–°Nextä¸»é¢˜ï¼š<a href="https://github.com/next-theme/hexo-theme-next">hexo-theme-next</a></p><h3 id="1-1-Hexoå‡çº§"><a href="#1-1-Hexoå‡çº§" class="headerlink" title="1.1 Hexoå‡çº§"></a>1.1 Hexoå‡çº§</h3><p>æ‰§è¡Œ <code>npm outdated</code> æŸ¥çœ‹æ‰€æœ‰å¯ä»¥å‡çº§çš„æ’ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-check     //å®‰è£…npm-check</span><br><span class="line">npm-check                    //æŸ¥çœ‹ç³»ç»Ÿæ’ä»¶æ˜¯å¦éœ€è¦å‡çº§</span><br><span class="line">npm install -g npm-upgrade   //å®‰è£…npm-upgrade</span><br><span class="line">npm-upgrade        //æ›´æ–°package.json</span><br><span class="line">//åœ¨æ‰§è¡Œnpm-upgradeå‘½ä»¤åä¼šè¦æ±‚è¾“å…¥yesæˆ–è€…noï¼Œç›´æ¥è¾“å…¥Yesæˆ–Yå³å¯</span><br><span class="line">npm update -g      //æ›´æ–°å…¨å±€æ’ä»¶</span><br><span class="line">npm update --save  //æ›´æ–°ç³»ç»Ÿæ’ä»¶</span><br></pre></td></tr></table></figure><h3 id="1-2-ä¸»é¢˜æ›´æ–°"><a href="#1-2-ä¸»é¢˜æ›´æ–°" class="headerlink" title="1.2 ä¸»é¢˜æ›´æ–°"></a>1.2 ä¸»é¢˜æ›´æ–°</h3><p>åœ¨<strong>ä¸»é¢˜çš„æ ¹ç›®å½•</strong>ï¼ˆæ³¨æ„ä¸æ˜¯åšå®¢æ ¹ç›®å½•ï¼‰ï¼Œæ‰“å¼€å‘½ä»¤è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git pull</span></span><br></pre></td></tr></table></figure><p>Nextä¸»é¢˜ä»5.Xç‰ˆæœ¬å‡çº§ï¼Œå› ä¸ºå·®å¼‚è¾ƒå¤§ï¼Œéœ€è¦å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/theme-next/hexo-theme-next/blob/master/docs/zh-CN/UPDATE-FROM-5.1.X.md">ä» NexT v5.1.x æ›´æ–°</a>ã€‚</p><h3 id="1-3-npmæ›´æ–°"><a href="#1-3-npmæ›´æ–°" class="headerlink" title="1.3 npmæ›´æ–°"></a>1.3 npmæ›´æ–°</h3><p>npmæ›´æ–°å…¨å±€å®‰è£…çš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm update -g</span><br></pre></td></tr></table></figure><p>npm æ›´æ–°ç«™ç‚¹æ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸‹å®‰è£…çš„ä¾èµ–åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm update</span></span><br></pre></td></tr></table></figure><p>æ›´æ–° npmï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install npm -g</span><br></pre></td></tr></table></figure><p>æ›´æ–° Node.js åˆ°æœ€æ–°ç‰ˆï¼ˆLinuxï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹å½“å‰nodeç‰ˆæœ¬</span></span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br><span class="line"></span><br><span class="line">npm install -g n</span><br><span class="line"></span><br><span class="line">n latest</span><br></pre></td></tr></table></figure><p>æ›´æ–° Node.js åˆ°æœ€æ–°ç‰ˆWin10ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹åŸnodejså®‰è£…ç›®å½•</span></span><br><span class="line">where node </span><br><span class="line">npm config list | findstr location</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½æœ€æ–°nodejså®‰è£…åŒ…æ”¾åœ¨åŸå®‰è£…ç›®å½•ä¸‹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®˜ç½‘: https://nodejs.org/en/download/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ·˜å®é•œåƒ: https://npm.taobao.org/mirrors/node/v14.15.2/</span></span><br></pre></td></tr></table></figure><h3 id="1-4-é—®é¢˜è®°å½•"><a href="#1-4-é—®é¢˜è®°å½•" class="headerlink" title="1.4 é—®é¢˜è®°å½•"></a>1.4 é—®é¢˜è®°å½•</h3><p>é—®é¢˜ <code>  err: Error: Cannot find module &#39;hexo-util&#39;</code> ç¼ºå°‘ <a href="https://www.npmjs.com/package/hexo-util">hexo-util</a> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…hexo-util</span></span><br><span class="line">npm install hexo-util --save</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>hexo generator</code> å‘½ä»¤åï¼Œ<code>themes/next/scripts/events/lib/vendors.js</code> ä»£ç é‡Œé¢è§£æ <code>local</code> çš„ <code>call</code> ä¸€ç›´å‡ºç°ä»¥ä¸‹é”™è¯¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: TypeError: Cannot read property &#x27;call&#x27; of undefined</span><br><span class="line">      at module.exports (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/lib/vendors.js:27:25)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/index.js:9:27)</span><br><span class="line">      at Hexo.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/method.js:15:34)</span><br><span class="line">      at /home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/hexo/lib/extend/filter.js:67:52</span><br><span class="line">      at tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Object.gotValue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:166:18)</span><br><span class="line">      at Object.gotAccum (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:155:25)</span><br><span class="line">      at Object.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Promise._settlePromiseFromHandler (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">      at Promise._settlePromise (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">      at Promise._settlePromiseCtx (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:641:10)</span><br><span class="line">      at _drainQueueStep (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:97:12)</span><br><span class="line">      at _drainQueue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:86:9)</span><br><span class="line">      at Async._drainQueues (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:102:5)</span><br><span class="line">      at Immediate.Async.drainQueues [as _onImmediate] (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:15:14)</span><br><span class="line">      at processImmediate (internal/timers.js:461:21)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŠ¥é”™æ˜¯æ²¡æ‰¾åˆ° <code>hexo-util</code> çš„ <code>url_for</code> ï¼Œå¯èƒ½æ˜¯ <code>hexo-util</code> æ¨¡å—æ›´æ–°å¤±è´¥ï¼Œæœ€ç»ˆå¯¼è‡´ä»£ç ä¸å…¼å®¹ã€‚é¦–å…ˆæ£€æŸ¥ <code>hexo-util</code> æ¨¡å—çš„ç‰ˆæœ¬ï¼Œç„¶åå¯ä»¥å°è¯•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¼ºåˆ¶æ›´æ–° NPM æ¨¡å—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥åšå®¢çš„ä¸»é¢˜ç›®å½•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /boot-root/</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¼ºåˆ¶æ›´æ–°</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm update --save --force</span></span><br></pre></td></tr></table></figure><h2 id="äºŒ-åŠŸèƒ½é…ç½®-æ•´ä½“"><a href="#äºŒ-åŠŸèƒ½é…ç½®-æ•´ä½“" class="headerlink" title="äºŒ. åŠŸèƒ½é…ç½®-æ•´ä½“"></a>äºŒ. åŠŸèƒ½é…ç½®-æ•´ä½“</h2><p>æœ‰äº›æ—§ç‰ˆçš„è®¾ç½®ï¼Œæ–°ç‰ˆå› ä¸ºè§‰å¾—æ²¡å¿…è¦ã€æˆ–æœªæ‰¾åˆ°ä¿®æ”¹æ–¹æ¡ˆåœ¨èœå•ä¸­æ ‡è®°äº†ï¼ˆæ—§ç‰ˆæœ¬ï¼‰ã€‚</p><h3 id="2-1-ä¿®æ”¹ä¸»é¢˜é£æ ¼"><a href="#2-1-ä¿®æ”¹ä¸»é¢˜é£æ ¼" class="headerlink" title="2.1 ä¿®æ”¹ä¸»é¢˜é£æ ¼"></a>2.1 ä¿®æ”¹ä¸»é¢˜é£æ ¼</h3><p>nexTé»˜è®¤ <code>Scheme: Muse</code> ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­çš„schemeï¼š</p><ul><li><p>Muse - é»˜è®¤ Schemeï¼Œè¿™æ˜¯ NexT æœ€åˆçš„ç‰ˆæœ¬ï¼Œé»‘ç™½ä¸»è°ƒï¼Œå¤§é‡ç•™ç™½</p></li><li><p>Mist - Muse çš„ç´§å‡‘ç‰ˆæœ¬ï¼Œæ•´æ´æœ‰åºçš„å•æ å¤–è§‚</p></li><li><p>Pisces - åŒæ  Schemeï¼Œå°å®¶ç¢§ç‰ä¼¼çš„æ¸…æ–°</p></li><li><p>Gemini - ä¸å¤ªæ¸…æ¥šï¼Œæœ‰æƒ³æ³•å¯ä»¥è¯•ç”¨ä¸€ä¸‹</p></li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280204.png"></p><h3 id="2-2-æ·»åŠ å¤´åƒ"><a href="#2-2-æ·»åŠ å¤´åƒ" class="headerlink" title="2.2 æ·»åŠ å¤´åƒ"></a>2.2 æ·»åŠ å¤´åƒ</h3><p>æ–°å»º <code>source/images/</code> ç›®å½•ï¼Œå¤åˆ¶è¿›å»ä¸€äº›å›¾ç‰‡ï¼ˆå¯ä»¥æ˜¯åŠ¨å›¾Gifï¼‰ï¼Œåœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ <code>\_config.yml</code> æ·»åŠ ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤´åƒ</span></span><br><span class="line"><span class="attr">avatar:</span> <span class="string">/images/riho_yoshioka1.jpg</span></span><br></pre></td></tr></table></figure><p>ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> è‹¥è®¾ç½®äº†ï¼Œä¼šä¼˜å…ˆäºå‰è€…ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">XXX</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é‡‡ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼š</p><ol><li><p>é¦–å…ˆåœ¨ç½‘ä¸Šæ‰¾æˆ–è€…è‡ªå·±PSä¸€å¼ å¿ƒä»ªçš„å›¾ç‰‡ï¼Œå–å <code>background.jpg</code> ï¼ŒæŠŠå®ƒæ”¾åœ¨ <code>Hexo\source\image</code> è·¯å¾„ä¸‹ï¼ˆæˆ–è€…ç›´æ¥ä½¿ç”¨å›¾åºŠçš„å›¾ç‰‡åœ°å€ï¼‰ã€‚</p></li><li><p>è¿›å…¥ <code>Hexo\themes\hexo-theme-next\source\css\_common\components\header</code> ç›®å½•ï¼Œæ‰¾åˆ° <code>header.styl</code> æ–‡ä»¶ï¼ŒåŒå‡»æ‰“å¼€ã€‚å°†ç¬¬ä¸€è¡Œé»˜è®¤çš„ <code>.header &#123; background: $head-bg; &#125;</code> ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢çš„url()é‡Œä¸ä¸€å®šéè¦å¡«ç›¸å¯¹è·¯å¾„ï¼Œå¡«ä¸€ä¸ªèƒ½è®¿é—®çš„urlå³å¯</span></span><br><span class="line">.header &#123; <span class="attr">background</span>: url(<span class="string">&#x27;../image/background.jpg&#x27;</span>); &#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-3-è®¾ç½®å¤´åƒæ—‹è½¬"><a href="#2-3-è®¾ç½®å¤´åƒæ—‹è½¬" class="headerlink" title="2.3 è®¾ç½®å¤´åƒæ—‹è½¬"></a>2.3 è®¾ç½®å¤´åƒæ—‹è½¬</h3><p>æ—§ç‰ˆï¼Œæ‰“å¼€ <code>\themes\next\source\css\_common\components\sidebar\sidebar-author.styl</code> ï¼Œåœ¨é‡Œé¢æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.site-author-image</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding</span>: $site-author-image-padding;</span><br><span class="line">  <span class="attribute">max-width</span>: $site-author-image-width;</span><br><span class="line">  <span class="attribute">height</span>: $site-author-image-height;</span><br><span class="line">  <span class="attribute">border</span>: $site-author-image-border-width solid $site-author-image-border-color;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å¤´åƒåœ†å½¢ */</span></span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -moz-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: inset <span class="number">0</span> -<span class="number">1px</span> <span class="number">0</span> <span class="number">#333</span>sf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* è®¾ç½®å¾ªç¯åŠ¨ç”» [animation: (play)åŠ¨ç”»åç§° (2s)åŠ¨ç”»æ’­æ”¾æ—¶é•¿å•ä½ç§’æˆ–å¾®ç§’ (ase-out)åŠ¨ç”»æ’­æ”¾çš„é€Ÿåº¦æ›²çº¿ä¸ºä»¥ä½é€Ÿç»“æŸ </span></span><br><span class="line"><span class="comment">    (1s)ç­‰å¾…1ç§’ç„¶åå¼€å§‹åŠ¨ç”» (1)åŠ¨ç”»æ’­æ”¾æ¬¡æ•°(infiniteä¸ºå¾ªç¯æ’­æ”¾) ]*/</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* é¼ æ ‡ç»è¿‡å¤´åƒæ—‹è½¬360åº¦ */</span></span><br><span class="line">  -webkit-<span class="attribute">transition</span>: -webkit-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  -moz-<span class="attribute">transition</span>: -moz-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  <span class="attribute">transition</span>: transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="comment">/* é¼ æ ‡ç»è¿‡åœæ­¢å¤´åƒæ—‹è½¬ </span></span><br><span class="line"><span class="comment">  -webkit-animation-play-state:paused;</span></span><br><span class="line"><span class="comment">  animation-play-state:paused;*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* é¼ æ ‡ç»è¿‡å¤´åƒæ—‹è½¬360åº¦ */</span></span><br><span class="line">  -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Z è½´æ—‹è½¬åŠ¨ç”» */</span></span><br><span class="line"><span class="keyword">@-webkit-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@-moz-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆå¯ä»¥ç›´æ¥ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼Œè®¾ç½® rotated å±æ€§ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be dispalyed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-4-è®¾ç½®ä¾§æ ä½ç½®"><a href="#2-4-è®¾ç½®ä¾§æ ä½ç½®" class="headerlink" title="2.4 è®¾ç½®ä¾§æ ä½ç½®"></a>2.4 è®¾ç½®ä¾§æ ä½ç½®</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­çš„sidebarï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280206.png"></p><p>é»˜è®¤æ˜¯å·¦è¾¹ï¼Œdisplayè®¾ç½®ä¾§æ åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ˜¾ç¤ºã€‚</p><h3 id="2-5-è®¾ç½®èœå•"><a href="#2-5-è®¾ç½®èœå•" class="headerlink" title="2.5 è®¾ç½®èœå•"></a>2.5 è®¾ç½®èœå•</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> èœå•æ˜ å°„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280207.png"></p><p>ç•Œé¢æ‰€æ˜¾ç¤ºçš„æ˜ å°„valueæ˜¯å» <code>languages/&#123;yourlanguage&#125;.yml</code> æŸ¥è¯¢çš„ï¼Œæƒ³è¦ä¿®æ”¹æ—¶åªéœ€å»ä¿®æ”¹ <code>&#123;yourlanguage&#125;.yml</code> å³å¯ï¼Œä¸è¿‡è¦å…ˆåœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­å¼€å¯è¿™ä¸ªæ ‡ç­¾ã€‚</p><p>è®¾ç½®èœå•çš„å›¾æ ‡: </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280208.png"></p><h4 id="ï¼ˆ1ï¼‰æ·»åŠ æ ‡ç­¾é¡µé¢"><a href="#ï¼ˆ1ï¼‰æ·»åŠ æ ‡ç­¾é¡µé¢" class="headerlink" title="ï¼ˆ1ï¼‰æ·»åŠ æ ‡ç­¾é¡µé¢"></a>ï¼ˆ1ï¼‰æ·»åŠ æ ‡ç­¾é¡µé¢</h4><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­çš„menué€‰é¡¹ï¼Œå¯ä»¥åœ¨ä¸»é¡µé¢çš„èœå•æ æ·»åŠ æ ‡ç­¾é€‰é¡¹ï¼Œä½†æ˜¯æ­¤æ—¶ç‚¹å‡»æ ‡ç­¾ï¼Œè·³è½¬çš„é¡µé¢ä¼šæ˜¾ç¤ºpage not foundã€‚</p><p>æ·»åŠ æ ‡ç­¾é¡µé¢çš„å…·ä½“æ–¹æ³•æ˜¯:</p><ul><li><p>æ–°å»ºé¡µé¢ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page tags</span></span><br></pre></td></tr></table></figure></li><li><p>è¾“å…¥å‘½ä»¤åï¼Œåœ¨ <code>myBlog/source</code> ä¸‹ä¼šæ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹tagsï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰ä¸€ä¸ª <code>index.md</code> æ–‡ä»¶ã€‚</p></li><li><p>è®¾ç½®é¡µé¢ç±»å‹ï¼Œåœ¨ä¸Šæ­¥æ–°ç”Ÿæˆçš„ <code>myBlog/source/tags/index.md</code> ä¸­æ·»åŠ  <code>type: &quot;tags&quot;</code> ï¼Œ<code>index.md</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2016-11-15 19:10:05</span><br><span class="line"><span class="section">type: &quot;tags&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®å…·ä½“æ–‡ç« çš„tagsï¼Œå½“è¦ä¸ºæŸä¸€ç¯‡æ–‡ç« æ·»åŠ æ ‡ç­¾ï¼Œåªéœ€åœ¨ <code>myBlog/source/_post</code> ç›®å½•ä¸‹çš„å…·ä½“æ–‡ç« çš„tagsä¸­æ·»åŠ æ ‡ç­¾å³å¯ï¼Œå¦‚:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: åŸºäºHexoå’ŒGithubæ­å»ºåšå®¢</span><br><span class="line">date: 2016-11-09</span><br><span class="line">tags: [npm, hexo, github]</span><br><span class="line"><span class="section">categories: æ­å»ºåšå®¢</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ï¼ˆ2ï¼‰æ·»åŠ åˆ†ç±»é¡µé¢"><a href="#ï¼ˆ2ï¼‰æ·»åŠ åˆ†ç±»é¡µé¢" class="headerlink" title="ï¼ˆ2ï¼‰æ·»åŠ åˆ†ç±»é¡µé¢"></a>ï¼ˆ2ï¼‰æ·»åŠ åˆ†ç±»é¡µé¢</h4><p>æ­¥éª¤ä¸æ·»åŠ æ ‡ç­¾é¡µé¢ç±»ä¼¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ul><li><p>æ–°å»ºé¡µé¢ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page categories</span></span><br></pre></td></tr></table></figure></li><li><p>è¾“å…¥å‘½ä»¤åï¼Œåœ¨myBlog/sourceä¸‹ä¼šæ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹categoriesï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰ä¸€ä¸ªindex.mdæ–‡ä»¶ã€‚</p></li><li><p>è®¾ç½®é¡µé¢ç±»å‹ï¼Œåœ¨ä¸Šæ­¥æ–°ç”Ÿæˆçš„ <code>myBlog/source/categories/index.md</code> ä¸­æ·»åŠ  <code>type: &quot;categories&quot;</code> ï¼Œ <code>index.md</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2016-11-15 19:11:13</span><br><span class="line"><span class="section">type: &quot;categories&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®å…·ä½“æ–‡ç« çš„categoriesï¼Œå½“è¦ä¸ºæŸä¸€ç¯‡æ–‡ç« æ·»åŠ åˆ†ç±»ï¼Œåªéœ€åœ¨ <code>myBlog/source/_post</code> ç›®å½•ä¸‹çš„å…·ä½“æ–‡ç« çš„categoriesä¸­æ·»åŠ åˆ†ç±»å³å¯ï¼Œå¦‚ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: åŸºäºHexoå’ŒGithubæ­å»ºåšå®¢</span><br><span class="line">date: XXXX-XX-XX</span><br><span class="line">tags: [hexo, github]</span><br><span class="line"><span class="section">categories: æ­å»ºåšå®¢</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ï¼ˆ3ï¼‰æ·»åŠ å…³äºæˆ‘é¡µé¢"><a href="#ï¼ˆ3ï¼‰æ·»åŠ å…³äºæˆ‘é¡µé¢" class="headerlink" title="ï¼ˆ3ï¼‰æ·»åŠ å…³äºæˆ‘é¡µé¢"></a>ï¼ˆ3ï¼‰æ·»åŠ å…³äºæˆ‘é¡µé¢</h4><p>æ­¥éª¤ä¸æ·»åŠ æ ‡ç­¾é¡µé¢ç±»ä¼¼ï¼Œå…·ä½“å¦‚ä¸‹:</p><ul><li><p>æ–°å»ºé¡µé¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page about</span></span><br></pre></td></tr></table></figure></li><li><p>è¾“å…¥å‘½ä»¤åï¼Œåœ¨ <code>myBlog/source</code> ä¸‹ä¼šæ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹aboutï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰ä¸€ä¸ª <code>index.md</code> æ–‡ä»¶ã€‚ä¿®æ”¹ <code>about/index.md</code> ï¼Œæœ¬ç«™ç‚¹ <code>index.md</code> å¦‚ä¸‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: about</span><br><span class="line"><span class="section">date: 2016-11-15 19:08:50</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"><span class="section">## å…³äºæˆ‘</span></span><br><span class="line"></span><br><span class="line">XXXX,XXXXXXXXXã€‚</span><br><span class="line"></span><br><span class="line">From XXX</span><br><span class="line"></span><br><span class="line">QQ: XXXXXXX</span><br><span class="line">Email: XXXXXX@XX.com</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-6-è®¾ç½®ç¤¾äº¤é“¾æ¥"><a href="#2-6-è®¾ç½®ç¤¾äº¤é“¾æ¥" class="headerlink" title="2.6 è®¾ç½®ç¤¾äº¤é“¾æ¥"></a>2.6 è®¾ç½®ç¤¾äº¤é“¾æ¥</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280209.png"></p><p>å¯ä»¥åœ¨<a href="https://fontawesome.com/icons?from=io">å›¾æ ‡åº“</a>ä¸­æœç´¢å›¾æ ‡ ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280210.png"></p><p><strong>å°†é“¾æ¥è®¾ç½®ä¸ºå±…ä¸­æ˜¾ç¤ºï¼š</strong></p><p>æ‰“å¼€æ–‡ä»¶ <code>themes\next\source\css\_common\components\sidebar\sidebar-author-links.styl</code> ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-of-author-item</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-æ·»åŠ å‹é“¾"><a href="#2-7-æ·»åŠ å‹é“¾" class="headerlink" title="2.7 æ·»åŠ å‹é“¾"></a>2.7 æ·»åŠ å‹é“¾</h3><h4 id="ï¼ˆ1ï¼‰ç®€å•æ–¹æ¡ˆ"><a href="#ï¼ˆ1ï¼‰ç®€å•æ–¹æ¡ˆ" class="headerlink" title="ï¼ˆ1ï¼‰ç®€å•æ–¹æ¡ˆ"></a>ï¼ˆ1ï¼‰ç®€å•æ–¹æ¡ˆ</h4><p>åœ¨sourceç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªxx.htmlæ–‡ä»¶ï¼Œç„¶åé…ç½®menuæ˜ å°„å³å¯ã€‚</p><blockquote><p>xx: /xx.html</p><p>xx: /xx</p></blockquote><p>æ·»åŠ å¦‚å‹æƒ…é“¾æ¥çš„æ–¹æ³•:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blogrolls </span></span><br><span class="line"><span class="attr">links_title:</span> <span class="string">å‹æƒ…é“¾æ¥</span> </span><br><span class="line"><span class="comment"># links_layout: block </span></span><br><span class="line"><span class="comment">#links_layout: inline </span></span><br><span class="line"><span class="attr">links:</span> <span class="string">Javaå­¦ä¹ å¤©åœ°:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="attr">ruulai.com:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="string">è§†å¬ä¸­å›½:</span> <span class="string">https://wangli0.github.com</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰Nextä¾§è¾¹æ æ·»åŠ "><a href="#ï¼ˆ2ï¼‰Nextä¾§è¾¹æ æ·»åŠ " class="headerlink" title="ï¼ˆ2ï¼‰Nextä¾§è¾¹æ æ·»åŠ "></a>ï¼ˆ2ï¼‰Nextä¾§è¾¹æ æ·»åŠ </h4><p>å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://theme-next.js.org/docs/theme-settings/sidebar">Sidebar Setting</a></p><p>ä¼šåœ¨ç¤¾äº¤ä¸‹å¢åŠ ä»»æ„ä¸ªè¶…é“¾æ¥ï¼Œç¼ºç‚¹æ˜¯åœ°æ–¹æœ‰é™ï¼Œæ— æ³•æ”¾ç½®è¿‡å¤šé“¾æ¥ï¼›ä»¥åŠæ²¡æœ‰å›¾æ ‡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blog rolls</span></span><br><span class="line"><span class="attr">links_settings:</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">far</span> <span class="string">fa-smile-wink</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">ä¸ªäºº</span></span><br><span class="line">  <span class="comment"># Available values: block | inline</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="string">block</span></span><br><span class="line"></span><br><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="string">ç½‘æ˜“äº‘éŸ³ä¹:</span> <span class="string">https://music.163.com/#/XXX</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Table of Contents in the Sidebar</span></span><br><span class="line"><span class="comment"># Front-matter variable (unsupport wrap expand_all).</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If true, all words will placed on next lines if header width longer then sidebar width.</span></span><br><span class="line">  <span class="attr">wrap:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, all level of TOC in a post will be displayed, rather than the activated part of it.</span></span><br><span class="line">  <span class="attr">expand_all:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Maximum heading</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ3ï¼‰è‡ªå®šä¹‰ç•Œé¢"><a href="#ï¼ˆ3ï¼‰è‡ªå®šä¹‰ç•Œé¢" class="headerlink" title="ï¼ˆ3ï¼‰è‡ªå®šä¹‰ç•Œé¢"></a>ï¼ˆ3ï¼‰è‡ªå®šä¹‰ç•Œé¢</h4><p>å‚è€ƒï¼š<a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/">Hexo NexT æ·»åŠ å‹é“¾é¡µé¢</a></p><p>æ¶‰åŠåˆ°çš„æ–‡ä»¶ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config<span class="selector-class">.next</span><span class="selector-class">.yml</span></span><br><span class="line">â””â”€â”€ source</span><br><span class="line">    â”œâ”€â”€ _data</span><br><span class="line">    â”‚   â””â”€â”€ <span class="selector-tag">body</span>-end<span class="selector-class">.njk</span></span><br><span class="line">    â”œâ”€â”€ css</span><br><span class="line">    â”‚   â””â”€â”€ link<span class="selector-class">.css</span>ï¼ˆä¹Ÿå¯ä»¥æ”¾ç½®åˆ°ä¸»é¢˜ä¸­ç›¸åŒå­è·¯å¾„ï¼‰</span><br><span class="line">    â”œâ”€â”€ js</span><br><span class="line">    â”‚   â””â”€â”€ link<span class="selector-class">.js</span>ï¼ˆä¹Ÿå¯ä»¥æ”¾ç½®åˆ°ä¸»é¢˜ä¸­ç›¸åŒå­è·¯å¾„ï¼‰</span><br><span class="line">    â””â”€â”€ links</span><br><span class="line">        â”œâ”€â”€ index<span class="selector-class">.md</span></span><br><span class="line">        â””â”€â”€ linklist<span class="selector-class">.json</span></span><br></pre></td></tr></table></figure><h5 id="1-å»ºç«‹é¡µé¢"><a href="#1-å»ºç«‹é¡µé¢" class="headerlink" title="1. å»ºç«‹é¡µé¢"></a>1. å»ºç«‹é¡µé¢</h5><p>æ‰§è¡Œå‘½ä»¤ï¼Œè¿™ä¼šåˆ›å»º <code>source/links/index.md</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page links</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶ç¤ºä¾‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: å‹æƒ…é“¾æ¥</span><br><span class="line">type: links</span><br><span class="line">toc:</span><br><span class="line"><span class="section">  enable: false</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/css/link.css&quot;</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% note info %&#125;</span><br><span class="line"></span><br><span class="line">æ’åä¸åˆ†å…ˆåï¼Œæ¯æ¬¡åˆ·æ–°ä¼šéšæœºæ’åˆ—ã€‚</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;div class=&quot;link-navigation&quot; id=&quot;links1&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="code">  &lt;/div&gt;</span></span><br><span class="line"><span class="code">&lt;/div&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;&quot;</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate1&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  ç•™è¨€äº’æ¢å‹é“¾ o ((&gt;Ï‰&lt;)) o</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate2&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="section">  </span></span><br><span class="line"><span class="section">------</span></span><br><span class="line"></span><br><span class="line">&#123;% note success %&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## å‹é“¾æ ¼å¼</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> åç§°ï¼šå¦‚é±¼é¥®æ°´ï¼Œå†·æš–è‡ªçŸ¥</span><br><span class="line"><span class="bullet">-</span> ç½‘å€ï¼š[<span class="string">https://wangjiezhe.com</span>](<span class="link">https://wangjiezhe.com</span>)</span><br><span class="line"><span class="bullet">-</span> å¤´åƒï¼š[<span class="string">https://gravatar.loli.net/avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>](<span class="link">https://gravatar.loli.net//avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åœ¨ Front-Matter é‡Œä¸€å®šè¦æœ‰ <code>type: links</code> ï¼Œè¿™é‡Œæˆ‘è¿˜å…³é—­äº†ä¾§è¾¹æ çš„ç›®å½•ã€‚</p><h5 id="2-å­˜å‚¨æ•°æ®"><a href="#2-å­˜å‚¨æ•°æ®" class="headerlink" title="2. å­˜å‚¨æ•°æ®"></a>2. å­˜å‚¨æ•°æ®</h5><p>æ‰€æœ‰å‹é“¾çš„æ•°æ®éƒ½æ”¾åœ¨ <code>source/links/linklist.json</code> é‡Œï¼Œå…¶æ ¼å¼ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>name</code> ä¸ºç½‘ç«™çš„åå­—ï¼Œ<code>site</code> ä¸ºç½‘å€ï¼Œ<code>avatar</code> ä¸ºå¤´åƒã€‚å¤´åƒå¯ä»¥ä½¿ç”¨ Gravatarï¼Œè¿™æ ·å¯ä»¥ä¿è¯å§‹ç»ˆå¯ç”¨çš„ã€‚</p><h5 id="3-æ¸²æŸ“é¡µé¢"><a href="#3-æ¸²æŸ“é¡µé¢" class="headerlink" title="3. æ¸²æŸ“é¡µé¢"></a>3. æ¸²æŸ“é¡µé¢</h5><p>åœ¨ <code>source/_data/body-end.njk</code> ä¸­ï¼Œå¼•å…¥ <code>link.js</code>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> page.type === <span class="string">&#x27;links&#x27;</span> %&#125;</span><br><span class="line">  &#123;&#123;- next_js(<span class="string">&#x27;link.js&#x27;</span>, <span class="literal">true</span>) &#125;&#125;</span><br><span class="line">&#123;% endif %</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­å¼€å¯è‡ªå®šä¹‰é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.njk</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.njk</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.njk</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.njk</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.njk</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.njk</span></span><br><span class="line">  <span class="attr">bodyEnd:</span> <span class="string">source/_data/body-end.njk</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="comment">#style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>source/js/link.js</code> çš„å†…å®¹ä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éšæœºæ’åˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffle</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = arr.length;</span><br><span class="line">  <span class="keyword">while</span> (i) &#123;</span><br><span class="line">    <span class="keyword">let</span> j = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * i--);</span><br><span class="line">    [arr[j], arr[i]] = [arr[i], arr[j]];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸²æŸ“æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderlink</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name, avatar, site, li = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  shuffle(data);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">    name = data[i].name;</span><br><span class="line">    avatar = data[i].avatar;</span><br><span class="line">    site = data[i].site;</span><br><span class="line">    li += <span class="string">&#x27;&lt;div class=&quot;card&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;thumb&quot; style=&quot;background: url( &#x27;</span> + avatar + <span class="string">&#x27;);&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/a&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;card-header&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div&gt;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + name + <span class="string">&#x27;&lt;/a&gt;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">&quot;.link-navigation&quot;</span>).innerHTML = li;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– json æ–‡ä»¶</span></span><br><span class="line">fetch(<span class="string">&#x27;/links/linklist.json&#x27;</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> renderlink(res));</span><br></pre></td></tr></table></figure><h5 id="4-åˆ›å»ºæ ·å¼"><a href="#4-åˆ›å»ºæ ·å¼" class="headerlink" title="4. åˆ›å»ºæ ·å¼"></a>4. åˆ›å»ºæ ·å¼</h5><p>åˆ›å»º <code>source/css/link.css</code>ï¼Œå…¶å†…å®¹ä¸ºï¼ˆè¿™ä¸ªæ–‡ä»¶å®Œå…¨æ¥è‡ªäºç½‘ç»œï¼‰ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-content</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1rem</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.link-navigation</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot; &quot;</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">clear</span>: both</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">130px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">transition-duration</span>: .<span class="number">15s</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>);</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f5f5f5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(max-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">16px</span>)/<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">32px</span>)/<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:768px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">48px</span>)/<span class="number">4</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:1200px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">64px</span>)/<span class="number">5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>),<span class="number">0</span> <span class="number">0</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">04</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.thumb</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding-bottom</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span><span class="meta">!important</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.posts-expand</span> <span class="selector-class">.post-body</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1rem</span> .<span class="number">25rem</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  <span class="attribute">white-space</span>: normal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#2bbc8a</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#d480aa</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-æ·»åŠ ä¾§æ "><a href="#5-æ·»åŠ ä¾§æ " class="headerlink" title="5. æ·»åŠ ä¾§æ "></a>5. æ·»åŠ ä¾§æ </h5><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­ï¼Œæ·»åŠ </p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || fa fa-home</span><br><span class="line">  tags: /tags/ || fa fa-tags</span><br><span class="line">  categories: /categories/ || fa fa-th</span><br><span class="line">  archives: /archives/ || fa fa-archive</span><br><span class="line"><span class="addition">+  links: /links/ || fa fa-link</span></span><br></pre></td></tr></table></figure><h5 id="6-é—®é¢˜æ’æŸ¥"><a href="#6-é—®é¢˜æ’æŸ¥" class="headerlink" title="6. é—®é¢˜æ’æŸ¥"></a>6. é—®é¢˜æ’æŸ¥</h5><p>æ­¥éª¤ï¼š</p><ol><li>æµè§ˆå™¨ F12 æŸ¥çœ‹é¡µé¢æºç ï¼Œæ˜¯å¦æœ‰ä¸€ä¸ª class æ˜¯ <code>.link-navigation</code> çš„ç½‘é¡µå…ƒç´ ã€‚</li><li>æŸ¥çœ‹ <code>link.js</code> æ˜¯å¦æ­£å¸¸åŠ è½½äº†ï¼Œjson æ–‡ä»¶æ˜¯å¦æ­£å¸¸åŠ è½½äº†ã€‚</li></ol><p>æŒ‰ä¸Šè¿°é…ç½®åï¼Œ <code>link.js</code> åŠ è½½æŠ¥é”™ <code>Unexpected token &#39;&lt;&#39;</code> ï¼Œå‘ç°æ˜¯å› ä¸ºå¯ç”¨äº†éŸ³ä¹æ’­æ”¾å™¨APlayerï¼Œé»˜è®¤ä¼šä¸ºæ–‡ä»¶æ·»åŠ ä¸€è¡Œæ ‡ç­¾é…ç½®ï¼Œå¯¼è‡´JSå’Œè¯»å–Jsonæ—¶æŠ¥é”™ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">hexo-tag-aplayer</a></p><p>ç«™ç‚¹é…ç½®æ–‡ä»¶ <code>\_config.yml</code> ä¸­å°†asset_injectå±æ€§è®¾ç½®ä¸ºfalseï¼Œå³å¯è§£å†³é—®é¢˜ï¼ˆå¯èƒ½éœ€è¦é‡æ–°ç¼–è¯‘ï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éŸ³ä¹æ’­æ”¾å™¨</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># è‡ªåŠ¨æ’å…¥ Aplayer.js ä¸ Meting.js èµ„æºè„šæœ¬, é»˜è®¤å¼€å¯</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="2-8-è®¾ç½®ç«™ç‚¹å›¾æ ‡"><a href="#2-8-è®¾ç½®ç«™ç‚¹å›¾æ ‡" class="headerlink" title="2.8 è®¾ç½®ç«™ç‚¹å›¾æ ‡"></a>2.8 è®¾ç½®ç«™ç‚¹å›¾æ ‡</h3><p>ä¸‹è½½ä¸€ä¸ª32*32çš„icoå›¾æ ‡ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Put your favicon.ico into `hexo-site/source/` directory.</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br></pre></td></tr></table></figure><h3 id="2-9-ä¿®æ”¹å­—ä½“"><a href="#2-9-ä¿®æ”¹å­—ä½“" class="headerlink" title="2.9 ä¿®æ”¹å­—ä½“"></a>2.9 ä¿®æ”¹å­—ä½“</h3><p>åœ¨ <a href="https://www.google.com/fonts">Google Fonts</a> ä¸Šæ‰¾åˆ°å¿ƒä»ªçš„å­—ä½“ï¼Œç„¶ååœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­ä¸ºä¸åŒçš„åº”ç”¨åœºæ™¯é…ç½®å­—ä½“ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Font Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Find fonts on Google Fonts (https://fonts.google.com)</span></span><br><span class="line"><span class="comment"># All fonts set here will have the following styles:</span></span><br><span class="line"><span class="comment">#   light | light italic | normal | normal italic | bold | bold italic</span></span><br><span class="line"><span class="comment"># Be aware that setting too much fonts will cause site running slowly</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Web Safe fonts are recommended for `global` (and `title`):</span></span><br><span class="line"><span class="comment"># Arial | Tahoma | Helvetica | Times New Roman | Courier New | Verdana | Georgia | Palatino | Garamond | Comic Sans MS | Trebuchet MS</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host, e.g. https://fonts.googleapis.com (Default).</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font options:</span></span><br><span class="line">  <span class="comment"># `external: true` will load this font family from `host` above.</span></span><br><span class="line">  <span class="comment"># `family: Times New Roman`. Without any quotes.</span></span><br><span class="line">  <span class="comment"># `size: x.x`. Use `em` as unit. Default: 1 (16px)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global font settings used for all elements inside &lt;body&gt;.</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Monda</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for site title (.site-title).</span></span><br><span class="line">  <span class="attr">title:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for headlines (&lt;h1&gt; to &lt;h6&gt;).</span></span><br><span class="line">  <span class="attr">headings:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Roboto</span> <span class="string">Slab</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for posts (.post-body).</span></span><br><span class="line">  <span class="attr">posts:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for &lt;code&gt; and code blocks.</span></span><br><span class="line">  <span class="attr">codes:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br></pre></td></tr></table></figure><h3 id="2-10-è®¾ç½®é¦–é¡µåªæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹"><a href="#2-10-è®¾ç½®é¦–é¡µåªæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹" class="headerlink" title="2.10 è®¾ç½®é¦–é¡µåªæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹"></a>2.10 è®¾ç½®é¦–é¡µåªæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹</h3><p>è¿™ä¸ªåªè¦åœ¨æ–‡ç« ä¸­åŠ ä¸Š &lt;&#33;â€“moreâ€“&gt; æ ‡è®° ï¼Œè¯¥æ ‡è®°ä»¥åéƒ¨åˆ†å°±ä¸åœ¨æ˜¾ç¤ºäº†ï¼Œåªæœ‰å±•å¼€å…¨éƒ¨æ‰æ˜¾ç¤ºï¼Œè¿™æ˜¯hexoå®šä¹‰çš„ã€‚ä½†è¿™æ ·æ‰‹åŠ¨é…ç½®æ„Ÿè§‰ä¼šå¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically Excerpt. Not recommand.</span></span><br><span class="line"><span class="comment"># Please use &lt;!-- more --&gt; in the post to control excerpt accurately.</span></span><br><span class="line"><span class="attr">auto_excerpt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">length:</span> <span class="number">150</span></span><br></pre></td></tr></table></figure><p>æŠŠenableæ”¹ä¸ºå¯¹åº”çš„falseæ”¹ä¸ºtrueã€‚</p><p>æ–°ç‰ˆæœ¬ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically excerpt description in homepage as preamble text.</span></span><br><span class="line"><span class="attr">excerpt_description:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read more button</span></span><br><span class="line"><span class="comment"># If true, the read more button will be displayed in excerpt section.</span></span><br><span class="line"><span class="attr">read_more_btn:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-11-è®¾ç½®åšå®¢èƒŒæ™¯"><a href="#2-11-è®¾ç½®åšå®¢èƒŒæ™¯" class="headerlink" title="2.11 è®¾ç½®åšå®¢èƒŒæ™¯"></a>2.11 è®¾ç½®åšå®¢èƒŒæ™¯</h3><p>æ—§ç‰ˆæœ¬ï¼Œæ‰“å¼€æ–‡ä»¶ <code>blog\themes\next\source\css\_custom\custom.styl</code> ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>:<span class="number">1200px</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>);      //è¿™ä¸€è¡Œçš„æ‹¬å·é‡Œå¡«èƒŒæ™¯å›¾ç‰‡çš„è·¯å¾„ï¼Œå°†å›¾ç‰‡é‡å‘½åä¸º<span class="attribute">background</span><span class="selector-class">.jpg</span>æ”¾åœ¨\themes\next\source\imagesä¸‹ï¼Œä¹Ÿå¯å¡«å›¾ç‰‡çš„é“¾æ¥ã€‚</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed;</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-id">#footer</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>:<span class="number">#eee</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆæœ¬ï¼Œ<code>source/_data/styles.styl</code> æ–‡ä»¶ï¼Œæ·»åŠ ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>); // å¯ä»¥æ˜¯è·¯å¾„ä¹Ÿå¯ä»¥æ˜¯é“¾æ¥</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat; // ä¸é‡å¤</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed; // å›ºå®šä½èƒŒæ™¯å›¾ç‰‡</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>; // å›¾ç‰‡ä½ç½®ï¼šå±…ä¸­</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>; // å›¾ç‰‡é•¿å®½æ‰©å……ä¸º<span class="number">100%</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>blog/themes/next/_config.yml</code> ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Define custom file paths.</span><br><span class="line"># Create your custom files in site directory `source/_data` and uncomment needed files below.</span><br><span class="line">custom_file_path:</span><br><span class="line">  #head: source/_data/head.njk</span><br><span class="line">  #header: source/_data/header.njk</span><br><span class="line">  #sidebar: source/_data/sidebar.njk</span><br><span class="line">  #postMeta: source/_data/post-meta.njk</span><br><span class="line">  #postBodyEnd: source/_data/post-body-end.njk</span><br><span class="line">  #footer: source/_data/footer.njk</span><br><span class="line">  bodyEnd: source/_data/body-end.njk</span><br><span class="line">  #variable: source/_data/variables.styl</span><br><span class="line">  #mixin: source/_data/mixins.styl</span><br><span class="line"><span class="deletion">-  #style: source/_data/styles.styl</span></span><br><span class="line"><span class="addition">+  style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><h3 id="2-12-æ·»åŠ è…¾è®¯å…¬ç›Š404é¡µé¢"><a href="#2-12-æ·»åŠ è…¾è®¯å…¬ç›Š404é¡µé¢" class="headerlink" title="2.12 æ·»åŠ è…¾è®¯å…¬ç›Š404é¡µé¢"></a>2.12 æ·»åŠ è…¾è®¯å…¬ç›Š404é¡µé¢</h3><p>åœ¨ <code>blog\themes\next\source\</code> è·¯å¾„ä¸‹æ–°å»º <code>404.html</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;content-type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge,chrome=1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;all&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;index,follow&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/style/404style.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/plain&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://www.qq.com/404/search_children.js&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> <span class="attr">homePageUrl</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">homePageName</span>=<span class="string">&quot;å›åˆ°æˆ‘çš„ä¸»é¡µ&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/data.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/page.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>blog/themes/next/_config.yml</code> ï¼Œå¼€å¯ <code>commonweal</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || calendar</span></span><br><span class="line">  <span class="attr">sitemap:</span> <span class="string">/sitemap.xml</span> <span class="string">||</span> <span class="string">sitemap</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">/404/</span> <span class="string">||</span> <span class="string">heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable/Disable menu icons.</span></span><br><span class="line"><span class="attr">menu_icons:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Icon Mapping</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">about</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">archive</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">heartbeat</span></span><br></pre></td></tr></table></figure><h3 id="2-13-æ·»åŠ ç‰ˆæƒå£°æ˜"><a href="#2-13-æ·»åŠ ç‰ˆæƒå£°æ˜" class="headerlink" title="2.13 æ·»åŠ ç‰ˆæƒå£°æ˜"></a>2.13 æ·»åŠ ç‰ˆæƒå£°æ˜</h3><p>æ—§ç‰ˆæœ¬ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.xml</code> ï¼Œæ‰¾åˆ° <code>post_copyright</code> å¼€å¯ <code>enable</code> ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Declare license on posts</span></span><br><span class="line"><span class="attr">post_copyright:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">CC</span> <span class="string">BY-NC-SA</span> <span class="number">3.0</span></span><br><span class="line">  <span class="attr">license_url:</span> <span class="string">https://creativecommons.org/licenses/by-nc-sa/3.0/</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æ ¹ç›®å½•é…ç½®æ–‡ä»¶ï¼šç¡®è®¤ <code>url</code> å±æ€§æœ‰é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">http://linyishui.top</span></span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆæœ¬ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.xml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># See: https://creativecommons.org/about/cclicenses/</span></span><br><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="comment"># Available values: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | cc-zero</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="comment"># Available values: big | small</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">small</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># You can set a language value if you prefer a translated version of CC license, e.g. deed.zh</span></span><br><span class="line">  <span class="comment"># CC licenses are available in 39 languages, you can find the specific and correct abbreviation you need on https://creativecommons.org</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">deed.zh</span></span><br></pre></td></tr></table></figure><h3 id="2-14-é¡µè„šå¢åŠ å»ºç«™æ—¶é—´"><a href="#2-14-é¡µè„šå¢åŠ å»ºç«™æ—¶é—´" class="headerlink" title="2.14 é¡µè„šå¢åŠ å»ºç«™æ—¶é—´"></a>2.14 é¡µè„šå¢åŠ å»ºç«™æ—¶é—´</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>blog/themes/next/_config.yml</code> ï¼Œæ‰¾åˆ°sinceï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">since:</span> <span class="number">2018</span></span><br></pre></td></tr></table></figure><h3 id="2-15-ä¾§æ å¢åŠ å·²è¿è¡Œæ—¶é—´ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-15-ä¾§æ å¢åŠ å·²è¿è¡Œæ—¶é—´ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.15 ä¾§æ å¢åŠ å·²è¿è¡Œæ—¶é—´ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.15 ä¾§æ å¢åŠ å·²è¿è¡Œæ—¶é—´ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>æ‰“å¼€æ–‡ä»¶ <code>blog/themes/next/layout/_custom/sidebar.swig</code> ï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;days&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">show_date_time</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.setTimeout(<span class="string">&quot;show_date_time()&quot;</span>, <span class="number">1000</span>);</span></span><br><span class="line"><span class="javascript">    BirthDay=<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">&quot;07/26/2018 00:00:00&quot;</span>);</span></span><br><span class="line"><span class="javascript">    today=<span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">    timeold=(today.getTime()-BirthDay.getTime());</span></span><br><span class="line"><span class="javascript">    sectimeold=timeold/<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    secondsold=<span class="built_in">Math</span>.floor(sectimeold);</span></span><br><span class="line"><span class="javascript">    msPerDay=<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    e_daysold=timeold/msPerDay</span></span><br><span class="line"><span class="javascript">    daysold=<span class="built_in">Math</span>.floor(e_daysold);</span></span><br><span class="line"><span class="javascript">    e_hrsold=(e_daysold-daysold)*<span class="number">24</span>;</span></span><br><span class="line"><span class="javascript">    hrsold=setzero(<span class="built_in">Math</span>.floor(e_hrsold));</span></span><br><span class="line"><span class="javascript">    e_minsold=(e_hrsold-hrsold)*<span class="number">60</span>;</span></span><br><span class="line"><span class="javascript">    minsold=setzero(<span class="built_in">Math</span>.floor((e_hrsold-hrsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    seconds=setzero(<span class="built_in">Math</span>.floor((e_minsold-minsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;days&#x27;</span>).innerHTML=<span class="string">&quot;å·²è¿è¡Œ &quot;</span>+daysold+<span class="string">&quot; å¤© &quot;</span>+hrsold+<span class="string">&quot; å°æ—¶ &quot;</span>+minsold+<span class="string">&quot; åˆ† &quot;</span>+seconds+<span class="string">&quot; ç§’&quot;</span>;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">setzero</span>(<span class="params">i</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (i&lt;<span class="number">10</span>) &#123;</span></span><br><span class="line"><span class="javascript">        i=<span class="string">&quot;0&quot;</span> + i</span></span><br><span class="line"><span class="javascript">    &#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> i;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript">show_date_time();</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€æ–‡ä»¶ <code>blog/themes/next/layout/_macro/sidebar.swig</code>ï¼ˆä¿®æ”¹ä½ç½®ï¼Œå¯ä¸ä¿®æ”¹ï¼‰ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  &#123;# Blogroll #&#125;</span><br><span class="line">  &#123;% if theme.links %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll motion-element &#123;&#123; &quot;</span><span class="attr">links-of-blogroll-</span>&quot; + <span class="attr">theme.links_layout</span> | <span class="attr">default</span>(&#x27;<span class="attr">inline</span>&#x27;) &#125;&#125;&quot;&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        &#123;&#123; theme.links_title &#125;&#125;<span class="symbol">&amp;nbsp;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-list&quot;</span>&gt;</span></span><br><span class="line">        &#123;% for name, link in theme.links %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-item&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; link &#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123; name &#125;&#125;&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">   &#123;% include &#x27;../_custom/sidebar.swig&#x27; %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æ–‡ä»¶ <code>blog/themes/next/source/css/_custom/custom.styl</code> ï¼Œä¿®æ”¹æ—¶é—´æ æ ·å¼ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è‡ªå®šä¹‰çš„ä¾§æ æ—¶é—´æ ·å¼ */</span></span><br><span class="line"><span class="selector-id">#days</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">7</span>, <span class="number">179</span>, <span class="number">155</span>);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-16-ä¾§æ å¤´åƒç‚¹å‡»è¿”å›é¦–é¡µï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-16-ä¾§æ å¤´åƒç‚¹å‡»è¿”å›é¦–é¡µï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.16 ä¾§æ å¤´åƒç‚¹å‡»è¿”å›é¦–é¡µï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.16 ä¾§æ å¤´åƒç‚¹å‡»è¿”å›é¦–é¡µï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>ä¿®æ”¹æ–‡ä»¶ <code>blog/themes/next/layout/_macro/sidebar.swig</code> ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;site-author-image&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;image&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for( theme.avatar | default(theme.images + &#x27;/avatar.gif&#x27;) ) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">alt</span>=<span class="string">&quot;&#123;&#123; theme.author &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-17-é¡µè„šå¢åŠ ä¼šè·³åŠ¨çš„å¿ƒï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-17-é¡µè„šå¢åŠ ä¼šè·³åŠ¨çš„å¿ƒï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.17 é¡µè„šå¢åŠ ä¼šè·³åŠ¨çš„å¿ƒï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.17 é¡µè„šå¢åŠ ä¼šè·³åŠ¨çš„å¿ƒï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>é¦–å…ˆä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>blog\themes\next\_config.yml</code> ï¼Œæ‰¾åˆ°iconï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">footer:</span></span><br><span class="line">  <span class="comment"># Icon between year and copyright info.</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">heart</span></span><br></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹æ–‡ä»¶ <code>blog/themes/next/layout/_partials/footer.swig</code> ï¼Œæ‰¾åˆ° <code>with-love</code> ï¼Œå¢åŠ idï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;heart&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-&#123;&#123; theme.footer.icon &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€åä¿®æ”¹æ–‡ä»¶ <code>blog/themes/next/source/css/_custom/custom.styl</code> ï¼Œå¢åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è‡ªå®šä¹‰é¡µè„šè·³åŠ¨çš„å¿ƒæ ·å¼ */</span></span><br><span class="line"><span class="keyword">@keyframes</span> heartAnimate &#123;</span><br><span class="line">    <span class="number">0%</span>,<span class="number">100%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1</span>);&#125;</span><br><span class="line">    <span class="number">10%</span>,<span class="number">30%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">0.9</span>);&#125;</span><br><span class="line">    <span class="number">20%</span>,<span class="number">40%</span>,<span class="number">60%</span>,<span class="number">80%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">    <span class="number">50%</span>,<span class="number">70%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#heart</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">    <span class="attribute">animation</span>: heartAnimate <span class="number">1.33s</span> ease-in-out infinite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-18-éšè—ç½‘é¡µåº•éƒ¨powered-Byï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-18-éšè—ç½‘é¡µåº•éƒ¨powered-Byï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.18 éšè—ç½‘é¡µåº•éƒ¨powered Byï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.18 éšè—ç½‘é¡µåº•éƒ¨powered Byï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>æ‰“å¼€ <code>themes/next/layout/_partials/footer.swig</code> ï¼Œä½¿ç”¨ â€œ&lt;&#33;â€“&gt;â€ éšè—ä¹‹é—´çš„ä»£ç å³å¯ï¼Œæˆ–è€…ç›´æ¥åˆ é™¤ï¼Œä½ç½®å¦‚å›¾:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280213.png"></p><h3 id="2-19-è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-19-è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.19 è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.19 è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>æ‰“å¼€ <code>themes/next/source/css/_custom/custom.styl</code> ï¼Œåœ¨é‡Œé¢å†™ä¸‹å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// é¼ æ ‡æ ·å¼</span><br><span class="line">  * &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword2.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword1.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ url é‡Œé¢å¿…é¡»æ˜¯ ico å›¾ç‰‡ï¼Œæ›¿æ¢åå‘ç°å®é™…ç‚¹è§¦å’Œé¼ æ ‡å›¾æ ‡æ˜¯æœ‰åå·®çš„ï¼Œæ‰€ä»¥æˆ‘å–æ¶ˆäº†é¼ æ ‡çš„æ ·å¼ã€‚</p><h3 id="2-20-åšæ–‡å‹ç¼©ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-20-åšæ–‡å‹ç¼©ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.20 åšæ–‡å‹ç¼©ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.20 åšæ–‡å‹ç¼©ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>åœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp -g</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp --save</span></span><br></pre></td></tr></table></figure><p>æ ¹ç›®å½•ä¸‹æ–°å»º <code>gulpfile.js</code> ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">&#x27;gulp-minify-css&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">&#x27;gulp-uglify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlmin = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlmin&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlclean = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlclean&#x27;</span>);</span><br><span class="line"><span class="comment">// å‹ç¼© public ç›®å½• css</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-css&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.css&#x27;</span>)</span><br><span class="line">        .pipe(minifycss())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å‹ç¼© public ç›®å½• html</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-html&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.html&#x27;</span>)</span><br><span class="line">    .pipe(htmlclean())</span><br><span class="line">    .pipe(htmlmin(&#123;</span><br><span class="line">         <span class="attr">removeComments</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyJS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyCSS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyURLs</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">    .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å‹ç¼© public/js ç›®å½• js</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-js&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.js&#x27;</span>)</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// æ‰§è¡Œ gulp å‘½ä»¤æ—¶æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">gulp.task(<span class="string">&#x27;default&#x27;</span>, [</span><br><span class="line">    <span class="string">&#x27;minify-html&#x27;</span>,<span class="string">&#x27;minify-css&#x27;</span>,<span class="string">&#x27;minify-js&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆåšæ–‡æ˜¯æ‰§è¡Œ <code>hexo g &amp;&amp; gulp</code> å°±ä¼šæ ¹æ® <code>gulpfile.js</code> ä¸­çš„é…ç½®ï¼Œå¯¹ public ç›®å½•ä¸­çš„é™æ€èµ„æºæ–‡ä»¶è¿›è¡Œå‹ç¼©ã€‚</p><h3 id="2-21-æ·»åŠ ä¸»é¡µæ–‡ç« é˜´å½±æ•ˆæœï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-21-æ·»åŠ ä¸»é¡µæ–‡ç« é˜´å½±æ•ˆæœï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.21 æ·»åŠ ä¸»é¡µæ–‡ç« é˜´å½±æ•ˆæœï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.21 æ·»åŠ ä¸»é¡µæ–‡ç« é˜´å½±æ•ˆæœï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>æ‰“å¼€ <code>\themes\next\source\css\_custom\custom.styl</code> ï¼Œå‘é‡Œé¢åŠ å…¥ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// ä¸»é¡µæ–‡ç« æ·»åŠ é˜´å½±æ•ˆæœ</span><br><span class="line"> <span class="selector-class">.post</span> &#123;</span><br><span class="line">   <span class="attribute">margin-top</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">margin-bottom</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">   -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">203</span>, .<span class="number">5</span>);</span><br><span class="line">   -moz-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, .<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-22-æ·»åŠ åŠ¨æ€èƒŒæ™¯ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#2-22-æ·»åŠ åŠ¨æ€èƒŒæ™¯ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="2.22 æ·»åŠ åŠ¨æ€èƒŒæ™¯ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>2.22 æ·»åŠ åŠ¨æ€èƒŒæ™¯ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>å¦‚æœnextä¸»é¢˜åœ¨5.1.1ä»¥ä¸Šçš„è¯ï¼Œç›´æ¥åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­æ‰¾åˆ° <code>canvas_nest: false</code> ï¼ŒæŠŠå®ƒæ”¹ä¸º <code>canvas_nest: true</code> å°±è¡Œäº†ï¼ˆæ³¨æ„åˆ†å·åé¢è¦åŠ ä¸€ä¸ªç©ºæ ¼ï¼‰ã€‚</p><h2 id="ä¸‰-åŠŸèƒ½é…ç½®-åšæ–‡"><a href="#ä¸‰-åŠŸèƒ½é…ç½®-åšæ–‡" class="headerlink" title="ä¸‰. åŠŸèƒ½é…ç½®-åšæ–‡"></a>ä¸‰. åŠŸèƒ½é…ç½®-åšæ–‡</h2><h3 id="3-1-å¼€å¯å›¾ç‰‡ç¯ç®±"><a href="#3-1-å¼€å¯å›¾ç‰‡ç¯ç®±" class="headerlink" title="3.1 å¼€å¯å›¾ç‰‡ç¯ç®±"></a>3.1 å¼€å¯å›¾ç‰‡ç¯ç®±</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class="line"><span class="comment"># For more information: https://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-2-ä¿®æ”¹æ ‡ç­¾å›¾æ ‡"><a href="#3-2-ä¿®æ”¹æ ‡ç­¾å›¾æ ‡" class="headerlink" title="3.2 ä¿®æ”¹æ ‡ç­¾å›¾æ ‡"></a>3.2 ä¿®æ”¹æ ‡ç­¾å›¾æ ‡</h3><p>é»˜è®¤æƒ…å†µä¸‹æ ‡ç­¾å‰ç¼€æ˜¯ <code>#</code> å­—ç¬¦ï¼Œæ—§ç‰ˆæœ¬ä¸­ç”¨æˆ·å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸»é¢˜æºç å°†æ ‡ç­¾çš„å­—ç¬¦å‰ç¼€æ”¹ä¸ºå›¾æ ‡å‰ç¼€ï¼Œåœ¨ <code>themes\next\layout\_macro\post.swig  </code> æ–‡ç« å¸ƒå±€æ¨¡æ¿ä¸­æ‰¾åˆ°æ–‡æœ«æ ‡ç­¾ç›¸å…³ä»£ç æ®µï¼Œå°† <code>#</code> æ¢æˆ <code>&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt;</code> å³å¯ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer class=&quot;post-footer&quot;&gt;</span><br><span class="line">    &#123;% if post.tags and post.tags.length and not is_index %&#125;</span><br><span class="line">      &lt;div class=&quot;post-tags&quot;&gt;</span><br><span class="line">        &#123;% for tag in post.tags %&#125;</span><br><span class="line"><span class="deletion">-          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;# &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line"><span class="addition">+          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt; &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/footer&gt;</span><br></pre></td></tr></table></figure><p>Next ä¸­ä½¿ç”¨ <a href="https://fontawesome.com/v4.7.0/icons/">FontAwesome</a> ä½œä¸ºå›¾æ ‡åº“ï¼Œç”¨æˆ·å¯ä»¥åœ¨ FontAwesome ä¸Šæ‰¾åˆ°å¿ƒä»ªçš„å›¾æ ‡æ¥æ›¿æ¢æ ‡ç­¾çš„å­—ç¬¦å‰ç¼€ã€‚</p><p>æ–°ç‰ˆç›´æ¥ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use icon instead of the symbol # to indicate the tag at the bottom of the post</span></span><br><span class="line"><span class="attr">tag_icon:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-3-å¼€å¯ç›¸å…³æ–‡ç« æ¨è"><a href="#3-3-å¼€å¯ç›¸å…³æ–‡ç« æ¨è" class="headerlink" title="3.3 å¼€å¯ç›¸å…³æ–‡ç« æ¨è"></a>3.3 å¼€å¯ç›¸å…³æ–‡ç« æ¨è</h3><p>è¯¥åŠŸèƒ½ç”± <a href="https://github.com/tea3/hexo-related-popular-posts">hexo-related-popular-posts</a> æ’ä»¶æä¾›ï¼Œåœ¨ç«™ç‚¹æ ¹ç›®å½•ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-related-popular-posts --save</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> å¼€å¯ç›¸å…³æ–‡ç« æ¨èåŠŸèƒ½ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Related popular posts</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/tea3/hexo-related-popular-posts</span></span><br><span class="line"><span class="attr">related_posts:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">title:</span> <span class="comment"># Custom header, leave empty to use the default one</span></span><br><span class="line">  <span class="attr">display_in_home:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">maxCount:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment">#PPMixingRate: 0.0</span></span><br><span class="line">    <span class="comment">#isDate: false</span></span><br><span class="line">    <span class="comment">#isImage: false</span></span><br><span class="line">    <span class="comment">#isExcerpt: false</span></span><br></pre></td></tr></table></figure><p>ä¼šåœ¨æ¯ç¯‡æ–‡ç« ç»“å°¾æ ¹æ®æ ‡ç­¾ç›¸å…³æ€§å’Œå†…å®¹ç›¸å…³æ€§æ¥æ¨èç›¸å…³æ–‡ç« ã€‚äº‹å®ä¸Šå¹¶éæ¯ç¯‡æ–‡ç« éƒ½éœ€è¦å¼€å¯è¯¥åŠŸèƒ½ï¼Œå¯åœ¨æ–‡ç«  Front-Matter ä¸­è®¾ç½® <code>related_posts</code> å­—æ®µæ¥æ§åˆ¶æ˜¯å¦åœ¨æ–‡æœ«æ˜¾ç¤ºç›¸å…³æ–‡ç« ï¼Œç„¶åä¿®æ”¹æ–‡ç« å¸ƒå±€æ¨¡æ¿ä¸­ç›¸å…³çš„åˆ¤å®šæ¡ä»¶ <code>themes/next/layout/_macro/post.njk</code> ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) %&#125;</span></span><br><span class="line"><span class="addition">+     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) and post.related_posts %&#125;</span></span><br><span class="line">      &#123;&#123; partial(&#x27;_partials/post/post-related.njk&#x27;) &#125;&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿å¯åœ¨è‰ç¨¿æ¨¡æ¿ <code>\scaffolds\draft.md</code> ä¸­ç»Ÿä¸€æ·»åŠ  <code>related_posts</code> å­—æ®µé»˜è®¤å€¼ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="addition">+ related_posts: true</span></span><br></pre></td></tr></table></figure><h3 id="3-4-ä¿®æ”¹ä»£ç å—è‡ªå®šä¹‰æ ·å¼"><a href="#3-4-ä¿®æ”¹ä»£ç å—è‡ªå®šä¹‰æ ·å¼" class="headerlink" title="3.4 ä¿®æ”¹ä»£ç å—è‡ªå®šä¹‰æ ·å¼"></a>3.4 ä¿®æ”¹ä»£ç å—è‡ªå®šä¹‰æ ·å¼</h3><p>æ—§ç‰ˆæœ¬ï¼Œæ‰“å¼€ <code>\themes\next\source\css\_custom\custom.styl</code> ï¼Œå‘é‡Œé¢åŠ å…¥ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Custom styles.</span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ff7600</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fbf7f8</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br><span class="line">// å¤§ä»£ç å—çš„è‡ªå®šä¹‰æ ·å¼</span><br><span class="line"><span class="selector-class">.highlight</span>, pre &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.highlight</span>, <span class="selector-tag">code</span>, pre &#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d6d6d6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆæœ¬ï¼Œä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># Code Highlight theme</span></span><br><span class="line">  <span class="comment"># All available themes: https://theme-next.js.org/highlight/</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">tomorrow-night</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="comment"># Add copy button on codeblock</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">mac</span></span><br></pre></td></tr></table></figure><h3 id="3-5-æ·»åŠ é¡¶éƒ¨åŠ è½½æ¡"><a href="#3-5-æ·»åŠ é¡¶éƒ¨åŠ è½½æ¡" class="headerlink" title="3.5 æ·»åŠ é¡¶éƒ¨åŠ è½½æ¡"></a>3.5 æ·»åŠ é¡¶éƒ¨åŠ è½½æ¡</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> å°† <code>pace: false</code> æ”¹ä¸º <code>pace: true</code> ï¼Œè¿˜å¯ä»¥æ¢ä¸åŒæ ·å¼çš„åŠ è½½æ¡ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280212.png"></p><p>æŸ¥çœ‹ä¸åŒä¸»é¢˜æ•ˆæœï¼š<a href="https://codebyzach.github.io/pace/">Pace-Themes</a></p><p>V8ç‰ˆæœ¬ä¹‹åå¥½åƒåºŸå¼ƒäº†Paceï¼Œä»£æ›¿ä¸ºnprogressï¼Œä½†æ²¡æœ‰æ ·å¼å¯ä»¥é€‰ï¼Œè€Œä¸”ä¼¼ä¹ä¼šå’Œé˜…è¯»è¿›åº¦æ¡å†²çªï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Progress bar in the top during page loading.</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rstacruz/nprogress</span></span><br><span class="line"><span class="attr">nprogress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">spinner:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-6-å¼€å¯é¡¶éƒ¨é˜…è¯»è¿›åº¦"><a href="#3-6-å¼€å¯é¡¶éƒ¨é˜…è¯»è¿›åº¦" class="headerlink" title="3.6 å¼€å¯é¡¶éƒ¨é˜…è¯»è¿›åº¦"></a>3.6 å¼€å¯é¡¶éƒ¨é˜…è¯»è¿›åº¦</h3><p>ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Reading progress bar</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available values: left | right</span></span><br><span class="line">  <span class="attr">start_at:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment"># Available values: top | bottom</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">top</span></span><br><span class="line">  <span class="attr">reversed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37acc6&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">3px</span></span><br></pre></td></tr></table></figure><h3 id="3-7-å³ä¸Šè§’æ·»åŠ bookmarkè®°å½•é˜…è¯»è¿›åº¦"><a href="#3-7-å³ä¸Šè§’æ·»åŠ bookmarkè®°å½•é˜…è¯»è¿›åº¦" class="headerlink" title="3.7 å³ä¸Šè§’æ·»åŠ bookmarkè®°å½•é˜…è¯»è¿›åº¦"></a>3.7 å³ä¸Šè§’æ·»åŠ bookmarkè®°å½•é˜…è¯»è¿›åº¦</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bookmark Support</span></span><br><span class="line"><span class="attr">bookmark:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Customize the color of the bookmark.</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#222&quot;</span></span><br><span class="line">  <span class="comment"># If auto, save the reading progress when closing the page or clicking the bookmark-icon.</span></span><br><span class="line">  <span class="comment"># If manual, only save it by clicking the bookmark-icon.</span></span><br><span class="line">  <span class="attr">save:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><h3 id="3-8-å³ä¸Šè§’æ·»åŠ -Follow-Me-On-GitHub"><a href="#3-8-å³ä¸Šè§’æ·»åŠ -Follow-Me-On-GitHub" class="headerlink" title="3.8 å³ä¸Šè§’æ·»åŠ  Follow Me On GitHub"></a>3.8 å³ä¸Šè§’æ·»åŠ  Follow Me On GitHub</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `Follow me on GitHub` banner in the top-right corner.</span></span><br><span class="line"><span class="attr">github_banner:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">permalink:</span> <span class="string">https://github.com/LAILAIWA</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Follow</span> <span class="string">me</span> <span class="string">on</span> <span class="string">GitHub</span></span><br></pre></td></tr></table></figure><h3 id="3-9-è¿”å›é¡¶éƒ¨æŒ‰é’®æ·»åŠ ç™¾åˆ†æ¯”"><a href="#3-9-è¿”å›é¡¶éƒ¨æŒ‰é’®æ·»åŠ ç™¾åˆ†æ¯”" class="headerlink" title="3.9 è¿”å›é¡¶éƒ¨æŒ‰é’®æ·»åŠ ç™¾åˆ†æ¯”"></a>3.9 è¿”å›é¡¶éƒ¨æŒ‰é’®æ·»åŠ ç™¾åˆ†æ¯”</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-10-å–æ¶ˆç›®å½•ç”Ÿæˆçš„è‡ªåŠ¨åºå·"><a href="#3-10-å–æ¶ˆç›®å½•ç”Ÿæˆçš„è‡ªåŠ¨åºå·" class="headerlink" title="3.10 å–æ¶ˆç›®å½•ç”Ÿæˆçš„è‡ªåŠ¨åºå·"></a>3.10 å–æ¶ˆç›®å½•ç”Ÿæˆçš„è‡ªåŠ¨åºå·</h3><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­numberå±æ€§ä¸ºfalseå³å¯ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Table Of Contents in the Sidebar</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="3-11-æ·»åŠ åº•éƒ¨è®¿é—®é‡ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#3-11-æ·»åŠ åº•éƒ¨è®¿é—®é‡ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="3.11 æ·»åŠ åº•éƒ¨è®¿é—®é‡ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>3.11 æ·»åŠ åº•éƒ¨è®¿é—®é‡ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>æ‰“å¼€ <code>\themes\next\layout\_partials\footer.swig</code> æ–‡ä»¶ï¼Œåœ¨copyrightå‰åŠ ä¸Šè¿™å¥è¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;https://dn-</span></span></span><br><span class="line"><span class="string"><span class="tag">lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>2019/07/16æ›´æ–°ï¼š<a href="http://busuanzi.ibruce.info/" title="Title">ä¸è’œå­å®˜ç½‘</a>æç¤ºåŸåœ°å€å·²å¤±æ•ˆï¼Œè¯·æŠŠdn-lbstatics.qbox.me åŸŸåæ›´æ¢ä¸º busuanzi.ibruce.info</p></blockquote><p>ç„¶ååœ¨åˆé€‚çš„ä½ç½®æ·»åŠ æ˜¾ç¤ºç»Ÿè®¡çš„ä»£ç :</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280215.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;powered-by&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-user-md&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  æœ¬ç«™è®¿å®¢æ•°:<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæœ‰ä¸¤ä¸­ä¸åŒè®¡ç®—æ–¹å¼çš„ç»Ÿè®¡ä»£ç ï¼š</p><ul><li><p>pvçš„æ–¹å¼ï¼Œå•ä¸ªç”¨æˆ·è¿ç»­ç‚¹å‡»nç¯‡æ–‡ç« ï¼Œè®°å½•næ¬¡è®¿é—®é‡ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span></span><br><span class="line">    æœ¬ç«™æ€»è®¿é—®é‡<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_pv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>æ¬¡</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>uvçš„æ–¹å¼ï¼Œå•ä¸ªç”¨æˆ·è¿ç»­ç‚¹å‡»nç¯‡æ–‡ç« ï¼Œåªè®°å½•1æ¬¡è®¿å®¢æ•°ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  æœ¬ç«™æ€»è®¿é—®é‡<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>æ¬¡</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>æ·»åŠ ä¹‹åå†æ‰§è¡Œ <code>hexo d -g</code> ï¼Œç„¶åå†åˆ·æ–°é¡µé¢å°±èƒ½çœ‹åˆ°æ•ˆæœã€‚</p><h3 id="3-12-æ·»åŠ åšæ–‡æœ«å°¾æ ‡è®°ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#3-12-æ·»åŠ åšæ–‡æœ«å°¾æ ‡è®°ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="3.12 æ·»åŠ åšæ–‡æœ«å°¾æ ‡è®°ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>3.12 æ·»åŠ åšæ–‡æœ«å°¾æ ‡è®°ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><p>åœ¨ <code>\themes\next\layout\_macro</code> ä¸­æ–°å»º <code>passage-end-tag.swig</code> æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if not is_index %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;color: #ccc;font-size:14px;&quot;</span>&gt;</span>-------------æœ¬æ–‡ç»“æŸ<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-paw&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰“å¼€ <code>\themes\next\layout\_macro\post.swig</code> æ–‡ä»¶ï¼Œåœ¨post-body ä¹‹åï¼Œ post-footer ä¹‹å‰æ·»åŠ å¦‚ä¸‹ç”»çº¢è‰²éƒ¨åˆ†ä»£ç ï¼ˆpost-footerä¹‹å‰ä¸¤ä¸ªDIVï¼‰:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280211.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">    &#123;% include &#x27;passage-end-tag.swig&#x27; %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ï¼Œåœ¨æœ«å°¾æ·»åŠ :</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–‡ç« æœ«å°¾æ·»åŠ â€œæœ¬æ–‡ç»“æŸâ€æ ‡è®°</span></span><br><span class="line"><span class="attr">passage_end_tag:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å®Œæˆä»¥ä¸Šè®¾ç½®ä¹‹åï¼Œåœ¨æ¯ç¯‡æ–‡ç« ä¹‹åéƒ½ä¼šæ·»åŠ å¦‚ä¸Šæ•ˆæœå›¾çš„æ ·å­ã€‚</p><h3 id="3-13-MarkDownå¸¸ç”¨"><a href="#3-13-MarkDownå¸¸ç”¨" class="headerlink" title="3.13 MarkDownå¸¸ç”¨"></a>3.13 MarkDownå¸¸ç”¨</h3><p>ä»£ç æ–°å¢åˆ é™¤å˜è‰²ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â€‹<span class="code">```diff</span></span><br><span class="line"><span class="code">+</span></span><br><span class="line"><span class="code">-</span></span><br><span class="line"><span class="code">â€‹```</span></span><br></pre></td></tr></table></figure><h2 id="å››-æ–°å¢æ’ä»¶"><a href="#å››-æ–°å¢æ’ä»¶" class="headerlink" title="å››. æ–°å¢æ’ä»¶"></a>å››. æ–°å¢æ’ä»¶</h2><h3 id="4-1-ç»Ÿè®¡åŠŸèƒ½"><a href="#4-1-ç»Ÿè®¡åŠŸèƒ½" class="headerlink" title="4.1 ç»Ÿè®¡åŠŸèƒ½"></a>4.1 ç»Ÿè®¡åŠŸèƒ½</h3><p>å®ç°ç»Ÿè®¡åŠŸèƒ½ï¼Œé¦–å…ˆåœ¨æ ¹ç›®å½•ä¸‹å®‰è£… <code>hexo-wordcount</code> ï¼Œè¿è¡Œ:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-wordcount --save</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/willin/hexo-wordcount</span></span><br><span class="line"><span class="attr">post_wordcount:</span></span><br><span class="line">  <span class="attr">item_text:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wordcount:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">min2read:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆæœ¬ï¼Œåœ¨æ ¹ç›®å½•ä¸‹å®‰è£… <code>hexo-word-counter</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-word-counter</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br></pre></td></tr></table></figure><p>æ ¹ç›®å½•é…ç½®æ–‡ä»¶ <code>\_config.yml</code> æ·»åŠ ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å­—æ•°ç»Ÿè®¡</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># å¼€å¯å½“å‰é¡µé¢å­—æ•°ç»Ÿè®¡</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># å¼€å¯å½“å‰é¡µé¢ä¼°è®¡é˜…è¯»æ—¶é—´</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># é¡µè„šæ·»åŠ å…¨ç«™å­—æ•°ç»Ÿè®¡</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># é¡µè„šæ·»åŠ å…¨ç«™ä¼°è®¡é˜…è¯»æ—¶é—´</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># å¹³å‡å­—é•¿</span></span><br><span class="line">  <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># æ¯åˆ†é’Ÿçš„å¹³å‡å­—æ•°</span></span><br><span class="line">  <span class="attr">wpm:</span> <span class="number">275</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># æ˜¯å¦åœ¨åŒä¸€è¡Œ</span></span><br><span class="line">  <span class="attr">separated_meta:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># æ˜¯å¦åœ¨é¡µè„šæ˜¾å¼</span></span><br><span class="line">  <span class="attr">item_text_total:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="4-2-å¢åŠ æœç´¢åŠŸèƒ½"><a href="#4-2-å¢åŠ æœç´¢åŠŸèƒ½" class="headerlink" title="4.2 å¢åŠ æœç´¢åŠŸèƒ½"></a>4.2 å¢åŠ æœç´¢åŠŸèƒ½</h3><p>å®‰è£… <code>hexo-generator-searchdb</code> ï¼Œåœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-generator-searchdb --save</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>blog/themes/next/_config.yml</code> ï¼Œæ‰¾åˆ° <code>local_search</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Local search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/flashlab/hexo-generator-search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># if auto, trigger search by changing input</span></span><br><span class="line">  <span class="comment"># if manual, trigger search by pressing enter key or search button</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="4-3-å¤œæ™šæ¨¡å¼"><a href="#4-3-å¤œæ™šæ¨¡å¼" class="headerlink" title="4.3 å¤œæ™šæ¨¡å¼"></a>4.3 å¤œæ™šæ¨¡å¼</h3><p>å®‰è£… <code>hexo-next-darkmode</code> æ’ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-next-darkmode --save</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> é‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Darkmode JS</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rqh656418510/hexo-next-darkmode, https://github.com/sandoche/Darkmode.js</span></span><br><span class="line"><span class="attr">darkmode_js:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bottom:</span> <span class="string">&#x27;64px&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">right:</span> <span class="string">&#x27;unset&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">left:</span> <span class="string">&#x27;32px&#x27;</span> <span class="comment"># default: &#x27;unset&#x27;</span></span><br><span class="line">  <span class="attr">time:</span> <span class="string">&#x27;0.5s&#x27;</span> <span class="comment"># default: &#x27;0.3s&#x27;</span></span><br><span class="line">  <span class="attr">mixColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">backgroundColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorDark:</span> <span class="string">&#x27;#100f2c&#x27;</span> <span class="comment"># default: &#x27;#100f2c&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorLight:</span> <span class="string">&#x27;#fff&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">isActivated:</span> <span class="literal">false</span> <span class="comment"># default false</span></span><br><span class="line">  <span class="attr">saveInCookies:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">&#x27;ğŸŒ“&#x27;</span> <span class="comment"># default: &#x27;&#x27;</span></span><br><span class="line">  <span class="attr">autoMatchOsTheme:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="comment"># Set custom library cdn url for Darkmode.js</span></span><br></pre></td></tr></table></figure><ul><li><code>isActivated: true</code>ï¼šé»˜è®¤æ¿€æ´»æš—é»‘ / å¤œé—´æ¨¡å¼ï¼Œè¯·å§‹ç»ˆä¸ <code>saveInCookies: false</code>ã€<code>autoMatchOsTheme: false</code> ä¸€èµ·ä½¿ç”¨</li></ul><p>ç¡®ä¿ Next åŸç”Ÿçš„ <code>darkmode</code> é€‰é¡¹è®¾ç½®ä¸º <code>false</code>ï¼Œåœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­æ›´æ”¹ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">darkmode:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>å¤œæ™šæ¨¡å¼æ¿€æ´»åï¼Œ<code>hexo-next-darkmode</code> æ’ä»¶ä¼šå°† <code>darkmode--activated</code> CSS ç±»æ·»åŠ åˆ° <code>body</code> æ ‡ç­¾ï¼Œå¯ä»¥åˆ©ç”¨å®ƒè¦†ç›–æ’ä»¶é»˜è®¤è‡ªå¸¦çš„ CSS æ ·å¼ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰ï¼›è¿™æ ·å°±å¯ä»¥å®ç°æš—é»‘æ¨¡å¼ CSS æ ·å¼çš„é«˜åº¦è‡ªå®šä¹‰ï¼ŒåŒ…æ‹¬ä»£ç å—é¢œè‰²è‡ªå®šä¹‰åˆ‡æ¢ç­‰ã€‚æ›´å¤šé…ç½®å†…å®¹ä»‹ç»å¯ä»¥å‚è€ƒ<a href="https://github.com/rqh656418510/hexo-next-darkmode/blob/main/README_CN.md">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå®ç°åŸç†åˆ†æå¯ä»¥çœ‹<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90">è¿™é‡Œ</a>ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.darkmode--activated</span> &#123;</span><br><span class="line">  --<span class="selector-tag">body</span>-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="attribute">content</span>-bg-<span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  --card-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --text-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --<span class="selector-tag">blockquote</span>-<span class="attribute">color</span>: <span class="number">#bbb</span>;</span><br><span class="line">  --link-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --link-hover-<span class="attribute">color</span>: <span class="number">#eee</span>;</span><br><span class="line">  --brand-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --brand-hover-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-odd-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-hover-bg-<span class="attribute">color</span>: <span class="number">#363636</span>;</span><br><span class="line">  --<span class="selector-tag">menu</span>-item-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-bg: <span class="number">#222</span>;</span><br><span class="line">  --btn-default-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-<span class="attribute">border-color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-hover-bg: <span class="number">#666</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">border-color</span>: <span class="number">#666</span>;</span><br><span class="line">  --highlight-<span class="attribute">background</span>: <span class="number">#282b2e</span>;</span><br><span class="line">  --highlight-foreground: <span class="number">#a9b7c6</span>;</span><br><span class="line">  --highlight-gutter-<span class="attribute">background</span>: <span class="number">#34393d</span>;</span><br><span class="line">  --highlight-gutter-foreground: <span class="number">#9ca9b6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.75</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#69dbdc</span>;</span><br><span class="line">  <span class="attribute">background</span>: transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hexo é‡æ–°æ„å»ºç”Ÿæˆé™æ€æ–‡ä»¶åï¼Œç‚¹å‡»é¡µé¢ä¸Šçš„æŒ‰é’®å³å¯åˆ‡æ¢æš—é»‘æ¨¡å¼ï¼Œæœ€ç»ˆæ¼”ç¤ºæ•ˆæœå¯ä»¥çœ‹<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E6%9C%80%E7%BB%88%E6%BC%94%E7%A4%BA%E6%95%88%E6%9E%9C">è¿™é‡Œ</a>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo g -d</span></span><br></pre></td></tr></table></figure><h3 id="4-4-è±†ç“£é˜…è¯»-ç”µå½±-æ¸¸æˆ"><a href="#4-4-è±†ç“£é˜…è¯»-ç”µå½±-æ¸¸æˆ" class="headerlink" title="4.4 è±†ç“£é˜…è¯» / ç”µå½± / æ¸¸æˆ"></a>4.4 è±†ç“£é˜…è¯» / ç”µå½± / æ¸¸æˆ</h3><p>ä¸ºç«™ç‚¹æ·»åŠ è±†ç“£é˜…è¯» / ç”µå½± / æ¸¸æˆé¡µé¢ï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ç›¸å…³ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-douban --save</span></span><br></pre></td></tr></table></figure><p>åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ <code>/_config.yml</code> ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">douban:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="comment"># ä¸ªäººè±†ç“£ID</span></span><br><span class="line">  <span class="attr">builtin:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">book:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my book title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my book quote&quot;</span></span><br><span class="line">  <span class="attr">movie:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my movie title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my movie quote&quot;</span></span><br><span class="line">  <span class="attr">game:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my game title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my game quote&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure><ul><li>user: å¡«å†™è±†ç“£ IDã€‚ç™»é™†è±†ç“£åç‚¹å‡»<strong>ä¸ªäººä¸»é¡µ</strong>ï¼Œæ­¤æ—¶ url ä¸­æœ€åä¸€æ®µå³æ˜¯ç”¨æˆ· IDï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šæ˜¯ä¸€æ®µæ•°å­—ï¼Œå¦‚æœè®¾ç½®äº†ä¸ªäººåŸŸåçš„è¯ï¼Œåˆ™ä¸ªäººåŸŸåå³ä¸º IDã€‚</li><li>builtin: æ˜¯å¦å°†ç”Ÿæˆé¡µé¢çš„åŠŸèƒ½åµŒå…¥ <code>hexo s</code> å’Œ <code>hexo g</code> ä¸­ã€‚</li><li>timeout: çˆ¬å–æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚</li></ul><p>å¦‚æœåªæƒ³ç”ŸæˆæŸä¸€ä¸ªé¡µé¢ï¼ˆæ¯”å¦‚åªç”Ÿæˆè¯»ä¹¦é¡µé¢ï¼‰ï¼ŒæŠŠå…¶ä»–çš„é…ç½®é¡¹æ³¨é‡Šæ‰å³å¯ã€‚</p><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>\themes\next\_config.yml</code> ä¸­æ–°å¢èœå•å…¥å£ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: / || home</span><br><span class="line">    tags: /tags/ || tags</span><br><span class="line">    categories: /categories/ || th</span><br><span class="line">    archives: /archives/ || tasks</span><br><span class="line"><span class="addition">+   books: /books/ || book</span></span><br><span class="line"><span class="addition">+   movies: /movies/ || video-camera</span></span><br><span class="line"><span class="addition">+   games: /games/ || gamepad</span></span><br></pre></td></tr></table></figure><p>åœ¨è¯­è¨€åŒ… <code>themes\next\language\zh_CN.yml</code> ä¸­æ–°å¢èœå•ä¸­æ–‡ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: é¦–é¡µ</span><br><span class="line">    archives: å½’æ¡£</span><br><span class="line">    categories: åˆ†ç±»</span><br><span class="line">    tags: æ ‡ç­¾</span><br><span class="line"><span class="addition">+   movies: ç”µå½±</span></span><br><span class="line"><span class="addition">+   books: è¯»ä¹¦</span></span><br><span class="line"><span class="addition">+   games: æ¸¸æˆ</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè±†ç“£é˜…è¯» / ç”µå½± / æ¸¸æˆé¡µé¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo douban</span></span><br></pre></td></tr></table></figure><p>å¯é€‰å‚æ•°:</p><ul><li>-b | â€“books: åªç”Ÿæˆè±†ç“£è¯»ä¹¦é¡µé¢</li><li>-m | â€“movies: åªç”Ÿæˆè±†ç“£ç”µå½±é¡µé¢</li><li>-g | â€“games: åªç”Ÿæˆè±†ç“£æ¸¸æˆé¡µé¢</li></ul><p>æ‰§è¡Œå‘½ä»¤åï¼Œæ’ä»¶ä¼šæ ¹æ®ç”¨æˆ·æä¾›çš„ ID çˆ¬å–è±†ç“£ä¸­çš„æ•°æ®ä¿¡æ¯å¹¶åœ¨ <code>public</code> ç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„é¡µé¢ï¼Œå½“æœåŠ¡å™¨å¯åŠ¨æˆ–éƒ¨ç½²åä¼šå°†é¡µé¢æ˜¾ç¤ºåœ¨å¯¹åº”çš„èœå•è·¯ç”±ä¸‹ã€‚</p><p>å¦‚æœåœ¨ç«™ç‚¹é…ç½®ä¸­è®¾ç½®äº† <code>douban.builtin: false</code>ï¼Œåˆ™æ¯æ¬¡è±†ç“£æ•°æ®å˜åŠ¨åéœ€è¦æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ <code>hexo douban</code> æ¥åˆ·æ–°é¡µé¢æ•°æ®ã€‚å¦‚æœè®¾ç½®äº† <code>douban.builtin: true</code>ï¼Œåˆ™æ¯æ¬¡æ‰§è¡Œ <code>hexo s</code> å’Œ <code>hexo g</code> çš„æ—¶å€™å°†ä¼šè‡ªåŠ¨åŒæ—¶æ‰§è¡Œ <code>hexo douban</code> å‘½ä»¤ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šå¢åŠ æ‰“åŒ…ç¼–è¯‘çš„æ—¶é—´ã€‚å»ºè®®å¦‚æœè±†ç“£æ•°æ®å˜åŠ¨ä¸é¢‘ç¹çš„æƒ…å†µä¸‹è¯¥é¡¹è®¾ä¸º <code>false</code> å³å¯ã€‚</p><p>æ™®éä¼šç”¨ <code>hexo d</code> æ¥ä½œä¸º <code>hexo deploy</code> å‘½ä»¤çš„ç®€åŒ–ï¼Œä½†æ˜¯å½“å®‰è£…äº† <code>hexo douban</code> ä¹‹åï¼Œ <code>hexo d</code> å°±ä¼šæœ‰æ­§ä¹‰è€Œæ— æ³•æ‰§è¡Œï¼Œå› ä¸º <code>hexo douban</code> è·Ÿ <code>hexo deploy</code> çš„ Alias éƒ½æ˜¯ <code>hexo d</code>ã€‚</p><p>ä»¥ä¸‹é—®é¢˜éœ€è¦é‡è£…Nodeåˆ°12.18.xçš„ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  0 books have been loaded in 1223 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 movies have been loaded in 1743 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 games have been loaded in 1133 ms, because you are offline or your network is bad</span><br></pre></td></tr></table></figure><h3 id="4-5-ç•™è¨€æ¿"><a href="#4-5-ç•™è¨€æ¿" class="headerlink" title="4.5 ç•™è¨€æ¿"></a>4.5 ç•™è¨€æ¿</h3><p>Next æ”¯æŒå¤šæ¬¾è¯„è®ºç³»ç»Ÿï¼š</p><ul><li><a href="https://disqus.com/">Disqus</a>ï¼šæ¬§ç¾ UI é£æ ¼ï¼Œæ”¯æŒ Tweetã€Facebook ç­‰å›½å¤–ç¤¾äº¤è½¯ä»¶çš„ä¸‰æ–¹ç™»é™†å’Œä¸€é”®åˆ†äº«ï¼› <a href="https://blog.disqus.com/disqus-welcomes-the-spruce">Demo</a>ï¼›</li><li><a href="https://github.com/imsun/gitment">gitment</a>ï¼šå¿…é¡»ç”¨ github è´¦å·ç™»é™†æ‰èƒ½è¯„è®ºï¼Œæ”¯æŒ Markdown è¯­æ³•ï¼Œä¸ github issues é¡µé¢é£æ ¼ä¸€è‡´ï¼›<a href="https://imsun.github.io/gitment/">Demo</a>ï¼›</li><li><a href="https://valine.js.org/">Valine</a>ï¼šæ”¯æŒåŒ¿åè¯„è®ºï¼Œæ”¯æŒ Markdown è¯­æ³•ï¼Œç•Œé¢ç®€æ´ç¾è§‚ï¼›</li><li><a href="http://changyan.kuaizhan.com/">ç•…è¨€</a>ï¼šå›½äº§è¯„è®ºç³»ç»Ÿï¼Œå¯åŒºåˆ†çƒ­è¯„å’Œæœ€æ–°è¯„è®ºï¼Œè®ºå›è´´å§é£ï¼›</li><li><a href="https://www.livere.com/">æ¥å¿…åŠ›</a>ï¼šæ”¯æŒæ’å…¥å›¾ç‰‡å’Œ GIFï¼Œæ”¯æŒå›½å†…å¤–å¤šç§ç¤¾äº¤åª’ä½“çš„ä¸‰æ–¹ç™»é™† <a href="https://www.livere.com/city-demo">Demo</a>ï¼›</li></ul><h4 id="ï¼ˆ1ï¼‰utterances"><a href="#ï¼ˆ1ï¼‰utterances" class="headerlink" title="ï¼ˆ1ï¼‰utterances"></a>ï¼ˆ1ï¼‰utterances</h4><blockquote><p>ä¸ºä»€ä¹ˆé€‰ç”¨utterancesï¼Ÿ</p><ol><li>æ²¡æœ‰å¹¿å‘Š</li><li>ä¸ä¼šè¿½è¸ªç”¨æˆ·éšç§</li><li>æ­å»ºäºGitHubï¼Œä¸éœ€è¦å†æ³¨å†Œè´¦å·æ‰èƒ½ä½¿ç”¨</li></ol></blockquote><p><a href="https://github.com/apps/utterances" title="title">å®‰è£…utterances</a>-&gt;ã€Installã€‘-&gt;ã€Only Select Repositoriesã€‘é€‰æ‹©åšå®¢æ‰€åœ¨repo-&gt;ã€å¡«å†™owner/repoã€‘-&gt;ã€è®¾ç½®issueæ ‡é¢˜å¦‚ä½•å¼€ã€‘-&gt;ã€å¡«å†™Issue Labelã€‘-&gt;ã€é€‰æ‹©ä¸»é¢˜æ ·å¼ã€‘-&gt;ã€å¤åˆ¶ç”Ÿæˆçš„ä»£ç ã€‘ã€‚</p><p>é¦–å…ˆåœ¨åšå®¢å¯¹åº”çš„Repositoryä¸­å¢åŠ è¦ä½¿ç”¨çš„labelï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010186.png"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ–°å¢äº†ä¸€ä¸ªğŸ’¬Commentsï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010187.png"></p><p>ä¿®æ”¹ <code>blog\themes\next\layout\_third-party\comments\utterances.swig</code> (è¯·æ³¨æ„æ­¤å¤„æœ‰æ¼æ‰labelçš„é…ç½®ï¼Œåç»­æ‰å‘ç°ï¼Œå¯ä»¥å‚è€ƒä¸‹æ–‡ä¸­æ­£ç¡®å†…å®¹)ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>blog\themes\next\layout\_partials\comments.swig</code> ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% elseif theme.valine.appid and theme.valine.appkey %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% elseif theme.utterances.enable %&#125;</span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">     &#123;% include &#x27;../_third-party/comments/utterances.swig&#x27; %&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸»é¢˜çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¢åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ ç•™è¨€æ¿åŠŸèƒ½</span></span><br><span class="line"><span class="comment"># Demo: https://utteranc.es/  http://trumandu.github.io/about/</span></span><br><span class="line">  <span class="comment"># pathname, url, title, og:title [ISSUE NUMBER] or [SPECIFIC TERM]</span></span><br><span class="line">  <span class="comment"># theme: github-light,github-dark,github-dark-orange</span></span><br><span class="line">  <span class="comment"># The label must exist in your repo</span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">LAILAIWA/LAILAIWA.github.io</span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">ğŸ’¬Comments</span> </span><br></pre></td></tr></table></figure><p>æ›´æ–°åšå®¢ï¼Œå¹¶ä»»æ„æ‰“å¼€ä¸€ç¯‡æ–‡ç« ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010188.png"></p><p>éœ€è¦æˆæƒGitHubè´¦æˆ·ä¿¡æ¯æ‰èƒ½æ­£å¸¸ä½¿ç”¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010189.png"></p><p>å°è¯•è¯„è®ºä¸€æ¬¡ï¼Œæµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010190.png"></p><p>å›åˆ°GitHub-issuesï¼Œå¯ä»¥å‘ç°å¤šäº†åˆšåˆšæ·»åŠ çš„å›å¤ï¼Œä½†å¾ˆæ˜æ˜¾æ²¡æœ‰ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„labelï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010191.png"></p><p>æ£€æŸ¥ä»¥ä¸Šæ­¥éª¤ï¼Œå‘ç° <code>utterances.swig</code> ç²˜è´´copyçš„ä»£ç æ—¶ï¼Œå½“æ—¶é¡µé¢æœªå¡«å†™labelï¼Œè¡¥å……å®Œæ•´ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">label</span>=<span class="string">&quot;ğŸ’¬Comments&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>æ›´æ–°åšå®¢ï¼Œå¹¶å†æ¬¡è¯„è®ºï¼Œç„¶åç¡®è®¤æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„labelï¼Œç»“æœå¦‚ä¸‹ï¼Œä¿®æ”¹æˆåŠŸï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010192.png"></p><p>2019å¹´8æœˆ1æ—¥æ›´æ–°çš„NexT 7.3.0 ç‰ˆæœ¬é›†æˆäº†utterancesè¯„è®º</p><p>ä½¿ç”¨å‘½ä»¤å®‰è£…ï¼š<code>npm install theme-next/hexo-next-utteranc</code></p><p>é…ç½®éƒ¨åˆ†å’Œä¹‹å‰ç±»ä¼¼ï¼Œ<a href="http://chaih.com/2021/02/04/utterances-comment-for-Hexo-theme-nexT/">ä½¿ç”¨Hexo theme nexTå¹¶åŠ å…¥utterances comment</a>ã€‚</p><h4 id="ï¼ˆ2ï¼‰gitalk"><a href="#ï¼ˆ2ï¼‰gitalk" class="headerlink" title="ï¼ˆ2ï¼‰gitalk"></a>ï¼ˆ2ï¼‰gitalk</h4><p><a href="https://www.cnblogs.com/qisi007/p/13731562.html">hexoåšå®¢æ·»åŠ gitalkè¯„è®ºç³»ç»Ÿ</a></p><h3 id="4-6-æ–‡ç« è¯„åˆ†"><a href="#4-6-æ–‡ç« è¯„åˆ†" class="headerlink" title="4.6 æ–‡ç« è¯„åˆ†"></a>4.6 æ–‡ç« è¯„åˆ†</h3><p><a href="https://widgetpack.com/">widgetpack</a> æ˜¯ä¸€æ¬¾è½»é‡çº§çš„æ’ä»¶ï¼Œæä¾›å››é¡¹å…·ä½“çš„åŠŸèƒ½ï¼š</p><ul><li>Comments: è¯„è®ºç³»ç»Ÿï¼Œç±»ä¼¼äºç•™è¨€æ¿</li><li>Reviews: è¯„ä»·ç³»ç»Ÿï¼Œç±»ä¼¼äºå•†å“è¯„ä»·</li><li>Rating: æ˜Ÿçº§è¯„åˆ†ç³»ç»Ÿ</li><li>Google Reviews: å…³è”å±•ç¤º Google Rating</li></ul><p>Next ä¸»é¢˜ä¸­å·²ç»é›†æˆäº† widgetpack çš„æ˜Ÿçº§è¯„åˆ†ç³»ç»Ÿï¼Œç”¨æˆ·æ— é¡»å†å®‰è£…æˆ–å¼•å…¥æ’ä»¶è„šæœ¬ï¼Œåªéœ€åœ¨ widgetpack ä¸­æ³¨å†Œè´¦å·å¹¶ä¿®æ”¹ä¸»é¢˜é…ç½®å³å¯ï¼Œåº”ç”¨æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rating.png" alt="æ–‡ç« è¯„åˆ†ç»„ä»¶"></p><p>åœ¨ <a href="https://widgetpack.com/">widgetpack</a> ä¸­æ³¨å†Œè´¦å·ï¼Œæ ¹æ®å¼•å¯¼å¡«å†™åº”ç”¨åç§°å’ŒåŸŸååˆ›å»ºåº”ç”¨ï¼Œåˆ›å»ºåå¯åœ¨é¡µé¢å·¦ä¸Šè§’çœ‹åˆ°åº”ç”¨ idã€‚</p><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>themes\next_config.yml</code> ä¸­å¼€å¯è¯„åˆ†åŠŸèƒ½ï¼Œå¡«å†™åº”ç”¨ idï¼Œå¹¶è®¾ç½®è¯„åˆ†é¢œè‰²ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Star rating support to each article.</span></span><br><span class="line"><span class="comment"># To get your ID visit https://widgetpack.com</span></span><br><span class="line"><span class="attr">rating:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">id:</span> <span class="comment">#&lt;app_id&gt;</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">fadb14</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åˆ·æ–°æµè§ˆå™¨å³å¯åœ¨æ–‡ç« æœ«å°¾çœ‹åˆ°ç©ºçš„è¯„åˆ†æ äº†ã€‚ç‚¹å‡»è¯„åˆ†å‘ç°éœ€è¦ä»¥ç¤¾äº¤è´¦å·ç™»é™†ï¼Œè€Œè¿™äº›ç¤¾äº¤è´¦å·åŸºæœ¬éƒ½æ˜¯ facebookã€twitter ç­‰å¢™å¤–çš„ç¤¾äº¤è½¯ä»¶ï¼Œé™åˆ¶äº†è¯„åˆ†ç³»ç»Ÿå¯ç”¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ widgetpack æ§åˆ¶å°ä¸­ä¿®æ”¹è¯„åˆ†è®¤è¯æœºåˆ¶ã€‚</p><p>åœ¨æ§åˆ¶å°ä¸­ç‚¹å‡»å·¦ä¸Šè§’å±•å¼€èœå•ï¼Œåœ¨ <strong>Rating</strong> -&gt; <strong>Setting</strong> ä¸­å°† Vote via é€‰é¡¹æ”¹ä¸º Device(cookie) ä»¥å¼€å¯åŒ¿åè¯„åˆ†ï¼Œè¯¥é€‰é¡¹å°†åŸºäºè®¾å¤‡è®¤è¯è®¿é—®è€…èº«ä»½ï¼š</p><p><a href="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png"><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png" alt="å¼€å¯åŒ¿åè¯„åˆ†"></a></p><p>ç”¨æˆ·è¿˜å¯ä»¥åœ¨è¯¥é¡µé¢è®¾å®š star æ•°é‡å’Œå¤§å°ã€‚ä¿®æ”¹åè®°å¾—å‹¾é€‰å³ä¸‹è§’çš„ SAVE SETTING æ‰ä¼šç”Ÿæ•ˆã€‚</p><p>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¹¶éæ¯ç¯‡æ–‡ç« éƒ½éœ€è¦å¼€å¯è¯„åˆ†ã€‚æ­¤æ—¶å¯åœ¨ Front-Matter ä¸­è®¾å®šå˜é‡ rating ç”¨äºæ§åˆ¶æ˜¯å¦å¼€å¯è¯„åˆ†ã€‚ä¿®æ”¹æ–‡ç« å¸ƒå±€æ¨¡æ¿ä¸­ç›¸å…³ä»£ç ï¼Œä½¿å¾—åªæœ‰å½“ä¸»é¢˜é…ç½®æ–‡ä»¶ <code>themes\next\layout_macro\post.swig</code> ä¸­ <code>rating.enable</code> å­—æ®µå’Œ <code>page.rating</code> å­—æ®µåŒæ—¶ä¸º <code>true</code> æ‰ä¼šæ’å…¥è¯„åˆ†ç»„ä»¶ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">-  &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">+  &#123;% if (theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> and post<span class="selector-class">.rating</span>) or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;post-widgets&quot;&gt;</span><br><span class="line">    &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> %&#125;</span><br><span class="line">      &lt;<span class="selector-tag">div</span> class=&quot;wp_rating&quot;&gt;</span><br><span class="line">        &lt;<span class="selector-tag">div</span> id=&quot;wpac-rating&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">      &lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ‰¹é‡ä¸ºæ¯ç¯‡æ–°æ–‡ç« è®¾å®šè¯¥å˜é‡å¹¶èµ‹é»˜è®¤å€¼ï¼Œå¯ä»¥ä¿®æ”¹è‰ç¨¿æ¨¡æ¿å†…å®¹ <code>scaffolds\draft.md</code> ï¼Œè¿™æ ·ä»¥æ¥æ¯ç¯‡è‰ç¨¿å‘å¸ƒåéƒ½ä¼šé»˜è®¤å¼€å¯è¯„åˆ†ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="bullet">+</span> rating: true</span><br></pre></td></tr></table></figure><p>ç«™ç‚¹ä¸Šçº¿åï¼Œå¯ä»¥åœ¨æ§åˆ¶å°èœå•çš„ <strong>Site</strong> -&gt; <strong>Setting</strong> ä¸­å‹¾é€‰ Privateï¼Œä½¿å¾—ç»„ä»¶åªå¯¹åº”ç”¨å†…æŒ‡å®šçš„åŸŸåä¸Šç”Ÿæ•ˆï¼Œè¿™æ ·ä»¥æ¥å³æ—¶åˆ«äººé”™å¡«äº†ä½ çš„ id ä¹Ÿä¸ä¼šå°†è¯„åˆ†æ•°æ®è¯¯æäº¤åˆ°ä½ çš„åº”ç”¨ä¸­äº†ã€‚</p><p>widgetpack ä¸å‰æ–‡æåˆ°çš„ hotjar åœ¨è¯„ä»·åé¦ˆåŠŸèƒ½ä¸Šçš„ä¾§é‡ç‚¹ä¸ä¸€æ ·ï¼Œwidgetpack æ›´ä¾§é‡äºå¯¹æ–‡ç« çš„è¯„åˆ†ï¼Œè€Œ hotjar ä¾§é‡äºå¯¹æ•´ä¸ªé¡µé¢çš„è¯„åˆ†ï¼Œå¹¶æä¾›äº†æ–‡å­—å’Œæˆªå›¾åé¦ˆçš„æ¸ é“ã€‚</p><h3 id="4-7-åšæ–‡åŠ å¯†"><a href="#4-7-åšæ–‡åŠ å¯†" class="headerlink" title="4.7 åšæ–‡åŠ å¯†"></a>4.7 åšæ–‡åŠ å¯†</h3><p>é¦–å…ˆå®‰è£…æ’ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-blog-encrypt</span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆ–</span> </span><br><span class="line">yarn add hexo-blog-encrypt</span><br></pre></td></tr></table></figure><p>MDæ–‡ä»¶ä¿¡æ¯å¤´ä¸­æ·»åŠ passwordï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password: &lt;å¯†ç &gt; # ä¸ºç©ºè¡¨ç¤ºæ— å¯†ç </span><br></pre></td></tr></table></figure><p>æ ‡å‡†å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line">tags:</span><br><span class="line"><span class="bullet">-</span> ä½œä¸ºæ—¥è®°åŠ å¯†</span><br><span class="line">date: 2016-03-30 21:12:21</span><br><span class="line">password: mikemessi</span><br><span class="line">abstract: æœ‰ä¸œè¥¿è¢«åŠ å¯†äº†, è¯·è¾“å…¥å¯†ç æŸ¥çœ‹.</span><br><span class="line">message: æ‚¨å¥½, è¿™é‡Œéœ€è¦å¯†ç .</span><br><span class="line">wrong<span class="emphasis">_pass_</span>message: æŠ±æ­‰, è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹, è¯·å†è¯•è¯•.</span><br><span class="line"><span class="section">wrong<span class="emphasis">_hash_</span>message: æŠ±æ­‰, è¿™ä¸ªæ–‡ç« ä¸èƒ½è¢«æ ¡éªŒ, ä¸è¿‡æ‚¨è¿˜æ˜¯èƒ½çœ‹çœ‹è§£å¯†åçš„å†…å®¹.</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­ç»Ÿä¸€è®¾ç½® <code>blog/_config.yml</code> ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Security</span></span><br><span class="line"><span class="attr">encrypt:</span> <span class="comment"># hexo-blog-encrypt</span></span><br><span class="line">  <span class="attr">abstract:</span> <span class="string">è¿™ç¯‡æ–‡ç« è¢«åŠ å¯†äº†,</span> <span class="string">è¯·è¾“å…¥å¯†ç æŸ¥çœ‹.</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">æ‚¨å¥½,</span> <span class="string">è¿™é‡Œéœ€è¦å¯†ç .</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">å¯†ç A</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">å¯†ç B</span>&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;div</span> <span class="string">id=&quot;hexo-blog-encrypt&quot;</span> <span class="string">data-wpm=&quot;&#123;&#123;hbeWrongPassMessage&#125;&#125;&quot;</span> <span class="string">data-whm=&quot;&#123;&#123;hbeWrongHashMessage&#125;&#125;&quot;&gt;&lt;div</span> <span class="string">class=&quot;hbe-input-container&quot;&gt;&lt;input</span> <span class="string">type=&quot;password&quot;</span> <span class="string">id=&quot;hbePass&quot;</span> <span class="string">placeholder=&quot;&#123;&#123;hbeMessage&#125;&#125;&quot;</span> <span class="string">/&gt;&lt;label&gt;&#123;&#123;hbeMessage&#125;&#125;&lt;/label&gt;&lt;div</span> <span class="string">class=&quot;bottom-line&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;script</span> <span class="string">id=&quot;hbeData&quot;</span> <span class="string">type=&quot;hbeData&quot;</span> <span class="string">data-hmacdigest=&quot;&#123;&#123;hbeHmacDigest&#125;&#125;&quot;&gt;&#123;&#123;hbeEncryptedData&#125;&#125;&lt;/script&gt;&lt;/div&gt;</span></span><br><span class="line">  <span class="attr">wrong_pass_message:</span> <span class="string">æŠ±æ­‰,</span> <span class="string">è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹,</span> <span class="string">è¯·å†è¯•è¯•.</span></span><br><span class="line">  <span class="attr">wrong_hash_message:</span> <span class="string">æŠ±æ­‰,</span> <span class="string">è¿™ä¸ªæ–‡ç« ä¸èƒ½è¢«æ ¡éªŒ,</span> <span class="string">ä¸è¿‡æ‚¨è¿˜æ˜¯èƒ½çœ‹çœ‹è§£å¯†åçš„å†…å®¹.</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">default_abstract:</span> <span class="string">æ­¤æ–‡ç« å·²è¢«åŠ å¯†ï¼Œéœ€è¦è¾“å…¥å¯†ç è®¿é—®ã€‚</span>  <span class="string">//é¦–é¡µæ–‡ç« åˆ—è¡¨ä¸­åŠ å¯†æ–‡ç« çš„é»˜è®¤æè¿°æ–‡æ¡ˆ</span></span><br><span class="line">  <span class="attr">default_message:</span> <span class="string">è¯·è¾“å…¥å¯†ç ä»¥é˜…è¯»è¿™ç¯‡ç§å¯†æ–‡ç« ã€‚</span>  <span class="string">//æ–‡ç« è¯¦æƒ…é¡µçš„å¯†ç è¾“å…¥æ¡†ä¸Šçš„é»˜è®¤æè¿°æ–‡æ¡ˆ</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ–‡ç«  Front-Matter ä¸­æ·»åŠ  <code>password</code> å­—æ®µç”¨äºè®¾ç½®æ–‡ç« è®¿é—®å¯†ç ã€‚é‡å¯æœåŠ¡å™¨ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½éœ€è¦ç»å†è¾ƒé•¿ä¸€æ®µæ—¶é—´çš„åŠ å¯†è¿‡ç¨‹ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ŒåŠ å¯†å®Œæˆååˆ·æ–°é¡µé¢å°†ä¼šæ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†ï¼Œè¾“å…¥å¯†ç åæ‰èƒ½ç»§ç»­è®¿é—®æ–‡ç« å†…å®¹ã€‚</p><p>è¯¥åŠŸèƒ½åªä¼šåŠ å¯†æ–‡ç« æ­£æ–‡ï¼Œå…¶ä»–å†…å®¹å¦‚æ‰“èµã€ç‰ˆæƒä¿¡æ¯ã€æ ‡ç­¾ç­‰åˆ™ä¸ä¼šè¢«åŠ å¯†éšè—ï¼Œè¿™æ ·çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œæ‰€ä»¥å»ºè®®åŠ å¯†æ–‡ç« éšè—æ‰æ‰“èµå’Œç‰ˆæƒä¿¡æ¯å†…å®¹ã€‚</p><p>å¯†ç è¾“å…¥é”™è¯¯æ—¶å°†ä¼šæ˜¾ç¤ºæµè§ˆå™¨é»˜è®¤å‘Šè­¦å¼¹çª—ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://sweetalert.js.org/">sweetalert</a> æ¥ç¾åŒ–é”™è¯¯æç¤ºã€‚åœ¨ä¸»é¢˜è‡ªå®šä¹‰å¸ƒå±€æ–‡ä»¶ <code>themes\next\layout_custom\custom.swig</code> ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/sweetalert/dist/sweetalert.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>custom.swig</code> æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨æ–°å»ºå¹¶åœ¨å¸ƒå±€é¡µé¢ <code>themes\next\layout_layout.swig</code> ä¸­ body æœ«å°¾å¼•å…¥ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      ...</span><br><span class="line">      &#123;% include &#x27;_third-party/exturl.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/bookmark.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/copy-code.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+     &#123;% include &#x27;_custom/custom.swig&#x27; %&#125;</span></span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>node_modules</code> ä¾èµ–åº“ <code>node_modules\hexo-blog-encrypt\lib\blog.encrypt.js</code> ä¸­ä¿®æ”¹ <code>hexo-blog-encrypt</code> æºç ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line"><span class="deletion">-   alert(decryptionError);</span></span><br><span class="line"><span class="addition">+   swal(&#123;</span></span><br><span class="line"><span class="addition">+     text: &quot;å¯†ç é”™è¯¯!&quot;,</span></span><br><span class="line"><span class="addition">+     icon: &quot;error&quot;,</span></span><br><span class="line"><span class="addition">+     className: &quot;password-error&quot;,</span></span><br><span class="line"><span class="addition">+     timer: 1000,</span></span><br><span class="line"><span class="addition">+     button: false</span></span><br><span class="line"><span class="addition">+   &#125;);</span></span><br><span class="line">    console.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>åœ¨è‡ªå®šä¹‰æ ·å¼æ–‡ä»¶ <code>themes/next/source/css/_custom/custom.styl</code> ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//å¯†ç é”™è¯¯sweetalertå¼¹æ¡†æ ·å¼ä¿®æ”¹</span><br><span class="line"><span class="selector-class">.swal-overlay</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.password-error</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">4px</span> <span class="number">12px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.15</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯åœ¨ <code>node_module</code> ä¸­ä¿®æ”¹çš„ä¾èµ–æ–‡ä»¶ï¼Œä¸€æ—¦æ›´æ–°æˆ–è€…é‡è£…ä¾èµ–éƒ½ä¼šè¦†ç›–ä¿®æ”¹ï¼Œéœ€è¦é‡æ–°ä¿®æ”¹ä¸€é</p><h3 id="4-8-æ·»åŠ -Google-Analytics-ç›‘æ§-GitHub-Pages-è®¿é—®æµé‡"><a href="#4-8-æ·»åŠ -Google-Analytics-ç›‘æ§-GitHub-Pages-è®¿é—®æµé‡" class="headerlink" title="4.8 æ·»åŠ  Google Analytics ç›‘æ§ GitHub Pages è®¿é—®æµé‡"></a>4.8 æ·»åŠ  Google Analytics ç›‘æ§ GitHub Pages è®¿é—®æµé‡</h3><p>åœ¨è°·æ­Œçš„<a href="https://analytics.google.com/">Google Analytics</a>ä¸­æ³¨å†Œä¸ªäººè´¦æˆ·ï¼Œé…ç½®ç½‘ç«™ä¿¡æ¯è·å¾—è¡¡é‡IDï¼ˆæˆ–è€…ä½¿ç”¨ç™¾åº¦ç»Ÿè®¡ï¼‰ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201201/202012280109.png"></p><p>åœ¨åšå®¢ç›®å½•ä¸»é¢˜ä¸‹çš„ <code>_config.yml</code> ä¸­é…ç½®ï¼ˆæ³¨æ„éæ ¹ç›®å½•ï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google Analytics</span></span><br><span class="line"><span class="attr">google_analytics:</span></span><br><span class="line">  <span class="attr">tracking_id:</span> <span class="string">XXX</span></span><br><span class="line">  <span class="attr">localhost_ignored:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">baidu_analytics:</span> <span class="string">XXXï¼ˆ&quot;https://hm.baidu.com/hm.js?____________________&quot;ï¼‰</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>\themes\next\layout\_third-party\analytics\google-analytics.swig</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> theme.google_analytics.tracking_id %&#125;</span><br><span class="line">  &lt;script <span class="keyword">async</span> src=<span class="string">&quot;https://www.googletagmanager.com/gtag/js?id=&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">var</span> host = <span class="built_in">window</span>.location.hostname;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">if</span> (host !== <span class="string">&quot;localhost&quot;</span> || !&#123;&#123;theme.google_analytics.localhost_ignored&#125;&#125;) &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="built_in">window</span>.dataLayer = <span class="built_in">window</span>.dataLayer || [];</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="function"><span class="keyword">function</span> <span class="title">gtag</span>(<span class="params"></span>)</span>&#123;dataLayer.push(<span class="built_in">arguments</span>);&#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;js&#x27;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&#x27;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h3 id="4-9-éŸ³ä¹æ’­æ”¾å™¨"><a href="#4-9-éŸ³ä¹æ’­æ”¾å™¨" class="headerlink" title="4.9 éŸ³ä¹æ’­æ”¾å™¨"></a>4.9 éŸ³ä¹æ’­æ”¾å™¨</h3><p>éŸ³ä¹æ’­æ”¾å™¨ä½¿ç”¨ï¼š<a href="https://github.com/grzhan/hexo-tag-aplayer">hexo-tag-aplayer</a></p><p>å†…å®¹æ¥è‡ªå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">MetingJS</a></p><h4 id="ï¼ˆ1ï¼‰APlayer"><a href="#ï¼ˆ1ï¼‰APlayer" class="headerlink" title="ï¼ˆ1ï¼‰APlayer"></a>ï¼ˆ1ï¼‰APlayer</h4><p>å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-tag-aplayer</span><br></pre></td></tr></table></figure><p>ä¾èµ–ç‰ˆæœ¬ï¼š</p><ul><li>APlayer.js &gt; 1.8.0</li><li>Meting.js &gt; 1.1.1</li></ul><p>Markdownæ–‡æ¡£ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer title author url [picture<span class="emphasis">_url, narrow, autoplay, width:xxx, lrc:xxx] %&#125;</span></span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li><code>title</code> : æ›²ç›®æ ‡é¢˜</li><li><code>author</code>: æ›²ç›®ä½œè€…</li><li><code>url</code>: éŸ³ä¹æ–‡ä»¶ URL åœ°å€</li><li><code>picture_url</code>: (å¯é€‰) éŸ³ä¹å¯¹åº”çš„å›¾ç‰‡åœ°å€</li><li><code>narrow</code>: ï¼ˆå¯é€‰ï¼‰æ’­æ”¾å™¨è¢–çé£æ ¼</li><li><code>autoplay</code>: (å¯é€‰) è‡ªåŠ¨æ’­æ”¾ï¼Œç§»åŠ¨ç«¯æµè§ˆå™¨æš‚æ—¶ä¸æ”¯æŒæ­¤åŠŸèƒ½</li><li><code>width:xxx</code>: (å¯é€‰) æ’­æ”¾å™¨å®½åº¦ (é»˜è®¤: 100%)</li><li><code>lrc:xxx</code>: ï¼ˆå¯é€‰ï¼‰æ­Œè¯æ–‡ä»¶ URL åœ°å€</li></ul><p>å½“å¼€å¯ Hexo çš„ <a href="https://hexo.io/zh-cn/docs/asset-folders.html#%E6%96%87%E7%AB%A0%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%A4%B9">æ–‡ç« èµ„æºæ–‡ä»¶å¤¹</a> åŠŸèƒ½æ—¶ï¼Œå¯ä»¥å°†å›¾ç‰‡ã€éŸ³ä¹æ–‡ä»¶ã€æ­Œè¯æ–‡ä»¶æ”¾å…¥ä¸æ–‡ç« å¯¹åº”çš„èµ„æºæ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åç›´æ¥å¼•ç”¨ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer &quot;Caffeine&quot; &quot;Jeff Williams&quot; &quot;caffeine.mp3&quot; &quot;picture.jpg&quot; &quot;lrc:caffeine.txt&quot; %&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä½¿ç”¨æ ‡ç­¾ <code>lrc</code> é€‰é¡¹æ¥è®¾å®šæ­Œè¯ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>aplayerlrc</code> æ ‡ç­¾æ¥ç›´æ¥æ’å…¥æ­Œè¯æ–‡æœ¬åœ¨åšå®¢ä¸­ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlrc &quot;title&quot; &quot;author&quot; &quot;url&quot; &quot;autoplay&quot; %&#125;</span><br><span class="line">[00:00.00]lrc here</span><br><span class="line">&#123;% endaplayerlrc %&#125;</span><br></pre></td></tr></table></figure><p>æ’­æ”¾åˆ—è¡¨ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlist %&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;narrow&quot;</span>: <span class="literal">false</span>,                          <span class="comment">// ï¼ˆå¯é€‰ï¼‰æ’­æ”¾å™¨è¢–çé£æ ¼</span></span><br><span class="line">    <span class="attr">&quot;autoplay&quot;</span>: <span class="literal">true</span>,                         <span class="comment">// ï¼ˆå¯é€‰) è‡ªåŠ¨æ’­æ”¾ï¼Œç§»åŠ¨ç«¯æµè§ˆå™¨æš‚æ—¶ä¸æ”¯æŒæ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;random&quot;</span>,                         <span class="comment">// ï¼ˆå¯é€‰ï¼‰æ›²ç›®å¾ªç¯ç±»å‹ï¼Œæœ‰ &#x27;random&#x27;ï¼ˆéšæœºæ’­æ”¾ï¼‰, &#x27;single&#x27; (å•æ›²æ’­æ”¾), &#x27;circulation&#x27; (å¾ªç¯æ’­æ”¾), &#x27;order&#x27; (åˆ—è¡¨æ’­æ”¾)ï¼Œ é»˜è®¤ï¼š&#x27;circulation&#x27; </span></span><br><span class="line">    <span class="attr">&quot;showlrc&quot;</span>: <span class="number">3</span>,                             <span class="comment">// ï¼ˆå¯é€‰ï¼‰æ­Œè¯æ˜¾ç¤ºé…ç½®é¡¹ï¼Œå¯é€‰é¡¹æœ‰ï¼š1,2,3</span></span><br><span class="line">    <span class="attr">&quot;mutex&quot;</span>: <span class="literal">true</span>,                            <span class="comment">// ï¼ˆå¯é€‰ï¼‰è¯¥é€‰é¡¹å¼€å¯æ—¶ï¼Œå¦‚æœåŒé¡µé¢æœ‰å…¶ä»– aplayer æ’­æ”¾ï¼Œè¯¥æ’­æ”¾å™¨ä¼šæš‚åœ</span></span><br><span class="line">    <span class="attr">&quot;theme&quot;</span>: <span class="string">&quot;#e6d0b2&quot;</span>,                      <span class="comment">// ï¼ˆå¯é€‰ï¼‰æ’­æ”¾å™¨é£æ ¼è‰²å½©è®¾ç½®ï¼Œé»˜è®¤ï¼š#b7daff</span></span><br><span class="line">    <span class="attr">&quot;preload&quot;</span>: <span class="string">&quot;metadata&quot;</span>,                    <span class="comment">// ï¼ˆå¯é€‰ï¼‰éŸ³ä¹æ–‡ä»¶é¢„è½½å…¥æ¨¡å¼ï¼Œå¯é€‰é¡¹ï¼š &#x27;none&#x27; &#x27;metadata&#x27; &#x27;auto&#x27;, é»˜è®¤: &#x27;auto&#x27;</span></span><br><span class="line">    <span class="attr">&quot;listmaxheight&quot;</span>: <span class="string">&quot;513px&quot;</span>,                 <span class="comment">// (å¯é€‰) è¯¥æ’­æ”¾åˆ—è¡¨çš„æœ€å¤§é•¿åº¦</span></span><br><span class="line">    <span class="attr">&quot;music&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;CoCo&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Jeff Williams&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;caffeine.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;caffeine.jpeg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lrc&quot;</span>: <span class="string">&quot;caffeine.txt&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;ã‚¢ã‚¤ãƒ­ãƒ‹&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;é¹¿ä¹ƒ&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;irony.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;irony.jpg&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endaplayerlist %&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰MeingJS-æ”¯æŒ-3-0-æ–°åŠŸèƒ½"><a href="#ï¼ˆ2ï¼‰MeingJS-æ”¯æŒ-3-0-æ–°åŠŸèƒ½" class="headerlink" title="ï¼ˆ2ï¼‰MeingJS æ”¯æŒ (3.0 æ–°åŠŸèƒ½)"></a>ï¼ˆ2ï¼‰MeingJS æ”¯æŒ (3.0 æ–°åŠŸèƒ½)</h4><p><a href="https://github.com/metowolf/MetingJS">MetingJS</a> æ˜¯åŸºäº<a href="https://github.com/metowolf/Meting">Meting API</a> çš„ APlayer è¡ç”Ÿæ’­æ”¾å™¨ï¼Œå¼•å…¥ MetingJS åï¼Œæ’­æ”¾å™¨å°†æ”¯æŒå¯¹äº QQéŸ³ä¹ã€ç½‘æ˜“äº‘éŸ³ä¹ã€è™¾ç±³ã€é…·ç‹—ã€ç™¾åº¦ç­‰å¹³å°çš„éŸ³ä¹æ’­æ”¾ã€‚</p><p>å¦‚æœæƒ³åœ¨æœ¬æ’ä»¶ä¸­ä½¿ç”¨ MetingJSï¼Œè¯·åœ¨ Hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­è®¾ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>æ¥ç€å°±å¯ä»¥é€šè¿‡ <code>&#123;% meting ...%&#125;</code> åœ¨æ–‡ç« ä¸­ä½¿ç”¨ MetingJS æ’­æ”¾å™¨äº†ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ç®€å•ç¤ºä¾‹ (id, server, type)  --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- è¿›é˜¶ç¤ºä¾‹ --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; &quot;autoplay&quot; &quot;mutex:false<span class="string">&quot; &quot;</span>listmaxheight:<span class="number">340px</span><span class="string">&quot; &quot;</span>preload:none<span class="string">&quot; &quot;</span>theme:<span class="number">#ad7a86</span><span class="string">&quot;%&#125;</span></span><br></pre></td></tr></table></figure><p>æœ‰å…³ <code>&#123;% meting %&#125;</code> çš„é€‰é¡¹åˆ—è¡¨å¦‚ä¸‹ï¼š</p><table><thead><tr><th>é€‰é¡¹</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>id</td><td><strong>å¿…é¡»å€¼</strong></td><td>æ­Œæ›² id / æ’­æ”¾åˆ—è¡¨ id / ç›¸å†Œ id / æœç´¢å…³é”®å­—</td></tr><tr><td>server</td><td><strong>å¿…é¡»å€¼</strong></td><td>éŸ³ä¹å¹³å°: <code>netease</code>, <code>tencent</code>, <code>kugou</code>, <code>xiami</code>, <code>baidu</code></td></tr><tr><td>type</td><td><strong>å¿…é¡»å€¼</strong></td><td><code>song</code>, <code>playlist</code>, <code>album</code>, <code>search</code>, <code>artist</code></td></tr><tr><td>fixed</td><td><code>false</code></td><td>å¼€å¯å›ºå®šæ¨¡å¼</td></tr><tr><td>mini</td><td><code>false</code></td><td>å¼€å¯è¿·ä½ æ¨¡å¼</td></tr><tr><td>loop</td><td><code>all</code></td><td>åˆ—è¡¨å¾ªç¯æ¨¡å¼ï¼š<code>all</code>, <code>one</code>,<code>none</code></td></tr><tr><td>order</td><td><code>list</code></td><td>åˆ—è¡¨æ’­æ”¾æ¨¡å¼ï¼š <code>list</code>, <code>random</code></td></tr><tr><td>volume</td><td>0.7</td><td>æ’­æ”¾å™¨éŸ³é‡</td></tr><tr><td>lrctype</td><td>0</td><td>æ­Œè¯æ ¼å¼ç±»å‹</td></tr><tr><td>listfolded</td><td><code>false</code></td><td>æŒ‡å®šéŸ³ä¹æ’­æ”¾åˆ—è¡¨æ˜¯å¦æŠ˜å </td></tr><tr><td>storagename</td><td><code>metingjs</code></td><td>LocalStorage ä¸­å­˜å‚¨æ’­æ”¾å™¨è®¾å®šçš„é”®å</td></tr><tr><td>autoplay</td><td><code>true</code></td><td>è‡ªåŠ¨æ’­æ”¾ï¼Œç§»åŠ¨ç«¯æµè§ˆå™¨æš‚æ—¶ä¸æ”¯æŒæ­¤åŠŸèƒ½</td></tr><tr><td>mutex</td><td><code>true</code></td><td>è¯¥é€‰é¡¹å¼€å¯æ—¶ï¼Œå¦‚æœåŒé¡µé¢æœ‰å…¶ä»– aplayer æ’­æ”¾ï¼Œè¯¥æ’­æ”¾å™¨ä¼šæš‚åœ</td></tr><tr><td>listmaxheight</td><td><code>340px</code></td><td>æ’­æ”¾åˆ—è¡¨çš„æœ€å¤§é•¿åº¦</td></tr><tr><td>preload</td><td><code>auto</code></td><td>éŸ³ä¹æ–‡ä»¶é¢„è½½å…¥æ¨¡å¼ï¼Œå¯é€‰é¡¹ï¼š <code>none</code>, <code>metadata</code>, <code>auto</code></td></tr><tr><td>theme</td><td><code>#ad7a86</code></td><td>æ’­æ”¾å™¨é£æ ¼è‰²å½©è®¾ç½®</td></tr></tbody></table><p>å…³äºå¦‚ä½•è®¾ç½®è‡ªå»ºçš„ Meting API æœåŠ¡å™¨åœ°å€ï¼Œä»¥åŠå…¶ä»– MetingJS é…ç½®ï¼Œè¯·å‚è€ƒç« èŠ‚<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE30-%E6%96%B0%E5%8A%9F%E8%83%BD">è‡ªå®šä¹‰é…ç½®</a>ã€‚</p><p>è‹¥åœ¨ Hexo ä¸­ä½¿ç”¨äº† PJAXï¼Œå¯èƒ½éœ€è¦è‡ªå·±æ‰‹åŠ¨æ¸…ç† APlayer å…¨å±€å®ä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">&#x27;pjax:start&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.aplayers) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">window</span>.aplayers.length; i++) &#123;</span><br><span class="line">            <span class="built_in">window</span>.aplayers[i].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">window</span>.aplayers = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ3ï¼‰è‡ªå®šä¹‰é…ç½®ï¼ˆ3-0-æ–°åŠŸèƒ½ï¼‰"><a href="#ï¼ˆ3ï¼‰è‡ªå®šä¹‰é…ç½®ï¼ˆ3-0-æ–°åŠŸèƒ½ï¼‰" class="headerlink" title="ï¼ˆ3ï¼‰è‡ªå®šä¹‰é…ç½®ï¼ˆ3.0 æ–°åŠŸèƒ½ï¼‰"></a>ï¼ˆ3ï¼‰è‡ªå®šä¹‰é…ç½®ï¼ˆ3.0 æ–°åŠŸèƒ½ï¼‰</h4><p>ç°åœ¨ä½ å¯ä»¥åœ¨ Hexo é…ç½®æ–‡ä»¶ <code>_config.yml</code> ä¸­é…ç½®æœ¬æ’ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">script_dir:</span> <span class="string">some/place</span>                        <span class="comment"># Public ç›®å½•ä¸‹è„šæœ¬ç›®å½•è·¯å¾„ï¼Œé»˜è®¤: &#x27;assets/js&#x27;</span></span><br><span class="line">  <span class="attr">style_dir:</span> <span class="string">some/place</span>                         <span class="comment"># Public ç›®å½•ä¸‹æ ·å¼ç›®å½•è·¯å¾„ï¼Œé»˜è®¤: &#x27;assets/css&#x27;</span></span><br><span class="line">  <span class="attr">cdn:</span> <span class="string">http://xxx/aplayer.min.js</span>                <span class="comment"># å¼•ç”¨ APlayer.js å¤–éƒ¨ CDN åœ°å€ (é»˜è®¤ä¸å¼€å¯)</span></span><br><span class="line">  <span class="attr">style_cdn:</span> <span class="string">http://xxx/aplayer.min.css</span>         <span class="comment"># å¼•ç”¨ APlayer.css å¤–éƒ¨ CDN åœ°å€ (é»˜è®¤ä¸å¼€å¯)</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span>                                  <span class="comment"># MetingJS æ”¯æŒ</span></span><br><span class="line">  <span class="attr">meting_api:</span> <span class="string">http://xxx/api.php</span>                <span class="comment"># è‡ªå®šä¹‰ Meting API åœ°å€</span></span><br><span class="line">  <span class="attr">meting_cdn:</span> <span class="string">http://xxx/Meing.min.js</span>           <span class="comment"># å¼•ç”¨ Meting.js å¤–éƒ¨ CDN åœ°å€ (é»˜è®¤ä¸å¼€å¯)</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">true</span>                            <span class="comment"># è‡ªåŠ¨æ’å…¥ Aplayer.js ä¸ Meting.js èµ„æºè„šæœ¬, é»˜è®¤å¼€å¯</span></span><br><span class="line">  <span class="attr">externalLink:</span> <span class="string">http://xxx/aplayer.min.js</span>       <span class="comment"># è€ç‰ˆæœ¬å‚æ•°ï¼ŒåŠŸèƒ½ä¸å‚æ•° cdn ç›¸åŒ</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ4ï¼‰æ•…éšœæ’é™¤"><a href="#ï¼ˆ4ï¼‰æ•…éšœæ’é™¤" class="headerlink" title="ï¼ˆ4ï¼‰æ•…éšœæ’é™¤"></a>ï¼ˆ4ï¼‰æ•…éšœæ’é™¤</h4><h5 id="1-æ ‡ç­¾å‚æ•°ç©ºæ ¼é—®é¢˜"><a href="#1-æ ‡ç­¾å‚æ•°ç©ºæ ¼é—®é¢˜" class="headerlink" title="1. æ ‡ç­¾å‚æ•°ç©ºæ ¼é—®é¢˜"></a>1. æ ‡ç­¾å‚æ•°ç©ºæ ¼é—®é¢˜</h5><p>åœ¨ Hexo æ ‡ç­¾ä¸­ï¼Œç”¨æˆ·å¯èƒ½æ— æ³•ç›´æ¥åœ¨æ ‡ç­¾å‚æ•°ä¸­<a href="https://github.com/hexojs/hexo/issues/1455">åŠ å…¥ç©ºæ ¼</a></p><p>å¦‚æœé‡åˆ°è¿™ç±»é—®é¢˜ï¼Œè¯·ç›´æ¥å°†å‚æ•°ç”¨åŒå¼•å·æ‹¬èµ·æ¥ä½¿ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="meta">%</span> aplayer <span class="string">&quot;Caffeine&quot;</span> <span class="string">&quot;Jeff Williams&quot;</span> <span class="string">&quot;caffeine.mp3&quot;</span> <span class="string">&quot;autoplay&quot;</span> <span class="string">&quot;width:70%&quot;</span> <span class="string">&quot;lrc:caffeine.txt&quot;</span> <span class="meta">%</span>&#125;</span><br></pre></td></tr></table></figure><h5 id="2-é‡å¤è½½å…¥-Aplayer-js-èµ„æºè„šæœ¬é—®é¢˜"><a href="#2-é‡å¤è½½å…¥-Aplayer-js-èµ„æºè„šæœ¬é—®é¢˜" class="headerlink" title="2. é‡å¤è½½å…¥ Aplayer.js èµ„æºè„šæœ¬é—®é¢˜"></a>2. é‡å¤è½½å…¥ Aplayer.js èµ„æºè„šæœ¬é—®é¢˜</h5><p>æœ¬æ’ä»¶é€šè¿‡ <code>after_render:html</code>è¿‡æ»¤å™¨ , å°† <code>APlayer.js</code> å’Œ <code>Meting.js</code> æ’å…¥åˆ°ä½¿ç”¨äº†æœ¬æ’ä»¶æ ‡ç­¾ çš„ HTML æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/aplayer.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/meting.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ <code>after_render:html</code> åœ¨ä¸€äº›æƒ…å½¢ä¸‹å¯èƒ½æ— æ³•è¢«æ­£å¸¸è§¦å‘ï¼š</p><ul><li><a href="https://github.com/hexojs/hexo-inject/issues/1">Does not work with hexo-renderer-jade</a></li><li><code>after_render:html</code> ä¼¼ä¹åœ¨ Hexo æœåŠ¡å™¨æ¨¡å¼é»˜è®¤é…ç½®ä¸­æ— æ³•è¢«è°ƒç”¨ (<code>hexo server</code>), é‡åˆ°è¿™ç§æƒ…å†µç”¨æˆ·å¯èƒ½éœ€è¦ä½¿ç”¨ <code>hexo-server</code> çš„é™æ€æ–‡ä»¶è§£ææ¨¡å¼ ( <code>hexo server -s</code>) .</li></ul><p>å¦‚æœåœ¨åšå®¢ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ’ä»¶å‘ç° <code>after_render:html</code> æ²¡æœ‰è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆæ’ä»¶å°†ä¼šé€šè¿‡ <code>after_post_render</code> è¿‡æ»¤å™¨æ¥æ¤å…¥è„šæœ¬ã€‚ä½†æ˜¯ä½¿ç”¨ <code>after_post_render</code> ä¼šæœ‰é‡å¤è½½å…¥ <code>APlayer.js</code> çš„æƒ…å†µï¼ˆä¾‹å¦‚å½“ä¸€ä¸ªé¡µé¢ä¸­å­˜åœ¨å¤šç¯‡åšå®¢æ—¶ï¼‰ï¼Œä»¥åŠä¸€äº›éæ–‡ç« é¡µé¢å°†æ— æ³•ä½¿ç”¨æœ¬æ’ä»¶ã€‚</p><p>å¦‚æœæƒ³å®Œå…¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦è‡ªå·±åœ¨ä¸»é¢˜æ–‡ä»¶ä¸­æ‰‹åŠ¨åŠ å…¥ <code>Aplayer.js</code> ä¸ <code>Meting.js</code>ï¼ŒåŒæ—¶å…³é—­æ’ä»¶çš„è‡ªåŠ¨è„šæœ¬æ’å…¥åŠŸèƒ½ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éŸ³ä¹æ’­æ”¾å™¨</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># è‡ªåŠ¨æ’å…¥ Aplayer.js ä¸ Meting.js èµ„æºè„šæœ¬, é»˜è®¤å¼€å¯</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="4-10-è§†é¢‘æ’­æ”¾å™¨"><a href="#4-10-è§†é¢‘æ’­æ”¾å™¨" class="headerlink" title="4.10 è§†é¢‘æ’­æ”¾å™¨"></a>4.10 è§†é¢‘æ’­æ”¾å™¨</h3><p><a href="https://github.com/NextMoe/hexo-tag-dplayer">hexo-tag-dplayer</a></p><h3 id="4-11-hexo-tag-mmedia"><a href="#4-11-hexo-tag-mmedia" class="headerlink" title="4.11 hexo-tag-mmedia"></a>4.11 hexo-tag-mmedia</h3><p>å› APlayerè‡ªåŠ¨å¼•å…¥JSä¾èµ–ä¼šå¯¼è‡´ä¸€äº›å…¨å±€æ–‡ä»¶å‡ºé”™ï¼Œé…ç½®å…³é—­åå•ä¸ªé¡µé¢å¼€å¯åˆå¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥å¯»æ‰¾æ›¿ä»£å·¥å…·ã€‚</p><p><code>hexo-tag-mmedia</code> é›†æˆäº†å¤šç§éŸ³è§†é¢‘æ’­æ”¾å™¨ï¼Œå¯ä»¥å‚è€ƒ <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmediaæ–‡æ¡£</a> ï¼Œç›®å‰æ”¯æŒï¼š</p><ul><li><input checked="" disabled="" type="checkbox"> Audio</li><li><input checked="" disabled="" type="checkbox"> Video</li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/APlayer">Aplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/metowolf/MetingJS">MetingJS</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/DPlayer">Dplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.bilibili.com/">å“”å“©å“”å“©</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.ixigua.com/">è¥¿ç“œè§†é¢‘</a></li><li><input disabled="" type="checkbox"> <a href="https://www.npmjs.com/package/hexo-tag-mmedia">YouTube</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/zhw2590582/ArtPlayer">ArtPlayer</a></li></ul><p>æ•ˆæœå‚è€ƒï¼š<a href="http://demo.hexo-tag-mmedia.u2sb.com/">DEMO</a></p><p>å®‰è£…æ’ä»¶ï¼š</p><ol><li><p>åˆ é™¤å·²å®‰è£…çš„å‡ ä¸ªæ’ä»¶ï¼Œä»¥é˜²å†²çªã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall hexo-tag-aplayer</span><br><span class="line">npm uninstall hexo-tag-dplayer</span><br><span class="line">npm uninstall hexo-tag-bilibili</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… <code>hexo-tag-mmedia</code> ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-mmedia@1 --save</span><br></pre></td></tr></table></figure></li></ol><p>æ ¹ç›®å½•é…ç½®æ–‡ä»¶ <code>/_config.yml</code> æ·»åŠ ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default ä¸ºé»˜è®¤é…ç½®ï¼Œåœ¨ _config.yml ä¸­å¡«å†™å°±ä¸éœ€è¦åœ¨æ¯ä¸ªæ ‡ç­¾å…¨éƒ¨å†™å…¥äº†ï¼Œæ‰€æœ‰å…è®¸åœ¨ mmedia æ ‡ç­¾ä¸Šå†™å…¥çš„é…ç½®é¡¹ï¼Œå‡å¯åœ¨ default ä¸‹é…ç½®ã€‚default ä¸‹ contents é¡¹ï¼Œç”¨äºè®¾ç½® JSON ç±»å‹çš„é»˜è®¤é…ç½®ï¼Œæ³¨æ„è¦ä½¿ç”¨ yaml æ ¼å¼å†™é»˜è®¤é…ç½®ã€‚</span></span><br><span class="line"><span class="attr">mmedia:</span></span><br><span class="line">  <span class="attr">audio:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">video:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">aplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js</span></span><br><span class="line">    <span class="attr">css:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">meting:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js</span></span><br><span class="line">    <span class="attr">api:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">dplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dplayer@1/dist/DPlayer.min.js</span></span><br><span class="line">    <span class="attr">hls_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js</span></span><br><span class="line">    <span class="attr">dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js</span></span><br><span class="line">    <span class="attr">shaka_dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.compiled.js</span></span><br><span class="line">    <span class="attr">flv_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js</span></span><br><span class="line">    <span class="attr">webtorrent_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">bilibili:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">page:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">danmaku:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">xigua:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">autoplay:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">startTime:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ1ï¼‰MarkDownå¼•å…¥"><a href="#ï¼ˆ1ï¼‰MarkDownå¼•å…¥" class="headerlink" title="ï¼ˆ1ï¼‰MarkDownå¼•å…¥"></a>ï¼ˆ1ï¼‰MarkDownå¼•å…¥</h4><p>MarkDown å†…å¯ä»¥ä½¿ç”¨ä¸¤ç§æ ‡ç­¾ä½œä¸ºæ’ä»¶ï¼Œåˆ†åˆ«æ˜¯ <code>mmedia</code> å’Œ <code>mmedias</code> ï¼Œä½¿ç”¨æ–¹å¼ä¸ºï¼š</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">æˆ–</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedias</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><p>åªä½¿ç”¨ <code>args</code> ä½œä¸ºä¼ å‚æ–¹å¼æ—¶ï¼Œä¸¤ç§æ ‡ç­¾å‡å¯ä½¿ç”¨ï¼Œå½“éœ€è¦ä½¿ç”¨ <code>contents</code> ä¼ å‚æ—¶ï¼Œåªèƒ½ä½¿ç”¨ <code>mmedias</code> ã€‚åé¢ç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæ ‡è®°æ ‡ç­¾ï¼Œå¯é€‰ï¼ˆä»¥è¯¦ç»†æ–‡æ¡£ä¸ºä¸»ï¼ŒæŒç»­æ›´æ–°ä¸­ï¼‰ï¼š<code>audio</code> <code>video</code> <code>meting</code> <code>aplayer</code> <code>dplayer</code> <code>bilibili</code> <code>xigua</code> å†åé¢çš„å‚æ•°å°†ç›´æ¥ä½œä¸º <code>args</code> å‚æ•°ç›´æ¥ä¼ å…¥æ’ä»¶ã€‚</p><h4 id="ï¼ˆ2ï¼‰å‚æ•°"><a href="#ï¼ˆ2ï¼‰å‚æ•°" class="headerlink" title="ï¼ˆ2ï¼‰å‚æ•°"></a>ï¼ˆ2ï¼‰å‚æ•°</h4><p>ä¼ å…¥æ ‡ç­¾çš„å‚æ•°å¯ä»¥å†™å…¥åˆ°ä¸‰ä¸ªä½ç½®ï¼Œåˆ†åˆ«ä¸ºï¼š <code>_config.yml</code> ï¼Œ <code>args</code> ï¼Œ <code>contents</code> ï¼Œå…¶ä¸­åªæœ‰éƒ¨åˆ†æ’ä»¶å¯ä½¿ç”¨ <code>contents</code> é…ç½®ï¼Œå…·ä½“çœ‹è¯¦ç»†æ–‡æ¡£ï¼Œå¦‚æœ‰å†²çªé¡¹ï¼Œè¦†ç›–è§„åˆ™ä¸ºï¼ˆåé¢çš„ä¼šè¢«å‰é¢å‘è¦†ç›–ï¼‰ï¼š<code>contents</code> -&gt; <code>args</code> -&gt; <code>_config.yml</code> -&gt; <code>æ’ä»¶é»˜è®¤</code></p><p>å†™å…¥åˆ° <code>args</code> ä¸Šçš„å‚æ•°ï¼Œæœ‰ä¸¤ç§å†™æ³•ï¼Œåˆ†åˆ«æ˜¯ä½¿ç”¨ <code>:</code> å’Œ <code>=</code> åˆ†å‰²ï¼Œä¸¤ç§å†™æ³•æ˜¯ç­‰æ•ˆçš„ï¼Œåœ¨é‡åˆ°ç¬¬ä¸€ä¸ª <code>:</code> æˆ– <code>=</code> æ—¶ä¼šè‡ªåŠ¨åˆ†å‰²ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1hb4y1R7xf&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid=BV1hb4y1R7xf&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸¤ç§å†™æ³•æ˜¯ç­‰æ•ˆçš„ã€‚</p><p>å¦‚æœé‡åˆ°å¸ƒå°”ç±»å‹çš„å‚æ•°ï¼Œå¯ä»¥ç®€å†™ï¼š</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:true&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸¤ç§å†™æ³•ç­‰æ•ˆï¼Œä½†éœ€è¦æ³¨æ„ï¼Œ <code>:</code> æˆ– <code>=</code> ä¸€å®šä¸èƒ½çœç•¥ã€‚</p><h4 id="ï¼ˆ3ï¼‰JSON-ä¼ å‚"><a href="#ï¼ˆ3ï¼‰JSON-ä¼ å‚" class="headerlink" title="ï¼ˆ3ï¼‰JSON ä¼ å‚"></a>ï¼ˆ3ï¼‰JSON ä¼ å‚</h4><p>æ”¯æŒ JSON æ–¹å¼ä¼ å‚ï¼Œå…¶ä¸­ JSON ä¸º <a href="https://json5.org/">JSON5</a> è§„èŒƒã€‚ç¤ºä¾‹ï¼š</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedias</span> &quot;aplayer&quot; &quot;autoplay:false&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;</span></span><br><span class="line"><span class="xml">  &quot;volume&quot;: 0.8,</span></span><br><span class="line"><span class="xml">  &quot;audio&quot;:</span></span><br><span class="line"><span class="xml">  [</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url1.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover1.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc1.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#ebd0c2&quot;</span></span><br><span class="line"><span class="xml">    &#125;,</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url2.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover2.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc2.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#46718b&quot;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  ]</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ4ï¼‰MetingJS"><a href="#ï¼ˆ4ï¼‰MetingJS" class="headerlink" title="ï¼ˆ4ï¼‰MetingJS"></a>ï¼ˆ4ï¼‰MetingJS</h4><p>è§„åˆ™ï¼š</p><ul><li>ä½¿ç”¨ <code>:</code> æˆ– <code>=</code> åˆ†å‰²ã€‚</li><li>æ‰€æœ‰ <code>&lt;meting-js&gt;</code> æ ‡ç­¾çš„å‚æ•°å‡å¯æ·»åŠ ï¼Œåªè¦èƒ½å†™è¿›å»å°±å¯ä»¥ã€‚</li></ul><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;auto=https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;server=netease&quot;&quot;type=playlist&quot;&quot;id=60198&quot; %&#125;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" server="netease" type="song" id=603259 ></meting-js><h4 id="ï¼ˆ5ï¼‰BiliBili"><a href="#ï¼ˆ5ï¼‰BiliBili" class="headerlink" title="ï¼ˆ5ï¼‰BiliBili"></a>ï¼ˆ5ï¼‰BiliBili</h4><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; &quot;danmaku:false&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>:</code> æˆ– <code>=</code> åˆ†å‰²ï¼Œè¯¦ç»†å‚æ•°è¡¨ï¼š</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">é»˜è®¤</th><th align="left">è§£é‡Š</th></tr></thead><tbody><tr><td align="left">aid</td><td align="left">-</td><td align="left">aid</td></tr><tr><td align="left">bvid</td><td align="left">-</td><td align="left">bvidï¼Œä¸ aid åŒæ—¶å‡ºç°æ—¶ä»¥ bvid ä¸ºå‡†</td></tr><tr><td align="left">page</td><td align="left">1</td><td align="left">page</td></tr><tr><td align="left">danmaku</td><td align="left">true</td><td align="left">æ˜¯å¦æœ‰å¼¹å¹• ture or false</td></tr><tr><td align="left">allowfullscreen</td><td align="left">allowfullscreen</td><td align="left">å…è®¸å…¨å±ï¼Œ allowfullscreen æˆ– true å…è®¸ï¼Œå…¶ä»–é€‰é¡¹ä¸å…è®¸</td></tr><tr><td align="left">sandbox</td><td align="left">è§ <a href="https://www.u2sb.com/pages/19d343/#%E9%85%8D%E7%BD%AE">é…ç½®</a></td><td align="left">iframe sandbox</td></tr><tr><td align="left">width</td><td align="left">100%</td><td align="left">css å±æ€§</td></tr><tr><td align="left">max_width</td><td align="left">850px</td><td align="left">css å±æ€§</td></tr><tr><td align="left">margin</td><td align="left">auto</td><td align="left">css å±æ€§</td></tr></tbody></table><style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-IRJzovUHVBtczqnm" src="https://player.bilibili.com/player.html?bvid=BV1AE411a7Nw&page=1&high_quality=1&danmaku=false" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-IRJzovUHVBtczqnm").style.height=document.getElementById("mmedia-IRJzovUHVBtczqnm").scrollWidth*0.76+"px";    window.onresize = function(){      document.getElementById("mmedia-IRJzovUHVBtczqnm").style.height=document.getElementById("mmedia-IRJzovUHVBtczqnm").scrollWidth*0.76+"px";    }; </script><h3 id="4-12-æ·»åŠ çœ‹æ¿å¨˜ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"><a href="#4-12-æ·»åŠ çœ‹æ¿å¨˜ï¼ˆæ—§ç‰ˆæœ¬ï¼‰" class="headerlink" title="4.12 æ·»åŠ çœ‹æ¿å¨˜ï¼ˆæ—§ç‰ˆæœ¬ï¼‰"></a>4.12 æ·»åŠ çœ‹æ¿å¨˜ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</h3><ul><li>æ•ˆæœé¢„è§ˆï¼š <a href="https://huaji8.top/post/live2d-plugin-2.0/">https://huaji8.top/post/live2d-plugin-2.0/</a></li><li>æºä»£ç åœ°å€ï¼š <a href="https://github.com/EYHN/hexo-helper-live2d">https://github.com/EYHN/hexo-helper-live2d</a></li></ul><p>é¦–å…ˆæ ¹ç›®å½•æ‰“å¼€å‘½ä»¤å·¥å…·ï¼Œè¾“å…¥å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -save hexo-helper-live2d</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ <code>Hexo/blog/themes/next/layout</code> çš„ <code>_layout.swig</code> ï¼Œå°†ä¸‹é¢ä»£ç æ”¾åˆ° <code>&lt;/body&gt;</code> ä¹‹å‰ï¼š</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">live2d</span>() &#125;&#125;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ ¹ç›®å½•é…ç½®æ–‡ä»¶ <code>\_config.yml</code> ä¸­æ·»åŠ å‚æ•°ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ¨æ€å¦¹å­</span></span><br><span class="line"><span class="attr">live2d:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scriptFrom:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">tagMode:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">model:</span></span><br><span class="line">    <span class="attr">use:</span> <span class="string">live2d-widget-model-shizuku</span></span><br><span class="line">  <span class="attr">display:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">right</span></span><br><span class="line">    <span class="attr">width:</span> <span class="number">150</span></span><br><span class="line">    <span class="attr">height:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">mobile:</span></span><br><span class="line">    <span class="attr">show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°ä¸‹é¢è¿™ä¸ªé—®é¢˜:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280214.png"></p><p>é¦–å…ˆåˆ é™¤hexo ä¸‹é¢çš„ <code>.deploy_git</code> æ–‡ä»¶å¤¹ï¼Œç„¶åæ‰§è¡Œä¸‹åˆ—ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></table></figure><p>æ–°ç‰ˆæœ¬ï¼Œæœ‰ç‚¹å¡å¡çš„ï¼Œè€Œä¸”æ²¡åœ°æ–¹æ”¾äº†ï¼Œä¸åŠ äº†ï¼š<a href="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a></p><p>Edit <code>source/_data/head.njk</code> in site root directory and add the following contentï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Then uncomment <code>head</code> under the <code>custom_file_path</code> section in theme config file.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">head:</span> <span class="string">source/_data/head.njk</span></span><br></pre></td></tr></table></figure><h2 id="äº”-å¼‚å¸¸è®°å½•"><a href="#äº”-å¼‚å¸¸è®°å½•" class="headerlink" title="äº”. å¼‚å¸¸è®°å½•"></a>äº”. å¼‚å¸¸è®°å½•</h2><h3 id="ï¼ˆ1ï¼‰unknown-block-tag-endif"><a href="#ï¼ˆ1ï¼‰unknown-block-tag-endif" class="headerlink" title="ï¼ˆ1ï¼‰unknown block tag: endif"></a>ï¼ˆ1ï¼‰unknown block tag: endif</h3><p>ä¸€æ¬¡æ›´æ–°åšå®¢ï¼ˆhexo gï¼‰æ—¶ï¼Œå‡ºç°ä»¥ä¸‹å¼‚å¸¸ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200401/202004010101.png"></p><p>googleäº†ä¸€ä¸‹ï¼Œçœ‹åˆ°æœ‰ç±»ä¼¼é—®é¢˜çš„æ˜¯å› ä¸ºåœ¨â€™{â€˜å’Œâ€™%â€™ä¹‹é—´å¤šå†™äº†ç©ºæ ¼è¿™ç§è¯­æ³•é”™è¯¯ï¼Œæ‰€ä»¥èŠ±äº†ä¸€äº›æ—¶é—´å»æ‰¾é¡¹ç›®ä¸­çš„swigæ–‡ä»¶ï¼Œå› ä¸ºåˆšå¥½è¿™æ¬¡æ›´æ–°ä¹Ÿæœ‰å¢åŠ ä¸€äº›åšå®¢åŠŸèƒ½ï¼Œæ€€ç–‘æ˜¯ä¸æ˜¯ä¿®æ”¹swigæ–‡ä»¶æ—¶ä¹Ÿå†™é”™äº†ã€‚(<a href="https://52heartz.top/articles/hexo-template-render-error/" title="title">Hexo çš„ Template render error é”™è¯¯</a> å’Œ <a href="https://github.com/hexojs/hexo/issues/3346" title="title">hexo åœ¨markdownæ–‡æ¡£ä¸­å‡ºç°<code>&#123;-% %-&#125;</code>è¯­æ³•ä¼šæŠ¥é”™ï¼Œæç¤ºâ€œTemplate render error: (unknown path) </a>)</p><p>ä½†å¾ˆå¿«ä¾¿å‘ç°æ²¡æœ‰æ‰¾åˆ°å¼‚å¸¸ï¼Œæ‰€ä»¥æ€è€ƒäº†ä¸€ä¸‹ï¼Œæ—¢ç„¶ä»£ç æ–‡ä»¶ä¸­çš„endifæ²¡æœ‰é—®é¢˜ï¼Œä¼šä¸ä¼šæ˜¯å…¶ä»–åœ°æ–¹ä¹Ÿå†™äº†endifï¼Œçªç„¶æƒ³åˆ°è¿™æ¬¡æäº¤ä¹Ÿæ›´æ–°äº†MDæ–‡ä»¶ï¼Œè®°å½•æˆ‘è¿™æ¬¡æ›´æ–°ï¼Œå…¶ä¸­ä¹Ÿç›´æ¥è®°å½•äº† <code>\&#123;\% endif \%\&#125;</code>ï¼Œæ‰€ä»¥å°±ä¿®æ”¹äº†ç›¸å…³æè¿°ã€‚</p><p>é‡è¯•äº†ä¸€ä¸‹ï¼Œé—®é¢˜è§£å†³ã€‚</p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— <a href="http://www.wuxubj.cn/2016/08/Hexo-nexT-build-personal-blog/" title="title">Hexo+nexTä¸»é¢˜æ­å»ºä¸ªäººåšå®¢</a></p><p>ğŸ”— <a href="https://www.jianshu.com/p/5d5931289c09" title="title">nexTä¸»é¢˜é…ç½®</a></p><p>ğŸ”— <a href="http://theme-next.iissnan.com/theme-settings.html" title="title">nexTå®˜æ–¹æ–‡æ¡£</a></p><p>ğŸ”— <a href="https://segmentfault.com/a/1190000009544924" title="title">è‡ªå®šä¹‰é…ç½®nexT</a></p><p>ğŸ”— <a href="https://fontawesome.com/icons?from=io" title="title">å›¾æ ‡åº“</a></p><p>ğŸ”— <a href="https://www.techgrow.cn/posts/d1f06120.html" title="title">Hexo ä¸ Next ç‰ˆæœ¬å‡çº§æ•™ç¨‹</a></p><p>ğŸ”— <a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/" title="title">Hexo NexT æ·»åŠ å‹é“¾é¡µé¢</a></p><p>ğŸ”— <a href="http://yearito.cn/posts/hexo-advanced-settings.html" title="title">Hexo æ­å»ºä¸ªäººåšå®¢ç³»åˆ—ï¼šè¿›é˜¶è®¾ç½®ç¯‡</a></p><p>ğŸ”— <a href="https://www.techgrow.cn/posts/abf4aee1.html" title="title">Hexo Next 8.x ä¸»é¢˜æ·»åŠ å¯åˆ‡æ¢çš„æš—é»‘æ¨¡å¼</a></p><p>ğŸ”— <a href="https://www.gaficat.com/posts/353df0b0.html" title="title">ç»™ä½ çš„hexoæ’å…¥éŸ³ä¹è§†é¢‘</a></p><p>ğŸ”— <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmediaæ–‡æ¡£</a></p>]]></content>
    
    
    <summary type="html">Hexoå‡çº§ç‰ˆæœ¬å’ŒåŠŸèƒ½é…ç½®ï¼ŒæŒç»­æ›´æ–°ä¸­ã€‚</summary>
    
    
    
    <category term="æ­å»ºåšå®¢" scheme="http://linyishui.top/categories/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/"/>
    
    
    <category term="hexo" scheme="http://linyishui.top/tags/hexo/"/>
    
    <category term="updating" scheme="http://linyishui.top/tags/updating/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•-è¯·æ±‚å¤„ç†å’Œæ•°æ®å­˜å‚¨ï¼ˆæœªå®Œæˆï¼‰</title>
    <link href="http://linyishui.top/2021062001.html"/>
    <id>http://linyishui.top/2021062001.html</id>
    <published>2021-06-20T14:33:08.000Z</published>
    <updated>2021-07-20T14:55:19.831Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"><a href="#ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•" class="headerlink" title="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"></a>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•</h1><h2 id="å…«-è¯·æ±‚å¤„ç†"><a href="#å…«-è¯·æ±‚å¤„ç†" class="headerlink" title="å…«. è¯·æ±‚å¤„ç†"></a>å…«. è¯·æ±‚å¤„ç†</h2><h3 id="8-1-ä¼šè¯åˆ›å»ºè¯·æ±‚"><a href="#8-1-ä¼šè¯åˆ›å»ºè¯·æ±‚" class="headerlink" title="8.1 ä¼šè¯åˆ›å»ºè¯·æ±‚"></a>8.1 ä¼šè¯åˆ›å»ºè¯·æ±‚</h3><p>ZooKeeperæœåŠ¡å™¨å¯¹äºä¼šè¯åˆ›å»ºçš„å¤„ç†ï¼Œå¤§ä½“åˆ†ä¸º6å¤§ç¯èŠ‚ï¼š</p><ul><li>è¯·æ±‚æ¥æ”¶</li><li>ä¼šè¯åˆ›å»º</li><li>é¢„å¤„ç†</li><li>äº‹åŠ¡å¤„ç†</li><li>äº‹åŠ¡åº”ç”¨</li><li>ä¼šè¯å“åº”</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010153.png"></p><p>å…¶ä¸­äº‹åŠ¡å¤„ç†éƒ¨åˆ†æµç¨‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010154.png"></p><ul><li><strong>è¯·æ±‚æ¥æ”¶ï¼š</strong><ol><li>I/Oå±‚æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</li><li>åˆ¤æ–­æ˜¯å¦æ˜¯å®¢æˆ·ç«¯ä¼šè¯åˆ›å»ºè¯·æ±‚ã€‚</li><li>ååºåˆ—åŒ–ConnectRequestè¯·æ±‚ã€‚</li><li>åˆ¤æ–­æ˜¯å¦æ˜¯ReadOnlyå®¢æˆ·ç«¯ã€‚</li><li>æ£€æŸ¥å®¢æˆ·ç«¯ZXIDã€‚</li><li>åå•†sessionTimeoutã€‚</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºä¼šè¯ã€‚</li></ol></li><li><strong>ä¼šè¯åˆ›å»ºï¼š</strong><ol start="8"><li>ä¸ºå®¢æˆ·ç«¯ç”ŸæˆsessionIDã€‚</li><li>æ³¨å†Œä¼šè¯ã€‚</li><li>æ¿€æ´»ä¼šè¯ã€‚</li><li>ç”Ÿæˆä¼šè¯å¯†ç ã€‚</li></ol></li><li><strong>é¢„å¤„ç†ï¼š</strong><ol start="12"><li>å°†è¯·æ±‚äº¤ç»™ZKçš„PrepRequestProcessorå¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚</li><li>åˆ›å»ºè¯·æ±‚äº‹åŠ¡å¤´ã€‚</li><li>åˆ›å»ºè¯·æ±‚äº‹åŠ¡ä½“ã€‚</li><li>æ³¨å†Œä¸æ¿€æ´»ä¼šè¯ã€‚</li></ol></li><li><strong>äº‹åŠ¡å¤„ç†ï¼š</strong><ol start="16"><li>å°†è¯·æ±‚äº¤ç»™ProposalRequestProcessorå¤„ç†å™¨ã€‚</li></ol></li></ul><h3 id="8-2-SetDataè¯·æ±‚"><a href="#8-2-SetDataè¯·æ±‚" class="headerlink" title="8.2 SetDataè¯·æ±‚"></a>8.2 SetDataè¯·æ±‚</h3><h3 id="8-3-äº‹åŠ¡è¯·æ±‚è½¬å‘"><a href="#8-3-äº‹åŠ¡è¯·æ±‚è½¬å‘" class="headerlink" title="8.3 äº‹åŠ¡è¯·æ±‚è½¬å‘"></a>8.3 äº‹åŠ¡è¯·æ±‚è½¬å‘</h3><h3 id="8-4-GetDataè¯·æ±‚"><a href="#8-4-GetDataè¯·æ±‚" class="headerlink" title="8.4 GetDataè¯·æ±‚"></a>8.4 GetDataè¯·æ±‚</h3><h2 id="ä¹-æ•°æ®ä¸å­˜å‚¨"><a href="#ä¹-æ•°æ®ä¸å­˜å‚¨" class="headerlink" title="ä¹. æ•°æ®ä¸å­˜å‚¨"></a>ä¹. æ•°æ®ä¸å­˜å‚¨</h2><h3 id="9-1-å†…å­˜æ•°æ®"><a href="#9-1-å†…å­˜æ•°æ®" class="headerlink" title="9.1 å†…å­˜æ•°æ®"></a>9.1 å†…å­˜æ•°æ®</h3><h3 id="9-2-äº‹åŠ¡æ—¥å¿—"><a href="#9-2-äº‹åŠ¡æ—¥å¿—" class="headerlink" title="9.2 äº‹åŠ¡æ—¥å¿—"></a>9.2 äº‹åŠ¡æ—¥å¿—</h3><h3 id="9-3-snapshotâ€”æ•°æ®å¿«ç…§"><a href="#9-3-snapshotâ€”æ•°æ®å¿«ç…§" class="headerlink" title="9.3 snapshotâ€”æ•°æ®å¿«ç…§"></a>9.3 snapshotâ€”æ•°æ®å¿«ç…§</h3><h3 id="9-4-åˆå§‹åŒ–"><a href="#9-4-åˆå§‹åŒ–" class="headerlink" title="9.4 åˆå§‹åŒ–"></a>9.4 åˆå§‹åŒ–</h3><h3 id="9-5-æ•°æ®åŒæ­¥"><a href="#9-5-æ•°æ®åŒæ­¥" class="headerlink" title="9.5 æ•°æ®åŒæ­¥"></a>9.5 æ•°æ®åŒæ­¥</h3><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šä¼šè¯åˆ›å»ºã€SetDataã€GetDataè¯·æ±‚ï¼Œäº‹åŠ¡è¯·æ±‚è½¬å‘ï¼Œå†…å­˜æ•°æ®ï¼Œäº‹åŠ¡æ—¥å¿—ï¼Œsnapshotï¼Œåˆå§‹åŒ–ï¼Œæ•°æ®åŒæ­¥ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰å¯¼è®º</title>
    <link href="http://linyishui.top/2021061501.html"/>
    <id>http://linyishui.top/2021061501.html</id>
    <published>2021-06-15T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:31.154Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯¼è®º"><a href="#å¯¼è®º" class="headerlink" title="å¯¼è®º"></a>å¯¼è®º</h1><h2 id="ä¸€-ä»€ä¹ˆæ˜¯ç¤¾ä¼šå¿ƒç†å­¦"><a href="#ä¸€-ä»€ä¹ˆæ˜¯ç¤¾ä¼šå¿ƒç†å­¦" class="headerlink" title="ä¸€. ä»€ä¹ˆæ˜¯ç¤¾ä¼šå¿ƒç†å­¦"></a>ä¸€. ä»€ä¹ˆæ˜¯ç¤¾ä¼šå¿ƒç†å­¦</h2><blockquote><p>äººç±»æ˜¯æƒ…å¢ƒä¸­çš„ç”Ÿç‰©ï¼Œæƒ…å¢ƒå¡‘é€ äº†æˆ‘ä»¬ï¼Œå†³å®šæˆ‘ä»¬æœªæ¥çš„è¯¸å¤šå¯èƒ½æ€§ï¼Œæˆ‘ä»¬ä¾¿ä¸å¯ç‹¬ç«‹äºå®ƒè€Œå­˜åœ¨ã€‚</p></blockquote><p>ç¤¾ä¼šå¿ƒç†å­¦æ˜¯ä¸€é—¨<strong>ç ”ç©¶æˆ‘ä»¬å‘¨å›´æƒ…å¢ƒåŠ›é‡</strong>çš„ç§‘å­¦ï¼Œå°¤å…¶æ˜¯æˆ‘ä»¬<strong>å¦‚ä½•çœ‹å¾…ä»–äººã€å¦‚ä½•å½±å“ä»–äººã€åˆå¦‚ä½•äº’ç›¸å…³è”</strong>ã€‚ã€</p><p>æˆ‘ä»¬çš„ç¤¾ä¼šè¡Œä¸ºä¸ä»…å–å†³äº<strong>å®¢è§‚æƒ…å¢ƒ</strong>ï¼Œè¿˜å–å†³äºæˆ‘ä»¬å¦‚ä½•å¯¹å…¶è¿›è¡Œ<strong>ä¸»è§‚å»ºæ„</strong>ã€‚</p><h3 id="ç ”ç©¶çš„é—®é¢˜"><a href="#ç ”ç©¶çš„é—®é¢˜" class="headerlink" title="ç ”ç©¶çš„é—®é¢˜"></a>ç ”ç©¶çš„é—®é¢˜</h3><p>ç¤¾ä¼šå¿ƒç†å­¦ç ”ç©¶ä¸‰ç±»é—®é¢˜ï¼š</p><ul><li><strong>ç¤¾ä¼šæ€ç»´ï¼š</strong><ul><li>æˆ‘ä»¬å¦‚ä½•çŸ¥è§‰è‡ªæˆ‘å’Œä»–äºº</li><li>æˆ‘ä»¬çš„ä¿¡å¿µæ˜¯ä»€ä¹ˆ</li><li>æˆ‘ä»¬æ‰€åšçš„åˆ¤æ–­</li><li>æˆ‘ä»¬çš„æ€åº¦</li></ul></li><li><strong>ç¤¾ä¼šå½±å“ï¼š</strong><ul><li>æ–‡åŒ–ä¸ç”Ÿç‰©ä»ä¼—çš„å‹åŠ›</li><li>è¯´æœ</li><li>å›¢ä½“</li></ul></li><li><strong>ç¤¾ä¼šå…³ç³»ï¼š</strong><ul><li>åè§</li><li>æ”»å‡»</li><li>å¸å¼•åŠ›å’Œäº²å¯†å…³ç³»</li><li>åŠ©äºº</li></ul></li></ul><p>æˆ‘ä»¬çš„ç¤¾äº¤ç”Ÿæ´»åœ¨å¤šå¤§ç¨‹åº¦ä¸Šå­˜åœ¨äºæˆ‘ä»¬çš„å¤´è„‘ä¹‹ä¸­ï¼Ÿå¦‚æœè¢«è¦æ±‚å¬å‘½è¡Œäº‹ï¼Œä½ ä¼šç”¨æ®‹å¿çš„æ–¹å¼è¡ŒåŠ¨å—ï¼Ÿé€‰æ‹©åŠ©äººè¿˜æ˜¯åŠ©å·±ï¼Ÿ</p><h3 id="ç¤¾ä¼šå¿ƒç†å­¦çš„è§‚ç‚¹"><a href="#ç¤¾ä¼šå¿ƒç†å­¦çš„è§‚ç‚¹" class="headerlink" title="ç¤¾ä¼šå¿ƒç†å­¦çš„è§‚ç‚¹"></a>ç¤¾ä¼šå¿ƒç†å­¦çš„è§‚ç‚¹</h3><ul><li>ç¤¾ä¼šæ€ç»´ï¼š<ol><li><strong>æˆ‘ä»¬æ„å»ºèµ·ç¤¾ä¼šç°å®ã€‚</strong>äººç±»çš„é€šæ€§æ˜¯æƒ³è¦è§£é‡Šè¡Œä¸ºï¼Œä½¿å…¶å½’å› å˜å¾—æ¬¡åºäº•ç„¶ï¼Œå…·æœ‰å¯é¢„è§æ€§ï¼Œèƒ½å¤Ÿè¢«æŒæ¡ã€‚æˆ‘ä»¬ä¼šä¹ æƒ¯è§£é‡Šä»–äººçš„è¡Œä¸ºï¼Œå°†å…¶â€œäººæ ¼â€å½’ç±»ã€‚çœ‹å¾…è‡ªå·±æ˜¯ä¹è§‚æˆ–æ‚²è§‚ï¼Œä¹ æƒ¯é«˜äººä¸€ç­‰è¿˜æ˜¯ä½äººä¸€ç­‰ï¼Ÿ</li><li><strong>æˆ‘ä»¬çš„ç¤¾ä¼šç›´è§‰çš„åŠ›é‡æ˜¯å¼ºå¤§çš„ï¼Œä½†æœ‰æ—¶æ˜¯å±é™©çš„ã€‚</strong>æˆ‘ä»¬çš„ç›´è§‰å½±å“æˆ‘ä»¬æŸäº›æ—¶åˆ»çš„é€‰æ‹©ï¼Œäººçš„å¿ƒçµæˆ–è®¸æ˜¯æ— æ„è¯†çš„ï¼Œä¸€ä¸ªç”±ç›´è§‰æ‰€æ“æ§çš„ã€‚æ€ç»´ã€è®°å¿†å’Œæ€åº¦éƒ½æ˜¯åŒæ—¶åœ¨ä¸¤ä¸ªæ°´å¹³ä¸Šè¿è¡Œçš„ï¼Œä¸€ä¸ªæœ‰æ„è¯†å’Œæ„å›¾ï¼Œä¸€ä¸ªæ— æ„è¯†å’Œè‡ªåŠ¨ï¼Œå³<strong>åŒé‡åŠ å·¥</strong>ã€‚æˆ‘ä»¬è‡ªå·±çš„ç›´è§‰æ—¶å¸¸ä¼šå‡ºé”™ï¼Œå¤ªè¿‡äºç›¸ä¿¡è‡ªå·±çš„è®°å¿†åŠ›ï¼Œé”™è¯¯çš„è§£è¯»è‡ªå·±çš„å¿ƒç†ï¼Œé”™è¯¯ä¼°è®¡è‡ªå·±çš„æœªæ¥ã€‚å¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼Œå¿«æ·çœåŠ›çš„é€Ÿé£Ÿå‹åˆ¤æ–­æ–¹å¼è¶³ä»¥æ»¡è¶³éœ€æ±‚ï¼Œä½†ä¸€äº›éœ€è¦<strong>å‡†ç¡®æ€§</strong>çš„ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿ç”¨<strong>æ‰¹åˆ¤æ€§æ€ç»´</strong>æ¥æŠ‘åˆ¶ç›´è§‰å†²åŠ¨ã€‚</li><li><strong>æ€åº¦å¡‘é€ è¡Œä¸ºã€‚</strong>æˆ‘ä»¬å¯¹æŸäº›äº‹æƒ…çš„æ€åº¦ä¼šå·¦å³ç›¸å…³çš„è¡Œä¸ºï¼Œæ€åº¦ä¹ŸåŒæ ·ä¾é™„äºè¡Œä¸ºã€‚</li></ol></li><li>ç¤¾ä¼šå½±å“ï¼š<ol start="4"><li><strong>ç¤¾ä¼šå½±å“å¡‘é€ è¡Œä¸ºã€‚</strong>æˆ‘ä»¬æ˜¯ç¤¾ä¼šåŠ¨ç‰©ï¼Œä¼šå¯¹å‘¨å›´ç¯å¢ƒåšå‡ºååº”ã€‚æœ‰æ—¶ï¼ŒæŸäº›ç¤¾ä¼šæƒ…å¢ƒå…·æœ‰çš„å½±å“åŠ›ä¼šå¼•å‘æˆ‘ä»¬åšå‡ºèƒŒç¦»è‡ªå·±æ€åº¦çš„ä¸¾åŠ¨ã€‚æ¯”å¦‚ä¼Šæ‹‰å…‹æˆ˜äº‰çˆ†å‘æ—¶ï¼Œç¾å›½å’Œä»¥è‰²åˆ—çš„ç¾¤ä¼—ä¼šæ›´å€¾å‘äºæˆ˜äº‰ï¼Œè€Œä¸–ç•Œå…¶ä»–å›½å®¶çš„ç¾¤ä¼—åˆ™åå¯¹æˆ˜äº‰ã€‚æˆ‘ä»¬å¯¹å¥³æ€§ç¾çš„å®šä¹‰å–å†³äºæˆ‘ä»¬æ‰€åœ¨çš„æ–‡åŒ–ç¯å¢ƒç­‰ç­‰ã€‚<strong>ç¯å¢ƒæ— æ—¶æ— åˆ»ä¸åœ¨å½±å“ä¸ªäººã€‚</strong></li><li><strong>æ€§æ ¼å€¾å‘å¡‘é€ è¡Œä¸ºã€‚</strong>é¢å¯¹åŒæ ·çš„æƒ…å¢ƒï¼Œä¸åŒæ€§æ ¼çš„äººä¼šåšå‡ºä¸åŒçš„é€‰æ‹©ã€‚<strong>ä½œä¸ºç¤¾ä¼šä¸ªä½“ï¼Œæˆ‘ä»¬ä¸ä»…ä»…æ˜¯ç¤¾ä¼šçš„äº§ç‰©ï¼Œä¹ŸåŒæ ·æ˜¯ç¤¾ä¼šçš„åˆ›é€ è€…ã€‚</strong>ï¼ˆç›¸äº’å½±å“ï¼‰</li></ol></li><li>ç¤¾ä¼šå…³ç³»ï¼š<ol start="6"><li><strong>ç¤¾ä¼šè¡Œä¸ºåŒæ ·ä¹Ÿæ˜¯ç”Ÿç‰©æ€§è¡Œä¸ºã€‚</strong>äººç±»æ˜¯å…ˆå¤©ä¸åå¤©å…±åŒä½œç”¨çš„ç”Ÿç‰©ï¼Œé—ä¼ å¾—åˆ°çš„å¤©æ€§æ˜¯æˆ‘ä»¬åšå‡ºæœ‰åˆ©äºç¹è¡çš„è¡Œä¸ºï¼Œæˆ‘ä»¬é—ä¼ äº†è¿™äº›ä½¿å¾—è¡€è„‰å¾—ä»¥å»¶ç»­çš„åŸºå› ã€‚è¿›åŒ–å¿ƒç†å­¦ç ”ç©¶çš„æ˜¯è‡ªç„¶é€‰æ‹©å¦‚ä½•å½±å“æˆ‘ä»¬çš„ä¸€äº›è¡Œä¸ºä¸ååº”ã€‚å¤§è„‘ã€å¿ƒçµå’Œè¡Œä¸ºæ˜¯å¦‚ä½•å…±åŒä½œç”¨æˆä¸ºä¸€ä¸ªç›¸äº’åè°ƒçš„å·¥ä½œç³»ç»Ÿï¼Œè¿™æ˜¯ç¤¾ä¼šè®¤çŸ¥ç¥ç»ç§‘å­¦å…³æ³¨çš„é—®é¢˜ã€‚</li><li><strong>å¯¹ä»–äººçš„æ„Ÿå—å’Œåšå‡ºçš„è¡Œä¸ºæœ‰æ—¶æ˜¯ç§¯æï¼Œæœ‰æ—¶åˆ™æ˜¯æ¶ˆæçš„ã€‚</strong></li></ol></li></ul><h2 id="äºŒ-ç¤¾ä¼šå¿ƒç†å­¦ä¸ç›¸å…³å­¦ç§‘"><a href="#äºŒ-ç¤¾ä¼šå¿ƒç†å­¦ä¸ç›¸å…³å­¦ç§‘" class="headerlink" title="äºŒ. ç¤¾ä¼šå¿ƒç†å­¦ä¸ç›¸å…³å­¦ç§‘"></a>äºŒ. ç¤¾ä¼šå¿ƒç†å­¦ä¸ç›¸å…³å­¦ç§‘</h2><ul><li><p><strong>ç¤¾ä¼šå­¦ï¼š</strong>ç¤¾ä¼šå­¦å®¶ç ”ç©¶<strong>å›¢ä½“</strong>â€”ä»å°å›¢ä½“åˆ°å¤§å›¢ä½“ï¼ˆç¤¾ä¼šä¸å…¶å‘å±•è¶‹åŠ¿ï¼‰ï¼›ç¤¾ä¼šå¿ƒç†å­¦å®¶ç ”ç©¶<strong>ä¸ªä½“</strong>â€”ä¸ªä½“åœ¨æŸä¸ªç‰¹å®šæ—¶é—´å¯¹ä»–äººçš„çœ‹æ³•ï¼Œä¸ªä½“ä¹‹é—´çš„ç›¸äº’å½±å“åŠå…³ç³»ã€‚æ¯”å¦‚äº²å¯†å…³ç³»çš„ç ”ç©¶ä¸­ï¼Œç¤¾ä¼šå­¦å…³ç³»å©šå§»å…³ç³»ã€ç¦»å©šä»¥åŠåŒå±…æ¯”ä¾‹ï¼Œç¤¾ä¼šå¿ƒç†å­¦åˆ™å…³å¿ƒä¸ªä½“å¦‚ä½•è¢«å¦ä¸€ä¸ªä¸ªä½“å¸å¼•ã€‚</p></li><li><p><strong>äººæ ¼å¿ƒç†å­¦ï¼š</strong>äºŒè€…éƒ½å…³æ³¨ä¸ªä½“ï¼Œç¤¾ä¼šå¿ƒç†å­¦æ›´å¤šå…³æ³¨ç¤¾ä¼šå› ç´ ï¼Œäººæ ¼å¿ƒç†å­¦åˆ™å…³æ³¨ä¸ªä½“å†…éƒ¨åŠŸèƒ½ä»¥åŠä¸ªä½“é—´çš„å·®å¼‚ã€‚ç¤¾ä¼šå¿ƒç†å­¦å…³æ³¨ä¸ªä½“é—´çš„ç›¸åŒç‚¹ï¼Œäººæ ¼å¿ƒç†å­¦å…³æ³¨ä¸ªä½“é—´çš„å·®å¼‚ç‚¹ã€‚</p></li></ul><h2 id="ä¸‰-ä»·å€¼è§‚ä¸äº‹åèªæ˜"><a href="#ä¸‰-ä»·å€¼è§‚ä¸äº‹åèªæ˜" class="headerlink" title="ä¸‰. ä»·å€¼è§‚ä¸äº‹åèªæ˜"></a>ä¸‰. ä»·å€¼è§‚ä¸äº‹åèªæ˜</h2><blockquote><p>å¿ƒç†å­¦æ— æ³•è§£é‡Šäººç±»å­˜åœ¨çš„ç›®çš„ï¼Œä¹Ÿæ— æ³•è§£é‡Šäººç±»ç”Ÿæ´»çš„æ„ä¹‰ï¼Œä»¥åŠäººç±»çš„æœ€ç»ˆå‘½è¿ã€‚ç¤¾ä¼šå¿ƒç†å­¦åªæ˜¯æˆ‘ä»¬çœ‹å¾…è‡ªæˆ‘ï¼Œäº†è§£è‡ªæˆ‘çš„å…¶ä¸­ä¸€ä¸ªè§†è§’ã€‚</p></blockquote><p>å¦‚æœå¤§è„‘æ²¡æœ‰é¢„å…ˆè®¾å®šä½ å°†çŸ¥è§‰åˆ°æŸä¸ªç‰©ä½“ï¼Œå®ƒä¾¿ä¼šå°†å…¶é˜»éš”åœ¨ä½ çš„ä¸€è§†ä¹‹å¤–ã€‚æˆ‘ä»¬å¯¹ç°å®çš„çŸ¥è§‰ä¼šä¸ºæˆ‘ä»¬çš„é¢„æœŸæ‰€å·¦å³ã€‚<strong>å®¢è§‚ç°å®çš„ç¡®å­˜åœ¨ï¼Œä½†æˆ‘ä»¬æ€»æ˜¯é€è¿‡ä¿¡å¿µä¸ä»·å€¼è§‚çš„çœ¼é•œè§‚å¯Ÿå®ƒä»¬ã€‚</strong></p><p>æ¯ä¸ªäººéƒ½éš¾ä»¥è„±ç¦»ä¸ªäººä¸»è§‚çš„å½±å“ï¼Œå› æ­¤ç¤¾ä¼šå¿ƒç†å­¦çš„æ¦‚å¿µä¹Ÿä¼šè¢«éšå«çš„ä»·å€¼è§‚æ¸—å…¥ã€‚æˆ‘ä»¬ç”Ÿæ´»ä¸­ä¹Ÿä¼šæœ‰è¿™ç§é—®é¢˜ï¼Œå½“åˆ«äººèµç¾å›½å®¶å’Œäººæ°‘æ—¶æˆ‘ä»¬ç§°å…¶ä¸ºæ°‘æ—ä¸»ä¹‰ï¼Œå½“æˆ‘ä»¬è¿™æ ·åšæ—¶å°±å«çˆ±å›½ä¸»ä¹‰ã€‚ä¸€ä¸ªå·å…¥å©šå¤–æƒ…çš„äººæ˜¯è¿½æ±‚å©šå§»è§£æ”¾è¿˜æ˜¯é€šå¥¸ï¼Œå–å†³äºæˆ‘ä»¬ä¸ªäººä»·å€¼è§‚ã€‚é›„å¿ƒå‹ƒå‹ƒçš„ç”·äººä¸ç››æ°”å‡Œäººçš„å¥³äººï¼Œå°å¿ƒè°¨æ…çš„ç”·å­©å­ä¸æ€¯ç”Ÿç”Ÿçš„å¥³å­©å­ç­‰ã€‚</p><p>ç¤¾ä¼šå¿ƒç†å­¦ä¸æ˜¯æ—¨åœ¨äº‹ååˆ†æï¼Œè€Œæ˜¯èƒ½å¤Ÿé¢„æµ‹ã€‚å½“å¾—çŸ¥ç»“æœåå°±ä¼šè§‰å¾—æ˜¾è€Œæ˜“è§ï¼Œæ¯”å¦‚è‚¡å¸‚éœ‡è¡æˆ–å¤§é€‰è½å®šï¼Œå¤§éƒ¨åˆ†è¯„è®ºå¯¹æ­¤å¹¶ä¸æ„Ÿåˆ°æ„å¤–ã€‚ç»å¤§å¤šæ•°çš„å¿ƒç†å­¦å®éªŒå¾—åˆ°ç»“è®ºçœ‹èµ·æ¥éƒ½åƒå¸¸è¯†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æå‰çŸ¥é“äº†ç»“æœï¼ˆäº‹åèªæ˜ï¼‰ã€‚</p><blockquote><p>å°†ä¸€ç¾¤äººåˆ†ä¸ºä¸¤ç»„ï¼Œä¸€ç»„å‘ŠçŸ¥å…¶æ— è®ºäº¤å‹è¿˜æ˜¯å å…¥çˆ±æ²³ï¼Œæ€§æ ¼ä¸æˆ‘ä»¬ä¸åŒçš„äººæ›´æœ‰å¸å¼•åŠ›ï¼Œä¿—è¯è¯´å¼‚æ€§ç›¸å¸ï¼›å¦ä¸€ç»„åˆ™å‘ŠçŸ¥å…¶æ€§æ ¼ç›¸ä¼¼çš„äººæœ€æœ‰å¸å¼•åŠ›ï¼Œä¿—è¯è¯´ç‰©ä»¥ç±»èšã€äººä»¥ç¾¤åˆ†ã€‚</p><p>æ— è®ºå“ªç§è¯´æ³•ï¼Œç”šè‡³æ˜¯ç›¸åçš„è®ºç‚¹éƒ½ä¼šè®©æˆ‘ä»¬è§‰å¾—å¾ˆæœ‰é“ç†ï¼Œæ¯”å¦‚â€œå •è½çš„äººä¸èƒ½å¸®åŠ©å¦ä¸€ä¸ªå •è½çš„äººâ€ä¸â€œå •è½çš„äººèƒ½å¤Ÿå¸®åŠ©å¦ä¸€ä¸ªå •è½çš„äººâ€è¿™ç§åŒé‡æ ¼è¨€ã€‚</p></blockquote><h2 id="å››-ç ”ç©¶æ–¹æ³•"><a href="#å››-ç ”ç©¶æ–¹æ³•" class="headerlink" title="å››. ç ”ç©¶æ–¹æ³•"></a>å››. ç ”ç©¶æ–¹æ³•</h2><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹ã€‚</summary>
    
    
    
    <category term="ç¼–ç¨‹ä¹‹å¤–" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="å¿ƒç†å­¦" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹è¯»ä¹¦ç¬”è®°</title>
    <link href="http://linyishui.top/2021061401.html"/>
    <id>http://linyishui.top/2021061401.html</id>
    <published>2021-06-14T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:27.924Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¤¾ä¼šå¿ƒç†å­¦"><a href="#ç¤¾ä¼šå¿ƒç†å­¦" class="headerlink" title="ç¤¾ä¼šå¿ƒç†å­¦"></a>ç¤¾ä¼šå¿ƒç†å­¦</h1><h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€. å‰è¨€"></a>ä¸€. å‰è¨€</h2><p><a href="../2021061501.html" title="Title">ã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆä¸€ï¼‰å¯¼è®º</a></p><h2 id="äºŒ-ç¤¾ä¼šæ€ç»´"><a href="#äºŒ-ç¤¾ä¼šæ€ç»´" class="headerlink" title="äºŒ. ç¤¾ä¼šæ€ç»´"></a>äºŒ. ç¤¾ä¼šæ€ç»´</h2><h2 id="ä¸‰-ç¤¾ä¼šå½±å“"><a href="#ä¸‰-ç¤¾ä¼šå½±å“" class="headerlink" title="ä¸‰. ç¤¾ä¼šå½±å“"></a>ä¸‰. ç¤¾ä¼šå½±å“</h2><h2 id="å››-ç¤¾ä¼šå…³ç³»"><a href="#å››-ç¤¾ä¼šå…³ç³»" class="headerlink" title="å››. ç¤¾ä¼šå…³ç³»"></a>å››. ç¤¾ä¼šå…³ç³»</h2><h2 id="äº”-å®é™…åº”ç”¨"><a href="#äº”-å®é™…åº”ç”¨" class="headerlink" title="äº”. å®é™…åº”ç”¨"></a>äº”. å®é™…åº”ç”¨</h2><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šç¤¾ä¼šå¿ƒç†å­¦ã€‹ã€‚</summary>
    
    
    
    <category term="ç¼–ç¨‹ä¹‹å¤–" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="å¿ƒç†å­¦" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•-æœåŠ¡å™¨å¯åŠ¨æµç¨‹å’ŒLeaderé€‰ä¸¾</title>
    <link href="http://linyishui.top/2021061301.html"/>
    <id>http://linyishui.top/2021061301.html</id>
    <published>2021-06-13T15:29:15.000Z</published>
    <updated>2021-07-20T14:30:23.871Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"><a href="#ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•" class="headerlink" title="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"></a>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•</h1><h2 id="äº”-æœåŠ¡å™¨å¯åŠ¨"><a href="#äº”-æœåŠ¡å™¨å¯åŠ¨" class="headerlink" title="äº”. æœåŠ¡å™¨å¯åŠ¨"></a>äº”. æœåŠ¡å™¨å¯åŠ¨</h2><p>ZooKeeperæœåŠ¡ç«¯æ¶æ„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010134.png"></p><h3 id="5-1-å•æœºç‰ˆæœåŠ¡å™¨å¯åŠ¨"><a href="#5-1-å•æœºç‰ˆæœåŠ¡å™¨å¯åŠ¨" class="headerlink" title="5.1 å•æœºç‰ˆæœåŠ¡å™¨å¯åŠ¨"></a>5.1 å•æœºç‰ˆæœåŠ¡å™¨å¯åŠ¨</h3><p>ZKæœåŠ¡å™¨å¯åŠ¨æ­¥éª¤ï¼š</p><ol><li>é…ç½®æ–‡ä»¶è§£æã€‚</li><li>åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨ã€‚</li><li>åˆå§‹åŒ–ç½‘ç»œI/Oç®¡ç†å™¨ã€‚</li><li>æ•°æ®æ¢å¤å’Œå¯¹å¤–æœåŠ¡ã€‚</li></ol><p>å•æœºæ¨¡å¼ä¸‹ZKæœåŠ¡å™¨çš„å¯åŠ¨æµç¨‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010135.png"></p><h4 id="ï¼ˆ1ï¼‰é¢„å¯åŠ¨"><a href="#ï¼ˆ1ï¼‰é¢„å¯åŠ¨" class="headerlink" title="ï¼ˆ1ï¼‰é¢„å¯åŠ¨"></a>ï¼ˆ1ï¼‰é¢„å¯åŠ¨</h4><ol><li><p>ç»Ÿä¸€ç”±QuorumPeerMainä½œä¸ºå¯åŠ¨ç±»ã€‚</p><p>å•æœº/é›†ç¾¤æ¨¡å¼ï¼Œåœ¨ <code>zkServer.cmd</code> å’Œ <code>zkServer.sh</code> ä¸¤ä¸ªè„šæœ¬ä¸­éƒ½é…ç½®äº† <code>org.apache.zookeeper.server.quorum.QuorumPeerMain</code> ä½œä¸ºå¯åŠ¨å…¥å£ç±»ã€‚</p></li><li><p>è§£æé…ç½®æ–‡ä»¶ <code>zoo.cfg</code> ã€‚</p><p>è¯¥æ–‡ä»¶é…ç½®äº†ZKè¿è¡Œæ—¶çš„åŸºæœ¬å‚æ•°ï¼ŒåŒ…æ‹¬tickTimeã€dataDirå’ŒclientPortç­‰å‚æ•°ã€‚</p></li><li><p>åˆ›å»ºå¹¶å¯åŠ¨å†å²æ–‡ä»¶æ¸…ç†å™¨ DatadirCleanupManager ã€‚</p><p>ZKä»3.4.0ç‰ˆæœ¬åå¢åŠ äº†è‡ªåŠ¨æ¸…ç†å†å²æ•°æ®æ–‡ä»¶çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬å¯¹äº‹åŠ¡æ—¥å¿—å’Œå¿«ç…§æ•°æ®æ–‡ä»¶è¿›è¡Œå®šæ—¶æ¸…ç†ã€‚</p></li><li><p>åˆ¤æ–­å½“å‰æ˜¯é›†ç¾¤æ¨¡å¼è¿˜æ˜¯å•æœºæ¨¡å¼çš„å¯åŠ¨ã€‚</p><p>ZooKeeperæ ¹æ®æ­¥éª¤2è§£æå‡ºçš„é›†ç¾¤æœåŠ¡å™¨åœ°å€åˆ—è¡¨åˆ¤æ–­å½“å‰æ˜¯å•æœºè¿˜æ˜¯é›†ç¾¤æ¨¡å¼ã€‚å•æœºæ¨¡å¼å§”æ‰˜ç»™ZooKeeperServerMainè¿›è¡Œå¯åŠ¨å¤„ç†ã€‚</p></li><li><p>å†æ¬¡è¿›è¡Œé…ç½®æ–‡ä»¶ <code>zoo.cfg</code> çš„è§£æã€‚</p></li><li><p>åˆ›å»ºæœåŠ¡å™¨å®ä¾‹ ZooKeeperServer ã€‚</p><p><code>org.apache.zookeeper.server.ZooKeeperServer</code> æ˜¯å•æœºç‰ˆæœåŠ¡ç«¯æœ€æ ¸å¿ƒçš„å®ä½“ç±»ã€‚ZKæœåŠ¡å™¨ä¼šé¦–å…ˆè¿›è¡ŒæœåŠ¡å™¨å®ä¾‹çš„åˆ›å»ºï¼Œç„¶åå¯¹å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬è¿æ¥å™¨ã€å†…å­˜æ•°æ®åº“å’Œè¯·æ±‚å¤„ç†å™¨ç­‰ç»„ä»¶çš„åˆå§‹åŒ–ã€‚</p></li></ol><h4 id="ï¼ˆ2ï¼‰åˆå§‹åŒ–"><a href="#ï¼ˆ2ï¼‰åˆå§‹åŒ–" class="headerlink" title="ï¼ˆ2ï¼‰åˆå§‹åŒ–"></a>ï¼ˆ2ï¼‰åˆå§‹åŒ–</h4><ol><li><p>åˆ›å»ºæœåŠ¡å™¨ç»Ÿè®¡å™¨ ServerStats ã€‚</p><p>ServerStats æ˜¯ZKæœåŠ¡å™¨è¿è¡Œæ—¶çš„ç»Ÿè®¡å™¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010136.png"></p></li><li><p>åˆ›å»ºZooKeeperæ•°æ®ç®¡ç†å™¨ FileTxnSnapLog ã€‚</p><p>FileTxnSnapLog æ˜¯ZKä¸Šå±‚æœåŠ¡å™¨å’Œåº•å±‚æ•°æ®å­˜å‚¨ä¹‹é—´çš„å¯¹æ¥å±‚ï¼Œæä¾›äº†ä¸€ç³»åˆ—æ“ä½œæ•°æ®æ–‡ä»¶çš„æ¥å£ï¼ŒåŒ…æ‹¬äº‹åŠ¡æ—¥å¿—æ–‡ä»¶å’Œå¿«ç…§æ•°æ®æ–‡ä»¶ã€‚ZKæ ¹æ® zoo.cfg æ–‡ä»¶ä¸­è§£æå‡ºçš„å¿«ç…§æ•°æ®ç›®å½• dataDir å’Œäº‹åŠ¡æ—¥å¿—ç›®å½• dataLogDir æ¥åˆ›å»º FileTxnSnapLog ã€‚</p></li><li><p>è®¾ç½®æœåŠ¡å™¨tickTimeå’Œä¼šè¯è¶…æ—¶æ—¶é—´é™åˆ¶ã€‚</p></li><li><p>åˆ›å»ºServerCnxnFactoryã€‚</p><p>3.4.0ç‰ˆæœ¬å¼•å…¥Nettyä»£æ›¿è‡ªå®ç°çš„NIOæ¡†æ¶ï¼Œé€šè¿‡é…ç½®ç³»ç»Ÿå±æ€§ <code>zookeeper.serverCnxnFactory</code> æ¥é€‰æ‹©æ‰€ä½¿ç”¨çš„æœåŠ¡ç«¯ç½‘ç»œè¿æ¥å·¥å‚ã€‚</p></li><li><p>åˆå§‹åŒ–ServerCnxnFactoryã€‚</p><p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªThreadæ¥ä½œä¸ºServerCnxnFactoryçš„ä¸»çº¿ç¨‹ï¼Œç„¶åå†åˆå§‹åŒ–NIOæœåŠ¡å™¨ã€‚</p></li><li><p>å¯åŠ¨ServerCnxnFactoryä¸»çº¿ç¨‹ã€‚</p><p>å¯åŠ¨æ­¥éª¤5å·²ç»åˆå§‹åŒ–çš„ä¸»çº¿ç¨‹ServerCnxnFactoryçš„runæ–¹æ³•ï¼Œè™½ç„¶æ­¤æ—¶NIOæœåŠ¡å™¨å·²å¯¹å¤–å¼€æ”¾ç«¯å£ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿè®¿é—®2181ï¼Œä½†æœåŠ¡å™¨å®é™…æ— æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p></li><li><p>æ¢å¤æœ¬åœ°æ•°æ®ã€‚</p><p>æ¯æ¬¡åœ¨ZKå¯åŠ¨çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä»æœ¬åœ°å¿«ç…§æ•°æ®æ–‡ä»¶å’Œäº‹åŠ¡æ—¥å¿—æ–‡ä»¶ä¸­è¿›è¡Œæ•°æ®æ¢å¤ã€‚</p></li><li><p>åˆ›å»ºå¹¶å¯åŠ¨ä¼šè¯ç®¡ç†å™¨ã€‚</p><p>ä¼šè¯ç®¡ç†å™¨ SessionTracker è´Ÿè´£æœåŠ¡ç«¯çš„ä¼šè¯ç®¡ç†ï¼Œåˆ›å»ºSessionTrackerçš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ– expirationIntervalã€nextExpirationTime å’Œ sessionWithTimeoutï¼ˆç”¨äºä¿å­˜æ¯ä¸ªä¼šè¯çš„è¶…æ—¶æ—¶é—´ï¼‰ï¼ŒåŒæ—¶è¿˜ä¼šè®¡ç®—å‡ºä¸€ä¸ªåˆå§‹åŒ–çš„ sessionID ã€‚</p><p>SessionTrackeråˆå§‹åŒ–å®Œæ¯•ï¼ŒZKå°±ä¼šç«‹å³å¼€å§‹ä¼šè¯ç®¡ç†å™¨çš„ä¼šè¯è¶…æ—¶æ£€æŸ¥ã€‚</p></li><li><p>åˆå§‹åŒ–ZooKeeperçš„è¯·æ±‚å¤„ç†é“¾ã€‚</p><p>ZKçš„è¯·æ±‚å¤„ç†æ–¹å¼æ˜¯å…¸å‹çš„è´£ä»»é“¾æ¨¡å¼çš„å®ç°ï¼Œåœ¨æœåŠ¡å™¨ä¸Šä¼šæœ‰å¤šä¸ªè¯·æ±‚å¤„ç†å™¨ä¸€æ¬¡æ¥å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚æœåŠ¡å™¨å¯åŠ¨æ—¶å°†è¿™äº›è¯·æ±‚å¤„ç†å™¨ä¸²è”èµ·æ¥å½¢æˆä¸€ä¸ªè¯·æ±‚å¤„ç†é“¾ã€‚å•æœºç‰ˆåŒ…æ‹¬ PrepRequestProcessorã€SyncRequestProcessor å’Œ FinalRequestProcessor ä¸‰ä¸ªè¯·æ±‚å¤„ç†å™¨</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010137.png"></p></li><li><p>æ³¨å†ŒJMXæœåŠ¡ã€‚</p><p>ZKå°†æœåŠ¡å™¨è¿è¡Œæ—¶çš„ä¸€äº›ä¿¡æ¯ä»¥JMXçš„æ–¹å¼æš´éœ²ç»™å¤–éƒ¨ã€‚</p></li><li><p>æ³¨å†ŒZooKeeperæœåŠ¡å™¨å®ä¾‹ã€‚</p><p>æ­¤å‰ç«¯å£å¼€æ”¾ä½†ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå› ä¸ºç½‘ç»œå±‚å°šæœªèƒ½è®¿é—®ZKå®ä¾‹ã€‚ç»è¿‡åç»­æ­¥éª¤åï¼ŒZKæœåŠ¡å™¨å·²åˆå§‹åŒ–å®Œæ¯•ï¼Œåªéœ€æ³¨å†Œç»™ServerCnxnFactoryå°±å¯ä»¥å¯¹å¤–æä¾›æ­£å¸¸çš„æœåŠ¡ã€‚</p></li></ol><h3 id="5-2-é›†ç¾¤ç‰ˆæœåŠ¡å™¨å¯åŠ¨"><a href="#5-2-é›†ç¾¤ç‰ˆæœåŠ¡å™¨å¯åŠ¨" class="headerlink" title="5.2 é›†ç¾¤ç‰ˆæœåŠ¡å™¨å¯åŠ¨"></a>5.2 é›†ç¾¤ç‰ˆæœåŠ¡å™¨å¯åŠ¨</h3><p>é›†ç¾¤æ¨¡å¼ä¸‹ZKæœåŠ¡å™¨çš„å¯åŠ¨æµç¨‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010138.png"></p><h4 id="ï¼ˆ1ï¼‰é¢„å¯åŠ¨-1"><a href="#ï¼ˆ1ï¼‰é¢„å¯åŠ¨-1" class="headerlink" title="ï¼ˆ1ï¼‰é¢„å¯åŠ¨"></a>ï¼ˆ1ï¼‰é¢„å¯åŠ¨</h4><ol><li><p>ç»Ÿä¸€ç”±QuorumPeerMainä½œä¸ºå¯åŠ¨ç±»ã€‚</p></li><li><p>è§£æé…ç½®æ–‡ä»¶ <code>zoo.cfg</code> ã€‚</p></li><li><p>åˆ›å»ºå¹¶å¯åŠ¨å†å²æ–‡ä»¶æ¸…ç†å™¨ DatadirCleanupManager ã€‚</p></li><li><p>åˆ¤æ–­å½“å‰æ˜¯é›†ç¾¤æ¨¡å¼è¿˜æ˜¯å•æœºæ¨¡å¼çš„å¯åŠ¨ã€‚</p><p>ZooKeeperæ ¹æ®æ­¥éª¤2è§£æå‡ºçš„é›†ç¾¤æœåŠ¡å™¨åœ°å€åˆ—è¡¨åˆ¤æ–­å½“å‰æ˜¯å•æœºè¿˜æ˜¯é›†ç¾¤æ¨¡å¼ã€‚</p></li></ol><h4 id="ï¼ˆ2ï¼‰åˆå§‹åŒ–-1"><a href="#ï¼ˆ2ï¼‰åˆå§‹åŒ–-1" class="headerlink" title="ï¼ˆ2ï¼‰åˆå§‹åŒ–"></a>ï¼ˆ2ï¼‰åˆå§‹åŒ–</h4><ol><li><p>åˆ›å»ºServerCnxnFactoryã€‚</p></li><li><p>åˆå§‹åŒ–ServerCnxnFactoryã€‚</p></li><li><p>åˆ›å»ºZooKeeperæ•°æ®ç®¡ç†å™¨ FileTxnSnapLog ã€‚</p></li><li><p>åˆ›å»ºQuorumPeerå®ä¾‹ã€‚</p><p>QuorumPeeræ˜¯é›†ç¾¤æ¨¡å¼ç‰¹æœ‰çš„å¯¹è±¡ï¼Œæ˜¯ZKæœåŠ¡å™¨å®ä¾‹çš„æ‰˜ç®¡è€…ï¼Œä»é›†ç¾¤å±‚é¢çœ‹ï¼ŒQuorumPeerä»£è¡¨äº†ZKé›†ç¾¤ä¸­ä¸€å°æœºå™¨ã€‚è¿è¡ŒæœŸé—´ï¼ŒQuorumPeer ä¼šä¸æ–­æ£€æµ‹å½“å‰æœåŠ¡å™¨å®ä¾‹çš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒæ—¶æ ¹æ®æƒ…å†µå‘èµ·Leaderé€‰ä¸¾ã€‚</p></li><li><p>åˆ›å»ºå†…å­˜æ•°æ®åº“ZKDatabaseã€‚</p><p>è´Ÿè´£ç®¡ç†ZooKeeperçš„æ‰€æœ‰ä¼šè¯è®°å½•ä»¥åŠDataTreeå’Œäº‹åŠ¡æ—¥å¿—çš„å­˜å‚¨ã€‚</p></li><li><p>åˆå§‹åŒ–QuorumPeerã€‚</p><p>ä¸€äº›æ ¸å¿ƒç»„ä»¶æ³¨å†Œåˆ°QuorumPeerä¸­å»ï¼ŒåŒ…æ‹¬FileTxnSnapLogã€ServerCnxnFactory å’Œ ZKDatabase ã€‚åŒæ—¶ZKè¿˜ä¼šå¯¹QuorumPeeré…ç½®ä¸€äº›å‚æ•°ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€Leader é€‰ä¸¾ç®—æ³•å’Œä¼šè¯è¶…æ—¶æ—¶é—´é™åˆ¶ã€‚</p></li><li><p>æ¢å¤æœ¬åœ°æ•°æ®ã€‚</p></li><li><p>å¯åŠ¨ServerCnxnFactoryä¸»çº¿ç¨‹ã€‚</p></li></ol><h4 id="ï¼ˆ3ï¼‰Leaderé€‰ä¸¾"><a href="#ï¼ˆ3ï¼‰Leaderé€‰ä¸¾" class="headerlink" title="ï¼ˆ3ï¼‰Leaderé€‰ä¸¾"></a>ï¼ˆ3ï¼‰Leaderé€‰ä¸¾</h4><p>æ­¥éª¤ï¼š</p><ol><li><p><strong>åˆå§‹åŒ–Leaderé€‰ä¸¾ã€‚</strong></p><p>ZKæ ¹æ®è‡ªèº«çš„SIDï¼ˆæœåŠ¡å™¨IDï¼‰ã€lastLoggedZxidï¼ˆæœ€æ–°ZXIDï¼‰å’Œå½“å‰æœåŠ¡å™¨epochï¼ˆcurrentEpochï¼‰æ¥ç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–çš„æŠ•ç¥¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½æŠ•è‡ªå·±ã€‚</p><p>ç„¶åZKæ ¹æ® <code>zoo.cfg</code> çš„é…ç½®ï¼Œåˆ›å»ºå¯¹åº”çš„Leaderé€‰ä¸¾ç®—æ³•å®ç°ã€‚é»˜è®¤å¯é€‰ä¸‰ç§å®ç°ï¼Œä½¿ç”¨ <code>electionAlg</code> å±æ€§0~3æŒ‡å®šï¼š</p><ul><li><strong>LeaderElectionï¼š</strong>3.4.0ç‰ˆæœ¬åºŸå¼ƒã€‚</li><li><strong>AuthFastLeaderElectionï¼š</strong>3.4.0ç‰ˆæœ¬åºŸå¼ƒã€‚</li><li><strong>FastLeaderElectionï¼š</strong>å½“å‰å”¯ä¸€é€‰æ‹©ã€‚</li></ul><p>åˆå§‹åŒ–é˜¶æ®µï¼ŒZKé¦–å…ˆåˆ›å»ºLeaderé€‰ä¸¾æ‰€éœ€çš„ç½‘ç»œI/Oå±‚QuorumCnxManagerï¼ŒåŒæ—¶å¯åŠ¨å¯¹Leaderé€‰ä¸¾ç«¯å£çš„ç›‘å¬ï¼Œç­‰å¾…é›†ç¾¤ä¸­å…¶ä»–æœåŠ¡å™¨åˆ›å»ºè¿æ¥ã€‚</p></li><li><p><strong>æ³¨å†ŒJMXæœåŠ¡ã€‚</strong></p></li><li><p><strong>æ£€æµ‹å½“å‰æœåŠ¡å™¨çŠ¶æ€ã€‚</strong></p><p>QuorumPeeræ˜¯ZKæœåŠ¡å™¨å®ä¾‹çš„æ‰˜ç®¡è€…ï¼Œå…¶æ ¸å¿ƒä¸æ–­çš„æ£€æŸ¥å½“å‰æœåŠ¡å™¨çš„çŠ¶æ€å¹¶åšå‡ºå¤„ç†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒZKæœåŠ¡å™¨çŠ¶æ€åœ¨ LOOKINGã€LEADINGå’ŒFOLLOWING/OBSERVING ä¹‹é—´åˆ‡æ¢ã€‚<strong>å¯åŠ¨é˜¶æ®µï¼ŒQuorumPeerçš„åˆå§‹çŠ¶æ€ä¸ºLOOKINGï¼Œæ­¤æ—¶è¿›è¡ŒLeaderé€‰ä¸¾ã€‚</strong></p></li><li><p><strong>Leaderé€‰ä¸¾ã€‚</strong></p><p>ä¸€ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰çš„æœºå™¨ç›¸äº’ä¹‹é—´è¿›è¡Œä¸€ç³»åˆ—æŠ•ç¥¨ï¼Œé€‰ä¸¾æœ€åˆé€‚çš„æœºå™¨æˆä¸ºLeaderï¼Œå…¶ä½™åˆ™æ˜¯Followeræˆ–Observerã€‚<strong>é›†ç¾¤ä¸­å“ªä¸ªæœºå™¨å¤„ç†çš„æ•°æ®æœ€æ–°ï¼ˆæ ¹æ®æœåŠ¡å™¨å¤„ç†è¿‡çš„æœ€å¤§ZXIDæ¥æ¯”è¾ƒæ–°æ—§ï¼‰å°±è¶Šæœ‰å¯èƒ½æˆä¸ºLeader</strong>ã€‚å½“æ‰€æœ‰æœåŠ¡å™¨å¤„ç†çš„ZXIDä¸€è‡´ï¼ŒSIDæœ€å¤§çš„ä¼šæˆä¸ºLeaderã€‚</p></li></ol><h4 id="ï¼ˆ4ï¼‰Leaderå’ŒFollowå¯åŠ¨æœŸäº¤äº’è¿‡ç¨‹"><a href="#ï¼ˆ4ï¼‰Leaderå’ŒFollowå¯åŠ¨æœŸäº¤äº’è¿‡ç¨‹" class="headerlink" title="ï¼ˆ4ï¼‰Leaderå’ŒFollowå¯åŠ¨æœŸäº¤äº’è¿‡ç¨‹"></a>ï¼ˆ4ï¼‰Leaderå’ŒFollowå¯åŠ¨æœŸäº¤äº’è¿‡ç¨‹</h4><p>Leaderå’ŒFollowerå¯åŠ¨æœŸäº¤äº’è¿‡ç¨‹æ­¥éª¤ï¼š</p><ol><li><p><strong>åˆ›å»ºLeaderæœåŠ¡å™¨å’ŒFolloweræœåŠ¡å™¨ã€‚</strong></p><p>å®ŒæˆLeaderé€‰ä¸¾åï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¼šæ ¹æ®è‡ªå·±çš„è§’è‰²åˆ›å»ºå¯¹åº”çš„æœåŠ¡å™¨å®ä¾‹ï¼Œå¼€å§‹è‡ªå·±çš„ä¸»æµç¨‹ã€‚</p></li><li><p><strong>LeaderæœåŠ¡å™¨å¯åŠ¨Followeræ¥æ”¶å™¨LearnerCnxAcceptorã€‚</strong></p><p>ZKé›†ç¾¤è¿è¡ŒæœŸé—´ï¼ŒLeaderæœåŠ¡å™¨éœ€è¦å’Œå…¶ä½™æœåŠ¡å™¨ï¼ˆLearneræœåŠ¡å™¨ï¼‰ä¿æŒè¿æ¥æ¥ç¡®å®šå…¶å­˜æ´»æƒ…å†µã€‚LearnerCnxAcceptorè´Ÿè´£æ¥æ”¶æ‰€æœ‰éLeaderæœåŠ¡å™¨çš„è¿æ¥è¯·æ±‚ã€‚</p></li><li><p><strong>LearneræœåŠ¡å™¨å¼€å§‹å’ŒLeaderå»ºç«‹è¿æ¥ã€‚</strong></p><p>æ‰€æœ‰LearneræœåŠ¡å™¨å¯åŠ¨å®Œæ¯•åï¼Œä»æŠ•ç¥¨ç»“æœå¾—åˆ°LeaderæœåŠ¡å™¨ä¿¡æ¯ï¼Œå¹¶ä¸å…¶å»ºç«‹è¿æ¥ã€‚</p></li><li><p><strong>LeaderæœåŠ¡å™¨åˆ›å»ºLearnerHandlerã€‚</strong></p><p>Leaderæ¥æ”¶åˆ°è¿æ¥åˆ›å»ºè¯·æ±‚åï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„LearnerHandlerå®ä¾‹è¡¨ç¤ºäºŒè€…é—´çš„è¿æ¥ï¼Œå¹¶è´Ÿè´£æ‰€æœ‰çš„æ¶ˆæ¯é€šä¿¡å’Œæ•°æ®åŒæ­¥ã€‚</p></li><li><p><strong>å‘Leaderæ³¨å†Œã€‚</strong></p><p>å»ºç«‹å¥½è¿æ¥åï¼ŒLearnerå‘Leaderæ³¨å†Œï¼Œå‘é€è‡ªå·±çš„LearnerInfoï¼ŒåŒ…æ‹¬æœåŠ¡å™¨SIDå’Œå¤„ç†çš„æœ€æ–°ZXIDã€‚</p></li><li><p><strong>Leaderè§£æLearnerä¿¡æ¯ï¼Œè®¡ç®—æ–°çš„epochã€‚</strong></p><p>Leaderæ ¹æ®è§£æå‡ºçš„SIDå’ŒZXIDï¼Œè·å–å¯¹åº”çš„ <code>epoch_of_learner</code> ï¼Œä¸å½“å‰æœåŠ¡å™¨çš„ <code>epoch_of_leader</code> è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœLearneræ›´å¤§çš„è¯å°±æ›´æ–°Leaderçš„epochï¼š<code>epoch_of_leader = epoch_of_learner + 1</code> ã€‚</p><p>ç„¶åLearnerHandlerä¼šè¿›è¡Œç­‰å¾…ï¼Œç­‰åˆ°è¿‡åŠçš„Learnerå·²ç»å‘Leaderè¿›è¡Œäº†æ³¨å†Œï¼ŒåŒæ—¶æ›´æ–°äº† <code>epoch_of_leader</code> ä¹‹åï¼ŒLeaderå°±å¯ä»¥ç¡®å®šå½“å‰é›†ç¾¤çš„epochäº†ã€‚</p></li><li><p><strong>å‘é€LeaderçŠ¶æ€ã€‚</strong></p><p>è®¡ç®—å‡ºæ–°çš„epochåï¼ŒLeaderä¼šå°†å…¶ä»¥ä¸€ä¸ªLEADERINFOæ¶ˆæ¯çš„å½¢å¼å‘é€ç»™Learnerï¼ŒåŒæ—¶ç­‰å¾…å…¶å“åº”ã€‚</p></li><li><p><strong>Learnerå‘é€ACKä¿¡æ¯ã€‚</strong></p><p>Followeræ”¶åˆ°LEADERINFOæ¶ˆæ¯åï¼Œè§£æå‡ºepochå’ŒZXIDï¼Œå¹¶å‘Leaderåé¦ˆä¸€ä¸ªACKEPOCHå“åº”ã€‚</p></li><li><p><strong>æ•°æ®åŒæ­¥ã€‚</strong></p><p>LeaderæœåŠ¡å™¨æ¥æ”¶åˆ°ACKåï¼Œå¼€å§‹ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p></li><li><p><strong>å¯åŠ¨Leaderå’ŒLearneræœåŠ¡å™¨ã€‚</strong></p><p>å½“è¿‡åŠçš„Learnerå·²ç»å®Œæˆäº†æ•°æ®åŒæ­¥ï¼ŒLeaderå’ŒLearneræœåŠ¡å™¨çš„å®ä¾‹å¯ä»¥å¼€å§‹å¯åŠ¨äº†ã€‚</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010139.png"></p><p>Leaderå’ŒFollowerå¯åŠ¨çš„æ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºå¹¶å¯åŠ¨ä¼šè¯ç®¡ç†å™¨ã€‚</li><li>åˆå§‹åŒ–ZKçš„è¯·æ±‚å¤„ç†é“¾ã€‚</li><li>æ³¨å†ŒJMXæœåŠ¡ã€‚</li></ol><h2 id="å…­-Leaderé€‰ä¸¾"><a href="#å…­-Leaderé€‰ä¸¾" class="headerlink" title="å…­. Leaderé€‰ä¸¾"></a>å…­. Leaderé€‰ä¸¾</h2><h3 id="6-1-æ¦‚è¿°"><a href="#6-1-æ¦‚è¿°" class="headerlink" title="6.1 æ¦‚è¿°"></a>6.1 æ¦‚è¿°</h3><p>Leaderé€‰ä¸¾æ˜¯ä¿è¯åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„å…³é”®æ‰€åœ¨ã€‚</p><h4 id="ï¼ˆ1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶æœŸçš„Leaderé€‰ä¸¾"><a href="#ï¼ˆ1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶æœŸçš„Leaderé€‰ä¸¾" class="headerlink" title="ï¼ˆ1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶æœŸçš„Leaderé€‰ä¸¾"></a>ï¼ˆ1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶æœŸçš„Leaderé€‰ä¸¾</h4><p>å‡è®¾é›†ç¾¤æœ‰ä¸‰å°æœºå™¨ï¼Œé›†ç¾¤åˆå§‹åŒ–é˜¶æ®µåªæœ‰ä¸€å°æœºå™¨å¯åŠ¨æ—¶è¿˜ä¸èƒ½è¿›è¡ŒLeaderé€‰ä¸¾ï¼Œåªæœ‰å½“ç¬¬äºŒå°æœºå™¨å¯åŠ¨å¹¶èƒ½äº’ç›¸é€šä¿¡æ—¶ï¼Œæ‰èƒ½è¿›å…¥é€‰ä¸¾æµç¨‹ï¼š</p><ol><li><p><strong>æ¯ä¸ªServerä¼šå‘å‡ºä¸€ä¸ªæŠ•ç¥¨ã€‚</strong></p><p>æ¯å°æœºå™¨éƒ½æŠ•è‡ªå·±ï¼Œæ¯æ¬¡æŠ•ç¥¨åŒ…å«æœ€åŸºæœ¬å…ƒç´ ï¼šæ‰€æ¨ä¸¾çš„æœåŠ¡å™¨çš„myidå’ŒZXIDã€‚</p><p>æ‰€ä»¥ç»“æœæ˜¯ä¸¤ä¸ªæŠ•ç¥¨(1, 0)å’Œ(2, 0)åˆ†åˆ«å‘é€ç»™é›†ç¾¤çš„å…¶ä»–æœºå™¨ã€‚</p></li><li><p><strong>æ¥æ”¶æ¥è‡ªå„ä¸ªæœåŠ¡å™¨çš„æŠ•ç¥¨ã€‚</strong></p><p>æ¯ä¸ªæœåŠ¡å™¨æ”¶åˆ°æŠ•ç¥¨åï¼Œå…ˆåˆ¤æ–­æŠ•ç¥¨çš„æœ‰æ•ˆæ€§ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬è½®æŠ•ç¥¨ã€æ˜¯å¦æ¥è‡ªLOOKINGçŠ¶æ€çš„æœåŠ¡å™¨ã€‚</p></li><li><p><strong>å¤„ç†æŠ•ç¥¨ã€‚</strong></p><p>æ¯ä¸€ä¸ªæŠ•ç¥¨ï¼ŒæœåŠ¡å™¨éƒ½è¦å°†å…¶ä¸è‡ªå·±çš„æŠ•ç¥¨è¿›è¡ŒPKï¼Œè§„åˆ™ï¼š</p><ul><li>ä¼˜å…ˆæ£€æŸ¥ZXIDï¼Œè¾ƒå¤§çš„æœåŠ¡å™¨ä¼˜å…ˆä½œä¸ºLeaderã€‚</li><li>ZXIDç›¸åŒæ—¶æ¯”è¾ƒmyidï¼Œè¾ƒå¤§çš„æœåŠ¡å™¨ä¼˜å…ˆä½œä¸ºLeaderã€‚</li></ul><p>æ‰€ä»¥æ­¥éª¤1çš„ä¸¤ä¸ªæŠ•ç¥¨ä¸­åè€…myidè¾ƒå¤§ï¼ŒæœåŠ¡å™¨1å°†è‡ªå·±çš„æŠ•ç¥¨æ›´æ–°ä¸º(2, 0)ï¼ŒæœåŠ¡å™¨2åˆ™é‡å¤å†å‘ä¸€æ¬¡æŠ•ç¥¨ä¿¡æ¯ã€‚</p></li><li><p><strong>ç»Ÿè®¡æŠ•ç¥¨ã€‚</strong></p><p>æ¯æ¬¡æŠ•ç¥¨åï¼ŒæœåŠ¡å™¨éƒ½ä¼šç»Ÿè®¡æ‰€æœ‰æŠ•ç¥¨ï¼Œåˆ¤æ–­æ˜¯å¦å·²æœ‰è¿‡åŠçš„æœºå™¨æ”¶åˆ°ç›¸åŒçš„æŠ•ç¥¨ä¿¡æ¯ã€‚</p></li><li><p><strong>æ”¹å˜æœåŠ¡å™¨çŠ¶æ€ã€‚</strong></p><p>ä¸€æ—¦ç¡®å®šäº†Leaderï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¼šæ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼ŒFolloweræ›´æ–°ä¸ºFOLLOWINGï¼ŒLeaderæ›´æ–°ä¸ºLEADINGã€‚</p></li></ol><h4 id="ï¼ˆ2ï¼‰æœåŠ¡å™¨è¿è¡ŒæœŸé—´çš„Leaderé€‰ä¸¾"><a href="#ï¼ˆ2ï¼‰æœåŠ¡å™¨è¿è¡ŒæœŸé—´çš„Leaderé€‰ä¸¾" class="headerlink" title="ï¼ˆ2ï¼‰æœåŠ¡å™¨è¿è¡ŒæœŸé—´çš„Leaderé€‰ä¸¾"></a>ï¼ˆ2ï¼‰æœåŠ¡å™¨è¿è¡ŒæœŸé—´çš„Leaderé€‰ä¸¾</h4><p>å½“Leaderæ‰€åœ¨æœåŠ¡å™¨æŒ‚æ‰ï¼Œä¼šè¿›å…¥æ–°ä¸€è½®çš„Leaderé€‰ä¸¾ï¼š</p><ol><li><p><strong>å˜æ›´çŠ¶æ€ã€‚</strong></p><p>LeaderæŒ‚äº†ï¼Œæ‰€æœ‰éObserveræœåŠ¡å™¨å°†è‡ªå·±çŠ¶æ€æ›´æ–°ä¸ºLOOKINGã€‚</p></li><li><p><strong>æ¯ä¸ªServerä¼šå‘å‡ºä¸€ä¸ªæŠ•ç¥¨ã€‚</strong></p><p>ç”ŸæˆæŠ•ç¥¨ä¿¡æ¯(myid, ZXID)ï¼Œæ­¤æ—¶æœåŠ¡å™¨1å’Œ3äº§ç”ŸæŠ•ç¥¨(1, 123)å’Œ(3, 122)ï¼Œå‘é€ç»™å„ä¸ªæœºå™¨ã€‚</p></li><li><p><strong>æ¥æ”¶æ¥è‡ªå„ä¸ªæœåŠ¡å™¨çš„æŠ•ç¥¨ã€‚</strong></p></li><li><p><strong>å¤„ç†æŠ•ç¥¨ã€‚</strong></p><p>å’Œå¯åŠ¨é˜¶æ®µè§„åˆ™ä¸€è‡´ï¼ŒæœåŠ¡å™¨1ä¼šè¢«é€‰ä¸ºLeaderã€‚</p></li><li><p><strong>ç»Ÿè®¡æŠ•ç¥¨ã€‚</strong></p></li><li><p><strong>æ”¹å˜æœåŠ¡å™¨çŠ¶æ€ã€‚</strong></p></li></ol><h3 id="6-2-ç®—æ³•åˆ†æ"><a href="#6-2-ç®—æ³•åˆ†æ" class="headerlink" title="6.2 ç®—æ³•åˆ†æ"></a>6.2 ç®—æ³•åˆ†æ</h3><p>ZKæä¾›äº†ä¸‰ç§é€‰ä¸¾ç®—æ³•ï¼Œåœ¨ <code>zoo.cfg</code> çš„é…ç½®ä¸­ä½¿ç”¨ <code>electionAlg</code> å±æ€§æŒ‡å®šï¼š</p><ul><li><strong>LeaderElectionï¼š</strong>æ•°å­—0ï¼Œçº¯UDPå®ç°ã€‚</li><li><strong>AuthFastLeaderElectionï¼š</strong>æ•°å­—2ï¼ŒUDPç‰ˆæœ¬ï¼Œæˆæƒæ¨¡å¼ã€‚</li><li><strong>FastLeaderElectionï¼š</strong>æ•°å­—1è¡¨ç¤ºUDPç‰ˆæœ¬ï¼Œéæˆæƒæ¨¡å¼ï¼›æ•°å­—3è¡¨ç¤ºï¼ŒTCPç‰ˆæœ¬ï¼Œå½“å‰å”¯ä¸€é€‰æ‹©ã€‚</li></ul><h4 id="ï¼ˆ1ï¼‰æœ¯è¯­"><a href="#ï¼ˆ1ï¼‰æœ¯è¯­" class="headerlink" title="ï¼ˆ1ï¼‰æœ¯è¯­"></a>ï¼ˆ1ï¼‰æœ¯è¯­</h4><ul><li><strong>SIDï¼ˆæœåŠ¡å™¨IDï¼‰ï¼š</strong>å”¯ä¸€æ ‡è¯†ä¸€å°æœºå™¨ï¼Œä¸myidçš„å€¼ä¸€è‡´ã€‚</li><li><strong>ZXIDï¼ˆäº‹åŠ¡IDï¼‰ï¼š</strong>å”¯ä¸€æ ‡è¯†ä¸€æ¬¡æœåŠ¡å™¨çŠ¶æ€çš„å˜æ›´ï¼Œé›†ç¾¤ä¸­æ¯å°æœºå™¨çš„ä¸ä¸€å®šä¸€è‡´ã€‚</li><li><strong>Voteï¼ˆæŠ•ç¥¨ï¼‰ï¼š</strong>å½“æœºå™¨å‘ç°è‡ªå·±æ— æ³•æ£€æµ‹åˆ°Leaderæ—¶ï¼Œå°±ä¼šå°è¯•å¼€å§‹Leaderé€‰ä¸¾ã€‚</li><li><strong>Quorumï¼ˆè¿‡åŠæœºå™¨æ•°ï¼‰ï¼š</strong>é›†ç¾¤ä¸­æœºå™¨æ•°ä¸ºnï¼Œåˆ™ <code>quorum = (n / 2 + 1)</code> ã€‚</li></ul><h4 id="ï¼ˆ2ï¼‰ä½•æ—¶è¿›å…¥Leaderé€‰ä¸¾"><a href="#ï¼ˆ2ï¼‰ä½•æ—¶è¿›å…¥Leaderé€‰ä¸¾" class="headerlink" title="ï¼ˆ2ï¼‰ä½•æ—¶è¿›å…¥Leaderé€‰ä¸¾"></a>ï¼ˆ2ï¼‰ä½•æ—¶è¿›å…¥Leaderé€‰ä¸¾</h4><p>å½“æŸå°æœºå™¨å‡ºç°ä»»ä¸€æƒ…å†µï¼š</p><ul><li>æœåŠ¡å™¨åˆå§‹åŒ–å¯åŠ¨ã€‚</li><li>æœåŠ¡å™¨è¿è¡ŒæœŸé—´æ— æ³•å’ŒLeaderä¿æŒè¿æ¥ã€‚</li></ul><p>å½“ä¸€å°æœºå™¨è¿›å…¥é€‰ä¸¾æµç¨‹æ—¶ï¼Œé›†ç¾¤å¯èƒ½å¤„äºä¸¤ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p><ul><li><p>é›†ç¾¤æœ¬èº«å­˜åœ¨ä¸€ä¸ªLeaderã€‚</p><p>å¯èƒ½å› ä¸ºæŸå°æœºå™¨å¯åŠ¨è¾ƒæ™šï¼Œæ­¤æ—¶é€‰ä¸¾æµç¨‹å·²ç»“æŸï¼Œæ‰€ä»¥å½“å…¶å°è¯•é€‰ä¸¾Leaderæ—¶ä¼šè¢«å‘ŠçŸ¥å½“å‰LeaderæœåŠ¡å™¨çš„ä¿¡æ¯ã€‚æœºå™¨ä»…éœ€å’ŒLeaderå»ºç«‹è¿æ¥å¹¶åŒæ­¥çŠ¶æ€å³å¯ã€‚</p></li><li><p>é›†ç¾¤ç¡®å®å·²ä¸å­˜åœ¨Leaderã€‚</p></li></ul><h4 id="ï¼ˆ3ï¼‰å¼€å§‹ç¬¬ä¸€æ¬¡æŠ•ç¥¨"><a href="#ï¼ˆ3ï¼‰å¼€å§‹ç¬¬ä¸€æ¬¡æŠ•ç¥¨" class="headerlink" title="ï¼ˆ3ï¼‰å¼€å§‹ç¬¬ä¸€æ¬¡æŠ•ç¥¨"></a>ï¼ˆ3ï¼‰å¼€å§‹ç¬¬ä¸€æ¬¡æŠ•ç¥¨</h4><p>å¯¼è‡´é›†ç¾¤ä¸­ä¸å­˜åœ¨Leaderï¼š</p><ul><li>æœåŠ¡å™¨åˆšåˆå§‹åŒ–å¯åŠ¨ï¼Œå°šæœªäº§ç”Ÿä¸€å°LeaderæœåŠ¡å™¨ã€‚</li><li>è¿è¡ŒæœŸé—´LeaderæœåŠ¡å™¨æŒ‚æ‰ã€‚</li></ul><p>æ­¤æ—¶é›†ç¾¤æ‰€æœ‰æœºå™¨éƒ½å¤„äºLOOKINGçŠ¶æ€ï¼Œå°è¯•å¯»æ‰¾Leaderã€‚å½“ä¸€å°æœºå™¨å¤„äºæ­¤çŠ¶æ€ï¼Œä¼šå‘é›†ç¾¤å…¶å®ƒæœºå™¨å‘é€æŠ•ç¥¨æ¶ˆæ¯(SID, ZXID)ã€‚</p><p>é¦–æ¬¡æŠ•ç¥¨æ‰€æœ‰æœºå™¨éƒ½ä¼šé€‰ä¸¾è‡ªå·±ã€‚</p><h4 id="ï¼ˆ4ï¼‰å˜æ›´æŠ•ç¥¨"><a href="#ï¼ˆ4ï¼‰å˜æ›´æŠ•ç¥¨" class="headerlink" title="ï¼ˆ4ï¼‰å˜æ›´æŠ•ç¥¨"></a>ï¼ˆ4ï¼‰å˜æ›´æŠ•ç¥¨</h4><p>æ¯å°æœºå™¨å‘é€å®Œè‡ªå·±çš„æŠ•ç¥¨ï¼Œä¹Ÿä¼šæ¥æ”¶åˆ°å…¶å®ƒæœºå™¨çš„æŠ•ç¥¨ã€‚æ ¹æ®æŠ•ç¥¨è§„åˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦å˜æ›´è‡ªå·±çš„æŠ•ç¥¨ã€‚</p><p>æœ¯è¯­ï¼š</p><ul><li><strong>vote_sidï¼š</strong>æ¥æ”¶åˆ°çš„æŠ•ç¥¨ä¸­çš„æœåŠ¡å™¨SIDã€‚</li><li><strong>vote_zxidï¼š</strong>æ¥æ”¶åˆ°çš„æŠ•ç¥¨ä¸­çš„æœåŠ¡å™¨ZXIDã€‚</li><li><strong>self_sidï¼š</strong>æœåŠ¡å™¨è‡ªå·±çš„SIDã€‚</li><li><strong>self_zxidï¼š</strong>æœåŠ¡å™¨è‡ªå·±çš„ZXIDã€‚</li></ul><p>è§„åˆ™ï¼š</p><ol><li>å¦‚æœvote_zxidå¤§äºself_zxidï¼Œè®¤å¯å½“å‰æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œå†æ¬¡å°†å…¶å‘é€å‡ºå»ä»£è¡¨è‡ªå·±æ–°ä¸€è½®çš„æŠ•ç¥¨ã€‚</li><li>å¦‚æœvote_zxidå°äºself_zxidï¼ŒåšæŒè‡ªå·±çš„æŠ•ç¥¨ï¼Œä¸åšä»»ä½•å˜æ›´ã€‚</li><li>å¦‚æœvote_zxidç­‰äºself_zxidï¼Œå¯¹æ¯”äºŒè€…çš„SIDï¼Œå¦‚æœvote_sidå¤§äºself_sidï¼Œè®¤å¯å½“å‰æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œå†æ¬¡å°†å…¶å‘é€å‡ºå»ä»£è¡¨è‡ªå·±æ–°ä¸€è½®çš„æŠ•ç¥¨ã€‚</li><li>å¦‚æœvote_zxidç­‰äºself_zxidï¼Œä¸”vote_sidå°äºself_sidï¼ŒåšæŒè‡ªå·±çš„æŠ•ç¥¨ï¼Œä¸åšä»»ä½•å˜æ›´ã€‚</li></ol><p>å‡è®¾é›†ç¾¤æœ‰5å°æœºå™¨ï¼ŒSIDä¸º(1,2,3,4,5)ï¼ŒZXIDä¸º(9,9,9,8,8)ï¼Œæ­¤æ—¶SIDä¸º2çš„æœºå™¨ä¸ºLeaderï¼Œä¸”1å’Œ2åŒæ—¶æŒ‚æ‰ï¼Œç”±æ­¤å¼€å§‹Leaderé€‰ä¸¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010140.png"></p><h4 id="ï¼ˆ5ï¼‰ç¡®å®šLeader"><a href="#ï¼ˆ5ï¼‰ç¡®å®šLeader" class="headerlink" title="ï¼ˆ5ï¼‰ç¡®å®šLeader"></a>ï¼ˆ5ï¼‰ç¡®å®šLeader</h4><p>ç»è¿‡ç¬¬äºŒæ¬¡æŠ•ç¥¨åï¼Œé›†ç¾¤ä¸­æ¯å°æœºå™¨éƒ½ä¼šå†æ¬¡æ”¶åˆ°å…¶ä»–æœºå™¨çš„æŠ•ç¥¨ï¼Œå¹¶è¿›è¡Œç»Ÿè®¡ï¼Œå½“ä¸€å°æœºå™¨æ”¶åˆ°äº†è¶…è¿‡åŠæ•°ç›¸åŒçš„æŠ•ç¥¨ï¼Œå…¶å°±ç§°ä¸ºæ–°çš„Leaderã€‚</p><p>ä¸Šè¿°æ¡ˆä¾‹ä¸­quorumä¸º3ï¼Œåªè¦æ”¶åˆ°3ä¸ªå³å¯ã€‚</p><h3 id="6-3-å®ç°ç»†èŠ‚"><a href="#6-3-å®ç°ç»†èŠ‚" class="headerlink" title="6.3 å®ç°ç»†èŠ‚"></a>6.3 å®ç°ç»†èŠ‚</h3><p>ä¸Šè¿°FastLeaderElectioné€‰ä¸¾ç®—æ³•å¹¶ä¸å¤æ‚ï¼Œä½†å®é™…å®ç°æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦è§£å†³ã€‚</p><h4 id="ï¼ˆ1ï¼‰æœåŠ¡å™¨çŠ¶æ€"><a href="#ï¼ˆ1ï¼‰æœåŠ¡å™¨çŠ¶æ€" class="headerlink" title="ï¼ˆ1ï¼‰æœåŠ¡å™¨çŠ¶æ€"></a>ï¼ˆ1ï¼‰æœåŠ¡å™¨çŠ¶æ€</h4><p><code>org.apache.zookeeper.server.quorum.QuorumPeer.ServerState</code> ç±»ä¸­åˆ—ä¸¾äº†4ç§æœåŠ¡å™¨çŠ¶æ€ï¼š</p><ul><li><strong>LOOKINGï¼š</strong>å¯»æ‰¾LeaderçŠ¶æ€ï¼ŒæœåŠ¡å™¨åœ¨æ­¤çŠ¶æ€æ—¶ä¼šè®¤ä¸ºé›†ç¾¤æ²¡æœ‰Leaderï¼Œéœ€è¦è¿›å…¥Leaderé€‰ä¸¾æµç¨‹ã€‚</li><li><strong>FOLLOWINGï¼š</strong>è·Ÿéšè€…çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æœºå™¨ä¸ºFollowerã€‚</li><li><strong>LEADINGï¼š</strong>é¢†å¯¼è€…çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æœºå™¨ä¸ºLeaderã€‚</li><li><strong>OBSERVINGï¼š</strong>è§‚å¯Ÿè€…çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æœºå™¨ä¸ºObserverã€‚</li></ul><h4 id="ï¼ˆ2ï¼‰æŠ•ç¥¨çš„æ•°æ®ç»“æ„"><a href="#ï¼ˆ2ï¼‰æŠ•ç¥¨çš„æ•°æ®ç»“æ„" class="headerlink" title="ï¼ˆ2ï¼‰æŠ•ç¥¨çš„æ•°æ®ç»“æ„"></a>ï¼ˆ2ï¼‰æŠ•ç¥¨çš„æ•°æ®ç»“æ„</h4><p><code>org.apache.zookeeper.server.quorum.Vote</code> ç±»çš„æ•°æ®ç»“æ„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010142.png"></p><h4 id="ï¼ˆ3ï¼‰QuorumCnxManager-ç½‘ç»œI-Oç®¡ç†è€…"><a href="#ï¼ˆ3ï¼‰QuorumCnxManager-ç½‘ç»œI-Oç®¡ç†è€…" class="headerlink" title="ï¼ˆ3ï¼‰QuorumCnxManager-ç½‘ç»œI/Oç®¡ç†è€…"></a>ï¼ˆ3ï¼‰QuorumCnxManager-ç½‘ç»œI/Oç®¡ç†è€…</h4><p>ClientCnxnæ˜¯ZKå®¢æˆ·ç«¯ä¸­ç”¨äºå¤„ç†ç½‘ç»œI/Oçš„ç®¡ç†å™¨ï¼ŒLeaderé€‰ä¸¾ä¸­ç±»ä¼¼è§’è‰²å°±æ˜¯QuorumCnxManagerï¼Œè´Ÿè´£å„å°æœåŠ¡å™¨ä¹‹é—´çš„åº•å±‚Leaderé€‰ä¸¾è¿‡ç¨‹ä¸­çš„ç½‘ç»œé€šä¿¡ã€‚</p><p>å…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ç³»åˆ—çš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ¥æ”¶åˆ°çš„ã€å¾…å‘é€çš„æ¶ˆæ¯ï¼Œä»¥åŠæ¶ˆæ¯çš„å‘é€å™¨ã€‚æ¯ä¸ªé˜Ÿåˆ—éƒ½æŒ‰SIDåˆ†ç»„å½¢æˆé˜Ÿåˆ—é›†åˆï¼Œä¿è¯æ¯å°æœåŠ¡å™¨ä¹‹é—´äº’ä¸å¹²æ‰°ã€‚</p><ul><li><strong>recvQueueï¼š</strong>æ¶ˆæ¯æ¥æ”¶é˜Ÿåˆ—ï¼Œå­˜æ”¾ä»å…¶ä»–æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</li><li><strong>queueSendMapï¼š</strong>æ¶ˆæ¯å‘é€é˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…å‘é€çš„æ¶ˆæ¯ã€‚è¯¥MapæŒ‰SIDè¿›è¡Œåˆ†ç»„ï¼Œä¸ºé›†ç¾¤ä¸­æ¯å°æœºå™¨åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œä¿è¯æœºå™¨ä¹‹é—´çš„æ¶ˆæ¯äº’ä¸å½±å“ã€‚</li><li><strong>senderWorkerMapï¼š</strong>å‘é€å™¨é›†åˆï¼Œæ¯ä¸ªSendWorkeræ¶ˆæ¯å‘é€å™¨ï¼Œéƒ½å¯¹åº”ä¸€å°è¿œç¨‹ZooKeeperæœåŠ¡å™¨ï¼Œè´Ÿè´£æ¶ˆæ¯çš„å‘é€ã€‚ä¹ŸæŒ‰SIDè¿›è¡Œäº†åˆ†ç»„ã€‚</li><li><strong>lastMessageSentï¼š</strong>æœ€è¿‘å‘é€è¿‡çš„æ¶ˆæ¯ï¼Œä¸ºæ¯ä¸ªSIDä¿ç•™æœ€è¿‘å‘é€è¿‡çš„ä¸€ä¸ªæ¶ˆæ¯ã€‚</li></ul><p>ZKä¸­æ‰€æœ‰æœºå™¨éƒ½è¦ä¸¤ä¸¤åˆ›å»ºç½‘ç»œè¿æ¥ï¼Œæ‰€ä»¥QuorumCnxManagerå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ª<strong>ServerSocket</strong>ç›‘å¬Leaderé€‰ä¸¾çš„é€šä¿¡ç«¯å£ï¼ˆé»˜è®¤3888ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šä¸æ–­æ¥æ”¶åˆ°å…¶å®ƒæœåŠ¡å™¨çš„åˆ›å»ºè¿æ¥è¯·æ±‚ã€‚è¿™ç±»TCPè¿æ¥è¯·æ±‚ä¼š<strong>äº¤ç”±receiveConnectionæ–¹æ³•è¿›è¡Œå¤„ç†</strong>ã€‚</p><p>ä¸ºäº†é¿å…ä¸¤æ¡æœºå™¨é‡å¤åˆ›å»ºTCPè¿æ¥ï¼ŒZKè®¾è®¡äº†è§„åˆ™ï¼š<strong>åªå…è®¸SIDå¤§çš„æœåŠ¡å™¨ä¸»åŠ¨å’Œå…¶ä»–æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¦åˆ™æ–­å¼€è¿æ¥</strong>ã€‚æ‰€ä»¥receiveConnectionæ–¹æ³•ä¸­ä¼šæ¯”å¯¹è‡ªå·±å’Œè¿œç¨‹æœåŠ¡å™¨çš„SIDå€¼ï¼Œå½“è‡ªå·±æ›´å¤§æ—¶æ–­å¼€è¿æ¥å¹¶ä¸»åŠ¨å‘é€è¿æ¥è¯·æ±‚ï¼Œå¦åˆ™æ¥å—è¿æ¥è¯·æ±‚ã€‚</p><p>ä¸€æ—¦è¿æ¥å»ºç«‹ï¼Œå°±ä¼šæ ¹æ®è¿œç¨‹æœåŠ¡å™¨çš„SIDåˆ›å»ºå¯¹åº”çš„æ¶ˆæ¯å‘é€å™¨SendWorkerå’Œæ¥æ”¶å™¨RecvWorkerå¹¶å¯åŠ¨ã€‚</p><ul><li><strong>æ¶ˆæ¯æ¥æ”¶ï¼š</strong>RecvWorkerä»å¯¹åº”TCPè¿æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå°†å…¶æ”¾åˆ°recvQueueä¸­ã€‚</li><li><strong>æ¶ˆæ¯å‘é€ï¼š</strong>SendWorkerä¸æ–­ä»queueSendMapå¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºä¸€ä¸ªæ¶ˆæ¯å‘é€ï¼ŒåŒæ—¶å°†å…¶æ”¾å…¥lastMessageSentè®°å½•ã€‚ï¼ˆæ³¨æ„ï¼š<strong>å½“æ¶ˆæ¯å‘é€é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šä»lastMessageSentå–å‡ºä¸€ä¸ªæœ€è¿‘å‘é€çš„æ¶ˆæ¯å†æ¬¡å‘é€ï¼Œä¸»è¦ä¸ºäº†è§£å†³åˆ†å¸ƒå¼é—®é¢˜ï¼šæ¥æ”¶æ–¹åœ¨æ¶ˆæ¯æ¥æ”¶å‰æˆ–æ¥æ”¶åˆ°æ¶ˆæ¯åæŒ‚æ‰ï¼Œå¯¼è‡´æ¶ˆæ¯è¿˜æœªè¢«æ­£ç¡®å¤„ç†ã€‚å½“ç„¶ZKä¹Ÿä¿è¯äº†æ¥æ”¶æ–¹å¯¹é‡å¤æ¶ˆæ¯è¿›è¡Œäº†æ­£ç¡®çš„å¤„ç†</strong>ï¼‰</li></ul><h4 id="ï¼ˆ4ï¼‰FastLeaderElectionæ ¸å¿ƒ"><a href="#ï¼ˆ4ï¼‰FastLeaderElectionæ ¸å¿ƒ" class="headerlink" title="ï¼ˆ4ï¼‰FastLeaderElectionæ ¸å¿ƒ"></a>ï¼ˆ4ï¼‰FastLeaderElectionæ ¸å¿ƒ</h4><p>æœ¯è¯­ï¼š</p><ul><li><strong>å¤–éƒ¨æŠ•ç¥¨ï¼š</strong>å…¶ä»–æœåŠ¡å™¨å‘æ¥çš„æŠ•ç¥¨ã€‚</li><li><strong>å†…éƒ¨æŠ•ç¥¨ï¼š</strong>æœåŠ¡å™¨è‡ªèº«å½“å‰çš„æŠ•ç¥¨ã€‚</li><li><strong>é€‰ä¸¾è½®æ¬¡ï¼š</strong>Leaderé€‰ä¸¾çš„è½®æ¬¡ï¼Œå³logicalClockã€‚</li><li><strong>PKï¼š</strong>æŒ‡å¯¹å†…éƒ¨å’Œå¤–éƒ¨æŠ•ç¥¨è¿›è¡Œå¯¹æ¯”ï¼Œæ¥ç¡®è®¤æ˜¯å¦éœ€è¦å˜æ›´å†…éƒ¨æŠ•ç¥¨ã€‚</li></ul><p>é€‰ç¥¨ç®¡ç†ï¼š</p><ul><li><strong>sendqueueï¼š</strong>é€‰ç¥¨å‘é€é˜Ÿåˆ—ï¼Œä¿å­˜å¾…å‘é€çš„é€‰ç¥¨ã€‚</li><li><strong>recvqueueï¼š</strong>é€‰ç¥¨æ¥æ”¶é˜Ÿåˆ—ï¼Œä¿å­˜æ¥æ”¶åˆ°çš„å¤–éƒ¨æŠ•ç¥¨ã€‚</li><li><strong>WorkerReceiverï¼š</strong>é€‰ç¥¨æ¥æ”¶å™¨ï¼Œä¸æ–­ä»QuorumCnxManagerä¸­è·å–å…¶ä»–æœåŠ¡å™¨å‘æ¥çš„é€‰ä¸¾æ¶ˆæ¯ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªé€‰ç¥¨ï¼Œå¹¶ä¿å­˜åˆ°recvqueueã€‚<ul><li>åœ¨é€‰ç¥¨æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç°å…¶é€‰ä¸¾è½®æ¬¡å°äºå½“å‰æœåŠ¡å™¨å°±ç›´æ¥å¿½ç•¥ï¼Œå¹¶ç«‹å³å‘é€å†…éƒ¨æŠ•ç¥¨ã€‚</li><li>å½“å‰æœåŠ¡å™¨ä¸æ˜¯LOOKINGçŠ¶æ€ï¼Œè¡¨ç¤ºå·²é€‰å‡ºLeaderï¼ŒåŒæ ·ç›´æ¥å¿½ç•¥ï¼Œå¹¶ç«‹å³å‘é€å†…éƒ¨æŠ•ç¥¨ã€‚</li><li>æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ¥è‡ªäºObserverï¼ŒåŒæ ·ç›´æ¥å¿½ç•¥ï¼Œå¹¶ç«‹å³å‘é€å†…éƒ¨æŠ•ç¥¨ã€‚</li></ul></li><li><strong>WorkerSenderï¼š</strong>é€‰ç¥¨å‘é€å™¨ï¼Œä¸æ–­ä»sendqueueè·å–é€‰ç¥¨å¹¶å°†å…¶ä¼ é€’ç»™åº•å±‚QuorumCnxManagerã€‚</li></ul><p>é€‰ç¥¨ç®¡ç†ä¸QuorumCnxManageråœ¨Leaderé€‰ä¸¾ä¸­çš„å…³ç³»ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010143.png"></p><p>Leaderé€‰ä¸¾ç®—æ³•æ•´ä½“æµç¨‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010144.png"></p><p>ä¸Šè¿°å…¶å®æ˜¯ lookForLeaderæ–¹æ³•çš„å†…éƒ¨é€»è¾‘ï¼š</p><ol><li><p><strong>è‡ªå¢é€‰ä¸¾è½®æ¬¡ã€‚</strong></p><p>FastLeaderElectionçš„å®ç°ä¸­æœ‰ä¸€ä¸ªå±æ€§logicalclockï¼Œç”¨äºæ ‡è¯†å½“å‰Leaderçš„é€‰ä¸¾è½®æ¬¡ï¼Œå¼€å§‹æ–°ä¸€è½®æŠ•ç¥¨æ—¶ä¼šå…ˆå°†å…¶è‡ªå¢ã€‚</p></li><li><p><strong>åˆå§‹åŒ–é€‰ç¥¨ã€‚</strong></p><p>å¼€å§‹æ–°ä¸€è½®æŠ•ç¥¨å‰ï¼Œæ¯å°æœåŠ¡å™¨è¦å…ˆåˆå§‹åŒ–è‡ªå·±çš„é€‰ç¥¨ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–Voteçš„å„ä¸ªå±æ€§ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010145.png"></p></li><li><p><strong>å‘é€åˆå§‹åŒ–é€‰ç¥¨ã€‚</strong></p><p>å®Œæˆé€‰ç¥¨çš„åˆå§‹åŒ–åï¼Œå°±ä¼šå‘èµ·ç¬¬ä¸€æ¬¡æŠ•ç¥¨ã€‚é€‰ç¥¨è¢«æ”¾å…¥sendqueueä¸­ï¼Œç”±WorkerSenderè´Ÿè´£å‘é€å‡ºå»ã€‚</p></li><li><p><strong>æ¥æ”¶å¤–éƒ¨æŠ•ç¥¨ã€‚</strong></p><p>æ¯å°æœåŠ¡å™¨ä¼šä¸æ–­ä»recvqueueä¸­è·å–å¤–éƒ¨æŠ•ç¥¨ï¼Œå½“æœåŠ¡å™¨å‘ç°è‡ªå·±æ— æ³•è·å–ä»»ä½•å¤–éƒ¨æŠ•ç¥¨ï¼Œä¼šç«‹åˆ»ç¡®è®¤è‡ªå·±æ˜¯å¦å’Œé›†ç¾¤å…¶å®ƒæœåŠ¡å™¨ä¿æŒè¿æ¥ã€‚è‹¥æ²¡æœ‰å°±ç«‹å³å»ºç«‹è¿æ¥ï¼Œå¦‚å·²æœ‰åˆ™å†æ¬¡å‘é€è‡ªå·±çš„å†…éƒ¨æŠ•ç¥¨ã€‚</p></li><li><p><strong>åˆ¤æ–­é€‰ä¸¾è½®æ¬¡ã€‚</strong></p><p>å‘é€å®Œåˆå§‹åŒ–é€‰ç¥¨ï¼Œå°±è¦å¤„ç†å¤–éƒ¨æŠ•ç¥¨ã€‚éœ€è¦æ ¹æ®é€‰ä¸¾è½®æ¬¡çš„ä¸åŒè¿›è¡Œä¸åŒçš„å¤„ç†ï¼š</p><ul><li><strong>å¤–éƒ¨æŠ•ç¥¨çš„è½®æ¬¡å¤§äºå†…éƒ¨æŠ•ç¥¨ï¼š</strong>ç«‹å³æ›´æ–°è‡ªå·±çš„é€‰ä¸¾è½®æ¬¡ï¼Œå¹¶æ¸…ç©ºæ‰€æœ‰å·²ç»æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œç„¶åä½¿ç”¨åˆå§‹åŒ–æŠ•ç¥¨è¿›è¡ŒPKæ¥ç¡®å®šæ˜¯å¦å˜æ›´å†…éƒ¨æŠ•ç¥¨ï¼Œæœ€ç»ˆå†å°†æŠ•ç¥¨å‘é€å‡ºå»ã€‚</li><li><strong>å¤–éƒ¨æŠ•ç¥¨çš„è½®æ¬¡å°äºå†…éƒ¨æŠ•ç¥¨ï¼š</strong>ç›´æ¥å¿½ç•¥è¯¥æŠ•ç¥¨ï¼Œè¿”å›æ­¥éª¤4ã€‚</li><li><strong>å¤–éƒ¨æŠ•ç¥¨çš„è½®æ¬¡ç­‰äºå†…éƒ¨æŠ•ç¥¨ï¼š</strong>è¿›è¡Œé€‰ç¥¨PKã€‚</li></ul></li><li><p><strong>é€‰ç¥¨PKã€‚</strong></p><p>å³ <code>FastLeaderElection.totalOrderPredicate</code> æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ã€‚ä¸»è¦ä»é€‰ä¸¾è½®æ¬¡ã€ZXIDå’ŒSIDä¸‰ä¸ªå› ç´ è€ƒè™‘ï¼š</p><ul><li>å¦‚æœå¤–éƒ¨æŠ•ç¥¨ä¸­è¢«æ¨ä¸¾çš„LeaderæœåŠ¡å™¨çš„é€‰ä¸¾è½®æ¬¡å¤§äºå†…éƒ¨æŠ•ç¥¨ï¼Œéœ€è¦è¿›è¡ŒæŠ•ç¥¨å˜æ›´ã€‚</li><li>é€‰ä¸¾è½®æ¬¡ä¸€è‡´ï¼Œåˆ™å¯¹æ¯”ZXIDï¼Œå¦‚æœå¤–éƒ¨æŠ•ç¥¨è¾ƒå¤§å°±éœ€è¦è¿›è¡ŒæŠ•ç¥¨å˜æ›´ã€‚</li><li>ZXIDä¸€è‡´ï¼Œåˆ™å¯¹æ¯”SIDï¼Œå¦‚æœå¤–éƒ¨æŠ•ç¥¨è¾ƒå¤§å°±éœ€è¦è¿›è¡ŒæŠ•ç¥¨å˜æ›´ã€‚</li></ul></li><li><p><strong>å˜æ›´æŠ•ç¥¨ã€‚</strong></p><p>é€‰ç¥¨PKåç¡®å®šå¦‚æœéœ€è¦è¿›è¡ŒæŠ•ç¥¨å˜æ›´ï¼Œè¦å°†å¤–éƒ¨æŠ•ç¥¨çš„é€‰ç¥¨ä¿¡æ¯è¦†ç›–å†…éƒ¨æŠ•ç¥¨ã€‚å˜æ›´å®Œæˆåå†å°†å…¶å‘é€å‡ºå»ã€‚</p></li><li><p><strong>é€‰ç¥¨å½’æ¡£ã€‚</strong></p><p>æ— è®ºæ˜¯å¦è¿›è¡Œäº†æŠ•ç¥¨å˜æ›´ï¼Œéƒ½è¦å°†æ”¶åˆ°çš„å¤–éƒ¨æŠ•ç¥¨æ”¾å…¥recvsetä¸­è¿›è¡Œå½’æ¡£ã€‚å…¶ç”¨äºè®°å½•å½“å‰æœåŠ¡å™¨åœ¨æœ¬è½®æ¬¡æ”¶åˆ°çš„æ‰€æœ‰å¤–éƒ¨æŠ•ç¥¨ï¼Œå¹¶ä¼šæŒ‰SIDè¿›è¡ŒåŒºåˆ†ï¼Œå¦‚ <code>&#123;(1, vote1),(2, vote2),...&#125;</code> ã€‚</p></li><li><p><strong>ç»Ÿè®¡æŠ•ç¥¨ã€‚</strong></p><p>å®Œæˆé€‰ç¥¨å½’æ¡£åï¼Œå¯ä»¥å¼€å§‹æŠ•ç¥¨çš„ç»Ÿè®¡ã€‚ä¸€æ—¦ç»Ÿè®¡å‡ºæœ‰è¿‡åŠæœåŠ¡å™¨è®¤å¯äº†å½“å‰å†…éƒ¨æŠ•ç¥¨ï¼Œå°±ç»ˆæ­¢æŠ•ç¥¨ï¼Œå¦åˆ™è¿”å›æ­¥éª¤4ã€‚</p></li><li><p><strong>æ›´æ–°æœåŠ¡å™¨çŠ¶æ€ã€‚</strong></p><p>å½“ç»Ÿè®¡æŠ•ç¥¨ç¡®å®šå¯ä»¥ç»ˆæ­¢æŠ•ç¥¨ï¼Œå¼€å§‹æ›´æ–°æœåŠ¡å™¨çŠ¶æ€ã€‚å¦‚æœåˆ¤æ–­è¿‡åŠæœåŠ¡å™¨è®¤å¯ï¼Œå°±ä¼šæ›´æ–°ä¸ºLEADINGã€‚å¦åˆ™æ ¹æ®å…·ä½“æƒ…å†µæ›´æ–°ä¸ºFOLLOWINGæˆ–OBSERVINGã€‚æ­¥éª¤9åˆ°æ­¥éª¤10å¯èƒ½ä¼šæœ‰ä¸€æ®µæ—¶é—´å»¶è¿Ÿæ¥ç¡®è®¤æ˜¯å¦æœ‰æ–°çš„æ›´ä¼˜çš„æŠ•ç¥¨ï¼ˆé»˜è®¤200æ¯«ç§’ï¼‰ã€‚</p></li></ol><h2 id="ä¸ƒ-å„æœåŠ¡å™¨è§’è‰²ä»‹ç»"><a href="#ä¸ƒ-å„æœåŠ¡å™¨è§’è‰²ä»‹ç»" class="headerlink" title="ä¸ƒ. å„æœåŠ¡å™¨è§’è‰²ä»‹ç»"></a>ä¸ƒ. å„æœåŠ¡å™¨è§’è‰²ä»‹ç»</h2><h3 id="7-1-Leader"><a href="#7-1-Leader" class="headerlink" title="7.1 Leader"></a>7.1 Leader</h3><p>Leaderçš„ä¸»è¦å·¥ä½œï¼š</p><ul><li>äº‹åŠ¡è¯·æ±‚çš„å”¯ä¸€è°ƒåº¦å’Œå¤„ç†è€…ï¼Œä¿è¯é›†ç¾¤äº‹åŠ¡å¤„ç†çš„é¡ºåºæ€§ã€‚</li><li>é›†ç¾¤å†…éƒ¨å„æœåŠ¡å™¨çš„è°ƒåº¦è€…ã€‚</li></ul><p>ZKä½¿ç”¨<strong>è´£ä»»é“¾æ¨¡å¼</strong>å¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¯·æ±‚å¤„ç†é“¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010146.png"></p><blockquote><p>äº‹åŠ¡è¯·æ±‚ï¼šæŒ‡ä¼šæ”¹å˜æœåŠ¡å™¨çŠ¶æ€çš„ä¸€ç³»åˆ—è¯·æ±‚ï¼Œå¦‚åˆ›å»ºèŠ‚ç‚¹ã€æ›´æ–°æ•°æ®ã€åˆ é™¤èŠ‚ç‚¹ä»¥åŠåˆ›å»ºä¼šè¯ç­‰ã€‚</p></blockquote><ul><li><p><strong>PrepRequestProcessorï¼š</strong>è¯·æ±‚é¢„å¤„ç†å™¨ï¼Œæ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨ã€‚å…¶èƒ½è¯†åˆ«å‡ºå½“å‰å®¢æˆ·ç«¯è¯·æ±‚æ˜¯å¦ä¸ºäº‹åŠ¡è¯·æ±‚ã€‚å¦‚æœæ˜¯åˆ™è¿›è¡Œä¸€ç³»åˆ—é¢„å¤„ç†ï¼Œå¦‚åˆ›å»ºè¯·æ±‚äº‹åŠ¡å¤´ã€äº‹åŠ¡ä½“ã€ä¼šè¯æ£€æŸ¥ã€ACLæ£€æŸ¥å’Œç‰ˆæœ¬æ£€æŸ¥ç­‰ã€‚</p></li><li><p><strong>ProposalRequestProcessorï¼š</strong>äº‹åŠ¡æŠ•ç¥¨å¤„ç†å™¨ï¼ŒLeaderæœåŠ¡å™¨äº‹åŠ¡å¤„ç†æµç¨‹çš„å‘èµ·è€…ã€‚</p><ul><li>å…¶ä¼šå°†éäº‹åŠ¡è¯·æ±‚æµè½¬åˆ°CommitProcessorï¼Œä¸å†åšå…¶ä»–å¤„ç†ï¼›</li><li>äº‹åŠ¡è¯·æ±‚é™¤äº†äº¤ç»™CommitProcessorå¤–ï¼Œè¿˜ä¼šæ ¹æ®è¯·æ±‚ç±»å‹åˆ›å»ºå¯¹åº”çš„Proposalæè®®ï¼Œå¹¶å‘é€ç»™æ‰€æœ‰çš„FolloweræœåŠ¡å™¨ä»è€Œå‘èµ·ä¸€æ¬¡é›†ç¾¤å†…äº‹åŠ¡æŠ•ç¥¨ã€‚</li><li>åŒæ—¶è¿˜ä¼šå°†äº‹åŠ¡è¯·æ±‚äº¤ä»˜ç»™SyncRequestProcessorè¿›è¡Œäº‹åŠ¡æ—¥å¿—çš„è®°å½•ã€‚</li></ul></li><li><p><strong>SyncRequestProcessorï¼š</strong>äº‹åŠ¡æ—¥å¿—è®°å½•å¤„ç†å™¨ï¼Œä¸»è¦ç”¨æ¥å°†äº‹åŠ¡è¯·æ±‚è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶è§¦å‘ZKè¿›è¡Œæ•°æ®å¿«ç…§ã€‚</p></li><li><p><strong>AckRequestProcessorï¼š</strong>è´Ÿè´£åœ¨SyncRequestProcessorå¤„ç†å™¨å®Œæˆäº‹åŠ¡æ—¥å¿—è®°å½•åï¼Œå‘Proposalçš„æŠ•ç¥¨æ”¶é›†å™¨å‘é€ACKåé¦ˆï¼Œä»¥é€šçŸ¥æŠ•ç¥¨æ”¶é›†å™¨å½“å‰æœåŠ¡å™¨å·²ç»å®Œæˆäº†å¯¹è¯¥Proposalçš„äº‹åŠ¡æ—¥å¿—è®°å½•ã€‚</p></li><li><p><strong>CommitProcessorï¼š</strong> äº‹åŠ¡æäº¤å¤„ç†å™¨ï¼Œä½¿æœåŠ¡å™¨éƒ½å¯ä»¥æ§åˆ¶å¯¹äº‹åŠ¡è¯·æ±‚çš„é¡ºåºå¤„ç†ã€‚</p><ul><li>éäº‹åŠ¡è¯·æ±‚ï¼Œè¯¥å¤„ç†å™¨ä¼šç›´æ¥å°†å…¶äº¤ä»˜ç»™ä¸‹ä¸€çº§å¤„ç†å™¨ï¼›</li><li>äº‹åŠ¡è¯·æ±‚ï¼Œå…¶ä¼šç­‰å¾…é›†ç¾¤å†…é’ˆå¯¹Proposalçš„æŠ•ç¥¨ç›´åˆ°å…¶å¯è¢«æäº¤ã€‚</li></ul></li><li><p><strong>ToBeCommitProcessorï¼š</strong>ç‰¹æ®Šçš„å¤„ç†å™¨ï¼Œæœ‰ä¸€ä¸ªtoBeAppliedé˜Ÿåˆ—ï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å·²è¢«CommitProcessorå¤„ç†è¿‡çš„å¯è¢«æäº¤çš„Proposalã€‚</p><p>å°†è¿™äº›è¯·æ±‚é€ä¸ªäº¤ä»˜ç»™FinalRequestProcessorè¿›è¡Œå¤„ç†ï¼Œå¾…å…¶å¤„ç†å®Œæ¯•åå†ä»toBeAppliedä¸­ç§»é™¤ã€‚</p></li><li><p><strong>FinalRequestProcessorï¼š</strong>æœ€åä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨ï¼Œä¸»è¦ç”¨æ¥è¿›è¡Œå®¢æˆ·ç«¯è¯·æ±‚è¿”å›ä¹‹å‰çš„æ”¶å°¾å·¥ä½œï¼ŒåŒ…æ‹¬åˆ›å»ºå®¢æˆ·ç«¯è¯·æ±‚çš„å“åº”ï¼›é’ˆå¯¹äº‹åŠ¡è¯·æ±‚ï¼Œè¯¥å¤„ç†å™¨è¿˜ä¼šè´Ÿè´£å°†äº‹åŠ¡åº”ç”¨åˆ°å†…å­˜æ•°æ®åº“ä¸­ã€‚</p></li></ul><p>LeaderæœåŠ¡å™¨ä¼šä¸æ‰€æœ‰å…¶ä»–æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªTCPé•¿è¿æ¥ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªåä¸ºLearnerHandlerçš„å®ä½“ï¼Œæ˜¯ZKé›†ç¾¤ä¸­LearneræœåŠ¡å™¨çš„ç®¡ç†å™¨ï¼Œè´Ÿè´£LearneræœåŠ¡å™¨ä¸LeaderæœåŠ¡å™¨ä¹‹é—´çš„ä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡ï¼ŒåŒ…æ‹¬æ•°æ®åŒæ­¥ã€è¯·æ±‚è½¬å‘å’ŒProposalæè®®çš„æŠ•ç¥¨ç­‰ã€‚</p><h3 id="7-2-Follower"><a href="#7-2-Follower" class="headerlink" title="7.2 Follower"></a>7.2 Follower</h3><p>ä¸»è¦å·¥ä½œï¼š</p><ul><li>å¤„ç†å®¢æˆ·ç«¯éäº‹åŠ¡è¯·æ±‚ï¼Œè½¬å‘äº‹åŠ¡è¯·æ±‚ç»™LeaderæœåŠ¡å™¨ã€‚</li><li>å‚ä¸äº‹åŠ¡è¯·æ±‚Proposalçš„æŠ•ç¥¨ã€‚</li><li>å‚ä¸Leaderé€‰ä¸¾æŠ•ç¥¨ã€‚</li></ul><p>Followerä¹Ÿé‡‡ç”¨è´£ä»»é“¾æ¨¡å¼ç»„è£…çš„è¯·æ±‚å¤„ç†é“¾æ¥å¤„ç†æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œä½†ä¸éœ€è¦è´Ÿè´£äº‹åŠ¡è¯·æ±‚çš„æŠ•ç¥¨å¤„ç†ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010147.png"></p><p>ä¸LeaderæœåŠ¡å™¨æœ‰å·®å¼‚çš„ä¸¤ä¸ªå¤„ç†å™¨ï¼š</p><ul><li><strong>FollowerRequestProcessorï¼š</strong>ç¬¬ä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨ï¼Œä¸»è¦å·¥ä½œæ˜¯è¯†åˆ«å½“å‰è¯·æ±‚æ˜¯å¦æ˜¯äº‹åŠ¡è¯·æ±‚ã€‚äº‹åŠ¡è¯·æ±‚ä¼šå°†å…¶è½¬å‘ç»™LeaderæœåŠ¡å™¨ã€‚</li><li><strong>SendAckRequestProcessorï¼š</strong>åŒæ ·è´Ÿè´£äº‹åŠ¡æ—¥å¿—è®°å½•åé¦ˆçš„è§’è‰²ï¼Œå®Œæˆæ—¥å¿—è®°å½•åï¼Œä¼šå‘LeaderæœåŠ¡å™¨å‘é€ACKæ¶ˆæ¯è¡¨ç¤ºè‡ªå·±å®Œæˆäº†äº‹åŠ¡æ—¥å¿—çš„è®°å½•å·¥ä½œã€‚ä¸AckRequestProcessorçš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼Œåè€…ä¸LeaderæœåŠ¡å™¨åœ¨åŒå°æœåŠ¡å™¨ï¼Œå› æ­¤å…¶ACKåé¦ˆä»…ä»…æ˜¯ä¸€ä¸ªæœ¬åœ°æ“ä½œï¼›å‰è€…ä½äºFolloweræœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡ACKæ¶ˆæ¯çš„å½¢å¼æ¥å‘LeaderæœåŠ¡å™¨è¿›è¡Œåé¦ˆã€‚</li></ul><h3 id="7-3-Observer"><a href="#7-3-Observer" class="headerlink" title="7.3 Observer"></a>7.3 Observer</h3><p>ä¸»è¦å·¥ä½œï¼š</p><ul><li>è§‚å¯ŸZKé›†ç¾¤çš„æœ€æ–°çŠ¶æ€å˜åŒ–å¹¶å°†çŠ¶æ€å˜æ›´åŒæ­¥è¿‡æ¥ã€‚</li><li>ä¸Followerä¸€æ ·ï¼Œå¤„ç†éäº‹åŠ¡è¯·æ±‚ï¼Œäº‹åŠ¡è¯·æ±‚åˆ™è½¬äº¤ç»™LeaderæœåŠ¡å™¨ã€‚ä½†Observerä¸å‚ä¸ä»»ä½•æŠ•ç¥¨ï¼ŒåŒ…æ‹¬äº‹åŠ¡è¯·æ±‚Proposalçš„æŠ•ç¥¨å’ŒLeaderé€‰ä¸¾æŠ•ç¥¨ã€‚</li><li>åªæä¾›éäº‹åŠ¡æœåŠ¡ï¼Œé€šå¸¸ç”¨äºä¸å½±å“é›†ç¾¤äº‹åŠ¡å¤„ç†èƒ½åŠ›çš„å‰æä¸‹æå‡é›†ç¾¤çš„éäº‹åŠ¡å¤„ç†èƒ½åŠ›ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010148.png"></p><p>è™½ç„¶ç»„è£…äº†SyncRequestProcessorå¤„ç†å™¨ï¼Œä½†LeaderæœåŠ¡å™¨ä¸ä¼šå°†äº‹åŠ¡è¯·æ±‚çš„æŠ•ç¥¨è½¬å‘ç»™Observerã€‚</p><h3 id="7-4-é›†ç¾¤é—´æ¶ˆæ¯é€šä¿¡"><a href="#7-4-é›†ç¾¤é—´æ¶ˆæ¯é€šä¿¡" class="headerlink" title="7.4 é›†ç¾¤é—´æ¶ˆæ¯é€šä¿¡"></a>7.4 é›†ç¾¤é—´æ¶ˆæ¯é€šä¿¡</h3><p>ZKçš„æ¶ˆæ¯ç±»å‹å¯ä»¥åˆ†ä¸ºå››ç±»ï¼š</p><ul><li>æ•°æ®åŒæ­¥å‹</li><li>æœåŠ¡å™¨åˆå§‹åŒ–å‹</li><li>è¯·æ±‚å¤„ç†å‹</li><li>ä¼šè¯ç®¡ç†å‹</li></ul><h4 id="ï¼ˆ1ï¼‰æ•°æ®åŒæ­¥å‹"><a href="#ï¼ˆ1ï¼‰æ•°æ®åŒæ­¥å‹" class="headerlink" title="ï¼ˆ1ï¼‰æ•°æ®åŒæ­¥å‹"></a>ï¼ˆ1ï¼‰æ•°æ®åŒæ­¥å‹</h4><p>æ•°æ®åŒæ­¥å‹æ¶ˆæ¯æ˜¯æŒ‡åœ¨Learnerå’ŒLeaderæœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œç½‘ç»œé€šä¿¡æ‰€ç”¨åˆ°çš„æ¶ˆæ¯ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010149.png"></p><h4 id="ï¼ˆ2ï¼‰æœåŠ¡å™¨åˆå§‹åŒ–å‹"><a href="#ï¼ˆ2ï¼‰æœåŠ¡å™¨åˆå§‹åŒ–å‹" class="headerlink" title="ï¼ˆ2ï¼‰æœåŠ¡å™¨åˆå§‹åŒ–å‹"></a>ï¼ˆ2ï¼‰æœåŠ¡å™¨åˆå§‹åŒ–å‹</h4><p>æœåŠ¡å™¨åˆå§‹åŒ–å‹æ¶ˆæ¯æ˜¯æŒ‡æ•´ä¸ªé›†ç¾¤æˆ–æ˜¯æŸäº›æ–°æœºå™¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒLearnerå’ŒLeaderæœåŠ¡å™¨ä¹‹é—´ç›¸äº’é€šä¿¡æ‰€ä½¿ç”¨çš„æ¶ˆæ¯ç±»å‹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010150.png"></p><h4 id="ï¼ˆ3ï¼‰è¯·æ±‚å¤„ç†å‹"><a href="#ï¼ˆ3ï¼‰è¯·æ±‚å¤„ç†å‹" class="headerlink" title="ï¼ˆ3ï¼‰è¯·æ±‚å¤„ç†å‹"></a>ï¼ˆ3ï¼‰è¯·æ±‚å¤„ç†å‹</h4><p>è¯·æ±‚å¤„ç†å‹æ¶ˆæ¯æ˜¯åœ¨è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼ŒLearnerå’ŒLeaderæœåŠ¡å™¨ä¹‹é—´ç›¸äº’é€šä¿¡æ‰€ä½¿ç”¨çš„æ¶ˆæ¯ç±»å‹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010151.png"></p><h4 id="ï¼ˆ4ï¼‰ä¼šè¯ç®¡ç†å‹"><a href="#ï¼ˆ4ï¼‰ä¼šè¯ç®¡ç†å‹" class="headerlink" title="ï¼ˆ4ï¼‰ä¼šè¯ç®¡ç†å‹"></a>ï¼ˆ4ï¼‰ä¼šè¯ç®¡ç†å‹</h4><p>ä¼šè¯ç®¡ç†å‹æ¶ˆæ¯æ˜¯ZKè¿›è¡Œä¼šè¯ç®¡ç†è¿‡ç¨‹ä¸­ï¼Œä¸LearneræœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ä½¿ç”¨çš„æ¶ˆæ¯ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010152.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šå•æœºç‰ˆå’Œé›†ç¾¤ç‰ˆæœåŠ¡å™¨çš„å¯åŠ¨æµç¨‹ï¼ŒLeaderé€‰ä¸¾ç®—æ³•åˆ†æå’Œå…·ä½“å®ç°ç»†èŠ‚ï¼ŒLeaderã€Followerã€Observerç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•-ä¼šè¯</title>
    <link href="http://linyishui.top/2021061201.html"/>
    <id>http://linyishui.top/2021061201.html</id>
    <published>2021-06-12T10:24:16.000Z</published>
    <updated>2021-07-18T15:35:44.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"><a href="#ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•" class="headerlink" title="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"></a>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•</h1><h2 id="å››-ä¼šè¯"><a href="#å››-ä¼šè¯" class="headerlink" title="å››. ä¼šè¯"></a>å››. ä¼šè¯</h2><p>ä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸã€å®¢æˆ·ç«¯è¯·æ±‚é¡ºåºæ‰§è¡Œä»¥åŠWatcheré€šçŸ¥æœºåˆ¶ç­‰éƒ½å’Œä¼šè¯æ¯æ¯ç›¸å…³ã€‚</p><h3 id="4-1-ä¼šè¯çŠ¶æ€"><a href="#4-1-ä¼šè¯çŠ¶æ€" class="headerlink" title="4.1 ä¼šè¯çŠ¶æ€"></a>4.1 ä¼šè¯çŠ¶æ€</h3><p>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å®Œæˆè¿æ¥çš„åˆ›å»ºåï¼Œå°±å»ºç«‹äº†ä¸€ä¸ªä¼šè¯ã€‚ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸä¸­ä¼šæœ‰å¤šç§çŠ¶æ€ï¼š</p><ul><li><strong>CONNECTINGï¼š</strong>å®¢æˆ·ç«¯å¼€å§‹åˆ›å»ºZKå¯¹è±¡æ—¶è¿›å…¥æ­¤çŠ¶æ€ï¼ŒåŒæ—¶ä»æœåŠ¡å™¨åœ°å€åˆ—è¡¨é€ä¸ªé€‰å–IPåœ°å€æ¥å°è¯•è¿›è¡Œç½‘ç»œè¿æ¥ã€‚</li><li><strong>CONNECTEDï¼š</strong>å½“æˆåŠŸè¿æ¥ä¸ŠæœåŠ¡å™¨æ—¶æ›´æ–°ä¸ºæ­¤çŠ¶æ€ã€‚</li><li>RECONNECTING/CONNECTINGï¼šç½‘ç»œé—®é¢˜ç­‰ä¼šä½¿è¿æ¥æ–­å¼€ï¼ŒZKå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¿›è¡Œé‡è¿æ“ä½œã€‚</li><li>RECONNECTED/CONNECTEDï¼šè¿è¡ŒæœŸé—´ï¼Œå®¢æˆ·ç«¯çŠ¶æ€æ€»æ˜¯ä¼šä»‹äºCONNECTINGä¸CONNECTEDä¹‹é—´ã€‚</li><li><strong>CLOSEï¼š</strong>ä¼šè¯è¶…æ—¶ã€æƒé™æ£€æŸ¥å¤±è´¥æˆ–å®¢æˆ·ç«¯ä¸»åŠ¨é€€å‡ºã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010130.png"></p><h3 id="4-2-ä¼šè¯åˆ›å»º"><a href="#4-2-ä¼šè¯åˆ›å»º" class="headerlink" title="4.2 ä¼šè¯åˆ›å»º"></a>4.2 ä¼šè¯åˆ›å»º</h3><p>SessionåŸºæœ¬å±æ€§ï¼š</p><ul><li><strong>sessionIDï¼š</strong>ä¼šè¯IDï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†ä¸€ä¸ªä¼šè¯ã€‚</li><li><strong>TimeOut</strong>ï¼šä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ­¤è¶…æ—¶æ—¶é—´ï¼ŒæœåŠ¡å™¨æ ¹æ®è‡ªå·±è¶…æ—¶æ—¶é—´é™åˆ¶æœ€ç»ˆç¡®å®šä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚</li><li><strong>TickTimeï¼š</strong>ä¸‹æ¬¡ä¼šè¯è¶…æ—¶æ—¶é—´ç‚¹ï¼Œä¾¿äºZKå¯¹ä¼šè¯è¿›è¡Œâ€œåˆ†æ¡¶ç­–ç•¥â€ç®¡ç†ï¼Œä¹Ÿä¸ºäº†é«˜æ•ˆä½è€—çš„å®ç°ä¼šè¯çš„è¶…æ—¶æ£€æŸ¥å’Œæ¸…ç†ã€‚13ä½çš„longå‹æ•°æ®ï¼Œæ¥è¿‘äºå½“æ—¶é—´åŠ ä¸ŠTimeOutã€‚</li><li><strong>isClosingï¼š</strong>æ ‡è®°ä¼šè¯æ˜¯å¦å·²ç»å…³é—­ï¼Œç¡®ä¿æœåŠ¡ç«¯ä¸å†å¤„ç†æ¥è‡ªè¯¥ä¼šè¯çš„è¯·æ±‚ã€‚</li></ul><p>ç”ŸæˆSessionIDï¼Œé«˜8ä½ç¡®å®šäº†æ‰€åœ¨æœºå™¨ï¼Œå56ä½ä¸ºå½“å‰æ—¶é—´æ¥è¿›è¡Œéšæœºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">initializeNextSession</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> nextSid = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">// è·å–å½“å‰æ¯«ç§’æ ¼å¼æ—¶é—´ï¼Œå·¦ç§»24ä½ï¼Œä½24ä½ç”¨0è¡¥é½ï¼Œå†å³ç§»8ä½ï¼Œé«˜8ä½ç”¨0è¡¥é½</span></span><br><span class="line">       <span class="comment">// å·¦ç§»24ä½å°†é«˜ä½çš„1ç§»å‡ºé¿å…äº†è´Ÿæ•°å‡ºç°ï¼ˆç‰¹æ®Šçš„æ—¶é—´èŠ‚ç‚¹å¦‚2022å¹´0408æ—¥ä»ä¼šå¾—åˆ°è´Ÿæ•°ï¼‰ï¼Œæ‰€ä»¥3.4.6ç‰ˆæœ¬ä¿®å¤ä¸º &gt;&gt;&gt; 8</span></span><br><span class="line">       nextSid = (System.currentTimeMillis() &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">       <span class="comment">// å†æ·»åŠ æœºå™¨æ ‡è¯†ï¼Œå½“å‰ZKæœåŠ¡å™¨çš„SIDå€¼ï¼Œå·¦ç§»56ä½</span></span><br><span class="line">       <span class="comment">// å°†ä¸¤è€…|æ“ä½œå¾—åˆ°ä¸€ä¸ªå•æœºå”¯ä¸€çš„åºåˆ—å·</span></span><br><span class="line">       nextSid = nextSid | (id &lt;&lt; <span class="number">56</span>);</span><br><span class="line">       <span class="keyword">return</span> nextSid;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>SessionTrackeræ˜¯ä¼šè¯çš„ç®¡ç†å™¨ï¼Œè´Ÿè´£ä¼šè¯åˆ›å»ºã€ç®¡ç†å’Œæ¸…ç†ç­‰å·¥ä½œï¼Œæ¯ä¸ªä¼šè¯åœ¨å…¶ä¸­éƒ½ä¿ç•™3ä»½ï¼š</p><ul><li><strong>sessionsById</strong>ï¼šæ ¹æ®sessionIDæ¥ç®¡ç†sessionå®ä½“ï¼Œ<code>HashMap&lt;Long, SessionImpl&gt;</code> æ•°æ®ç»“æ„ã€‚</li><li><strong>sessionsWithTimeout</strong>ï¼šæ ¹æ®sessionIDæ¥ç®¡ç†sessionè¶…æ—¶æ—¶é—´ï¼Œ<code>HashMap&lt;Long, Integer&gt;</code> æ•°æ®ç»“æ„ã€‚å…¶ä¸ZKå†…å­˜æ•°æ®åº“ç›¸è¿ï¼Œä¼šè¢«å®šæœŸæŒä¹…åŒ–åˆ°å¿«ç…§æ–‡ä»¶ã€‚</li><li><strong>sessionSets</strong>ï¼šæ ¹æ®ä¸‹æ¬¡ä¼šè¯è¶…æ—¶æ—¶é—´æ¥ç®¡ç†å½’æ¡£sessionï¼Œ<code>HashMap&lt;Long, SessionSet&gt;</code> æ•°æ®ç»“æ„ã€‚ä¾¿äºè¿›è¡Œä¼šè¯ç®¡ç†å’Œè¶…æ—¶æ£€æŸ¥ã€‚</li></ul><p>åˆ›å»ºä¼šè¯è¿æ¥ï¼š</p><ul><li><strong>å¤„ç†ConnectRequestè¯·æ±‚ï¼š</strong>ç”±NIOServerCnxnè´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„ä¼šè¯åˆ›å»ºè¯·æ±‚ï¼Œååºåˆ—åŒ–å‡ºConnectRequestè¯·æ±‚ï¼Œæ ¹æ®ZKæœåŠ¡ç«¯çš„é…ç½®å®Œæˆä¼šè¯è¶…æ—¶æ—¶é—´çš„åå•†ã€‚</li><li><strong>ä¼šè¯åˆ›å»º</strong>ï¼šSessionTrackerä¸ºä¼šè¯åˆ†é…ä¸€ä¸ªSessionIDï¼Œå°†å…¶æ³¨å†Œåˆ°sessionsByIdå’ŒsessionsWithTimeoutï¼ŒåŒæ—¶è¿›è¡Œä¼šè¯çš„æ¿€æ´»ã€‚ä¼šè¯è¯·æ±‚è¿˜ä¼šåœ¨ZKæœåŠ¡ç«¯å„è¯·æ±‚å¤„ç†å™¨ç›´æ¥è¿›è¡Œé¡ºåºæµè½¬ã€‚</li><li><strong>å¤„ç†å™¨é“¾è·¯å¤„ç†</strong></li><li><strong>ä¼šè¯å“åº”</strong></li></ul><h3 id="4-3-ä¼šè¯ç®¡ç†"><a href="#4-3-ä¼šè¯ç®¡ç†" class="headerlink" title="4.3 ä¼šè¯ç®¡ç†"></a>4.3 ä¼šè¯ç®¡ç†</h3><h4 id="ï¼ˆ1ï¼‰åˆ†æ¡¶ç­–ç•¥"><a href="#ï¼ˆ1ï¼‰åˆ†æ¡¶ç­–ç•¥" class="headerlink" title="ï¼ˆ1ï¼‰åˆ†æ¡¶ç­–ç•¥"></a>ï¼ˆ1ï¼‰åˆ†æ¡¶ç­–ç•¥</h4><p>åˆ†æ¡¶ç­–ç•¥æŒ‡å°†ç±»ä¼¼çš„ä¼šè¯æ”¾åœ¨åŒä¸€åŒºå—ä¸­è¿›è¡Œç®¡ç†ï¼Œä»¥ä¾¿äºZKå¯¹ä¼šè¯è¿›è¡Œä¸åŒåŒºå—çš„éš”ç¦»å¤„ç†ä»¥åŠåŒä¸€åŒºå—çš„ç»Ÿä¸€å¤„ç†ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010131.png"></p><p>åˆ†é…çš„åŸåˆ™æ˜¯æ¯ä¸ªä¼šè¯çš„ä¸‹æ¬¡è¶…æ—¶æ—¶é—´ç‚¹ï¼ˆExpirationTimeï¼‰æœ€è¿‘ä¸€æ¬¡å¯èƒ½è¶…æ—¶çš„æ—¶é—´ç‚¹ï¼Œè®¡ç®—æ–¹å¼ï¼š<code>ExpirationTime = CurrentTime + SessionTimeout</code> ï¼Œå½“å‰æ—¶é—´+è¶…æ—¶æ—¶é—´ã€‚</p><p>ZKçš„LeaderæœåŠ¡å™¨åœ¨è¿è¡ŒæœŸé—´ä¼šå®šæ—¶è¿›è¡Œä¼šè¯è¶…æ—¶æ£€æŸ¥ï¼Œé—´éš”æ˜¯ExpirationIntervalï¼Œé»˜è®¤å€¼ä¸ºTickTimeï¼ˆ2000æ¯«ç§’ï¼‰ï¼Œå®Œæ•´çš„å…¬å¼ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExpirationTime_ = CurrentTime + SessionTimeout</span><br><span class="line">ExpirationTime = (ExpirationTime_ / ExpirationInterval + 1) * ExpirationInterval</span><br><span class="line">// å‡è®¾å½“å‰æ—¶é—´ä¸º1370907000000æ¯«ç§’ï¼Œå®¢æˆ·ç«¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º15000æ¯«ç§’ï¼ŒæœåŠ¡å™¨TickTimeä¸º2000æ¯«ç§’</span><br><span class="line">ExpirationTime_ = 1370907000000 + 15000 = 1370907015000</span><br><span class="line">ExpirationTime = (1370907015000 / 2000 + 1) = 1370907016000</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰ä¼šè¯æ¿€æ´»"><a href="#ï¼ˆ2ï¼‰ä¼šè¯æ¿€æ´»" class="headerlink" title="ï¼ˆ2ï¼‰ä¼šè¯æ¿€æ´»"></a>ï¼ˆ2ï¼‰ä¼šè¯æ¿€æ´»</h4><p>å®¢æˆ·ç«¯åœ¨ä¼šè¯è¿è¡ŒæœŸé—´å‘æœåŠ¡ç«¯å‘é€PINGè¯·æ±‚æ¥ä¿æŒä¼šè¯æœ‰æ•ˆï¼ŒæœåŠ¡ç«¯è¦ä¸æ–­æ¥æ”¶è¿™ç±»å¿ƒè·³æ£€æµ‹ï¼Œå¹¶é‡æ–°æ¿€æ´»å¯¹åº”å®¢æˆ·ç«¯ä¼šè¯ï¼Œå³TouchSessionï¼Œä¸€æ¬¡å¿ƒè·³æ£€æµ‹å¯¹åº”ä¸€æ¬¡ä¼šè¯æ¿€æ´»ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010132.png"></p><ol><li>æ£€éªŒä¼šè¯æ˜¯å¦å·²å…³é—­ã€‚</li><li>è®¡ç®—æ”¹ä¼šè¯æ–°çš„è¶…æ—¶æ—¶é—´ã€‚</li><li>å®šä½æ”¹ä¼šè¯å½“å‰çš„åŒºå—ã€‚æ ¹æ®ä¼šè¯è€çš„è¶…æ—¶æ—¶é—´å®šä½å…¶æ‰€åœ¨åŒºå—ã€‚</li><li>è¿ç§»ä¼šè¯ã€‚æ”¾å…¥æ–°çš„è¶…æ—¶æ—¶é—´å¯¹åº”åŒºå—ã€‚</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010133.png"></p><p>å‘ç”Ÿä¼šè¯æ¿€æ´»çš„ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒåŒ…æ‹¬è¯»å†™ï¼Œè§¦å‘ä¸€æ¬¡ä¼šè¯æ¿€æ´»ã€‚</li><li>å®¢æˆ·ç«¯å‘ç°åœ¨sessionTimeout/3æ—¶é—´å†…æœªå’ŒæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œä¸»åŠ¨å‘èµ·ä¸€æ¬¡PINGè¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åè§¦å‘ä¸€æ¬¡ä¼šè¯æ¿€æ´»ã€‚</li></ul><h4 id="ï¼ˆ3ï¼‰ä¼šè¯è¶…æ—¶æ£€æŸ¥"><a href="#ï¼ˆ3ï¼‰ä¼šè¯è¶…æ—¶æ£€æŸ¥" class="headerlink" title="ï¼ˆ3ï¼‰ä¼šè¯è¶…æ—¶æ£€æŸ¥"></a>ï¼ˆ3ï¼‰ä¼šè¯è¶…æ—¶æ£€æŸ¥</h4><p>SessionTrackerä¸­æœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸“é—¨è¿›è¡Œä¼šè¯è¶…æ—¶æ£€æŸ¥ï¼Œå…¶å·¥ä½œæœºåˆ¶çš„æ ¸å¿ƒæ€è·¯éå¸¸ç®€å•ï¼Œé€ä¸ªä¾æ¬¡å¯¹ä¼šè¯æ¡¶ä¸­å‰©ä¸‹çš„ä¼šè¯è¿›è¡Œæ¸…ç†ã€‚</p><p>ä¼šè¯åˆ†æ¡¶ç­–ç•¥ä¸­å°†ExpirationIntervalçš„å€æ•°ä½œä¸ºæ—¶é—´ç‚¹æ¥åˆ†å¸ƒä¼šè¯ï¼Œè¶…æ—¶æ£€æŸ¥çº¿ç¨‹åªè¦åœ¨è¿™äº›æŒ‡å®šçš„æ—¶é—´ç‚¹è¿›è¡Œæ£€æŸ¥å³å¯ï¼Œè¿™æ ·å¯ä»¥æ‰¹é‡æ¸…ç†æœ‰å¾ˆå¥½çš„æ€§èƒ½ã€‚</p><h3 id="4-4-ä¼šè¯æ¸…ç†"><a href="#4-4-ä¼šè¯æ¸…ç†" class="headerlink" title="4.4 ä¼šè¯æ¸…ç†"></a>4.4 ä¼šè¯æ¸…ç†</h3><p>SessionTrackerçš„è¶…æ—¶æ£€æŸ¥å‡ºå·²ç»è¿‡æœŸçš„ä¼šè¯åï¼Œå¼€å§‹è¿›è¡Œä¼šè¯æ¸…ç†ï¼š</p><ol><li><p><strong>æ ‡è®°ä¼šè¯çŠ¶æ€ä¸ºâ€œå·²å…³é—­â€</strong>ã€‚</p><p>æ¸…ç†è¿‡ç¨‹éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œé¦–å…ˆè¦å°†ä¼šè¯çš„isClosingè®¾ç½®ä¸ºtrueï¼Œåœ¨æ­¤æœŸé—´ä¸å†å¤„ç†è¯¥å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p></li><li><p><strong>å‘èµ·â€œä¼šè¯å…³é—­â€è¯·æ±‚</strong>ã€‚</p><p>æäº¤æ­¤è¯·æ±‚ä½¿ä¼šè¯å…³é—­åœ¨æ•´ä¸ªæœåŠ¡å™¨é›†ç¾¤ä¸­ç”Ÿæ•ˆï¼Œç«‹å³äº¤ä»˜ç»™PrepRequestProcessorå¤„ç†å™¨ã€‚</p></li><li><p><strong>æ”¶é›†éœ€è¦æ¸…ç†çš„ä¸´æ—¶èŠ‚ç‚¹</strong>ã€‚</p><p>ä¼šè¯å¤±æ•ˆåï¼Œç›¸å…³çš„ä¸´æ—¶èŠ‚ç‚¹éƒ½è¦ä¸€å¹¶æ¸…é™¤æ‰ï¼Œæ‰€ä»¥è¦å…ˆæ•´ç†å‡ºå’Œä¼šè¯ç›¸å…³çš„ä¸´æ—¶èŠ‚ç‚¹ã€‚</p><p>ZKå†…å­˜æ•°æ®åº“ä¸­æ¯ä¸ªä¼šè¯éƒ½å•ç‹¬ä¿å­˜äº†ä¸€ä»½ç”±è¯¥ä¼šè¯ç»´æŠ¤çš„ä¸´æ—¶èŠ‚ç‚¹é›†åˆï¼Œåªéœ€æ ¹æ®sessionIDå–åˆ°è¿™ä»½åˆ—è¡¨å³å¯ã€‚</p><p>å®é™…åº”ç”¨ä¸­ï¼ŒZKå¤„ç†ä¼šè¯å…³é—­è¯·æ±‚å‰å¯èƒ½æœ‰ä¸¤ç±»è¯·æ±‚åˆ°è¾¾äº†æœåŠ¡ç«¯å¹¶æ­£åœ¨å¤„ç†ï¼š</p><ul><li>èŠ‚ç‚¹åˆ é™¤è¯·æ±‚ï¼Œåˆ é™¤çš„ç›®æ ‡èŠ‚ç‚¹æ­£å¥½æ˜¯é›†åˆä¸­çš„ä¸€ä¸ªã€‚</li><li>ä¸´æ—¶èŠ‚ç‚¹åˆ›å»ºè¯·æ±‚ï¼Œåˆ›å»ºçš„çš„ç›®æ ‡èŠ‚ç‚¹æ­£å¥½æ˜¯é›†åˆä¸­çš„ä¸€ä¸ªã€‚</li></ul><p>å…±åŒç‚¹æ˜¯äº‹åŠ¡å°šæœªå®Œæˆï¼Œè¿˜æœªåº”ç”¨åˆ°å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥è·å–ä¸´æ—¶èŠ‚ç‚¹åˆ—è¡¨æ—¶å¯èƒ½ä¼šæœ‰ä¸ä¸€è‡´çš„æƒ…å†µã€‚å‰è€…éœ€è¦ä»è·å–çš„åˆ—è¡¨ä¸­ä¹Ÿç§»é™¤ï¼Œåè€…è¦å°†æ‰€æœ‰è¯·æ±‚å¯¹åº”çš„è·¯å¾„èŠ‚ç‚¹åŠ åˆ°é›†åˆä¸­ï¼Œä»¥åˆ é™¤è¿™äº›å°†è¦åˆ›å»ºçš„èŠ‚ç‚¹ã€‚</p></li><li><p><strong>æ·»åŠ â€œèŠ‚ç‚¹åˆ é™¤â€äº‹åŠ¡å˜æ›´</strong>ã€‚</p><p>å®Œæˆä¸´æ—¶èŠ‚ç‚¹æ”¶é›†åï¼ŒZKé€ä¸ªå°†ä¸´æ—¶èŠ‚ç‚¹è½¬æ¢ä¸ºèŠ‚ç‚¹åˆ é™¤è¯·æ±‚ï¼Œå¹¶æ”¾å…¥äº‹åŠ¡å˜æ›´é˜Ÿåˆ—outstandingChangesä¸­å»ã€‚</p></li><li><p><strong>åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹</strong>ã€‚</p><p>FinalRequestProcessorå¤„ç†å™¨ä¼šè§¦å‘å†…å­˜æ•°æ®åº“ï¼Œåˆ é™¤è¯¥ä¼šè¯å¯¹åº”çš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ã€‚</p></li><li><p><strong>ç§»é™¤ä¼šè¯</strong>ã€‚</p><p>å®ŒæˆèŠ‚ç‚¹åˆ é™¤åï¼Œè¦å°†ä¼šè¯ä»SessionTrackerä¸­ç§»é™¤ã€‚ä¸»è¦æ˜¯ä»ä¸‰ä¸ªæ•°æ®ç»“æ„sessionsByIdã€sessionsWithTimeoutå’ŒsessionSetsä¸­ç§»é™¤ã€‚</p></li><li><p><strong>å…³é—­NIOServerCnxn</strong>ã€‚</p><p>ä»NIOServerCnxnFactoryä¸­æ‰¾åˆ°å¹¶å…³é—­NIOServerCnxnã€‚</p></li></ol><h3 id="4-5-ä¼šè¯é‡è¿"><a href="#4-5-ä¼šè¯é‡è¿" class="headerlink" title="4.5 ä¼šè¯é‡è¿"></a>4.5 ä¼šè¯é‡è¿</h3><p>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç½‘ç»œè¿æ¥æ–­å¼€æ—¶ï¼ŒZKå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¿›è¡Œåå¤çš„é‡è¿ï¼Œç›´åˆ°æœ€ç»ˆæˆåŠŸè¿æ¥åˆ°ä¸€å°æœåŠ¡å™¨ï¼Œå†æ¬¡è¿ä¸Šçš„å®¢æˆ·ç«¯å¯èƒ½å¤„äºä¸¤ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼š</p><ul><li><strong>CONNECTEDï¼š</strong>ä¼šè¯è¶…æ—¶æ—¶é—´å†…é‡æ–°è¿æ¥ä¸Šï¼Œå°±æ˜¯é‡è¿æˆåŠŸã€‚</li><li><strong>EXPIREDï¼š</strong>è¶…æ—¶æ—¶é—´ä»¥å¤–åˆ™æœåŠ¡ç«¯å·²è¿›è¡Œäº†ä¼šè¯æ¸…ç†æ“ä½œï¼Œæ­¤æ—¶è¿ä¸Šçš„ä¼šè¯æ˜¯éæ³•ä¼šè¯ã€‚</li></ul><p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥æ–­å¼€åï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šçœ‹åˆ°ä¸¤ç±»å¼‚å¸¸ï¼š</p><ul><li><strong>CONNECTION_LOSS</strong>ï¼ˆè¿æ¥æ–­å¼€ï¼‰ï¼šç«‹å³æ”¶åˆ°äº‹ä»¶None-Disconnectedé€šçŸ¥ï¼ŒåŒæ—¶æŠ›å‡ºå¼‚å¸¸ ConnectionLossException ã€‚ZKå®¢æˆ·ç«¯è‡ªåŠ¨ä»åœ°å€åˆ—è¡¨é‡æ–°é€ä¸ªé€‰å–æ–°çš„åœ°å€å¹¶å°è¯•é‡æ–°è¿æ¥ã€‚é‡è¿åæ”¶åˆ°äº‹ä»¶None-SyncConnectedé€šçŸ¥ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•å‡ºé”™çš„æ“ä½œã€‚</li><li><strong>SESSION_EXPIRED</strong>ï¼ˆä¼šè¯è¿‡æœŸï¼‰ï¼šé‡è¿æ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡äº†ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ŒæœåŠ¡å™¨è®¤å®šè¿™ä¸ªä¼šè¯å·²ç»ç»“æŸå¹¶æ‰§è¡Œä¼šè¯æ¸…ç†ï¼Œä½†å®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“ä¼šè¯å·²ç»å¤±æ•ˆï¼Œå…¶å®¢æˆ·ç«¯çŠ¶æ€è¿˜æ˜¯DISCONNECTEDã€‚ä¹‹åå®¢æˆ·ç«¯å¯èƒ½ä¼šé‡æ–°è¿ä¸ŠæœåŠ¡å™¨ï¼Œå¹¶è¢«å‘ŠçŸ¥ä¼šè¯å·²å¤±æ•ˆï¼Œç”¨æˆ·è¦é‡æ–°å®ä¾‹åŒ–ä¸€ä¸ªZKå¯¹è±¡ï¼Œå¹¶å†³å®šæ˜¯å¦å’Œå¦‚ä½•æ¢å¤ä¸´æ—¶æ•°æ®ã€‚</li></ul><p><strong>SESSION_MOVED</strong>ï¼ˆä¼šè¯è½¬ç§»ï¼‰ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨1æ–­å¼€è¿æ¥åï¼Œä¸æœåŠ¡å™¨2è¿æ¥ä¸Šå¹¶å»¶ç»­äº†æœ‰æ•ˆä¼šè¯ã€‚3.2.0ç‰ˆæœ¬ä¹‹å‰æ²¡æœ‰æ­¤æ¦‚å¿µï¼Œä¼šæœ‰å¼‚å¸¸æƒ…å†µï¼Œå‘å‰ä¸€ä¸ªæœåŠ¡å™¨å‘é€çš„è¯·æ±‚è¢«å¤„ç†åè¦†ç›–äº†å‘åä¸€ä¸ªæœåŠ¡å™¨çš„ç›¸åŒè¯·æ±‚ã€‚3.2.0ç‰ˆæœ¬åæå‡ºäº†ä¼šè¯è½¬ç§»çš„æ¦‚å¿µï¼Œå¹¶å°è£…äº†SessionMovedExceptionå¼‚å¸¸ã€‚ä¹‹åå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ä½¿ï¼Œé¦–å…ˆæ£€æŸ¥ä¼šè¯çš„æ‰€æœ‰è€…æ˜¯å¦æ˜¯å½“å‰æœåŠ¡å™¨ï¼Œä¸æ˜¯å°±æŠ›å‡ºæ­¤å¼‚å¸¸ï¼Œä½†å› ä¸ºå®¢æˆ·ç«¯å·²å’ŒæœåŠ¡å™¨æ–­å¼€äº†è¿æ¥ï¼Œæ‰€ä»¥æ— æ³•æ”¶åˆ°è¿™ä¸ªå¼‚å¸¸çš„å“åº”ã€‚åªæœ‰å¤šä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒçš„sessionId/sessionPasswdåˆ›å»ºä¼šè¯æ—¶æ‰ä¼šæ”¶åˆ°ï¼Œä¸€æ—¦ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯åˆ›å»ºæˆåŠŸï¼ŒæœåŠ¡å™¨å°±è®¤ä¸ºè¯¥sessionIdå¯¹åº”çš„ä¼šè¯å·²å‘ç”Ÿè½¬ç§»ï¼Œäºæ˜¯ç­‰åˆ°ç¬¬äºŒä¸ªå®¢æˆ·ç«¯è¿ä¸Šæ­¤æœåŠ¡å™¨åå°±è¢«è®¤ä¸ºæ˜¯ä¼šè¯è½¬ç§»çš„æƒ…å†µã€‚</p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šä¼šè¯çŠ¶æ€ã€ä¼šè¯åˆ›å»ºã€ä¼šè¯ç®¡ç†ï¼ˆåˆ†æ¡¶ç­–ç•¥ã€ä¼šè¯æ¿€æ´»ã€ä¼šè¯è¶…æ—¶æ£€æŸ¥ï¼‰ã€ä¼šè¯æ¸…ç†ã€ä¼šè¯é‡è¿ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•-å®¢æˆ·ç«¯</title>
    <link href="http://linyishui.top/2021061101.html"/>
    <id>http://linyishui.top/2021061101.html</id>
    <published>2021-06-11T03:45:26.000Z</published>
    <updated>2021-07-18T15:35:40.590Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"><a href="#ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•" class="headerlink" title="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"></a>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•</h1><h2 id="ä¸‰-å®¢æˆ·ç«¯"><a href="#ä¸‰-å®¢æˆ·ç«¯" class="headerlink" title="ä¸‰. å®¢æˆ·ç«¯"></a>ä¸‰. å®¢æˆ·ç«¯</h2><p>å®¢æˆ·ç«¯æ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li><strong>ZooKeeperå®ä¾‹ï¼š</strong>å®¢æˆ·ç«¯å…¥å£ã€‚</li><li><strong>ClientWatchManagerï¼š</strong>å®¢æˆ·ç«¯Watcherç®¡ç†å™¨ã€‚</li><li><strong>HostProviderï¼š</strong>å®¢æˆ·ç«¯åœ°å€åˆ—è¡¨ç®¡ç†å™¨ã€‚</li><li><strong>ClientCnxnï¼š</strong>å®¢æˆ·ç«¯æ ¸å¿ƒçº¿ç¨‹ï¼Œå†…éƒ¨åŒ…å«ä¸¤ä¸ªçº¿ç¨‹ SendThread å’ŒEventThread ï¼Œå‰è€…æ˜¯I/Oçº¿ç¨‹è´Ÿè´£å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´çš„I/Oé€šä¿¡ï¼Œåè€…æ˜¯äº‹ä»¶çº¿ç¨‹è´Ÿè´£å¯¹æœåŠ¡ç«¯äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010123.png"></p><p>æ„é€ å‡½æ•°APIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯åˆå§‹åŒ–å’Œå¯åŠ¨æ­¥éª¤ï¼š</p><ol><li>è®¾ç½®é»˜è®¤Watcherã€‚</li><li>è®¾ç½®ZooKeeperæœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€</li><li>åˆ›å»ºClientCnxnã€‚</li></ol><h3 id="3-1-ä¸€æ¬¡ä¼šè¯çš„åˆ›å»ºè¿‡ç¨‹"><a href="#3-1-ä¸€æ¬¡ä¼šè¯çš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="3.1 ä¸€æ¬¡ä¼šè¯çš„åˆ›å»ºè¿‡ç¨‹"></a>3.1 ä¸€æ¬¡ä¼šè¯çš„åˆ›å»ºè¿‡ç¨‹</h3><p><strong>åˆå§‹åŒ–é˜¶æ®µï¼š</strong></p><ol><li><p><strong>åˆå§‹åŒ–ZKå¯¹è±¡ã€‚</strong></p><p>é€šè¿‡è°ƒç”¨ZKçš„æ„é€ å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ªZKå¯¹è±¡ï¼Œåˆå§‹åŒ–è¿‡ç¨‹åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯çš„Watcherç®¡ç†å™¨ï¼šClientWatcherManagerã€‚</p></li><li><p><strong>è®¾ç½®é»˜è®¤ä¼šè¯Watcherã€‚</strong></p><p>å¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥äº†ä¸€ä¸ªWatcherå¯¹è±¡ï¼Œå®¢æˆ·ç«¯å°†å…¶ä½œä¸ºé»˜è®¤Watcherä¿å­˜åœ¨ClientWatcherManagerä¸­ã€‚</p></li><li><p><strong>æ„é€ ZKæœåŠ¡å™¨åœ°å€åˆ—è¡¨ç®¡ç†å™¨ï¼šHostProviderã€‚</strong></p><p>å®¢æˆ·ç«¯å°†æ„é€ å‡½æ•°ä¼ å…¥çš„æœåŠ¡å™¨åœ°å€å­˜æ”¾åˆ°æœåŠ¡å™¨åœ°å€åˆ—è¡¨ç®¡ç†å™¨HostProviderä¸­ã€‚</p></li><li><p><strong>åˆ›å»ºå¹¶åˆå§‹åŒ–å®¢æˆ·ç«¯ç½‘ç»œè¿æ¥å™¨ï¼šClientCnxnã€‚</strong></p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œè¿æ¥å™¨ClientCnxnï¼Œç”¨æ¥ç®¡ç†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ç½‘ç»œäº¤äº’ã€‚åŒæ—¶è¿˜ä¼šåˆå§‹åŒ–å®¢æˆ·ç«¯çš„ä¸¤ä¸ªæ ¸å¿ƒé˜Ÿåˆ— outgoingQueue å’Œ pendingQueue ï¼Œåˆ†åˆ«ä½œä¸ºå®¢æˆ·ç«¯çš„è¯·æ±‚å‘é€é˜Ÿåˆ—å’ŒæœåŠ¡ç«¯å“åº”çš„ç­‰å¾…é˜Ÿåˆ—ã€‚</p><p>åŒæ—¶è¿˜ä¼šåˆ›å»ºClientCnxnçš„åº•å±‚I/Oå¤„ç†å™¨ClientCnxnSocketã€‚</p></li><li><p><strong>åˆå§‹åŒ–SendThreadå’ŒEventThreadã€‚</strong></p><p>å‰è€…æ˜¯I/Oçº¿ç¨‹è´Ÿè´£å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´çš„I/Oé€šä¿¡ï¼Œåè€…æ˜¯äº‹ä»¶çº¿ç¨‹è´Ÿè´£å¯¹æœåŠ¡ç«¯äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p><p>åŒæ—¶å°†ClientCnxnSocketåˆ†é…ç»™SendThreadä½œä¸ºåº•å±‚ç½‘ç»œI/Oå¤„ç†å™¨ï¼Œå¹¶åˆå§‹åŒ–EventThreadçš„å¾…å¤„ç†äº‹ä»¶é˜Ÿåˆ—waitingEventsï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰ç­‰å¾…è¢«å®¢æˆ·ç«¯å¤„ç†çš„äº‹ä»¶ã€‚</p></li></ol><p><strong>ä¼šè¯åˆ›å»ºé˜¶æ®µï¼š</strong></p><ol start="6"><li><p><strong>å¯åŠ¨SendThreadå’ŒEventThreadã€‚</strong></p><p>SendThreadé¦–å…ˆåˆ¤æ–­å½“å‰å®¢æˆ·ç«¯çŠ¶æ€ï¼Œè¿›è¡Œä¸€ç³»åˆ—è¯·ç†æ€§å·¥ä½œï¼Œä¸ºå®¢æˆ·ç«¯å‘é€â€œä¼šè¯åˆ›å»ºâ€åšå‡†å¤‡ã€‚</p></li><li><p><strong>è·å–ä¸€ä¸ªæœåŠ¡å™¨åœ°å€ã€‚</strong></p><p>åˆ›å»ºTCPè¿æ¥å‰ï¼ŒSendThreadé¦–å…ˆéœ€è¦è·å–ä¸€ä¸ªZKæœåŠ¡å™¨çš„ç›®æ ‡åœ°å€ï¼Œé€šå¸¸ä»HostProvideréšæœºå–ä¸€ä¸ªï¼Œå§”æ‰˜ç»™ClientCnxnSocketåˆ›å»ºTCPè¿æ¥ã€‚</p></li><li><p><strong>åˆ›å»ºTCPè¿æ¥ã€‚</strong></p><p>ClientCnxnSocketè´Ÿè´£å’ŒæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªTCPé•¿è¿æ¥ã€‚</p></li><li><p><strong>æ„é€ ConnectRequestè¯·æ±‚ã€‚</strong></p><p>TCPè¿æ¥åˆ›å»ºåï¼Œåªæ˜¯ä»ç½‘ç»œTCPå±‚é¢å®Œæˆäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´çš„Socketè¿æ¥ï¼Œä½†è¿˜æœªå®Œæˆä¼šè¯åˆ›å»ºã€‚</p><p>SendThreadæ ¹æ®å½“å‰å®¢æˆ·ç«¯çš„å®é™…è®¾ç½®ï¼Œæ„é€ å‡ºä¸€ä¸ªConnectRequestè¯·æ±‚ï¼Œä»£è¡¨äº†å®¢æˆ·ç«¯è¯•å›¾ä¸æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªä¼šè¯ã€‚</p><p>åŒæ—¶ZKå®¢æˆ·ç«¯è¿›ä¸€æ­¥å°†è¯·æ±‚åŒ…è£…æˆç½‘ç»œI/Oå±‚çš„Packetå¯¹è±¡ï¼Œæ”¾å…¥è¯·æ±‚å‘é€é˜Ÿåˆ— outgoingQueue ä¸­å»ã€‚</p></li><li><p><strong>å‘é€è¯·æ±‚ã€‚</strong></p><p>å®¢æˆ·ç«¯è¯·æ±‚å‡†å¤‡å®Œæ¯•ï¼Œå¼€å§‹å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ã€‚ClientCnxnSocketä»outgoingQueueä¸­å–å‡ºä¸€ä¸ªå¾…å‘é€çš„Packetå¯¹è±¡ï¼Œå°†å…¶åºåˆ—åŒ–æˆByteBufferåï¼Œå‘æœåŠ¡ç«¯è¿›è¡Œå‘é€ã€‚</p></li></ol><p><strong>å“åº”å¤„ç†é˜¶æ®µï¼š</strong></p><ol start="11"><li><p><strong>æ¥æ”¶æœåŠ¡ç«¯å“åº”ã€‚</strong></p><p>ClientCnxnSocketæ¥æ”¶åˆ°æœåŠ¡ç«¯å“åº”ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰å®¢æˆ·ç«¯çŠ¶æ€æ˜¯å¦ä¸ºâ€œå·²åˆå§‹åŒ–â€ï¼Œè‹¥å°šæœªåˆå§‹åŒ–å®Œï¼Œè®¤å®šè¯¥å“åº”æ˜¯ä¼šè¯åˆ›å»ºè¯·æ±‚çš„å“åº”ï¼Œç›´æ¥äº¤ç”± readConnectResult æ–¹æ³•æ¥å¤„ç†ã€‚</p></li><li><p><strong>å¤„ç†Responseã€‚</strong></p><p>ClientCnxnSocketå¯¹æ¥æ”¶åˆ°çš„æœåŠ¡ç«¯å“åº”è¿›è¡Œååºåˆ—åŒ–ï¼Œå¾—åˆ°ConnectResponseå¯¹è±¡ï¼Œä»ä¸­è·å–åˆ°ZKæœåŠ¡å™¨åˆ†é…çš„SessionIdã€‚</p></li><li><p><strong>è¿æ¥æˆåŠŸã€‚</strong></p><p>è¿æ¥æˆåŠŸï¼Œä¸€æ–¹é¢é€šçŸ¥SendThreadçº¿ç¨‹ï¼Œè¿›ä¸€æ­¥å¯¹å®¢æˆ·ç«¯è¿›è¡Œä¼šè¯å‚æ•°è®¾ç½®ï¼ŒåŒ…æ‹¬readTimeoutå’ŒconnectTimeoutç­‰ï¼Œå¹¶æ›´æ–°å®¢æˆ·ç«¯çŠ¶æ€ï¼›</p><p>å¦ä¸€æ–¹é¢ï¼Œé€šçŸ¥åœ°å€ç®¡ç†å™¨HostProviderå½“å‰æˆåŠŸè¿æ¥çš„æœåŠ¡å™¨åœ°å€ã€‚</p></li><li><p><strong>ç”Ÿæˆäº‹ä»¶SyncConnected-Noneã€‚</strong></p><p>SendThreadç”Ÿæˆäº‹ä»¶SyncConnected-Noneè®©ä¸Šå±‚åº”ç”¨æ„ŸçŸ¥åˆ°ä¼šè¯æˆåŠŸåˆ›å»ºï¼Œå°†å…¶ä¼ é€’ç»™EventThreadçº¿ç¨‹ã€‚</p></li><li><p><strong>æŸ¥è¯¢Watcherã€‚</strong></p><p>EventThreadæ”¶åˆ°äº‹ä»¶åï¼Œä»ClientWatcherManagerä¸­æŸ¥è¯¢å‡ºå¯¹åº”çš„Watcherï¼Œé’ˆå¯¹SyncConnected-Noneäº‹ä»¶ç›´æ¥æ‰¾å‡ºæ­¥éª¤2å­˜å‚¨çš„é»˜è®¤Watcherï¼Œå°†å…¶æ”¾åˆ°EventThreadçš„waitingEventsé˜Ÿåˆ—ã€‚</p></li><li><p><strong>å¤„ç†äº‹ä»¶ã€‚</strong></p><p>EventThreadä¸æ–­ä»waitingEventsé˜Ÿåˆ—ä¸­å–å‡ºå¾…å¤„ç†çš„Watcherå¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨æ­¤å¯¹è±¡çš„processæ¥å£æ–¹æ³•ï¼Œä»¥è¾¾åˆ°è§¦å‘Watcherçš„ç›®çš„ã€‚</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010124.png"></p><h3 id="3-2-æœåŠ¡å™¨åœ°å€åˆ—è¡¨"><a href="#3-2-æœåŠ¡å™¨åœ°å€åˆ—è¡¨" class="headerlink" title="3.2 æœåŠ¡å™¨åœ°å€åˆ—è¡¨"></a>3.2 æœåŠ¡å™¨åœ°å€åˆ—è¡¨</h3><p>ZKæ„é€ å‡½æ•°ä¸­çš„æœåŠ¡å™¨åœ°å€åˆ—è¡¨å‚æ•°<strong>connectString</strong>ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”çš„å¤šä¸ªIPå’Œç«¯å£ç»„æˆçš„å­—ç¬¦ä¸²ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span></span><br></pre></td></tr></table></figure><p>ZKå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨åœ°å€åˆ—è¡¨åï¼Œé¦–å…ˆå°†å…¶æ”¾å…¥ConnectStringParserå¯¹è±¡å°è£…èµ·æ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectStringParser</span> </span>&#123;</span><br><span class="line">    String chrootPath;</span><br><span class="line">    ArrayList&lt;InetSocketAddress&gt; serverAddresses = <span class="keyword">new</span> ArrayList&lt;InetSocketAddress&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ1ï¼‰å®¢æˆ·ç«¯éš”ç¦»å‘½åç©ºé—´â€”Chroot"><a href="#ï¼ˆ1ï¼‰å®¢æˆ·ç«¯éš”ç¦»å‘½åç©ºé—´â€”Chroot" class="headerlink" title="ï¼ˆ1ï¼‰å®¢æˆ·ç«¯éš”ç¦»å‘½åç©ºé—´â€”Chroot"></a>ï¼ˆ1ï¼‰å®¢æˆ·ç«¯éš”ç¦»å‘½åç©ºé—´â€”Chroot</h4><p>ZooKeeper 3.2.0ç‰ˆæœ¬å¼•å…¥Chrootç‰¹æ€§ï¼Œå…è®¸æ¯ä¸ªå®¢æˆ·ç«¯ä¸ºè‡ªå·±è®¾ç½®ä¸€ä¸ªå‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œ<strong>è®¾ç½®äº†Chrootçš„å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„ä»»ä½•æ“ä½œéƒ½ä¼šè¢«é™åˆ¶åœ¨å‘½åç©ºé—´ä¸‹</strong>ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦ä¸ºåº”ç”¨Xåˆ†é… <code>/apps/X</code> ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œåº”ç”¨å¯ä»¥å°†å…¶æ‰€æœ‰ZKå®¢æˆ·ç«¯çš„Chrootè®¾ç½®ä¸º <code>/apps/X</code> ã€‚å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼ŒèŠ‚ç‚¹è·¯å¾„éƒ½æ˜¯ä»¥ <code>/apps/X</code> ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå®ƒå’ŒZKå‘èµ·çš„èŠ‚ç‚¹è·¯å¾„éƒ½æ˜¯ä»¥è¿™ä¸ªæ ¹èŠ‚ç‚¹æ„å»ºçš„ç›¸å¯¹è·¯å¾„ã€‚è¿™ç§è®¾è®¡å¯¹äºå®ç°ä¸åŒåº”ç”¨é—´çš„ç›¸äº’éš”ç¦»å¾ˆæœ‰å¸®åŠ©ã€‚</p><p>å¯ä»¥åœ¨connectStringåæ·»åŠ åç¼€æ¥è®¾ç½®Chrootï¼Œå¯ä»¥è§£æå‡ºChrootä¿å­˜åœ¨chrootPathå±æ€§ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span>/apps/X</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰åœ°å€åˆ—è¡¨ç®¡ç†å™¨â€”HostProvider"><a href="#ï¼ˆ2ï¼‰åœ°å€åˆ—è¡¨ç®¡ç†å™¨â€”HostProvider" class="headerlink" title="ï¼ˆ2ï¼‰åœ°å€åˆ—è¡¨ç®¡ç†å™¨â€”HostProvider"></a>ï¼ˆ2ï¼‰åœ°å€åˆ—è¡¨ç®¡ç†å™¨â€”HostProvider</h4><p>ConnectStringParserä¼šå¯¹æœåŠ¡å™¨åœ°å€åšç®€å•å¤„ç†ï¼Œå°è£…æˆInetSocketAddresså¯¹è±¡ï¼Œæœ€åç»è¿‡å¤„ç†çš„åœ°å€åˆ—è¡¨ä¼šè¿›ä¸€æ­¥çš„å°è£…åˆ°<strong>StaticHostProvider</strong>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HostProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> InetSocketAddress <span class="title">next</span><span class="params">(<span class="keyword">long</span> spinDelay)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010125.png"></p><p>HostProviderä¸‰è¦ç´ ï¼š</p><ul><li><p><strong>next()æ–¹æ³•å¿…é¡»è¦æœ‰åˆæ³•çš„è¿”å›å€¼ã€‚</strong></p><p>å‡¡æ˜¯å¯¹è¯¥æ–¹æ³•çš„è°ƒç”¨ï¼Œå¿…é¡»è¦è¿”å›ä¸€ä¸ªåˆæ³•çš„InetSocketAddresså¯¹è±¡ï¼Œä¸èƒ½ä¸ºnullæˆ–ä¸åˆæ³•å¯¹è±¡ã€‚</p></li><li><p><strong>next()æ–¹æ³•å¿…é¡»è¿”å›å·²è§£æçš„InetSocketAddresså¯¹è±¡ã€‚</strong></p><p>æœåŠ¡å™¨åœ°å€åˆ—è¡¨ä¿å­˜åœ¨ <code>ConnectStringParser.serverAddresses</code> ä¸­æ˜¯æ²¡æœ‰è¢«è§£æçš„InetSocketAddressï¼Œä¼ é€’åˆ°HostProvideråæ‰ä¼šè¢«è§£æï¼Œä¸ä¸€å®šæ˜¯åœ¨next()ä¸­è§£æï¼Œä½†next()è¿”å›çš„å¿…é¡»æ˜¯å·²è§£æçš„InetSocketAddresså¯¹è±¡ã€‚</p></li><li><p><strong>size()æ–¹æ³•ä¸èƒ½è¿”å›0ã€‚</strong></p><p>HostProviderå¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæœåŠ¡å™¨åœ°å€ã€‚</p></li></ul><h4 id="ï¼ˆ3ï¼‰StaticHostProvider"><a href="#ï¼ˆ3ï¼‰StaticHostProvider" class="headerlink" title="ï¼ˆ3ï¼‰StaticHostProvider"></a>ï¼ˆ3ï¼‰StaticHostProvider</h4><p>StaticHostProvideræ˜¯HostProvideræ¥å£çš„é»˜è®¤å®ç°ï¼Œæ•°æ®ç»“æ„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010126.png"></p><ul><li><p><strong>è§£ææœåŠ¡å™¨åœ°å€ï¼š</strong>å¯¹ <code>ConnectStringParser.serverAddresses</code> ä¸­æ²¡æœ‰è¢«è§£æçš„æœåŠ¡å™¨åœ°å€é€ä¸ªè¿›è¡Œè§£æï¼Œå†æ”¾åˆ° serverAddresses é›†åˆä¸­ã€‚åŒæ—¶ä½¿ç”¨Collectionså·¥å…·ç±»çš„shuffleæ–¹æ³•æ¥å°†å…¶éšæœºæ‰“æ•£ã€‚</p></li><li><p><strong>è·å–å¯ç”¨çš„æœåŠ¡å™¨åœ°å€ï¼š</strong>è°ƒç”¨ next() æ–¹æ³•è·å–ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨åœ°å€ï¼Œå…¶å¹¶éæ˜¯ç®€å•çš„ä»é›†åˆä¸­ä¸€æ¬¡è·å–åœ°å€ï¼Œè€Œæ˜¯å°†æ‰“æ•£çš„åœ°å€åˆ—è¡¨å…ˆæ‹¼è£…æˆä¸€ä¸ªç¯å½¢å¾ªç¯é˜Ÿåˆ—ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010127.png"></p><p>æœåŠ¡å™¨åœ°å€åˆ—è¡¨å¯èƒ½ä¼šè¾ƒå°‘ï¼Œæ‰€ä»¥å½“ä¸¤ä¸ªæ¸¸æ ‡å€¼ç›¸åŒæ—¶ï¼Œä¼šè¿›è¡ŒspinDelayæ¯«ç§’æ—¶é—´çš„ç­‰å¾…ã€‚</p></li></ul><h4 id="è‡ªå®šä¹‰HostProvider"><a href="#è‡ªå®šä¹‰HostProvider" class="headerlink" title="è‡ªå®šä¹‰HostProvider"></a>è‡ªå®šä¹‰HostProvider</h4><ul><li><strong>é…ç½®æ–‡ä»¶æ–¹å¼ï¼š</strong>ZKé»˜è®¤å®ç°ä¸­æ˜¯ä¼ å…¥æœåŠ¡å™¨åœ°å€åˆ—è¡¨åˆ°æ„é€ å‡½æ•°ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°ä¸€ä¸ªHostProvideråœ¨åº”ç”¨å¯åŠ¨æ—¶åŠ è½½é…ç½®æ–‡ä»¶æ¥å®ç°åœ°å€åˆ—è¡¨çš„è·å–ã€‚</li><li><strong>åŠ¨æ€å˜æ›´çš„åœ°å€åˆ—è¡¨ç®¡ç†å™¨ï¼š</strong>ZKé›†ç¾¤çš„æ•´ä½“è¿ç§»æˆ–ä¸ªåˆ«æœºå™¨å˜æ›´ï¼Œä¼šå¯¼è‡´å¤§æ‰¹å®¢æˆ·ç«¯åº”ç”¨ä¹Ÿè¦ä¸€èµ·å˜æ›´ï¼Œå› ä¸ºæˆ‘ä»¬å°†IPåœ°å€å†™æ­»åœ¨ç¨‹åºä¸­ã€‚å¯ä»¥å®ç°ä¸€ä¸ªHostProviderèƒ½å®šæ—¶ä»DNSæˆ–é…ç½®ç®¡ç†ä¸­å¿ƒä¸Šè§£æå‡ºZKæœåŠ¡å™¨åœ°å€åˆ—è¡¨ï¼Œå½“åœ°å€åˆ—è¡¨å˜æ›´æ—¶ï¼ŒåŒæ­¥æ›´æ–°åˆ°serverAddressesé›†åˆã€‚</li><li><strong>å®ç°åŒæœºæˆ¿ä¼˜å…ˆç­–ç•¥ï¼š</strong>é¡¹ç›®è§„æ¨¡æ‰©å¤§åˆ°ä¸€å®šç¨‹åº¦ï¼Œå¯èƒ½å‡ºç°å¤šæœºæˆ¿æˆ–å¼‚åœ°æœºæˆ¿ï¼Œå¦‚ä½•è§£å†³ä¸åŒæœºæˆ¿ä¹‹é—´çš„å»¶æ—¶ï¼ˆé€šå¸¸å¯èƒ½ä¼šè¾¾åˆ°å‡ åæ¯«ç§’ï¼‰ï¼Ÿå¼•å…¥åŒæœºæˆ¿ä¼˜å…ˆç­–ç•¥ï¼ŒæœåŠ¡çš„æ¶ˆè´¹è€…ä¼˜å…ˆæ¶ˆè´¹åŒä¸€ä¸ªæœºæˆ¿çš„æœåŠ¡ï¼Œå®ç°ä¸€ä¸ªHostProviderèƒ½ä¼˜å…ˆå’ŒåŒæœºæˆ¿çš„ZKæœåŠ¡å™¨åˆ›å»ºä¼šè¯ã€‚</li></ul><h3 id="3-3-ClientCnxn-ç½‘ç»œI-O"><a href="#3-3-ClientCnxn-ç½‘ç»œI-O" class="headerlink" title="3.3 ClientCnxn-ç½‘ç»œI/O"></a>3.3 ClientCnxn-ç½‘ç»œI/O</h3><p>ClientCnxnè´Ÿè´£å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„ç½‘ç»œè¿æ¥å¹¶è¿›è¡Œä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡ã€‚</p><h4 id="ï¼ˆ1ï¼‰Packet"><a href="#ï¼ˆ1ï¼‰Packet" class="headerlink" title="ï¼ˆ1ï¼‰Packet"></a>ï¼ˆ1ï¼‰Packet</h4><p>Packetæ˜¯å¯¹åè®®å±‚çš„å°è£…ï¼Œä½œä¸ºè¯·æ±‚å’Œå“åº”çš„è½½ä½“ï¼ŒClientCnxnçš„é™æ€å†…éƒ¨ç±»ï¼Œç»“æ„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010128.png"></p><p>Packetçš„createBB()æ–¹æ³•è´Ÿè´£å¯¹Packetå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œæœ€ç»ˆç”Ÿæˆç”¨äºç½‘ç»œä¼ è¾“çš„ByteBufferå¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹<strong>åªä¼šå°† requestHeaderã€requestå’ŒreadOnlyä¸‰ä¸ªå±æ€§åºåˆ—åŒ–</strong>ï¼Œå…¶ä½™éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ä¸Šä¸‹æ–‡ä¸­ä¸ä¼šå‚ä¸ç½‘ç»œä¼ è¾“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Packet</span> </span>&#123;</span><br><span class="line">    RequestHeader requestHeader;</span><br><span class="line">    ReplyHeader replyHeader;</span><br><span class="line">    Record request;</span><br><span class="line">    Record response;</span><br><span class="line">    ByteBuffer bb;</span><br><span class="line">    String clientPath;</span><br><span class="line">    String serverPath;</span><br><span class="line">    <span class="keyword">boolean</span> finished;</span><br><span class="line">    AsyncCallback cb;</span><br><span class="line">    Object ctx;</span><br><span class="line">    WatchRegistration watchRegistration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> readOnly;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">            boa.writeInt(-<span class="number">1</span>, <span class="string">&quot;len&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.requestHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// requestHeaderè¢«åºåˆ—åŒ–</span></span><br><span class="line">                <span class="keyword">this</span>.requestHeader.serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.request <span class="keyword">instanceof</span> ConnectRequest) &#123;</span><br><span class="line">                <span class="comment">// requestå’ŒreadOnlyè¢«åºåˆ—åŒ–</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">                boa.writeBool(<span class="keyword">this</span>.readOnly, <span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// requestè¢«åºåˆ—åŒ–</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="keyword">this</span>.bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line">            <span class="keyword">this</span>.bb.putInt(<span class="keyword">this</span>.bb.capacity() - <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.bb.rewind();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Ignoring unexpected exception&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰outgoingQueueå’ŒpendingQueue"><a href="#ï¼ˆ2ï¼‰outgoingQueueå’ŒpendingQueue" class="headerlink" title="ï¼ˆ2ï¼‰outgoingQueueå’ŒpendingQueue"></a>ï¼ˆ2ï¼‰outgoingQueueå’ŒpendingQueue</h4><ul><li>outgoingQueueï¼šå®¢æˆ·ç«¯è¯·æ±‚å‘é€é˜Ÿåˆ—ï¼Œå­˜å‚¨é‚£äº›éœ€è¦å‘é€åˆ°æœåŠ¡ç«¯çš„Packeté›†åˆã€‚</li><li>pendingQueueï¼šæœåŠ¡ç«¯å“åº”ç­‰å¾…é˜Ÿåˆ—ï¼Œå­˜å‚¨å·²ç»ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡ç«¯ï¼Œä½†éœ€è¦ç­‰å¾…å“åº”çš„Packeté›†åˆã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressFBWarnings(&#123;&quot;EI_EXPOSE_REP&quot;, &quot;EI_EXPOSE_REP2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxn.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SET_WATCHES_MAX_LENGTH = <span class="number">131072</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> disableAutoWatchReset = Boolean.getBoolean(<span class="string">&quot;zookeeper.disableAutoWatchReset&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;ClientCnxn.AuthData&gt; authInfo;</span><br><span class="line">    <span class="comment">// é“¾è¡¨ç»“æ„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; pendingQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; outgoingQueue;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ3ï¼‰åº•å±‚Socketé€šä¿¡å±‚â€”ClientCnxnSocket"><a href="#ï¼ˆ3ï¼‰åº•å±‚Socketé€šä¿¡å±‚â€”ClientCnxnSocket" class="headerlink" title="ï¼ˆ3ï¼‰åº•å±‚Socketé€šä¿¡å±‚â€”ClientCnxnSocket"></a>ï¼ˆ3ï¼‰åº•å±‚Socketé€šä¿¡å±‚â€”ClientCnxnSocket</h4><p>3.4.0ç‰ˆæœ¬åï¼Œä»ClientCnxnä¸­æŠ½ç¦»å‡ºClientCnxnSocketï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œä½¿å®¢æˆ·ç«¯ä»£ç ç»“æ„æ›´æ¸…æ™°çš„åŒæ—¶ä¹Ÿä¾¿äºå¯¹åº•å±‚Socketé€šä¿¡å±‚è¿›è¡Œæ‰©å±•ï¼ˆå¦‚ä½¿ç”¨Nettyå®ç°ï¼‰ã€‚</p><p>å¯ä»¥é€šè¿‡åœ¨ <code>zookeeper.clientCnxnSocket</code> è¿™ä¸ªç³»ç»Ÿå˜é‡ä¸­é…ç½® ClientCnxnSocket å®ç°ç±»çš„å…¨ç±»åï¼Œæ¥æŒ‡å®šè‡ªå®šä¹‰å®ç°ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZKé»˜è®¤å®ç°å³ClientCnxnSocketNIOï¼Œä½¿ç”¨JavaåŸç”Ÿçš„NIOæ¥å£ï¼Œæ ¸å¿ƒæ˜¯doIOé€»è¾‘ï¼Œè´Ÿè´£å¯¹è¯·æ±‚çš„å‘ç”Ÿå’Œå“åº”æ¥æ”¶è¿‡ç¨‹</span></span><br><span class="line"><span class="meta">-Dzookeeper.clientCnxnSocket</span>=<span class="string">org.apache.zookeeper.ClientCnxnSocketNIO</span></span><br></pre></td></tr></table></figure><ul><li><p><strong>è¯·æ±‚å‘é€ï¼š</strong></p><ul><li>ä»outgoingQueueé˜Ÿåˆ—æå–å‡ºä¸€ä¸ªå¯å‘é€çš„Packetå¯¹è±¡ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚åºå·XIDå¹¶å°†å…¶è®¾ç½®åˆ°Packetè¯·æ±‚å¤´ä¸­ï¼Œå†å°†å…¶åºåˆ—åŒ–åå‘é€ã€‚</li><li>å¯å‘é€æ˜¯æŒ‡ï¼Œæ£€æµ‹åˆ°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´æ­£åœ¨å¤„ç†SASLæƒé™æ—¶ï¼Œä¸åŒ…å«è¯·æ±‚å¤´ï¼ˆrequestHeaderï¼‰çš„Packetï¼ˆå¦‚ä¼šè¯åˆ›å»ºè¯·æ±‚ï¼‰å¯ä»¥è¢«å‘é€ï¼Œå…¶ä½™éƒ½æ— æ³•å‘é€ã€‚</li><li>å‘é€å®Œæ¯•ï¼Œä¼šç«‹å³å°†Packetä¿å­˜åˆ°pendingQueueé˜Ÿåˆ—ã€‚</li></ul></li><li><p><strong>å“åº”æ¥æ”¶ï¼š</strong>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„å®Œæ•´å“åº”æ•°æ®åï¼Œä¸åŒçš„å®¢æˆ·ç«¯è¯·æ±‚ç±»å‹ä¼šè¿›è¡Œä¸åŒçš„å¤„ç†</p><ul><li>å¦‚æœæ£€æµ‹åˆ°<strong>å½“å‰å®¢æˆ·ç«¯å°šæœªè¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œè¯´æ˜å½“å‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´æ­£åœ¨è¿›è¡Œä¼šè¯åˆ›å»ºï¼Œç›´æ¥å°†æ¥æ”¶åˆ°çš„ByteBufferï¼ˆincomingBufferï¼‰åºåˆ—åŒ–ä¸ºConnectResponseå¯¹è±¡ã€‚</li><li>å¦‚æœå½“å‰å®¢æˆ·ç«¯å·²ç»å¤„äºæ­£å¸¸çš„ä¼šè¯å‘¨æœŸï¼Œä¸”<strong>æ¥æ”¶åˆ°çš„æœåŠ¡ç«¯å“åº”æ˜¯ä¸€ä¸ªäº‹ä»¶</strong>ï¼Œå°†æ¥æ”¶åˆ°çš„ByteBufferï¼ˆincomingBufferï¼‰åºåˆ—åŒ–ä¸ºWatcherEventå¯¹è±¡ï¼Œå¹¶å°†å…¶æ”¾å…¥å¾…å¤„ç†é˜Ÿåˆ—ä¸­ã€‚</li><li>å¦‚æœæ˜¯ä¸€ä¸ª<strong>å¸¸è§„çš„è¯·æ±‚å“åº”</strong>ï¼ˆCreateã€GetDataå’ŒExistç­‰æ“ä½œè¯·æ±‚ï¼‰ï¼Œä¼šä»pendingQueueé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªPacketæ¥è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚å®¢æˆ·ç«¯é¦–å…ˆé€šè¿‡æ£€éªŒæœåŠ¡ç«¯å“åº”ä¸­åŒ…å«çš„XIDå€¼æ¥ç¡®ä¿è¯·æ±‚å¤„ç†çš„é¡ºåºæ€§ï¼Œç„¶åå†å°†æ¥æ”¶åˆ°çš„ByteBufferï¼ˆincomingBufferï¼‰åºåˆ—åŒ–ä¸ºç›¸åº”çš„Responseå¯¹è±¡ã€‚</li></ul><p>æœ€ç»ˆä¼šåœ¨ ClientCnxn.finishPacket æ–¹æ³•ä¸­å¤„ç† Watcher æ³¨å†Œç­‰é€»è¾‘ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(ClientCnxn.Packet p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// é”™è¯¯ç ä¸ä¸º0åˆ™å°†Watcheræ·»åŠ åˆ°clientPathä¸ºkeyçš„æ•°ç»„</span></span><br><span class="line">        p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å›è°ƒå‡½æ•°ï¼Œæ›´æ–°Packetä¸ºç»ˆæ­¢ï¼Œå”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">synchronized</span>(p) &#123;</span><br><span class="line">            p.finished = <span class="keyword">true</span>;</span><br><span class="line">            p.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœ‰å›è°ƒå‡½æ•°ï¼Œæ›´æ–°Packetä¸ºç»ˆæ­¢ï¼Œå¢åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—</span></span><br><span class="line">        p.finished = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.eventThread.queuePacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010129.png"></p><p>æŠ½è±¡ç±»ClientCnxnSocketå®šä¹‰äº†ä¸€äº›æŠ½è±¡æ–¹æ³•ï¼Œå’ŒreadConnectResultçš„é»˜è®¤å®ç°ç­‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocket.class);</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ByteBuffer lenBuffer = ByteBuffer.allocateDirect(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">protected</span> ByteBuffer incomingBuffer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sentCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> recvCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastHeard;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastSend;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> now;</span><br><span class="line">    <span class="keyword">protected</span> SendThread sendThread;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sessionId;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocket() &#123;</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">        <span class="keyword">this</span>.sentCount = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">this</span>.recvCount = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">introduce</span><span class="params">(SendThread sendThread, <span class="keyword">long</span> sessionId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sendThread = sendThread;</span><br><span class="line">        <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = Time.currentElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleRecv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastHeard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getSentCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getRecvCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.recvCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSendAndHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="keyword">this</span>.incomingBuffer.getInt();</span><br><span class="line">        <span class="keyword">if</span> (len &gt;= <span class="number">0</span> &amp;&amp; len &lt; ClientCnxn.packetLen) &#123;</span><br><span class="line">            <span class="keyword">this</span>.incomingBuffer = ByteBuffer.allocate(len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Packet len&quot;</span> + len + <span class="string">&quot; is out of range!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readConnectResult</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;0x[&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] var2 = <span class="keyword">this</span>.incomingBuffer.array();</span><br><span class="line">            <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">                <span class="keyword">byte</span> b = var2[var4];</span><br><span class="line">                buf.append(Integer.toHexString(b) + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buf.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            LOG.trace(<span class="string">&quot;readConnectResult &quot;</span> + <span class="keyword">this</span>.incomingBuffer.remaining() + <span class="string">&quot; &quot;</span> + buf.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ConnectResponse conRsp = <span class="keyword">new</span> ConnectResponse();</span><br><span class="line">        conRsp.deserialize(bbia, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isRO = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isRO = bbia.readBool(<span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Connected to an old server; r-o mode will be unavailable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sessionId = conRsp.getSessionId();</span><br><span class="line">        <span class="keyword">this</span>.sendThread.onConnected(conRsp.getTimeOut(), <span class="keyword">this</span>.sessionId, conRsp.getPasswd(), isRO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> var1, List&lt;Packet&gt; var2, LinkedList&lt;Packet&gt; var3, ClientCnxn var4)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤å®ç°ClientCnxnSocketNIOï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocketNIO</span> <span class="keyword">extends</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocketNIO.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector = Selector.open();</span><br><span class="line">    <span class="keyword">private</span> SelectionKey sockKey;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocketNIO() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sockKey != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doIO</span><span class="params">(List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">int</span> rc = sock.read(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException(<span class="string">&quot;Unable to read additional data from server sessionid 0x&quot;</span> + Long.toHexString(<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, likely server has closed socket&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.incomingBuffer.hasRemaining()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.incomingBuffer.flip();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.incomingBuffer == <span class="keyword">this</span>.lenBuffer) &#123;</span><br><span class="line">                        ++<span class="keyword">this</span>.recvCount;</span><br><span class="line">                        <span class="keyword">this</span>.readLength();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.readConnectResult();</span><br><span class="line">                        <span class="keyword">this</span>.enableRead();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                        <span class="keyword">this</span>.initialized = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendThread.readResponse(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isWritable()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                    Packet p = <span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress());</span><br><span class="line">                    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastSend();</span><br><span class="line">                        <span class="keyword">if</span> (p.bb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                p.requestHeader.setXid(cnxn.getXid());</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            p.createBB();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        sock.write(p.bb);</span><br><span class="line">                        <span class="keyword">if</span> (!p.bb.hasRemaining()) &#123;</span><br><span class="line">                            ++<span class="keyword">this</span>.sentCount;</span><br><span class="line">                            outgoingQueue.removeFirstOccurrence(p);</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span>(pendingQueue) &#123;</span><br><span class="line">                                    pendingQueue.add(p);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !p.bb.hasRemaining()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Packet <span class="title">findSendablePacket</span><span class="params">(LinkedList&lt;Packet&gt; outgoingQueue, <span class="keyword">boolean</span> clientTunneledAuthenticationInProgress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((Packet)outgoingQueue.getFirst()).bb == <span class="keyword">null</span> &amp;&amp; clientTunneledAuthenticationInProgress) &#123;</span><br><span class="line">                ListIterator iter = outgoingQueue.listIterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">                    Packet p = (Packet)iter.next();</span><br><span class="line">                    <span class="keyword">if</span> (p.requestHeader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        iter.remove();</span><br><span class="line">                        outgoingQueue.add(<span class="number">0</span>, p);</span><br><span class="line">                        <span class="keyword">return</span> p;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">&quot;deferring non-priming packet: &quot;</span> + p + <span class="string">&quot;until SASL authentication completes.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (Packet)outgoingQueue.getFirst();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">            <span class="keyword">this</span>.sockKey.cancel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownInput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown input&quot;</span>, var7);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownOutput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown output&quot;</span>, var6);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during socket close&quot;</span>, var5);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during channel close&quot;</span>, var4);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var3) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;SendThread interrupted during sleep, ignoring&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sockKey = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Doing client selector close&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.selector.close();</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Closed client selector&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Ignoring exception during selector close&quot;</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketChannel <span class="title">createSock</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = SocketChannel.open();</span><br><span class="line">        sock.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        sock.socket().setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">        sock.socket().setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> sock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerAndConnect</span><span class="params">(SocketChannel sock, InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey = sock.register(<span class="keyword">this</span>.selector, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">boolean</span> immediateConnect = sock.connect(addr);</span><br><span class="line">        <span class="keyword">if</span> (immediateConnect) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = <span class="keyword">this</span>.createSock();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.registerAndConnect(sock, addr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Unable to open socket to &quot;</span> + addr);</span><br><span class="line">            sock.close();</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initialized = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getRemoteSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getLocalSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> waitTimeOut, List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.select((<span class="keyword">long</span>)waitTimeOut);</span><br><span class="line">        Set selected;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            selected = <span class="keyword">this</span>.selector.selectedKeys();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.updateNow();</span><br><span class="line">        Iterator var6 = selected.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">            SelectionKey k = (SelectionKey)var6.next();</span><br><span class="line">            SocketChannel sc = (SocketChannel)k.channel();</span><br><span class="line">            <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">8</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sc.finishConnect()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateLastSendAndHeard();</span><br><span class="line">                    <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">5</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.doIO(pendingQueue, outgoingQueue, cnxn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sendThread.getZkState().isConnected()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        selected.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;testableCloseSocket() called&quot;</span>);</span><br><span class="line">        ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i &amp; -<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey.interestOps(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Selector <span class="title">getSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.selector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.createBB();</span><br><span class="line">            ByteBuffer pbb = p.bb;</span><br><span class="line">            sock.write(pbb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ4ï¼‰SendThread"><a href="#ï¼ˆ4ï¼‰SendThread" class="headerlink" title="ï¼ˆ4ï¼‰SendThread"></a>ï¼ˆ4ï¼‰SendThread</h4><p>SendThreadæ˜¯å®¢æˆ·ç«¯ClientCnxnå†…éƒ¨ä¸€ä¸ªæ ¸å¿ƒçš„I/Oè°ƒåº¦çº¿ç¨‹ï¼Œç»´æŠ¤äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡åœ¨ä¸€å®šçš„å‘¨æœŸé¢‘ç‡å†…å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªPINGåŒ…æ¥å®ç°å¿ƒè·³æ£€æµ‹ã€‚ä¼šè¯å‘¨æœŸå†…ä¸€æ—¦TCPè¿æ¥æ–­å¼€ï¼Œå°±ä¼šè‡ªåŠ¨ä¸”é€æ˜åŒ–çš„å®Œæˆé‡è¿æ“ä½œã€‚</p><p>ç®¡ç†äº†å®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚å‘é€å’Œå“åº”æ¥æ”¶æ“ä½œï¼Œå°†ä¸Šå±‚å®¢æˆ·ç«¯APIæ“ä½œè½¬æ¢ä¸ºç›¸åº”çš„è¯·æ±‚åè®®å¹¶å‘é€åˆ°æœåŠ¡ç«¯ï¼Œå®Œæˆå¯¹åŒæ­¥è°ƒç”¨çš„è¿”å›å’Œå¼‚æ­¥è°ƒç”¨çš„å›è°ƒã€‚è¿˜è´Ÿè´£å°†æ¥è‡ªæœåŠ¡ç«¯çš„äº‹ä»¶ä¼ é€’ç»™EventThreadå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastPingSentNs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientCnxnSocket clientCnxnSocket;</span><br><span class="line">    <span class="keyword">private</span> Random r = <span class="keyword">new</span> Random(System.nanoTime());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstConnect = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> InetSocketAddress rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> minPingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> maxPingRwTimeout = <span class="number">60000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RETRY_CONN_MSG = <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å“åº”ä¿¡æ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ReplyHeader replyHdr = <span class="keyword">new</span> ReplyHeader();</span><br><span class="line">        replyHdr.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">        <span class="comment">// è¯·æ±‚å’Œå“åº”åºå·ä¸ºè´Ÿå€¼çš„å‡ ç§ç‰¹æ®Šæƒ…å†µï¼Œ-1ä¸ºé€šçŸ¥ï¼Œ-2ä¸ºpingè¯·æ±‚ï¼Œ-4æƒé™</span></span><br><span class="line">        <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got ping response for sessionid: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; after &quot;</span> + (System.nanoTime() - <span class="keyword">this</span>.lastPingSentNs) / <span class="number">1000000L</span> + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (replyHdr.getErr() == Code.AUTHFAILED.intValue()) &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got auth sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got notification sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºç›‘å¬äº‹ä»¶ï¼Œå°†å“åº”å†…å®¹ååºåˆ—åŒ–</span></span><br><span class="line">            WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">            event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœç›¸å¯¹è·¯å¾„ä¸ä¸ºç©ºï¼Œå¤„ç†ä¸‹è·¯å¾„</span></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String serverPath = event.getPath();</span><br><span class="line">                <span class="keyword">if</span> (serverPath.compareTo(ClientCnxn.<span class="keyword">this</span>.chrootPath) == <span class="number">0</span>) &#123;</span><br><span class="line">                    event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; ClientCnxn.<span class="keyword">this</span>.chrootPath.length()) &#123;</span><br><span class="line">                    event.setPath(serverPath.substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Got server path &quot;</span> + event.getPath() + <span class="string">&quot; which is too short for chroot path &quot;</span> + ClientCnxn.<span class="keyword">this</span>.chrootPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// WatcherEventå†å°è£…ä¸ºWatchedEventï¼Œå¹¶åŠ å…¥eventThreadé˜Ÿåˆ—</span></span><br><span class="line">            WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got &quot;</span> + we + <span class="string">&quot; for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(we);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.clientTunneledAuthenticationInProgress()) &#123;</span><br><span class="line">            <span class="comment">// å¼€å¯SASL</span></span><br><span class="line">            GetSASLRequest request = <span class="keyword">new</span> GetSASLRequest();</span><br><span class="line">            request.deserialize(bbia, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.respondToServer(request.getToken(), ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// éç‰¹æ®Šæƒ…å†µ</span></span><br><span class="line">            ClientCnxn.Packet packet;</span><br><span class="line">            <span class="comment">// é”ä½å“åº”é˜Ÿåˆ—ï¼Œç§»å‡ºPacket</span></span><br><span class="line">            <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.pendingQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Nothing in the queue, but got &quot;</span> + replyHdr.getXid());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                packet = (ClientCnxn.Packet)ClientCnxn.<span class="keyword">this</span>.pendingQueue.remove();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å“åº”åºå·å’Œè¯·æ±‚åºå·ä¸åŒ¹é…ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span> (packet.requestHeader.getXid() != replyHdr.getXid()) &#123;</span><br><span class="line">                    packet.replyHeader.setErr(Code.CONNECTIONLOSS.intValue());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xid out of order. Got Xid &quot;</span> + replyHdr.getXid() + <span class="string">&quot; with err &quot;</span> + replyHdr.getErr() + <span class="string">&quot; expected Xid &quot;</span> + packet.requestHeader.getXid() + <span class="string">&quot; for a packet with details: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å°†å“åº”ååºåˆ—åŒ–å‡ºçš„headerä¿¡æ¯å¡å…¥Packetå¯¹è±¡</span></span><br><span class="line">                packet.replyHeader.setXid(replyHdr.getXid());</span><br><span class="line">                packet.replyHeader.setErr(replyHdr.getErr());</span><br><span class="line">                packet.replyHeader.setZxid(replyHdr.getZxid());</span><br><span class="line">                <span class="keyword">if</span> (replyHdr.getZxid() &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.lastZxid = replyHdr.getZxid();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// responseååºåˆ—åŒ–å¡å…¥Packetå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (packet.response != <span class="keyword">null</span> &amp;&amp; replyHdr.getErr() == <span class="number">0</span>) &#123;</span><br><span class="line">                    packet.response.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    ClientCnxn.LOG.debug(<span class="string">&quot;Reading reply sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, packet:: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// æœ€ç»ˆæ³¨å†Œä¸‹Watchç­‰</span></span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.finishPacket(packet);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SendThread(ClientCnxnSocket clientCnxnSocket) &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-SendThread()&quot;</span>));</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket = clientCnxnSocket;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">States <span class="title">getZkState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ClientCnxnSocket <span class="title">getClientCnxnSocket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.clientCnxnSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">primeConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Socket connection established to &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, initiating session&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.isFirstConnect = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">long</span> sessId = ClientCnxn.<span class="keyword">this</span>.seenRwServerBefore ? ClientCnxn.<span class="keyword">this</span>.sessionId : <span class="number">0L</span>;</span><br><span class="line">        ConnectRequest conReq = <span class="keyword">new</span> ConnectRequest(<span class="number">0</span>, ClientCnxn.<span class="keyword">this</span>.lastZxid, ClientCnxn.<span class="keyword">this</span>.sessionTimeout, sessId, ClientCnxn.<span class="keyword">this</span>.sessionPasswd);</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.disableAutoWatchReset) &#123;</span><br><span class="line">                List&lt;String&gt; dataWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getDataWatches();</span><br><span class="line">                List&lt;String&gt; existWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getExistWatches();</span><br><span class="line">                List&lt;String&gt; childWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getChildWatches();</span><br><span class="line">                <span class="keyword">if</span> (!dataWatches.isEmpty() || !existWatches.isEmpty() || !childWatches.isEmpty()) &#123;</span><br><span class="line">                    Iterator&lt;String&gt; dataWatchesIter = <span class="keyword">this</span>.prependChroot(dataWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; existWatchesIter = <span class="keyword">this</span>.prependChroot(existWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; childWatchesIter = <span class="keyword">this</span>.prependChroot(childWatches).iterator();</span><br><span class="line">                    <span class="keyword">long</span> setWatchesLastZxid = ClientCnxn.<span class="keyword">this</span>.lastZxid;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(dataWatchesIter.hasNext() || existWatchesIter.hasNext() || childWatchesIter.hasNext()) &#123;</span><br><span class="line">                        List&lt;String&gt; dataWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; existWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; childWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">                        String watch;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> batchLength = <span class="number">0</span>; batchLength &lt; <span class="number">131072</span>; batchLength += watch.length()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (dataWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)dataWatchesIter.next();</span><br><span class="line">                                dataWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (existWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)existWatchesIter.next();</span><br><span class="line">                                existWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!childWatchesIter.hasNext()) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                watch = (String)childWatchesIter.next();</span><br><span class="line">                                childWatchesBatch.add(watch);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        SetWatches sw = <span class="keyword">new</span> SetWatches(setWatchesLastZxid, dataWatchesBatch, existWatchesBatch, childWatchesBatch);</span><br><span class="line">                        RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">                        h.setType(<span class="number">101</span>);</span><br><span class="line">                        h.setXid(-<span class="number">8</span>);</span><br><span class="line">                        ClientCnxn.Packet packet = <span class="keyword">new</span> ClientCnxn.Packet(h, <span class="keyword">new</span> ReplyHeader(), sw, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">                        ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(packet);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Iterator var22 = ClientCnxn.<span class="keyword">this</span>.authInfo.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var22.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet((RequestHeader)<span class="keyword">null</span>, (ReplyHeader)<span class="keyword">null</span>, conReq, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>, ClientCnxn.<span class="keyword">this</span>.readOnly));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ClientCnxn.AuthData id = (ClientCnxn.AuthData)var22.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet(<span class="keyword">new</span> RequestHeader(-<span class="number">4</span>, <span class="number">100</span>), (ReplyHeader)<span class="keyword">null</span>, <span class="keyword">new</span> AuthPacket(<span class="number">0</span>, id.scheme, id.data), (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.enableReadWriteOnly();</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">            ClientCnxn.LOG.debug(<span class="string">&quot;Session establishment request sent on &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">prependChroot</span><span class="params">(List&lt;String&gt; paths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span> &amp;&amp; !paths.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.size(); ++i) &#123;</span><br><span class="line">                String clientPath = (String)paths.get(i);</span><br><span class="line">                String serverPath;</span><br><span class="line">                <span class="keyword">if</span> (clientPath.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath + clientPath;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                paths.set(i, serverPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run()è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastPingSentNs = System.nanoTime();</span><br><span class="line">        <span class="comment">// åºå·å›ºå®šä¸º-2</span></span><br><span class="line">        RequestHeader h = <span class="keyword">new</span> RequestHeader(-<span class="number">2</span>, <span class="number">11</span>);</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.queuePacket(h, (ReplyHeader)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (AsyncCallback)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹è¿æ¥ï¼Œrun()è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startConnect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.setName(<span class="keyword">this</span>.getName().replaceAll(<span class="string">&quot;\\(.*\\)&quot;</span>, <span class="string">&quot;(&quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort() + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="comment">// SASLå¼€å¯æ—¶ï¼Œå®ä¾‹åŒ–å®¢æˆ·ç«¯</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient = <span class="keyword">new</span> ZooKeeperSaslClient(SaslServerPrincipal.getServerPrincipal(addr));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LoginException var3) &#123;</span><br><span class="line">                ClientCnxn.LOG.warn(<span class="string">&quot;SASL configuration failed: &quot;</span> + var3 + <span class="string">&quot; Will continue connection to Zookeeper server without SASL authentication, if Zookeeper server allows it.&quot;</span>);</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">                <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.logStartConnect(addr);</span><br><span class="line">        <span class="comment">// æ³¨å†Œå¹¶è¿æ¥Socket</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.connect(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logStartConnect</span><span class="params">(InetSocketAddress addr)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="string">&quot;Opening socket connection to server &quot;</span> + addr;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg = msg + <span class="string">&quot;. &quot;</span> + ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getConfigStatus();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ClientCnxnSocketæ„å»ºä¼šè¯å’ŒThreadï¼Œæ›´æ–°å‡ ä¸ªå‚æ•°å±æ€§</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.introduce(<span class="keyword">this</span>, ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">        <span class="keyword">long</span> lastPingRwServer = Time.currentElapsedTime();</span><br><span class="line">        <span class="keyword">int</span> MAX_SEND_PING_INTERVAL = <span class="keyword">true</span>;</span><br><span class="line">        InetSocketAddress serverAddress = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çŠ¶æ€å­˜æ´»ä¸€ç›´å¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span>(ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Socketè¿˜æœªè¿æ¥ä¸Šï¼Œåˆ™æ›´å…·</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.clientCnxnSocket.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// å½“å‰éé¦–æ¬¡è¿æ¥å°±ä¼‘çœ ç­‰å¾…(0åˆ°1000çš„éšæœºæ•°)ï¼Œç­‰å¾…è¿æ¥å»ºç«‹</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.isFirstConnect) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep((<span class="keyword">long</span>)<span class="keyword">this</span>.r.nextInt(<span class="number">1000</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">                            ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var10);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœå·²ç»ç»“æŸåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing || !ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è·å–æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.rwServerAddress != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        serverAddress = <span class="keyword">this</span>.rwServerAddress;</span><br><span class="line">                        <span class="keyword">this</span>.rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        serverAddress = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">1000L</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è°ƒç”¨startConnectå»ºç«‹è¿æ¥</span></span><br><span class="line">                    <span class="keyword">this</span>.startConnect(serverAddress);</span><br><span class="line">                    <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> to;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// å½“å‰å·²è¿æ¥</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> sendAuthEvent = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getSaslState() == SaslState.INITIAL) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.initialize(ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (SaslException var9) &#123;</span><br><span class="line">                                ClientCnxn.LOG.error(<span class="string">&quot;SASL authentication with Zookeeper Quorum member failed: &quot;</span> + var9);</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        KeeperState authState = ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getKeeperState();</span><br><span class="line">                        <span class="keyword">if</span> (authState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (authState == KeeperState.AuthFailed) &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authState == KeeperState.SaslAuthenticated) &#123;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (sendAuthEvent) &#123;</span><br><span class="line">                            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, authState, (String)<span class="keyword">null</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.readTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å½“å‰è¿˜æœªè¿æ¥</span></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.connectTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ä¼šè¯è¶…æ—¶</span></span><br><span class="line">                <span class="keyword">if</span> (to &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    String warnInfo = <span class="string">&quot;Client session timed out, have not heard from server in &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv() + <span class="string">&quot;ms for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">                    ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionTimeoutException(warnInfo);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å·²è¿æ¥åˆ™å®šæ—¶å‘é€Ping</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> timeToNextPing = ClientCnxn.<span class="keyword">this</span>.readTimeout / <span class="number">2</span> - <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() - (<span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &gt; <span class="number">1000</span> ? <span class="number">1000</span> : <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (timeToNextPing &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &lt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (timeToNextPing &lt; to) &#123;</span><br><span class="line">                            to = timeToNextPing;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendPing();</span><br><span class="line">                        <span class="keyword">this</span>.clientCnxnSocket.updateLastSend();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// CONNECTED_READ_ONLYçŠ¶æ€ï¼Œæ›´æ–°to</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state == States.CONNECTEDREADONLY) &#123;</span><br><span class="line">                    <span class="keyword">long</span> now = Time.currentElapsedTime();</span><br><span class="line">                    <span class="keyword">int</span> idlePingRwServer = (<span class="keyword">int</span>)(now - lastPingRwServer);</span><br><span class="line">                    <span class="keyword">if</span> (idlePingRwServer &gt;= <span class="keyword">this</span>.pingRwTimeout) &#123;</span><br><span class="line">                        lastPingRwServer = now;</span><br><span class="line">                        idlePingRwServer = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">this</span>.pingRwTimeout = Math.min(<span class="number">2</span> * <span class="keyword">this</span>.pingRwTimeout, <span class="number">60000</span>);</span><br><span class="line">                        <span class="keyword">this</span>.pingRwServer();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = Math.min(to, <span class="keyword">this</span>.pingRwTimeout - idlePingRwServer);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨åº•å±‚ä¼ è¾“æ¥å£</span></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.doTransport(to, ClientCnxn.<span class="keyword">this</span>.pendingQueue, ClientCnxn.<span class="keyword">this</span>.outgoingQueue, ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        ClientCnxn.LOG.debug(<span class="string">&quot;An exception was thrown while closing send thread for session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()) + <span class="string">&quot; : &quot;</span> + var11.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionExpiredException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionTimeoutException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.EndOfStreamException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.RWServerFoundException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> SocketException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(<span class="string">&quot;Socket error occurred: &#123;&#125;: &#123;&#125;&quot;</span>, serverAddress, var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Session 0x&#123;&#125; for server &#123;&#125;, unexpected error&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()), serverAddress, <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>, var11&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.cleanup();</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾ªç¯ç»“æŸï¼Œç»ˆæ­¢çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">this</span>.cleanup();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.close();</span><br><span class="line">        <span class="comment">// è‹¥æ­¤æ—¶çŠ¶æ€è¿˜æ˜¯å­˜æ´»ï¼Œå‘é€æ–­å¼€è¿æ¥äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZooTrace.logTraceMessage(ClientCnxn.LOG, ZooTrace.getTextTraceLevel(), <span class="string">&quot;SendThread exited loop for session: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pingRwServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientCnxn.RWServerFoundException, UnknownHostException </span>&#123;</span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line">        InetSocketAddress addr = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">0L</span>);</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Checking server &quot;</span> + addr + <span class="string">&quot; for being r/w. Timeout &quot;</span> + <span class="keyword">this</span>.pingRwTimeout);</span><br><span class="line">        Socket sock = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sock = <span class="keyword">new</span> Socket(addr.getHostName(), addr.getPort());</span><br><span class="line">            sock.setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">            sock.setSoTimeout(<span class="number">1000</span>);</span><br><span class="line">            sock.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">            sock.getOutputStream().write(<span class="string">&quot;isro&quot;</span>.getBytes());</span><br><span class="line">            sock.getOutputStream().flush();</span><br><span class="line">            sock.shutdownOutput();</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(sock.getInputStream()));</span><br><span class="line">            result = br.readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConnectException var21) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var22) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Exception while seeking for r/w server &quot;</span> + var22.getMessage(), var22);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var20) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var20);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var19) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var19);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;rw&quot;</span>.equals(result)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">            <span class="keyword">this</span>.rwServerAddress = addr;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.RWServerFoundException(<span class="string">&quot;Majority server found at &quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.cleanup();</span><br><span class="line">        Iterator var2;</span><br><span class="line">        ClientCnxn.Packet p;</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.pendingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.pendingQueue.clear();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.outgoingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.outgoingQueue.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(<span class="keyword">int</span> _negotiatedSessionTimeout, <span class="keyword">long</span> _sessionId, <span class="keyword">byte</span>[] _sessionPasswd, <span class="keyword">boolean</span> isRO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout = _negotiatedSessionTimeout;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Expired, (String)<span class="keyword">null</span>));</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEventOfDeath();</span><br><span class="line">            String warnInfo = <span class="string">&quot;Unable to reconnect to ZooKeeper service, session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; has expired&quot;</span>;</span><br><span class="line">            ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionExpiredException(warnInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.<span class="keyword">this</span>.readOnly &amp;&amp; isRO) &#123;</span><br><span class="line">                ClientCnxn.LOG.error(<span class="string">&quot;Read/write client got connected to read-only server&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.readTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.connectTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout / ClientCnxn.<span class="keyword">this</span>.hostProvider.size();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.hostProvider.onConnected();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionId = _sessionId;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionPasswd = _sessionPasswd;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = isRO ? States.CONNECTEDREADONLY : States.CONNECTED;</span><br><span class="line">            ClientCnxn var10000 = ClientCnxn.<span class="keyword">this</span>;</span><br><span class="line">            var10000.seenRwServerBefore |= !isRO;</span><br><span class="line">            ClientCnxn.LOG.info(<span class="string">&quot;Session establishment complete on server &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, sessionid = 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, negotiated timeout = &quot;</span> + ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout + (isRO ? <span class="string">&quot; (READ-ONLY mode)&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            KeeperState eventState = isRO ? KeeperState.ConnectedReadOnly : KeeperState.SyncConnected;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, eventState, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.wakeupCnxn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.testableCloseSocket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">clientTunneledAuthenticationInProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.saslLoginFailed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient == <span class="keyword">null</span> ? <span class="keyword">true</span> : ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.clientTunneledAuthenticationInProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(ClientCnxn.Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.sendPacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ5ï¼‰EventThread"><a href="#ï¼ˆ5ï¼‰EventThread" class="headerlink" title="ï¼ˆ5ï¼‰EventThread"></a>ï¼ˆ5ï¼‰EventThread</h4><p>EventThreadæ˜¯ClientCnxnçš„å†…éƒ¨ç±»ï¼Œè´Ÿè´£å®¢æˆ·ç«¯çš„äº‹ä»¶å¤„ç†ï¼Œå¹¶è§¦å‘å®¢æˆ·ç«¯æ³¨å†Œçš„Watcherç›‘å¬ã€‚EventThreadä¸­æœ‰ä¸€ä¸ªwaitingEventsé˜Ÿåˆ—ï¼Œç”¨äºä¸´æ—¶å­˜æ”¾é‚£äº›éœ€è¦è¢«è§¦å‘çš„Objectï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯æ³¨å†Œçš„Watcherå’Œå¼‚æ­¥æ¥å£ä¸­æ³¨å†Œçš„å›è°ƒå™¨ AsyncCallbackã€‚</p><p>EventThreadä¼šä¸æ–­ä»waitingEventsä¸­å–å‡ºObjectï¼Œè¯†åˆ«å‡ºå…¶å…·ä½“ç±»å‹ï¼Œå¹¶åˆ†åˆ«è°ƒç”¨processå’ŒprocessResultæ¥å£æ–¹æ³•æ¥å®ç°å¯¹äº‹ä»¶çš„è§¦å‘å’Œå›è°ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EventThreadçº¿ç¨‹ä¸æ–­çš„ä»waitingEventsè¿™ä¸ªé˜Ÿåˆ—ä¸­å–å‡ºObjectï¼Œè¯†åˆ«å‡ºå…¶å…·ä½“ç±»å‹Watcheræˆ–è€…AsyncCallbackï¼Œå¹¶åˆ†åˆ«è°ƒç”¨processå’ŒprocessResultæ¥å£æ–¹æ³•æ¥å®ç°å¯¹äº‹ä»¶çš„è§¦å‘å’Œå›è°ƒã€‚</span></span><br><span class="line"><span class="comment">// watcherå°±æ˜¯æ•°æ®å˜æ›´é€šçŸ¥</span></span><br><span class="line"><span class="comment">// AsyncCallbackæ˜¯ZooKeeperå®¢æˆ·ç«¯çš„APIå‘½ä»¤ä¸­çš„å¼‚æ­¥APIï¼ŒZooKeeperå®¢æˆ·ç«¯çš„APIï¼Œåˆ›å»ºèŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€æƒé™æ§åˆ¶ã€è·å–å­èŠ‚ç‚¹ã€è·å–æ•°æ®å†…å®¹ã€è®¾ç½®æƒé™ã€è®¾ç½®æ•°æ®å†…å®¹éƒ½æœ‰ç›¸åº”çš„å¼‚æ­¥æ–¹å¼ï¼Œæœ‰StringCallbackã€VoidCallbackã€StatCallbackã€ACLCallbackã€ChildrenCallbackã€Children2Callbackã€DataCallbackä¸ƒç§</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;Object&gt; waitingEvents = <span class="keyword">new</span> LinkedBlockingQueue();</span><br><span class="line">    <span class="comment">//è¿™å®é™…ä¸Šæ˜¯é˜Ÿåˆ—ä¸­çš„ä¼šè¯çŠ¶æ€ï¼Œç›´åˆ°EventThreadäº‹ä»¶çº¿ç¨‹å®é™…å¤„ç†è¯¥äº‹ä»¶å¹¶å°†å…¶äº¤ç»™watcherä¸ºæ­¢ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> KeeperState sessionState;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> wasKilled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">    EventThread() &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-EventThread&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.sessionState = KeeperState.Disconnected;</span><br><span class="line">        <span class="keyword">this</span>.wasKilled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†WatchedEventåŠ å…¥åˆ°waitingEventsé˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">//åœ¨SendThreadçº¿ç¨‹çš„readResponse(ByteBuffer incomingBuffer)è¯»å–ä»æœåŠ¡å™¨ç«¯çš„response</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯äº‹ä»¶ï¼Œåˆ™è§£æååºåˆ—åŒ–è¿˜åŸæˆWatchedEventï¼Œè°ƒç”¨è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getType() != EventType.None || <span class="keyword">this</span>.sessionState != event.getState()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionState = event.getState();</span><br><span class="line">            ClientCnxn.WatcherSetEventPair pair = <span class="keyword">new</span> ClientCnxn.WatcherSetEventPair(ClientCnxn.<span class="keyword">this</span>.watcher.materialize(event.getState(), event.getType(), event.getPath()), event);</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(pair);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queuePacket</span><span class="params">(ClientCnxn.Packet packet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isRunning) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.processEvent(packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEventOfDeath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingEvents.add(ClientCnxn.<span class="keyword">this</span>.eventOfDeath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.isRunning = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//ä¸€ç›´å¾ªç¯ï¼Œä»waitingEventsé˜Ÿåˆ—ä¸­å–å‡ºWatchedEventæˆ–è€…Packet</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                Object event = <span class="keyword">this</span>.waitingEvents.take();</span><br><span class="line">                <span class="keyword">if</span> (event == ClientCnxn.<span class="keyword">this</span>.eventOfDeath) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wasKilled = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//å¤„ç†event</span></span><br><span class="line">                    <span class="keyword">this</span>.processEvent(event);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.waitingEvents.isEmpty()) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var5) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Event thread exiting due to interruption&quot;</span>, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;EventThread shut down for session: 0x&#123;&#125;&quot;</span>, Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//watcherç›‘å¬äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ClientCnxn.WatcherSetEventPair) &#123;</span><br><span class="line">                <span class="comment">// each watcher will process the event</span></span><br><span class="line">                ClientCnxn.WatcherSetEventPair pair = (ClientCnxn.WatcherSetEventPair)event;</span><br><span class="line">                <span class="comment">//å¾ªç¯watcheré›†åˆï¼Œè°ƒç”¨watcherçš„å›è°ƒæ–¹æ³•(WatchedEvent event)å¤„ç†è¯¥äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">                    Watcher watcher = (Watcher)var3.next();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//è¿˜è®°å¾—Watcheræ¥å£ä¸­å¯¹äºwatcherå®ç°ç±»éƒ½è¦å®ç°çš„ä¸€ä¸ªprocess(WatchedEvent event)æ–¹æ³•ï¼Œå°±æ˜¯è¿™ä¸ª</span></span><br><span class="line">                        watcher.process(pair.event);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                        ClientCnxn.LOG.error(<span class="string">&quot;Error while calling watcher &quot;</span>, var11);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¼‚æ­¥å›è°ƒ</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                ClientCnxn.Packet p = (ClientCnxn.Packet)event;</span><br><span class="line">                <span class="comment">//ResultCodeæœåŠ¡å™¨ç«¯å“åº”ç ï¼Œå¸¸è§ç å¦‚ä¸‹</span></span><br><span class="line">                <span class="comment">//0ï¼šæ¥å£è°ƒç”¨æˆåŠŸ -4å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯è¿æ¥å·²æ–­å¼€</span></span><br><span class="line">                <span class="comment">//-110æŒ‡å®šèŠ‚ç‚¹å·²å­˜åœ¨ -112ä¼šè¯å·²è¿‡æœŸ</span></span><br><span class="line">                <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">                String clientPath = p.clientPath;</span><br><span class="line">                <span class="keyword">if</span> (p.replyHeader.getErr() != <span class="number">0</span>) &#123;</span><br><span class="line">                    rc = p.replyHeader.getErr();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Somehow a null cb got to EventThread!&quot;</span>);</span><br><span class="line">                &#125; </span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯exists/setData/setAclå‘½ä»¤å¼‚æ­¥æ–¹å¼çš„æœåŠ¡å™¨ç«¯å“åº”</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!(p.response <span class="keyword">instanceof</span> ExistsResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetDataResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetACLResponse)) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//getDataå‘½ä»¤å¼‚æ­¥æ–¹å¼çš„æœåŠ¡å™¨å¼‚æ­¥å“åº”</span></span><br><span class="line">                    <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetDataResponse) &#123;</span><br><span class="line">                        DataCallback cbxxxx = (DataCallback)p.cb;</span><br><span class="line">                        GetDataResponse rspxxx = (GetDataResponse)p.response;</span><br><span class="line"><span class="comment">//rc==0è¡¨ç¤ºæ¥å£è°ƒç”¨æˆåŠŸ</span></span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, rspxxx.getData(), rspxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, (<span class="keyword">byte</span>[])<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">//getACLå‘½ä»¤å¼‚æ­¥æ–¹å¼çš„æœåŠ¡å™¨å¼‚æ­¥å“åº”</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetACLResponse) &#123;</span><br><span class="line">                        ACLCallback cbxxxxx = (ACLCallback)p.cb;</span><br><span class="line">                        GetACLResponse rspxxxx = (GetACLResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, rspxxxx.getAcl(), rspxxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildrenå‘½ä»¤çš„æœåŠ¡å™¨å“åº”</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildrenResponse) &#123;</span><br><span class="line">                        ChildrenCallback cbxxxxxx = (ChildrenCallback)p.cb;</span><br><span class="line">                        GetChildrenResponse rspxxxxx = (GetChildrenResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, rspxxxxx.getChildren());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildrenå‘½ä»¤å¼‚æ­¥æ–¹å¼çš„æœåŠ¡å™¨å¼‚æ­¥å“åº”ï¼Œä¸ä¸Šé¢çš„åŒºåˆ«åœ¨ä¸statä¿¡æ¯æ›´æ–°</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildren2Response) &#123;</span><br><span class="line">                        Children2Callback cbxxxxxxx = (Children2Callback)p.cb;</span><br><span class="line">                        GetChildren2Response rsp = (GetChildren2Response)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, rsp.getChildren(), rsp.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//createå‘½ä»¤å¼‚æ­¥æ–¹å¼çš„æœåŠ¡å™¨å¼‚æ­¥å“åº”</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> CreateResponse) &#123;</span><br><span class="line">                        StringCallback cb = (StringCallback)p.cb;</span><br><span class="line">                        CreateResponse rspx = (CreateResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, ClientCnxn.<span class="keyword">this</span>.chrootPath == <span class="keyword">null</span> ? rspx.getPath() : rspx.getPath().substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, (String)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//MultiResponse</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> MultiResponse) &#123;</span><br><span class="line">                        MultiCallback cbx = (MultiCallback)p.cb;</span><br><span class="line">                        MultiResponse rspxx = (MultiResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            List&lt;OpResult&gt; results = rspxx.getResultList();</span><br><span class="line">                            <span class="keyword">int</span> newRc = rc;</span><br><span class="line">                            Iterator var9 = results.iterator();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">                                OpResult result = (OpResult)var9.next();</span><br><span class="line">                                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ErrorResult &amp;&amp; Code.OK.intValue() != (newRc = ((ErrorResult)result).getErr())) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            cbx.processResult(newRc, clientPath, p.ctx, results);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb <span class="keyword">instanceof</span> VoidCallback) &#123;</span><br><span class="line">                        VoidCallback cbxx = (VoidCallback)p.cb;</span><br><span class="line">                        cbxx.processResult(rc, clientPath, p.ctx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    StatCallback cbxxx = (StatCallback)p.cb;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> ExistsResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((ExistsResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetDataResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetDataResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetACLResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetACLResponse)p.response).getStat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cbxxx.processResult(rc, clientPath, p.ctx, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Caught unexpected throwable&quot;</span>, var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šä¸€æ¬¡ä¼šè¯çš„åˆ›å»ºè¿‡ç¨‹ã€æœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€ClientCnxnç½‘ç»œI/Oï¼ˆPacketã€outgoingQueueå’ŒpendingQueueã€ClientCnxnSocketã€SendThreadã€EventThreadï¼‰ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•-ç³»ç»Ÿæ¨¡å‹å’Œåºåˆ—åŒ–åè®®</title>
    <link href="http://linyishui.top/2021061001.html"/>
    <id>http://linyishui.top/2021061001.html</id>
    <published>2021-06-10T07:03:45.000Z</published>
    <updated>2021-07-18T15:35:23.513Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"><a href="#ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•" class="headerlink" title="ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•"></a>ZooKeeperï¼ˆäº”ï¼‰æŠ€æœ¯å†…å¹•</h1><h2 id="ä¸€-ç³»ç»Ÿæ¨¡å‹"><a href="#ä¸€-ç³»ç»Ÿæ¨¡å‹" class="headerlink" title="ä¸€. ç³»ç»Ÿæ¨¡å‹"></a>ä¸€. ç³»ç»Ÿæ¨¡å‹</h2><h3 id="1-1-æ•°æ®æ¨¡å‹"><a href="#1-1-æ•°æ®æ¨¡å‹" class="headerlink" title="1.1 æ•°æ®æ¨¡å‹"></a>1.1 æ•°æ®æ¨¡å‹</h3><p>ZooKeeperçš„æ•°æ®æ¨¡å‹ä¸º ZNodeï¼Œå³æ•°æ®èŠ‚ç‚¹ï¼Œå¯ä»¥ä¿å­˜æ•°æ®ï¼ŒåŒäº‹å¯ä»¥æŒ‚è½½å­èŠ‚ç‚¹ï¼Œå› æ­¤æ„æˆäº†ä¸€ä¸ªå±‚æ¬¡åŒ–çš„å‘½åç©ºé—´ï¼Œä¸€ä¸ªæ ‘ç»“æ„ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010101.png"></p><p>ZooKeeperä¸­çš„äº‹åŠ¡æŒ‡èƒ½å¤Ÿæ”¹å˜ZKæœåŠ¡å™¨çŠ¶æ€çš„æ“ä½œï¼Œä¸€èˆ¬åŒ…æ‹¬æ•°æ®èŠ‚ç‚¹çš„åˆ›å»ºå’Œåˆ é™¤ã€æ•°æ®èŠ‚ç‚¹å†…å®¹æ›´æ–°å’Œå®¢æˆ·ç«¯ä¼šè¯åˆ›å»ºä¸å¤±æ•ˆç­‰æ“ä½œã€‚æ¯ä¸ªäº‹åŠ¡ä¼šè¢«åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„äº‹åŠ¡IDï¼Œå³ZXIDï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª64ä½çš„æ•°å­—ï¼Œæ¯ä¸ªZXIDå¯¹åº”ä¸€æ¬¡æ›´æ–°æ“ä½œï¼Œè€Œä¸”å¯ä»¥é—´æ¥çœ‹å‡ºZKå¤„ç†è¿™äº›è¯·æ±‚çš„å…¨å±€é¡ºåºã€‚</p><h3 id="1-2-èŠ‚ç‚¹ç‰¹æ€§"><a href="#1-2-èŠ‚ç‚¹ç‰¹æ€§" class="headerlink" title="1.2 èŠ‚ç‚¹ç‰¹æ€§"></a>1.2 èŠ‚ç‚¹ç‰¹æ€§</h3><h4 id="ï¼ˆ1ï¼‰èŠ‚ç‚¹ç±»å‹"><a href="#ï¼ˆ1ï¼‰èŠ‚ç‚¹ç±»å‹" class="headerlink" title="ï¼ˆ1ï¼‰èŠ‚ç‚¹ç±»å‹"></a>ï¼ˆ1ï¼‰èŠ‚ç‚¹ç±»å‹</h4><ul><li><strong>æŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENTï¼‰ï¼š</strong>æ•°æ®èŠ‚ç‚¹åˆ›å»ºåå°±ä¼šä¸€ç›´å­˜åœ¨äºZKæœåŠ¡å™¨ä¸Šï¼Œç›´åˆ°ç”±åˆ é™¤æ“ä½œä¸»åŠ¨æ¸…é™¤æ­¤èŠ‚ç‚¹ã€‚</li><li><strong>æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPERSISTENT_SEQUENTIALï¼‰ï¼š</strong>æœ‰é¢å¤–çš„é¡ºåºæ€§ç‰¹ç‚¹ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹éƒ½ä¼šä¸ºå®ƒçš„ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½é¡ºåºï¼Œåˆ›å»ºå­èŠ‚ç‚¹æ—¶å¯ä»¥è®¾ç½®è¿™ä¸ªæ ‡è®°ï¼ŒZKä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹åååŠ ä¸€ä¸ªæ•°å­—åç¼€ã€‚</li><li><strong>ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰ï¼š</strong>æ­¤èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸä¸å®¢æˆ·ç«¯ä¼šè¯ç»‘å®šï¼Œå½“ä¼šè¯å¤±æ•ˆï¼ŒèŠ‚ç‚¹å°±ä¼šè¢«è‡ªåŠ¨æ¸…ç†æ‰ï¼ˆéTCPè¿æ¥æ–­å¼€ï¼‰ï¼Œä¸´æ—¶èŠ‚ç‚¹åªèƒ½ä½œä¸ºå¶å­èŠ‚ç‚¹ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li><li><strong>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEPHEMERAL_SEQUENTIALï¼‰ï¼š</strong>é¢å¤–æœ‰äº†é¡ºåºæ€§ã€‚</li></ul><h4 id="ï¼ˆ2ï¼‰çŠ¶æ€ä¿¡æ¯"><a href="#ï¼ˆ2ï¼‰çŠ¶æ€ä¿¡æ¯" class="headerlink" title="ï¼ˆ2ï¼‰çŠ¶æ€ä¿¡æ¯"></a>ï¼ˆ2ï¼‰çŠ¶æ€ä¿¡æ¯</h4><p>é€šè¿‡getå‘½ä»¤è·å–ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹çš„å†…å®¹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010102.png"></p><p>ç¬¬ä¸€è¡Œæ˜¯æ•°æ®å†…å®¹ï¼Œåé¢å°±æ˜¯èŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯æ•°æ®èŠ‚ç‚¹çš„Statå¯¹è±¡çš„æ ¼å¼åŒ–è¾“å‡ºï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010103.png"></p><p>Statç±»åŒ…å«ä¸Šä¸€ä¸ªæ•°æ®èŠ‚ç‚¹çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼ˆäº‹åŠ¡IDã€ç‰ˆæœ¬ä¿¡æ¯å’Œå­èŠ‚ç‚¹ä¸ªæ•°ç­‰ï¼‰ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010104.png"></p><h3 id="1-3-ç‰ˆæœ¬â€”ä¹è§‚é”ä¿è¯åˆ†å¸ƒå¼æ•°æ®åŸå­æ€§æ“ä½œ"><a href="#1-3-ç‰ˆæœ¬â€”ä¹è§‚é”ä¿è¯åˆ†å¸ƒå¼æ•°æ®åŸå­æ€§æ“ä½œ" class="headerlink" title="1.3 ç‰ˆæœ¬â€”ä¹è§‚é”ä¿è¯åˆ†å¸ƒå¼æ•°æ®åŸå­æ€§æ“ä½œ"></a>1.3 ç‰ˆæœ¬â€”ä¹è§‚é”ä¿è¯åˆ†å¸ƒå¼æ•°æ®åŸå­æ€§æ“ä½œ</h3><p>æ¯ä¸ªæ•°æ®èŠ‚ç‚¹éƒ½æœ‰ä¸‰ç§ç±»ä¼¼æ–°çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010105.png"></p><p>å½“èŠ‚ç‚¹åˆ›å»ºåï¼Œversionå€¼ä¸º0ï¼Œå½“å¯¹æ­¤èŠ‚ç‚¹è¿›è¡Œæ›´æ–°åï¼Œæ›´æ–°ä¸º1ï¼Œä»£è¡¨å˜æ›´æ¬¡æ•°ã€‚é€šè¿‡ç‰ˆæœ¬å·å®ç°çš„ä¹è§‚é”æ¥å®ç°åœ¨æ•°æ®å¹¶å‘ç«äº‰ä¸å¤§ã€äº‹åŠ¡å†²çªè¾ƒå°‘çš„åº”ç”¨åœºæ™¯ã€‚</p><p>ZKçš„PrepRequestProcessorå¤„ç†å™¨ç±»ä¸­ï¼Œå¤„ç†æ¯ä¸ªæ•°æ®æ›´æ–°è¯·æ±‚ï¼ˆsetDataRequestï¼‰æ—¶ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹ç‰ˆæœ¬æ£€æŸ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version = setDataRequest.getVersion();</span><br><span class="line"><span class="comment">// è·å–å½“å‰æœåŠ¡å™¨ä¸Šè¯¥æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">int</span> currentVersion = nodeRecord.stat.getVersion();</span><br><span class="line"><span class="comment">// -1è¡¨ç¤ºå®¢æˆ·ç«¯ä¸è¦æ±‚ä½¿ç”¨ä¹è§‚é”</span></span><br><span class="line"><span class="keyword">if</span> (version != -<span class="number">1</span> &amp;&amp; version != currentVersion) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadVersionException(path);</span><br><span class="line">   &#125;</span><br><span class="line">version = currentVersion + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="1-4-Watcher"><a href="#1-4-Watcher" class="headerlink" title="1.4 Watcher"></a>1.4 Watcher</h3><p>ZKé€šè¿‡Watcheræœºåˆ¶æ¥å®ç°å‘å¸ƒ/è®¢é˜…çš„åˆ†å¸ƒå¼é€šçŸ¥åŠŸèƒ½ï¼Œå½“æœåŠ¡ç«¯æŒ‡å®šäº‹ä»¶è§¦å‘äº†Watcherï¼Œå°±ä¼šå‘æŒ‡å®šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010106.png"></p><h4 id="1-4-1-ç»“æ„"><a href="#1-4-1-ç»“æ„" class="headerlink" title="1.4.1 ç»“æ„"></a>1.4.1 ç»“æ„</h4><p>Watcherå¯¹è±¡å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„WatchManagerä¸­ï¼Œæ”¶åˆ°é€šçŸ¥åä»ä¸­å–å‡ºå¯¹åº”çš„Watcherå¯¹åº”æ¥æ‰§è¡Œå›è°ƒé€»è¾‘ã€‚</p><p>æ¥å£ç±»Watcherè¡¨ç¤ºä¸€ä¸ªæ ‡å‡†çš„äº‹ä»¶å¤„ç†å™¨ï¼ŒåŒ…å«KeeperStateå’ŒEventTypeä¸¤ä¸ªæšä¸¾ç±»ï¼Œåˆ†åˆ«è¡¨ç¤ºé€šçŸ¥çŠ¶æ€å’Œäº‹ä»¶ç±»å‹ï¼ŒåŒæ—¶å®šä¹‰äº†äº‹ä»¶çš„å›è°ƒæ–¹æ³•ï¼š<code>process(WatchedEvent event)</code> ã€‚</p><p>Watcheräº‹ä»¶å¸¸è§çš„é€šçŸ¥çŠ¶æ€å’Œäº‹ä»¶ç±»å‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010107.png"></p><p>å†…å®¹å˜æ›´åŒ…æ‹¬èŠ‚ç‚¹çš„æ•°æ®å†…å®¹å’Œæ•°æ®çš„ç‰ˆæœ¬å·dataVersionï¼Œå³ä½¿ç›¸åŒæ•°æ®å†…å®¹ï¼Œä¸€æ—¦æœ‰å®¢æˆ·ç«¯è°ƒç”¨æ•°æ®æ›´æ–°çš„æ¥å£ï¼Œè§¦å‘çš„æ›´æ–°ä¸€æ ·ä¼šå‘é€ç›¸åº”é€šçŸ¥ã€‚</p><p>AuthFailedæ˜¯æˆæƒå¤±è´¥è§¦å‘ï¼Œä½¿ç”¨é”™è¯¯çš„Authåªä¼šæŠ›å‡ºNoAuthExceptionå¼‚å¸¸ï¼Œè€Œä½¿ç”¨é”™è¯¯çš„Schemeåˆ™ä¼šæŠ›å‡ºAuthFailedExceptionï¼Œå¹¶ä¸”æ”¶åˆ°äº‹ä»¶é€šçŸ¥(AuthFailed, None)ã€‚</p><p>å›è°ƒæ–¹æ³• <code>process()</code> ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WatchedEventå¯¹è±¡å°è£…æœåŠ¡ç«¯äº‹ä»¶å¹¶ä¼ é€’ç»™Watcher</span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span></span>;</span><br></pre></td></tr></table></figure><p>WatchedEventåŒ…å«æ¯ä¸ªäº‹ä»¶çš„ä¸‰ä¸ªåŸºæœ¬å±æ€§ï¼šé€šçŸ¥çŠ¶æ€ï¼ˆKeeperStateï¼‰ã€äº‹ä»¶ç±»å‹ï¼ˆeventTypeï¼‰å’ŒèŠ‚ç‚¹è·¯å¾„ï¼ˆpathï¼‰ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010108.png"></p><p>ç›¸å¯¹çš„WatcherEventå®ç°äº†åºåˆ—å·æ¥å£ï¼Œå¯ä»¥ç”¨äºç½‘ç»œä¼ è¾“ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010109.png"></p><p>æœåŠ¡ç«¯ç”ŸæˆWatchedEventäº‹ä»¶åï¼Œä¼šè°ƒç”¨getWrapperæ–¹æ³•å°†è‡ªå·±åŒ…è£…æˆä¸€ä¸ªå¯åºåˆ—åŒ–çš„WatcherEventäº‹ä»¶ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ”¶åˆ°äº‹ä»¶å¯¹è±¡åä¼šå…ˆå°†WatcherEventè¿˜åŸä¸ºWatchedEventï¼Œå¹¶ä¼ é€’ç»™processæ–¹æ³•å¤„ç†ã€‚äºŒè€…å¯¹äºäº‹ä»¶çš„å°è£…éƒ½å¾ˆç®€å•ï¼Œæ¯”å¦‚èŠ‚ç‚¹æ•°æ®å˜æ›´ï¼Œå®¢æˆ·ç«¯æ— æ³•ç›´æ¥è·å–åˆ°åŸå§‹æ•°æ®å’Œå˜æ›´åæ•°æ®ï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">KeeperState:</span> SyncConnected</span><br><span class="line"><span class="symbol">EventType:</span> NodeDataChanged</span><br><span class="line"><span class="symbol">Path:</span> /zk-book</span><br></pre></td></tr></table></figure><p>Watcherå†…éƒ¨å„ç»„ä»¶é—´å…³ç³»ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010110.png"></p><h4 id="1-4-2-å®¢æˆ·ç«¯æ³¨å†ŒWatcher"><a href="#1-4-2-å®¢æˆ·ç«¯æ³¨å†ŒWatcher" class="headerlink" title="1.4.2 å®¢æˆ·ç«¯æ³¨å†ŒWatcher"></a>1.4.2 å®¢æˆ·ç«¯æ³¨å†ŒWatcher</h4><p>æ³¨å†ŒWatcherï¼š</p><ul><li><p>åˆ›å»ºZKå®¢æˆ·ç«¯å®ä¾‹æ—¶ï¼Œå¯ä»¥ç»™å®šä¸€ä¸ªé»˜è®¤çš„Watcherï¼Œå®ƒä¼šä¸€ç›´ä¿å­˜åœ¨å®¢æˆ·ç«¯ZKWatchManagerçš„defaultWatcherä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥é€šè¿‡ <code>getData()</code> ã€<code>getChildren()</code> å’Œ <code>exist()</code> ä¸‰ä¸ªæ¥å£æ¥æ³¨å†ŒWatcherï¼Œä¾‹å¦‚getDataï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  é€šè¿‡å¸ƒå°”å‚æ•°æ ‡è¯†æ˜¯å¦ä½¿ç”¨å‰é¢çš„é»˜è®¤Watcheræ¥è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getData(String path, <span class="keyword">boolean</span> watch, Stat stat);</span><br><span class="line"><span class="comment">// ç›´æ¥æä¾›Watcher</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getData(<span class="keyword">final</span> String path, Watcher watcher, Stat stat);</span><br></pre></td></tr></table></figure></li></ul><p>å®¢æˆ·ç«¯é¦–å…ˆä¼šå¯¹å½“å‰å®¢æˆ·ç«¯è¯·æ±‚requestè¿›è¡Œæ ‡è®°ï¼Œè®¾ç½®ä¸ºâ€œä½¿ç”¨Watcherç›‘å¬â€ï¼ŒåŒæ—¶å°è£…ä¸€ä¸ªWatcheræ³¨å†Œä¿¡æ¯WatchRegistrationå¯¹è±¡ï¼Œä¸´æ—¶ä¿å­˜æ•°æ®èŠ‚ç‚¹çš„è·¯å¾„å’ŒWatcherçš„å…³ç³»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">getData</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Stat stat)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       WatchRegistration wcb = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (watcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">           wcb = <span class="keyword">new</span> DataWatchRegistration(watcher, clientPath);</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">       request.setWatch(watcher != <span class="keyword">null</span>);</span><br><span class="line">       ReplyHeader r = cnxn.submitRequest(h, request, response, wcb);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>Packetå¯ä»¥çœ‹ä½œæ˜¯ZKä¸­æœ€å°çš„é€šä¿¡åè®®å•å…ƒï¼Œç”¨äºè¿›è¡Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„ç½‘ç»œä¼ è¾“ï¼Œä»»ä½•éœ€è¦ä¼ è¾“çš„å¯¹è±¡éƒ½éœ€è¦åŒ…è£…æˆä¸€ä¸ªPacketå¯¹è±¡ã€‚ClientCnxnçš„WatchRegistrationä¹Ÿä¼šå°è£…åˆ°Packetä¸­ï¼Œå†æ”¾å…¥å‘é€é˜Ÿåˆ—ä¸­ç­‰å¾…å®¢æˆ·ç«¯å‘é€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Packet <span class="title">queuePacket</span><span class="params">(RequestHeader h, ReplyHeader r, Record request, Record response, AsyncCallback cb, String clientPath, String serverPath, Object ctx, WatchRegistration watchRegistration)</span> </span>&#123;</span><br><span class="line">       Packet packet = <span class="keyword">null</span>;</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">           packet = <span class="keyword">new</span> Packet(h, r, request, response, watchRegistration);</span><br><span class="line">       ...</span><br><span class="line">           outgoingQueue.add(packet);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>éšåï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒåŒæ—¶ç­‰å¾…è¯·æ±‚è¿”å›ã€‚å®Œæˆå‘é€åï¼Œç”±å®¢æˆ·ç«¯SendThreadçº¿ç¨‹çš„readResponseæ–¹æ³•è´Ÿè´£æ¥æ”¶æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”ï¼ŒfinishPacketæ–¹æ³•ä»Packetä¸­å–å‡ºå¯¹åº”çš„Watcherå¹¶æ³¨å†Œåˆ°ZKWatchManagerä¸­å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(Packet p)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">           p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Map&lt;String, Set&lt;Watcher&gt;&gt; getWatches(<span class="keyword">int</span> rc) &#123;</span><br><span class="line">       <span class="keyword">return</span> watchManager.dataWatches;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯å°†æš‚æ—¶ä¿å­˜çš„Watcherè½¬äº¤ç»™ZKWatchManagerï¼Œæœ€ç»ˆä¿å­˜åˆ°dataWatches</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (shouldAddWatch(rc)) &#123;</span><br><span class="line">           Map&lt;String, Set&lt;Watcher&gt;&gt; watches = getWatches(rc);</span><br><span class="line">           <span class="keyword">synchronized</span>(watches) &#123;</span><br><span class="line">               Set&lt;Watcher&gt; watchers = watches.get(clientPath);</span><br><span class="line">               <span class="keyword">if</span> (watchers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   watchers = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line">                   watchers.put(clientPath, watchers);</span><br><span class="line">               &#125;</span><br><span class="line">               watchers.add(watcher);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010111.png"></p><p>æç«¯æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æ¯è°ƒç”¨ä¸€æ¬¡ <code>getData()</code> æ¥å£ï¼Œå°±ä¼šæ³¨å†Œä¸€ä¸ªWatcherï¼Œä½†è¿™äº›Watcherå¹¶ä¸ä¼šéƒ½éšç€å®¢æˆ·ç«¯è¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯é€ æˆå†…å­˜ç´§å¼ ç­‰æ€§èƒ½é—®é¢˜ã€‚ZKåº•å±‚å®é™…çš„ç½‘ç»œä¼ è¾“åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å°†WatchRegistrationå¯¹è±¡å®Œå…¨çš„åºåˆ—åŒ–åˆ°åº•å±‚å­—èŠ‚æ•°ç»„ä¸­ï¼ŒPacketå†…éƒ¨åºåˆ—åŒ–è¿‡ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">           BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">           <span class="comment">// We&#x27;ll fill this in later</span></span><br><span class="line">           boa.writeInt(-<span class="number">1</span>, <span class="string">&quot;len&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (requestHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">               requestHeader.serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ConnectRequest) &#123;</span><br><span class="line">               request.serialize(boa, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">               <span class="comment">// append &quot;am-I-allowed-to-be-readonly&quot; flag</span></span><br><span class="line">               boa.wirteBool(readOnly, <span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">               request.serialize(boa, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>åªæœ‰requestHeaderå’Œrequestè¿›è¡Œäº†åºåˆ—åŒ–ï¼Œæ‰€ä»¥å°½ç®¡WatchRegistrationè¢«å°è£…åˆ°äº†Packetä¸­ï¼Œä½†å¹¶æ²¡æœ‰åºåˆ—åŒ–åˆ°åº•å±‚å­—èŠ‚æ•°ç»„ï¼Œå› æ­¤ä¸ä¼šè¿›è¡Œç½‘ç»œä¼ è¾“ã€‚</strong></p><h4 id="1-4-3-æœåŠ¡ç«¯å¤„ç†Watcher"><a href="#1-4-3-æœåŠ¡ç«¯å¤„ç†Watcher" class="headerlink" title="1.4.3 æœåŠ¡ç«¯å¤„ç†Watcher"></a>1.4.3 æœåŠ¡ç«¯å¤„ç†Watcher</h4><p>å®¢æˆ·ç«¯å¹¶ä¸ä¼šå°†Watcherå¯¹è±¡çœŸæ­£çš„ä¼ é€’åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¦‚ä½•å®Œæˆå®¢æˆ·ç«¯çš„Watcheræ³¨å†Œï¼Ÿ</p><h5 id="ï¼ˆ1ï¼‰ServerCnxnå­˜å‚¨"><a href="#ï¼ˆ1ï¼‰ServerCnxnå­˜å‚¨" class="headerlink" title="ï¼ˆ1ï¼‰ServerCnxnå­˜å‚¨"></a>ï¼ˆ1ï¼‰ServerCnxnå­˜å‚¨</h5><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010112.png"></p><p>æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼Œåœ¨ <code>FinalRequestProcessor.processRequest()</code> ä¸­åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦éœ€è¦æ³¨å†ŒWatcherï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> OpCode.getData: &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// å½“getDtatRequest.getWatch()ä¸ºTrueæ—¶ï¼Œå°†å½“å‰ServerCnxnå¯¹è±¡å’Œæ•°æ®èŠ‚ç‚¹è·¯å¾„ä¼ å…¥getDataæ–¹æ³•ï¼Œæœ€ç»ˆå­˜å‚¨åœ¨WatchManagerçš„watchTableå’Œwatch2Pathsä¸­</span></span><br><span class="line">    <span class="keyword">byte</span> b[] = zks.getZKDatabase().getData(getDataRequest.getPath(), stat, getDtatRequest.getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">    rsp = <span class="keyword">new</span> GetDataResponse(b, stat);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerCnxnæ˜¯ä¸€ä¸ªZooKeeperå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥æ¥å£ï¼Œä»£è¡¨äº†ä¸€ä¸ªäºŒè€…é—´çš„è¿æ¥ã€‚é»˜è®¤å®ç°æ˜¯NIOServerCnxnï¼Œ3.4.0ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†åŸºäºNettyçš„å®ç°NettyServerCnxnã€‚éƒ½å®ç°äº†Watcherçš„processæ¥å£ï¼Œæ‰€ä»¥ServerCnxnä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªWatcherã€‚</p><p>WatchManageræ˜¯ZKæœåŠ¡ç«¯Watcherçš„ç®¡ç†è€…ï¼Œå†…éƒ¨ä¸¤ç§å­˜å‚¨ç»“æ„å¯¹åº”ä¸åŒç»´åº¦ï¼š</p><ul><li><strong>watchTableï¼š</strong>ä»æ•°æ®èŠ‚ç‚¹è·¯å¾„çš„ç²’åº¦æ¥æ‰˜ç®¡Watcherã€‚</li><li><strong>watch2Pathsï¼š</strong>ä»Watcherçš„ç²’åº¦æ§åˆ¶äº‹ä»¶è§¦å‘éœ€è¦è§¦å‘çš„æ•°æ®èŠ‚ç‚¹ã€‚</li></ul><p>WatchManagerè¿˜è´Ÿè´£Watcheräº‹ä»¶çš„è§¦å‘ï¼Œç§»é™¤æ‰å·²è¢«è§¦å‘çš„Watcherã€‚æœåŠ¡ç«¯DataTreeä¼šæ‰˜ç®¡ä¸¤ä¸ªWatchManagerï¼ˆdataWatcheså’ŒchildWatchesï¼Œå¯¹åº”æ•°æ®å˜æ›´å’Œå­èŠ‚ç‚¹å˜æ›´ï¼‰ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010113.png"></p><h5 id="ï¼ˆ2ï¼‰Watcherè§¦å‘"><a href="#ï¼ˆ2ï¼‰Watcherè§¦å‘" class="headerlink" title="ï¼ˆ2ï¼‰Watcherè§¦å‘"></a>ï¼ˆ2ï¼‰Watcherè§¦å‘</h5><p>æœåŠ¡ç«¯å¦‚ä½•è§¦å‘Watcher</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">setData</span><span class="params">(String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version, <span class="keyword">long</span> zxid, <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> KeeperException.NoNodeException </span>&#123;</span><br><span class="line">       DataNode n = nodes.get(path);</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">byte</span> lasdtdata[] = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">synchronized</span> (n) &#123;</span><br><span class="line">           lastdata = n.data;</span><br><span class="line">           n.data = data;</span><br><span class="line">           n.stat.setMtime(time);</span><br><span class="line">           n.stat.setMzxid(zxid);</span><br><span class="line">           n.stat.setVersion(version);</span><br><span class="line">           n.copyStat(s);</span><br><span class="line">       &#125;</span><br><span class="line">       ......</span><br><span class="line">       <span class="comment">// æŒ‡å®šèŠ‚ç‚¹æ•°æ®æ›´æ–°åï¼Œè°ƒç”¨WatchManagerçš„triggerWatchæ¥è§¦å‘ç›¸å…³äº‹ä»¶</span></span><br><span class="line">       dataWatches.triggerWatch(path, EventType.NodeDataChanged);</span><br><span class="line">       <span class="keyword">return</span> s;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> triggerWatch(path, type, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type, Set&lt;Watcher&gt; supress)</span> </span>&#123;</span><br><span class="line">       WatchedEvent e = <span class="keyword">new</span> WatchedEvent(type, KeeperState.SyncConnected, path);</span><br><span class="line">       HashSet&lt;Watcher&gt; watchers;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           watchers = watchTable.remove(path);</span><br><span class="line">           ......</span><br><span class="line">           <span class="comment">// å¦‚æœä¸å­˜åœ¨Watcherï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">           <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">               HashSet&lt;String&gt; paths = watch2Paths.get(w);</span><br><span class="line">               <span class="keyword">if</span> (paths != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   paths.remove(path);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">           <span class="keyword">if</span> (supress != <span class="keyword">null</span> &amp;&amp; supress.contains(w)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           w.process(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> watchers;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>WatchManagerçš„è§¦å‘é€»è¾‘ï¼š</p><ol><li><p><strong>å°è£…WatchedEventï¼š</strong>å…ˆå°†é€šçŸ¥çŠ¶æ€ï¼ˆKeeperStateï¼‰ã€äº‹ä»¶ç±»å‹ï¼ˆEventTypeï¼‰å’ŒèŠ‚ç‚¹è·¯å¾„å°è£…æˆä¸€ä¸ªWatchedEventå¯¹è±¡ã€‚</p></li><li><p><strong>æŸ¥è¯¢Watcherï¼š</strong>æ ¹æ®èŠ‚ç‚¹è·¯å¾„ä»watchTableä¸­å–å‡ºå¯¹åº”çš„Watcherï¼Œè‹¥æ²¡æ‰¾åˆ°åˆ™è¯´æ˜æ²¡æœ‰å®¢æˆ·ç«¯åœ¨è¯¥èŠ‚ç‚¹æ³¨å†Œè¿‡Watcherï¼Œç›´æ¥é€€å‡ºï¼›è‹¥æ‰¾åˆ°äº†åˆ™å°†å…¶æå–å‡ºæ¥ï¼ŒåŒæ—¶ç›´æ¥ä»watchTableå’Œwatch2Pathsä¸­å°†å…¶åˆ é™¤ï¼ˆ<strong>Watcheråœ¨æœåŠ¡ç«¯æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œç”¨å®ŒåŠåˆ </strong>ï¼‰ã€‚</p></li><li><p><strong>è°ƒç”¨processæ–¹æ³•æ¥è§¦å‘Watcherï¼š</strong>é€ä¸ªè°ƒç”¨æ­¥éª¤2æ‰¾åˆ°çš„Watcherçš„processæ–¹æ³•ï¼Œå³è¯·æ±‚ä¸­çš„ServerCnxnå¯¹åº”æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NIOServerCnxn</span> <span class="keyword">extends</span> <span class="title">ServerCnxn</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤´æ ‡è®°-1ï¼Œæ ‡è¯†å½“å‰æ˜¯ä¸€ä¸ªé€šçŸ¥</span></span><br><span class="line">        ReplyHeader h -= <span class="keyword">new</span> ReplyHeader(-<span class="number">1</span>, -<span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Convert WatchedEvent to a type that can be sent over the write</span></span><br><span class="line">        <span class="comment">// WatchedEventåŒ…è£…ä¸ºWatcherEventæ–¹ä¾¿ç½‘ç»œä¼ è¾“åºåˆ—åŒ–</span></span><br><span class="line">        WatcherEvent e = event.getWrapper();</span><br><span class="line">        <span class="comment">// å‘å®¢æˆ·ç«¯å‘é€é€šçŸ¥</span></span><br><span class="line">        sendResponse(h, e, <span class="string">&quot;notification&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ServerCnxnä¸­çš„processä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ŒçœŸæ­£çš„Watcherå›è°ƒå’Œä¸šåŠ¡é€»è¾‘éƒ½åœ¨å®¢æˆ·ç«¯</p></li></ol><h5 id="ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å›è°ƒWatcher"><a href="#ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å›è°ƒWatcher" class="headerlink" title="ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å›è°ƒWatcher"></a>ï¼ˆ3ï¼‰å®¢æˆ·ç«¯å›è°ƒWatcher</h5><ul><li><p><strong>SendThreadæ¥æ”¶äº‹ä»¶é€šçŸ¥ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZKå®¢æˆ·ç«¯å¦‚ä½•æ¥æ”¶äº‹ä»¶é€šçŸ¥</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯å“åº”ç»Ÿä¸€å¤„ç†</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> throw IOException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// -1 means notification é€šçŸ¥ç±»å‹çš„å“åº”</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 1.å°†å­—èŠ‚æµè½¬æ¢ä¸ºWatcherEventå¯¹è±¡</span></span><br><span class="line">            WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">            event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="comment">// 2.å¤„ç†chrootPath</span></span><br><span class="line">            <span class="comment">// convert from a server path to a client path</span></span><br><span class="line">            <span class="keyword">if</span> (chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¯¹æœåŠ¡ç«¯ä¼ è¿‡æ¥çš„å®Œæ•´å­—èŠ‚è·¯å¾„è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆå®¢æˆ·ç«¯ä¸€ä¸ªç›¸å¯¹èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">                String serverPath = event.getPath();</span><br><span class="line">                <span class="keyword">if</span> (serverPath.compareTo(chrootPath) == <span class="number">0</span>)</span><br><span class="line">                    event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; chrootPath.length())</span><br><span class="line">                    event.setPath(serverPath.substring(chrootPath.length()));</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.è¿˜åŸWatchedEventï¼Œé€‚é…processæ¥å£å‚æ•°</span></span><br><span class="line">            WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 4.å›è°ƒWatcherï¼Œå°†WatchedEventäº¤ç»™EventThreadçº¿ç¨‹ï¼Œåœ¨ä¸‹ä¸€ä¸ªè½®è¯¢å‘¨æœŸè¿›è¡ŒWatcherå›è°ƒ</span></span><br><span class="line">            eventThread.queueEvent(we);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>EventThreadå¤„ç†äº‹ä»¶é€šçŸ¥ï¼š</strong></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010114.png"></p><p>SentThreadé€šè¿‡ <code>EventThread.queueEvent()</code> å°†äº‹ä»¶ä¼ ç»™EventThreadçº¿ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (event.getType() == EventType.None &amp;&amp; sessionState == event.getState()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       sessionState = event.getState();</span><br><span class="line">       <span class="comment">// materialize the watchers based on the event</span></span><br><span class="line">       WatcherSetEventPair pair = <span class="keyword">new</span> WatcherSetEventPair();</span><br><span class="line">       watcher.materialize(event.getState(), event.getType(), event.getPath(), event));</span><br><span class="line">       <span class="comment">// queue the pair (watch set &amp; event) for later processing</span></span><br><span class="line">       <span class="comment">// å–å‡ºæ‰€æœ‰ç›¸å…³Watcheråï¼Œæ”¾å…¥waitingEventsé˜Ÿåˆ—</span></span><br><span class="line">       waitingEvents.add(pair);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// æ ¹æ®é€šçŸ¥äº‹ä»¶ï¼Œä»ZKWatchManagerä¸­å–å‡ºæ‰€æœ‰ç›¸å…³Watcher</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">materialize</span><span class="params">(Watcher.Event.KeeperState state, Watcher.Event.EventType type, String clientPath)</span> </span>&#123;</span><br><span class="line">       Set&lt;Watcher&gt; result = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line">       <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">       ...</span><br><span class="line">           <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">           <span class="keyword">case</span> NodeCreated:</span><br><span class="line">               <span class="comment">// ä»ç›¸åº”çš„Watcherå­˜å‚¨ä¸­å»é™¤å¯¹åº”çš„Watcherï¼Œå®¢æˆ·ç«¯çš„Watcherä¹Ÿæ˜¯ä¸€æ¬¡æ€§çš„</span></span><br><span class="line">               <span class="keyword">synchronized</span> (dataWatches) &#123;</span><br><span class="line">                   addTo(dataWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">synchronized</span> (existWatches) &#123;</span><br><span class="line">                   addTo(existWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addTo</span><span class="params">(Set&lt;Watcher&gt; from, Set&lt;Watcher&gt; to)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (from != <span class="keyword">null</span>) &#123;</span><br><span class="line">           to.addAll(from);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>EventThreadçš„runæ–¹æ³•ä¸æ–­å¯¹waitingEventsé˜Ÿåˆ—è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           isRunning = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">               Object event = waitingEvents.take();</span><br><span class="line">               <span class="keyword">if</span> (event == eventOfDeath) &#123;</span><br><span class="line">                   wasKilled = <span class="keyword">true</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   processEvent(event);</span><br><span class="line">               &#125;</span><br><span class="line">               ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (event <span class="keyword">instanceof</span> WatcherSetEventPair) &#123;</span><br><span class="line">               <span class="comment">// each watcher will process the event</span></span><br><span class="line">               WatcherSetEventPair pair = (WatcherSetEventPair) event;</span><br><span class="line">               <span class="comment">// æ¯æ¬¡ä»waitingEventsä¸­å–å‡ºä¸€ä¸ªWatcherå¹¶è¿›è¡Œä¸²è¡ŒåŒæ­¥å¤„ç†</span></span><br><span class="line">               <span class="keyword">for</span> (Watcher watcher : pair.watchers) &#123;</span><br><span class="line">                   <span class="keyword">try</span>&#123;</span><br><span class="line">                       <span class="comment">// è°ƒç”¨processå®Œæˆå›è°ƒ</span></span><br><span class="line">                       watcher.process(pair.event);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           ...</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li></ul><h4 id="1-4-4-Watcherç‰¹æ€§"><a href="#1-4-4-Watcherç‰¹æ€§" class="headerlink" title="1.4.4 Watcherç‰¹æ€§"></a>1.4.4 Watcherç‰¹æ€§</h4><ul><li><strong>ä¸€æ¬¡æ€§ï¼š</strong>æ— è®ºæ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œä¸€æ—¦Watcherè¢«è§¦å‘ï¼Œå°±ä¼šä»ZKå­˜å‚¨ä¸­åˆ é™¤ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶è¦åå¤æ³¨å†Œï¼Œè¿™æ ·èƒ½å¤Ÿå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ã€‚</li><li><strong>å®¢æˆ·ç«¯ä¸²è¡Œæ‰§è¡Œï¼š</strong>å®¢æˆ·ç«¯Watcherå›è°ƒæ—¶ä¸€ä¸ªä¸²è¡ŒåŒæ­¥è¿‡ç¨‹ï¼Œä¿è¯äº†æ‰§è¡Œé¡ºåºã€‚</li><li><strong>è½»é‡ï¼š</strong>WatchedEventæ˜¯Watcheré€šçŸ¥æœºåˆ¶çš„æœ€å°é€šçŸ¥å•å…ƒï¼ŒåªåŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼ˆé€šçŸ¥çŠ¶æ€ã€äº‹ä»¶ç±»å‹å’ŒèŠ‚ç‚¹è·¯å¾„ï¼‰ï¼Œå®¢æˆ·ç«¯éœ€è¦ä¸»åŠ¨å»è·å–æ›´æ–°æ•°æ®ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†ŒWatcheræ—¶ï¼Œæ²¡æœ‰æŠŠçœŸå®Watcherå¯¹è±¡ä¼ ç»™æœåŠ¡ç«¯ï¼Œåªæ˜¯åœ¨è¯·æ±‚ä¸­ä½¿ç”¨Booleanç±»å‹æ ‡è®°ï¼ŒæœåŠ¡ç«¯ä»…ä»…ä¿å­˜äº†å½“å‰è¿æ¥çš„ServerCnxnå¯¹è±¡ã€‚</li></ul><h3 id="1-5-ACLâ€”ä¿éšœæ•°æ®å®‰å…¨"><a href="#1-5-ACLâ€”ä¿éšœæ•°æ®å®‰å…¨" class="headerlink" title="1.5 ACLâ€”ä¿éšœæ•°æ®å®‰å…¨"></a>1.5 ACLâ€”ä¿éšœæ•°æ®å®‰å…¨</h3><h4 id="1-5-1-æƒé™æ¨¡å¼-Scheme"><a href="#1-5-1-æƒé™æ¨¡å¼-Scheme" class="headerlink" title="1.5.1 æƒé™æ¨¡å¼-Scheme"></a>1.5.1 æƒé™æ¨¡å¼-Scheme</h4><p>æƒé™æ¨¡å¼ç”¨æ¥ç¡®å®šæƒé™éªŒè¯è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ£€éªŒç­–ç•¥ï¼Œå¸¸ç”¨çš„å››ç§æƒé™æ¨¡å¼ï¼š</p><ul><li><p><strong>IPï¼š</strong>é€šè¿‡IPåœ°å€ç²’åº¦è¿›è¡Œæƒé™æ§åˆ¶ï¼Œä¹Ÿæ”¯æŒæŒ‰ç½‘æ®µçš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œå¦‚ <code>ip:192.168.0.1/24</code> è¡¨ç¤ºé’ˆå¯¹ <code>192.168.0.*</code> IPæ®µè¿›è¡Œæƒé™æ§åˆ¶ã€‚</p></li><li><p><strong>Digestï¼š</strong></p><ul><li><p>æœ€å¸¸ç”¨çš„æ¨¡å¼ï¼Œç±»ä¼¼äº <code>username:password</code> å½¢å¼çš„æƒé™è¡¨ç¤ºè¿›è¡Œæƒé™æ§åˆ¶æ¥åŒºåˆ†ä¸åŒåº”ç”¨ã€‚</p></li><li><p>ZKå…ˆåä¼šè¿›è¡Œä¸¤æ¬¡ç¼–ç å¤„ç†ï¼Œ<strong>SHA-1ç®—æ³•åŠ å¯†</strong>å’Œ<strong>BASE64ç¼–ç </strong>ï¼Œç”± <code>DigestAuthenticationProvider.generateDigest(String idPassword)</code> å‡½æ•°è¿›è¡Œå°è£…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DigestAuthenticationProviderUsage</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        System.out.println(DigestAuthenticationProvider.generateDigest(<span class="string">&quot;foo:zk-book&quot;</span>));</span><br><span class="line">        <span class="comment">// è¾“å‡ºï¼šfoo:kWN6aNS.... æ··æ·†æ— åºçš„å­—ç¬¦ä¸²</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>Worldï¼š</strong>æœ€å¼€æ”¾çš„æ¨¡å¼ï¼Œæ•°æ®èŠ‚ç‚¹è®¿é—®å¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾ï¼Œåªæœ‰ä¸€ä¸ªæƒé™æ ‡è¯† <code>world:anyone</code> ã€‚</p></li><li><p><strong>Superï¼š</strong>è¶…çº§ç”¨æˆ·æ¨¡å¼ï¼Œå¯ä»¥å¯¹ä»»æ„ZKèŠ‚ç‚¹è¿›è¡Œä»»æ„æ“ä½œã€‚</p></li></ul><h4 id="1-5-2-æˆæƒå¯¹è±¡-ID"><a href="#1-5-2-æˆæƒå¯¹è±¡-ID" class="headerlink" title="1.5.2 æˆæƒå¯¹è±¡-ID"></a>1.5.2 æˆæƒå¯¹è±¡-ID</h4><p>æˆæƒå¯¹è±¡æŒ‡æƒé™èµ‹äºˆçš„ç”¨æˆ·æˆ–ä¸€ä¸ªæŒ‡å®šå®ä½“ï¼Œå¦‚IPåœ°å€æˆ–æœºå™¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010115.png"></p><h4 id="1-5-3-æƒé™-Permission"><a href="#1-5-3-æƒé™-Permission" class="headerlink" title="1.5.3 æƒé™-Permission"></a>1.5.3 æƒé™-Permission</h4><p>æƒé™æŒ‡é€šè¿‡æƒé™æ£€æŸ¥åå…è®¸æ‰§è¡Œçš„æ“ä½œï¼Œåˆ†ä¸º5ç±»ï¼š</p><ul><li><strong>CREATEï¼š</strong>æ•°æ®èŠ‚ç‚¹çš„åˆ›å»ºæƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡åœ¨è¯¥æ•°æ®èŠ‚ç‚¹ä¸‹åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li><li><strong>DELETEï¼š</strong>å­èŠ‚ç‚¹çš„åˆ é™¤æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡åˆ é™¤è¯¥æ•°æ®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚</li><li><strong>READï¼š</strong>æ•°æ®èŠ‚ç‚¹çš„è¯»å–æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡è®¿é—®è¯¥æ•°æ®èŠ‚ç‚¹å¹¶è¯»å–å…¶æ•°æ®å†…å®¹æˆ–å­èŠ‚ç‚¹åˆ—è¡¨ç­‰ã€‚</li><li><strong>WRITEï¼š</strong>æ•°æ®èŠ‚ç‚¹çš„æ›´æ–°æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡å¯¹è¯¥æ•°æ®èŠ‚ç‚¹è¿›è¡Œæ›´æ–°æ“ä½œã€‚</li><li><strong>ADMINï¼š</strong>æ•°æ®èŠ‚ç‚¹çš„ç®¡ç†æƒé™ï¼Œå…è®¸æˆæƒå¯¹è±¡å¯¹è¯¥æ•°æ®èŠ‚ç‚¹è¿›è¡ŒACLç›¸å…³çš„è®¾ç½®æ“ä½œã€‚</li></ul><h4 id="1-5-4-è‡ªå®šä¹‰æ‰©å±•"><a href="#1-5-4-è‡ªå®šä¹‰æ‰©å±•" class="headerlink" title="1.5.4 è‡ªå®šä¹‰æ‰©å±•"></a>1.5.4 è‡ªå®šä¹‰æ‰©å±•</h4><p>ZKå…è®¸å¼€å‘äººå‘˜ç”¨è¿‡æŒ‡å®šæ–¹å¼å¯¹ZKè¿›è¡Œæ‰©å±•ï¼Œå³ Pluggable ZooKeeper Authentication æœºåˆ¶ï¼Œå®ç°æ¥å£AuthenticationProviderï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZKé»˜è®¤çš„å‡ ç§æƒé™æ¨¡å¼å¯¹åº”DigestAuthenticationProviderå’ŒIPAuthenticationProvider</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getScheme</span><span class="params">()</span></span>;</span><br><span class="line">    KeeperException.<span class="function">Code <span class="title">handleAuthentication</span><span class="params">(ServerCnxn cnxn, <span class="keyword">byte</span> authData[])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String id, String aclExpr)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è‡ªå®šä¹‰æƒé™æ§åˆ¶å™¨åï¼Œéœ€è¦å°†å…¶æ³¨å†Œåˆ°ZKä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><p><strong>ç³»ç»Ÿå±æ€§ï¼š</strong>å¯åŠ¨å‚æ•°æ·»åŠ é…ç½®ä¿¡æ¯</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-Dzookeeper.authProvider.1</span>=<span class="string">com.zkbook.CustomAuthenticationProvider</span></span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®æ–‡ä»¶ï¼š</strong><code>zoo.cfg</code> ä¸­æ·»åŠ é…ç½®ä¿¡æ¯</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">authProvider.1</span>=<span class="string">com.zkbook.CustomAuthenticationProvider</span></span><br></pre></td></tr></table></figure></li></ul><p>æƒé™æ§åˆ¶å™¨æ³¨å†Œé‡‡ç”¨äº†<strong>å»¶è¿ŸåŠ è½½</strong>çš„ç­–ç•¥ï¼Œç¬¬ä¸€æ¬¡å¤„ç†åŒ…å«æƒé™æ§åˆ¶è¯·æ±‚æ—¶æ‰ä¼šè¿›è¡Œæƒé™æ§åˆ¶å™¨çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶ZKå°†æ‰€æœ‰æ§åˆ¶å™¨æ³¨å†Œåˆ°ProviderRegistryä¸­ï¼Œé¡ºåºä¸ºï¼šDigestAuthenticationProviderå’ŒIPAuthenticationProviderå…ˆåˆå§‹åŒ–ï¼Œç„¶åæ‰«æ <code>zookeeper.authProvider</code> è·å–è‡ªå®šä¹‰æ§åˆ¶å™¨å¹¶åˆå§‹åŒ–ã€‚</p><h4 id="1-5-5-ACLç®¡ç†"><a href="#1-5-5-ACLç®¡ç†" class="headerlink" title="1.5.5 ACLç®¡ç†"></a>1.5.5 ACLç®¡ç†</h4><p>é€šè¿‡zkCliè„šæœ¬ç™»å½•ZKæœåŠ¡å™¨åï¼Œé€šè¿‡ä¸¤ç§æ–¹å¼è®¾ç½®ACLï¼š</p><ul><li><p><strong>æ•°æ®èŠ‚ç‚¹åˆ›å»ºçš„åŒæ—¶è¿›è¡ŒACLæƒé™çš„è®¾ç½®ï¼š</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤æ ¼å¼</span></span><br><span class="line">create [-s] [-e] path data acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e /zk-book init digest: foo:MiHs3Eiylp......</span></span><br><span class="line">Created /zk-book</span><br><span class="line"><span class="meta">$</span><span class="bash"> getAcl /zk-book</span></span><br><span class="line">&#x27;digest,&#x27;foo:MiHs3Eiylp......</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨ <code>setAcl</code> å‘½ä»¤å•ç‹¬å¯¹å·²ç»å­˜åœ¨çš„æ•°æ®èŠ‚ç‚¹è¿›è¡ŒACLè®¾ç½®ï¼š</strong>ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">setAcl path acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e /zk-book init</span></span><br><span class="line">Created /zk-book</span><br><span class="line"><span class="meta">$</span><span class="bash"> setAcl /zk-book digest:foo:MiHs3Eiylp......</span></span><br><span class="line">cZxid = 0x400000042</span><br><span class="line">ctime = ......</span><br><span class="line">mZxid = 0x400000042</span><br><span class="line">mtime = ......</span><br><span class="line">pZxid = 0x400000042</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 1</span><br><span class="line">ephemeralOwner = 0x1472ff49b020003</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br><span class="line"><span class="meta">$</span><span class="bash"> getAcl /zk-book</span></span><br><span class="line">&#x27;digest,&#x27;foo:MiHs3Eiylp......</span><br></pre></td></tr></table></figure></li></ul><p>ä¸€æ—¦å¯¹ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹è®¾ç½®äº†ACLæƒé™æ§åˆ¶ï¼Œæ²¡æœ‰æˆæƒçš„ZKå®¢æˆ·ç«¯å°±æ— æ³•è®¿é—®è¯¥æ•°æ®èŠ‚ç‚¹ï¼Œä½†å¦‚æœä¸€ä¸ªæŒä¹…æ•°æ®èŠ‚ç‚¹åŒ…å«äº†ACLæƒé™æ§åˆ¶ï¼Œå…¶åˆ›å»ºå®¢æˆ·ç«¯å·²ä¸å†ä½¿ç”¨ï¼Œè¿™äº›æ•°æ®èŠ‚ç‚¹å¦‚ä½•æ¸…ç†ï¼Ÿ<strong>Superæ¨¡å¼</strong>ä¸‹ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜æƒé™ã€‚</p><p>ZKæœåŠ¡å™¨å¯åŠ¨æ—¶æ·»åŠ å¦‚ä¸‹ç³»ç»Ÿå±æ€§ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fooè¡¨ç¤ºç®¡ç†å‘˜åï¼Œåç»­å­—ç¬¦ä¸²ç”±ç®¡ç†å‘˜è‡ªä¸»é…ç½®</span></span><br><span class="line"><span class="meta">-Dzookeeper.DigestAuthenticationProvider.superDigest</span>=<span class="string">foo:MiHs3Eiylp......</span></span><br></pre></td></tr></table></figure><p>åº”ç”¨ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthSampleSuper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String PATH = <span class="string">&quot;/zk-book&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ZooKeeper zk1 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">5000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk1.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:true&quot;</span>.getBytes());</span><br><span class="line">        zk1.create(PATH, <span class="string">&quot;init&quot;</span>.getBytes(), Ids.CREATOR_ALL_ACL, CreateMode.EPHEMERAL);</span><br><span class="line">        ZooKeeper zk2 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">50000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk2.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:zk-book&quot;</span>.getBytes());</span><br><span class="line">        System.out.println(zk2.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">        ZooKeeper zk3 = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">50000</span>, <span class="keyword">null</span>);</span><br><span class="line">        zk3.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;foo:false&quot;</span>.getBytes());</span><br><span class="line">        System.out.println(zk3.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¾“å‡º org.apache.zookeeper.KeeperException$NoAuthException: KeeperErrorCode = NoAuth for /zk-book foo:falseæ— æ³•é€šè¿‡æƒé™æ ¡éªŒï¼Œfoo:zk-bookè¶…çº§ç®¡ç†å‘˜å¯ä»¥éšæ„è¿›è¡Œæ“ä½œ</span></span><br></pre></td></tr></table></figure><h2 id="äºŒ-åºåˆ—åŒ–ä¸åè®®"><a href="#äºŒ-åºåˆ—åŒ–ä¸åè®®" class="headerlink" title="äºŒ. åºåˆ—åŒ–ä¸åè®®"></a>äºŒ. åºåˆ—åŒ–ä¸åè®®</h2><p>ç½‘ç»œé€šä¿¡çš„é¦–è¦é—®é¢˜æ˜¯è§£å†³æ•°æ®çš„åºåˆ—å·å’Œååºåˆ—åŒ–æ“ä½œã€‚</p><h3 id="2-1-Juteç®€ä»‹"><a href="#2-1-Juteç®€ä»‹" class="headerlink" title="2.1 Juteç®€ä»‹"></a>2.1 Juteç®€ä»‹</h3><p>Juteå³ZKä¸­çš„åºåˆ—å·ç»„ä»¶ï¼Œå‰èº«æ˜¯Hadoop Record IOä¸­çš„åºåˆ—åŒ–ç»„ä»¶ï¼Œåæ¥ç”±äºApache Avroåºåˆ—åŒ–æ¡†æ¶æœ‰å‡ºè‰²çš„è·¨è¯­è¨€ç‰¹æ€§ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„å’Œå¯¹MapReduceçš„å¤©ç„¶æ”¯æŒï¼Œä¸”éå¸¸æ–¹ä¾¿ç”¨äºRPCè°ƒç”¨ï¼Œæ‰€ä»¥åœ¨0.21.0ç‰ˆæœ¬ä»£æ›¿äº†Record IOã€‚</p><p>ZooKeeperä¹Ÿæ›¾å°è¯•ä½¿ç”¨Apache Avroã€Thriftæˆ–Googleçš„protobufæ¥æ›¿æ¢Juteï¼Œä½†è€ƒè™‘æ–°è€ç‰ˆæœ¬çš„å…¼å®¹è€Œæœªèƒ½æ¨è¿›ï¼Œå¹¶ä¸”Juteçš„åºåˆ—åŒ–èƒ½åŠ›ä¸€ç›´éƒ½ä¸æ˜¯ZKçš„æ€§èƒ½ç“¶é¢ˆã€‚</p><h3 id="2-2-Juteä½¿ç”¨"><a href="#2-2-Juteä½¿ç”¨" class="headerlink" title="2.2 Juteä½¿ç”¨"></a>2.2 Juteä½¿ç”¨</h3><p>ä½¿ç”¨Juteæ¥å¯¹Javaå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockReqHeader</span> <span class="keyword">implements</span> <span class="title">Record</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sessionId;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutputArchive a_, String tag)</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        a_.startRecord(<span class="keyword">this</span>, tag);</span><br><span class="line">        a_.writeLong(sessionId, <span class="string">&quot;sessionId&quot;</span>);</span><br><span class="line">        a_.writeLong(type, <span class="string">&quot;type&quot;</span>);</span><br><span class="line">        a_.endRecord(<span class="keyword">this</span>, tag);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">(InputArchive a_, String tag)</span> <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">        a_.startRecord(tag);</span><br><span class="line">        sessionId = a_.readLong(<span class="string">&quot;sessionId&quot;</span>);</span><br><span class="line">        type = a_.readLong(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        a_.endRecord(tag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å§‹åºåˆ—åŒ–</span></span><br><span class="line">ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">   BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line"><span class="keyword">new</span> MockReqHeader(<span class="number">0x34221eccb92a34el</span>, <span class="string">&quot;ping&quot;</span>).serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line"><span class="comment">// æ­¤å¤„é€šå¸¸æ˜¯TCPç½‘ç»œä¼ è¾“å¯¹è±¡</span></span><br><span class="line">ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line"><span class="comment">// å¼€å§‹ååºåˆ—åŒ–</span></span><br><span class="line">ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(bb);</span><br><span class="line">BinaryInputArchive bbia = BinaryOutputArchive.getArchive(bbis);</span><br><span class="line"><span class="keyword">new</span> MockReqHeader();</span><br><span class="line">header2.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">bbis.close();</span><br><span class="line">baos.close();</span><br></pre></td></tr></table></figure><p>æµç¨‹ï¼š</p><ol><li>å®ä½“ç±»å®ç°Recordæ¥å£çš„serializeå’Œdeserializeæ–¹æ³•ã€‚</li><li>æ„å»ºä¸€ä¸ªåºåˆ—åŒ–å™¨BinaryOutputArchiveã€‚</li><li>åºåˆ—åŒ–ï¼Œè°ƒç”¨å®ä½“ç±»çš„serializeæ–¹æ³•ï¼Œå°†å¯¹è±¡åºåˆ—åŒ–åˆ°æŒ‡å®štagã€‚</li><li>ååºåˆ—åŒ–ï¼Œè°ƒç”¨å®ä½“ç±»çš„deserializeæ–¹æ³•ï¼Œä»æŒ‡å®štagä¸­ååºåˆ—åŒ–å‡ºæ•°æ®å†…å®¹ã€‚</li></ol><h3 id="2-3-Juteæ·±å…¥"><a href="#2-3-Juteæ·±å…¥" class="headerlink" title="2.3 Juteæ·±å…¥"></a>2.3 Juteæ·±å…¥</h3><h4 id="ï¼ˆ1ï¼‰Recordæ¥å£"><a href="#ï¼ˆ1ï¼‰Recordæ¥å£" class="headerlink" title="ï¼ˆ1ï¼‰Recordæ¥å£"></a>ï¼ˆ1ï¼‰Recordæ¥å£</h4><p>æš‚æ— ã€‚</p><h4 id="ï¼ˆ2ï¼‰OutputArchiveå’ŒInputArchive"><a href="#ï¼ˆ2ï¼‰OutputArchiveå’ŒInputArchive" class="headerlink" title="ï¼ˆ2ï¼‰OutputArchiveå’ŒInputArchive"></a>ï¼ˆ2ï¼‰OutputArchiveå’ŒInputArchive</h4><p>æš‚æ— ã€‚</p><h3 id="2-4-é€šä¿¡åè®®"><a href="#2-4-é€šä¿¡åè®®" class="headerlink" title="2.4 é€šä¿¡åè®®"></a>2.4 é€šä¿¡åè®®</h3><p>ZKåŸºäºTCP/IPåè®®å®ç°é€šä¿¡åè®®ï¼Œè¯·æ±‚å’Œå“åº”ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010116.png"></p><h4 id="ï¼ˆ1ï¼‰è¯·æ±‚å’Œå“åº”ç»“æ„"><a href="#ï¼ˆ1ï¼‰è¯·æ±‚å’Œå“åº”ç»“æ„" class="headerlink" title="ï¼ˆ1ï¼‰è¯·æ±‚å’Œå“åº”ç»“æ„"></a>ï¼ˆ1ï¼‰è¯·æ±‚å’Œå“åº”ç»“æ„</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010117.png"></p><ul><li><p><strong>è¯·æ±‚å¤´ï¼ˆRequestHeaderï¼‰ï¼š</strong></p><ul><li><strong>xidï¼š</strong>è®°å½•å®¢æˆ·ç«¯è¯·æ±‚å‘èµ·çš„å…ˆååºå·ï¼Œç¡®ä¿å•ä¸ªå®¢æˆ·ç«¯è¯·æ±‚çš„å“åº”é¡ºåºã€‚</li><li><strong>typeï¼š</strong>è¯·æ±‚çš„æ“ä½œç±»å‹ï¼Œå®šä¹‰åœ¨ OpCode ä¸­<ul><li>OpCode.createï¼šåˆ›å»ºèŠ‚ç‚¹</li><li>OpCode.deleteï¼šåˆ é™¤èŠ‚ç‚¹</li><li>OpCode.getDataï¼šè·å–èŠ‚ç‚¹æ•°æ®</li><li>â€¦â€¦</li></ul></li></ul></li><li><p><strong>è¯·æ±‚ä½“ï¼ˆRequestï¼‰ï¼š</strong>è¯·æ±‚çš„ä¸»ä½“ï¼ŒåŒ…å«æ‰€æœ‰æ“ä½œå†…å®¹ã€‚ä¸åŒè¯·æ±‚ç±»å‹çš„è¯·æ±‚ä½“ç»“æ„æ˜¯ä¸åŒçš„ã€‚</p><ul><li><p><strong>ä¼šè¯åˆ›å»ºï¼ˆConnectRequestï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åè®®ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">int</span> protocolVersion;</span><br><span class="line">        <span class="comment">// æœ€è¿‘ä¸€æ¬¡æ”¶åˆ°çš„æœåŠ¡å™¨ZXID</span></span><br><span class="line">        <span class="keyword">long</span> lastZxidSeen;</span><br><span class="line">        <span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        <span class="keyword">int</span> timeOut;</span><br><span class="line">        <span class="comment">// ä¼šè¯æ ‡è¯†</span></span><br><span class="line">        <span class="keyword">long</span> sessionId;</span><br><span class="line">        <span class="comment">// ä¼šè¯å¯†ç </span></span><br><span class="line">        buffer passwd;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>è·å–èŠ‚ç‚¹æ•°æ®ï¼ˆGetDataRequestï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetDataRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ•°æ®èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">        ustring path;</span><br><span class="line">        <span class="comment">// æ˜¯å¦æ³¨å†ŒWatcher</span></span><br><span class="line">        <span class="keyword">boolean</span> watch;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>æ›´æ–°èŠ‚ç‚¹æ•°æ®ï¼ˆSetDataRequestï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SetDataRequest</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ•°æ®èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„</span></span><br><span class="line">        ustring path;</span><br><span class="line">        <span class="comment">// æ•°æ®å†…å®¹</span></span><br><span class="line">        buffer data;</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹æ•°æ®çš„æœŸæœ›ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">int</span> version;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å“åº”å¤´ï¼ˆReplyHeaderï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplyHeader</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¯¹åº”è¯·æ±‚å‘èµ·çš„å…ˆååºå·ï¼ŒåŸå€¼è¿”å›</span></span><br><span class="line">        <span class="keyword">int</span> xid;</span><br><span class="line">        <span class="comment">// ZKæœåŠ¡å™¨ä¸Šçš„æœ€æ–°äº‹åŠ¡ID</span></span><br><span class="line">        <span class="keyword">long</span> zxid;</span><br><span class="line">        <span class="comment">// é”™è¯¯ç ï¼Œå‡ºç°å¼‚å¸¸æ—¶æ ‡è¯†å‡ºæ¥</span></span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>å“åº”ä½“ï¼ˆResponseï¼‰ï¼š</strong></p><ul><li><p><strong>ä¼šè¯åˆ›å»ºï¼ˆConnectResponseï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ConnectResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åè®®ç‰ˆæœ¬å·</span></span><br><span class="line">        <span class="keyword">int</span> protocolVersion;</span><br><span class="line">        <span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        <span class="keyword">int</span> timeOut;</span><br><span class="line">        <span class="comment">// ä¼šè¯æ ‡è¯†</span></span><br><span class="line">        <span class="keyword">long</span> sessionId;</span><br><span class="line">        <span class="comment">// ä¼šè¯å¯†ç </span></span><br><span class="line">        buffer passwd;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>è·å–èŠ‚ç‚¹æ•°æ®ï¼ˆGetDataResponseï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GetDataResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ•°æ®å†…å®¹</span></span><br><span class="line">        buffer data;</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">        org.apache.zookeeper.data.Stat stat;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li><li><p><strong>æ›´æ–°èŠ‚ç‚¹æ•°æ®ï¼ˆSetDataResponseï¼‰ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> org.apache.zookeeper.proto &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SetDataResponse</span> </span>&#123;</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">        org.apache.zookeeper.data.Stat stat;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010120.png"></p><h4 id="ï¼ˆ2ï¼‰å®ä¾‹"><a href="#ï¼ˆ2ï¼‰å®ä¾‹" class="headerlink" title="ï¼ˆ2ï¼‰å®ä¾‹"></a>ï¼ˆ2ï¼‰å®ä¾‹</h4><p>è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASimpleGetDataRequest</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ZooKeeper zk = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;domain1.book.zookeeper&quot;</span>, <span class="number">5000</span>, <span class="keyword">new</span> ASimpleGetDataRequest());</span><br><span class="line">        <span class="comment">// è·å–èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line">        zk.getData(<span class="string">&quot;/$7_2_4/get_data&quot;</span>, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨Wiresharkè·å–åˆ°å…¶å‘é€çš„ç½‘ç»œTCPåŒ…ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010118.png"></p><p>åå…­è¿›åˆ¶è¡¨ç¤ºå«ä¹‰å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010119.png"></p><p>å“åº”ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010121.png"></p><p>åå…­è¿›åˆ¶è¡¨ç¤ºå«ä¹‰å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010122.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šæ•°æ®æ¨¡å‹ZNodeã€èŠ‚ç‚¹ç±»å‹ã€Watcherã€ACLã€Juteå’Œé€šä¿¡åè®®ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆå››ï¼‰åº”ç”¨åœºæ™¯ä¸å®ç°</title>
    <link href="http://linyishui.top/2021052001.html"/>
    <id>http://linyishui.top/2021052001.html</id>
    <published>2021-05-20T07:03:45.000Z</published>
    <updated>2021-07-18T15:36:42.760Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆå››ï¼‰åº”ç”¨åœºæ™¯ä¸å®ç°"><a href="#ZooKeeperï¼ˆå››ï¼‰åº”ç”¨åœºæ™¯ä¸å®ç°" class="headerlink" title="ZooKeeperï¼ˆå››ï¼‰åº”ç”¨åœºæ™¯ä¸å®ç°"></a>ZooKeeperï¼ˆå››ï¼‰åº”ç”¨åœºæ™¯ä¸å®ç°</h1><h2 id="ä¸€-å…¸å‹åº”ç”¨åœºæ™¯"><a href="#ä¸€-å…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="ä¸€. å…¸å‹åº”ç”¨åœºæ™¯"></a>ä¸€. å…¸å‹åº”ç”¨åœºæ™¯</h2><p>ZooKeeperæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„åˆ†å¸ƒå¼æ•°æ®ç®¡ç†å’Œåè°ƒæ¡†æ¶ï¼ŒåŸºäºZABç®—æ³•ï¼ŒZKå¯ä»¥å¾ˆå¥½çš„ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒçš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><h3 id="1-1-æ•°æ®å‘å¸ƒ-è®¢é˜…"><a href="#1-1-æ•°æ®å‘å¸ƒ-è®¢é˜…" class="headerlink" title="1.1 æ•°æ®å‘å¸ƒ/è®¢é˜…"></a>1.1 æ•°æ®å‘å¸ƒ/è®¢é˜…</h3><p>æ•°æ®å‘å¸ƒ/è®¢é˜…ï¼ˆé…ç½®ä¸­å¿ƒï¼‰ï¼š<strong>å‘å¸ƒè€…å°†æ•°æ®å‘å¸ƒåˆ°ZKçš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—èŠ‚ç‚¹ä¸Šï¼Œè®¢é˜…è€…è¿›è¡Œè®¢é˜…ï¼Œä»è€ŒåŠ¨æ€çš„è·å–æ•°æ®ï¼Œå®ç°é…ç½®ä¿¡æ¯çš„é›†ä¸­å¼ç®¡ç†å’Œæ•°æ®çš„åŠ¨æ€æ›´æ–°</strong>ã€‚</p><p>å‘å¸ƒ/è®¢é˜…ç³»ç»Ÿä¸€èˆ¬éƒ½åŒ…å«ä¸¤ç§è®¾è®¡æ¨¡å¼ï¼š<strong>æ¨å’Œæ‹‰æ¨¡å¼</strong>ã€‚æ¨æ¨¡å¼ä¸‹æœåŠ¡ç«¯ä¸»åŠ¨å°†æ•°æ®æ›´æ–°å‘é€ç»™æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯ï¼Œæ‹‰æ¨¡å¼ä¸‹åˆ™æ˜¯ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚è·å–æœ€æ–°æ•°æ®ï¼ˆè½®è¯¢ï¼‰ã€‚ZKå°†æ¨æ‹‰ç»“åˆï¼Œ<strong>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†Œè‡ªå·±æ„Ÿå…´è¶£çš„èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ•°æ®å˜æ›´ï¼ŒæœåŠ¡ç«¯å‘é€Watcheräº‹ä»¶é€šçŸ¥ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯åä¸»åŠ¨è·å–æœ€æ–°æ•°æ®</strong>ã€‚</p><p>æ¡ˆä¾‹ï¼šç³»ç»Ÿä¸­éœ€è¦ä¸€äº›é€šç”¨çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æœºå™¨åˆ—è¡¨ä¿¡æ¯ã€è¿è¡Œæ—¶çš„å¼€å…³é…ç½®ã€æ•°æ®åº“é…ç½®ä¿¡æ¯ç­‰ï¼Œè¿™äº›å…¨å±€çš„é…ç½®ä¿¡æ¯é€šå¸¸æœ‰3ä¸ªç‰¹æ€§ï¼š</p><ul><li>æ•°æ®é‡è¾ƒå°</li><li>æ•°æ®å†…å®¹ä¼šåœ¨è¿è¡Œæ—¶å‘ç”ŸåŠ¨æ€å˜åŒ–</li><li>é›†ç¾¤ä¸­å„æœºå™¨å…±äº«ï¼Œé…ç½®ä¸€è‡´</li></ul><p>å•æœºç³»ç»Ÿé€šå¸¸ä¼šé‡‡ç”¨æœ¬åœ°é…ç½®æ–‡ä»¶æˆ–å†…å­˜å˜é‡ï¼ˆJMXæ¥å®ç°å¯¹ç³»ç»Ÿè¿è¡Œæ—¶å†…å­˜å˜é‡çš„æ›´æ–°ï¼‰çš„æ–¹å¼ï¼Œä½†å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´è¿™ä¸¤å¼ æ–¹å¼æ¯”è¾ƒéš¾ç®¡ç†ã€‚</p><ul><li><p><strong>é…ç½®å­˜å‚¨ï¼š</strong></p><p>é¦–å…ˆå°†åˆå§‹åŒ–é…ç½®å­˜æ”¾åœ¨ZKä¸Šï¼Œé€‰å–ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010101.png"></p><p>å†™å…¥é…ç½®ä¿¡æ¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#DBCP</span></span><br><span class="line"><span class="string">dbcp.driverClassName=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">dbcp.dbJDBCUrl=jdbc:mysql://1.1.1.1:3306/taokeeper</span></span><br><span class="line"><span class="string">dbcp.characterEncoding=GBK</span></span><br><span class="line"><span class="string">dbcp.username=xiaoming</span></span><br><span class="line"><span class="string">dbcp.password=123456</span></span><br><span class="line"><span class="string">dbcp.maxActive=30</span></span><br><span class="line"><span class="string">dbcp.maxIdle=10</span></span><br><span class="line"><span class="string">dbcp.maxWait=10000</span></span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®è·å–ï¼š</strong>æ¯ä¸ªå®¢æˆ·ç«¯å¯åŠ¨æ—¶ä»ZKèŠ‚ç‚¹ä¸Šè¯»å–é…ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨è¯¥é…ç½®èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªæ•°æ®å˜æ›´çš„Watcherç›‘å¬ï¼Œä¸€æ—¦æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œæ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯éƒ½èƒ½æ”¶åˆ°é€šçŸ¥ã€‚</p></li><li><p><strong>é…ç½®å˜æ›´ï¼š</strong>è¿è¡Œæ—¶å¯èƒ½è¦åˆ‡æ¢æ•°æ®åº“ï¼Œæ­¤æ—¶åªéœ€å¯¹ZKèŠ‚ç‚¹ä¸Šçš„é…ç½®ä¿¡æ¯è¿›è¡Œæ›´æ”¹ã€‚</p></li></ul><h3 id="1-2-è´Ÿè½½å‡è¡¡"><a href="#1-2-è´Ÿè½½å‡è¡¡" class="headerlink" title="1.2 è´Ÿè½½å‡è¡¡"></a>1.2 è´Ÿè½½å‡è¡¡</h3><p>è´Ÿè½½å‡è¡¡å³å¯¹å¤šå°æœºå™¨ã€ç½‘ç»œè¿æ¥ã€CPUã€ç£ç›˜é©±åŠ¨æˆ–å…¶ä»–èµ„æºè¿›è¡Œåˆ†é…è´Ÿè½½ï¼Œä»¥è¾¾åˆ°ä¼˜åŒ–èµ„æºä½¿ç”¨ã€æœ€å¤§åŒ–ååç‡ã€æœ€å°åŒ–å“åº”æ—¶é—´å’Œé¿å…è¿‡è½½çš„ç›®çš„ã€‚</p><p>åˆ†å¸ƒå¼ç³»ç»Ÿå…·æœ‰å¯¹ç­‰æ€§ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œé€šå¸¸é‡‡ç”¨å‰¯æœ¬çš„æ–¹å¼æ¥å¯¹æ•°æ®å’ŒæœåŠ¡è¿›è¡Œéƒ¨ç½²ï¼Œå¯¹äºæ¶ˆè´¹è€…è€Œè¨€éœ€è¦åœ¨è¿™äº›å¯¹ç­‰çš„æœåŠ¡æä¾›æ–¹é€‰æ‹©ä¸€ä¸ªæ¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><p>å…¸å‹çš„è´Ÿè½½å‡è¡¡å¦‚<strong>DNS</strong>ï¼Œå³<strong>åŸŸåç³»ç»Ÿ</strong>ï¼ˆDomain Name Systemï¼‰ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè¶…å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼æ˜ å°„è¡¨ï¼Œç”¨äºå°†åŸŸåå’ŒIPåœ°å€è¿›è¡Œä¸€ä¸€æ˜ å°„ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨åŸŸåæ¥è®¿é—®äº’è”ç½‘ç«™ç‚¹ã€‚</p><p>æˆ‘ä»¬åªèƒ½æ³¨å†Œæœ‰é™çš„åŸŸåï¼Œå½“ç³»ç»Ÿè§„æ¨¡å˜å¤§ï¼Œå¾ˆéš¾é€šè¿‡ç»Ÿä¸€çš„DNSé…ç½®æ¥ç®¡ç†ã€‚å¯ä»¥ä½¿ç”¨æœ¬åœ°HOSTç»‘å®šæ¥å®ç°åŸŸåè§£æçš„å·¥ä½œï¼Œè§£å†³äº†åŸŸåç´§å¼ çš„é—®é¢˜ï¼Œå¯ä»¥éšæ—¶ä¿®æ”¹åŸŸåå’ŒIPçš„æ˜ å°„ï¼Œä½†æœºå™¨è§„æ¨¡æ‰©å¤§æ—¶ï¼Œç³»ç»Ÿä¸Šçº¿å‰è¦åœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šåŸŸåä¼šéå¸¸ä¸æ–¹ä¾¿ï¼Œå¦‚æœéœ€è¦ä¸´æ—¶æ›´æ–°åŸŸåè¿˜éœ€è¦åˆ°æ¯å°æœºå™¨ä¸Šå˜æ›´ã€‚</p><h4 id="ï¼ˆ1ï¼‰åŠ¨æ€DNSæœåŠ¡"><a href="#ï¼ˆ1ï¼‰åŠ¨æ€DNSæœåŠ¡" class="headerlink" title="ï¼ˆ1ï¼‰åŠ¨æ€DNSæœåŠ¡"></a>ï¼ˆ1ï¼‰åŠ¨æ€DNSæœåŠ¡</h4><ul><li><p><strong>é…ç½®ç®¡ç†ï¼š</strong></p><p>é¦–å…ˆè¦åœ¨ZKä¸Šåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹è¿›è¡ŒåŸŸåé…ç½®ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010102.png"></p><p>æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥åˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„æ•°æ®èŠ‚ç‚¹ä½œä¸ºåŸŸåé…ç½®çš„æ ¹èŠ‚ç‚¹ï¼Œé…ç½®æ¸…å•ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å•ä¸ªIP:PORT</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br><span class="line"><span class="comment">#å¤šä¸ªIP:PORT</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080,</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åŸŸåè§£æï¼š</strong></p><p>ä¼ ç»ŸDNSè§£æçš„å·¥ä½œç”±æ“ä½œç³»ç»Ÿçš„åŸŸåå’ŒIPåœ°å€æ˜ å°„æœºåˆ¶æˆ–åŸŸåè§£ææœåŠ¡å™¨å®Œæˆã€‚è€ŒZKå®ç°çš„DDNSåˆ™éœ€è¦æ¯ä¸ªåº”ç”¨è‡ªå·±ä»ZKæ•°æ®èŠ‚ç‚¹ä¸Šè·å–ä¸€ä»½IPåœ°å€å’Œç«¯å£çš„é…ç½®ï¼Œå¹¶è‡ªè¡Œè§£æã€‚æ¯ä¸ªåº”ç”¨éƒ½ä¼šåœ¨åŸŸåèŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªæ•°æ®å˜æ›´Watcherç›‘å¬ã€‚</p></li><li><p><strong>åŸŸåå˜æ›´ï¼š</strong></p><p>è¿è¡Œè¿‡ç¨‹ä¸­è¦æ›´æ–°IPåœ°å€æˆ–ç«¯å£æ—¶ï¼Œåªéœ€å¯¹æŒ‡å®šçš„åŸŸåèŠ‚ç‚¹è¿›è¡Œæ›´æ–°æ“ä½œï¼ŒZKä¼šå‘è®¢é˜…çš„å®¢æˆ·ç«¯å‘é€é€šçŸ¥ã€‚</p></li></ul><h4 id="ï¼ˆ2ï¼‰è‡ªåŠ¨åŒ–çš„DNSæœåŠ¡"><a href="#ï¼ˆ2ï¼‰è‡ªåŠ¨åŒ–çš„DNSæœåŠ¡" class="headerlink" title="ï¼ˆ2ï¼‰è‡ªåŠ¨åŒ–çš„DNSæœåŠ¡"></a>ï¼ˆ2ï¼‰è‡ªåŠ¨åŒ–çš„DNSæœåŠ¡</h4><p>ä¸Šè¿°å®ç°åœ¨åŸŸåå˜æ›´çš„ç¯èŠ‚è¿˜æ˜¯éœ€è¦äººä¸ºçš„ä»‹å…¥å–ä¿®æ”¹åŸŸåèŠ‚ç‚¹ä¸Šçš„IPåœ°å€å’Œç«¯å£ï¼ŒZKå®ç°äº†è‡ªåŠ¨åŒ–çš„DNSæœåŠ¡ä¸ºäº†å®ç°æœåŠ¡çš„è‡ªåŠ¨åŒ–å®šä½ï¼Œç³»ç»Ÿæ¶æ„å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010103.png"></p><p>é‡è¦çš„ç»„ä»¶ï¼š</p><ul><li><strong>Registerï¼š</strong>é›†ç¾¤è´Ÿè´£åŸŸåçš„åŠ¨æ€æ³¨å†Œ</li><li><strong>Dispatcherï¼š</strong>é›†ç¾¤è´Ÿè´£åŸŸåè§£æ</li><li><strong>Scannerï¼š</strong>é›†ç¾¤è´Ÿè´£æ£€æµ‹ä»¥åŠç»´æŠ¤æœåŠ¡çŠ¶æ€ï¼ˆæ¢æµ‹æœåŠ¡çš„å¯ç”¨æ€§ã€å±è”½å¼‚å¸¸æœåŠ¡èŠ‚ç‚¹ç­‰ï¼‰</li><li><strong>SDKï¼š</strong>æä¾›å„ç§è¯­è¨€çš„ç³»ç»Ÿæ¥å…¥åè®®ï¼Œæä¾›æœåŠ¡æ³¨å†Œä»¥åŠæŸ¥è¯¢æ¥å£</li><li><strong>Monitorï¼š</strong>è´Ÿè´£æ”¶é›†æœåŠ¡ä¿¡æ¯ä»¥åŠå¯¹DDNSè‡ªèº«çŠ¶æ€çš„ç›‘æ§</li><li><strong>Controllerï¼š</strong>åå°ç®¡ç†çš„Consoleï¼Œè´Ÿè´£æˆæƒç®¡ç†ã€æµé‡æ§åˆ¶ã€é™æ€é…ç½®æœåŠ¡å’Œæ‰‹åŠ¨å±è”½æœåŠ¡ç­‰åŠŸèƒ½ï¼Œè¿ç»´äººå‘˜å¯ä»¥åœ¨ä¸Šé¢ç®¡ç†Registerã€Dispatcherã€Scannerç­‰é›†ç¾¤ã€‚</li></ul><p>è‡ªåŠ¨åŒ–DNSæµç¨‹ï¼š</p><ul><li><p><strong>åŸŸåæ³¨å†Œï¼š</strong></p><p>æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨è¿‡ç¨‹æŠŠè‡ªå·±çš„åŸŸåä¿¡æ¯æ³¨å†Œåˆ° Register é›†ç¾¤ä¸­å»</p><ol><li>æœåŠ¡æä¾›è€…é€šè¿‡SDKæä¾›çš„APIæ¥å£ï¼Œå°†åŸŸåã€IPåœ°å€å’Œç«¯å£å‘é€ç»™ Register é›†ç¾¤ã€‚</li><li> Register æ”¶åˆ°åæ ¹æ®åŸŸåå°†ä¿¡æ¯å†™å…¥ç›¸åº”çš„ZKåŸŸåèŠ‚ç‚¹ä¸­ã€‚</li></ol></li><li><p><strong>åŸŸåè§£æï¼š</strong>ä¸åŸŸåæ³¨å†Œè¿‡ç¨‹ç›¸åï¼ŒæœåŠ¡æ¶ˆè´¹è€…åœ¨ä½¿ç”¨åŸŸåæ—¶ï¼Œä¼šå‘ Dispatcher å‘å‡ºåŸŸåè§£æè¯·æ±‚ã€‚Dispatcher æ”¶åˆ°è¯·æ±‚åï¼Œä¼šä»ZKä¸ŠæŒ‡å®šåŸŸåèŠ‚ç‚¹è¯»å–ç›¸åº”çš„IP:PORTåˆ—è¡¨ï¼Œé€šè¿‡ä¸€å®šçš„ç­–ç•¥é€‰å–ä¸€ä¸ªè¿”å›ç»™å‰ç«¯åº”ç”¨ã€‚</p></li><li><p><strong>åŸŸåæ¢æµ‹ï¼š</strong></p><p>æŒ‡DDNSç³»ç»Ÿå¯¹åŸŸåä¸‹æ‰€æœ‰æ³¨å†Œçš„IPåœ°å€å’Œç«¯å£è¿›è¡Œå¯ç”¨æ€§æ£€æµ‹/å¥åº·åº¦æ£€æµ‹ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>æœåŠ¡ç«¯ä¸»åŠ¨å‘èµ·å¥åº·åº¦å¿ƒè·³æ£€æµ‹ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹èµ·ä¸€ä¸ªTCPé•¿é“¾æ¥ï¼›</li><li>å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡ç«¯å‘èµ·å¥åº·åº¦å¿ƒè·³æ£€æµ‹ã€‚</li></ol><p>DDNSæ¶æ„ä¸­çš„åŸŸåæ£€æµ‹ä½¿ç”¨çš„æ˜¯æœåŠ¡æä¾›è€…ä¸»åŠ¨å®šæ—¶å‘Scannerè¿›è¡ŒçŠ¶æ€æ±‡æŠ¥çš„æ¨¡å¼ï¼ˆç¬¬äºŒç§ï¼‰ã€‚Scannerè´Ÿè´£è®°å½•æ¯ä¸ªæœåŠ¡æä¾›è€…æœ€è¿‘ä¸€æ¬¡çš„çŠ¶æ€æ±‡æŠ¥æ—¶é—´ï¼Œä¸€æ—¦è¶…è¿‡5ç§’æ²¡æœ‰æ”¶åˆ°çŠ¶æ€æ±‡æŠ¥å°±è®¤å®šæ­¤IPå’Œç«¯å£ä¸å¯ç”¨ï¼Œå¹¶è¿›è¡ŒåŸŸåæ¸…ç†è¿‡ç¨‹ã€‚</p><p>åŸŸåæ¸…ç†ï¼ŒScannerä¼šåœ¨ZKä¸­æ‰¾åˆ°å¯¹äºåŸŸåèŠ‚ç‚¹ï¼Œå¹¶å°†IPå’Œç«¯å£é…ç½®ä»èŠ‚ç‚¹å†…å®¹ä¸­ç§»é™¤ã€‚</p></li></ul><h3 id="1-3-å‘½åæœåŠ¡"><a href="#1-3-å‘½åæœåŠ¡" class="headerlink" title="1.3 å‘½åæœåŠ¡"></a>1.3 å‘½åæœåŠ¡</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¢«å‘½åçš„å®ä½“é€šå¸¸æ˜¯é›†ç¾¤ä¸­çš„æœºå™¨ã€æä¾›çš„æœåŠ¡åœ°å€æˆ–è¿œç¨‹å¯¹è±¡ç­‰ï¼Œè¾ƒå¸¸è§çš„æ˜¯ä¸€äº›åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶RPCæˆ–RMIä¸­çš„æœåŠ¡åœ°å€åˆ—è¡¨ï¼Œé€šè¿‡å‘½åæœåŠ¡ï¼Œå®¢æˆ·ç«¯åº”ç”¨èƒ½å¤Ÿæ ¹æ®æŒ‡å®šåå­—æ¥è·å–èµ„æºçš„å®ä½“ã€æœåŠ¡åœ°å€å’Œæä¾›è€…çš„ä¿¡æ¯ç­‰ã€‚</p><ul><li>Javaçš„JNDIï¼ˆJavaå‘½åä¸ç›®å½•æ¥å£ï¼ŒJava Naming and Directory Interfaceï¼‰æ˜¯ä¸€ç§å…¸å‹çš„å‘½åæœåŠ¡ï¼Œæ ‡å‡†çš„J2EEå®¹å™¨éƒ½æä¾›äº†å¯¹JNDIè§„èŒƒçš„å®ç°ï¼Œå¯ä»¥ç”¨æ¥å®Œæˆæ•°æ®æºçš„é…ç½®å’Œç®¡ç†ã€‚</li><li>ZKçš„å‘½åæœåŠ¡ï¼Œä¸Šå±‚åº”ç”¨åªéœ€ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åå­—ï¼Œç±»ä¼¼äºå”¯ä¸€ä¸»é”®ã€‚</li></ul><p>ä½¿ç”¨ZKæ¥å®ç°ä¸€å¥—åˆ†å¸ƒå¼å…¨å±€å”¯ä¸€IDçš„åˆ†é…æœºåˆ¶ï¼šæ•°æ®åº“çš„å•åº“å•è¡¨å¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„ <code>auto_increment</code> å±æ€§æ¥è‡ªåŠ¨ä¸ºæ¯æ¡è®°å½•ç”Ÿæˆä¸€ä¸ªå”¯ä¸€IDï¼Œä½†éšç€æ•°æ®åº“æ•°æ®è§„æ¨¡ä¸æ–­å¢å¤§ï¼Œåˆ†åº“åˆ†è¡¨åè¿™ä¸ªå±æ€§å°±åªèƒ½é’ˆå¯¹å•ä¸€è¡¨ä¸­è®°å½•è‡ªåŠ¨ç”ŸæˆIDã€‚</p><p>UUIDï¼ˆé€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼ŒUniversally Unique Identifierï¼‰åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨äºä½œå”¯ä¸€æ ‡è¯†å…ƒç´ æ ‡å‡†ï¼Œä¸€ä¸ªæ ‡å‡†çš„UUIDæ˜¯ä¸€ä¸ªåŒ…å«32ä½å­—ç¬¦å’Œ4ä¸ªçŸ­çº¿çš„å­—ç¬¦ä¸²ã€‚</p><p>UUIDçš„ç¼ºç‚¹ï¼š</p><ul><li>é•¿åº¦è¿‡é•¿ï¼šç”Ÿæˆçš„å­—ç¬¦ä¸²è¿‡é•¿ï¼Œç›¸æ¯”INTç±»å‹å­˜å‚¨å¼€é”€æ›´å¤§ã€‚</li><li>å«ä¹‰ä¸æ˜ï¼šå­—ç¬¦ä¸²æœ¬èº«æ²¡æœ‰å«ä¹‰ã€‚</li></ul><p>å¯ä»¥é€šè¿‡ZKèŠ‚ç‚¹æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010104.png"></p><p>ZKä¸­æ¯ä¸ªæ•°æ®èŠ‚ç‚¹éƒ½èƒ½ç»´æŠ¤ä¸€ä»½å­èŠ‚ç‚¹çš„é¡ºåºé˜Ÿåˆ—ï¼Œå½“å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªé¡ºåºå­èŠ‚ç‚¹æ—¶ï¼ŒZKä¼šè‡ªåŠ¨ä»¥åç¼€çš„å½¢å¼åœ¨å­èŠ‚ç‚¹ä¸Šæ·»åŠ ä¸€ä¸ªåºå·ï¼š</p><ol><li>æ‰€æœ‰å®¢æˆ·ç«¯æ ¹æ®è‡ªå·±çš„ä»»åŠ¡ç±»å‹ï¼Œåœ¨æŒ‡å®šç±»å‹çš„ä»»åŠ¡ä¸‹é€šè¿‡è°ƒç”¨ <code>create()</code> æ¥å£æ¥åˆ›å»ºä¸€ä¸ªé¡ºåºèŠ‚ç‚¹ï¼ˆå¦‚â€œjob-â€èŠ‚ç‚¹ï¼‰ã€‚</li><li>èŠ‚ç‚¹åˆ›å»ºå®Œæ¯•ï¼Œ <code>create()</code> è¿”å›ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹åï¼ˆå¦‚â€œjob-0000000003â€ï¼‰ã€‚</li><li>å®¢æˆ·ç«¯æ‹¿åˆ°è¿”å›å€¼åï¼Œæ‹¼æ¥ä¸Štypeç±»å‹ï¼ˆå¦‚â€œtype2-job-0000000003â€ï¼‰ä½œä¸ºå…¨å±€å”¯ä¸€IDã€‚</li></ol><h3 id="1-4-åˆ†å¸ƒå¼åè°ƒ-é€šçŸ¥"><a href="#1-4-åˆ†å¸ƒå¼åè°ƒ-é€šçŸ¥" class="headerlink" title="1.4 åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥"></a>1.4 åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦å¼•å…¥ä¸€ä¸ªåè°ƒè€…ï¼ˆCoordinatorï¼‰æ§åˆ¶æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œæµç¨‹ï¼ˆå¦‚åˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†æˆ–æœºå™¨é—´çš„äº’ç›¸åè°ƒç­‰ï¼‰ä¾¿äºå°†åˆ†å¸ƒå¼åè°ƒçš„èŒè´£ä»åº”ç”¨æœ¬èº«æŠ½ç¦»ï¼Œå‡å°‘ç³»ç»Ÿé—´çš„è€¦åˆæ€§ï¼Œæä¾›å¯æ‰©å±•æ€§ã€‚</p><p>åŸºäºZKå®ç°çš„åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥é€šå¸¸åšæ³•ï¼šä¸åŒçš„å®¢æˆ·ç«¯éƒ½å¯¹ZKä¸ŠåŒä¸€ä¸ªæ•°æ®èŠ‚ç‚¹è¿›è¡ŒWatcheræ³¨å†Œï¼Œç›‘å¬æ•°æ®èŠ‚ç‚¹çš„å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œæ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯éƒ½èƒ½æ”¶åˆ°å¹¶å¤„ç†ã€‚</p><h4 id="ï¼ˆ1ï¼‰MySQLæ•°æ®å¤åˆ¶æ€»çº¿-Mysql-Replicator"><a href="#ï¼ˆ1ï¼‰MySQLæ•°æ®å¤åˆ¶æ€»çº¿-Mysql-Replicator" class="headerlink" title="ï¼ˆ1ï¼‰MySQLæ•°æ®å¤åˆ¶æ€»çº¿-Mysql_Replicator"></a>ï¼ˆ1ï¼‰MySQLæ•°æ®å¤åˆ¶æ€»çº¿-Mysql_Replicator</h4><p>MySQLæ•°æ®å¤åˆ¶æ€»çº¿æ˜¯ä¸€ä¸ªå®æ—¶æ•°æ®å¤åˆ¶æ¡†æ¶ï¼Œ<strong>ç”¨äºåœ¨ä¸åŒçš„MySQLæ•°æ®åº“å®ä¾‹ä¹‹é—´è¿›è¡Œå¼‚æ­¥æ•°æ®å¤åˆ¶åˆæ•°æ®å˜åŒ–é€šçŸ¥</strong>ã€‚</p><p>ç³»ç»Ÿæ˜¯ç”±ä¸€ä¸ªMySQLæ•°æ®åº“é›†ç¾¤ã€æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿã€ä»»åŠ¡ç®¡ç†ç›‘æ§å¹³å°ä»¥åŠZKé›†ç¾¤ç­‰ç»„ä»¶å…±åŒæ„æˆçš„ä¸€ä¸ªåŒ…å«æ•°æ®ç”Ÿäº§è€…ã€å¤åˆ¶ç®¡é“å’Œæ•°æ®æ¶ˆè´¹è€…ç­‰éƒ¨åˆ†çš„æ•°æ®æ€»çº¿ç³»ç»Ÿï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010105.png"></p><p>ZKè´Ÿè´£ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼åè°ƒå·¥ä½œï¼Œæ ¹æ®åŠŸèƒ½å°†æ•°æ®å¤åˆ¶ç»„ä»¶åˆ’åˆ†ä¸ºä¸‰ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ä½œä¸ºç‹¬ç«‹çš„è¿›ç¨‹è¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œè¿è¡Œæ—¶æ•°æ®å’Œé…ç½®ä¿¡æ¯ä¿å­˜åœ¨ZKä¸Šï¼š</p><ul><li><strong>Coreï¼š</strong>å®ç°äº†æ•°æ®å¤åˆ¶çš„æ ¸å¿ƒé€»è¾‘ï¼Œå°†æ•°æ®å¤åˆ¶å°è£…æˆç®¡é“ï¼Œå¹¶æŠ½è±¡å‡ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸¤ä¸ªæ¦‚å¿µï¼Œç”Ÿäº§è€…é€šå¸¸æ˜¯MySQLçš„Binlogæ—¥å¿—ã€‚</li><li><strong>Serverï¼š</strong>è´Ÿè´£å¯åŠ¨å’Œåœæ­¢å¤åˆ¶ä»»åŠ¡ã€‚</li><li><strong>Monitorï¼š</strong>è´Ÿè´£ç›‘æ§ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœåœ¨æ•°æ®å¤åˆ¶æœŸé—´å‘ç”Ÿå¼‚å¸¸æˆ–æ•…éšœä¼šå‘Šè­¦ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010106.png"></p><h4 id="ï¼ˆ2ï¼‰Coreè¿›è¡Œåˆ†å¸ƒå¼åè°ƒçš„æµç¨‹"><a href="#ï¼ˆ2ï¼‰Coreè¿›è¡Œåˆ†å¸ƒå¼åè°ƒçš„æµç¨‹" class="headerlink" title="ï¼ˆ2ï¼‰Coreè¿›è¡Œåˆ†å¸ƒå¼åè°ƒçš„æµç¨‹"></a>ï¼ˆ2ï¼‰Coreè¿›è¡Œåˆ†å¸ƒå¼åè°ƒçš„æµç¨‹</h4><ol><li><p><strong>ä»»åŠ¡æ³¨å†Œï¼š</strong></p><p>Coreè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé¦–å…ˆå‘ <code>/mysql_replicator/tasks</code> èŠ‚ç‚¹ï¼ˆä»»åŠ¡åˆ—è¡¨èŠ‚ç‚¹ï¼‰æ³¨å†Œä»»åŠ¡ã€‚å½“æ³¨å†Œè¿‡ç¨‹å‘ç°å­èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œè¡¨ç¤ºå·²æœ‰å…¶ä»–Taskæœºå™¨æ³¨å†Œäº†è¯¥ä»»åŠ¡ï¼Œä»¥ä¸‹ä¸ºâ€œå¤åˆ¶çƒ­é—¨å•†å“â€çš„ä»»åŠ¡ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010107.png"></p></li><li><p><strong>ä»»åŠ¡çƒ­å¤‡ä»½ï¼š</strong></p><ul><li>å¤åˆ¶ç»„ä»¶é‡‡ç”¨çƒ­å¤‡ä»½çš„å®¹ç¾æ–¹å¼æ¥åº”å¯¹å¤åˆ¶ä»»åŠ¡å¯èƒ½ä¼šé‡åˆ°çš„æ•…éšœï¼Œå³0å°†åŒä¸€ä¸ªå¤åˆ¶ä»»åŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„ä¸»æœºä¸Šï¼Œä¸»å¤‡æœºå™¨é€šè¿‡ZKäº’ç›¸æ£€æµ‹è¿è¡Œå¥åº·çŠ¶å†µã€‚</li><li>å®ç°çƒ­å¤‡æ–¹æ¡ˆï¼Œä¸ç®¡ç¬¬ä¸€æ­¥æ˜¯å¦åˆ›å»ºäº†ä»»åŠ¡èŠ‚ç‚¹ï¼Œæ¯å°ä»»åŠ¡æœºå™¨éƒ½è¦åœ¨ <code>/mysql_replicator/tasks/copy_hot_item/instances</code> èŠ‚ç‚¹ä¸Šå°†è‡ªå·±çš„ä¸»æœºåæ³¨å†Œä¸Šå»ã€‚æ³¨å†Œçš„æ˜¯ä¸€ä¸ªä¸´æ—¶çš„é¡ºåºèŠ‚ç‚¹ <code>/mysql_replicator/tasks/copy_hot_item/instances/[Hostname]-1</code> æœ€åçš„åºåˆ—å·æ˜¯ä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„ç²¾åã€‚</li><li>å®Œæˆå­èŠ‚ç‚¹åˆ›å»ºåï¼Œæ¯å°æœºå™¨éƒ½å¯ä»¥é€šè¿‡å¯¹æ¯”è‡ªå·±æ˜¯å¦æ˜¯æ‰€æœ‰å­èŠ‚ç‚¹åºå·ä¸­æœ€å°çš„ï¼Œå¦‚æœæ˜¯å°±å°†è‡ªå·±çš„è¿è¡ŒçŠ¶æ€ç½®ä¸º RUNNINGï¼Œå…¶ä½™çš„æœºå™¨åˆ™è®¾ç½®ä¸º STANDBYï¼Œå³<strong>å°åºå·ä¼˜å…ˆ</strong>ã€‚</li></ul></li><li><p><strong>çƒ­å¤‡åˆ‡æ¢ï¼š</strong></p><ul><li>ä»»åŠ¡æœºå™¨åœ¨å®ŒæˆçŠ¶æ€æ ‡è¯†åå°±å¯ä»¥å·¥ä½œäº†ï¼ŒRUNNINGè¿›è¡Œæ•°æ®å¤åˆ¶ï¼ŒSTANDBYåˆ™è¿›å…¥å¾…å‘½çŠ¶æ€ï¼Œä¸€æ—¦RUNNINGçš„æœºå™¨å‡ºç°æ•…éšœï¼Œå–ä¸€ä¸ªå¾…å‘½çŠ¶æ€æœ€å°çš„æœºå™¨æ›¿è¡¥æ‰§è¡Œã€‚</li><li>æ‰€ä»¥å¾…å‘½çš„æœºå™¨éƒ½è¦åœ¨ <code>/mysql_replicator/tasks/copy_hot_item/instances</code> èŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªWatcherç›‘å¬å­èŠ‚ç‚¹åˆ—è¡¨å˜æ›´ï¼Œè®¢é˜…æ‰€æœ‰ä»»åŠ¡æœºå™¨çš„å˜åŒ–æƒ…å†µï¼ŒRUNNINGæœºå™¨å®•æœºä¸ZKæ–­å¼€è¿æ¥åèŠ‚ç‚¹ä¼šæ¶ˆå¤±ï¼Œå…¶ä½™æœºå™¨æ”¶åˆ°é€šçŸ¥åå¼€å¯æ–°ä¸€è½®çš„RUNNINGé€‰ä¸¾ã€‚</li></ul></li><li><p><strong>è®°å½•æ‰§è¡ŒçŠ¶æ€ï¼š</strong>RUNNINGæœºå™¨éœ€è¦å°†è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ä¿ç•™ç»™STANDBYæœºå™¨ï¼ŒMySQLé€‰æ‹© <code>/mysql_replicator/tasks/copy_hot_item/lastCommit</code> ä½œä¸ºBinlogæ—¥å¿—æ¶ˆè´¹ä½ç‚¹çš„å­˜å‚¨èŠ‚ç‚¹ï¼Œ RUNNINGå®šæ—¶å†™å…¥å½“å‰ä¿¡æ¯ã€‚</p></li></ol><h4 id="ï¼ˆ3ï¼‰Serverç®¡ç†Coreç»„ä»¶"><a href="#ï¼ˆ3ï¼‰Serverç®¡ç†Coreç»„ä»¶" class="headerlink" title="ï¼ˆ3ï¼‰Serverç®¡ç†Coreç»„ä»¶"></a>ï¼ˆ3ï¼‰Serverç®¡ç†Coreç»„ä»¶</h4><ol><li><p><strong>æ§åˆ¶å°åè°ƒï¼š</strong>Serverçš„ä¸»è¦å·¥ä½œæ˜¯é€šè¿‡ZKæ¥å¯¹ä¸åŒä»»åŠ¡è¿›è¡Œæ§åˆ¶å’Œåè°ƒï¼ŒServerå°†æ¯ä¸ªå¤åˆ¶ä»»åŠ¡å¯¹äºç”Ÿäº§è€…çš„å…ƒæ•°æ®ï¼ˆåº“åã€è¡¨åã€ç”¨æˆ·åå’Œå¯†ç ç­‰æ•°æ®åº“ä¿¡æ¯ä»¥åŠæ¶ˆè´¹è€…ç›¸å…³ä¿¡æ¯ï¼‰ä»¥é…ç½®çš„å½¢å¼å†™å…¥ä»»åŠ¡èŠ‚ç‚¹ <code>/mysql_replicator/tasks/copy_hot_item</code> ä½¿ä»»åŠ¡çš„æ‰€æœ‰æœºå™¨éƒ½èƒ½èƒ½å…±äº«é…ç½®ã€‚</p></li><li><p><strong>å†·å¤‡åˆ‡æ¢ï¼š</strong></p><p>åœ¨ä¸€å®šè§„æ¨¡çš„åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œå¾€å¾€æœ‰è®¸å¤šMySQLå®ä¾‹éœ€è¦è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œæ¯ä¸ªå®ä¾‹éƒ½è¦å¯¹åº”ä¸€ä¸ªå¤åˆ¶ä»»åŠ¡ï¼Œå¦‚æœæ¯ä¸ªä»»åŠ¡éƒ½è¿›è¡ŒåŒæœºçƒ­å¤‡ä»½ä¼šæ¶ˆè€—å¤ªå¤šçš„æœºå™¨ã€‚</p><p>æ ¹æ®è¿™ä¸ªé—®é¢˜è®¾è®¡ä¸€ç§æ–°çš„å†·å¤‡ä»½çš„æ–¹æ¡ˆï¼Œå®ƒå¯¹æ‰€æœ‰ä»»åŠ¡è¿›è¡Œåˆ†ç»„ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010108.png"></p><p>Coreè¿›ç¨‹è¢«é…ç½®äº†æ‰€å±Groupï¼Œ<strong>å†·å¤‡ä»½æ‰«æ</strong>ï¼š</p><ul><li>å‡å¦‚ä¸€ä¸ªCoreè¿›ç¨‹è¢«æ ‡è®°äº†group1ï¼Œå¯åŠ¨åä¼šè·å–å¯¹åº”èŠ‚ç‚¹ä¸‹æ‰€æœ‰çš„Taskåˆ—è¡¨ã€‚</li><li>å¦‚æœæ‰¾åˆ°äº†ä»»åŠ¡ <code>copy_hot_item</code> ä¼šéå†instancesèŠ‚ç‚¹ï¼Œè‹¥æ²¡æœ‰å­èŠ‚ç‚¹åˆ™åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„é¡ºåºèŠ‚ç‚¹ <code>copy_hot_item/instances/[Hostname]-1</code> ã€‚</li><li>ç±»ä¼¼äºçƒ­å¤‡ä»½çš„å°åºå·ä¼˜å…ˆï¼Œ<strong>æœ€å°çš„Coreè¿›ç¨‹æ ‡è®°ä¸ºRUNNINGï¼Œä¸åŒçš„æ˜¯å…¶ä»–Coreè¿›ç¨‹ä¼šè‡ªåŠ¨å°†åˆ›å»ºçš„å­èŠ‚ç‚¹åˆ é™¤ï¼Œç„¶åç»§ç»­éå†ä¸‹ä¸€ä¸ªTaskèŠ‚ç‚¹</strong>ã€‚</li></ul></li><li><p><strong>å†·çƒ­å¤‡ä»½å¯¹æ¯”ï¼š</strong></p><ul><li>çƒ­å¤‡ä»½ï¼šé’ˆå¯¹ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨ä¸¤å°æœºå™¨åšå¤‡ä»½ï¼Œç”±äºWatcheré€šçŸ¥å’Œä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§ï¼Œå¯ä»¥å®æ—¶çš„è¿›è¡Œåè°ƒï¼›æœºå™¨èµ„æºæ¶ˆè€—è¾ƒå¤§ã€‚</li><li>å†·å¤‡ä»½ï¼šä½¿ç”¨äº†æ‰«ææœºåˆ¶ï¼Œè™½ç„¶é™ä½äº†å®æ—¶æ€§ï¼Œä½†èŠ‚çœäº†æœºå™¨èµ„æºã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010109.png"></p></li></ol><h4 id="ï¼ˆ4ï¼‰æœºå™¨é—´é€šä¿¡æ–¹å¼"><a href="#ï¼ˆ4ï¼‰æœºå™¨é—´é€šä¿¡æ–¹å¼" class="headerlink" title="ï¼ˆ4ï¼‰æœºå™¨é—´é€šä¿¡æ–¹å¼"></a>ï¼ˆ4ï¼‰æœºå™¨é—´é€šä¿¡æ–¹å¼</h4><p>å¸¸è§åˆ†å¸ƒå¼ç³»ç»Ÿæœºå™¨é—´é€šä¿¡æ–¹å¼ï¼š</p><ul><li><strong>å¿ƒè·³æ£€æµ‹ï¼š</strong>ä¸åŒæœºå™¨ä¹‹é—´æ£€æµ‹å½¼æ­¤æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨ZKçš„ä¸´æ—¶èŠ‚ç‚¹å®ç°è€Œä¸åŒäºå¸¸è§„çš„PINGæˆ–TCPé•¿è¿æ¥ã€‚æ‰€æœ‰æœºå™¨åœ¨ZKçš„ä¸€ä¸ªæŒ‡å®šèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶å­èŠ‚ç‚¹ï¼Œæœºå™¨ä¹‹é—´å¯ä»¥æ ¹æ®ä¸´æ—¶èŠ‚ç‚¹åˆ¤æ–­å¯¹åº”æœºå™¨æ˜¯å¦å­˜æ´»ï¼Œè¿™æ ·æœºå™¨ä¹‹é—´ä¸éœ€è¦ç›´æ¥äº¤äº’ã€‚</li><li><strong>å·¥ä½œè¿›åº¦æ±‡æŠ¥ï¼š</strong>ä»»åŠ¡åˆ†å‘åˆ°ä¸åŒæœºå™¨ä¸Šæ‰§è¡Œåï¼Œéœ€è¦å®æ—¶çš„å°†è‡ªå·±çš„æ‰§è¡Œè¿›åº¦æ±‡æŠ¥ç»™åˆ†å‘ç³»ç»Ÿï¼Œæ¯ä¸ªä»»åŠ¡å®¢æˆ·ç«¯åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶å­èŠ‚ç‚¹ï¼š<ul><li>é€šè¿‡åˆ¤æ–­ä¸´æ—¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨åˆ¤æ–­å¯¹åº”ä»»åŠ¡æœºå™¨æ˜¯å¦å­˜æ´»ï¼›</li><li>å„ä¸ªä»»åŠ¡æœºå™¨å®æ—¶çš„å°†è‡ªå·±çš„ä»»åŠ¡æ‰§è¡Œè¿›åº¦å†™å…¥ä¸´æ—¶èŠ‚ç‚¹ï¼Œä¸­å¿ƒç³»ç»Ÿå®šæ—¶çš„è·å–ã€‚</li></ul></li><li><strong>ç³»ç»Ÿè°ƒåº¦ï¼š</strong>æ§åˆ¶å°å°†æŒ‡ä»¤å‘é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå®é™…æ˜¯æ”¹ZKèŠ‚ç‚¹çš„æ•°æ®ï¼Œæ•°æ®å˜æ›´çš„é€šçŸ¥å†å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>ç”¨ZKæ¥å®ç°åˆ†å¸ƒå¼é€šä¿¡å¯ä»¥é™ä½ç³»ç»Ÿé—´çš„è€¦åˆå’Œå‡å°‘åº•å±‚ç½‘ç»œé€šä¿¡ä»¥åŠåè®®è®¾è®¡ä¸Šçš„é‡å¤å·¥ä½œã€‚</p><h3 id="1-5-é›†ç¾¤ç®¡ç†"><a href="#1-5-é›†ç¾¤ç®¡ç†" class="headerlink" title="1.5 é›†ç¾¤ç®¡ç†"></a>1.5 é›†ç¾¤ç®¡ç†</h3><p>é›†ç¾¤ç®¡ç†åŒ…æ‹¬ï¼š</p><ul><li>é›†ç¾¤ç›‘æ§ï¼šä¾§é‡å¯¹é›†ç¾¤è¿è¡Œæ—¶çŠ¶æ€çš„æ”¶é›†</li><li>é›†ç¾¤æ§åˆ¶ï¼šä¾§é‡å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œä¸æ§åˆ¶</li></ul><h4 id="ï¼ˆ1ï¼‰ä¼ ç»ŸAgentçš„å¼Šç«¯"><a href="#ï¼ˆ1ï¼‰ä¼ ç»ŸAgentçš„å¼Šç«¯" class="headerlink" title="ï¼ˆ1ï¼‰ä¼ ç»ŸAgentçš„å¼Šç«¯"></a>ï¼ˆ1ï¼‰ä¼ ç»ŸAgentçš„å¼Šç«¯</h4><p>ä¼ ç»ŸåŸºäºAgentçš„åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†ä½“ç³»ï¼Œæ¯å°æœºå™¨éƒ¨ç½²ä¸€ä¸ªAgentï¼Œè´Ÿè´£ä¸»åŠ¨å‘æŒ‡å®šçš„ç›‘æ§ä¸­å¿ƒæ±‡æŠ¥çŠ¶æ€ï¼Œæ¥å®ç°é›†ç¾¤ç›‘æ§ï¼Œå…¶å¼Šç«¯ï¼š</p><ul><li><strong>å¤§è§„æ¨¡å‡çº§å›°éš¾ï¼š</strong>å¤§è§„æ¨¡å‡çº§çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å½¢å¼çš„Agentéå¸¸éº»çƒ¦ã€‚</li><li><strong>ç»Ÿä¸€çš„Agentæ— æ³•æ»¡è¶³å¤šæ ·çš„éœ€æ±‚ï¼š</strong>Agentå¯ä»¥æ»¡è¶³å¦‚CPUä½¿ç”¨ç‡ã€è´Ÿè½½ã€å†…å­˜ä½¿ç”¨ç‡ã€ç½‘ç»œååä»¥åŠç£ç›˜å®¹é‡ç­‰åŸºæœ¬ç‰©ç†çŠ¶æ€çš„ç›‘æ§ï¼Œä½†å¦‚æœè¦æ·±å…¥åˆ°ä¸šåŠ¡çŠ¶æ€ï¼ˆæ¯”å¦‚ç›‘æ§æ¯ä¸ªæ¶ˆè´¹è€…å¯¹æ¶ˆæ¯çš„æ¶ˆè´¹çŠ¶æ€ï¼Œæˆ–æ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¯å°ä»»åŠ¡æœºå™¨ä¸Šçš„ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼‰å°±ä¸é€‚åˆç”±ç»Ÿä¸€çš„Agentæ¥æä¾›ã€‚</li><li><strong>ç¼–ç¨‹è¯­è¨€å¤šæ ·æ€§ï¼š</strong>ä¼ ç»Ÿçš„Agentéœ€è¦æä¾›å„ç§è¯­è¨€ç‰ˆçš„å®¢æˆ·ç«¯ã€‚</li></ul><h4 id="ï¼ˆ2ï¼‰åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿ"><a href="#ï¼ˆ2ï¼‰åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿ" class="headerlink" title="ï¼ˆ2ï¼‰åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿ"></a>ï¼ˆ2ï¼‰åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿ</h4><p>åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿè¦è§£å†³çš„é—®é¢˜ï¼š</p><ul><li><strong>å˜åŒ–çš„æ—¥å¿—æºæœºå™¨ï¼š</strong>æ¯ä¸ªåº”ç”¨çš„æœºå™¨å‡ ä¹æ¯å¤©éƒ½æ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯å› ä¸º</li><li><strong>å˜åŒ–çš„æ”¶é›†å™¨æœºå™¨ï¼š</strong>æ—¥å¿—æ”¶é›†ç³»ç»Ÿè‡ªèº«ä¹Ÿä¼šæœ‰æœºå™¨çš„å˜æ›´å’Œæ‰©å®¹ã€‚</li></ul><p>æµç¨‹ï¼š</p><ul><li><p><strong>æ³¨å†Œæ”¶é›†å™¨æœºå™¨ï¼š</strong>åœ¨ZKä¸Šåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ”¶é›†å™¨çš„æ ¹èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ”¶é›†å™¨æœºå™¨å¯åŠ¨æ—¶éƒ½ä¼šåœ¨æ”¶é›†å™¨èŠ‚ç‚¹ä¸‹åˆ›å»ºè‡ªå·±çš„èŠ‚ç‚¹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010110.png"></p></li><li><p><strong>ä»»åŠ¡åˆ†å‘ï¼š</strong>å¾…æ‰€æœ‰æ”¶é›†å™¨éƒ½åˆ›å»ºå¥½è‡ªå·±çš„èŠ‚ç‚¹ï¼Œæ ¹æ®å­èŠ‚ç‚¹æ•°ç›®å°†æ‰€æœ‰æ—¥å¿—æºæœºå™¨åˆ†ä¸ºå¯¹åº”çš„è‹¥å¹²ç»„ï¼Œç„¶åå°†åˆ†ç»„åçš„æœºå™¨åˆ—è¡¨åˆ†åˆ«å†™åˆ°æ”¶é›†å™¨åˆ›å»ºçš„å­èŠ‚ç‚¹ä¸Šï¼Œæ¯å°æ”¶é›†å™¨éƒ½å¯ä»¥ä»è‡ªå·±çš„èŠ‚ç‚¹ä¸Šè·å–æ—¥å¿—æºæœºå™¨åˆ—è¡¨ã€‚</p></li><li><p><strong>çŠ¶æ€æ±‡æŠ¥ï¼š</strong>æˆ‘ä»¬è¦è€ƒè™‘åˆ°æœºå™¨æœ‰éšæ—¶æŒ‚æ‰çš„å¯èƒ½ï¼Œæ‰€ä»¥è¦æœ‰ä¸€ä¸ªæ”¶é›†å™¨çš„çŠ¶æ€æ±‡æŠ¥æœºåˆ¶ï¼Œæ¯ä¸ªæ”¶é›†å™¨æœºå™¨åœ¨åˆ›å»ºå®Œè‡ªå·±çš„èŠ‚ç‚¹åè¿˜è¦å†å¯¹åº”çš„å­èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªçŠ¶æ€å­èŠ‚ç‚¹ï¼Œå®šæœŸå‘è¯¥èŠ‚ç‚¹å†™å…¥è‡ªå·±çš„çŠ¶æ€ä¿¡æ¯ï¼ˆç±»ä¼¼äºå¿ƒè·³æ£€æµ‹ï¼‰ã€‚</p></li><li><p><strong>åŠ¨æ€åˆ†é…ï¼š</strong>å¦‚æœæ”¶é›†å™¨æŒ‚æ‰æˆ–è€…æ‰©å®¹ï¼Œéœ€è¦åŠ¨æ€çš„è¿›è¡Œæ”¶é›†ä»»åŠ¡çš„åˆ†é…ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ—¥å¿—ç³»ç»Ÿå§‹ç»ˆå…³æ³¨ç€ <code>/logs/collector</code> èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹çš„å˜æ›´ï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰æ”¶é›†å™¨åœæ­¢æ±‡æŠ¥æˆ–æœ‰æ–°çš„æ”¶é›†å™¨åŠ å…¥å°±ä¼šè¿›è¡Œä»»åŠ¡çš„é‡æ–°åˆ†é…ã€‚</p><p>å°†ä¹‹å‰åˆ†é…çš„ä»»åŠ¡è½¬ç§»çš„æ–¹æ³•ï¼š</p><ul><li><strong>å…¨å±€åŠ¨æ€åˆ†é…ï¼š</strong>ç³»ç»Ÿæ ¹æ®æ–°çš„æ”¶é›†å™¨æœºå™¨åˆ—è¡¨ï¼Œå°†æ‰€æœ‰æ—¥å¿—æºæœºå™¨é‡æ–°è¿›è¡Œåˆ†ç»„ï¼Œé‡æ–°åˆ†é…ç»™å½“å‰æ‰€æœ‰æ”¶é›†å™¨ã€‚</li><li><strong>å±€éƒ¨åŠ¨æ€åˆ†é…ï¼š</strong>åœ¨å°èŒƒå›´å†…è¿›è¡Œä»»åŠ¡çš„åŠ¨æ€åˆ†é…ï¼Œæ¯ä¸ªæ”¶é›†å™¨åœ¨æ±‡æŠ¥çŠ¶æ€çš„åŒæ—¶ä¹Ÿæºå¸¦è‡ªå·±çš„è´Ÿè½½ï¼ˆéCPUè´Ÿè½½è€Œæ˜¯å½“å‰ä»»åŠ¡çš„ç»¼åˆè¯„ä¼°ï¼‰ï¼Œå½“æ”¶é›†å™¨æŒ‚æ‰ï¼Œå°±ä¼˜å…ˆåˆ†é…ç»™è´Ÿè½½è¾ƒä½çš„æœºå™¨ï¼Œæ–°çš„æœºå™¨åŠ å…¥æ—¶ä¹Ÿä¼šæŠŠè´Ÿè½½è¾ƒé«˜çš„æœºå™¨éƒ¨åˆ†ä»»åŠ¡è½¬ç§»è¿‡å»ã€‚</li></ul></li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><strong>èŠ‚ç‚¹ç±»å‹ï¼š</strong>æ¯ä¸ªä»£è¡¨æ”¶é›†å™¨çš„å­èŠ‚ç‚¹å¦‚æœæ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹å¤±æ•ˆæ—¶ä¼šè¢«ç«‹å³åˆ é™¤ï¼Œè®°å½•çš„æ—¥å¿—æºæœºå™¨åˆ—è¡¨ä¹Ÿä¼šéšä¹‹æ¶ˆå¤±ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯æŒä¹…èŠ‚ç‚¹ã€‚</li><li><strong>æ—¥å¿—ç³»ç»ŸèŠ‚ç‚¹ç›‘å¬ï¼š</strong>å®é™…ç”Ÿäº§è¿è¡Œä¸­ï¼Œæ”¶é›†å™¨æ›´æ”¹çŠ¶æ€èŠ‚ç‚¹çš„é¢‘ç‡å¯èƒ½å¾ˆé«˜ï¼ˆå°äº1ç§’ï¼‰ï¼Œä¸”æ”¶é›†å™¨æ•°é‡ä¼šå¾ˆå¤§ï¼Œæ—¥å¿—ç³»ç»Ÿå¦‚æœè¦ç›‘å¬æ‰€æœ‰èŠ‚ç‚¹å˜åŒ–ï¼Œå¯¹åº”çš„æ•°æ®é‡å¤ªè¿‡åºå¤§ï¼Œæ‰€ä»¥æ—¥å¿—ç³»ç»Ÿå¹¶æ²¡æœ‰å®æ—¶çš„æ¥æ”¶æ¯æ¬¡èŠ‚ç‚¹çŠ¶æ€å˜æ›´ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æ²¡ä»€ä¹ˆç”¨çš„ï¼Œè€Œæ˜¯é‡‡ç”¨<strong>ä¸»åŠ¨è½®è¯¢</strong>çš„æ–¹æ¡ˆï¼Œåªæ˜¯æœ‰ä¸€ç‚¹å»¶æ—¶ã€‚</li></ul><h4 id="ï¼ˆ3ï¼‰åœ¨çº¿äº‘ä¸»æœºç®¡ç†"><a href="#ï¼ˆ3ï¼‰åœ¨çº¿äº‘ä¸»æœºç®¡ç†" class="headerlink" title="ï¼ˆ3ï¼‰åœ¨çº¿äº‘ä¸»æœºç®¡ç†"></a>ï¼ˆ3ï¼‰åœ¨çº¿äº‘ä¸»æœºç®¡ç†</h4><p>é›†ç¾¤æœºå™¨çš„ç›‘æ§ï¼Œå¯¹æœºå™¨çš„çŠ¶æ€å°¤å…¶æ˜¯æœºå™¨åœ¨çº¿ç‡ç»Ÿè®¡æœ‰è¾ƒé«˜è¦æ±‚ï¼Œå¹¶èƒ½å¯¹æœºå™¨å˜æ›´æœ‰å¿«é€Ÿçš„å“åº”ï¼š</p><ol><li>å¦‚ä½•å¿«é€Ÿç»Ÿè®¡å‡ºå½“å‰ç”Ÿäº§ç¯å¢ƒä¸€å…±æœ‰å¤šå°‘å°æœºå™¨ï¼Ÿ</li><li>å¦‚ä½•å¿«é€Ÿè·å–åˆ°æœºå™¨ä¸Šä¸‹çº¿æƒ…å†µï¼Ÿ</li><li>å¦‚ä½•å®æ—¶ç›‘æ§é›†ç¾¤ä¸­æ¯å°ä¸»æœºçš„è¿è¡Œæ—¶çŠ¶æ€ï¼Ÿ</li></ol><ul><li><p><strong>æœºå™¨ä¸Šä¸‹çº¿ï¼š</strong>æ–°å¢æœºå™¨æ—¶ï¼Œå…ˆå°†æŒ‡å®šçš„Agentéƒ¨ç½²åˆ°æœºå™¨ï¼Œéƒ¨ç½²å¯åŠ¨åå‘ZKæŒ‡å®šèŠ‚ç‚¹è¿›è¡Œæ³¨å†Œï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶å­èŠ‚ç‚¹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010111.png"></p><p>åˆ›å»ºå®Œå­èŠ‚ç‚¹åï¼Œå¯¹ <code>/XAE/machines</code> èŠ‚ç‚¹å…³æ³¨çš„ç›‘æ§ä¸­å¿ƒä¼šæ”¶åˆ°â€œå­èŠ‚ç‚¹å˜æ›´â€çš„äº‹ä»¶ï¼Œå³ä¸Šçº¿é€šçŸ¥ï¼›åŒç†ä¹Ÿå¯ä»¥æ”¶åˆ°ä¸‹çº¿é€šçŸ¥ã€‚</p></li><li><p><strong>æœºå™¨ç›‘æ§ï¼š</strong>è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒAgentä¼šå®šæ—¶å°†ä¸»æœºçš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯å†™å…¥ZKå¯¹åº”ä¸»æœºèŠ‚ç‚¹ï¼Œç›‘æ§ä¸­å¿ƒé€šè¿‡è®¢é˜…è¿™äº›èŠ‚ç‚¹æ•°æ®å˜æ›´æ¥è·å–è¿è¡Œæ—¶ä¿¡æ¯ã€‚</p></li></ul><h3 id="1-6-Masteré€‰ä¸¾"><a href="#1-6-Masteré€‰ä¸¾" class="headerlink" title="1.6 Masteré€‰ä¸¾"></a>1.6 Masteré€‰ä¸¾</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸éœ€è¦MasterèŠ‚ç‚¹æ¥åè°ƒå…¶ä»–å•å…ƒï¼Œå¦‚ä¸€äº›è¯»å†™åˆ†ç¦»çš„åº”ç”¨åœºæ™¯ï¼Œå®¢æˆ·ç«¯çš„å†™è¯·æ±‚å¾€å¾€æ˜¯ç”±Masteræ¥å¤„ç†çš„ã€‚</p><p>åˆ†å¸ƒå¼ç¯å¢ƒå¸¸è§åœºæ™¯ï¼šé›†ç¾¤ä¸­æ‰€æœ‰ç³»ç»Ÿå•å…ƒéœ€è¦å¯¹å‰ç«¯ä¸šåŠ¡æä¾›æ•°æ®ï¼Œå¦‚ä¸€ä¸ªç»è¿‡ä¸€ç³»åˆ—æµ·é‡æ•°æ®å¤„ç†è®¡ç®—å¾—åˆ°çš„å•†å“IDï¼Œè®©ä¸€å°æœºå™¨è®¡ç®—åå…±äº«ç»™å…¶ä»–æœºå™¨æ¥å‡å°‘é‡å¤åŠ³åŠ¨ï¼Œç³»ç»Ÿå¯ä»¥åˆ†ä¸ºå®¢æˆ·ç«¯é›†ç¾¤ã€åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿã€æµ·é‡æ•°æ®å¤„ç†æ€»çº¿å’ŒZooKeeperå››ä¸ªéƒ¨åˆ†ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010112.png"></p><p>Clienté›†ç¾¤æ¯å°å®šæ—¶é€šè¿‡ZKå®ŒæˆMasteré€‰ä¸¾ï¼Œé€‰å‡ºçš„Masterè¿›è¡Œä¸€ç³»åˆ—æµ·é‡æ•°æ®å¤„ç†å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œå°†å…¶æ”¾ç½®åœ¨ä¸€ä¸ªå†…å­˜/æ•°æ®åº“ä¸­ï¼Œå¹¶é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯æ¥è·å–ã€‚</p><p>æˆ‘ä»¬å¯¹Masteré€‰ä¸¾çš„éœ€æ±‚æ˜¯ä»æ‰€æœ‰æœºå™¨ä¸­é€‰æ‹©ä¸€å°æœºå™¨ï¼Œé€šå¸¸æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨æ•°æ®åº“ä¸»é”®æ¥å®ç°ï¼šæ‰€æœ‰æœºå™¨æ’å…¥ä¸€æ¡ç›¸åŒä¸»é”®çš„è®°å½•ï¼ŒæˆåŠŸçš„ä¸€å°ä¸ºMasterã€‚ä½†è¿™ç§æ–¹æ¡ˆæ²¡æ³•åº”å¯¹MasteræŒ‚æ‰çš„é—®é¢˜ï¼Œå› ä¸ºå…³ç³»å‹æ•°æ®åº“æ— æ³•é€šçŸ¥è¿™ä¸€äº‹ä»¶ã€‚</p><p>åˆ©ç”¨ZooKeeperçš„å¼ºä¸€è‡´æ€§ï¼Œæˆ‘ä»¬åœ¨åˆ†å¸ƒå¼é«˜å¹¶å‘åœºæ™¯ä¸‹å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨å±€å”¯ä¸€çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®ç°ï¼š<strong>æ¯å¤©æ‰€æœ‰å®¢æˆ·ç«¯å®šæ—¶åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ <code>/master_election/2013-09-20/binding</code> ï¼Œåªæœ‰ä¸€ä¸ªä¼šæˆåŠŸåˆ›å»ºï¼Œå…¶å°±æˆä¸ºäº†Masterï¼Œæ²¡æœ‰åˆ›å»ºæˆåŠŸçš„å†æ¬¡èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ªèŠ‚ç‚¹å˜æ›´çš„Watcherï¼Œç›‘æ§å½“å‰çš„Masteræœºå™¨æ˜¯å¦å­˜æ´»ï¼Œä¸€æ—¦æŒ‚æ‰å°±é‡æ–°è¿›è¡Œé€‰ä¸¾</strong>ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010113.png"></p><h3 id="1-7-åˆ†å¸ƒå¼é”"><a href="#1-7-åˆ†å¸ƒå¼é”" class="headerlink" title="1.7 åˆ†å¸ƒå¼é”"></a>1.7 åˆ†å¸ƒå¼é”</h3><p>ä¸åŒä¸»æœºå…±äº«ä¸€ç»„èµ„æºï¼Œéœ€è¦äº’æ–¥æ‰‹æ®µé˜²æ­¢å½¼æ­¤çš„å¹²æ‰°æ¥ä¿è¯ä¸€è‡´æ€§ï¼Œæ­¤æ—¶ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚å…³ç³»å‹æ•°æ®åº“æœ¬èº«å…·æœ‰æ’ä»–æ€§ï¼Œæ¥å®ç°ä¸åŒè¿›ç¨‹çš„äº’æ–¥ï¼Œä½†å®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚</p><h4 id="ï¼ˆ1ï¼‰æ’ä»–é”"><a href="#ï¼ˆ1ï¼‰æ’ä»–é”" class="headerlink" title="ï¼ˆ1ï¼‰æ’ä»–é”"></a>ï¼ˆ1ï¼‰æ’ä»–é”</h4><p>æ’ä»–é”ï¼ˆExclusive Locksï¼Œå³Xé”ï¼‰åˆå«å†™é”æˆ–ç‹¬å é”ï¼Œå½“äº‹åŠ¡Aå¯¹æ•°æ®å¯¹è±¡OåŠ æ’ä»–é”ï¼Œåœ¨æŒæœ‰é”æœŸé—´åªå…è®¸äº‹åŠ¡Aå¯¹Oè¿›è¡Œè¯»å–å’Œæ›´æ–°æ“ä½œã€‚</p><ul><li><p><strong>å®šä¹‰é”ï¼š</strong>Javaå¸¸ç”¨ synchronized æˆ– ReentrantLock æ¥å®šä¹‰é”ï¼ŒZKæ²¡æœ‰ç±»ä¼¼çš„APIæ¥ä½¿ç”¨ï¼Œè€Œæ˜¯ç›´æ¥ç”¨ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æ¥è¡¨ç¤ºä¸€ä¸ªé”ï¼ˆå¦‚ <code>/exclusive_lock/lock</code> ï¼‰</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010114.png"></p></li><li><p><strong>è·å–é”ï¼š</strong>å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨ <code>create()</code> æ¥å£åœ¨ <code>/exclusive_lock</code> èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸´æ—¶å­èŠ‚ç‚¹ï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥åˆ›å»ºæˆåŠŸï¼Œå³è·å–åˆ°äº†é”ï¼Œæ²¡æœ‰è·å–åˆ°çš„å®¢æˆ·ç«¯åœ¨ <code>/exclusive_lock</code> èŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªå­èŠ‚ç‚¹å˜æ›´çš„Watcherç›‘å¬ã€‚</p></li><li><p><strong>é‡Šæ”¾é”ï¼š</strong>å› ä¸ºé”æ˜¯ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¼šé‡Šæ”¾é”ï¼š</p><ul><li>å½“å‰è·å–é”çš„å®¢æˆ·ç«¯é›†ç¾¤å®•æœºï¼ŒZKä¸Šæ­¤ä¸´æ—¶èŠ‚ç‚¹ä¼šè¢«ç§»é™¤ã€‚</li><li>æ­£å¸¸æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨åˆ é™¤è‡ªå·±åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹ã€‚</li></ul><p>èŠ‚ç‚¹åˆ é™¤åï¼Œå…¶ä»–å®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥å†æ¬¡å‘èµ·åˆ†å¸ƒå¼é”çš„è·å–ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010115.png"></p></li></ul><h4 id="ï¼ˆ2ï¼‰å…±äº«é”"><a href="#ï¼ˆ2ï¼‰å…±äº«é”" class="headerlink" title="ï¼ˆ2ï¼‰å…±äº«é”"></a>ï¼ˆ2ï¼‰å…±äº«é”</h4><p>å…±äº«é”ï¼ˆShared Locksï¼Œç®€ç§°Sé”ï¼‰åˆå«è¯»é”ï¼Œäº‹åŠ¡Aå¯¹æ•°æ®å¯¹è±¡OåŠ ä¸Šå…±äº«é”ï¼Œå…¶ä»–äº‹åŠ¡åªèƒ½å¯¹Oè¿›è¡Œè¯»æ“ä½œå’ŒåŠ å…±äº«é”ï¼Œç›´åˆ°æ‰€æœ‰å…±äº«é”é‡Šæ”¾ã€‚</p><ul><li><p><strong>å®šä¹‰é”ï¼š</strong>ç›´æ¥ç”¨ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æ¥è¡¨ç¤ºä¸€ä¸ªé”ï¼ˆå¦‚ <code>/shared_lock/192.168.0.1-R-000000001</code> ï¼‰</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010116.png"></p></li><li><p><strong>è·å–é”ï¼š</strong>å®¢æˆ·ç«¯åˆ° <code>/shared_lock</code> èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œè‹¥å½“å‰æ˜¯è¯»è¯·æ±‚ï¼Œå°±åˆ›å»ºRç±»èŠ‚ç‚¹ï¼›å¦‚æœæ˜¯å†™è¯·æ±‚ï¼Œå°±åˆ›å»ºWç±»èŠ‚ç‚¹ã€‚</p></li><li><p><strong>åˆ¤æ–­è¯»å†™é¡ºåºï¼š</strong></p><ol><li>åˆ›å»ºå®ŒèŠ‚ç‚¹åï¼Œè·å– <code>/shared_lock</code> èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå¹¶æ³¨å†ŒWatcherå˜æ›´ç›‘å¬ã€‚</li><li>ç¡®å®šè‡ªå·±çš„èŠ‚ç‚¹åºå·åœ¨æ‰€æœ‰å­èŠ‚ç‚¹ä¸­çš„é¡ºåºã€‚</li><li>è¯»å†™ä¸¤ç§æƒ…å†µï¼š<ul><li>è¯»è¯·æ±‚ï¼šå¦‚æœæ²¡æœ‰æ¯”è‡ªå·±åºå·å°çš„å­èŠ‚ç‚¹ï¼Œæˆ–æ˜¯å°çš„èŠ‚ç‚¹éƒ½æ˜¯è¯»è¯·æ±‚ï¼Œè¡¨ç¤ºè‡ªå·±å·²ç»è·å–åˆ°å…±äº«é”ï¼ŒåŒæ—¶å¼€å§‹æ‰§è¡Œè¯»å–é€»è¾‘ã€‚</li><li>å†™è¯·æ±‚ï¼šå¦‚æœè‡ªå·±ä¸æ˜¯åºå·æœ€å°çš„å­èŠ‚ç‚¹ï¼Œå°±è¦è¿›å…¥ç­‰å¾…ã€‚</li></ul></li><li>æ¥æ”¶åˆ°Watcheré€šçŸ¥åï¼Œé‡å¤æ­¥éª¤1ã€‚</li></ol></li><li><p><strong>é‡Šæ”¾é”ï¼š</strong>æµç¨‹åŒæ’ä»–é”ã€‚</p><p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010117.png"></p></li></ul><h5 id="ç¾Šç¾¤æ•ˆåº”"><a href="#ç¾Šç¾¤æ•ˆåº”" class="headerlink" title="ç¾Šç¾¤æ•ˆåº”"></a>ç¾Šç¾¤æ•ˆåº”</h5><p>ä¸Šè¿°å…±äº«é”å®ç°å¯ä»¥æ»¡è¶³æœºå™¨è§„æ¨¡è¾ƒå°çš„åœºæ™¯ï¼ˆ10å°ä»¥å†…ï¼‰ï¼Œå½“æœºå™¨è§„æ¨¡è¾ƒå¤§æ—¶ï¼Œé’ˆå¯¹åˆ¤æ–­è¯»å†™é¡ºåºæ­¥éª¤ç»“åˆä¸‹å›¾å®ä¾‹ï¼ŒçŒœæƒ³å®é™…è¿è¡Œçš„æƒ…å†µã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010118.png"></p><p>å®é™…è¿è¡Œï¼š</p><ol><li>192.168.0.1æœºå™¨é¦–å…ˆè¿›è¡Œè¯»æ“ä½œï¼Œå®Œæˆåå°†é¦–ä¸ªå­èŠ‚ç‚¹åˆ é™¤ã€‚</li><li>ä½™ä¸‹4å°æœºå™¨å‡å—åˆ°èŠ‚ç‚¹ç§»é™¤çš„é€šçŸ¥ï¼Œé‡æ–°ä» <code>/shared_lock</code> èŠ‚ç‚¹ä¸Šè·å–ä¸€ä»½æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨ã€‚</li><li>æ¯ä¸ªæœºå™¨åˆ¤æ–­è‡ªå·±çš„è¯»å†™é¡ºåºï¼Œå…¶ä¸­192.168.0.2è¿™å°æœºå™¨æ£€æµ‹åˆ°è‡ªå·±å·²ç»æ˜¯æœ€å°æœºå™¨äº†ï¼Œäºæ˜¯å¼€å§‹è¯»æ“ä½œï¼Œè€Œå…¶ä»–æœºå™¨å‘ç°æœªè½®åˆ°è‡ªå·±å°±ç»§ç»­ç­‰å¾…ã€‚</li><li>ç»§ç»­â€¦.</li></ol><p>å…¶ä¸­æ­¥éª¤3ï¼Œè¯¥é€šçŸ¥å‘ç»™äº†æ‰€æœ‰æœºå™¨ï¼Œä½†å®é™…ä¸Šåªå¯¹192.168.0.2è¿™å°æœºå™¨æœ‰ç”¨ï¼Œæ•´ä¸ªæµç¨‹å¤§é‡çš„Watcheré€šçŸ¥å’Œå­èŠ‚ç‚¹åˆ—è¡¨è·å–æ“ä½œé‡å¤è¿è¡Œï¼Œå¤§éƒ¨åˆ†æœºå™¨åˆ¤æ–­çš„ç»“æœéƒ½æ˜¯éœ€è¦ç»§ç»­ç­‰å¾…ã€‚<strong>åœ¨é›†ç¾¤è§„æ¨¡è¾ƒå¤§çš„åœºæ™¯ä¸‹ï¼Œä¸ä»…ä¼šå¯¹ZooKeeperæœåŠ¡å™¨é€ æˆå·¨å¤§çš„æ€§èƒ½å½±å“å’Œç½‘ç»œå†²å‡»</strong>ï¼Œæ›´ä¸ºä¸¥é‡çš„æ˜¯ï¼Œ<strong>è‹¥åŒä¸€æ—¶é—´æœ‰å¤šä¸ªèŠ‚ç‚¹å¯¹åº”çš„å®¢æˆ·ç«¯å®Œæˆäº‹åŠ¡æˆ–æ˜¯äº‹åŠ¡ä¸­æ–­å¼•èµ·èŠ‚ç‚¹æ¶ˆå¤±ï¼ŒZKæœåŠ¡å™¨å°±ä¼šåœ¨çŸ­æ—¶é—´å†…å‘å…¶ä½™å®¢æˆ·ç«¯å‘é€å¤§é‡çš„äº‹ä»¶é€šçŸ¥â€”å³ç¾Šç¾¤æ•ˆåº”</strong>ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç»æµå­¦é‡Œç»å¸¸ç”¨â€œç¾Šç¾¤æ•ˆåº”â€æ¥æè¿°ç»æµä¸ªä½“çš„ä»ä¼—è·Ÿé£å¿ƒç†ã€‚â€œç¾Šç¾¤æ•ˆåº”â€å°±æ˜¯æ¯”å–»äººéƒ½æœ‰ä¸€ç§ä»ä¼—å¿ƒç†ï¼Œä»ä¼—å¿ƒç†å¾ˆå®¹æ˜“å¯¼è‡´ç›²ä»ï¼Œè€Œç›²ä»å¾€å¾€ä¼šé™·å…¥éª—å±€æˆ–é­åˆ°å¤±è´¥ã€‚</span><br></pre></td></tr></table></figure><p>äº§ç”Ÿé—®é¢˜çš„åŸå› åœ¨äºæ²¡æœ‰æ‰¾å‡†å®¢æˆ·ç«¯çœŸæ­£çš„å…³æ³¨ç‚¹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åªéœ€å…³æ³¨æ¯”è‡ªå·±å°çš„é‚£ä¸€ä¸ªèŠ‚ç‚¹çš„å˜æ›´æƒ…å†µå³å¯ï¼š</p><ol><li>å®¢æˆ·ç«¯è°ƒç”¨ <code>create()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªç±»ä¼¼äº <code>/shared_lock/[hostname]-è¯·æ±‚ç±»å‹-åºå·</code> çš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚</li><li>å®¢æˆ·ç«¯è°ƒç”¨ <code>getChildren()</code> æ¥å£æ¥è·å–æ‰€æœ‰å·²ç»åˆ›å»ºçš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œè¿™é‡Œä¸å†æ³¨å†Œä»»ä½•Watcherã€‚</li><li>å¦‚æœæ— æ³•è·å–å…±äº«é”ï¼Œå°±è°ƒç”¨ <code>exist()</code> æ¥å¯¹æ¯”è‡ªå·±å°çš„é‚£ä¸ªèŠ‚ç‚¹æ³¨å†ŒWatcherï¼Œè¯»å†™è¯·æ±‚æƒ…å†µä¸ä¸€æ ·ï¼š<ul><li>è¯»è¯·æ±‚ï¼šå‘æ¯”è‡ªå·±åºå·å°çš„æœ€åä¸€ä¸ªå†™è¯·æ±‚èŠ‚ç‚¹æ³¨å†Œ</li><li>å†™è¯·æ±‚ï¼šå‘æ¯”è‡ªå·±åºå·å°çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹æ³¨å†Œ</li></ul></li><li>ç­‰å¾…Watcheré€šçŸ¥ï¼Œç»§ç»­è¿›å…¥æ­¥éª¤2ã€‚</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010119.png"></p><h3 id="1-8-åˆ†å¸ƒå¼é˜Ÿåˆ—"><a href="#1-8-åˆ†å¸ƒå¼é˜Ÿåˆ—" class="headerlink" title="1.8 åˆ†å¸ƒå¼é˜Ÿåˆ—"></a>1.8 åˆ†å¸ƒå¼é˜Ÿåˆ—</h3><p>åˆ†å¸ƒå¼é˜Ÿåˆ—å¦‚å¸¸è§çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼šActiveMQã€Metamorphosisã€Kafkaå’ŒHornetQç­‰ã€‚åˆ†ä¸ºä¸¤å¤§ç±»ï¼šå¸¸è§„çš„å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ã€ç­‰åˆ°é˜Ÿåˆ—å…ƒç´ é›†èšåæ‰ç»Ÿä¸€å®‰æ’çš„Barrieræ¨¡å‹ã€‚</p><h4 id="ï¼ˆ1ï¼‰FIFO-å…ˆå…¥å…ˆå‡º"><a href="#ï¼ˆ1ï¼‰FIFO-å…ˆå…¥å…ˆå‡º" class="headerlink" title="ï¼ˆ1ï¼‰FIFO-å…ˆå…¥å…ˆå‡º"></a>ï¼ˆ1ï¼‰FIFO-å…ˆå…¥å…ˆå‡º</h4><p>ä½¿ç”¨ZooKeeperå®ç°FIFOé˜Ÿåˆ—ç±»ä¼¼äºå…¨å†™çš„å…±äº«é”æ¨¡å‹ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯åˆ° <code>/queue_fifo</code> èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010120.png"></p><p>åˆ›å»ºå®ŒèŠ‚ç‚¹åï¼Œç¡®å®šæ‰§è¡Œé¡ºåºçš„æ­¥éª¤ï¼š</p><ol><li>é€šè¿‡è°ƒç”¨ <code>getChildren()</code> æ¥å£æ¥è·å– <code>/queue_fifo</code> èŠ‚ç‚¹ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è·å–é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚</li><li>ç¡®å®šè‡ªå·±çš„èŠ‚ç‚¹åºå·åœ¨æ‰€æœ‰å­èŠ‚ç‚¹ä¸­çš„é¡ºåºã€‚</li><li>å¦‚æœè‡ªå·±ä¸æ˜¯åºå·æœ€å°çš„å­èŠ‚ç‚¹ï¼Œè¿›å…¥ç­‰å¾…ï¼ŒåŒæ—¶å‘æ¯”è‡ªå·±åºå·å°çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹æ³¨å†ŒWatcherç›‘å¬ã€‚</li><li>æ¥æ”¶åˆ°Watcheré€šçŸ¥ï¼Œé‡å¤æ­¥éª¤1ã€‚</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010121.png"></p><h4 id="ï¼ˆ2ï¼‰Barrierï¼šåˆ†å¸ƒå¼å±éšœ"><a href="#ï¼ˆ2ï¼‰Barrierï¼šåˆ†å¸ƒå¼å±éšœ" class="headerlink" title="ï¼ˆ2ï¼‰Barrierï¼šåˆ†å¸ƒå¼å±éšœ"></a>ï¼ˆ2ï¼‰Barrierï¼šåˆ†å¸ƒå¼å±éšœ</h4><p>BarrieråŸæ„éšœç¢ç‰©ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æŒ‡ç³»ç»Ÿé—´çš„ä¸€ä¸ªåè°ƒæ¡ä»¶ï¼Œè§„å®šä¸€ä¸ªé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»éƒ½é›†èšåæ‰èƒ½ç»Ÿä¸€è¿›è¡Œå®‰æ’ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚</p><p>å¼€å§‹æ—¶ï¼Œ<code>/queue_barrier</code> èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„é»˜è®¤èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶èŠ‚ç‚¹çš„æ•°æ®å†…å®¹èµ‹å€¼ä¸ºä¸€ä¸ªæ•°å­—næ¥ä»£è¡¨Barrierå€¼ï¼Œå½“å­èŠ‚ç‚¹æ•°è¾¾åˆ°nåæ‰èƒ½æ‰“å¼€Barrierï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½è¦åˆ°æ­¤èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010122.png"></p><p>åˆ›å»ºå®ŒèŠ‚ç‚¹åï¼Œç¡®å®šæ‰§è¡Œé¡ºåºçš„æ­¥éª¤ï¼š</p><ol><li>é€šè¿‡è°ƒç”¨ <code>getData()</code> æ¥å£è·å– <code>/queue_barrier</code> èŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼š10ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>getChildren()</code> æ¥å£è·å– <code>/queue_barrier</code> èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œå³è·å–é˜Ÿåˆ—ä¸­æ‰€æœ‰å…ƒç´ ï¼ŒåŒæ—¶æ³¨å†Œå¯¹å­èŠ‚ç‚¹åˆ—è¡¨å˜æ›´çš„Watcherç›‘å¬ã€‚</li><li>ç»Ÿè®¡å­èŠ‚ç‚¹çš„ä¸ªæ•°ã€‚</li><li>å¦‚æœå­èŠ‚ç‚¹ä¸ªæ•°ä¸è¶³10ä¸ªï¼Œéœ€è¦è¿›å…¥ç­‰å¾…ã€‚</li><li>æ¥æ”¶åˆ°Watcheré€šçŸ¥åï¼Œé‡å¤æ­¥éª¤2ã€‚</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010123.png"></p><h2 id="äºŒ-å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨"><a href="#äºŒ-å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨" class="headerlink" title="äºŒ. å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨"></a>äºŒ. å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨</h2><p>ZKå› ä¸ºä¾¿æ·çš„ä½¿ç”¨æ–¹å¼ã€å“è¶Šçš„è¿è¡Œæ€§èƒ½å’Œè‰¯å¥½çš„ç¨³å®šæ€§ï¼Œå·²ç»è¢«å¹¿æ³›çš„åº”ç”¨åœ¨è¶Šæ¥è¶Šå¤šçš„å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”¨æ¥è§£å†³å¦‚é…ç½®ç®¡ç†ã€åˆ†å¸ƒå¼é€šçŸ¥/åè°ƒã€é›†ç¾¤ç®¡ç†å’ŒMasteré€‰ä¸¾ç­‰ä¸€ç³»åˆ—åˆ†å¸ƒå¼é—®é¢˜ã€‚</p><h3 id="2-1-Hadoop"><a href="#2-1-Hadoop" class="headerlink" title="2.1 Hadoop"></a>2.1 Hadoop</h3><p>Hadoopæ˜¯Apacheå¼€æºçš„ä¸€ä¸ªå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼Œå®šä¹‰äº†ä¸€ç§èƒ½å¤Ÿå¼€å‘å’Œè¿è¡Œå¤„ç†æµ·é‡æ•°æ®çš„è½¯ä»¶è§„èŒƒï¼Œç”¨æ¥å®ç°ä¸€ä¸ªåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­å¯¹æµ·é‡æ•°æ®è¿›è¡Œåˆ†å¸ƒå¼è®¡ç®—çš„è½¯ä»¶å¹³å°ã€‚<strong>æ ¸å¿ƒæ˜¯HDFSå’ŒMapReduceï¼Œåˆ†åˆ«æä¾›äº†å¯¹æµ·é‡æ•°æ®çš„å­˜å‚¨å’Œè®¡ç®—èƒ½åŠ›</strong>ã€‚0.23.0ç‰ˆæœ¬ååˆå¼•å…¥å…¨æ–°ä¸€ä»£MapReduceæ¡†æ¶YARNã€‚</p><p>åœ¨Hadoopä¸­ï¼ŒZooKeeperæ³¨æ„ç”¨äºå®ç°HAï¼ˆHigh Availabilityï¼Œé«˜å¯ç”¨ï¼‰é›†ä¸­äºHadoop Commonä¸­çš„HAæ¨¡å—ï¼ŒHDFSçš„NameNodeä¸YARNçš„ResourceManageréƒ½æ˜¯åŸºäºæ­¤HAæ¨¡å—å®ç°è‡ªå·±çš„HAåŠŸèƒ½ï¼ŒYARNè¿˜ç”¨ZooKeeperæ¥å­˜å‚¨åº”ç”¨çš„è¿è¡ŒçŠ¶æ€ã€‚</p><h4 id="ï¼ˆ1ï¼‰YARN"><a href="#ï¼ˆ1ï¼‰YARN" class="headerlink" title="ï¼ˆ1ï¼‰YARN"></a>ï¼ˆ1ï¼‰YARN</h4><p>YARNæ˜¯Hadoopä¸ºäº†æé«˜è®¡ç®—èŠ‚ç‚¹Masterçš„æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¸ºäº†æ”¯æŒå¤šè®¡ç®—æ¨¡å‹å’Œæä¾›èµ„æºçš„ç»†ç²’åº¦è°ƒåº¦è€Œå¼•å…¥çš„å…¨æ–°ä¸€ä»£åˆ†å¸ƒå¼è°ƒåº¦æ¡†æ¶ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010124.png"></p><p>YARNç”±å››éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>ResourceManagerï¼ˆRMï¼‰ï¼š</strong>æ ¸å¿ƒæ¨¡å—ï¼Œå…¨å±€èµ„æºç®¡ç†å™¨ï¼Œè´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„èµ„æºç®¡ç†å’Œåˆ†é…ï¼ŒåŒæ—¶æ¥æ”¶å„ä¸ªèŠ‚ç‚¹ï¼ˆNodeManagerï¼‰çš„èµ„æºæ±‡æŠ¥ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥åˆ†é…ç»™å„ä¸ªåº”ç”¨ç¨‹åºï¼ˆApplicationMasterï¼‰ã€‚å…¶å†…éƒ¨ç»´æŠ¤äº†å„ä¸ªåº”ç”¨ç¨‹åºçš„ApplicationMasterä¿¡æ¯ã€NodeManagerä¿¡æ¯ä»¥åŠèµ„æºä½¿ç”¨ä¿¡æ¯ç­‰ã€‚</li><li><strong>NodeManagerï¼ˆNMï¼‰</strong></li><li><strong>ApplicationMasterï¼ˆAMï¼‰</strong></li><li><strong>Container</strong></li></ul><h4 id="ï¼ˆ2ï¼‰ResourceManagerå•ç‚¹é—®é¢˜"><a href="#ï¼ˆ2ï¼‰ResourceManagerå•ç‚¹é—®é¢˜" class="headerlink" title="ï¼ˆ2ï¼‰ResourceManagerå•ç‚¹é—®é¢˜"></a>ï¼ˆ2ï¼‰ResourceManagerå•ç‚¹é—®é¢˜</h4><p>ä¸Šè¿°æ¶æ„å¯ä»¥æ˜æ˜¾çœ‹å‡ºå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šResourceManagerå•ç‚¹é—®é¢˜ã€‚YARNè®¾è®¡äº†ä¸€å¥— <strong>Active/Standby æ¨¡å¼çš„ ResourceManager HA æ¶æ„</strong>ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010125.png"></p><p>è¿è¡ŒæœŸé—´æœ‰å¤šä¸ªRMå¹¶å­˜ï¼Œåªæœ‰ä¸€ä¸ªå¤„äºActiveçŠ¶æ€ï¼Œå¦å¤–åˆ™å¤„äºStandbyçŠ¶æ€ï¼Œå½“ActiveèŠ‚ç‚¹æ— æ³•æ­£å¸¸å·¥ä½œæ—¶ï¼Œå…¶ä½™èŠ‚ç‚¹é€šè¿‡ç«äº‰é€‰ä¸¾å‡ºæ–°çš„ActiveèŠ‚ç‚¹ã€‚</p><p>YARNä½¿ç”¨åŸºäºZooKeeperå®ç°çš„ActiveStandbyElectorç»„ä»¶æ¥ç¡®å®šRMçš„çŠ¶æ€ï¼Œä»è€Œå®ç°å¤šä¸ªRMçš„ä¸»å¤‡åˆ‡æ¢ï¼š</p><ol><li><strong>åˆ›å»ºé”èŠ‚ç‚¹ï¼š</strong>ZKä¸Šä¼šæœ‰ä¸€ä¸ªç±»ä¼¼äº <code>/yarn-leader-election/pseudo-yarn-rm-cluster</code> çš„é”èŠ‚ç‚¹ï¼Œæ‰€æœ‰RMåœ¨å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šå»ç«äº‰å†™ä¸€ä¸ªLockå­èŠ‚ç‚¹ <code>../ActiveStandbyElectorLock</code> ï¼Œè¯¥å­èŠ‚ç‚¹ç±»å‹æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸçš„RMåˆ‡æ¢ä¸ºActiveçŠ¶æ€ï¼Œæ²¡æœ‰çš„åˆ‡æ¢ä¸ºStandbyçŠ¶æ€ã€‚</li><li><strong>æ³¨å†ŒWatcherç›‘å¬ï¼š</strong>StandbyçŠ¶æ€çš„RMå‘ <code>../ActiveStandbyElectorLock</code> èŠ‚ç‚¹æ³¨å†Œä¸€ä¸ªWatcherç›‘å¬èŠ‚ç‚¹å˜æ›´ã€‚</li><li><strong>ä¸»å¤‡åˆ‡æ¢ï¼š</strong>å½“ActiveçŠ¶æ€çš„èŠ‚ç‚¹å‡ºç°å¼‚å¸¸æƒ…å†µï¼Œå…¶åˆ›å»ºçš„LockèŠ‚ç‚¹ä¼šéšä¹‹åˆ é™¤ï¼Œæ‰€æœ‰StandbyçŠ¶æ€çš„RMæ”¶åˆ°é€šçŸ¥åé‡å¤æ­¥éª¤1æ“ä½œã€‚</li></ol><p>HDFSä¸­çš„NameNodeå’ŒResourceManageréƒ½ä½¿ç”¨è¯¥ç»„ä»¶æ¥å®ç°å„è‡ªçš„HAã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010126.png"></p><h4 id="ï¼ˆ3ï¼‰Fencingéš”ç¦»"><a href="#ï¼ˆ3ï¼‰Fencingéš”ç¦»" class="headerlink" title="ï¼ˆ3ï¼‰Fencingéš”ç¦»"></a>ï¼ˆ3ï¼‰Fencingéš”ç¦»</h4><p>åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæœºå™¨ä¼šç”±äºç½‘ç»œé—ªæ–­æˆ–è‡ªèº«è´Ÿè½½è¿‡é«˜ï¼ˆGCå ç”¨æ—¶é—´è¿‡é•¿æˆ–CPUè´Ÿè½½è¿‡é«˜ï¼‰å¯¼è‡´æ— æ³•æ­£å¸¸çš„å¯¹å¤–è¿›è¡ŒåŠæ—¶å“åº”ï¼Œå³â€œ<strong>å‡æ­»</strong>â€çš„æƒ…å†µã€‚å½“ActiveçŠ¶æ€çš„RM1æœºå™¨å‘ç”Ÿå‡æ­»æƒ…å†µï¼Œä¸»å¤‡åˆ‡æ¢åRM2æˆä¸ºActiveçŠ¶æ€ï¼Œè€ŒRM1æ¢å¤æ­£å¸¸åä¾ç„¶ä¼šè®¤ä¸ºè‡ªå·±å¤„äºActiveçŠ¶æ€ï¼Œå³<strong>åˆ†å¸ƒå¼è„‘è£‚ç°è±¡</strong>ï¼ˆBrain-Splitï¼‰ã€‚</p><p>Fencingæœºåˆ¶åˆ©ç”¨ZKæ•°æ®èŠ‚ç‚¹çš„ACLæƒé™æ§åˆ¶æœºåˆ¶æ¥å®ç°ä¸åŒRMä¹‹é—´çš„éš”ç¦»ï¼Œå¤šä¸ªRMä¹‹é—´é€šè¿‡ç«äº‰åˆ›å»ºé”èŠ‚ç‚¹æ¥å®ç°ä¸»å¤‡çŠ¶æ€çš„ç¡®å®šï¼Œæ”¹è¿›ä¸ºåˆ›å»ºçš„æ ¹èŠ‚ç‚¹å¿…é¡»æºå¸¦ZKçš„ACLä¿¡æ¯ï¼Œç›®çš„æ˜¯ä¸ºäº†ç‹¬å è¯¥æ ¹èŠ‚ç‚¹ï¼Œé˜²æ­¢å…¶ä»–RMå¯¹èŠ‚ç‚¹è¿›è¡Œæ›´æ–°ã€‚</p><p>å½“RM1å‡ºç°å‡æ­»åï¼ŒZKä¼šå°†å…¶åˆ›å»ºçš„é”èŠ‚ç‚¹ç§»é™¤ï¼ŒRM2åˆ›å»ºç›¸åº”çš„é”èŠ‚ç‚¹å¹¶åˆ‡æ¢ä¸ºActiveçŠ¶æ€ã€‚RM1æ¢å¤ä¹‹åä¼šè¯•å›¾æ›´æ–°ZKçš„ç›¸å…³æ•°æ®ï¼Œä½†å‘ç°æ²¡æœ‰æƒé™ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯è‡ªå·±åˆ›å»ºçš„ï¼Œäºæ˜¯è‡ªåŠ¨åˆ‡æ¢å›StandbyçŠ¶æ€ã€‚</p><h4 id="ï¼ˆ4ï¼‰ResourceManagerçŠ¶æ€å­˜å‚¨"><a href="#ï¼ˆ4ï¼‰ResourceManagerçŠ¶æ€å­˜å‚¨" class="headerlink" title="ï¼ˆ4ï¼‰ResourceManagerçŠ¶æ€å­˜å‚¨"></a>ï¼ˆ4ï¼‰ResourceManagerçŠ¶æ€å­˜å‚¨</h4><p>åœ¨ResourceManagerä¸­ï¼ŒRMStateStoreèƒ½å¤Ÿå­˜å‚¨ä¸€äº›RMçš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬Applicationå’Œå®ƒä»¬çš„Attemptsä¿¡æ¯ã€Delegation TokenåŠVersion Informationç­‰ï¼Œå¤§éƒ¨åˆ†çŠ¶æ€ä¿¡æ¯å› ä¸ºå¾ˆå®¹æ˜“ä»ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸­é‡æ„å‡ºæ¥æ‰€ä»¥ä¸éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼Œæ‰€ä»¥å­˜å‚¨çš„è®¾è®¡æ–¹æ¡ˆæœ‰ï¼š</p><ul><li>åŸºäºå†…å­˜å®ç°ï¼Œä¸€èˆ¬ç”¨äºæ—¥å¸¸å¼€å‘æµ‹è¯•ã€‚</li><li>åŸºäºæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œå¦‚HDFSã€‚</li><li>åŸºäºZooKeeperå®ç°ã€‚</li></ul><p>Hadoopå®˜æ–¹å»ºè®®ä½¿ç”¨ZooKeeperæ¥å®ç°ï¼Œå­˜æ”¾åœ¨ <code>/rmstore</code> èŠ‚ç‚¹ä¸‹ï¼ŒRMAppRootèŠ‚ç‚¹ä¸‹å­˜æ”¾çš„æ˜¯ä¸å„ä¸ªApplicationç›¸å…³çš„ä¿¡æ¯ï¼ŒRMDTSecretManagerRootå­˜æ”¾çš„æ˜¯å®‰å…¨ç›¸å…³çš„Tokenç­‰ä¿¡æ¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010127.png"></p><p>æ¯ä¸ªActiveçŠ¶æ€çš„RMåœ¨åˆå§‹åŒ–é˜¶æ®µä¼šä»ZKä¸Šè¯»å–è¿™äº›çŠ¶æ€ä¿¡æ¯ã€‚</p><h3 id="2-2-HBase"><a href="#2-2-HBase" class="headerlink" title="2.2 HBase"></a>2.2 HBase</h3><p>HBaseï¼Œå³ Hadoop Databaseï¼Œæ˜¯ Google Bigtable çš„å¼€æºå®ç°ï¼ŒåŸºäºHadoopæ–‡ä»¶ç³»ç»Ÿè®¾è®¡çš„é¢å‘æµ·é‡æ•°æ®çš„é«˜å¯é æ€§ã€é«˜æ€§èƒ½ã€é¢å‘åˆ—ã€å¯ä¼¸ç¼©çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚</p><p>ä¸å¤§éƒ¨åˆ†åˆ†å¸ƒå¼NoSQLæ•°æ®åº“ä¸åŒçš„æ˜¯ï¼ŒHBaseé’ˆå¯¹æ•°æ®å†™å…¥å…·æœ‰å¼ºä¸€è‡´æ€§çš„ç‰¹æ€§ï¼Œç”šè‡³åŒ…æ‹¬ç´¢å¼•åˆ—ä¹Ÿå®ç°äº†å¼ºä¸€è‡´æ€§ã€‚</p><p>HBaseåœ¨å®ç°ä¸Šéµå®ˆäº† Google BigTable è®ºæ–‡çš„è®¾è®¡æ€æƒ³ï¼ŒBigTableä½¿ç”¨Chubbyæ¥è´Ÿè´£åˆ†å¸ƒå¼çŠ¶æ€çš„åè°ƒï¼ŒChubbyæ˜¯Googleå®ç°çš„ä¸€ç§åŸºäºPaxosç®—æ³•çš„åˆ†å¸ƒå¼é”æœåŠ¡ï¼ŒHBaseåˆ™é‡‡ç”¨äº†å¼€æºçš„ZooKeeperæœåŠ¡æ¥å®Œæˆå¯¹æ•´ä¸ªç³»ç»Ÿçš„åˆ†å¸ƒå¼åè°ƒå·¥ä½œã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010128.png"></p><h4 id="ï¼ˆ1ï¼‰ç³»ç»Ÿå†—é”™"><a href="#ï¼ˆ1ï¼‰ç³»ç»Ÿå†—é”™" class="headerlink" title="ï¼ˆ1ï¼‰ç³»ç»Ÿå†—é”™"></a>ï¼ˆ1ï¼‰ç³»ç»Ÿå†—é”™</h4><p>å¯åŠ¨æ—¶ï¼Œæ¯ä¸ªRegionServeræœåŠ¡å™¨éƒ½ä¼šåˆ°ZKçš„ <code>/hbase/rs</code> èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªä¿¡æ¯èŠ‚ç‚¹ï¼ˆrsçŠ¶æ€èŠ‚ç‚¹ï¼‰ï¼ŒåŒæ—¶HMasterå¯¹è¿™ä¸ªèŠ‚ç‚¹æ³¨å†Œç›‘å¬ã€‚æŸä¸ªRSæŒ‚æ‰ï¼ŒZKå› ä¸ºä¸€æ®µæ—¶é—´æ— æ³•æ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œè€Œåˆ é™¤æ‰å…¶å¯¹åº”çš„rsçŠ¶æ€èŠ‚ç‚¹ã€‚</p><p>åŒæ—¶HMasteræ”¶åˆ°ZKçš„NodeDeleteé€šçŸ¥ï¼Œä»è€Œæ„ŸçŸ¥åˆ°æŸä¸ªèŠ‚ç‚¹æ–­å¼€ï¼Œå¹¶ç«‹å³å¼€å§‹å†—é”™å·¥ä½œï¼Œå°†è¯¥RSå¤„ç†çš„æ•°æ®åˆ†ç‰‡Regioné‡æ–°è·¯ç”±åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œå¹¶è®°å½•åˆ°Metaä¿¡æ¯ä¸­ä¾›å®¢æˆ·ç«¯æŸ¥è¯¢ã€‚</p><p>HMasterä¸ç›´æ¥é€šè¿‡å¿ƒè·³æœºåˆ¶ç®¡ç†RSçš„çŠ¶æ€ï¼Œå› ä¸ºä¼šéšç€ç³»ç»Ÿå®¹é‡çš„ä¸æ–­å¢åŠ å…¶ç®¡ç†è´Ÿæ‹…ä¼šè¶Šæ¥è¶Šé‡ã€‚</p><h4 id="ï¼ˆ2ï¼‰RootRegionç®¡ç†"><a href="#ï¼ˆ2ï¼‰RootRegionç®¡ç†" class="headerlink" title="ï¼ˆ2ï¼‰RootRegionç®¡ç†"></a>ï¼ˆ2ï¼‰RootRegionç®¡ç†</h4><p>æ•°æ®å­˜å‚¨çš„ä½ç½®ä¿¡æ¯è®°å½•åœ¨å…ƒæ•°æ®åˆ†ç‰‡RootRegionï¼Œæ¯æ¬¡å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚è¦çŸ¥é“æ•°æ®çš„ä½ç½®ï¼Œå…ˆè¦æŸ¥è¯¢RootRegionï¼ˆå­˜å‚¨åœ¨ZKä¸Šçš„ <code>/hbase/root-region-server</code> èŠ‚ç‚¹ï¼‰ï¼ŒRootRegionå‘ç”Ÿå˜åŒ–ï¼Œå¦‚Regionçš„æ‰‹å·¥ç§»åŠ¨ã€Balanceæˆ–RootRegionæ‰€åœ¨æœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼Œèƒ½å¤Ÿé€šè¿‡ZKæ¥æ„ŸçŸ¥å˜åŒ–å¹¶æ‰§è¡Œå®¹ç¾æªæ–½ï¼Œä»è€Œä¿è¯å®¢æˆ·ç«¯æ€»èƒ½æ‹¿åˆ°æ­£ç¡®çš„RootRegionä¿¡æ¯ã€‚</p><h4 id="ï¼ˆ3ï¼‰RegionçŠ¶æ€ç®¡ç†"><a href="#ï¼ˆ3ï¼‰RegionçŠ¶æ€ç®¡ç†" class="headerlink" title="ï¼ˆ3ï¼‰RegionçŠ¶æ€ç®¡ç†"></a>ï¼ˆ3ï¼‰RegionçŠ¶æ€ç®¡ç†</h4><p>Regionæ˜¯HBaseä¸­æ•°æ®çš„ç‰©ç†åˆ‡ç‰‡ï¼Œæ¯ä¸ªRegionè®°å½•å…¨å±€æ•°æ®çš„ä¸€å°éƒ¨åˆ†ï¼Œä¸åŒRegioné—´æ•°æ®ä¸é‡å¤ã€‚ä½†å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼ŒRegionæ˜¯ä¼šç»å¸¸å› ä¸ºç³»ç»Ÿæ•…éšœã€è´Ÿè½½å‡è¡¡ã€é…ç½®ä¿®æ”¹ã€Regionåˆ†è£‚å’Œåˆå¹¶ç­‰å‘ç”Ÿå˜æ›´ã€‚ä¸€æ—¦Regionç§»åŠ¨å°±ä¼šå°½åŠ›Offlineå’Œé‡æ–°Onlineçš„è¿‡ç¨‹ã€‚</p><p>OfflineæœŸé—´æ•°æ®ä¸èƒ½è¢«è®¿é—®ï¼Œå¹¶ä¸”Regionçš„çŠ¶æ€å˜åŒ–éœ€è¦è®©å…¨å±€çŸ¥æ™“ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æŸäº›äº‹åŠ¡æ€§å¼‚å¸¸ã€‚å¯¹äºHBaseé›†ç¾¤ï¼ŒRegionçš„æ•°é‡å¯èƒ½è¾¾åˆ°10ä¸‡çº§åˆ«ï¼Œæ‰€ä»¥éœ€è¦ä¾èµ–ZKæ¥åšåˆ°ã€‚</p><h4 id="ï¼ˆ4ï¼‰åˆ†å¸ƒå¼SplitLogä»»åŠ¡ç®¡ç†"><a href="#ï¼ˆ4ï¼‰åˆ†å¸ƒå¼SplitLogä»»åŠ¡ç®¡ç†" class="headerlink" title="ï¼ˆ4ï¼‰åˆ†å¸ƒå¼SplitLogä»»åŠ¡ç®¡ç†"></a>ï¼ˆ4ï¼‰åˆ†å¸ƒå¼SplitLogä»»åŠ¡ç®¡ç†</h4><p>æŸå°RegionServeræœåŠ¡å™¨æŒ‚æ‰æ—¶ï¼Œæ€»æœ‰ä¸€éƒ¨åˆ†æ–°å†™å…¥çš„æ•°æ®è¿˜æ²¡æœ‰æŒä¹…åŒ–åˆ°HFileä¸­ï¼Œå› æ­¤è¿ç§»è¯¥RegionServeræœåŠ¡æ—¶è¦ä»HLogä¸­æ¢å¤è¿™éƒ¨åˆ†è¿˜åœ¨å†…å­˜ä¸­çš„æ•°æ®ï¼Œæœ€å…³é”®çš„ä¸€æ­¥æ˜¯SplitLogï¼Œå³HMasteréœ€è¦éå†è¯¥RegionServeræœåŠ¡å™¨çš„HLogï¼Œå¹¶æŒ‰Regionåˆ‡åˆ†æˆå°å—ç§»åŠ¨åˆ°æ–°çš„åœ°å€ä¸‹ï¼Œå†è¿›è¡Œæ•°æ®çš„Replayã€‚</p><p>å•ä¸ªRegionServerçš„æ—¥å¿—é‡ç›¸å¯¹åºå¤§ï¼ˆæ•°åƒä¸ªRegionï¼Œä¸ŠGBçš„æ—¥å¿—ï¼‰ï¼Œä½†åˆéœ€è¦ç³»ç»Ÿå¿«é€Ÿçš„å®Œæˆæ—¥å¿—çš„æ¢å¤å·¥ä½œï¼Œä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆæ˜¯å°†å¤„ç†HLogçš„ä»»åŠ¡åˆ†é…ç»™å¤šå°RegionServeræœåŠ¡å™¨æ¥å…±åŒå¤„ç†ï¼Œéœ€è¦ä¸€ä¸ªæŒä¹…åŒ–ç»„ä»¶è¾…åŠ©HMasterå®Œæˆä»»åŠ¡çš„åˆ†é…ã€‚</p><p>HMasterä¼šåœ¨ZKä¸Šåˆ›å»ºä¸€ä¸ª <code>/hbase/splitlog</code> çš„èŠ‚ç‚¹ï¼Œå°†å“ªä¸ªRegionServerå¤„ç†å“ªä¸ªRegionè¿™æ ·çš„ä¿¡æ¯ä»¥åˆ—è¡¨çš„å½¢å¼å­˜æ”¾åœ¨è¯¥èŠ‚ç‚¹ï¼Œå„ä¸ªRegionServeræœåŠ¡å™¨è‡ªè¡Œåˆ°è¯¥èŠ‚ç‚¹ä¸Šé¢†å–ä»»åŠ¡å¹¶åœ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥åæ›´æ–°è¯¥èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä»¥é€šçŸ¥HMasterç»§ç»­è¿›è¡Œåç»­æ­¥éª¤ã€‚ZKè´Ÿè´£åˆ†å¸ƒå¼é›†ç¾¤ä¸­ç›¸äº’é€šçŸ¥å’Œä¿¡æ¯æŒä¹…åŒ–çš„è§’è‰²ã€‚</p><h4 id="ï¼ˆ5ï¼‰Replicationç®¡ç†"><a href="#ï¼ˆ5ï¼‰Replicationç®¡ç†" class="headerlink" title="ï¼ˆ5ï¼‰Replicationç®¡ç†"></a>ï¼ˆ5ï¼‰Replicationç®¡ç†</h4><p>HBaseé€šè¿‡Replicationå®ç°å®æ—¶çš„ä¸»å¤‡åŒæ­¥ï¼Œä»è€Œæ‹¥æœ‰äº†å®¹ç¾å’Œåˆ†æµç­‰å…³ç³»å‹æ•°æ®åº“æ‹¥æœ‰çš„åŠŸèƒ½ã€‚ä¸ä¼ ç»ŸReplicationä¸åŒçš„æ˜¯ï¼ŒHBaseä¸­Replicationæ˜¯å¤šå¯¹å¤šçš„ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹éšæ—¶éƒ½æœ‰å¯èƒ½æŒ‚æ‰ã€‚</p><p>åœ¨ZKä¸Šè®°å½•ä¸€ä¸ª <code>/hbase/replication</code> èŠ‚ç‚¹ï¼Œç„¶åæŠŠä¸åŒçš„RegionServeræœåŠ¡å™¨å¯¹åº”çš„HLogæ–‡ä»¶åç§°è®°å½•åˆ°ç›¸åº”çš„èŠ‚ç‚¹ä¸Šï¼ŒHMasteré›†ç¾¤ä¼šå°†æ–°å¢çš„æ•°æ®æ¨é€ç»™Slaveé›†ç¾¤ï¼Œå¹¶åŒæ—¶å°†æ¨é€ä¿¡æ¯è®°å½•åˆ°ZKä¸Šï¼ˆæ–­ç‚¹è®°å½•ï¼‰ï¼Œé‡å¤ä»¥ä¸Šè¿‡ç¨‹ã€‚æœåŠ¡å™¨æŒ‚æ‰æ—¶ï¼Œå› ä¸ºZKä¸Šå·²ç»ä¿å­˜äº†æ–­ç‚¹ä¿¡æ¯ï¼Œåªè¦ç”¨è¿™äº›ä¿¡æ¯åè°ƒæ¨é€HLogæ•°æ®çš„ä¸»èŠ‚ç‚¹æœåŠ¡å™¨å°±å¯ä»¥ç»§ç»­å¤åˆ¶ã€‚</p><h4 id="ï¼ˆ6ï¼‰ZooKeeperéƒ¨ç½²"><a href="#ï¼ˆ6ï¼‰ZooKeeperéƒ¨ç½²" class="headerlink" title="ï¼ˆ6ï¼‰ZooKeeperéƒ¨ç½²"></a>ï¼ˆ6ï¼‰ZooKeeperéƒ¨ç½²</h4><p>HBaseçš„å¯åŠ¨è„šæœ¬ï¼ˆhbase-env.shï¼‰ä¸­å¯ä»¥é€‰æ‹©ç”±HBaseå¯åŠ¨å…¶è‡ªå¸¦çš„é»˜è®¤ZKè¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ªå·²æœ‰çš„å¤–éƒ¨ZKé›†ç¾¤ã€‚ä¸€èˆ¬å»ºè®®åè€…ï¼Œå¯ä»¥æ–¹ä¾¿å¤šä¸ªHBaseå¤ç”¨ä¸€å¥—ZKé›†ç¾¤ï¼Œä½†è¦ä¸ºæ¯ä¸ªHBaseé›†ç¾¤æ˜ç¡®æŒ‡å®šå¯¹åº”çš„ZKæ ¹èŠ‚ç‚¹é…ç½®ï¼ˆé…ç½®é¡¹zookeeper.znode.parentï¼‰ç¡®ä¿HBaseé›†ç¾¤é—´äº’ä¸å¹²æ‰°ã€‚</p><p>å¯¹åº”HBaseå®¢æˆ·ç«¯åªè¦æŒ‡å®šZKçš„é›†ç¾¤åœ°å€å’Œå¯¹åº”HBaseæ ¹èŠ‚ç‚¹é…ç½®å³å¯ã€‚HBaseé›†ç¾¤å¯åŠ¨æ—¶ä¼šåœ¨ZKä¸Šé€ä¸ªæ·»åŠ å¯¹åº”çš„åˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå¹¶åœ¨HMasterä»¥åŠRegionServerè¿›ç¨‹ä¸­è¿›è¡Œç›¸åº”èŠ‚ç‚¹çš„Watcheræ³¨å†Œã€‚</p><h3 id="2-3-Kafka"><a href="#2-3-Kafka" class="headerlink" title="2.3 Kafka"></a>2.3 Kafka</h3><p>Kafkaæ˜¯ç”±ç¤¾äº¤å…¬å¸LinkedInäº2010å¹´12æœˆä»½å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œç”±Scalaè¯­è¨€å¼€å‘ï¼Œå¹¿æ³›è¿ç”¨åœ¨Twitterã€Netflixå’ŒTumblrç­‰å¤§å‹äº’è”ç½‘ç«™ç‚¹ä¸Šã€‚</p><ul><li>ä¸»è¦ç”¨äº<strong>å®ç°ä½å»¶è¿Ÿçš„å‘é€å’Œæ”¶é›†å¤§é‡çš„äº‹ä»¶å’Œæ—¥å¿—æ•°æ®</strong>ï¼ˆæ´»è·ƒæ•°æ®ï¼Œå¦‚ç½‘ç«™çš„PVæ•°å’Œç”¨æˆ·è®¿é—®è®°å½•ï¼‰ï¼Œè¿™äº›æ•°æ®ä»¥æ—¥å¿—çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œç„¶åç”±ä¸€ä¸ªä¸“é—¨çš„ç³»ç»Ÿè¿›è¡Œæ—¥å¿—çš„æ”¶é›†ä¸ç»Ÿè®¡ã€‚</li><li>ååé‡æé«˜ï¼Œæ•´ä½“è®¾è®¡æ˜¯å…¸å‹çš„å‘å¸ƒä¸è®¢é˜…æ¨¡å¼ç³»ç»Ÿã€‚é›†ç¾¤ä¸­æ‰€æœ‰æœåŠ¡å™¨éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œå¯ä»¥åœ¨ä¸åšä»»ä½•é…ç½®æ›´æ”¹çš„æƒ…å†µä¸‹å®ç°æœåŠ¡å™¨çš„æ·»åŠ ä¸åˆ é™¤ï¼Œæ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹Ÿèƒ½åšåˆ°éšæ„é‡å¯å’Œæœºå™¨ä¸Šä¸‹çº¿ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010129.png"></p><h4 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h4><ul><li><strong>æ¶ˆæ¯ç”Ÿäº§è€…ï¼š</strong>å³Producerï¼Œç”Ÿæˆæ¶ˆæ¯å¹¶å‘é€åˆ°KafkaæœåŠ¡å™¨ä¸Šã€‚</li><li><strong>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼š</strong>å³Consumerï¼Œè´Ÿè´£æ¶ˆè´¹KafkaæœåŠ¡å™¨ä¸Šçš„æ¶ˆæ¯ã€‚</li><li><strong>ä¸»é¢˜ï¼š</strong>å³Topicï¼Œç”±ç”¨æˆ·å®šä¹‰å¹¶é…ç½®åœ¨KafkaæœåŠ¡ç«¯ï¼Œç”¨äºå»ºç«‹ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„è®¢é˜…å…³ç³»ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°æŒ‡å®štopicä¸‹ï¼Œæ¶ˆè´¹è€…ä»è¯¥topicæ¶ˆè´¹æ¶ˆæ¯ã€‚</li><li><strong>æ¶ˆæ¯åˆ†åŒºï¼š</strong>å³Partitionï¼Œä¸€ä¸ªtopicä¸‹åˆ†å¤šä¸ªåˆ†åŒºï¼Œå¦‚topic1åˆ†10ä¸ªåˆ†åŒºï¼Œç”±ä¸¤å°æœåŠ¡å™¨æä¾›ï¼Œæ¯å°5ä¸ªåˆ†åŒºï¼ŒæœåŠ¡å™¨IDä¸º0å’Œ1ï¼Œåˆ†åŒºä¸º0-0åˆ°0-4å’Œ1-0åˆ°1-4ã€‚æ¶ˆæ¯åˆ†åŒºæœºåˆ¶å’Œåˆ†åŒºæ•°é‡ä¸æ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡æœºåˆ¶æœ‰å¾ˆå¤§å…³ç³»ã€‚</li><li><strong>Brokerï¼š</strong>å³Kafkaçš„æœåŠ¡å™¨ï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚</li><li><strong>æ¶ˆè´¹è€…åˆ†ç»„ï¼š</strong>å³Groupï¼Œç”¨äºå½’ç»„åŒç±»æ¶ˆè´¹è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥å…±åŒæ¶ˆè´¹ä¸€ä¸ªtopicä¸‹çš„æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªåˆ†ç»„/é›†ç¾¤ã€‚</li><li><strong>Offsetï¼š</strong>æ¶ˆæ¯å­˜å‚¨åœ¨Kafkaçš„Brokerä¸Šï¼Œæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯æ•°æ®çš„è¿‡ç¨‹éœ€è¦åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚</li></ul><h4 id="Brokeræ³¨å†Œ"><a href="#Brokeræ³¨å†Œ" class="headerlink" title="Brokeræ³¨å†Œ"></a>Brokeræ³¨å†Œ</h4><p>Brokerã€Producerå’ŒConsumeræ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒBrokerè™½ç„¶ç›¸äº’ç‹¬ç«‹è¿è¡Œä½†éœ€è¦ä¸€ä¸ªæ³¨å†Œç³»ç»Ÿç»Ÿä¸€ç®¡ç†æ‰€æœ‰èŠ‚ç‚¹ã€‚ZKä¸Šé…ç½®ä¸€ä¸ªBrokerèŠ‚ç‚¹ <code>/broker/ids</code> ï¼Œæ¯ä¸ªBrokeræœåŠ¡å™¨å¯åŠ¨æ—¶éƒ½å…ˆä¼šåˆ°ZKä¸Šè¿›è¡Œæ³¨å†Œ <code>/broker/ids/[0...N]</code> ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ã€‚</p><p>ä½¿ç”¨å…¨å±€å”¯ä¸€IDï¼ˆBroker  IDï¼‰æ¥æŒ‡ä»£æ¯å°BrokeræœåŠ¡å™¨ï¼Œåˆ›å»ºå®ŒèŠ‚ç‚¹åæ¯ä¸ªBrokerä¼šå°†è‡ªå·±çš„IPåœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯å†™å…¥æ­¤èŠ‚ç‚¹ã€‚</p><h4 id="Topicæ³¨å†Œ"><a href="#Topicæ³¨å†Œ" class="headerlink" title="Topicæ³¨å†Œ"></a>Topicæ³¨å†Œ</h4><p>Kafkaä¸­å°†åŒä¸€ä¸ªTopicçš„æ¶ˆæ¯åˆ†ä¸ºå¤šä¸ªåˆ†åŒºå¹¶åˆ†å¸ƒåˆ°å¤šä¸ªBrokerä¸Šï¼Œè¿™äº›åˆ†åŒºä¿¡æ¯å’ŒBrokerçš„å¯¹åº”ä¿¡æ¯ä¹Ÿç”±ZKç»´æŠ¤ï¼Œè®°å½•åœ¨èŠ‚ç‚¹ <code>/brokers/topics</code> ï¼Œå³TopicèŠ‚ç‚¹ã€‚æ¯ä¸ªTopicéƒ½ä¼šå¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹ <code>/brokers/topics/[topic]</code> ã€‚</p><p>BrokeræœåŠ¡å™¨å¯åŠ¨åï¼Œä¼šåˆ°å¯¹åº”çš„TopicèŠ‚ç‚¹ä¸‹æ³¨å†Œè‡ªå·±çš„Broker IDï¼Œå¹¶å†™å…¥é’ˆå¯¹è¯¥Topicçš„åˆ†åŒºæ€»æ•° ã€‚å¦‚ä¸´æ—¶èŠ‚ç‚¹ <code>/brokers/topics/login3-&gt;2</code> è¡¨æ˜Broker IDä¸º3çš„ä¸€å°æœåŠ¡å™¨å¯¹åº”ï¼Œloginè¿™ä¸ªä¸»é¢˜çš„æ¶ˆæ¯æä¾›äº†2ä¸ªåˆ†åŒºè¿›è¡Œæ¶ˆæ¯å­˜å‚¨ã€‚ </p><h4 id="ç”Ÿäº§è€…è´Ÿè½½å‡è¡¡"><a href="#ç”Ÿäº§è€…è´Ÿè½½å‡è¡¡" class="headerlink" title="ç”Ÿäº§è€…è´Ÿè½½å‡è¡¡"></a>ç”Ÿäº§è€…è´Ÿè½½å‡è¡¡</h4><p>å› ä¸ºä¸€ä¸ªTopicä¼šè¿›è¡Œåˆ†åŒºå¹¶åˆ†å¸ƒåˆ°ä¸åŒçš„BrokeræœåŠ¡å™¨ï¼Œæ‰€ä»¥ç”Ÿäº§è€…è¦åˆç†çš„å°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„Brokerä¸Šï¼Œå¦‚ä½•è¿›è¡Œç”Ÿäº§è€…çš„è´Ÿè½½å‡è¡¡ï¼Ÿ</p><ul><li><strong>å››å±‚è´Ÿè½½å‡è¡¡ï¼š</strong><ul><li>æ ¹æ®ç”Ÿäº§è€…çš„IPåœ°å€å’Œç«¯å£ä¸ºå™¨ç¡®å®šä¸€ä¸ªç›¸å…³è”çš„Brokerï¼Œä¸€ä¸ªç”Ÿäº§è€…å¯¹åº”ä¸€ä¸ªBrokerï¼Œå…¶æ¶ˆæ¯éƒ½å‘é€ç»™æ­¤Brokerã€‚</li><li>ä¼˜ç‚¹ï¼šæ•´ä½“æ¶æ„ç®€å•ï¼Œæ¯ä¸ªç”Ÿäº§è€…åªéœ€ç»´æŠ¤å’ŒBrokerçš„å•ä¸ªTCPé“¾æ¥ã€‚</li><li>ç¼ºç‚¹ï¼šæ— æ³•åšåˆ°çœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼Œç”Ÿäº§è€…ä¹Ÿæ— æ³•å®æ—¶æ„ŸçŸ¥åˆ°Brokerçš„æ–°å¢å’Œåˆ é™¤ï¼Œä¹Ÿå°±æ— æ³•åšåˆ°åŠ¨æ€çš„è´Ÿè½½å‡è¡¡ã€‚</li></ul></li><li><strong>ZooKeeperè´Ÿè½½å‡è¡¡ï¼š</strong><ul><li>ç”Ÿäº§è€…é€šè¿‡BrokerèŠ‚ç‚¹çš„å˜åŒ–åŠ¨æ€æ„ŸçŸ¥åˆ°BrokeræœåŠ¡å™¨åˆ—è¡¨çš„å˜æ›´ï¼Œç”Ÿäº§è€…æ³¨å†Œå¯¹â€œBrokerå¢åŠ ä¸å‡å°‘â€ã€â€œTopicçš„æ–°å¢ä¸å‡å°‘â€å’Œâ€œBrokerä¸Topicå…³è”å…³ç³»çš„å˜åŒ–â€ç­‰äº‹ä»¶æ³¨å†ŒWatcherç›‘å¬ã€‚</li><li>å¼€å‘äººå‘˜å¯ä»¥æ§åˆ¶ç”Ÿäº§è€…æ ¹æ®ä¸€å®šè§„åˆ™æ¥è¿›è¡Œæ•°æ®åˆ†åŒºï¼Œè€Œä¸ä»…ä»…æ˜¯éšæœºç®—æ³•ã€‚å³è¯­ä¹‰åˆ†åŒºã€‚</li></ul></li></ul><h4 id="æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡"><a href="#æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡" class="headerlink" title="æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡"></a>æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡</h4><p>æ¯ä¸ªæ¶ˆè´¹è€…åˆ†ç»„éƒ½ä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„Group IDï¼Œæ¯ä¸ªæ¶ˆè´¹è€…åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„Consumer IDï¼Œæ ¼å¼ä¸º <code>Hostname:UUID</code> ã€‚</p><h5 id="ZKè®°å½•æ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€…å…³ç³»"><a href="#ZKè®°å½•æ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€…å…³ç³»" class="headerlink" title="ZKè®°å½•æ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€…å…³ç³»"></a>ZKè®°å½•æ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€…å…³ç³»</h5><p>æ¯ä¸ªæ¶ˆæ¯åˆ†åŒºæœ‰ä¸”åªèƒ½åŒäº‹æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆæ¯çš„æ¶ˆè´¹ã€‚æ‰€ä»¥è¦åœ¨ZKä¸Šè®°å½•ä¸‹æ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€…ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚å½“æ¶ˆè´¹è€…ç¡®å®šäº†å¯¹ä¸€ä¸ªåˆ†åŒºçš„æ¶ˆè´¹æƒåˆ©ï¼Œè¦å°†å…¶Consumer IDå†™å…¥å¯¹åº”åˆ†åŒºçš„ä¸´æ—¶èŠ‚ç‚¹ä¸Šï¼Œå¦‚ <code>/consumers/[group_id]/owners/[topic]/[broker_id-partition_id]</code> æœ€åå³æ¶ˆæ¯åˆ†åŒºçš„æ ‡è¯†ï¼ŒèŠ‚ç‚¹å†…å®¹å°±æ˜¯æ¶ˆè´¹è¯¥åˆ†åŒºä¸Šæ¶ˆæ¯çš„æ¶ˆè´¹è€…çš„Consumer IDã€‚</p><h5 id="ZKè®°å½•æ¶ˆè´¹è¿›åº¦Offset"><a href="#ZKè®°å½•æ¶ˆè´¹è¿›åº¦Offset" class="headerlink" title="ZKè®°å½•æ¶ˆè´¹è¿›åº¦Offset"></a>ZKè®°å½•æ¶ˆè´¹è¿›åº¦Offset</h5><p>æ¶ˆè´¹è€…å¯¹åˆ†åŒºè¿›è¡Œæ¶ˆè´¹æ—¶ï¼Œè¦å®šæ—¶çš„å°†åˆ†åŒºæ¶ˆæ¯çš„æ¶ˆè´¹è¿›åº¦/Offsetï¼ˆèŠ‚ç‚¹ä¸º <code>/consumers/[group_id]/offsets/[topic]/[broker_id-partition_id]</code> ï¼Œå†…å®¹ä¸ºOffsetå€¼ï¼‰è®°å½•åˆ°ZKä¸Šå»ï¼Œä»¥ä¾¿è¯¥æ¶ˆè´¹è€…é‡å¯æˆ–å…¶ä»–æ¶ˆè´¹è€…é‡æ–°æ¥ç®¡è¯¥æ¶ˆæ¯åˆ†åŒºæ¶ˆè´¹åï¼Œèƒ½å¤Ÿä»ä¹‹å‰çš„è¿›åº¦å¼€å§‹ç»§ç»­æ¶ˆè´¹ã€‚</p><h5 id="æ¶ˆè´¹è€…æ³¨å†Œ"><a href="#æ¶ˆè´¹è€…æ³¨å†Œ" class="headerlink" title="æ¶ˆè´¹è€…æ³¨å†Œ"></a>æ¶ˆè´¹è€…æ³¨å†Œ</h5><p>æ¶ˆè´¹è€…æœåŠ¡å™¨åˆå§‹åŒ–å¯åŠ¨æ—¶åŠ å…¥æ¶ˆè´¹è€…åˆ†ç»„çš„è¿‡ç¨‹ï¼š</p><ol><li><strong>æ³¨å†Œåˆ°æ¶ˆè´¹è€…åˆ†ç»„Groupï¼š</strong><ul><li>æ¶ˆè´¹è€…å¯åŠ¨æ—¶ï¼Œåœ¨ZKæ³¨å†Œè‡ªå·±çš„ä¸´æ—¶èŠ‚ç‚¹ <code>/consumers/[group_id]/ids/[consumer_id]</code> </li><li>å®Œæˆåˆ›å»ºåï¼Œæ¶ˆè´¹è€…å°†è‡ªå·±è®¢é˜…çš„Topicä¿¡æ¯å†™å…¥è¯¥èŠ‚ç‚¹ã€‚</li></ul></li><li><strong>å¯¹Groupä¸­æ¶ˆè´¹è€…çš„å˜åŒ–æ³¨å†Œç›‘å¬ï¼š</strong>æ¯ä¸ªæ¶ˆè´¹è€…ä¼šå…³æ³¨æ‰€å±Groupä¸­æ¶ˆè´¹è€…æœåŠ¡å™¨çš„å˜åŒ–æƒ…å†µï¼Œå¯¹ <code>/consumers/[group_id]/ids</code> èŠ‚ç‚¹æ³¨å†Œå­èŠ‚ç‚¹å˜åŒ–çš„Watcherç›‘å¬ï¼Œå½“æ¶ˆè´¹è€…å‘ç”Ÿå˜åŒ–ï¼Œä¼šè§¦å‘æ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ã€‚</li><li><strong>å¯¹BrokeræœåŠ¡å™¨çš„å˜åŒ–æ³¨å†Œç›‘å¬ï¼š</strong>æ¶ˆè´¹è€…å¯¹ <code>/broker/ids/[0...N]</code> ä¸­çš„èŠ‚ç‚¹è¿›è¡Œç›‘å¬æ³¨å†Œï¼Œå½“BrokeræœåŠ¡å™¨åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼Œä¼šæ ¹æ®å…·ä½“æƒ…å†µå†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œæ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ã€‚</li><li><strong>è¿›è¡Œæ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡ï¼š</strong>è®©åŒä¸€ä¸ªTopicä¸‹ä¸åŒåˆ†åŒºçš„æ¶ˆæ¯å°½é‡å‡è¡¡çš„å‘—å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå½“ä¸€ä¸ªGroupç»„å†…æ¶ˆè´¹è€…æœåŠ¡å™¨å‘ç”Ÿå˜æ›´ï¼Œæˆ–BrokeræœåŠ¡å™¨å‘ç”Ÿå˜æ›´ä¼šè§¦å‘æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡ã€‚</li></ol><h5 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h5><p>ä¸€ä¸ªæ¶ˆè´¹è€…åˆ†ç»„ä¸­æ¯ä¸ªæ¶ˆè´¹è€…è®°ä¸ºC<del>1</del>ï¼ŒC<del>2</del>ï¼Œâ€¦ï¼ŒC<del>i</del> ï¼Œâ€¦. ï¼ŒC<del>G</del> ã€‚å¯¹äºæ¶ˆè´¹è€…C<del>i</del>å…¶å¯¹åº”çš„æ¶ˆæ¯åˆ†åŒºåˆ†é…ç­–ç•¥ä¸ºï¼š</p><ol><li>è®¾ç½®P<del>T</del>ä¸ºæŒ‡å®šTopicæ‰€æœ‰çš„æ¶ˆæ¯åˆ†åŒºã€‚</li><li>è®¾ç½®C<del>G</del>ä¸ºåŒä¸€ä¸ªæ¶ˆè´¹è€…åˆ†ç»„ä¸­æ‰€æœ‰çš„æ¶ˆè´¹è€…ã€‚</li><li>å¯¹P<del>T</del>è¿›è¡Œæ’åºï¼Œä½¿åˆ†å¸ƒåœ¨åŒä¸€ä¸ªBrokeræœåŠ¡å™¨ä¸Šçš„åˆ†åŒºå°½é‡é åœ¨ä¸€èµ·ã€‚</li><li>å¯¹C<del>G</del>è¿›è¡Œæ’åºã€‚</li><li>è®¾ç½®iä¸ºC<del>i</del>åœ¨C<del>G</del>ä¸­ä½ç½®çš„ç´¢å¼•å€¼ï¼ŒåŒäº‹hiè®¾ç½® N = size(P<del>T</del>) / size(C<del>G</del>) ã€‚</li><li>å°†ç¼–å·ä¸º <code>i*N~(I+1)*N-1</code> çš„æ¶ˆæ¯åˆ†åŒºåˆ†é…ç»™æ¶ˆè´¹è€…C<del>i</del> ã€‚</li><li>é‡å†™æ›´æ–°ZooKeeperä¸Šæ¶ˆæ¯åˆ†åŒºä¸æ¶ˆè´¹è€… C<del>i</del> çš„å…³ç³»ã€‚</li></ol><h2 id="ä¸‰-é˜¿é‡Œå·´å·´çš„åº”ç”¨å®è·µ"><a href="#ä¸‰-é˜¿é‡Œå·´å·´çš„åº”ç”¨å®è·µ" class="headerlink" title="ä¸‰. é˜¿é‡Œå·´å·´çš„åº”ç”¨å®è·µ"></a>ä¸‰. é˜¿é‡Œå·´å·´çš„åº”ç”¨å®è·µ</h2><p>æœªå®Œå¾…ç»­ã€‚</p><h3 id="3-1-æ¶ˆæ¯ä¸­é—´ä»¶-Metamorphosis"><a href="#3-1-æ¶ˆæ¯ä¸­é—´ä»¶-Metamorphosis" class="headerlink" title="3.1 æ¶ˆæ¯ä¸­é—´ä»¶-Metamorphosis"></a>3.1 æ¶ˆæ¯ä¸­é—´ä»¶-Metamorphosis</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010130.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010131.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010132.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010133.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010134.png"></p><h3 id="3-2-RPCæœåŠ¡æ¡†æ¶-Dubbo"><a href="#3-2-RPCæœåŠ¡æ¡†æ¶-Dubbo" class="headerlink" title="3.2 RPCæœåŠ¡æ¡†æ¶-Dubbo"></a>3.2 RPCæœåŠ¡æ¡†æ¶-Dubbo</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010135.png"></p><h3 id="3-3-åŸºäºMySQL-Binlogçš„å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ç»„ä»¶-Canal"><a href="#3-3-åŸºäºMySQL-Binlogçš„å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ç»„ä»¶-Canal" class="headerlink" title="3.3 åŸºäºMySQL Binlogçš„å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ç»„ä»¶-Canal"></a>3.3 åŸºäºMySQL Binlogçš„å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ç»„ä»¶-Canal</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010136.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010137.png"></p><h3 id="3-4-åˆ†å¸ƒå¼æ•°æ®åº“åŒæ­¥ç³»ç»Ÿ-Otter"><a href="#3-4-åˆ†å¸ƒå¼æ•°æ®åº“åŒæ­¥ç³»ç»Ÿ-Otter" class="headerlink" title="3.4 åˆ†å¸ƒå¼æ•°æ®åº“åŒæ­¥ç³»ç»Ÿ-Otter"></a>3.4 åˆ†å¸ƒå¼æ•°æ®åº“åŒæ­¥ç³»ç»Ÿ-Otter</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010138.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010139.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010140.png"></p><h3 id="3-5-è½»é‡çº§åˆ†å¸ƒå¼é€šç”¨æœç´¢å¹³å°-ç»ˆæœ"><a href="#3-5-è½»é‡çº§åˆ†å¸ƒå¼é€šç”¨æœç´¢å¹³å°-ç»ˆæœ" class="headerlink" title="3.5 è½»é‡çº§åˆ†å¸ƒå¼é€šç”¨æœç´¢å¹³å°-ç»ˆæœ"></a>3.5 è½»é‡çº§åˆ†å¸ƒå¼é€šç”¨æœç´¢å¹³å°-ç»ˆæœ</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010142.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010143.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010144.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010145.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010146.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010147.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010148.png"></p><h3 id="3-6-å®æ—¶è®¡ç®—å¼•æ“-JStorm"><a href="#3-6-å®æ—¶è®¡ç®—å¼•æ“-JStorm" class="headerlink" title="3.6 å®æ—¶è®¡ç®—å¼•æ“-JStorm"></a>3.6 å®æ—¶è®¡ç®—å¼•æ“-JStorm</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210501/202105010149.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šåº”ç”¨åœºæ™¯ï¼ˆæ•°æ®å‘å¸ƒ/è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Masteré€‰ä¸¾ã€åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼‰ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨ï¼ˆHadoopã€HBaseã€Kafkaï¼‰ï¼Œé˜¿é‡Œå·´å·´åº”ç”¨ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆä¸‰ï¼‰å¼€æºå®¢æˆ·ç«¯ZkClientå’ŒCurator</title>
    <link href="http://linyishui.top/2021051601.html"/>
    <id>http://linyishui.top/2021051601.html</id>
    <published>2021-05-16T06:35:20.000Z</published>
    <updated>2021-07-18T15:36:38.600Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆä¸‰ï¼‰å¼€æºå®¢æˆ·ç«¯"><a href="#ZooKeeperï¼ˆä¸‰ï¼‰å¼€æºå®¢æˆ·ç«¯" class="headerlink" title="ZooKeeperï¼ˆä¸‰ï¼‰å¼€æºå®¢æˆ·ç«¯"></a>ZooKeeperï¼ˆä¸‰ï¼‰å¼€æºå®¢æˆ·ç«¯</h1><h2 id="ä¸€-ZkClient"><a href="#ä¸€-ZkClient" class="headerlink" title="ä¸€. ZkClient"></a>ä¸€. ZkClient</h2><p>ZkClientæ˜¯GitHubä¸Šçš„ä¸€ä¸ªå¼€æºçš„ZooKeeperå®¢æˆ·ç«¯ï¼Œå®ƒåœ¨ZKåŸç”ŸAPIæ¥å£ä¸Šè¿›è¡Œäº†åŒ…è£…ï¼ŒåŒæ—¶å†…éƒ¨å®ç°äº†è¯¸å¦‚Sessionè¶…æ—¶é‡è¿ã€Watcheråå¤æ³¨å†Œç­‰åŠŸèƒ½ã€‚</p><h3 id="1-1-å¼•å…¥ä¾èµ–"><a href="#1-1-å¼•å…¥ä¾èµ–" class="headerlink" title="1.1 å¼•å…¥ä¾èµ–"></a>1.1 å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zookeeper.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.sgroschupf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zkclient.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-åˆ›å»ºä¼šè¯"><a href="#1-2-åˆ›å»ºä¼šè¯" class="headerlink" title="1.2 åˆ›å»ºä¼šè¯"></a>1.2 åˆ›å»ºä¼šè¯</h3><p>æ„é€ å‡½æ•°APIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String serverstring)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> sessionTimeout, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(String zkServers, <span class="keyword">int</span> sessionTimeout, <span class="keyword">int</span> connectionTimeout, ZkSerializer zkSerializer)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection, <span class="keyword">int</span> connectionTimeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZkClient</span><span class="params">(IZkConnection connection, <span class="keyword">int</span> connectionTimeout, ZkSerializer zkSerializer)</span></span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>zkServers</td><td>æŒ‡ZooKeeperæœåŠ¡å™¨åˆ—è¡¨ï¼Œç”±è‹±æ–‡çŠ¶æ€é€—å·åˆ†å¼€çš„host:portå­—ç¬¦ä¸²ç»„æˆï¼Œæ¯ä¸€ä¸ªéƒ½ä»£è¡¨ä¸€å°ZooKeeperæœºå™¨ï¼Œä¾‹å¦‚ï¼Œ192.168.1.1:2181,192.168.1.2:2181,192.168.1.3:2181</td></tr><tr><td>sessionTimeout</td><td>ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤æ˜¯30000ms</td></tr><tr><td>connectionTimeout</td><td>è¿æ¥åˆ›å»ºè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚æ­¤å‚æ•°è¡¨æ˜å¦‚æœåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…è¿˜æ˜¯æ— æ³•å’ŒZooKeeperå»ºç«‹è¿æ¥ï¼Œå°±æŠ›å‡ºå¼‚å¸¸</td></tr><tr><td>connection</td><td>IZkConnectionæ¥å£çš„å®ç°ç±»</td></tr><tr><td>zkSerializer</td><td>è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</td></tr></tbody></table><ul><li>ZooKeeperä¼šè¯çš„å»ºç«‹æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ï¼Œå¼€å‘äººå‘˜éœ€è¦è‡ªå·±æ¥è¿›è¡Œç­‰å¾…å¤„ç†ï¼ŒZkClienté€šè¿‡å†…éƒ¨åŒ…è£…ï¼Œå°†è¿™ä¸ªå¼‚æ­¥çš„ä¼šè¯åˆ›å»ºè¿‡ç¨‹åŒæ­¥åŒ–äº†ï¼Œæ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚</li><li>IZkConnectionæ¥å£æ˜¯å¯¹ZooKeeperåŸç”Ÿæ¥å£æœ€ç›´æ¥çš„åŒ…è£…å’Œäº¤äº’å±‚ï¼ŒåŒ…å«äº†å¢åˆ æ”¹æŸ¥ä¸€ç³»åˆ—æ¥å£çš„å®šä¹‰ï¼Œæœ‰ä¸¤ç§é»˜è®¤å®ç° <code>ZkConnection</code> å’Œ <code>InMemoryConnection</code> ã€‚</li><li>ZkClientä¸­å®šä¹‰äº†ZkSerializeræ¥å£å…è®¸ç”¨æˆ·ä¼ å…¥ä¸€ä¸ªåºåˆ—åŒ–å®ç°ï¼Œå¦‚Hessianæˆ–Kryoï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä½¿ç”¨Javaè‡ªå¸¦çš„åºåˆ—åŒ–æ–¹å¼ã€‚</li><li>ZkClientä¸å†éœ€è¦æä¾›Watcherå‚æ•°ï¼Œå…¶å¼•å…¥äº†Listeneræ¥å®ç°Watcherçš„æ³¨å†Œã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºZKå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Create_Session_Sample</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        ZkClient zkClient = <span class="keyword">new</span> ZkClient(<span class="string">&quot;domain1.book.zookeeper:2181&quot;</span>, <span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ZooKeeper session established.&quot;</span>)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-åˆ›å»ºèŠ‚ç‚¹"><a href="#1-3-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="1.3 åˆ›å»ºèŠ‚ç‚¹"></a>1.3 åˆ›å»ºèŠ‚ç‚¹</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200140.png"></p><p><code>createEphemeral</code> æ¥å£æ˜¯åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œ<code>createPersistentSequential</code> åˆ™æ˜¯åˆ›å»ºæŒä¹…é¡ºåºèŠ‚ç‚¹ã€‚</p><p>ZKåŸç”ŸAPIæ— æ³•é€’å½’åˆ›å»ºèŠ‚ç‚¹ï¼Œåªèƒ½åœ¨çˆ¶èŠ‚ç‚¹å­˜åœ¨æ—¶åˆ›å»ºå­èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½è¦æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚ZkClienté€šè¿‡ <code>createParents</code> å‚æ•°åœ¨å†…éƒ¨å¸®åŠ©æˆ‘ä»¬é€’å½’å»ºç«‹çˆ¶èŠ‚ç‚¹ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200142.png"></p><h3 id="1-4-åˆ é™¤èŠ‚ç‚¹"><a href="#1-4-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="1.4 åˆ é™¤èŠ‚ç‚¹"></a>1.4 åˆ é™¤èŠ‚ç‚¹</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200143.png"></p><p><code>deleteRecursive</code> è‡ªåŠ¨å®Œæˆé€å±‚éå†åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200144.png"></p><h3 id="1-5-è¯»å–æ•°æ®"><a href="#1-5-è¯»å–æ•°æ®" class="headerlink" title="1.5 è¯»å–æ•°æ®"></a>1.5 è¯»å–æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path)</span></span>;</span><br><span class="line"><span class="comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬</span></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">subscribeChildChanges</span><span class="params">(String path, IZkChildListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IZkChildListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IZkChildListener å‚æ•°ï¼š</p><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>parentPath</td><td>å­èŠ‚ç‚¹å˜æ›´é€šçŸ¥å¯¹åº”çš„çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„</td></tr><tr><td>currentChilds</td><td>å­èŠ‚ç‚¹çš„ç›¸å¯¹è·¯å¾„åˆ—è¡¨ï¼Œå¦‚æœæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä¼šä¼ å…¥null</td></tr></tbody></table><p>èŠ‚ç‚¹æ³¨å†Œç›‘å¬åä¼šæ”¶åˆ°å¦‚ä¸‹äº‹ä»¶é€šçŸ¥ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200145.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200146.png"></p><ul><li>å®¢æˆ·ç«¯å¯ä»¥å¯¹ä¸€ä¸ªä¸å­˜åœ¨çš„èŠ‚ç‚¹è¿›è¡Œå­èŠ‚ç‚¹å˜æ›´çš„ç›‘å¬ã€‚</li><li>ä¸€æ—¦å®¢æˆ·ç«¯å¯¹ä¸€ä¸ªèŠ‚ç‚¹æ³¨å†Œå­èŠ‚ç‚¹åˆ—è¡¨å˜æ›´ç›‘å¬ä¹‹åï¼Œå½“è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨å‘é€å˜æ›´æ—¶ï¼ŒæœåŠ¡ç«¯éƒ½ä¼šé€šçŸ¥å¹¶å°†æœ€æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li><li>è¯¥èŠ‚ç‚¹æœ¬èº«çš„åˆ›å»ºæˆ–åˆ é™¤ä¹Ÿä¼šé€šçŸ¥åˆ°å®¢æˆ·ç«¯ã€‚</li><li>ZkClientçš„Listenerä¸åŒäºWatcherï¼Œä¸€æ—¦æ³¨å†Œå°±ä¼šä¸€ç›´ç”Ÿæ•ˆã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path)</span></span>;</span><br><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path, <span class="keyword">boolean</span> returnNullIfPathNotExists)</span></span>;</span><br><span class="line">&lt;T extends Object&gt; <span class="function">T <span class="title">readData</span><span class="params">(String path, Stat stat)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200147.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ ·é€šè¿‡æ³¨å†ŒListeneræ¥å®ç°ç›‘å¬</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IZkDataListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String dataPath, Object data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildDeleted</span><span class="params">(String dataPath)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>dataPath</td><td>äº‹ä»¶é€šçŸ¥å¯¹åº”çš„èŠ‚ç‚¹è·¯å¾„</td></tr><tr><td>data</td><td>æœ€æ–°çš„æ•°æ®å†…å®¹</td></tr></tbody></table><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200148.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200149.png"></p><h3 id="1-6-æ›´æ–°æ•°æ®"><a href="#1-6-æ›´æ–°æ•°æ®" class="headerlink" title="1.6 æ›´æ–°æ•°æ®"></a>1.6 æ›´æ–°æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeData</span><span class="params">(String path, Object data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeData</span><span class="params">(<span class="keyword">final</span> String path, Object data, <span class="keyword">final</span> <span class="keyword">int</span> expectedVersion)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200150.png"></p><p>æ£€æµ‹æŒ‡å®šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="äºŒ-Curator"><a href="#äºŒ-Curator" class="headerlink" title="äºŒ. Curator"></a>äºŒ. Curator</h2><p>Curatoræ˜¯ç”±Netflixå¼€å‘çš„ä¸€å¥—ZooKeeperå®¢æˆ·ç«¯æ¡†æ¶ï¼Œå’ŒZkClientä¸€æ ·è§£å†³äº†éå¸¸åº•å±‚çš„ç»†èŠ‚å¼€å‘å·¥ä½œï¼ŒåŒ…æ‹¬è¿æ¥é‡è¿ã€åå¤æ³¨å†ŒWatcherå’ŒNodeExistsExceptionå¼‚å¸¸ç­‰ã€‚Curatoråœ¨ZKåŸç”ŸAPIçš„åŸºç¡€ä¸Šè¿›è¡Œäº†åŒ…è£…ï¼Œæä¾›äº†ä¸€å¥—æ˜“ç”¨æ€§å’Œå¯è¯»æ€§æ›´å¼ºçš„Fluenté£æ ¼çš„APIæ¡†æ¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒCuratorè¿˜æä¾›äº†ZooKeeperå„ç§åº”ç”¨åœºæ™¯ï¼ˆRecipeï¼Œå¦‚å…±äº«é”æœåŠ¡ã€Masteré€‰ä¸¾æœºåˆ¶å’Œåˆ†å¸ƒå¼è®¡æ•°å™¨ï¼‰çš„æŠ½è±¡å°è£…ã€‚</p><h3 id="2-1-å¼•å…¥ä¾èµ–"><a href="#2-1-å¼•å…¥ä¾èµ–" class="headerlink" title="2.1 å¼•å…¥ä¾èµ–"></a>2.1 å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-åˆ›å»ºä¼šè¯"><a href="#2-2-åˆ›å»ºä¼šè¯" class="headerlink" title="2.2 åˆ›å»ºä¼šè¯"></a>2.2 åˆ›å»ºä¼šè¯</h3><ol><li><p>ä½¿ç”¨ <code>CuratorFrameworkFactory</code> å·¥å‚ç±»çš„ä¸¤ä¸ªé™æ€æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> CuratorFramework <span class="title">newClient</span><span class="params">(String connectString, RetryPolicy retryPolicy)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> CuratorFramework <span class="title">newClient</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeoutMs, <span class="keyword">int</span> connectionTimeoutMs, RetryPolicy retryPolicy)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡è°ƒç”¨ <code>CuratorFramework</code> ä¸­çš„ <code>start()</code> æ–¹æ³•æ¥å¯åŠ¨ä¼šè¯ã€‚</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200151.png"></p><p>Curatoré€šè¿‡æ¥å£ <code>RetryPolicy</code> æ¥è®©ç”¨æˆ·è‡ªå®šä¹‰é‡è¯•ç­–ç•¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">allowRetry</span><span class="params">(<span class="keyword">int</span> retryCount, <span class="keyword">long</span> elapsedTimeMs, RetrySleeper sleeper)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200152.png"></p><p>ä½¿ç”¨Curatoråˆ›å»ºä¸€ä¸ªZKå®¢æˆ·ç«¯ä¼šè¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200153.png"></p><p><code>ExponentialBackoffRetry</code> æ˜¯é»˜è®¤é‡è¯•ç­–ç•¥ä¹‹ä¸€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExponentialBackoffRetry(<span class="keyword">int</span> baseSleepTimeMs, <span class="keyword">int</span> maxRetries);</span><br><span class="line">ExponentialBackoffRetry(<span class="keyword">int</span> baseSleepTimeMs, <span class="keyword">int</span> maxRetries, <span class="keyword">int</span> maxSleepMs);</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200154.png"></p><p>ç»™å®šä¸€ä¸ªåˆå§‹sleepæ—¶é—´baseSleepTimeMsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šç»“åˆé‡è¯•æ¬¡æ•°ï¼Œé€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—å‡ºå½“å‰éœ€è¦sleepçš„æ—¶é—´ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰sleepæ—¶é—´ = baseSleepTimeMs<span class="operator"> * </span><span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(<span class="number">1</span>, random.next<span class="constructor">Int(1 &lt;&lt; (<span class="params">retryCount</span> + 1)</span>))</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨Fluenté£æ ¼çš„APIæ¥å£åˆ›å»ºä¼šè¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200155.png"></p><p>ä½¿ç”¨Curatoråˆ›å»ºå«éš”ç¦»å‘½åç©ºé—´çš„ä¼šè¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®ç°ä¸åŒZKä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œéœ€è¦ç»™æ¯ä¸ªä¸šåŠ¡åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œå³æŒ‡å®šä¸€ä¸ªZKæ ¹è·¯å¾„ï¼š</span></span><br><span class="line">    CuratorFrameworkFactory.builder()</span><br><span class="line">                           .connectString(<span class="string">&quot;domain.book.zookeeper:2181&quot;</span>)</span><br><span class="line">                           .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                           .retryPolicy(retryPolicy)</span><br><span class="line">                           .namespace(<span class="string">&quot;base&quot;</span>)</span><br><span class="line">                           .build();</span><br></pre></td></tr></table></figure><h3 id="2-3-åˆ›å»ºèŠ‚ç‚¹"><a href="#2-3-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="2.3 åˆ›å»ºèŠ‚ç‚¹"></a>2.3 åˆ›å»ºèŠ‚ç‚¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CreateBuilder <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ProtectACLCreateModePathAndBytesable&lt;String&gt; <span class="title">creatingParentsIfNeeded</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateModable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withMode</span><span class="params">(CreateMode mode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆå§‹å†…å®¹ä¸ºç©º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé™„å¸¦åˆå§‹å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(path, <span class="string">&quot;init&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œåˆå§‹å†…å®¹ä¸ºç©º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().withMode(CreateMode.EPHEMERAL).forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶è‡ªåŠ¨é€’å½’åˆ›å»ºçˆ¶èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200156.png"></p><h3 id="2-4-åˆ é™¤èŠ‚ç‚¹"><a href="#2-4-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="2.4 åˆ é™¤èŠ‚ç‚¹"></a>2.4 åˆ é™¤èŠ‚ç‚¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeleteBuilder <span class="title">delete</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Versionable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withVersion</span><span class="params">(<span class="keyword">int</span> version)</span></span>;</span><br><span class="line"><span class="comment">// DeleteBuilder</span></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯æ‰§è¡Œä¸€ä¸ªåˆ é™¤èŠ‚ç‚¹çš„æ“ä½œï¼Œå¯èƒ½ç”±äºç½‘ç»œåŸå› å¯¼è‡´åˆ é™¤å¤±è´¥ï¼Œåœ¨æŸäº›åœºæ™¯ä¸­è¿™ç§å¼‚å¸¸æ˜¯è‡´å‘½çš„ï¼Œæ¯”å¦‚Masteré€‰ä¸¾ã€‚å½“è°ƒç”¨guaranteed()ï¼Œä¼šè®°å½•ä¸‹è¿™æ¬¡å¤±è´¥çš„åˆ é™¤æ“ä½œï¼Œåªè¦å®¢æˆ·ç«¯ä¼šè¯æœ‰æ•ˆï¼Œå°±ä¼šåœ¨åå°åå¤é‡è¯•ç›´åˆ°èŠ‚ç‚¹åˆ é™¤æˆåŠŸ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeleteBuilderBase <span class="title">guaranteed</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤æ¥å£åªèƒ½åˆ é™¤å¶å­èŠ‚ç‚¹</span></span><br><span class="line">client.delete().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶é€’å½’åˆ é™¤å…¶æ‰€æœ‰å­èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().deletingChildrenIfNeeded().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œåˆ é™¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().withVersion(version).forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶ä¿è¯åˆ é™¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.delete().guaranteed().forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200157.png"></p><h3 id="2-5-è¯»å–æ•°æ®"><a href="#2-5-è¯»å–æ•°æ®" class="headerlink" title="2.5 è¯»å–æ•°æ®"></a>2.5 è¯»å–æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GetDataBuilder <span class="title">getData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Statable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">storingStatIn</span><span class="params">(Stat stat)</span></span>;</span><br><span class="line"><span class="comment">// Pathable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›å€¼ä¸ºbyte[]</span></span><br><span class="line">client.getData().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è·å–åˆ°è¯¥èŠ‚ç‚¹çš„statï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Curatoré€šè¿‡ä¼ å…¥ä¸€ä¸ªæ—§çš„statå˜é‡çš„æ–¹å¼æ¥å­˜å‚¨æœåŠ¡ç«¯è¿”å›çš„æœ€æ–°çš„èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">client.getData().storingStatIn(stat).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200158.png"></p><h3 id="2-6-æ›´æ–°æ•°æ®"><a href="#2-6-æ›´æ–°æ•°æ®" class="headerlink" title="2.6 æ›´æ–°æ•°æ®"></a>2.6 æ›´æ–°æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CuratorFramework</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SetDataBuilder <span class="title">setData</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// Versionable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">withVersion</span><span class="params">(<span class="keyword">int</span> version)</span></span>;</span><br><span class="line"><span class="comment">// PathAndBytesable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path, <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">forPath</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure><ul><li><p>æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªstatå¯¹è±¡</span></span><br><span class="line">client.setData().forPath(path);</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œæ›´æ–°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// withVersionç”¨æ¥å®ç°CASï¼Œversioné€šå¸¸ç”±ä¸€ä¸ªæ—§çš„statå¯¹è±¡è·å–åˆ°</span></span><br><span class="line">client.setData().withVersion(version).forPath(path);</span><br></pre></td></tr></table></figure></li></ul><p>ç¤ºä¾‹ï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨æœ€æ–°çš„statå˜é‡è¿›è¡Œæ›´æ–°æ“ä½œï¼Œç¬¬äºŒæ¬¡åˆ™ä½¿ç”¨äº†è¿‡æœŸçš„statå˜é‡ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200159.png"></p><h3 id="2-7-å¼‚æ­¥æ¥å£"><a href="#2-7-å¼‚æ­¥æ¥å£" class="headerlink" title="2.7 å¼‚æ­¥æ¥å£"></a>2.7 å¼‚æ­¥æ¥å£</h3><p>ä»¥ä¸ŠAPIçš†ä¸ºCuratorçš„åŒæ­¥æ¥å£ï¼ŒCuratorå¼•å…¥äº† <code>BackgroundCallback</code> æ¥å£ï¼Œç”¨æ¥å¤„ç†å¼‚æ­¥æ¥å£è°ƒç”¨ä¹‹åæœåŠ¡ç«¯è¿”å›çš„ç»“æœä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BackgroundCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>client</td><td>å½“å‰å®¢æˆ·ç«¯å®ä¾‹</td></tr><tr><td>event</td><td>æœåŠ¡ç«¯äº‹ä»¶ï¼ŒCuratorEventå®šä¹‰äº†ZKæœåŠ¡ç«¯å‘é€åˆ°å®¢æˆ·ç«¯çš„ä¸€ç³»åˆ—äº‹ä»¶å‚æ•°</td></tr></tbody></table><p>CuratorEventä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><strong>äº‹ä»¶ç±»å‹ï¼ˆCuratorEventTypeï¼‰ï¼š</strong><code>getType()</code> ä»£è¡¨æœ¬æ¬¡äº‹ä»¶çš„ç±»å‹<ul><li>CREATEï¼š<code>CuratorFramework#create()</code></li><li>DELETEï¼š<code>CuratorFramework#delete()</code></li><li>EXISXTSï¼š<code>CuratorFramework#checkExists()</code></li><li>GET_DATAï¼š<code>CuratorFramework#getData()</code></li><li>SET_DATAï¼š<code>CuratorFramework#setData()</code></li><li>CHILDRENï¼š<code>CuratorFramework#getChildren()</code></li><li>SYNCï¼š<code>CuratorFramework#sync()</code></li><li>GET_ACLï¼š<code>CuratorFramework#getACL()</code></li><li>WATCHEDï¼š<code>Watchable#usingWatcher(Watcher) / Watchable#watched()</code></li><li>CLOSINGï¼šZKå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥æ–­å¼€äº‹ä»¶</li></ul></li><li><strong>å“åº”ç ï¼ˆintï¼‰ï¼š</strong>å®šä¹‰åœ¨<code>org.apache.zookeeper.KeeperException.Code</code> ä¸­ï¼Œå¸¸è§çš„æœ‰ï¼š<ul><li>0ï¼ˆOKï¼‰æ¥å£è°ƒç”¨æˆåŠŸ</li><li>-4ï¼ˆConnectionLossï¼‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥æ–­å¼€</li><li>-110ï¼ˆNodeExistsï¼‰æŒ‡å®šèŠ‚ç‚¹å·²å­˜åœ¨</li><li>-112ï¼ˆSessionExpiredï¼‰ä¼šè¯å·²è¿‡æœŸ</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Backgroudable&lt;T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(Object context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Object context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Executor executor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">inBackground</span><span class="params">(BackgroundCallback callback, Object context, Executor executor)</span></span>;</span><br></pre></td></tr></table></figure><p>åœ¨ZooKeeperä¸­ï¼Œæ‰€æœ‰å¼‚æ­¥é€šçŸ¥äº‹ä»¶å¤„ç†éƒ½ç”±EventThreadçº¿ç¨‹æ¥å¤„ç†ï¼Œå…¶ä¸²è¡Œå¤„ç†æœºåˆ¶åœ¨ç»å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯ä¸‹èƒ½å¤Ÿä¿è¯å¯¹äº‹ä»¶å¤„ç†çš„é¡ºåºæ€§ï¼Œä½†ä¹Ÿæœ‰å¼Šç«¯å°±æ˜¯ä¸€æ—¦ç¢°åˆ°ä¸€ä¸ªå¤æ‚çš„å¤„ç†å•å…ƒï¼Œå°±ä¼šæ¶ˆè€—è¿‡é•¿çš„å¤„ç†æ—¶é—´ï¼Œä»è€Œå½±å“åˆ°å¯¹å…¶ä»–äº‹ä»¶çš„å¤„ç†ã€‚å› æ­¤æ¥å£ä¼šè®©ç”¨æˆ·ä¼ å…¥ä¸€ä¸ªExecutorå®ä¾‹ï¼ŒæŠŠå¤æ‚çš„äº‹ä»¶å¤„ç†æ”¾åˆ°ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹æ± ä¸­ï¼Œå¦‚ <code>Executors.newFixedThreadPool(2)</code> ã€‚</p><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200160.png"></p><h3 id="2-8-å…¸å‹ä½¿ç”¨åœºæ™¯"><a href="#2-8-å…¸å‹ä½¿ç”¨åœºæ™¯" class="headerlink" title="2.8 å…¸å‹ä½¿ç”¨åœºæ™¯"></a>2.8 å…¸å‹ä½¿ç”¨åœºæ™¯</h3><p>å‚è€ƒæ¡ˆä¾‹éƒ½åœ¨recipesåŒ…ä¸­ï¼Œéœ€è¦å•ç‹¬å¼•å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ1ï¼‰äº‹ä»¶ç›‘å¬"><a href="#ï¼ˆ1ï¼‰äº‹ä»¶ç›‘å¬" class="headerlink" title="ï¼ˆ1ï¼‰äº‹ä»¶ç›‘å¬"></a>ï¼ˆ1ï¼‰äº‹ä»¶ç›‘å¬</h4><p>Curatorå¼•å…¥äº†Cacheæ¥å®ç°å¯¹ZKæœåŠ¡ç«¯äº‹ä»¶çš„ç›‘å¬ï¼ŒCacheå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæœ¬åœ°ç¼“å­˜è§†å›¾å’Œè¿œç¨‹ZooKeeperè§†å›¾çš„å¯¹æ¯”è¿‡ç¨‹ï¼ŒåŒæ—¶è‡ªåŠ¨å¤„ç†åå¤ç›‘å¬ã€‚<strong>Cacheåˆ†ä¸ºä¸¤ç§ï¼šèŠ‚ç‚¹ç›‘å¬ï¼ˆNodeCacheï¼‰å’Œå­èŠ‚ç‚¹ç›‘å¬ï¼ˆPathChildrenCacheï¼‰ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NodeCacheç”¨äºç›‘å¬æŒ‡å®šZKæ•°æ®èŠ‚ç‚¹æœ¬èº«çš„å˜åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NodeCache</span><span class="params">(CuratorFramework client, String path)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NodeCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NodeCacheå®šä¹‰äº†äº‹ä»¶å¤„ç†çš„å›è°ƒæ¥å£NodeCacheListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NodeCacheListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">voidnodeChanged</span><span class="params">()</span> throw Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>client</td><td>Curatorå®¢æˆ·ç«¯å®ä¾‹</td></tr><tr><td>path</td><td>æ•°æ®èŠ‚ç‚¹çš„èŠ‚ç‚¹è·¯å¾„</td></tr><tr><td>dataIsCompressed</td><td>æ˜¯å¦è¿›è¡Œæ•°æ®å‹ç¼©</td></tr></tbody></table><p>ç¤ºä¾‹ï¼š </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200161.png"></p><p><code>start()</code> æœ‰ä¸ªå¸ƒå°”ç±»å‹å‚æ•°ï¼Œé»˜è®¤ä¸ºfalseï¼Œå½“è®¾ç½®ä¸ºtrueæ—¶NodeCacheé¦–æ¬¡å¯åŠ¨ä¼šç«‹å³ä»ZKä¸Šè¯»å–å¯¹åº”èŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œå¹¶ä¿å­˜åœ¨Cacheä¸­ã€‚NodeCacheä¸ä»…å¯ä»¥ç”¨äºç›‘å¬æ•°æ®èŠ‚ç‚¹çš„å†…å®¹å˜æ›´ï¼Œä¹Ÿèƒ½ç›‘å¬èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚è‹¥åŸæœ¬èŠ‚ç‚¹ä¸å­˜åœ¨ï¼ŒCacheä¼šåœ¨èŠ‚ç‚¹åˆ›å»ºåè§¦å‘NodeCacheListenerã€‚</p><p><code>PathChildrenCache</code> ç”¨äºç›‘å¬æŒ‡å®šZKæ•°æ®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å˜åŒ–æƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> cacheData)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> cacheData, ThreadFactory threadFactory)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, ThreadFactory threadFactory)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, <span class="keyword">final</span> ExecutorService executorService)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PathChildrenCache</span><span class="params">(CuratorFramework client, String path, <span class="keyword">boolean</span> dataIsCompressed, <span class="keyword">final</span> CloseableExecutorService executorService)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶å¤„ç†çš„å›è°ƒæ¥å£ï¼Œå­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶å›è°ƒæ–¹æ³•ï¼Œäº‹ä»¶ç±»å‹åŒ…æ‹¬ï¼šæ–°å¢å­èŠ‚ç‚¹ã€æ•°æ®å˜æ›´ã€å­èŠ‚ç‚¹åˆ é™¤ä¸‰ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PathChildrenCacheListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200162.png"></p><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200163.png"></p><h4 id="ï¼ˆ2ï¼‰Masteré€‰ä¸¾"><a href="#ï¼ˆ2ï¼‰Masteré€‰ä¸¾" class="headerlink" title="ï¼ˆ2ï¼‰Masteré€‰ä¸¾"></a>ï¼ˆ2ï¼‰Masteré€‰ä¸¾</h4><p>åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸è§åœºæ™¯ï¼šä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œä»…éœ€ä»é›†ç¾¤ä¸­é€‰ä¸¾å‡ºä¸€å°ä»…éœ€å¤„ç†å³å¯ã€‚</p><p>å¤§è‡´æ€è·¯ï¼šé€‰æ‹©ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå¦‚ <code>/master_select</code> ï¼Œå¤šå°æœºå™¨åŒæ—¶å‘è¯¥èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå­èŠ‚ç‚¹ <code>/master_select/lock</code> æœ€ç»ˆåªæœ‰ä¸€å°æœºå™¨èƒ½åˆ›å»ºæˆåŠŸï¼Œå°±ç›¸å½“äºè¢«é€‰ä¸ºMasterã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200164.png"></p><p>ç›‘å¬å™¨ LeaderSelectorListenerAdapter éœ€è¦è‡ªè¡Œå®ç°ï¼ŒCuratorä¼šåœ¨æˆåŠŸè·å–Masteræƒåˆ©åå›è°ƒæ­¤ç›‘å¬å™¨ï¼šæ‰§è¡Œå®Œæ–¹æ³•ä¼šç«‹å³é‡Šæ”¾æƒåˆ©ï¼Œé‡æ–°å¼€å§‹ä¸‹ä¸€è½®é€‰ä¸¾</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200165.png"></p><h4 id="ï¼ˆ3ï¼‰åˆ†å¸ƒå¼é”"><a href="#ï¼ˆ3ï¼‰åˆ†å¸ƒå¼é”" class="headerlink" title="ï¼ˆ3ï¼‰åˆ†å¸ƒå¼é”"></a>ï¼ˆ3ï¼‰åˆ†å¸ƒå¼é”</h4><p>ä¸ºäº†ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒçš„æ•°æ®ä¸€è‡´ï¼Œéœ€è¦åœ¨ç¨‹åºæŸä¸ªè¿è¡ŒèŠ‚ç‚¹è¿›è¡ŒåŒæ­¥æ§åˆ¶ï¼Œæ¯”å¦‚ç”¨æ—¶é—´æˆ³æ¥ç”Ÿæˆæµæ°´å·ï¼Œä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºè¿™ç§å…¸å‹çš„å¹¶å‘é—®é¢˜ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200166.png"></p><p>å› ä¸ºæ²¡æœ‰åŒæ­¥å¯¼è‡´äº†ä¸Šè¿°çš„æ•°æ®é‡å¤é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨Curatoræ¥å®ç°åˆ†å¸ƒå¼é”ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200167.png"></p><h4 id="ï¼ˆ4ï¼‰åˆ†å¸ƒå¼è®¡æ•°å™¨"><a href="#ï¼ˆ4ï¼‰åˆ†å¸ƒå¼è®¡æ•°å™¨" class="headerlink" title="ï¼ˆ4ï¼‰åˆ†å¸ƒå¼è®¡æ•°å™¨"></a>ï¼ˆ4ï¼‰åˆ†å¸ƒå¼è®¡æ•°å™¨</h4><p>ç»Ÿè®¡ç³»ç»Ÿçš„åœ¨çº¿äººæ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªZKæ•°æ®èŠ‚ç‚¹ä½œä¸ºè®¡æ•°å™¨ï¼Œå¤šä¸ªåº”ç”¨å®ä¾‹åœ¨åˆ†å¸ƒå¼é”çš„æ§åˆ¶ä¸‹ï¼Œé€šè¿‡æ›´æ–°è¯¥æ•°æ®èŠ‚ç‚¹æ¥å®ç°è®¡æ•°ï¼ˆå¯ä»¥ç›´æ¥ä½¿ç”¨å°è£…çš„ DistributedAtomicIntegerï¼‰ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200168.png"></p><h4 id="ï¼ˆ5ï¼‰åˆ†å¸ƒå¼Barrier"><a href="#ï¼ˆ5ï¼‰åˆ†å¸ƒå¼Barrier" class="headerlink" title="ï¼ˆ5ï¼‰åˆ†å¸ƒå¼Barrier"></a>ï¼ˆ5ï¼‰åˆ†å¸ƒå¼Barrier</h4><p>Barrieræ˜¯ä¸€ç§ç”¨æ¥æ§åˆ¶å¤šçº¿ç¨‹ä¹‹é—´åŒæ­¥çš„ç»å…¸æ–¹æ³•ï¼ŒJDKè‡ªå¸¦CyclicBarrierå®ç°ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200169.png"></p><p>å¤šçº¿ç¨‹åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œéƒ½ä¼šå‡†ç¡®çš„ç­‰å¾…æ‰€æœ‰å…ˆéƒ½å¤„äºå°±ç»ªçŠ¶æ€åæ‰å¼€å§‹åŒæ—¶æ‰§è¡Œå…¶ä»–ä¸šåŠ¡é€»è¾‘ï¼Œä½†åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰å¤šä¸ªJVMï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨Curatoræä¾›çš„DistributedBarrierï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200170.png"></p><p>ä¸Šè¿°ä¸ºä¸»çº¿ç¨‹è§¦å‘Barrieré‡Šæ”¾ä¸åŒï¼ŒCuratorè¿˜æä¾›äº†å¦ä¸€ç§çº¿ç¨‹è‡ªå‘çš„è§¦å‘Barrieré‡Šæ”¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200171.png"></p><h4 id="ï¼ˆ6ï¼‰Curatoræä¾›çš„å·¥å…·"><a href="#ï¼ˆ6ï¼‰Curatoræä¾›çš„å·¥å…·" class="headerlink" title="ï¼ˆ6ï¼‰Curatoræä¾›çš„å·¥å…·"></a>ï¼ˆ6ï¼‰Curatoræä¾›çš„å·¥å…·</h4><p>è¾ƒå¸¸ç”¨çš„æœ‰ ZKPaths å’Œ EnsurePathï¼Œå‰è€…å¯ä»¥æ¥æ„å»ºZNodeè·¯å¾„ã€é€’å½’åˆ›å»ºå’Œåˆ é™¤èŠ‚ç‚¹ç­‰ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200172.png"></p><p>åè€…æä¾›äº†ä¸€ç§èƒ½ç¡®ä¿æ•°æ®èŠ‚ç‚¹å­˜åœ¨çš„æœºåˆ¶ï¼Œæœ‰äº›åœºæ™¯æˆ‘ä»¬è¦åšæŸäº›æ“ä½œå¿…é¡»å…ˆè¦ç¡®ä¿èŠ‚ç‚¹å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±è¦å…ˆåˆ›å»ºèŠ‚ç‚¹ï¼Œä½†åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¯èƒ½æœ‰å…¶ä»–æœºå™¨ä¹Ÿåœ¨å°è¯•åˆ›å»ºè¯¥èŠ‚ç‚¹ï¼Œå°±å¯¼è‡´æˆ‘ä»¬åˆ›å»ºæ—¶å¾—åˆ°â€œèŠ‚ç‚¹å·²å­˜åœ¨â€çš„å¼‚å¸¸ã€‚</p><p>EnsurePathé‡‡å–äº†é™é»˜çš„èŠ‚ç‚¹åˆ›å»ºæ–¹å¼ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200173.png"></p><h4 id="ï¼ˆ7ï¼‰å•å…ƒæµ‹è¯•-TestingServer"><a href="#ï¼ˆ7ï¼‰å•å…ƒæµ‹è¯•-TestingServer" class="headerlink" title="ï¼ˆ7ï¼‰å•å…ƒæµ‹è¯• TestingServer"></a>ï¼ˆ7ï¼‰å•å…ƒæµ‹è¯• TestingServer</h4><p>å¼•å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200174.png"></p><h4 id="ï¼ˆ8ï¼‰é›†ç¾¤æµ‹è¯•-TestingCluster"><a href="#ï¼ˆ8ï¼‰é›†ç¾¤æµ‹è¯•-TestingCluster" class="headerlink" title="ï¼ˆ8ï¼‰é›†ç¾¤æµ‹è¯• TestingCluster"></a>ï¼ˆ8ï¼‰é›†ç¾¤æµ‹è¯• TestingCluster</h4><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200175.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šZkClientçš„APIå’Œä½¿ç”¨ç¤ºä¾‹ï¼ŒCuratorçš„APIå’Œä½¿ç”¨ç¤ºä¾‹ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆäºŒï¼‰Javaå®¢æˆ·ç«¯API</title>
    <link href="http://linyishui.top/2021051501.html"/>
    <id>http://linyishui.top/2021051501.html</id>
    <published>2021-05-15T04:11:16.000Z</published>
    <updated>2021-07-18T15:36:34.011Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆäºŒï¼‰Javaå®¢æˆ·ç«¯API"><a href="#ZooKeeperï¼ˆäºŒï¼‰Javaå®¢æˆ·ç«¯API" class="headerlink" title="ZooKeeperï¼ˆäºŒï¼‰Javaå®¢æˆ·ç«¯API"></a>ZooKeeperï¼ˆäºŒï¼‰Javaå®¢æˆ·ç«¯API</h1><h2 id="ä¸€-åˆ›å»ºä¼šè¯"><a href="#ä¸€-åˆ›å»ºä¼šè¯" class="headerlink" title="ä¸€. åˆ›å»ºä¼šè¯"></a>ä¸€. åˆ›å»ºä¼šè¯</h2><p>é€šè¿‡æ„å»ºä¸€ä¸ªZooKeeperå¯¹è±¡æ¥åˆ›å»ºä¼šè¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œæ„é€ å‡½æ•°ä¼šåœ¨å¤„ç†å®Œå®¢æˆ·ç«¯åˆå§‹åŒ–åç«‹å³è¿”å›ï¼Œæ­¤æ—¶ä¼šè¯å¤„äºCONNECTINGçŠ¶æ€ã€‚ä¼šè¯çœŸæ­£åˆ›å»ºå®Œæ¯•åï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„é€ å‡½æ•°API</span></span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly);</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200115.png"></p><p>å®ä¾‹ä»£ç å¦‚å›¾ï¼šé‡å†™äº†processæ–¹æ³•è´Ÿè´£å¤„ç†æ”¶åˆ°çš„Watcheré€šçŸ¥ï¼Œæ”¶åˆ°æœåŠ¡ç«¯å‘é€çš„SyncConnectedäº‹ä»¶åï¼Œè§£é™¤ä¸»ç¨‹åºåœ¨CountDownLatchä¸Šçš„ç­‰å¾…é˜»å¡ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200116.png"></p><p>å¤ç”¨sessionIdï¼Œç»´æŒä¹‹å‰ä¼šè¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200117.png"></p><h2 id="äºŒ-åˆ›å»ºèŠ‚ç‚¹"><a href="#äºŒ-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="äºŒ. åˆ›å»ºèŠ‚ç‚¹"></a>äºŒ. åˆ›å»ºèŠ‚ç‚¹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ­¥åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="function">String <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl, CreateMode createMode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl, CreateMode createMode, StringCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p>ZooKeeperèŠ‚ç‚¹å†…å®¹åªæ”¯æŒå­—èŠ‚æ•°ç»„ç±»å‹ï¼ˆbyte[]ï¼‰ï¼Œå³ZooKeeperä¸è´Ÿè´£ä¸ºèŠ‚ç‚¹å†…å®¹è¿›è¡Œåºåˆ—åŒ–ï¼Œéœ€è¦å¼€å‘äººå‘˜è‡ªå·±ä½¿ç”¨åºåˆ—åŒ–å·¥å…·æ“ä½œã€‚</p><p>é»˜è®¤ä¸éœ€è¦å…³æ³¨æƒé™å‚æ•°ï¼Œåªéœ€åœ¨aclä¸­ä¼ å…¥ <code>Ids.OPEN_ACL_UNSAFE</code> ï¼Œè¡¨ç¤ºä¸å—æƒé™æ§åˆ¶ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200118.png"></p><p>åˆ›å»ºåŒæ­¥èŠ‚ç‚¹ï¼Œåˆ†åˆ«åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹å’Œä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ŒäºŒè€…è¿”å›å€¼ä¸ä¸€æ ·ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200119.png"></p><p>åˆ›å»ºå¼‚æ­¥èŠ‚ç‚¹ï¼Œåªéœ€è¦å®ç° <code>AsyncCallback.StringCallback()</code> æ¥å£å³å¯ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200120.png"></p><p>AsyncCallbackåŒ…æ‹¬ä¸ƒç§ä¸åŒçš„å›è°ƒæ¥å£ï¼š</p><ul><li>StatCallback</li><li>DataCallback</li><li>ACLCallback</li><li>ChildrenCallback</li><li>Children2Callback</li><li>StringCallback</li><li>VoidCallback</li></ul><p>åŒæ­¥æ¥å£è°ƒç”¨è¿‡ç¨‹éœ€è¦å…³æ³¨æŠ›å‡ºå¼‚å¸¸çš„å¯èƒ½ï¼Œå¼‚æ­¥æ¥å£æœ¬èº«ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œç´ æœ‰å¼‚å¸¸éƒ½åœ¨å›è°ƒå‡½æ•°ä¸­é€šè¿‡å“åº”ç ï¼ˆResult Codeï¼‰ä½“ç°ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200121.png"></p><h2 id="ä¸‰-åˆ é™¤èŠ‚ç‚¹"><a href="#ä¸‰-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="ä¸‰. åˆ é™¤èŠ‚ç‚¹"></a>ä¸‰. åˆ é™¤èŠ‚ç‚¹</h2><p>ZooKeeperåªå…è®¸åˆ é™¤å¶å­èŠ‚ç‚¹ï¼Œå³å¦‚æœèŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹å°±æ— æ³•è¢«ç›´æ¥åˆ é™¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version, VoidCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200122.png"></p><h2 id="å››-è¯»å–æ•°æ®"><a href="#å››-è¯»å–æ•°æ®" class="headerlink" title="å››. è¯»å–æ•°æ®"></a>å››. è¯»å–æ•°æ®</h2><h3 id="ï¼ˆ1ï¼‰getChildren"><a href="#ï¼ˆ1ï¼‰getChildren" class="headerlink" title="ï¼ˆ1ï¼‰getChildren"></a>ï¼ˆ1ï¼‰getChildren</h3><p>è·å–ä¸€ä¸ªèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Stat stat)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, Stat stat)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, Children2Callback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, Children2Callback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200123.png"></p><p>å½“æœ‰å­èŠ‚ç‚¹è¢«æ·»åŠ æˆ–åˆ é™¤æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª <code>NodeChildrenChanged(EventType.NodeChildrenChanged)</code> ç±»å‹çš„äº‹ä»¶é€šçŸ¥ã€‚è¦æ³¨æ„è¯¥é€šçŸ¥ä¸åŒ…å«æœ€æ–°çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå®¢æˆ·ç«¯å¿…é¡»ä¸»åŠ¨é‡æ–°è·å–ã€‚</p><p>ä½¿ç”¨åŒæ­¥æ¥å£è·å–å­èŠ‚ç‚¹åˆ—è¡¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200124.png"></p><p>æ³¨æ„ï¼ŒWatcheré€šçŸ¥æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä¸€æ—¦è§¦å‘ä¸€æ¬¡é€šçŸ¥ï¼Œè¯¥Watcherå°±å¤±æ•ˆäº†ï¼Œå› æ­¤å®¢æˆ·ç«¯éœ€è¦åå¤æ³¨å†ŒWatcherã€‚</p><p>ä½¿ç”¨å¼‚æ­¥æ¥å£è·å–å­èŠ‚ç‚¹åˆ—è¡¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200125.png"></p><p>å¼‚æ­¥æ¥å£ç»å¸¸è¢«åº”ç”¨åœ¨è¿™æ ·çš„ä½¿ç”¨åœºæ™¯ï¼šåº”ç”¨å¯åŠ¨æ—¶è·å–ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œå¦‚â€œæœºå™¨åˆ—è¡¨â€ï¼Œè¿™äº›é…ç½®é€šå¸¸è¾ƒå¤§ï¼Œå¹¶ä¸”ä¸å¸Œæœ›é…ç½®çš„è·å–å½±å“åº”ç”¨çš„ä¸»æµç¨‹ã€‚</p><h3 id="ï¼ˆ2ï¼‰getData"><a href="#ï¼ˆ2ï¼‰getData" class="headerlink" title="ï¼ˆ2ï¼‰getData"></a>ï¼ˆ2ï¼‰getData</h3><p>è·å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] getData(<span class="keyword">final</span> String path, Watcher watcher, Stat stat);</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] getData(String path, <span class="keyword">boolean</span> watcher, Stat stat);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, DataCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, DataCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200126.png"></p><p>å½“èŠ‚ç‚¹çš„çŠ¶æ€å‘ç”Ÿå˜æ›´ï¼ŒZooKeeperæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª <code>NodeDataChanged(EventType.NodeDataChanged)</code> çš„äº‹ä»¶é€šçŸ¥ã€‚èŠ‚ç‚¹çš„æ•°æ®å†…å®¹å’Œæ•°æ®ç‰ˆæœ¬å˜åŒ–éƒ½è¢«çœ‹ä½œæ˜¯èŠ‚ç‚¹çš„å˜åŒ–ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200127.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200128.png"></p><h2 id="äº”-æ›´æ–°æ•°æ®"><a href="#äº”-æ›´æ–°æ•°æ®" class="headerlink" title="äº”. æ›´æ–°æ•°æ®"></a>äº”. æ›´æ–°æ•°æ®</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Stat <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version, StatCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200129.png"></p><p><code>getData</code> è¯»å–æ•°æ®æ¥å£å¹¶æœªæä¾›æ ¹æ®æŒ‡å®šæ•°æ®ç‰ˆæœ¬æ¥è·å–æ•°æ®çš„æ¥å£ï¼Œ<code>setData</code> æ­¤å¤„çš„versionç±»ä¼¼äºCASæ¯”è¾ƒå¹¶äº¤æ¢åŸç†ï¼Œå¯¹åº”é¢„æœŸå€¼è¡¨ç¤ºé’ˆå¯¹æ­¤ç‰ˆæœ¬æ›´æ–°ï¼Œè¿™æ ·åœ¨ä¸€ä¸ªå®¢æˆ·ç«¯è¯»å–å¹¶ä¿®æ”¹ä¸­é—´å…¶ä»–å®¢æˆ·ç«¯çš„ä¿®æ”¹ä¼šä½¿è¿™æ¬¡ä¿®æ”¹æ— æ•ˆï¼Œä»è€Œé¿å…å¹¶å‘é—®é¢˜ã€‚</p><p>åˆ†åˆ«ä½¿ç”¨ä¸åŒçš„versionè¿›è¡Œäº†ä¸‰æ¬¡æ›´æ–°æ“ä½œï¼šæ•°æ®ç‰ˆæœ¬ä»0å¼€å§‹ï¼Œ-1éåˆæ³•çš„æ•°æ®ç‰ˆæœ¬ï¼Œè¿™é‡Œç”¨æ¥å‘Šè¯‰æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯è¦åŸºäºæœ€æ–°ç‰ˆæœ¬è¿›è¡Œæ›´æ–°æ“ä½œã€‚ç¬¬ä¸‰æ¬¡æ“ä½œä½¿ç”¨äº†ä¹‹å‰çš„æ•°æ®ç‰ˆæœ¬1æ‰€ä»¥å¯¼è‡´æ›´æ–°å¤±è´¥ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200130.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200131.png"></p><h2 id="å…­-æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨"><a href="#å…­-æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨" class="headerlink" title="å…­. æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨"></a>å…­. æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</h2><p>æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ªstatå¯¹è±¡ï¼Œå½“èŠ‚ç‚¹è¢«åˆ›å»ºã€è¢«åˆ é™¤æˆ–æ•°æ®è¢«æ›´æ–°ä¼šé€šè¿‡Watcheré€šçŸ¥å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> watcher)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher, StatCallback cb, Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> watcher, StatCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200132.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200133.png"></p><p>ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå…ˆåè¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><ol><li>é€šè¿‡existsæ¥å£æ£€æµ‹æ˜¯å¦å­˜åœ¨æŒ‡å®šèŠ‚ç‚¹ï¼ŒåŒæ—¶æ³¨å†Œäº†ä¸€ä¸ªWatcherã€‚</li><li>åˆ›å»ºèŠ‚ç‚¹/zk-bookï¼Œæ­¤æ—¶æœåŠ¡ç«¯é©¬ä¸Šä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ï¼šNodeCreatedã€‚å®¢æˆ·ç«¯æ”¶åˆ°è¯¥äº‹ä»¶é€šçŸ¥åï¼Œå†æ¬¡è°ƒç”¨existsæ¥å£ï¼ŒåŒæ—¶æ³¨å†ŒWatcherã€‚</li><li>æ›´æ–°è¯¥èŠ‚ç‚¹çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒæœåŠ¡ç«¯åˆä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ï¼šNodeDataChangedã€‚å®¢æˆ·ç«¯æ”¶åˆ°è¯¥äº‹ä»¶é€šçŸ¥åï¼Œç»§ç»­è°ƒç”¨existsæ¥å£ï¼ŒåŒæ—¶æ³¨å†ŒWatcherã€‚</li><li>åˆ›å»ºå­èŠ‚ç‚¹/zk-book/c1ã€‚</li><li>åˆ é™¤å­èŠ‚ç‚¹/zk-book/c1ã€‚</li><li>åˆ é™¤èŠ‚ç‚¹/zk-bookã€‚æ­¤æ—¶å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æœåŠ¡ç«¯çš„äº‹ä»¶é€šçŸ¥ï¼šNodeDeletedã€‚</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯ä»¥å¾—çŸ¥ï¼š</p><ul><li>æ— è®ºæŒ‡å®šèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œé€šè¿‡è°ƒç”¨existsæ¥å£éƒ½å¯ä»¥æ³¨å†ŒWatcherã€‚</li><li>existsæ¥å£ä¸­æ³¨å†Œçš„Watcherï¼Œèƒ½å¤Ÿå¯¹èŠ‚ç‚¹åˆ›å»ºã€èŠ‚ç‚¹åˆ é™¤å’ŒèŠ‚ç‚¹æ•°æ®æ›´æ–°äº‹ä»¶è¿›è¡Œç›‘å¬ã€‚</li><li>å¯¹äºæŒ‡å®šèŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å„ç§å˜åŒ–ï¼Œéƒ½ä¸ä¼šé€šçŸ¥å®¢æˆ·ç«¯ã€‚</li></ul><h2 id="ä¸ƒ-æƒé™æ§åˆ¶"><a href="#ä¸ƒ-æƒé™æ§åˆ¶" class="headerlink" title="ä¸ƒ. æƒé™æ§åˆ¶"></a>ä¸ƒ. æƒé™æ§åˆ¶</h2><p>é›†ç¾¤æ¨¡å¼ä¸‹çš„ZooKeeperï¼Œä¸åŒçš„åº”ç”¨ä¹‹é—´å¾€å¾€æ˜¯ä¸ä¼šå­˜åœ¨å…±äº«æ•°æ®çš„ä½¿ç”¨åœºæ™¯çš„ï¼Œå› æ­¤éœ€è¦è§£å†³ä¸åŒåº”ç”¨ä¹‹é—´çš„æƒé™é—®é¢˜ã€‚</p><p>é€šè¿‡è®¾ç½®æœåŠ¡ç«¯ä¸Šæ•°æ®èŠ‚ç‚¹çš„ACLï¼Œæ¥æ§åˆ¶å®¢æˆ·ç«¯å¯¹è¯¥èŠ‚ç‚¹çš„è®¿é—®æƒé™ã€‚ZooKeeperæä¾›äº†å¤šç§æƒé™æ§åˆ¶æ¨¡å¼ï¼š</p><ul><li>world</li><li>auth</li><li>digestï¼šä¸»è¦è®²è§£è¯¥æ¨¡å¼</li><li>ip</li><li>super</li></ul><p>å®¢æˆ·ç«¯åœ¨ä¼šè¯åˆ›å»ºåï¼Œè°ƒç”¨ <code>addAuthInfo(String scheme, byte[] auth)</code> æ¥å£è¿›è¡Œæƒé™ä¿¡æ¯çš„è®¾ç½®ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200134.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200135.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200136.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200137.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200139.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šåˆ›å»ºä¼šè¯ã€èŠ‚ç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼Œè¯»å–ã€æ›´æ–°æ•°æ®ï¼Œæ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œæƒé™æ§åˆ¶ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeperï¼ˆä¸€ï¼‰æ¦‚è¿°å’ŒZABåè®®</title>
    <link href="http://linyishui.top/2021051001.html"/>
    <id>http://linyishui.top/2021051001.html</id>
    <published>2021-05-10T13:27:05.000Z</published>
    <updated>2021-07-18T15:36:46.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeperï¼ˆä¸€ï¼‰æ¦‚è¿°å’ŒZABåè®®"><a href="#ZooKeeperï¼ˆä¸€ï¼‰æ¦‚è¿°å’ŒZABåè®®" class="headerlink" title="ZooKeeperï¼ˆä¸€ï¼‰æ¦‚è¿°å’ŒZABåè®®"></a>ZooKeeperï¼ˆä¸€ï¼‰æ¦‚è¿°å’ŒZABåè®®</h1><h2 id="ä¸€-æ¦‚è¿°"><a href="#ä¸€-æ¦‚è¿°" class="headerlink" title="ä¸€. æ¦‚è¿°"></a>ä¸€. æ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯ZooKeeperï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯ZooKeeperï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ZooKeeperï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯ZooKeeperï¼Ÿ</h3><ul><li>Apache ZooKeeper ç”± Apache Hadoop å­é¡¹ç›®å‘å±•è€Œæ¥ã€‚</li><li>ZooKeeperæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œç”±é›…è™åˆ›å»ºï¼ŒGoogle Chubby çš„å¼€æºå®ç°ã€‚</li><li>è®¾è®¡ç›®æ ‡æ˜¯å°†é‚£äº›å¤æ‚æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</li><li>ZooKeeper ä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›äº†é«˜æ•ˆä¸”å¯é çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†è¯¸å¦‚<strong>ç»Ÿä¸€å‘½åæœåŠ¡</strong>ã€<strong>é…ç½®å…³è”</strong>å’Œ<strong>åˆ†å¸ƒå¼é”</strong>ç­‰åˆ†å¸ƒå¼çš„åŸºç¡€æœåŠ¡ã€‚</li><li>ZooKeeperå¹¶æ²¡æœ‰ç›´æ¥é‡‡ç”¨ Paxos ç®—æ³•ï¼Œè€Œæ˜¯ä¸€ç§è¢«ç§°ä¸º ZABï¼ˆZooKeeper Atomic Broadcastï¼‰çš„ä¸€è‡´æ€§åè®®ã€‚</li></ul><p>ZooKeeper æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåº”ç”¨å¯ä»¥åŸºäºå®ƒå®ç°è¯¸å¦‚<strong>æ•°æ®å‘å¸ƒ/è®¢é˜…</strong>ã€<strong>è´Ÿè½½å‡è¡¡</strong>ã€<strong>å‘½åæœåŠ¡</strong>ã€<strong>åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥</strong>ã€<strong>é›†ç¾¤ç®¡ç†</strong>ã€<strong>Masteré€‰ä¸¾</strong>ã€<strong>åˆ†å¸ƒå¼é”</strong>å’Œ<strong>åˆ†å¸ƒå¼é˜Ÿåˆ—</strong>ç­‰åŠŸèƒ½ã€‚</p><h3 id="1-2-ç‰¹æ€§"><a href="#1-2-ç‰¹æ€§" class="headerlink" title="1.2 ç‰¹æ€§"></a>1.2 ç‰¹æ€§</h3><ul><li><strong>é¡ºåºä¸€è‡´æ€§ï¼š</strong>ä»åŒä¸€å®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œå°†ä¼šä¸¥æ ¼çš„æŒ‰ç…§å‘é€é¡ºåºè¢«åº”ç”¨åˆ°ZooKeeperä¸­ã€‚</li><li><strong>åŸå­æ€§ï¼š</strong>æ‰€æœ‰äº‹åŠ¡è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œè¦ä¹ˆæ•´ä¸ªé›†ç¾¤æ‰€æœ‰æœºå™¨éƒ½æˆåŠŸåº”ç”¨äº†æŸä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ã€‚</li><li><strong>å•ä¸€è§†å›¾ï¼š</strong>æ— è®ºå®¢æˆ·ç«¯è¿æ¥å“ªä¸ªZooKeeperæœåŠ¡å™¨ï¼Œçœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚</li><li><strong>å¯é æ€§ï¼š</strong>ä¸€æ—¦æœåŠ¡ç«¯æˆåŠŸåº”ç”¨äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å®Œæˆå¯¹å®¢æˆ·ç«¯çš„å“åº”ï¼Œäº‹åŠ¡å¼•èµ·çš„æœåŠ¡ç«¯çŠ¶æ€ä¸€ç›´ä¿ç•™åˆ°ä¸‹ä¸ªäº‹åŠ¡è¿›è¡Œå˜æ›´ã€‚</li><li><strong>å®æ—¶æ€§ï¼š</strong>ZooKeeperä»…ä¿è¯åœ¨ä¸€å®šæ—¶é—´æ®µå†…ï¼Œå®¢æˆ·ç«¯æœ€ç»ˆä¸€å®šèƒ½å¤Ÿä»æœåŠ¡ç«¯è¯»å–åˆ°æœ€æ–°çš„æ•°æ®çŠ¶æ€ã€‚</li></ul><h3 id="1-3-è®¾è®¡ç›®æ ‡"><a href="#1-3-è®¾è®¡ç›®æ ‡" class="headerlink" title="1.3 è®¾è®¡ç›®æ ‡"></a>1.3 è®¾è®¡ç›®æ ‡</h3><ol><li><strong>ç®€å•çš„æ•°æ®æ¨¡å‹ï¼š</strong>åˆ†å¸ƒå¼ç¨‹åºé€šè¿‡ä¸€ä¸ªå…±äº«çš„ã€æ ‘å‹ç»“æ„çš„åå­—ç©ºé—´æ¥ç›¸äº’åè°ƒ</li><li><strong>å¯ä»¥æ„å»ºé›†ç¾¤ï¼š</strong>ä¸€èˆ¬3~5å°æœºå™¨å¯ä»¥ç»„æˆä¸€ä¸ªå¯ç”¨çš„ZooKeeperé›†ç¾¤ï¼Œæ¯å°æœºå™¨éƒ½ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤å½“å‰çš„æœåŠ¡å™¨çŠ¶æ€ï¼Œæœºå™¨ä¹‹é—´äº’ç›¸éƒ½ä¿æŒç€é€šä¿¡ã€‚ZooKeeperå®¢æˆ·ç«¯ä¼šä¸ä»»æ„ä¸€å°æœºå™¨åˆ›å»ºä¸€ä¸ªTCPè¿æ¥ï¼Œä¸€æ—¦è¿æ¥æ–­å¼€ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¿æ¥åˆ°å…¶ä»–æœºå™¨ã€‚</li><li><strong>é¡ºåºè®¿é—®ï¼š</strong>ZooKeeperä¸ºå®¢æˆ·ç«¯çš„æ¯ä¸ªæ›´æ–°è¯·æ±‚åˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„é€’å¢ç¼–å·ï¼Œåæ˜ äº†äº‹åŠ¡æ“ä½œçš„å…ˆåé¡ºåºã€‚</li><li><strong>é«˜æ€§èƒ½ï¼š</strong>ZooKeeperå°†å…¨é‡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥æœåŠ¡äºå®¢æˆ·ç«¯çš„æ‰€æœ‰éäº‹åŠ¡è¯·æ±‚ï¼Œéå¸¸é€‚åˆäºè¯»æ“ä½œä¸ºä¸»çš„åœºæ™¯ã€‚</li></ol><h3 id="1-4-æ ¸å¿ƒæ¦‚å¿µ"><a href="#1-4-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1.4 æ ¸å¿ƒæ¦‚å¿µ"></a>1.4 æ ¸å¿ƒæ¦‚å¿µ</h3><ul><li><p><strong>é›†ç¾¤è§’è‰²ï¼š</strong></p><ul><li>æœ€å…¸å‹çš„é›†ç¾¤æ¨¡å¼æ˜¯Master/Slaveï¼ˆä¸»å¤‡æ¨¡å¼ï¼‰ï¼Œèƒ½å¤Ÿå¤„ç†æ‰€æœ‰å†™æ“ä½œçš„æ˜¯Masteræœºå™¨ï¼Œæ‰€æœ‰é€šè¿‡å¼‚æ­¥å¤åˆ¶æ–¹å¼è·å–æœ€æ–°æ•°æ®ï¼Œå¹¶æä¾›è¯»æœåŠ¡çš„æœºå™¨æ˜¯Slaveæœºå™¨ã€‚</li><li>ZooKeeperå¹¶æ²¡æœ‰é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œè€Œæ˜¯å¼•å…¥äº†æ–°çš„ä¸‰ä¸ªè§’è‰²ï¼š<ul><li><strong>Leaderï¼š</strong>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨é€šè¿‡é€‰ä¸¾è¿‡ç¨‹é€‰å®šä¸€ä¸ªLeaderï¼Œå…¶ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å’Œå†™æœåŠ¡ã€‚</li><li><strong>Followerï¼š</strong>æä¾›è¯»æœåŠ¡ã€‚</li><li><strong>Observerï¼š</strong>æä¾›è¯»æœåŠ¡ï¼Œä¸å‚ä¸Leaderé€‰ä¸¾è¿‡ç¨‹ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼Œå› æ­¤Observerå¯ä»¥åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æé«˜é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚</li></ul></li></ul></li><li><p><strong>ä¼šè¯ï¼ˆSessionï¼‰ï¼š</strong></p><ul><li>åœ¨ZooKeeperä¸­ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ˜¯æŒ‡å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€ä¸ªTCPé•¿è¿æ¥ã€‚</li><li>ZooKeeperå¯¹å¤–çš„æœåŠ¡ç«¯å£é»˜è®¤æ˜¯2181ï¼Œå®¢æˆ·ç«¯å¯åŠ¨æ—¶é¦–å…ˆä¼šä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œä»ç¬¬ä¸€æ¬¡è¿æ¥å»ºç«‹å¼€å§‹ï¼Œå®¢æˆ·ç«¯ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå¼€å§‹ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªè¿æ¥è¿›è¡Œå¿ƒè·³æ£€æµ‹ä¸æœåŠ¡å™¨ä¿æŒæœ‰æ•ˆçš„ä¼šè¯ï¼Œä¹Ÿèƒ½å¤Ÿå‘ZooKeeperæœåŠ¡å™¨å‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ï¼ŒåŒæ—¶è¿˜èƒ½é€šè¿‡è¯¥è¿æ¥æ¥æ”¶æœåŠ¡å™¨çš„Watchäº‹ä»¶é€šçŸ¥ã€‚</li><li>sessionTimeoutå€¼ç”¨æ¥è®¾ç½®ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚å› æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€ç½‘ç»œæ•…éšœæˆ–å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ç­‰å¯¼è‡´çš„è¿æ¥æ–­å¼€ï¼Œåªè¦åœ¨sessionTimeoutè§„å®šæ—¶é—´å†…é‡æ–°è¿ä¸Šä¸€å°æœåŠ¡å™¨ï¼Œä¹‹å‰åˆ›å»ºçš„ä¼šè¯ä»ä¼šæœ‰æ•ˆã€‚</li></ul></li><li><p><strong>æ•°æ®èŠ‚ç‚¹ï¼ˆZNodeï¼‰ï¼š</strong>åˆ†å¸ƒå¼ä¸­èŠ‚ç‚¹å³æ¯å°æœºå™¨ï¼Œåœ¨ZooKeeperä¸­ï¼ŒèŠ‚ç‚¹åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>æœºå™¨èŠ‚ç‚¹ï¼š</strong>æ„æˆé›†ç¾¤çš„æœºå™¨</li><li><strong>æ•°æ®èŠ‚ç‚¹ï¼š</strong>æ•°æ®æ¨¡å‹ä¸­çš„æ•°æ®å•å…ƒï¼Œå³ZNodeï¼Œåˆå¯ä»¥åˆ†ä¸º<ul><li><strong>æŒä¹…èŠ‚ç‚¹ï¼š</strong>ä¸€æ—¦æ­¤ZNodeè¢«åˆ›å»ºï¼Œé™¤éä¸»åŠ¨è¿›è¡Œç§»é™¤æ“ä½œï¼Œå¦åˆ™å°†ä¸€ç›´ä¿å­˜ã€‚</li><li><strong>ä¸´æ—¶èŠ‚ç‚¹ï¼š</strong>ç”Ÿå‘½å‘¨æœŸå’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šï¼Œä¸€æ—¦å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œè¯¥å®¢æˆ·ç«¯åˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹éƒ½ä¼šè¢«ç§»é™¤ã€‚</li></ul></li></ul><p>æ•°æ®æ¨¡å‹æ˜¯ä¸€æ£µæ ‘ï¼Œç”±æ–œæ ï¼ˆ<code>/</code>ï¼‰è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ªZNodeï¼Œå¦‚ <code>/foo/path1</code> ã€‚æ¯ä¸ªZNodeä¸Šéƒ½ä¼šä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼Œä»¥åŠä¸€ç³»åˆ—å±æ€§ä¿¡æ¯ã€‚</p><p>ZooKeeperå…è®¸ç”¨æˆ·ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼šSEQUENTIALï¼Œå½“èŠ‚ç‚¹æ ‡è®°æ­¤å±æ€§ï¼Œåœ¨èŠ‚ç‚¹åˆ›å»ºæ—¶ä¼šè‡ªåŠ¨åœ¨èŠ‚ç‚¹ååè¿½åŠ ä¸€ä¸ªç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤çš„è‡ªå¢æ•´å‹æ•°å­—ã€‚</p></li><li><p><strong>ç‰ˆæœ¬ï¼š</strong>ZooKeeperçš„æ¯ä¸ªZNodeéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªå«åš <strong>Stat</strong> çš„æ•°æ®ç»“æ„ï¼ŒStatä¸­è®°å½•äº†èŠ‚ç‚¹çš„ä¸‰ä¸ªæ•°æ®ç‰ˆæœ¬ï¼š</p><ul><li>versionï¼šå½“å‰ZNodeçš„ç‰ˆæœ¬</li><li>cversionï¼šå½“å‰ZNodeå­èŠ‚ç‚¹çš„ç‰ˆæœ¬</li><li>aversionï¼šå½“å‰ZNodeçš„ACLç‰ˆæœ¬</li></ul></li><li><p><strong>Watcherï¼š</strong>å³äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº›Watcherï¼Œåœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶ï¼ŒZooKeeperæœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šã€‚</p></li><li><p><strong>ACLï¼š</strong>ZooKeeperé‡‡ç”¨ Access Control Lists ç­–ç•¥æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼Œç±»ä¼¼äºUNIXæ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ§åˆ¶ï¼Œå®šä¹‰äº†5ç§æƒé™ï¼š</p><ul><li><strong>CREATEï¼š</strong>åˆ›å»ºå­èŠ‚ç‚¹çš„æƒé™</li><li><strong>READï¼š</strong>è·å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨çš„æƒé™</li><li><strong>WRITEï¼š</strong>æ›´æ–°èŠ‚ç‚¹æ•°æ®çš„æƒé™</li><li><strong>DELETEï¼š</strong>åˆ é™¤å­èŠ‚ç‚¹çš„æƒé™</li><li><strong>ADMINï¼š</strong>è®¾ç½®èŠ‚ç‚¹ACLçš„æƒé™</li></ul></li></ul><h2 id="äºŒ-ZAB-åè®®"><a href="#äºŒ-ZAB-åè®®" class="headerlink" title="äºŒ. ZAB åè®®"></a>äºŒ. ZAB åè®®</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯ZABåè®®ï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯ZABåè®®ï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯ZABåè®®ï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯ZABåè®®ï¼Ÿ</h3><p>ZooKeeperå¹¶æ²¡æœ‰å®Œå…¨é‡‡ç”¨ Paxos ç®—æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªç§°ä¸º ZooKeeper Atomic Broadcastï¼ˆZABï¼ŒZooKeeper<strong>åŸå­æ¶ˆæ¯å¹¿æ’­åè®®</strong>ï¼‰çš„åè®®æ¥ä½œä¸ºå…¶æ•°æ®ä¸€è‡´æ€§çš„æ ¸å¿ƒç®—æ³•ã€‚</p><p>ZABåè®®æ˜¯ä¸€ç§æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ï¼Œæœ€åˆåªæ˜¯ä¸ºé›…è™å…¬å¸å†…éƒ¨ä¸€äº›<strong>é«˜ååé‡ã€ä½å»¶è¿Ÿã€å¥å£®ã€ç®€å•</strong>çš„åˆ†å¸ƒå¼ç³»ç»Ÿåœºæ™¯è®¾è®¡çš„ï¼Œå¹¶ä¸åƒPaxosç®—æ³•é‚£æ ·é€šç”¨å’Œå¯æ‰©å±•ã€‚</p><p>åŸºäºè¯¥åè®®ï¼ŒZooKeeperå®ç°äº†ä¸€ç§<strong>ä¸»å¤‡æ¨¡å¼</strong>çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„å‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚ZooKeeperä½¿ç”¨ä¸€ä¸ªå•ä¸€çš„ä¸»è¿›ç¨‹æ¥æ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯æ‰€æœ‰çš„äº‹åŠ¡è¯·æ±‚ï¼Œé€šè¿‡ZABçš„åŸå­å¹¿æ’­åè®®å°†æœåŠ¡å™¨çš„æ•°æ®çŠ¶æ€ä»¥äº‹åŠ¡Proposalçš„å½¢å¼å¹¿æ’­åˆ°æ‰€æœ‰çš„å‰¯æœ¬è¿›ç¨‹ã€‚è¯¥ä¸»å¤‡æ¨¡å‹ä¿è¯äº†<strong>åŒä¸€æ—¶åˆ»é›†ç¾¤ä¸­åªèƒ½æœ‰ä¸€ä¸ªä¸»è¿›ç¨‹æ¥å¹¿æ’­æœåŠ¡å™¨çš„çŠ¶æ€å˜æ›´</strong>ï¼Œå› æ­¤èƒ½å¤Ÿå¾ˆå¥½çš„å¤„ç†å®¢æˆ·ç«¯å¤§é‡çš„å¹¶å‘è¯·æ±‚ã€‚å¹¶ä¸”<strong>æ”¯æŒåˆ†å¸ƒå¼ç¯å¢ƒä¸­å¯¹äºé¡ºåºçŠ¶æ€çš„éœ€æ±‚</strong>ï¼ˆæœ‰äº›çŠ¶æ€å˜æ›´å¿…é¡»ä¾èµ–äºæ¯”å®ƒæ—©ç”Ÿæˆçš„çŠ¶æ€å˜æ›´ï¼‰ï¼Œä¿è¯äº†ä¸€ä¸ªå…¨å±€çš„å˜æ›´åºåˆ—è¢«é¡ºåºåº”ç”¨ã€‚å› ä¸ºä¸»è¿›ç¨‹éšæ—¶å¯èƒ½å´©æºƒæˆ–é‡å¯ï¼Œè¿˜è¦åšåˆ°ä¸»è¿›ç¨‹æœ‰é—®é¢˜æ—¶ä»èƒ½æ­£å¸¸å·¥ä½œã€‚</p><p>æ‰€æœ‰äº‹åŠ¡è¯·æ±‚å¿…é¡»ç”±ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æœåŠ¡å™¨æ¥åè°ƒå¤„ç†ï¼Œå³LeaderæœåŠ¡å™¨ï¼Œä½™ä¸‹çš„æœåŠ¡å™¨æˆä¸ºFolloweræœåŠ¡å™¨ã€‚LeaderæœåŠ¡å™¨è´Ÿè´£å°†ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡è¯·æ±‚è½¬æ¢ä¸ºä¸€ä¸ªäº‹åŠ¡ Proposalï¼ˆæè®®ï¼‰ï¼Œå¹¶å°†è¯¥æè®®åˆ†å‘ç»™é›†ç¾¤ä¸­æ‰€æœ‰çš„FolloweræœåŠ¡å™¨ã€‚ä¹‹åLeaderæœåŠ¡å™¨ç­‰å¾…æ‰€æœ‰FolloweræœåŠ¡å™¨çš„åé¦ˆï¼Œä¸€æ—¦è¶…è¿‡åŠæ•°è¿›è¡Œäº†æ­£ç¡®çš„åé¦ˆï¼ŒLeaderæœåŠ¡å™¨å†æ¬¡å‘æ‰€æœ‰çš„FolloweræœåŠ¡å™¨åˆ†å‘Commitæ¶ˆæ¯ï¼Œè¦æ±‚å°†å‰ä¸€ä¸ªæè®®æäº¤ã€‚</p><h3 id="2-2-åè®®ä»‹ç»"><a href="#2-2-åè®®ä»‹ç»" class="headerlink" title="2.2 åè®®ä»‹ç»"></a>2.2 åè®®ä»‹ç»</h3><p>ZABåè®®åŒ…å«ä¸¤ç§åŸºæœ¬æ¨¡å¼ï¼š</p><ul><li><strong>å´©æºƒæ¢å¤ï¼š</strong><ul><li>å½“æ•´ä¸ªæœåŠ¡æ¡†æ¶åœ¨å¯åŠ¨è¿‡ç¨‹ï¼Œæˆ–æ˜¯LeaderæœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼ŒZABè¿›å…¥è¯¥æ¨¡å¼é€‰ä¸¾äº§ç”Ÿæ–°çš„LeaderæœåŠ¡å™¨ã€‚</li><li>é€‰å‡ºæ–°çš„Leaderï¼Œä¸”é›†ç¾¤ä¸­å·²æœ‰è¿‡åŠçš„æœºå™¨ä¸æ–°çš„Leaderå®ŒæˆçŠ¶æ€åŒæ­¥ï¼ˆæŒ‡æ•°æ®åŒæ­¥ï¼Œç”¨æ¥ä¿è¯è¿‡åŠæœºå™¨ä¸Leaderä¿æŒä¸€è‡´ï¼‰ä¹‹åï¼ŒZABé€€å‡ºè¯¥æ¨¡å¼ã€‚</li></ul></li><li><strong>æ¶ˆæ¯å¹¿æ’­ï¼š</strong><ul><li>é›†ç¾¤ä¸­æœ‰è¿‡åŠçš„FolloweræœåŠ¡å™¨å®Œæˆäº†ä¸LeaderæœåŠ¡å™¨çš„çŠ¶æ€åŒæ­¥ï¼ŒæœåŠ¡æ¡†æ¶è¿›å…¥è¯¥æ¨¡å¼ã€‚</li><li>å½“ä¸€å°éµå®ˆZABåè®®çš„æœåŠ¡å™¨å¯åŠ¨å¹¶åŠ å…¥é›†ç¾¤æ—¶ï¼Œè‹¥æ­¤æ—¶å·²å­˜åœ¨LeaderæœåŠ¡å™¨ï¼Œå®ƒä¼šè‡ªè§‰çš„è¿›å…¥æ•°æ®æ¢å¤æ¨¡å¼ï¼šæ‰¾åˆ°Leaderæ‰€åœ¨æœåŠ¡å™¨ï¼Œå¹¶ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œç„¶åä¸€èµ·å‚ä¸åˆ°æ¶ˆæ¯å¹¿æ’­æµç¨‹ä¸­ã€‚</li></ul></li></ul><h4 id="ï¼ˆ1ï¼‰æ¶ˆæ¯å¹¿æ’­"><a href="#ï¼ˆ1ï¼‰æ¶ˆæ¯å¹¿æ’­" class="headerlink" title="ï¼ˆ1ï¼‰æ¶ˆæ¯å¹¿æ’­"></a>ï¼ˆ1ï¼‰æ¶ˆæ¯å¹¿æ’­</h4><p>æ¶ˆæ¯å¹¿æ’­çš„è¿‡ç¨‹ç±»ä¼¼äºäºŒé˜¶æ®µæäº¤ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200111.png"></p><p>ZABæ²¡æœ‰ä¸­æ–­é€»è¾‘ï¼Œæ‰€ä»¥FolloweræœåŠ¡å™¨åé¦ˆAckåå°±å¯ä»¥æäº¤äº‹åŠ¡Proposalï¼Œè¿™ç§ç®€åŒ–æ¨¡å‹è‡ªç„¶å­˜åœ¨Leaderå•ç‚¹æ•…éšœå¼•èµ·çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚ZABåè®®é€šè¿‡å´©æºƒæ¢å¤æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æ•´ä¸ªæ¶ˆæ¯å¹¿æ’­åè®®åŸºäºå…·æœ‰FIFOç‰¹æ€§çš„TCPåè®®æ¥è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œå¾ˆå®¹æ˜“ä¿è¯æ¶ˆæ¯æ¥æ”¶å’Œå‘é€çš„é¡ºåºæ€§ã€‚Leaderä¸ºæ¯ä¸ªäº‹åŠ¡Proposalåˆ†é…ä¸€ä¸ªå…¨å±€å•è°ƒé€’å¢çš„äº‹åŠ¡IDï¼ˆZXIDï¼‰ï¼Œæ¯ä¸ªäº‹åŠ¡æŒ‰ç…§ZXIDçš„å…ˆåé¡ºåºè¿›è¡Œæ’åºå’Œå¤„ç†ã€‚</p><p>LeaderæœåŠ¡å™¨ä¸ºæ¯ä¸ªFolloweræœåŠ¡å™¨å„è‡ªåˆ†é…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†éœ€è¦å¹¿æ’­çš„äº‹åŠ¡Proposalä¾æ¬¡æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œæ ¹æ®FIFOçš„ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚æ¯ä¸ªFolloweræœåŠ¡å™¨æ”¶åˆ°äº‹åŠ¡Proposalåï¼Œé¦–å…ˆä»¥äº‹åŠ¡æ—¥å¿—çš„å½¢å¼å†™å…¥åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œåœ¨æˆåŠŸå†™å…¥ååé¦ˆç»™Leaderä¸€ä¸ªAckå“åº”ã€‚æ”¶åˆ°è¶…è¿‡åŠæ•°çš„Ackå“åº”åï¼ŒLeaderä¼šå¹¿æ’­ä¸€ä¸ªCommitæ¶ˆæ¯ç»™æ‰€æœ‰FolloweræœåŠ¡å™¨ä»¥é€šçŸ¥è¿›è¡Œäº‹åŠ¡æäº¤ï¼ŒåŒæ—¶Leaderå®Œæˆè‡ªå·±çš„äº‹åŠ¡æäº¤ã€‚</p><h4 id="ï¼ˆ2ï¼‰å´©æºƒæ¢å¤"><a href="#ï¼ˆ2ï¼‰å´©æºƒæ¢å¤" class="headerlink" title="ï¼ˆ2ï¼‰å´©æºƒæ¢å¤"></a>ï¼ˆ2ï¼‰å´©æºƒæ¢å¤</h4><p>è¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼åï¼Œéœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„LeaderæœåŠ¡å™¨ï¼Œè¿™éœ€è¦ä¸€ä¸ªé«˜æ•ˆä¸”å¯é çš„é€‰ä¸¾ç®—æ³•ï¼Œä¸ä»…éœ€è¦è®©æ–°Leaderè‡ªå·±çŸ¥é“å·²è¢«é€‰ä¸¾ä¸ºLeaderï¼Œè¿˜è¦è®©é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨å¿«é€Ÿæ„ŸçŸ¥åˆ°è¿™ç‚¹ã€‚</p><p><strong>ZABåè®®è¦ç¡®ä¿é‚£äº›å·²ç»åœ¨LeaderæœåŠ¡å™¨ä¸Šæäº¤çš„äº‹åŠ¡æœ€ç»ˆè¢«æ‰€æœ‰æœåŠ¡å™¨æäº¤ã€‚</strong></p><p>å‡è®¾ä¸€ä¸ªäº‹åŠ¡å·²åœ¨LeaderæœåŠ¡å™¨æäº¤ï¼Œä½†åœ¨å°†Commitæ¶ˆæ¯å‘é€ç»™æ‰€æœ‰Followerä¹‹å‰ï¼ŒLeaderæŒ‚æ‰äº†ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200112.png"></p><p><strong>ZABåè®®è¦ç¡®ä¿ä¸¢å¼ƒé‚£äº›åªåœ¨LeaderæœåŠ¡å™¨ä¸Šè¢«æå‡ºçš„äº‹åŠ¡ã€‚</strong></p><p>ç›¸åï¼Œåœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­å‡ºç°ä¸€ä¸ªéœ€è¦è¢«ä¸¢å¼ƒçš„ææ¡ˆï¼Œåœ¨å´©æºƒæ¢å¤ç»“æŸåéœ€è¦è·³è¿‡è¯¥äº‹åŠ¡Proposalï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200113.png"></p><p>é’ˆå¯¹ä»¥ä¸Šä¸¤ç‚¹ï¼Œå¦‚æœLeaderé€‰ä¸¾ç®—æ³•èƒ½å¤Ÿä¿è¯æ–°é€‰ä¸¾å‡ºæ¥çš„LeaderæœåŠ¡å™¨æ‹¥æœ‰é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨æœ€é«˜ç¼–å·ï¼ˆZXIDï¼‰çš„äº‹åŠ¡Proposalï¼Œå°±å¯ä»¥ä¿è¯æ–°é€‰ä¸¾å‡ºçš„Leaderä¸€å®šå…·æœ‰æ‰€æœ‰å·²ç»æäº¤çš„ææ¡ˆï¼Œè¿˜å¯ä»¥çœåŒºLeaderæœåŠ¡å™¨æ£€æŸ¥Proposalçš„æäº¤å’Œä¸¢å¼ƒå·¥ä½œè¿™ä¸€æ­¥ã€‚</p><p>å®ŒæˆLeaderé€‰ä¸¾åï¼Œåœ¨æ­£å¼å·¥ä½œå‰ï¼ŒLeaderæœåŠ¡å™¨é¦–å…ˆè¦ç¡®è®¤äº‹åŠ¡æ—¥å¿—ä¸­æ‰€æœ‰çš„Proposalæ˜¯å¦éƒ½å·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠçš„æœºå™¨æäº¤äº†ï¼Œå³<strong>æ˜¯å¦å®Œæˆæ•°æ®åŒæ­¥</strong>ã€‚</p><ul><li>Leaderä¸ºæ¯ä¸ªFollowerå‡†å¤‡ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†æ²¡æœ‰è¢«å„FolloweråŒæ­¥çš„äº‹åŠ¡ä»¥Proposalæ¶ˆæ¯çš„å½¢å¼é€ä¸ªå‘é€ç»™Followerï¼Œå¹¶æ¯ä¸ªéƒ½è·Ÿç€å‘é€ä¸€ä¸ªCommitæ¶ˆæ¯ã€‚</li><li>ç­‰åˆ°æ‰€æœ‰Followeréƒ½å°†å…¶å°šæœªåŒæ­¥çš„äº‹åŠ¡Proposalä»Leaderä¸ŠåŒæ­¥è¿‡æ¥å¹¶æˆåŠŸåº”ç”¨åˆ°æœ¬åœ°æ•°æ®åº“åï¼ŒLeaderå°†è¯¥FolloweråŠ å¦‚åˆ°çœŸæ­£å¯ç”¨çš„Followeråˆ—è¡¨ï¼Œå¹¶å¼€å§‹ä¹‹åæµç¨‹ã€‚</li></ul><p><strong>å¦‚ä½•å¤„ç†éœ€è¦ä¸¢å¼ƒçš„äº‹åŠ¡Proposalï¼Ÿ</strong></p><p>ZXIDæ—¶ä¸€ä¸ª64ä½çš„æ•°å­—ï¼Œä½32ä½å¯ä»¥çœ‹ä½œç®€å•çš„é€’å¢è®¡æ•°å™¨ï¼Œé«˜32ä½åˆ™ä»£è¡¨äº†Leaderå‘¨æœŸepochçš„ç¼–å·ï¼Œæ¯å½“é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªæ–°çš„LeaderæœåŠ¡å™¨ï¼Œå°±ä¼šä»Leaderä¸Šå–å‡ºå…¶æœ¬åœ°æ—¥å¿—ä¸­æœ€å¤§äº‹åŠ¡Proposalçš„ZXIDï¼Œè§£æå‡ºepochå€¼å¹¶åŠ 1ï¼Œå°†æ­¤ç¼–å·ä½œä¸ºæ–°çš„epochï¼Œå¹¶å°†ä½32ä½ç½®0ã€‚</p><p>è¿™æ ·å¯ä»¥åŒºåˆ†å¼€ä¸åŒçš„Leaderå‘¨æœŸå˜åŒ–ï¼Œä»è€Œé¿å…ä¸åŒçš„LeaderæœåŠ¡å™¨é”™è¯¯çš„ä½¿ç”¨ç›¸åŒçš„ZXIDæå‡ºä¸åŒçš„äº‹åŠ¡Proposalã€‚</p><p>å½“ä¸€ä¸ªåŒ…å«äº†ä¸Šä¸ªå‘¨æœŸå°šæœªæäº¤çš„äº‹åŠ¡Proposalçš„æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå…¶è‚¯å®šæ— æ³•æˆä¸ºLeaderã€‚å› ä¸ºå½“å‰é›†ç¾¤ä¸€å®šåŒ…å«ä¸€ä¸ªQuorumé›†åˆï¼Œé›†åˆä¸­çš„æœºå™¨ä¸€å®šåŒ…å«äº†æ›´é«˜epochçš„äº‹åŠ¡Proposalï¼Œå› æ­¤è¯¥æœºå™¨è‚¯å®šéæœ€é«˜ç¼–å·äº‹åŠ¡ã€‚å½“å…¶è¿æ¥ä¸ŠLeaderåï¼ŒLeaderæ ¹æ®è‡ªå·±è®°å½•çš„æœ€åè¢«æäº¤çš„Proposalå¯¹æ¯”ï¼Œå¹¶è¦æ±‚Followerè¿›è¡Œä¸€ä¸ªå›é€€æ“ä½œâ€”å›é€€åˆ°ä¸€ä¸ªç¡®å®å·²ç»è¢«é›†ç¾¤è¿‡åŠæœºå™¨æäº¤çš„æœ€æ–°çš„äº‹åŠ¡Proposalï¼ˆå¦‚ä¸Šå›¾4-4 Server1è¿æ¥åï¼Œä¼šè¢«è¦æ±‚å»é™¤P3ï¼‰ã€‚</p><h3 id="2-3-æ·±å…¥å‰–æ"><a href="#2-3-æ·±å…¥å‰–æ" class="headerlink" title="2.3 æ·±å…¥å‰–æ"></a>2.3 æ·±å…¥å‰–æ</h3><p>æœªå®Œå¾…ç»­â€¦</p><h4 id="ï¼ˆ1ï¼‰-ç³»ç»Ÿæ¨¡å‹"><a href="#ï¼ˆ1ï¼‰-ç³»ç»Ÿæ¨¡å‹" class="headerlink" title="ï¼ˆ1ï¼‰ ç³»ç»Ÿæ¨¡å‹"></a>ï¼ˆ1ï¼‰ ç³»ç»Ÿæ¨¡å‹</h4><h4 id="ï¼ˆ2ï¼‰-é—®é¢˜æè¿°"><a href="#ï¼ˆ2ï¼‰-é—®é¢˜æè¿°" class="headerlink" title="ï¼ˆ2ï¼‰ é—®é¢˜æè¿°"></a>ï¼ˆ2ï¼‰ é—®é¢˜æè¿°</h4><h4 id="ï¼ˆ3ï¼‰-ç®—æ³•æè¿°"><a href="#ï¼ˆ3ï¼‰-ç®—æ³•æè¿°" class="headerlink" title="ï¼ˆ3ï¼‰ ç®—æ³•æè¿°"></a>ï¼ˆ3ï¼‰ ç®—æ³•æè¿°</h4><h4 id="ï¼ˆ4ï¼‰-è¿è¡Œåˆ†æ"><a href="#ï¼ˆ4ï¼‰-è¿è¡Œåˆ†æ" class="headerlink" title="ï¼ˆ4ï¼‰ è¿è¡Œåˆ†æ"></a>ï¼ˆ4ï¼‰ è¿è¡Œåˆ†æ</h4><h3 id="2-4-ZABä¸Paxosç®—æ³•çš„å¼‚åŒ"><a href="#2-4-ZABä¸Paxosç®—æ³•çš„å¼‚åŒ" class="headerlink" title="2.4 ZABä¸Paxosç®—æ³•çš„å¼‚åŒ"></a>2.4 ZABä¸Paxosç®—æ³•çš„å¼‚åŒ</h3><ul><li><p>äºŒè€…éƒ½å­˜åœ¨ä¸€ä¸ªLeaderè¿›ç¨‹è§’è‰²ï¼Œè´Ÿè´£åè°ƒå¤šä¸ªFollowerè¿›ç¨‹çš„è¿è¡Œã€‚</p></li><li><p>Leaderè¿›ç¨‹éƒ½ä¼šç­‰å¾…è¶…è¿‡åŠæ•°çš„Followerè¿›ç¨‹æ­£ç¡®åé¦ˆåï¼Œæ‰ä¼šå°†ææ¡ˆæäº¤ã€‚</p></li><li><p>ZABåè®®ä¸­æ ‡è¯†Leaderå‘¨æœŸçš„epochå€¼ï¼ŒPaxosç®—æ³•ä¸­å«Ballotã€‚</p></li></ul><p>äºŒè€…çš„æœ¬è´¨åŒºåˆ«åœ¨äºè®¾è®¡ç›®æ ‡ä¸åŒï¼ŒZABåè®®ç”¨äºæ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼æ•°æ®ä¸»å¤‡ç³»ç»Ÿï¼Œè€ŒPaxosç®—æ³•åˆ™ç”¨äºæ„å»ºä¸€ä¸ªåˆ†å¸ƒå¼çš„ä¸€è‡´æ€§çŠ¶æ€æœºç³»ç»Ÿã€‚</p><h2 id="ä¸‰-ç®€å•ä½¿ç”¨"><a href="#ä¸‰-ç®€å•ä½¿ç”¨" class="headerlink" title="ä¸‰. ç®€å•ä½¿ç”¨"></a>ä¸‰. ç®€å•ä½¿ç”¨</h2><h3 id="3-1-éƒ¨ç½²ä¸è¿è¡Œ"><a href="#3-1-éƒ¨ç½²ä¸è¿è¡Œ" class="headerlink" title="3.1 éƒ¨ç½²ä¸è¿è¡Œ"></a>3.1 éƒ¨ç½²ä¸è¿è¡Œ</h3><p>ZooKeeperä½¿ç”¨Javaè¯­è¨€ç¼–å†™ï¼Œæ‰€ä»¥éœ€è¦1.6ä»¥ä¸Šç‰ˆæœ¬çš„Javaç¯å¢ƒã€‚ZooKeeperåŒ…å«é›†ç¾¤å’Œå•æœºä¸¤ç§è¿è¡Œæ¨¡å¼ã€‚</p><h4 id="ï¼ˆ1ï¼‰éƒ¨ç½²"><a href="#ï¼ˆ1ï¼‰éƒ¨ç½²" class="headerlink" title="ï¼ˆ1ï¼‰éƒ¨ç½²"></a>ï¼ˆ1ï¼‰éƒ¨ç½²</h4><ol><li><p>ä¸‹è½½å®‰è£…åŒ…å¹¶è§£å‹ï¼š<code>http:zookeeper.apache.org/releases.html</code></p></li><li><p>é…ç½®æ–‡ä»¶ <code>zoo.cfg</code> ï¼š</p><p><code>%ZK_HOME%/conf</code> ç›®å½•ä¸‹ <code>zoo_sample.cfg</code> é‡å‘½åä¸º <code>zoo.cfg</code> </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">tickTime=2000</span></span><br><span class="line"><span class="string">dataDir=/var/lib/zookeeper/</span></span><br><span class="line"><span class="string">clientPort=2181</span></span><br><span class="line"><span class="string">initLimit=5</span></span><br><span class="line"><span class="string">syncLimit=2</span></span><br><span class="line"><span class="comment"># server.id=host:port:port ç”¨æ¥æ„ŸçŸ¥é›†ç¾¤ç”±å“ªäº›æœºå™¨æ„æˆï¼Œidè¡¨ç¤ºæœºå™¨åºå·ï¼ŒdataDirç›®å½•ä¸‹éœ€è¦æœ‰ä¸€ä¸ªmyidæ–‡ä»¶ï¼Œå†…å®¹ä¸ºä¸€ä¸ªæ•°å­—å¯¹åº”æ­¤id</span></span><br><span class="line"><span class="string">server.1=&lt;IP1&gt;:2888:3888</span></span><br><span class="line"><span class="string">server.2=&lt;IP2&gt;:2888:3888</span></span><br><span class="line"><span class="string">server.3=&lt;IP3&gt;:2888:3888</span></span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤æ¨¡å¼ä¸‹æ‰€æœ‰cfgæ–‡ä»¶éƒ½åº”æ˜¯ä¸€è‡´çš„ï¼Œæœ€å¥½ä½¿ç”¨ä»£ç ä»“åº“ç®¡ç†èµ·æ¥ã€‚</li><li>idå–å€¼èŒƒå›´ä¸º ï¼š1~255ã€‚</li></ul></li><li><p>åˆ›å»º <code>myid</code> æ–‡ä»¶ï¼Œåœ¨dataDiræŒ‡å®šç›®å½•ä¸‹ï¼Œå†…å®¹ä¸ºæ•°å­—id</p></li><li><p>ä¸ºæ‰€æœ‰æœºå™¨é…ç½®2å’Œ3æ­¥å†…å®¹</p></li><li><p>å¯åŠ¨æœåŠ¡å™¨ï¼šä½¿ç”¨ <code>%ZK_HOME%/bin</code> ç›®å½•ä¸‹çš„ <code>zkServer.sh</code> è„šæœ¬å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh zkServer.sh start</span></span><br><span class="line">JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper-3.4.3/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯æœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> telnet 127.0.0.1 2181</span></span><br><span class="line">stat</span><br></pre></td></tr></table></figure></li></ol><p>å•æœºæ¨¡å¼ä¸é›†ç¾¤æ¨¡å¼åªæ˜¯åœ¨ <code>zoo.cfg</code> çš„é…ç½®ä¸Šæœ‰äº›å·®å¼‚ï¼Œ<code>server.id</code> åªæœ‰ä¸€é¡¹ <code>server.1</code> ã€‚</p><h4 id="ï¼ˆ2ï¼‰è¿è¡Œå’Œåœæ­¢"><a href="#ï¼ˆ2ï¼‰è¿è¡Œå’Œåœæ­¢" class="headerlink" title="ï¼ˆ2ï¼‰è¿è¡Œå’Œåœæ­¢"></a>ï¼ˆ2ï¼‰è¿è¡Œå’Œåœæ­¢</h4><p>å¯åŠ¨æœåŠ¡ï¼š</p><ul><li>Javaå‘½ä»¤è¡Œï¼šåœ¨ <code>%ZK_HOME%</code> ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ <code>java -cp zookeeper -3.4.3 jar:lib/ slf4j-api-1.6. 1. jar:lib/slf4j- log4j12-1.6.1.jar:lib/log4j-1.2.15.jar:conf org. apache. zookeeper. server.quorum.QuorumPeerMain conf/zoo.cfg</code> æ³¨æ„log4jå’Œslf4jç‰ˆæœ¬</li><li>è‡ªå¸¦çš„å¯åŠ¨è„šæœ¬</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200114.png"></p><p>åœæ­¢æœåŠ¡ï¼š<code>sh zkServer.sh stop</code></p><h4 id="ï¼ˆ3ï¼‰å¸¸è§å¼‚å¸¸"><a href="#ï¼ˆ3ï¼‰å¸¸è§å¼‚å¸¸" class="headerlink" title="ï¼ˆ3ï¼‰å¸¸è§å¼‚å¸¸"></a>ï¼ˆ3ï¼‰å¸¸è§å¼‚å¸¸</h4><ul><li><strong>ç«¯å£è¢«å ç”¨ï¼š</strong><code>java.net.BindException: Address already in use</code> å¼‚å¸¸æ˜¯å› ä¸º2181ç«¯å£è¢«å…¶ä»–è¿›ç¨‹å ç”¨ï¼Œå…³é—­å¯¹åº”è¿›ç¨‹å¹¶é‡å¯ZKå³å¯ã€‚</li><li><strong>ç£ç›˜æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼š</strong><code>java.io.IOException: No space left on device</code> é‡åˆ°æ­¤å¼‚å¸¸ï¼ŒZKä¼šç«‹å³æ‰§è¡ŒFailoverç­–ç•¥ï¼Œä»è€Œé€€å‡ºè¿›ç¨‹ã€‚æ¸…ç†ç£ç›˜ç©ºé—´ï¼Œä¸ºäº†é¿å…åç»­å†æ¬¡é‡åˆ°æ­¤é—®é¢˜ï¼Œæœ€å¥½åŠ ä¸Šå¯¹ZKæœåŠ¡å™¨ç£ç›˜ä½¿ç”¨çš„ç›‘æ§å’ŒZKæ—¥å¿—çš„è‡ªåŠ¨æ¸…ç†ã€‚</li><li><strong>æ— æ³•æ‰¾åˆ° <code>myid</code> æ–‡ä»¶ï¼š</strong>ç¼ºå°‘æ­¤æ–‡ä»¶ï¼Œåˆ›å»ºå³å¯ã€‚</li><li><strong>é›†ç¾¤ä¸­å…¶ä»–æœºå™¨Leaderé€‰ä¸¾ç«¯å£æœªå¼€ï¼š</strong> <code>Cannot open channel to 2 at election adress /xx.xx.xx.xx:3888</code> è¿™æ˜¯ç”±äºå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè™½ç„¶å½“å‰æœºå™¨å¯åŠ¨äº†ï¼Œä½†å…¶ä»–æœºå™¨è¿˜æœªå¯åŠ¨å®Œã€‚ZKä½¿ç”¨3888ç«¯å£è¿›è¡ŒLeaderé€‰ä¸¾è¿‡ç¨‹çš„æŠ•ç¥¨é€šä¿¡ã€‚</li></ul><h3 id="3-2-å®¢æˆ·ç«¯è„šæœ¬"><a href="#3-2-å®¢æˆ·ç«¯è„šæœ¬" class="headerlink" title="3.2 å®¢æˆ·ç«¯è„šæœ¬"></a>3.2 å®¢æˆ·ç«¯è„šæœ¬</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥binç›®å½•ï¼Œç¡®è®¤æ˜¯å¦è¿æ¥ä¸ŠZKæœåŠ¡å™¨</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh zkCli.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿æ¥æŒ‡å®šZKæœåŠ¡å™¨</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh zkCli.sh -server ip:port</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºä¸€ä¸ªZKèŠ‚ç‚¹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sæˆ–eåˆ†åˆ«æŒ‡å®šèŠ‚ç‚¹ç‰¹æ€§é¡ºåºæˆ–ä¸´æ—¶èŠ‚ç‚¹ï¼Œä¸åŠ åˆ™é»˜è®¤ä¸ºæŒä¹…èŠ‚ç‚¹ï¼›aclè¿›è¡Œæƒé™æ§åˆ¶ï¼Œé»˜è®¤ä¸åŠ æ§åˆ¶</span></span><br><span class="line">create [-s] [-e] path data acl</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨æ ¹èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªå«/zk-bookçš„èŠ‚ç‚¹ï¼Œå†…å®¹ä¸º123</span></span><br><span class="line">create /zk-book 123</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¯»å–</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lsåˆ—å‡ºZKæŒ‡å®šèŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹</span></span><br><span class="line">ls path [watch]</span><br><span class="line">ls /</span><br><span class="line"><span class="meta">#</span><span class="bash"> getå‘½ä»¤è·å–æŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹å’Œå±æ€§ä¿¡æ¯</span></span><br><span class="line">get path [watch]</span><br><span class="line">get /zk-book</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ›´æ–°</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ›´æ–°æŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œversionå‚æ•°æŒ‡å®šæœ¬æ¬¡æ›´æ–°åŸºäºZNodeå“ªä¸ªæ•°æ®ç‰ˆæœ¬è¿›è¡Œ</span></span><br><span class="line">set path data [version]</span><br><span class="line">set /zk-book 456</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤ï¼Œè¦åˆ é™¤èŠ‚ç‚¹ï¼Œå…¶ä¸èƒ½åŒ…å«å­èŠ‚ç‚¹</span></span><br><span class="line">delete path [version]</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹æ¥è‡ªã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šæ¦‚è¿°ï¼ŒZABåè®®ï¼Œç®€å•ä½¿ç”¨ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://linyishui.top/2021042101.html"/>
    <id>http://linyishui.top/2021042101.html</id>
    <published>2021-04-21T13:27:05.000Z</published>
    <updated>2021-05-13T08:27:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h1><h2 id="ä¸€-ä»ACIDåˆ°CAP-BASE"><a href="#ä¸€-ä»ACIDåˆ°CAP-BASE" class="headerlink" title="ä¸€. ä»ACIDåˆ°CAP/BASE"></a>ä¸€. ä»ACIDåˆ°CAP/BASE</h2><h3 id="1-1-ACID"><a href="#1-1-ACID" class="headerlink" title="1.1 ACID"></a>1.1 ACID</h3><p>æ•°æ®åº“äº‹åŠ¡å’ŒACIDå¯ä»¥å‚çœ‹ï¼š<a href="2020120801.html">ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆä¸€ï¼‰æ¶æ„å’Œå†å²</a> ä¸­äº‹åŠ¡ç« èŠ‚ã€‚</p><h3 id="1-2-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#1-2-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="1.2 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡"></a>1.2 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡</h3><p>åˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œæ•°æ®åˆ†æ•£åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨å¯èƒ½åˆ†åˆ«ä½äºä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚</p><p>æ€è€ƒå¦‚ä½•å®ç°åˆ†å¸ƒå¼çš„äº‹åŠ¡å¤„ç†ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬è¦æŠŠåˆ†å¸ƒå¼äº‹åŠ¡çœ‹ä½œä¸€ç»„åˆ†å¸ƒå¼çš„æ“ä½œåºåˆ—ï¼Œå³ä¸€ç»„å­äº‹åŠ¡ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿå…·æœ‰ACIDçš„äº‹åŠ¡ç‰¹æ€§ã€‚</p><p>å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¿è¯æ•°æ®çš„ä¸¥æ ¼ä¸€è‡´æ€§æ—¶å¿…ç„¶è¦ç‰ºç‰²æ‰éƒ¨åˆ†ç³»ç»Ÿå¯ç”¨æ€§ã€‚</p><h3 id="1-3-CAP"><a href="#1-3-CAP" class="headerlink" title="1.3 CAP"></a>1.3 CAP</h3><p>CAPç†è®ºï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³<strong>ä¸€è‡´æ€§</strong>ï¼ˆConsistencyï¼‰ã€<strong>å¯ç”¨æ€§</strong>ï¼ˆAvailabilityï¼‰å’Œ<strong>åˆ†åŒºå®¹é”™æ€§</strong>ï¼ˆPartition toleranceï¼‰ï¼Œæœ€å¤šåŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤é¡¹ã€‚</p><ul><li>ä¸€è‡´æ€§ï¼šåˆ†å¸ƒå¼ä¸­æŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬é—´èƒ½å¦ä¿æŒä¸€è‡´ã€‚å¯¹ä¸€ä¸ªæ•°æ®æ›´æ–°ä¸”æ‰§è¡ŒæˆåŠŸåï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½è¦èƒ½è¯»åˆ°æœ€æ–°çš„å€¼ã€‚</li><li>å¯ç”¨æ€§ï¼šç³»ç»ŸæœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œç”¨æˆ·çš„æ¯ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½åœ¨<strong>æœ‰é™çš„æ—¶é—´</strong>å†…<strong>è¿”å›ç»“æœ</strong>ã€‚ç³»ç»Ÿå­˜åœ¨ä¸€ä¸ªåˆç†çš„å“åº”æ—¶é—´ï¼Œå¦åˆ™å°±ä¼šä½¿ç”¨æˆ·å¯¹ç³»ç»Ÿå¤±æœ›ã€‚</li><li>åˆ†åŒºå®¹é”™æ€§ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ï¼Œä»è¦ä¿è¯å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200102.png"></p><p>å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå› ä¸ºåˆ†å¸ƒå¼å¿…ç„¶è¦æŠŠç»„ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œç½‘ç»œé—®é¢˜å¿…å®šä¼šå‡ºç°ï¼Œæ‰€ä»¥æ¶æ„è®¾è®¡å¸ˆå¾€å¾€éœ€è¦æŠŠç²¾åŠ›èŠ±åœ¨å¦‚ä½•æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´å¯»æ±‚å¹³è¡¡ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200101.png"></p><h3 id="1-4-BASEç†è®º"><a href="#1-4-BASEç†è®º" class="headerlink" title="1.4 BASEç†è®º"></a>1.4 BASEç†è®º</h3><p>BASE æ˜¯ <strong>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ï¼ŒSoft stateï¼ˆè½¯çŠ¶æ€ï¼‰å’Œ Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</strong>ï¼Œæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong consistencyï¼‰ï¼Œæ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹é‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿæœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual consistencyï¼‰ã€‚</p><p><strong>åŸºæœ¬å¯ç”¨</strong>ï¼ŒæŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥çš„æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œä½†è¿™ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ï¼š</p><ul><li><strong>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±</strong>ï¼šå¦‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæœç´¢å¼•æ“è¦åœ¨0.5ç§’å†…è¿”å›ç»™ç”¨æˆ·æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºæ•…éšœå¯¼è‡´å“åº”æ—¶é—´å¢åŠ åˆ°1åˆ°2ç§’ã€‚</li><li><strong>åŠŸèƒ½ä¸Šçš„æŸå¤±</strong>ï¼šå¦‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…èƒ½åœ¨å•†åŸå¹³å°é¡ºåˆ©å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†åœ¨ä¸€äº›èŠ‚æ—¥è´­ç‰©é«˜å³°ä¸ºäº†ä¿è¯ç³»ç»Ÿç¨³å®šï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½è¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚</li></ul><p><strong>å¼±çŠ¶æ€</strong>ï¼šä¹Ÿå«è½¯çŠ¶æ€ï¼ŒæŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸å½±å“ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å‡ºç°å»¶æ—¶ã€‚</p><p><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚æœ€ç»ˆä¸€è‡´æ€§çš„5ç§å˜ç§ï¼š</p><ul><li><strong>å› æœä¸€è‡´æ€§ï¼ˆCausial consistencyï¼‰ï¼š</strong>è¿›ç¨‹Aåœ¨æ›´æ–°å®ŒæŸä¸ªæ•°æ®åé€šçŸ¥äº†è¿›ç¨‹Bï¼Œè¿›ç¨‹Bèƒ½è¯»å–åˆ°Aæ›´æ–°åçš„æœ€æ–°å€¼ï¼Œå¦‚æœBè¦å¯¹æ•°æ®è¿›è¡Œæ›´æ–°è¦åŸºäºæ­¤æœ€æ–°å€¼ï¼Œå³ä¸èƒ½å‘ç”Ÿä¸¢å¤±æ›´æ–°çš„æƒ…å†µï¼›è€Œä¸æ­¤æ— å…³çš„è¿›ç¨‹Cæ— æ­¤é™åˆ¶ã€‚</li><li><strong>è¯»å·±ä¹‹æ‰€å†™ï¼ˆRead your writesï¼‰ï¼š</strong>è¿›ç¨‹Aæ›´æ–°ä¸€ä¸ªæ•°æ®åï¼Œè‡ªå·±æ€»èƒ½è®¿é—®æ›´æ–°åçš„æœ€æ–°å€¼ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å› æœä¸€è‡´æ€§ã€‚</li><li><strong>ä¼šè¯ä¸€è‡´æ€§ï¼ˆSession consistencyï¼‰ï¼š</strong>ç³»ç»Ÿä¿è¯åœ¨åŒä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯ä¸­å®ç°è¯»å·±ä¹‹æ‰€å†™çš„ä¸€è‡´æ€§ã€‚</li><li><strong>å•è°ƒè¯»ä¸€è‡´æ€§ï¼ˆMonotonic read consistencyï¼‰ï¼š</strong>å¦‚æœä¸€ä¸ªè¿›ç¨‹ä»ç³»ç»Ÿä¸­è¯»å‡ºä¸€ä¸ªæ•°æ®åï¼Œç³»ç»Ÿå¯¹äºè¯¥è¿›ç¨‹åç»­çš„ä»»ä½•æ•°æ®è®¿é—®éƒ½ä¸åº”è¯¥è¿”å›æ›´æ—§çš„å€¼ã€‚</li><li><strong>å•è°ƒå†™ä¸€è‡´æ€§ï¼ˆMonotonic write consistencyï¼‰ï¼š</strong>ç³»ç»Ÿä¿è¯æ¥è‡ªåŒä¸€ä¸ªè¿›ç¨‹çš„å†™æ“ä½œè¢«é¡ºåºçš„æ‰§è¡Œã€‚</li></ul><p>ç°ä»£çš„å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¾€å¾€ä¼šé‡‡ç”¨åŒæ­¥å’Œä¸€æ­¥çš„æ–¹å¼æ¥å®ç°ä¸»å¤‡æ•°æ®å¤åˆ¶æŠ€æœ¯ï¼š</p><ul><li>åŒæ­¥æ–¹å¼ï¼šæ•°æ®çš„å¤åˆ¶è¿‡ç¨‹é€šå¸¸æ˜¯æ›´æ–°äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤åœ¨äº‹åŠ¡å®Œæˆåï¼Œä¸»å¤‡æ•°æ®åº“çš„æ•°æ®å°±ä¼šè¾¾åˆ°ä¸€è‡´ã€‚</li><li>å¼‚æ­¥æ–¹å¼ï¼šå¤‡åº“çš„æ›´æ–°å¾€å¾€å­˜åœ¨å»¶æ—¶ï¼Œå–å†³äºäº‹åŠ¡æ—¥å¿—åœ¨ä¸»å¤‡æ•°æ®åº“ä¹‹é—´ä¼ è¾“çš„æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœæ—¶é—´è¿‡ä¹…æˆ–ä¼ è¾“ä¸­å‡ºç°å¼‚å¸¸å¯¼è‡´æ— æ³•åŠæ—¶å°†äº‹åŠ¡åº”ç”¨åˆ°å¤‡åº“ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li></ul><p>BASEç†è®ºä¸åŒäºä¼ ç»Ÿäº‹åŠ¡ACIDçš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œæå‡ºç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€ã€‚</p><h2 id="äºŒ-ä¸€è‡´æ€§åè®®"><a href="#äºŒ-ä¸€è‡´æ€§åè®®" class="headerlink" title="äºŒ. ä¸€è‡´æ€§åè®®"></a>äºŒ. ä¸€è‡´æ€§åè®®</h2><p>æœ‰å¾ˆå¤šçš„ç»å…¸çš„ä¸€è‡´æ€§åè®®å’Œç®—æ³•æ¥è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ€è‘—åçš„æœ‰<strong>äºŒé˜¶æ®µæäº¤åè®®</strong>ã€<strong>ä¸‰é˜¶æ®µæäº¤åè®®</strong>å’Œ<strong>Paxosç®—æ³•</strong>ã€‚</p><h3 id="2-1-äºŒé˜¶æ®µæäº¤-2PC"><a href="#2-1-äºŒé˜¶æ®µæäº¤-2PC" class="headerlink" title="2.1 äºŒé˜¶æ®µæäº¤-2PC"></a>2.1 äºŒé˜¶æ®µæäº¤-2PC</h3><p>2PCï¼Œå³äºŒé˜¶æ®µæäº¤ï¼ŒTwo-Phase Commit çš„ç¼©å†™ï¼Œä¸ºäº†ä½¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹æ‰€æœ‰çš„èŠ‚ç‚¹åœ¨è¿›è¡Œäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­èƒ½ä¿æŒ<strong>åŸå­æ€§</strong>å’Œ<strong>ä¸€è‡´æ€§</strong>è€Œè®¾è®¡çš„ç®—æ³•ã€‚ç›®å‰å¤§éƒ¨åˆ†å…³ç³»å‹æ•°æ®åº“éƒ½é‡‡ç”¨2PCæ¥å®Œæˆåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ã€‚</p><p>æ‰§è¡Œæµç¨‹ï¼š</p><ul><li><strong>é˜¶æ®µä¸€ï¼šæäº¤äº‹åŠ¡è¯·æ±‚</strong>ï¼ˆä¹Ÿå«æŠ•ç¥¨é˜¶æ®µï¼‰<ol><li><strong>äº‹åŠ¡è¯¢é—®ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œç­‰å¾…å„å‚ä¸è€…å“åº”ã€‚</li><li><strong>æ‰§è¡Œäº‹åŠ¡ï¼š</strong>å„å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ã€‚</li><li><strong>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡è¯¢é—®çš„å“åº”ï¼š</strong>å‚ä¸è€…æˆåŠŸæ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œåé¦ˆç»™åè°ƒè€…Yeså“åº”ï¼Œè¡¨ç¤ºäº‹åŠ¡å¯ä»¥æ‰§è¡Œï¼›è‹¥æœªæ‰§è¡ŒæˆåŠŸï¼Œåé¦ˆNoã€‚</li></ol></li><li><strong>é˜¶æ®µäºŒï¼šæ‰§è¡Œäº‹åŠ¡æäº¤</strong>ï¼ˆæ‰€æœ‰å‚ä¸è€…éƒ½åé¦ˆYesï¼Œè¿›è¡Œé˜¶æ®µäºŒï¼‰<ol><li><strong>å‘é€æäº¤è¯·æ±‚ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡º <code>Commit</code> è¯·æ±‚ã€‚</li><li><strong>äº‹åŠ¡æäº¤ï¼š</strong>å‚ä¸è€…æ”¶åˆ° <code>Commit</code> è¯·æ±‚ï¼Œæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œåœ¨å®Œæˆæäº¤åé‡Šæ”¾äº‹åŠ¡èµ„æºã€‚</li><li><strong>åé¦ˆäº‹åŠ¡æäº¤ç»“æœï¼š</strong>å‚ä¸è€…åœ¨å®Œæˆäº‹åŠ¡æäº¤ä¹‹åï¼Œå‘åè°ƒè€…å‘é€ <code>Ack</code> æ¶ˆæ¯ã€‚</li><li><strong>å®Œæˆäº‹åŠ¡ï¼š</strong>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ <code>Ack</code> æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li></ol></li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>å½“æŸä¸ªå‚ä¸è€…åé¦ˆäº†Noå“åº”ã€æˆ–ç­‰å¾…æ¥æ”¶æ‰€æœ‰å‚ä¸è€…åé¦ˆè¶…æ—¶ä¹‹åï¼Œæ‰§è¡Œä¸­æ–­äº‹åŠ¡<ol><li><strong>å‘é€å›æ»šè¯·æ±‚ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡º <code>Rollback</code> è¯·æ±‚ã€‚</li><li><strong>äº‹åŠ¡å›æ»šï¼š</strong>å‚ä¸è€…æ¥æ”¶åˆ° <code>Rollback</code> è¯·æ±‚åï¼Œåˆ©ç”¨å…¶åœ¨é˜¶æ®µä¸€ä¸­è®°å½•çš„ <code>Undo</code> ä¿¡æ¯æ¥æ‰§è¡Œäº‹åŠ¡å›æ»šæ“ä½œï¼Œå¹¶é‡Šæ”¾äº‹åŠ¡å ç”¨èµ„æºã€‚</li><li><strong>åé¦ˆäº‹åŠ¡å›æ»šç»“æœï¼š</strong>å‚ä¸è€…å®Œæˆå›æ»šåï¼Œå‘åè°ƒè€…å‘é€ <code>Ack</code> æ¶ˆæ¯ã€‚</li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ <code>Ack</code> æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚</li></ol></li></ul><p>2PCçš„æ ¸å¿ƒæ˜¯æ¯ä¸ªäº‹åŠ¡éƒ½é‡‡ç”¨<strong>å…ˆå°è¯•åæäº¤</strong>çš„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªå¼ºä¸€è‡´æ€§ç®—æ³•ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200104.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200105.png"></p><p>ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®ç°æ–¹ä¾¿ã€‚</li><li>ç¼ºç‚¹ï¼šåŒæ­¥é˜»å¡ã€å•ç‚¹é—®é¢˜ã€è„‘è£‚ã€å¤ªè¿‡ä¿å®ˆ<ul><li><strong>åŒæ­¥é˜»å¡ï¼š</strong>åœ¨äºŒé˜¶æ®µçš„æäº¤è¿‡ç¨‹ï¼Œæ‰€æœ‰å‚ä¸è¯¥äº‹åŠ¡æ“ä½œçš„é€»è¾‘éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œå„ä¸ªå‚ä¸è€…åœ¨ç­‰å¾…å…¶ä»–å‚ä¸è€…å“åº”çš„è¿‡ç¨‹æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œã€‚</li><li><strong>å•ç‚¹é—®é¢˜ï¼š</strong>åè°ƒè€…å¤ªè¿‡é‡è¦ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜æ•´ä¸ªæµç¨‹å°±æ— æ³•è¿ä½œï¼Œå¦‚æœæ˜¯åœ¨é˜¶æ®µäºŒå‡ºç°é—®é¢˜ï¼Œæ›´ä¼šå¯¼è‡´å‚ä¸è€…éƒ½å¤„äºé”å®šäº‹åŠ¡èµ„æºçš„çŠ¶æ€ã€‚</li><li><strong>æ•°æ®ä¸ä¸€è‡´ï¼š</strong>åœ¨é˜¶æ®µäºŒæ‰§è¡Œäº‹åŠ¡æäº¤æ—¶ï¼Œå½“åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘ç”ŸCommitè¯·æ±‚åï¼Œå‘ç”Ÿå±€éƒ¨ç½‘ç»œå¼‚å¸¸æˆ–æ˜¯åè°ƒè€…è‡ªèº«æœªå‘é€å®Œå³å´©æºƒï¼Œå¯¼è‡´åªæœ‰éƒ¨åˆ†å‚ä¸è€…æ”¶åˆ°äº†Commitè¯·æ±‚ã€‚æ”¶åˆ°çš„æäº¤äº‹åŠ¡ï¼Œæœªæ”¶åˆ°çš„æ— æ³•æäº¤ï¼Œå‡ºç°æ•°æ®ä¸ä¸€è‡´ç°è±¡ã€‚</li><li><strong>å¤ªè¿‡ä¿å®ˆï¼š</strong>å‚ä¸è€…å‡ºç°æ•…éšœè€Œå¯¼è‡´åè°ƒè€…å§‹ç»ˆæ— æ³•è·å–åˆ°æ‰€æœ‰å“åº”ï¼Œæ­¤æ—¶åªèƒ½ä¾é åè°ƒè€…è‡ªèº«çš„è¶…æ—¶æœºåˆ¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­äº‹åŠ¡ï¼Œæ˜¾å¾—è¿‡äºä¿å®ˆï¼Œæ²¡æœ‰å®Œå–„çš„å®¹é”™æœºåˆ¶ï¼Œå¯¼è‡´ä¸€ä¸ªèŠ‚ç‚¹çš„å¤±è´¥å¯¼è‡´æ•´ä¸ªäº‹åŠ¡å¤±è´¥ã€‚</li></ul></li></ul><h3 id="2-2-ä¸‰é˜¶æ®µæäº¤-3PC"><a href="#2-2-ä¸‰é˜¶æ®µæäº¤-3PC" class="headerlink" title="2.2 ä¸‰é˜¶æ®µæäº¤-3PC"></a>2.2 ä¸‰é˜¶æ®µæäº¤-3PC</h3><p>3PCï¼Œå³ä¸‰é˜¶æ®µæäº¤ï¼ŒThree-Phase Commitçš„ç¼©å†™ï¼Œé’ˆå¯¹2PCçš„ç¼ºé™·è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°†2PCçš„æäº¤äº‹åŠ¡è¯·æ±‚è¿‡ç¨‹ä¸€åˆ†ä¸º2ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200106.png"></p><p>æ‰§è¡Œé˜¶æ®µï¼š</p><ul><li><strong>é˜¶æ®µä¸€ï¼šCanCommit</strong><ol><li><strong>äº‹åŠ¡è¯¢é—®ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸€ä¸ªåŒ…å«äº‹åŠ¡å†…å®¹çš„ <code>canCommit</code> è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…å“åº”ã€‚</li><li><strong>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡è¯¢é—®çš„å“åº”ï¼š</strong>å‚ä¸è€…æ¥æ”¶åˆ° <code>canCommit</code> è¯·æ±‚åï¼Œè‹¥åˆ¤æ–­è‡ªå·±å¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡åˆ™åé¦ˆYeså“åº”ï¼Œå¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™åé¦ˆNoå“åº”ã€‚</li></ol></li><li><strong>é˜¶æ®µäºŒï¼šPreCommit</strong><ul><li><strong>æ‰§è¡Œäº‹åŠ¡é¢„æäº¤ï¼š</strong>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰Yesåé¦ˆ<ol><li><strong>å‘é€é¢„æäº¤è¯·æ±‚ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸€ä¸ªåŒ…å«äº‹åŠ¡å†…å®¹çš„ <code>preCommit</code> è¯·æ±‚ï¼Œå¹¶è¿›å…¥ <code>Prepared</code> é˜¶æ®µã€‚</li><li><strong>äº‹åŠ¡é¢„æäº¤ï¼š</strong>å‚ä¸è€…æ¥æ”¶åˆ° <code>preCommit</code> è¯·æ±‚åï¼Œæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ã€‚</li><li><strong>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡æ‰§è¡Œçš„å“åº”ï¼š</strong>å‚ä¸è€…æˆåŠŸæ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œåé¦ˆç»™åè°ƒè€… <code>Ack</code> å“åº”ï¼ŒåŒæ—¶ç­‰å¾…æœ€ç»ˆæŒ‡ä»¤ï¼ˆcommitæˆ–abortï¼‰ã€‚</li></ol></li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>ä»»æ„ä¸€ä¸ªå‚ä¸è€…åé¦ˆäº†Noå“åº”ã€æˆ–ç­‰å¾…è¶…æ—¶åä»æœªæ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆå“åº”<ol><li><strong>å‘é€ä¸­æ–­è¯·æ±‚ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>abort</code> è¯·æ±‚ã€‚</li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>æ— è®ºæ˜¯æ”¶åˆ°åè°ƒè€…çš„ <code>abort</code> è¯·æ±‚ï¼Œæˆ–æ˜¯ç­‰å¾…åè°ƒè€…è¯·æ±‚è¶…æ—¶ï¼Œå‚ä¸è€…éƒ½ä¼šä¸­æ–­äº‹åŠ¡ã€‚</li></ol></li></ul></li><li><strong>é˜¶æ®µä¸‰ï¼šdoCommit</strong><ul><li><strong>æ‰§è¡Œæäº¤ï¼š</strong>åè°ƒè€…å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œä¸”æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…çš„ <code>Ack</code> å“åº”<ol><li><strong>å‘é€æäº¤è¯·æ±‚ï¼š</strong>åè°ƒè€…å°†ä»é¢„æäº¤çŠ¶æ€è½¬æ¢ä¸ºæäº¤çŠ¶æ€ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>doCommit</code> è¯·æ±‚ã€‚</li><li><strong>äº‹åŠ¡æäº¤ï¼š</strong>å‚ä¸è€…æ”¶åˆ° <code>doCommit</code> è¯·æ±‚ï¼Œæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå®Œæˆæäº¤åé‡Šæ”¾äº‹åŠ¡èµ„æºã€‚</li><li><strong>åé¦ˆäº‹åŠ¡æäº¤ç»“æœï¼š</strong>å‚ä¸è€…å®Œæˆäº‹åŠ¡æäº¤åï¼Œå‘åè°ƒè€…å‘é€ <code>Ack</code> æ¶ˆæ¯ã€‚</li><li><strong>å®Œæˆäº‹åŠ¡ï¼š</strong>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ <code>Ack</code> æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li></ol></li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>åè°ƒè€…å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œä¸”æœ‰ä»»ä¸€çš„å‚ä¸è€…åé¦ˆäº†Noå“åº”ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶åä»æœªæ”¶åˆ°æ‰€æœ‰å‚ä¸è€…å“åº”<ol><li><strong>å‘é€ä¸­æ–­è¯·æ±‚ï¼š</strong>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>abort</code> è¯·æ±‚ã€‚</li><li><strong>äº‹åŠ¡å›æ»šï¼š</strong>å‚ä¸è€…æ¥æ”¶åˆ° <code>abort</code> è¯·æ±‚åï¼Œåˆ©ç”¨å…¶åœ¨é˜¶æ®µäºŒä¸­è®°å½•çš„ <code>Undo</code> ä¿¡æ¯æ¥æ‰§è¡Œäº‹åŠ¡å›æ»šæ“ä½œï¼Œå¹¶é‡Šæ”¾äº‹åŠ¡å ç”¨èµ„æºã€‚</li><li><strong>åé¦ˆäº‹åŠ¡å›æ»šç»“æœï¼š</strong>å‚ä¸è€…å®Œæˆå›æ»šåï¼Œå‘åè°ƒè€…å‘é€ <code>Ack</code> æ¶ˆæ¯ã€‚</li><li><strong>ä¸­æ–­äº‹åŠ¡ï¼š</strong>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ <code>Ack</code> æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚</li></ol></li></ul></li></ul><p>è¿›å…¥é˜¶æ®µä¸‰åå¯èƒ½ä¼šå‡ºç°ä¸¤ç§æ•…éšœï¼š</p><ul><li>åè°ƒè€…å‡ºç°é—®é¢˜</li><li>åè°ƒè€…å’Œå‚ä¸è€…ä¹‹é—´ç½‘ç»œå‡ºç°æ•…éšœ</li></ul><p>æœ€ç»ˆéƒ½ä¼šå¯¼è‡´å‚ä¸è€…æ— æ³•åŠæ—¶æ”¶åˆ° <code>doCommit</code> è¯·æ±‚æˆ– <code>abort</code> è¯·æ±‚ï¼Œè¿™æ—¶å‚ä¸è€…ä¼šåœ¨ç­‰å¾…è¶…æ—¶åç»§ç»­è¿›è¡Œäº‹åŠ¡æäº¤ã€‚</p><p>ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šç›¸è¾ƒ2PCé™ä½äº†å‚ä¸è€…çš„é˜»å¡èŒƒå›´ï¼Œèƒ½å¤Ÿåœ¨å‡ºç°å•ç‚¹æ•…éšœåè¾¾æˆä¸€è‡´ã€‚</li><li>ç¼ºç‚¹ï¼š3PCåœ¨å»é™¤é˜»å¡çš„åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ–°é—®é¢˜ï¼Œå°±æ˜¯åœ¨å‚ä¸è€…æ”¶åˆ° <code>preCommit</code> è¯·æ±‚åï¼Œå¦‚æœç½‘ç»œå‡ºç°åˆ†åŒºï¼Œè¿™æ—¶åè°ƒè€…æ‰€åœ¨çš„èŠ‚ç‚¹å’Œå‚ä¸è€…æ— æ³•è¿›è¡Œæ­£å¸¸çš„ç½‘ç»œé€šä¿¡ï¼Œè¿™ä¸ªå‚ä¸è€…ä»ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œå¯¼è‡´äº†æ•°æ®ä¸ä¸€è‡´æ€§ã€‚</li></ul><h3 id="2-3-Paxos-ç®—æ³•"><a href="#2-3-Paxos-ç®—æ³•" class="headerlink" title="2.3 Paxos ç®—æ³•"></a>2.3 Paxos ç®—æ³•</h3><p>Paxos ç®—æ³•ç”± Leslie Lamport äº1990å¹´æå‡ºçš„ä¸€ç§åŸºäºæ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜çš„æœ€æœ‰æ•ˆç®—æ³•ä¹‹ä¸€ã€‚Paxos ç®—æ³•è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‘ç”Ÿä»»ä½•çš„æœºå™¨å®•æœºæˆ–ç½‘ç»œå¼‚å¸¸ï¼Œéƒ½ä¸ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚</p><p>Paxosç®—æ³•æ”¯æŒåˆ†å¸ƒå¼èŠ‚ç‚¹è§’è‰²ä¹‹é—´çš„è½®æ¢ï¼Œé¿å…äº†åˆ†å¸ƒå¼å•ç‚¹çš„å‡ºç°ï¼Œæ—¢è§£å†³äº†æ— é™æœŸç­‰å¾…é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†è„‘è£‚é—®é¢˜ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ‹œå åº­å°†å†›é—®é¢˜ï¼š</span><br><span class="line"></span><br><span class="line">æ‹œå åº­å¸å›½æœ‰å¤šæ”¯å†›é˜Ÿï¼Œä¸åŒå†›é˜Ÿçš„å°†å†›ä¹‹é—´éœ€è¦åˆ¶å®šä¸€ä¸ªç»Ÿä¸€çš„è¡ŒåŠ¨è®¡åˆ’ï¼Œä»è€Œåšå‡ºè¿›æ”»æˆ–æ’¤é€€çš„å†³å®šï¼Œå„ä¸ªå°†å†›åœ¨åœ°ç†ä¸Šè¢«åˆ†å‰²å¼€ï¼Œåªèƒ½ä¾é é€šè®¯å‘˜è¿›è¡Œè”ç»œã€‚é€šè®¯å‘˜ä¸­å¯èƒ½å­˜åœ¨å›å¾’ï¼Œå¯ä»¥ä»»æ„çš„ç¯¡æ”¹æ¶ˆæ¯ã€‚</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šæ¥è¯´ï¼Œåœ¨å¼‚æ­¥ç³»ç»Ÿå’Œä¸å¯é é€šé“ä¸Šæ¥è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€æ˜¯ä¸å¯èƒ½çš„ï¼Œå› æ­¤å¾€å¾€å‡è®¾ä¿¡é“æ˜¯å¯é çš„ã€‚ç°å®ä¸­ï¼Œå¤§éƒ¨åˆ†ç³»ç»Ÿéƒ½éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ï¼Œæ¶ˆæ¯è¢«ç¯¡æ”¹çš„æƒ…å†µæ¯”è¾ƒç½•è§ï¼›ç¡¬ä»¶æˆ–ç½‘ç»œåŸå› å¯¼è‡´çš„æ¶ˆæ¯ä¸å®Œæ•´é—®é¢˜ï¼Œåªéœ€ä¸€å¥—ç®€å•çš„æ ¡éªŒç®—æ³•å³å¯é¿å…ã€‚å› æ­¤å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œå¯ä»¥å‡è®¾ä¸å­˜åœ¨æ‹œå åº­å°†å†›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä»€ä¹ˆæ ·çš„ç®—æ³•æ¥ä¿è¯ä¸€è‡´æ€§ï¼Ÿ</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤å¸Œè…Šæœ‰ä¸€ä¸ªå« Paxos çš„å°å²›ï¼Œå²›ä¸Šé‡‡ç”¨è®®ä¼šçš„å½¢å¼æ¥é€šè¿‡æ³•ä»¤ï¼Œè®®å‘˜é—´é€šè¿‡ä¿¡ä½¿è¿›è¡Œæ¶ˆæ¯çš„ä¼ é€’ï¼Œè®®å‘˜æˆ–ä¿¡ä½¿éƒ½æ˜¯å…¼èŒçš„ï¼Œéšæ—¶å¯èƒ½ç¦»å¼€è®®ä¼šå…ï¼Œä¿¡ä½¿å¯èƒ½ä¼šé‡å¤çš„ä¼ é€’æ¶ˆæ¯ï¼Œä¹Ÿå¯èƒ½ä¸€å»ä¸å›ã€‚è®®ä¼šåè®®è¦ä¿è¯åœ¨è¿™ç§æƒ…å†µä¸‹ä»èƒ½æ­£ç¡®çš„äº§ç”Ÿæ³•ä»¤ï¼Œå¹¶ä¸”ä¸å‡ºç°å†²çªã€‚</span><br></pre></td></tr></table></figure><p>Paxosç®—æ³•çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ï¼Œå³ Lamport çš„è®ºæ–‡ The Part-Time Parliament ä¸­æåˆ°çš„ synod ç®—æ³•ã€‚</p><h4 id="2-3-1-é—®é¢˜æè¿°"><a href="#2-3-1-é—®é¢˜æè¿°" class="headerlink" title="2.3.1 é—®é¢˜æè¿°"></a>2.3.1 é—®é¢˜æè¿°</h4><p>å¯¹äºä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•æ¥è¯´è¦ä¿è¯å‡ ç‚¹ï¼š</p><ul><li>åœ¨è¿™äº›è¢«æå‡ºçš„ææ¡ˆä¸­ï¼Œåªæœ‰ä¸€ä¸ªä¼šè¢«é€‰å®šã€‚</li><li>å¦‚æœæ²¡æœ‰ææ¡ˆè¢«æå‡ºï¼Œå°±ä¸ä¼šæœ‰è¢«é€‰å®šçš„ææ¡ˆã€‚</li><li>å½“ä¸€ä¸ªææ¡ˆè¢«é€‰å®šåï¼Œè¿›ç¨‹åº”è¯¥å¯ä»¥è·å–è¢«é€‰å®šçš„ææ¡ˆä¿¡æ¯ã€‚</li></ul><p>ä¸€è‡´æ€§çš„å®‰å…¨æ€§éœ€æ±‚ï¼šï¼ˆPaxosçš„ç›®æ ‡å°±æ˜¯ä¿è¯æœ€ç»ˆæœ‰ä¸€ä¸ªææ¡ˆè¢«é€‰å®šï¼‰</p><ul><li>åªæœ‰è¢«æå‡ºçš„ææ¡ˆæ‰èƒ½è¢«é€‰å®šã€‚</li><li>åªèƒ½æœ‰ä¸€ä¸ªå€¼è¢«é€‰å®šã€‚</li><li>å¦‚æœæŸä¸ªè¿›ç¨‹è®¤ä¸ºæŸä¸ªææ¡ˆè¢«é€‰å®šäº†ï¼Œè¿™ä¸ªææ¡ˆå¿…é¡»æ˜¯çœŸçš„è¢«é€‰å®šçš„é‚£ä¸ªã€‚</li></ul><p>åœ¨è¯¥ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œæœ‰ä¸‰ç§å‚ä¸è§’è‰²ï¼šProposerï¼ˆæè®®äººï¼‰ã€Acceptorï¼ˆæ¥æ”¶äººï¼‰å’Œ Learner ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½å……å½“ä¸åªä¸€ç§è§’è‰²ï¼Œå‡è®¾ä¸åŒå‚ä¸è€…ä¹‹é—´å¯ä»¥é€šè¿‡æ”¶å‘æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡ï¼š</p><ul><li>æ¯ä¸ªå‚ä¸è€…ä»¥ä»»æ„çš„é€Ÿåº¦æ‰§è¡Œï¼Œå¯èƒ½ä¼šå› ä¸ºå‡ºé”™è€Œåœæ­¢ï¼Œä¹Ÿå¯èƒ½ä¼šé‡å¯ã€‚å³ä½¿ä¸€ä¸ªææ¡ˆè¢«é€‰å®šåï¼Œæ‰€æœ‰å‚ä¸è€…ä¹Ÿæœ‰å¯èƒ½å¤±è´¥æˆ–é‡å¯ï¼Œå› æ­¤é™¤éå¤±è´¥æˆ–é‡å¯çš„å‚ä¸è€…å¯ä»¥è®°å½•æŸäº›ä¿¡æ¯ï¼Œå¦åˆ™å°†æ— æ³•ç¡®å®šæœ€ç»ˆçš„å€¼ã€‚</li><li>æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸å¯é¢„çŸ¥çš„å»¶è¿Ÿï¼Œä¹Ÿå¯èƒ½ä¼šé‡å¤æˆ–ä¸¢å¤±ï¼Œä½†æ˜¯æ¶ˆæ¯ä¸ä¼šè¢«æŸåï¼Œå³æ¶ˆæ¯å†…å®¹ä¸ä¼šè¢«ç¯¡æ”¹ã€‚</li></ul><h4 id="2-3-2-ææ¡ˆçš„é€‰å®š"><a href="#2-3-2-ææ¡ˆçš„é€‰å®š" class="headerlink" title="2.3.2 ææ¡ˆçš„é€‰å®š"></a>2.3.2 ææ¡ˆçš„é€‰å®š</h4><p>é€‰å®šä¸€ä¸ªå”¯ä¸€ææ¡ˆï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆæ˜¯åªå…è®¸ä¸€ä¸ª Acceptor å­˜åœ¨ï¼ŒProposer åªèƒ½å‘é€ææ¡ˆç»™å®ƒï¼ŒAcceptor é€‰æ‹©å®ƒæ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆï¼Œè¿™ç§æ–¹æ¡ˆå­˜åœ¨å•ç‚¹æ•…éšœã€‚</p><p>å­˜åœ¨å¤šä¸ª Acceptor ï¼šProposer å‘ä¸€ä¸ª Acceptor é›†åˆå‘é€ææ¡ˆï¼Œé›†åˆä¸­æ¯ä¸ª Acceptor éƒ½å¯èƒ½ä¼šæ‰¹å‡†è¯¥ææ¡ˆï¼Œå½“æœ‰è¶³å¤Ÿå¤šçš„ Acceptor æ‰¹å‡†è¿™ä¸ªææ¡ˆæ—¶ï¼Œå°±å¯ä»¥è®¤ä¸ºå®ƒè¢«é€‰å®šäº†ã€‚</p><h4 id="2-3-3-æ¨å¯¼è¿‡ç¨‹"><a href="#2-3-3-æ¨å¯¼è¿‡ç¨‹" class="headerlink" title="2.3.3 æ¨å¯¼è¿‡ç¨‹"></a>2.3.3 æ¨å¯¼è¿‡ç¨‹</h4><p>éœ€æ±‚ï¼šåœ¨æ²¡æœ‰å¤±è´¥å’Œæ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªææ¡ˆè¢«æå‡ºï¼Œä¹Ÿè¦é€‰å‡ºä¸€ä¸ªææ¡ˆã€‚</p><p>è¿™å°±æ„å‘³ç€<strong>P1ï¼šä¸€ä¸ª Acceptor å¿…é¡»æ‰¹å‡†å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆ</strong>ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ¯ä¸ª Acceptor éƒ½æ‰¹å‡†äº†ç¬¬ä¸€ä¸ªææ¡ˆï¼Œä½†æ²¡æœ‰ä¸€ä¸ªææ¡ˆæ˜¯å¤šæ•°äººæ‰¹å‡†çš„ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200107.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200108.png"></p><p>ä¸€ä¸ªææ¡ˆéœ€è¦ç”±åŠæ•°ä»¥ä¸Šçš„ Acceptor æ‰¹å‡†çš„éœ€æ±‚æš—ç¤ºç€<strong>ä¸€ä¸ª Acceptor å¿…é¡»èƒ½å¤Ÿæ‰¹å‡†ä¸æ­¢ä¸€ä¸ªææ¡ˆ</strong>ã€‚</p><p>Paxos ä½¿ç”¨ä¸€ä¸ª<strong>å…¨å±€ç¼–å·</strong>æ¥å”¯ä¸€æ ‡è¯†æ¯ä¸€ä¸ªè¢« Acceptor æ‰¹å‡†çš„ææ¡ˆï¼Œå½“ä¸€ä¸ªå…·æœ‰æŸ Value å€¼çš„ææ¡ˆè¢«åŠæ•°ä»¥ä¸Šçš„ Acceptor æ‰¹å‡†åï¼Œå³è¯¥ Value è¢«é€‰å®šäº†å’Œè¯¥ææ¡ˆè¢«é€‰å®šäº†ã€‚ææ¡ˆå˜æˆäº†ä¸€ä¸ªç”±ç¼–å·å’Œ Value ç»„æˆçš„ç»„åˆä½“ â€œã€ç¼–å·, Valueã€‘â€ã€‚</p><p><strong>P2ï¼šå¦‚æœç¼–å·ä¸ºM<del>0</del>ã€Valueå€¼ä¸ºV<del>0</del>çš„ææ¡ˆè¢«é€‰å®šäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰æ¯”ç¼–å·M<del>0</del>æ›´é«˜çš„ï¼Œä¸”è¢«é€‰å®šçš„ï¼ˆè¢« Acceptor æ‰¹å‡†çš„ï¼‰ææ¡ˆï¼Œå…¶Valueå€¼å¿…é¡»ä¹Ÿæ˜¯V<del>0</del></strong></p><p>é€šä¿¡æ˜¯å¼‚æ­¥çš„ï¼Œä¸€ä¸ªææ¡ˆå¯èƒ½ä¼šåœ¨æŸä¸ª Acceptor è¿˜æœªæ”¶åˆ°ä»»ä½•ææ¡ˆæ—¶å°±è¢«é€‰å®šäº†ï¼Œæ‰€ä»¥ä»éœ€è¦P1æ¥ä¿è¯ææ¡ˆä¼šè¢«é€‰å®šã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200109.png"></p><p><strong>P2bï¼šå¦‚æœä¸€ä¸ªææ¡ˆ[M<del>0</del>, V<del>0</del>]è¢«é€‰å®šåï¼Œé‚£ä¹ˆä¹‹åä»»ä½• Proposer äº§ç”Ÿçš„ç¼–å·æ›´é«˜çš„ææ¡ˆï¼Œå…¶Valueå€¼å¿…é¡»ä¹Ÿæ˜¯V<del>0</del></strong></p><p>å› ä¸ºä¸€ä¸ªææ¡ˆå¿…é¡»åœ¨è¢« Proposer æå‡ºåæ‰èƒ½è¢« Acceptor æ‰¹å‡†ï¼Œæ‰€ä»¥P2båŒ…å«P2ã€‚</p><h4 id="2-3-4-æ•°å­¦å½’çº³æ³•è¯æ˜"><a href="#2-3-4-æ•°å­¦å½’çº³æ³•è¯æ˜" class="headerlink" title="2.3.4 æ•°å­¦å½’çº³æ³•è¯æ˜"></a>2.3.4 æ•°å­¦å½’çº³æ³•è¯æ˜</h4><p>éœ€è¦è¯æ˜ç»“è®ºï¼š**å‡è®¾æŸä¸ªææ¡ˆ[M<del>0</del>, V<del>0</del>]è¢«é€‰å®šäº†ï¼Œè¯æ˜ä»»ä½•ç¼–å·M<del>n</del>&gt;M<del>0</del>çš„ææ¡ˆï¼Œå…¶Valueå€¼éƒ½æ˜¯V<del>0</del>**ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹M<del>n</del>è¿›è¡Œç¬¬äºŒæ•°å­¦å½’çº³æ³•è¿›è¡Œè¯æ˜ï¼Œå³è¯æ˜ï¼š**å‡è®¾ç¼–å·åœ¨M<del>0</del>åˆ°M<del>n-1</del>ä¹‹é—´çš„ææ¡ˆï¼Œå…¶Valueå€¼éƒ½æ˜¯V<del>0</del>ï¼Œè¯æ˜ç¼–å·ä¸ºM<del>n</del>çš„ææ¡ˆçš„Valueå€¼ä¹Ÿä¸ºV<del>0</del>**ã€‚</p><p>å› ä¸ºM<del>0</del>çš„ææ¡ˆå·²è¢«é€‰å®šï¼Œæ„å‘³ç€è‚¯å®šå­˜åœ¨ä¸€ä¸ªç”±åŠæ•°ä»¥ä¸Šçš„ Acceptor ç»„æˆçš„é›†åˆCï¼Œéƒ½æ‰¹å‡†äº†ææ¡ˆã€‚**Cä¸­çš„æ¯ä¸ª Acceptor éƒ½æ‰¹å‡†äº†åœ¨M<del>0</del>åˆ°M<del>n-1</del>èŒƒå›´å†…çš„ææ¡ˆï¼Œå¹¶ä¸”æ¯ä¸ªç¼–å·åœ¨M<del>0</del>åˆ°M<del>n-1</del>ä¹‹é—´çš„è¢«æ‰¹å‡†çš„ææ¡ˆï¼Œå…¶Valueå€¼éƒ½æ˜¯V<del>0</del>**ã€‚</p><p>å› ä¸ºä»»ä½•åŒ…å«åŠæ•°ä»¥ä¸Šçš„ Acceptor ç»„æˆçš„é›†åˆéƒ½è‡³å°‘åŒ…å«ä¸€ä¸ªCçš„æˆå‘˜ï¼Œæ‰€ä»¥å¦‚æœä¿æŒä¸‹é¢P2cçš„ä¸å˜æ€§ï¼Œå¯ä»¥è®¤ä¸ºç¼–å·ä¸ºM<del>n</del>çš„ææ¡ˆçš„Valueå€¼ä¹Ÿä¸ºV<del>0</del>ã€‚</p><p><strong>P2cï¼šå¯¹äºä»»æ„çš„M<del>n</del>å’ŒV<del>n</del>ï¼Œå¦‚æœææ¡ˆ[M<del>n</del>, V<del>n</del>]è¢«æå‡ºï¼Œé‚£ä¹ˆè‚¯å®šå­˜åœ¨ä¸€ä¸ªç”±åŠæ•°ä»¥ä¸Šçš„ Acceptor ç»„å‡ºçš„é›†åˆSï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼š</strong></p><ul><li>è¦ä¹ˆï¼ŒSä¸­ä¸å­˜åœ¨ä»»ä½•æ‰¹å‡†è¿‡ç¼–å·å°äºM<del>n</del>çš„ææ¡ˆçš„ Acceptorã€‚</li><li>è¦ä¹ˆï¼Œé€‰å–Sä¸­æ‰€æœ‰ Acceptor æ‰¹å‡†çš„ç¼–å·å°äº M<del>n</del> çš„ææ¡ˆï¼Œå…¶ä¸­ç¼–å·æœ€å¤§çš„å“ªä¸ªææ¡ˆå…¶ Value å€¼æ˜¯ V<del>n</del> ã€‚</li></ul><p>P2c=&gt;P2b=&gt;P2ï¼Œé€šè¿‡P2å’ŒP1ä¿è¯ä¸€è‡´æ€§ã€‚</p><p>å‡è®¾ææ¡ˆ[M<del>0</del>, V<del>0</del>]è¢«é€‰å®šäº†ï¼Œéœ€è¦è¯æ˜åœ¨P2cçš„å‰æä¸‹ï¼Œå¯¹äºæ‰€æœ‰çš„[M<del>n</del>, V<del>n</del>]ï¼Œå­˜åœ¨ V<del>n</del> = V<del>0</del> ï¼šï¼ˆç¬¬äºŒæ•°å­¦å½’çº³æ³•ï¼‰</p><ol><li>å½“ M<del>n</del> = M<del>0</del> + 1 æ—¶ï¼Œå› ä¸º[M<del>0</del>, V<del>0</del>]è¢«é€‰å®šäº†ï¼Œä¸€å®šä¼šå­˜åœ¨ä¸€ä¸ª Acceptor çš„å­é›†Sï¼ŒSä¸­çš„ Acceptor å·²æ‰¹å‡†äº†å°äº M<del>n</del> çš„ææ¡ˆï¼Œå› æ­¤ V<del>n</del> åªèƒ½æ˜¯Sä¸­ç¼–å·å°äº  M<del>n</del> ä½†ä¸ºæœ€å¤§ç¼–å·çš„ææ¡ˆã€‚å› ä¸º M<del>n</del> = M<del>0</del> + 1 ï¼Œæ‰€ä»¥ææ¡ˆæ˜¯ [M<del>0</del>, V<del>0</del>] ï¼›åŒæ—¶ç”±äºSå’Œé€šè¿‡[M<del>0</del>, V<del>0</del>]çš„é›†åˆéƒ½æ˜¯å¤šæ•°é›†ï¼Œæ‰€ä»¥äºŒè€…ä¸€å®šå­˜åœ¨äº¤é›†ï¼Œè¿™æ · Proposer åœ¨ç¡®å®š V<del>n</del> å–å€¼æ—¶ä¸€å®šä¼šé€‰æ‹© V<del>0</del> ã€‚</li><li>ç¼–å·åœ¨ M<del>0</del> + 1 åˆ° M<del>n</del> - 1 ä¹‹é—´çš„Valueå€¼éƒ½ä¸º V<del>0</del> ï¼Œè¦è¯æ˜ç¼–å·ä¸º M<del>n</del> çš„ææ¡ˆçš„Valueå€¼ä¹Ÿä¸º V<del>0</del> ã€‚æ ¹æ®P1cï¼Œä¸€å®šä¼šå­˜åœ¨ä¸€ä¸ª Acceptor çš„å­é›†Sï¼ŒSä¸­çš„ Acceptor å·²æ‰¹å‡†äº†å°äº M<del>n</del> çš„ææ¡ˆï¼Œé‚£ä¹ˆç¼–å·ä¸º M<del>n</del> çš„ææ¡ˆçš„Valueå€¼åªèƒ½æ˜¯Sä¸­ç¼–å·å°äº M<del>n</del> ä½†ä¸ºæœ€å¤§ç¼–å·çš„ææ¡ˆçš„å€¼ã€‚åªè¦ç¼–å·è½åœ¨ M<del>0</del> + 1 åˆ° M<del>n</del> - 1 ä¹‹é—´ï¼Œé‚£ä¹ˆValueå€¼å°±æ˜¯ V<del>0</del> ï¼›å¦‚æœä¸è½åœ¨åŒºé—´å†…ï¼Œé‚£è‚¯å®šæ˜¯ M<del>0</del> ï¼Œå› ä¸ºSè‚¯å®šä¼šå’Œæ‰¹å‡†[M<del>0</del>, V<del>0</del>]çš„é›†åˆæœ‰äº¤é›†ï¼Œå¦‚æœç¼–å·ä¸º M<del>0</del> ï¼Œé‚£ä¹ˆå…¶Valueå€¼ä¹Ÿä¸º V<del>0</del> ã€‚</li></ol><h4 id="2-3-5-Proposer-ç”Ÿæˆææ¡ˆ"><a href="#2-3-5-Proposer-ç”Ÿæˆææ¡ˆ" class="headerlink" title="2.3.5 Proposer ç”Ÿæˆææ¡ˆ"></a>2.3.5 Proposer ç”Ÿæˆææ¡ˆ</h4><p>å¯¹äº Proposer æ¥è¯´ï¼Œè·å–å·²ç»è¢«é€šè¿‡çš„ææ¡ˆè¿œæ¯”é¢„æµ‹æœªæ¥å¯èƒ½è¢«é€šè¿‡çš„ææ¡ˆç®€å•ã€‚å› æ­¤ <strong>Proposer åœ¨äº§ç”Ÿä¸€ä¸ªç¼–å·ä¸º M<del>n</del> çš„ææ¡ˆæ—¶ï¼Œå¿…é¡»è¦çŸ¥é“å½“å‰ä¸€ä¸ªå°†è¦æˆ–å·²ç»è¢«åŠæ•°ä»¥ä¸Š Acceptor æ‰¹å‡†çš„ç¼–å·å°äº M<del>n</del> çš„æœ€å¤§ææ¡ˆç¼–å·ã€‚å¹¶ä¸” Proposer ä¼šè¦æ±‚æ‰€æœ‰ Acceptor ä¸å†æ‰¹å‡†ä»»ä½•ç¼–å·å°äº M<del>n</del> çš„ææ¡ˆ</strong>ã€‚  </p><p><strong>ææ¡ˆç”Ÿæˆç®—æ³•</strong>ï¼š</p><ol><li>Proposer é€‰æ‹©ä¸€ä¸ªæ–°çš„ææ¡ˆç¼–å· M<del>n</del> ï¼Œç„¶åå‘æŸä¸ª Acceptor é›†åˆçš„æˆå‘˜å‘é€è¯·æ±‚ï¼ˆå³ç¼–å·ä¸º M<del>n</del> çš„ææ¡ˆçš„ Prepare è¯·æ±‚ï¼‰ï¼Œè¦æ±‚è¯¥é›†åˆä¸­çš„ Acceptor åšå‡ºå¦‚ä¸‹å›åº”ã€‚<ul><li>å‘ Proposer æ‰¿è¯ºï¼Œä¿è¯ä¸å†æ‰¹å‡†ä»»ä½•ç¼–å·å°äº M<del>n</del> çš„ææ¡ˆã€‚</li><li>å¦‚æœ Acceptor å·²ç»æ‰¹å‡†è¿‡ä»»ä½•ææ¡ˆï¼Œé‚£ä¹ˆå…¶å°±å‘ Proposer åé¦ˆå½“å‰è¯¥ Acceptor å·²ç»æ‰¹å‡†çš„ç¼–å·å°äº M<del>n</del> ä½†ä¸ºæœ€å¤§ç¼–å·çš„é‚£ä¸ªææ¡ˆçš„å€¼ã€‚</li></ul></li><li>å¦‚æœ Proposer æ”¶åˆ°äº†æ¥è‡ªåŠæ•°ä»¥ä¸Šçš„ Acceptor çš„å“åº”ç»“æœï¼Œé‚£ä¹ˆå®ƒå¯ä»¥äº§ç”Ÿç¼–å·ä¸º M<del>n</del> ã€Valueå€¼ä¸º V<del>n</del> çš„ææ¡ˆï¼ŒV<del>n</del> æ˜¯æ‰€æœ‰å“åº”ä¸­ç¼–å·æœ€å¤§çš„ææ¡ˆçš„ Value å€¼ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå³åŠæ•°ä»¥ä¸Šéƒ½æœªæ‰¹å‡†è¿‡ä»»ä½•ææ¡ˆï¼Œä¹Ÿå³å“åº”ä¸­ä¸åŒ…å«ä»»ä½•ææ¡ˆï¼Œæ­¤æ—¶ V<del>n</del> å€¼å¯ä»¥ç”± Proposer ä»»æ„é€‰æ‹©ã€‚</li></ol><p>Proposer å‘é€ç»™ Acceptor é€‰å®šçš„ææ¡ˆæœŸæœ›è·å¾—æ‰¹å‡†çš„è¯·æ±‚å«Acceptè¯·æ±‚ã€‚æ¥å—è¯·æ±‚çš„ Acceptor é›†åˆä¸ä¸€å®šæ˜¯ä¹‹å‰å“åº”Prepareè¯·æ±‚çš„é‚£ä¸€ä¸ªã€‚</p><h4 id="2-3-6-Acceptor-æ‰¹å‡†ææ¡ˆ"><a href="#2-3-6-Acceptor-æ‰¹å‡†ææ¡ˆ" class="headerlink" title="2.3.6 Acceptor æ‰¹å‡†ææ¡ˆ"></a>2.3.6 Acceptor æ‰¹å‡†ææ¡ˆ</h4><p>ä¸€ä¸ª Acceptor å¯èƒ½æ¥æ”¶åˆ°ä¸¤ç§æ¥è‡ª Proposer çš„è¯·æ±‚ï¼š</p><ul><li><strong>Prepareè¯·æ±‚ï¼š</strong>Acceptor å¯ä»¥åœ¨ä»»ä½•æ—¶å€™å“åº”ã€‚</li><li><strong>Acceptè¯·æ±‚ï¼š</strong>åœ¨ä¸è¿èƒŒAcceptç°æœ‰æ‰¿è¯ºçš„å‰æä¸‹ï¼Œä»»æ„å“åº”Acceptè¯·æ±‚ã€‚</li></ul><p><strong>P1aï¼šä¸€ä¸ª Acceptor åªè¦å°šæœªå“åº”è¿‡ä»»ä½•ç¼–å·å¤§äº M<del>n</del> çš„Prepareè¯·æ±‚ï¼Œå®ƒå°±å¯ä»¥æ¥å—è¿™ä¸ªç¼–å·ä¸º M<del>n</del> çš„ææ¡ˆã€‚</strong></p><h4 id="2-3-7-ç®—æ³•ä¼˜åŒ–"><a href="#2-3-7-ç®—æ³•ä¼˜åŒ–" class="headerlink" title="2.3.7 ç®—æ³•ä¼˜åŒ–"></a>2.3.7 ç®—æ³•ä¼˜åŒ–</h4><p>å‡è®¾ä¸€ä¸ª Acceptor æ”¶åˆ°äº†ä¸€ä¸ªç¼–å·ä¸º M<del>n</del> çš„Prepareè¯·æ±‚ï¼Œä½†æ­¤æ—¶å®ƒå·²ç»å¯¹å¤§äº M<del>n</del> çš„Prepareè¯·æ±‚åšå‡ºäº†å“åº”ï¼Œå› æ­¤å®ƒè‚¯å®šä¸ä¼šå†æ‰¹å‡†ç¼–å· M<del>n</del> çš„ææ¡ˆï¼Œæ‰€ä»¥ Acceptor æ²¡æœ‰å¿…è¦å¯¹æ­¤è¯·æ±‚åšå‡ºå“åº”ï¼Œå¯ä»¥é€‰æ‹©å¿½ç•¥è¿™ç§Prepareè¯·æ±‚ã€‚åŒç†è¿˜å¯ä»¥å¿½ç•¥å·²ç»æ‰¹å‡†è¿‡çš„ææ¡ˆçš„Prepareè¯·æ±‚ã€‚</p><p>è¿™æ · Acceptor åªéœ€è®°ä½å®ƒå·²ç»æ‰¹å‡†çš„ææ¡ˆçš„æœ€å¤§ç¼–å·å’Œå®ƒå·²ç»åšå‡ºPrepareè¯·æ±‚å“åº”çš„ææ¡ˆçš„æœ€å¤§ç¼–å·ï¼Œä»¥ä¾¿å†å‡ºç°æ•…éšœæˆ–èŠ‚ç‚¹é‡å¯æ—¶ä¹Ÿèƒ½ä¿è¯P2cçš„ä¸å˜æ€§ã€‚</p><p>å¯¹äº Proposer æ¥è¯´ï¼Œåªè¦ä¿è¯ä¸ä¼šäº§ç”Ÿç›¸åŒç¼–å·çš„ææ¡ˆï¼Œå¯ä»¥ä¸¢å¼ƒä»»æ„ææ¡ˆå’Œè¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯ã€‚</p><h4 id="2-3-8-ç®—æ³•é™ˆè¿°"><a href="#2-3-8-ç®—æ³•é™ˆè¿°" class="headerlink" title="2.3.8 ç®—æ³•é™ˆè¿°"></a>2.3.8 ç®—æ³•é™ˆè¿°</h4><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªç±»ä¼¼äºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ul><li>é˜¶æ®µä¸€<ol><li>Proposer é€‰æ‹©ä¸€ä¸ªææ¡ˆç¼–å· M<del>n</del> ï¼Œç„¶åå‘ Acceptor çš„æŸä¸ªè¶…è¿‡åŠæ•°çš„å­é›†æˆå‘˜å‘é€ç¼–å·ä¸º M<del>n</del> çš„Prepareè¯·æ±‚ã€‚</li><li>å¦‚æœä¸€ä¸ª Acceptor æ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸º M<del>n</del> çš„Prepareè¯·æ±‚ï¼Œä¸”ç¼–å· M<del>n</del> å¤§äºå®ƒå·²ç»å“åº”çš„æ‰€æœ‰Prepareè¯·æ±‚çš„ç¼–å·ï¼Œé‚£ä¹ˆå®ƒä¼šå°†å®ƒå·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™ Proposer ï¼ŒåŒæ—¶æ‰¿è¯ºä¸ä¼šå†æ‰¹å‡†å°äºç¼–å· M<del>n</del> çš„ä»»ä½•ææ¡ˆã€‚</li></ol></li><li>é˜¶æ®µäºŒ<ol><li>å¦‚æœ Proposer æ”¶åˆ°æ¥è‡ªåŠæ•°ä»¥ä¸Šçš„ Acceptor å¯¹äºå…¶å‘å‡ºçš„ç¼–å·ä¸º M<del>n</del> çš„Prepareè¯·æ±‚çš„å“åº”ï¼Œå®ƒå°±ä¼šå‘é€ä¸€ä¸ªé’ˆå¯¹[M<del>n</del>, V<del>n</del>]ææ¡ˆçš„ Accept è¯·æ±‚ç»™ Acceptor ï¼ˆ V<del>n</del> ä¸ºæ”¶åˆ°çš„å“åº”ä¸­ç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè‹¥å“åº”ä¸­ä¸åŒ…å«ææ¡ˆï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„å€¼ï¼‰ã€‚</li><li>å¦‚æœ Acceptor æ”¶åˆ°æ­¤ Accept è¯·æ±‚ï¼Œåªè¦è¯¥ Acceptor å°šæœªå¯¹ç¼–å·å¤§äº M<del>n</del> çš„Prepareè¯·æ±‚åšå‡ºå“åº”ï¼Œå®ƒå°±å¯ä»¥é€šè¿‡è¿™ä¸ªææ¡ˆã€‚</li></ol></li></ul><h4 id="2-3-9-ææ¡ˆçš„è·å–"><a href="#2-3-9-ææ¡ˆçš„è·å–" class="headerlink" title="2.3.9 ææ¡ˆçš„è·å–"></a>2.3.9 ææ¡ˆçš„è·å–</h4><p>Learner è·å–ææ¡ˆçš„å‡ ç§æ–¹æ¡ˆï¼š</p><ol><li>Learner è·å–ææ¡ˆçš„å‰ææ˜¯æ­¤ææ¡ˆå·²è¢«åŠæ•°ä»¥ä¸Šçš„ Acceptor æ‰¹å‡†ã€‚å› æ­¤æœ€ç®€å•çš„åšæ³•æ˜¯ä¸€æ—¦ Acceptor æ‰¹å‡†äº†ææ¡ˆï¼Œå°±æŠŠå…¶å‘é€ç»™æ‰€æœ‰çš„ Learner ã€‚è¿™ç§åšæ³•ä¼šè®©æ¯ä¸ª Acceptor ä¸æ‰€æœ‰çš„ Learner é€šä¿¡ï¼Œé€šä¿¡æ¬¡æ•°è‡³å°‘ä¸ºäºŒè€…ä¸ªæ•°çš„ä¹˜ç§¯ã€‚</li><li>è®©æ‰€æœ‰çš„ Acceptor å¯¹ææ¡ˆçš„æ‰¹å‡†æƒ…å†µç»Ÿä¸€å‘é€ç»™ä¸€ä¸ª<strong>ä¸»Learner</strong>ï¼Œä¸»Learner è¢«é€šçŸ¥ä¸€ä¸ªææ¡ˆå·²è¢«é€‰å®šåä¼šè´Ÿè´£é€šçŸ¥å…¶ä»– Learner ã€‚æ­¤æ–¹æ¡ˆé€šè¿‡å¤šåŠ ä¸€ä¸ªæ­¥éª¤ï¼Œå¤§å¤§å‡å°‘äº†é€šä¿¡æ¬¡æ•°ï¼Œä½†å¸¦æ¥äº†ä¸»Learnerå¯èƒ½å‘ç”Ÿæ•…éšœè¿™ä¸ªéšæ‚£ã€‚</li><li>é’ˆå¯¹æ–¹æ¡ˆäºŒï¼Œå°†ä¸»Learneræ‰©å¤§ä¸ºç‰¹å®šçš„Learneré›†åˆï¼Œä»è€Œæé«˜å¯é æ€§ã€‚</li></ol><h4 id="2-3-10-é€šè¿‡é€‰å–ä¸»Proposerä¿è¯ç®—æ³•çš„æ´»æ€§"><a href="#2-3-10-é€šè¿‡é€‰å–ä¸»Proposerä¿è¯ç®—æ³•çš„æ´»æ€§" class="headerlink" title="2.3.10 é€šè¿‡é€‰å–ä¸»Proposerä¿è¯ç®—æ³•çš„æ´»æ€§"></a>2.3.10 é€šè¿‡é€‰å–ä¸»Proposerä¿è¯ç®—æ³•çš„æ´»æ€§</h4><p>Paxosç®—æ³•å¯èƒ½ä¼šå‡ºç°å¤šä¸ªProposerç›¸äº’å¯¼è‡´å¯¹æ–¹ææ¡ˆè¯·æ±‚è¢«å¿½ç•¥çš„æ­»å¾ªç¯ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210401/202104200110.png"></p><p>è§£å†³æ–¹æ¡ˆï¼šé€‰å®šä¸€ä¸ªä¸»Proposerï¼Œå¹¶è§„å®šåªæœ‰ä¸»Proposeræ‰èƒ½æå‡ºè®®æ¡ˆã€‚</p><p><strong>åŸºäºBest Efforts 1PCæ¨¡å¼çš„äº‹åŠ¡</strong>ï¼Œå‚è€ƒspring-data-neo4jçš„å®ç°ã€‚é‰´äºBest Efforts 1PCæ¨¡å¼çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä»¥åŠç›¸å¯¹ç®€å•çš„å®ç°æ–¹å¼ï¼Œå®ƒè¢«å¤§å¤šæ•°çš„shardingæ¡†æ¶å’Œé¡¹ç›®é‡‡ç”¨</p><p><strong>äº‹åŠ¡è¡¥å¿ï¼ˆå¹‚ç­‰å€¼ï¼‰</strong></p><p>å¯¹äºé‚£äº›å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜ï¼Œä½†å¯¹ä¸€è‡´æ€§è¦æ±‚å¹¶ä¸é«˜çš„ç³»ç»Ÿï¼Œå¾€å¾€å¹¶ä¸è‹›æ±‚ç³»ç»Ÿçš„å®æ—¶ä¸€è‡´æ€§ï¼Œåªè¦åœ¨ä¸€ä¸ªå…è®¸çš„æ—¶é—´å‘¨æœŸå†…è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§å³å¯ï¼Œè¿™ä½¿å¾—äº‹åŠ¡è¡¥å¿æœºåˆ¶æˆä¸ºä¸€ç§å¯è¡Œçš„æ–¹æ¡ˆã€‚äº‹åŠ¡è¡¥å¿æœºåˆ¶æœ€åˆè¢«æå‡ºæ˜¯åœ¨â€œé•¿äº‹åŠ¡â€çš„å¤„ç†ä¸­ï¼Œä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿç¡®ä¿ä¸€è‡´æ€§ä¹Ÿæœ‰å¾ˆå¥½çš„å‚è€ƒæ„ä¹‰ã€‚ç¬¼ç»Ÿåœ°è®²ï¼Œä¸äº‹åŠ¡åœ¨æ‰§è¡Œä¸­å‘ç”Ÿé”™è¯¯åç«‹å³å›æ»šçš„æ–¹å¼ä¸åŒï¼Œäº‹åŠ¡è¡¥å¿æ˜¯ä¸€ç§äº‹åæ£€æŸ¥å¹¶è¡¥æ•‘çš„æªæ–½ï¼Œå®ƒåªæœŸæœ›åœ¨ä¸€ä¸ªå®¹è®¸æ—¶é—´å‘¨æœŸå†…å¾—åˆ°æœ€ç»ˆä¸€è‡´çš„ç»“æœå°±å¯ä»¥äº†ã€‚äº‹åŠ¡è¡¥å¿çš„å®ç°ä¸ç³»ç»Ÿä¸šåŠ¡ç´§å¯†ç›¸å…³ï¼Œå¹¶æ²¡æœ‰ä¸€ç§æ ‡å‡†çš„å¤„ç†æ–¹å¼ã€‚ä¸€äº›å¸¸è§çš„å®ç°æ–¹å¼æœ‰ï¼šå¯¹æ•°æ®è¿›è¡Œå¯¹å¸æ£€æŸ¥;åŸºäºæ—¥å¿—è¿›è¡Œæ¯”å¯¹;å®šæœŸåŒæ ‡å‡†æ•°æ®æ¥æºè¿›è¡ŒåŒæ­¥ï¼Œç­‰ç­‰ã€‚</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/24036067">https://zhuanlan.zhihu.com/p/24036067</a></p><p>äº‹åŠ¡æ”¯æŒï¼šæˆ‘ä»¬æ˜¯å°†æ•´ä¸ªè®¢å•é¢†åŸŸèšåˆä½“åˆ‡åˆ†ï¼Œç»´åº¦ä¸€è‡´ï¼Œæ‰€ä»¥å¯¹èšåˆä½“çš„äº‹åŠ¡æ˜¯æ”¯æŒçš„ã€‚</p><p>å¤æ‚æŸ¥è¯¢ï¼šå‚ç›´åˆ‡åˆ†åï¼Œå°±è·Ÿjoinè¯´æ‹œæ‹œäº†ï¼›æ°´å¹³åˆ‡åˆ†åï¼ŒæŸ¥è¯¢çš„æ¡ä»¶ä¸€å®šè¦åœ¨åˆ‡åˆ†çš„ç»´åº¦å†…ï¼Œæ¯”å¦‚æŸ¥è¯¢å…·ä½“æŸä¸ªç”¨æˆ·ä¸‹çš„å„ä½è®¢å•ç­‰ï¼›ç¦æ­¢ä¸å¸¦åˆ‡åˆ†çš„ç»´åº¦çš„æŸ¥è¯¢ï¼Œå³ä½¿ä¸­é—´ä»¶å¯ä»¥æ”¯æŒè¿™ç§æŸ¥è¯¢ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­ç»„è£…ï¼Œä½†æ˜¯è¿™ç§éœ€æ±‚å¾€å¾€ä¸åº”è¯¥åœ¨åœ¨çº¿åº“æŸ¥è¯¢ï¼Œæˆ–è€…å¯ä»¥é€šè¿‡å…¶ä»–æ–¹æ³•è½¬æ¢åˆ°åˆ‡åˆ†çš„ç»´åº¦æ¥å®ç°ã€‚</p></blockquote><p>ä¸€æ—¦æ•°æ®åº“è¢«åˆ‡åˆ†åˆ°å¤šä¸ªç‰©ç†ç»“ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°†ä¸èƒ½å†ä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ã€‚ä¸€æ–¹é¢ï¼ŒæŸä¸ªåˆ†åŒºæ•°æ®åº“è‡ªç”Ÿæˆçš„IDæ— æ³•ä¿è¯åœ¨å…¨å±€ä¸Šæ˜¯å”¯ä¸€çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºåœ¨æ’å…¥æ•°æ®ä¹‹å‰éœ€è¦å…ˆè·å¾—ID,ä»¥ä¾¿è¿›è¡ŒSQLè·¯ç”±ã€‚</p><ol><li>åˆ©ç”¨æ•°æ®åº“è‡ªå¢IDå’ŒUUID</li></ol><p>ä¼˜ç‚¹ï¼šæœ€ç®€å•ã€‚</p><p>ç¼ºç‚¹ï¼šå•ç‚¹é£é™©ã€å•æœºæ€§èƒ½ç“¶é¢ˆã€‚</p><blockquote><p>ä½¿ç”¨UUIDä½œä¸»é”®æ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾çš„ã€‚ç”±äºUUIDéå¸¸çš„é•¿ï¼Œé™¤å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´å¤–ï¼Œæœ€ä¸»è¦çš„é—®é¢˜æ˜¯åœ¨ç´¢å¼•ä¸Šï¼Œåœ¨å»ºç«‹ç´¢å¼•å’ŒåŸºäºç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶éƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚</p></blockquote><ol start="2"><li>ç»“åˆæ•°æ®åº“ç»´æŠ¤ä¸€ä¸ªSequenceè¡¨</li></ol><p>æ­¤æ–¹æ¡ˆçš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨æ•°æ®åº“ä¸­å»ºç«‹ä¸€ä¸ªSequenceè¡¨ï¼Œè¡¨çš„ç»“æ„ç±»ä¼¼äºï¼š</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`SEQUENCE`</span> (  </span><br><span class="line">    <span class="symbol">`table_name`</span> varchar(<span class="number">18</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    <span class="symbol">`nextid`</span> bigint(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`table_name`</span>)  </span><br><span class="line">) ENGINE=InnoDB</span><br></pre></td></tr></table></figure><p>æ¯å½“éœ€è¦ä¸ºæŸä¸ªè¡¨çš„æ–°çºªå½•ç”ŸæˆIDæ—¶å°±ä»Sequenceè¡¨ä¸­å–å‡ºå¯¹åº”è¡¨çš„nextid,å¹¶å°†nextidçš„å€¼åŠ 1åæ›´æ–°åˆ°æ•°æ®åº“ä¸­ä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚æ­¤æ–¹æ¡ˆä¹Ÿè¾ƒç®€å•ï¼Œä½†ç¼ºç‚¹åŒæ ·æ˜æ˜¾ï¼šç”±äºæ‰€æœ‰æ’å…¥ä»»ä½•éƒ½éœ€è¦è®¿é—®è¯¥è¡¨ï¼Œè¯¥è¡¨å¾ˆå®¹æ˜“æˆä¸ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆï¼ŒåŒæ—¶å®ƒä¹Ÿå­˜åœ¨å•ç‚¹é—®é¢˜ï¼Œä¸€æ—¦è¯¥è¡¨æ•°æ®åº“å¤±æ•ˆï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºå°†æ— æ³•å·¥ä½œã€‚æœ‰äººæå‡ºä½¿ç”¨Master-Slaveè¿›è¡Œä¸»ä»åŒæ­¥ï¼Œä½†è¿™ä¹Ÿåªèƒ½è§£å†³å•ç‚¹é—®é¢˜ï¼Œå¹¶ä¸èƒ½è§£å†³è¯»å†™æ¯”ä¸º1:1çš„è®¿é—®å‹åŠ›é—®é¢˜ã€‚</p><ol start="3"><li>åˆ©ç”¨æ•°æ®åº“é›†ç¾¤å¹¶è®¾ç½®ç›¸åº”çš„æ­¥é•¿ï¼ˆFlickræ–¹æ¡ˆï¼‰</li></ol><p>ä¼˜ç‚¹ï¼šé«˜å¯ç”¨ã€IDè¾ƒç®€æ´ã€‚</p><p>ç¼ºç‚¹ï¼šéœ€è¦å•ç‹¬çš„æ•°æ®åº“é›†ç¾¤ã€‚</p><ol start="4"><li>Twitter Snowflake</li></ol><p>ä¼˜ç‚¹ï¼šé«˜æ€§èƒ½é«˜å¯ç”¨ã€æ˜“æ‹“å±•ã€‚</p><p>ç¼ºç‚¹ï¼šéœ€è¦ç‹¬ç«‹çš„é›†ç¾¤ä»¥åŠZKã€‚</p><blockquote><p><a href="http://blog.sina.com.cn/s/blog_6b7c2e660102vbi2.html" title="Title">Twitterçš„åˆ†å¸ƒå¼è‡ªå¢IDç®—æ³•Snowflake</a></p><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œéœ€è¦ç”Ÿæˆå…¨å±€UIDçš„åœºåˆè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œtwitterçš„snowflakeè§£å†³äº†è¿™ç§éœ€æ±‚ï¼Œå®ç°ä¹Ÿè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé™¤å»é…ç½®ä¿¡æ¯ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯æ¯«ç§’çº§æ—¶é—´41ä½ æœºå™¨ID 10ä½ æ¯«ç§’å†…åºåˆ—12ä½ã€‚</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">*</span> <span class="comment">10</span>--<span class="literal">-</span><span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0000000000</span> <span class="comment">0</span> --<span class="literal">-</span> <span class="comment">00000</span> --<span class="literal">-</span><span class="comment">00000</span> --<span class="literal">-</span><span class="comment">000000000000</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„å­—ç¬¦ä¸²ä¸­ï¼Œç¬¬ä¸€ä½ä¸ºæœªä½¿ç”¨ï¼ˆå®é™…ä¸Šä¹Ÿå¯ä½œä¸ºlongçš„ç¬¦å·ä½ï¼‰ï¼Œæ¥ä¸‹æ¥çš„41ä½ä¸ºæ¯«ç§’çº§æ—¶é—´ï¼Œç„¶å5ä½datacenteræ ‡è¯†ä½ï¼Œ5ä½æœºå™¨IDï¼ˆå¹¶ä¸ç®—æ ‡è¯†ç¬¦ï¼Œå®é™…æ˜¯ä¸ºçº¿ç¨‹æ ‡è¯†ï¼‰ï¼Œç„¶å12ä½è¯¥æ¯«ç§’å†…çš„å½“å‰æ¯«ç§’å†…çš„è®¡æ•°ï¼ŒåŠ èµ·æ¥åˆšå¥½64ä½ï¼Œä¸ºä¸€ä¸ªLongå‹ã€‚</p><p>è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œæ•´ä½“ä¸ŠæŒ‰ç…§æ—¶é—´è‡ªå¢æ’åºï¼Œå¹¶ä¸”æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”ŸIDç¢°æ’ï¼ˆç”±datacenterå’Œæœºå™¨IDä½œåŒºåˆ†ï¼‰ï¼Œå¹¶ä¸”æ•ˆç‡è¾ƒé«˜ï¼Œç»æµ‹è¯•ï¼Œsnowflakeæ¯ç§’èƒ½å¤Ÿäº§ç”Ÿ26ä¸‡IDå·¦å³ï¼Œå®Œå…¨æ»¡è¶³éœ€è¦ã€‚</p></blockquote><ol start="5"><li>ä¸€å¤§æ³¢GUIDã€Randomç®—æ³•</li></ol><p>ä¼˜ç‚¹ï¼šç®€å•ã€‚</p><p>ç¼ºç‚¹ï¼šç”ŸæˆIDè¾ƒé•¿ï¼Œæœ‰é‡å¤å‡ ç‡ã€‚</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/24036067">https://zhuanlan.zhihu.com/p/24036067</a> åšä¸»å›¢é˜Ÿé‡‡ç”¨çš„ç­–ç•¥æ˜¯ï¼šæ—¶é—´æˆ³+ç”¨æˆ·æ ‡è¯†ç +éšæœºæ•°</p><p>ä¼˜ç‚¹æœ‰ï¼š</p><ul><li><p>æ–¹ä¾¿ã€æˆæœ¬ä½ã€‚</p></li><li><p>åŸºæœ¬æ— é‡å¤çš„å¯èƒ½ã€‚</p></li><li><p>è‡ªå¸¦åˆ†åº“è§„åˆ™ï¼Œè¿™é‡Œçš„ç”¨æˆ·æ ‡è¯†ç å³ä¸ºç”¨æˆ·IDçš„åå››ä½ï¼Œåœ¨æŸ¥è¯¢çš„åœºæ™¯ä¸‹ï¼Œåªéœ€è¦è®¢å•å·å°±å¯ä»¥åŒ¹é…åˆ°ç›¸åº”çš„åº“è¡¨è€Œæ— éœ€ç”¨æˆ·IDï¼Œåªå–å››ä½æ˜¯å¸Œæœ›è®¢</p></li><li><p>å•å·å°½å¯èƒ½çš„çŸ­ä¸€äº›ï¼Œå¹¶ä¸”è¯„ä¼°ä¸‹æ¥å››ä½å·²ç»è¶³å¤Ÿã€‚</p></li><li><p>å¯æ’åºï¼Œå› ä¸ºæ—¶é—´æˆ³åœ¨æœ€å‰é¢ã€‚</p></li></ul><p>å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚é•¿åº¦ç¨é•¿ï¼Œæ€§èƒ½è¦æ¯”int/bigintçš„ç¨å·®ç­‰ã€‚</p></blockquote><p><a href="https://www.cnblogs.com/mayundalao/p/11798502.html">åˆ†å¸ƒå¼äº‹åŠ¡çš„å››ç§è§£å†³æ–¹æ¡ˆ</a></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">ç®€å•æ•´ç†äº†åˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³çŸ¥è¯†ï¼Œå†…å®¹åŒ…æ‹¬ï¼šACIDåˆ°CAP/BASEï¼Œ2PCäºŒé˜¶æ®µæäº¤ï¼Œ3PCä¸‰é˜¶æ®µæäº¤ï¼ŒPaxosç®—æ³•ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="transaction" scheme="http://linyishui.top/tags/transaction/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼é”</title>
    <link href="http://linyishui.top/2021042001.html"/>
    <id>http://linyishui.top/2021042001.html</id>
    <published>2021-04-20T13:26:57.000Z</published>
    <updated>2021-05-13T08:26:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¹‚ç­‰"><a href="#å¹‚ç­‰" class="headerlink" title="å¹‚ç­‰"></a>å¹‚ç­‰</h2><p>æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆå«å¹‚ç­‰ï¼Ÿåœ¨åˆ†å¸ƒå¼åº”ç”¨ä¸­ï¼Œå¹‚ç­‰æ˜¯éå¸¸é‡è¦çš„ï¼Œä¹Ÿå°±æ˜¯ç›¸åŒæ¡ä»¶ä¸‹å¯¹ä¸€ä¸ªä¸šåŠ¡çš„æ“ä½œï¼Œä¸ç®¡æ“ä½œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·ã€‚</p><p>ä¸ºä»€ä¹ˆè¦æœ‰å¹‚ç­‰è¿™ç§åœºæ™¯ï¼Ÿå› ä¸ºåœ¨å¤§çš„ç³»ç»Ÿä¸­ï¼Œéƒ½æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¦‚ï¼šè®¢å•ä¸šåŠ¡ å’Œ åº“å­˜ä¸šåŠ¡æœ‰å¯èƒ½éƒ½æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„ï¼Œéƒ½æ˜¯å•ç‹¬çš„æœåŠ¡ã€‚ç”¨æˆ·ä¸‹è®¢å•ï¼Œä¼šè°ƒç”¨åˆ°è®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡ã€‚</p><p><img src="https://p6-tt.byteimg.com/origin/pgc-image/ee6b8a81617a444fb8bac512ee7d3ebd?from=pc" alt="æµ·é‡è®¢å•äº§ç”Ÿçš„ä¸šåŠ¡é«˜å³°æœŸï¼Œå¦‚ä½•é¿å…æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹ï¼Ÿ"></p><p>å› ä¸ºåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨è°ƒç”¨åº“å­˜æœåŠ¡æ—¶ï¼Œå› ä¸ºç½‘ç»œç­‰åŸå› ï¼Œè®¢å•æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½†å…¶å®åº“å­˜æœåŠ¡å·²ç»å¤„ç†å®Œæˆï¼Œåªæ˜¯è¿”å›ç»™è®¢å•æœåŠ¡å¤„ç†ç»“æœæ—¶å‡ºç°äº†å¼‚å¸¸ã€‚è¿™ä¸ªæ—¶å€™ä¸€èˆ¬ç³»ç»Ÿä¼šä½œè¡¥å¿æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯è®¢å•æœåŠ¡å†æ­¤æ”¾èµ·åº“å­˜æœåŠ¡çš„è°ƒç”¨,åº“å­˜å‡1.</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> <span class="built_in">count</span> = <span class="built_in">count</span> <span class="number">-1</span> <span class="keyword">where</span> good_id=<span class="number">2</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å‡ºç°äº†é—®é¢˜ï¼Œå…¶å®ä¸Šä¸€æ¬¡è°ƒç”¨å·²ç»å‡äº†1ï¼Œåªæ˜¯è®¢å•æœåŠ¡æ²¡æœ‰æ”¶åˆ°å¤„ç†ç»“æœã€‚ç°åœ¨åˆè°ƒç”¨ä¸€æ¬¡ï¼Œåˆè¦å‡1ï¼Œè¿™æ ·å°±ä¸ç¬¦åˆä¸šåŠ¡äº†ï¼Œå¤šæ‰£äº†ã€‚</p><p>å¹‚ç­‰è¿™ä¸ªæ¦‚å¿µå°±æ˜¯ï¼Œä¸ç®¡åº“å­˜æœåŠ¡åœ¨ç›¸åŒæ¡ä»¶ä¸‹è°ƒç”¨å‡ æ¬¡ï¼Œå¤„ç†ç»“æœéƒ½ä¸€æ ·ã€‚è¿™æ ·æ‰èƒ½ä¿è¯è¡¥å¿æ–¹æ¡ˆçš„å¯è¡Œæ€§ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä¹è§‚é”æ–¹æ¡ˆ"><a href="#ä¹è§‚é”æ–¹æ¡ˆ" class="headerlink" title="ä¹è§‚é”æ–¹æ¡ˆ"></a>ä¹è§‚é”æ–¹æ¡ˆ</h3><p>å€Ÿé‰´æ•°æ®åº“çš„ä¹è§‚é”æœºåˆ¶ï¼Œå¦‚ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update t_goods <span class="keyword">set</span> <span class="built_in">count</span> = <span class="built_in">count</span> <span class="number">-1</span> , <span class="built_in">version</span> = <span class="built_in">version</span> + <span class="number">1</span> <span class="keyword">where</span> good_id=<span class="number">2</span> <span class="keyword">and</span> <span class="built_in">version</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®versionç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯åœ¨æ“ä½œåº“å­˜å‰å…ˆè·å–å½“å‰å•†å“çš„versionç‰ˆæœ¬å·ï¼Œç„¶åæ“ä½œçš„æ—¶å€™å¸¦ä¸Šæ­¤versionå·ã€‚æˆ‘ä»¬æ¢³ç†ä¸‹ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡æ“ä½œåº“å­˜æ—¶ï¼Œå¾—åˆ°versionä¸º1ï¼Œè°ƒç”¨åº“å­˜æœåŠ¡versionå˜æˆäº†2ï¼›ä½†è¿”å›ç»™è®¢å•æœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œè®¢å•æœåŠ¡åˆä¸€æ¬¡å‘èµ·è°ƒç”¨åº“å­˜æœåŠ¡ï¼Œå½“è®¢å•æœåŠ¡ä¼ å¦‚çš„versionè¿˜æ˜¯1ï¼Œå†æ‰§è¡Œä¸Šé¢çš„sqlè¯­å¥æ—¶ï¼Œå°±ä¸ä¼šæ‰§è¡Œï¼›å› ä¸ºversionå·²ç»å˜ä¸º2äº†ï¼Œwhereæ¡ä»¶å°±ä¸æˆç«‹ã€‚è¿™æ ·å°±ä¿è¯äº†ä¸ç®¡è°ƒç”¨å‡ æ¬¡ï¼Œåªä¼šçœŸæ­£çš„å¤„ç†ä¸€æ¬¡ã€‚</p><h3 id="å”¯ä¸€ID-æŒ‡çº¹ç "><a href="#å”¯ä¸€ID-æŒ‡çº¹ç " class="headerlink" title="å”¯ä¸€ID + æŒ‡çº¹ç "></a>å”¯ä¸€ID + æŒ‡çº¹ç </h3><p>åŸç†å°±æ˜¯åˆ©ç”¨æ•°æ®åº“ä¸»é”®å»é‡ï¼Œä¸šåŠ¡å®Œæˆåæ’å…¥ä¸»é”®æ ‡è¯†</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> t_check <span class="keyword">where</span> ID<span class="operator">=</span>å”¯ä¸€ID <span class="operator">+</span> æŒ‡çº¹ç </span><br></pre></td></tr></table></figure><ul><li>å”¯ä¸€IDå°±æ˜¯ä¸šåŠ¡è¡¨çš„å”¯ä¸€çš„ä¸»é”®ï¼Œå¦‚å•†å“ID</li><li>æŒ‡çº¹ç å°±æ˜¯ä¸ºäº†åŒºåˆ«æ¯æ¬¡æ­£å¸¸æ“ä½œçš„ç ï¼Œæ¯æ¬¡æ“ä½œæ—¶ç”ŸæˆæŒ‡çº¹ç ï¼›å¯ä»¥ç”¨æ—¶é—´æˆ³+ä¸šåŠ¡ç¼–å·çš„æ–¹å¼ã€‚</li></ul><p>ä¸Šé¢çš„sqlè¯­å¥ï¼š</p><ul><li>è¿”å›å¦‚æœä¸º0 è¡¨ç¤ºæ²¡æœ‰æ“ä½œè¿‡ï¼Œé‚£ä¸šåŠ¡æ“ä½œåå°±å¯ä»¥insert into t_check(å”¯ä¸€ID+æŒ‡çº¹ç )</li><li>è¿”å›å¦‚æœå¤§äº0 è¡¨ç¤ºæ“ä½œè¿‡ï¼Œå°±ç›´æ¥è¿”å›</li></ul><p>å¥½å¤„ï¼šå®ç°ç®€å•</p><p>åå¤„ï¼šé«˜å¹¶å‘ä¸‹æ•°æ®åº“ç“¶é¢ˆ</p><p>è§£å†³æ–¹æ¡ˆï¼šæ ¹æ®IDè¿›è¡Œåˆ†åº“åˆ†è¡¨è¿›è¡Œç®—æ³•è·¯ç”±</p><h3 id="redisåŸå­æ“ä½œ"><a href="#redisåŸå­æ“ä½œ" class="headerlink" title="redisåŸå­æ“ä½œ"></a>redisåŸå­æ“ä½œ</h3><p>åˆ©ç”¨redisçš„åŸå­æ“ä½œï¼Œåšä¸ªæ“ä½œå®Œæˆçš„æ ‡è®°ã€‚è¿™ä¸ªæ€§èƒ½å°±æ¯”è¾ƒå¥½ã€‚ä½†ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ã€‚</p><p>ç¬¬ä¸€ï¼šæˆ‘ä»¬æ˜¯å¦éœ€è¦æŠŠä¸šåŠ¡ç»“æœè¿›è¡Œæ•°æ®è½åº“ï¼Œå¦‚æœè½åº“ï¼Œå…³é”®è§£å†³çš„é—®é¢˜æ—¶æ•°æ®åº“å’Œredisæ“ä½œå¦‚ä½•åšåˆ°åŸå­æ€§ï¼Ÿ</p><blockquote><p>è¿™ä¸ªæ„æ€å°±æ˜¯åº“å­˜å‡1äº†ï¼Œä½†redisè¿›è¡Œæ“ä½œå®Œæˆæ ‡è®°æ—¶ï¼Œå¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿä¹Ÿå°±æ˜¯ä¸€å®šè¦ä¿è¯è½åº“å’Œredis è¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥</p></blockquote><p>ç¬¬äºŒï¼šå¦‚æœä¸è¿›è¡Œè½åº“ï¼Œé‚£ä¹ˆéƒ½å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚ä½•è®¾ç½®å®šæ—¶åŒæ­¥ç­–ç•¥ï¼Ÿ</p><blockquote><p>è¿™ä¸ªæ„æ€å°±æ˜¯åº“å­˜å‡1ï¼Œä¸è½åº“ï¼Œç›´æ¥å…ˆæ“ä½œredisæ“ä½œå®Œæˆæ ‡è®°ï¼Œç„¶åç”±å¦å¤–çš„åŒæ­¥æœåŠ¡è¿›è¡Œåº“å­˜è½åº“ï¼Œè¿™ä¸ªå°±æ˜¯å¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ï¼Œè€Œä¸”åŒæ­¥ç­–ç•¥å¦‚ä½•è®¾ç½®</p></blockquote><ul><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/zhishixingqiu/?zhihu">ã€ŠJava 2019 è¶…ç¥ä¹‹è·¯ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Dubbo/good-collection/?zhihu">ã€ŠDubbo å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring/good-collection/?zhihu">ã€ŠSpring å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/MyBatis/good-collection/?zhihu">ã€ŠMyBatis å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring-MVC/good-collection/?zhihu">ã€ŠSpring MVC å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Spring-Boot/good-collection/?zhihu">ã€ŠSpring Boot å®ç°åŸç†ä¸æºç è§£æ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Entity/good-collection/?zhihu">ã€Šæ•°æ®åº“å®ä½“è®¾è®¡åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Interview/good-collection/?zhihu">ã€ŠJava é¢è¯•é¢˜ â€”â€” ç²¾å“åˆé›†ã€‹</a></li><li><a href="https://link.zhihu.com/?target=http://www.iocoder.cn/Interview/good-collection/?zhihu">ã€ŠJava å­¦ä¹ æŒ‡å— â€”â€” ç²¾å“åˆé›†ã€‹</a></li></ul><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">ç®€å•æ•´ç†äº†åˆ†å¸ƒå¼é”ç›¸å…³çŸ¥è¯†ï¼Œå†…å®¹åŒ…æ‹¬ï¼šç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="lock" scheme="http://linyishui.top/tags/lock/"/>
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ä¸€è‡´æ€§</title>
    <link href="http://linyishui.top/2021041901.html"/>
    <id>http://linyishui.top/2021041901.html</id>
    <published>2021-04-19T13:26:49.000Z</published>
    <updated>2021-05-13T08:24:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ†å¸ƒå¼ä¸€è‡´æ€§"><a href="#åˆ†å¸ƒå¼ä¸€è‡´æ€§" class="headerlink" title="åˆ†å¸ƒå¼ä¸€è‡´æ€§"></a>åˆ†å¸ƒå¼ä¸€è‡´æ€§</h1><h2 id="ä¸€-å¼•æ–‡"><a href="#ä¸€-å¼•æ–‡" class="headerlink" title="ä¸€. å¼•æ–‡"></a>ä¸€. å¼•æ–‡</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯å¹¶å‘ï¼Ÿ</h3><p>å¹¶å‘ï¼šå½“é€»è¾‘æ§åˆ¶æµï¼ˆä¸€æ¬¡ç¨‹åºæ“ä½œï¼Œå¦‚è¯»å–æˆ–æ›´æ–°å†…å­˜å˜é‡çš„å€¼ï¼‰åœ¨æ—¶é—´ä¸Šé‡å ï¼Œé‚£å®ƒå°±æ˜¯å¹¶å‘çš„ã€‚</p><p>ä¸€èˆ¬å¹¶å‘éƒ½ç‰¹æŒ‡æ›´æ–°æ“ä½œçš„å¹¶å‘ï¼Œå³æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°å†…å­˜ä¸­å˜é‡çš„å€¼ã€‚</p><h3 id="1-2-æ•°æ®å¤åˆ¶å»¶æ—¶é—®é¢˜"><a href="#1-2-æ•°æ®å¤åˆ¶å»¶æ—¶é—®é¢˜" class="headerlink" title="1.2 æ•°æ®å¤åˆ¶å»¶æ—¶é—®é¢˜"></a>1.2 æ•°æ®å¤åˆ¶å»¶æ—¶é—®é¢˜</h3><p>æ•°æ®å¤åˆ¶ä¸€èˆ¬ä¼šæœ‰å»¶æ—¶é—®é¢˜ï¼Œå³æ— æ³•åŠæ—¶è¯»å–åˆ°æ›´æ–°åçš„æœ€æ–°æ•°æ®ã€‚</p><h3 id="1-3-åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜"><a href="#1-3-åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="1.3 åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜"></a>1.3 åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜</h3><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸€èˆ¬é‡‡ç”¨æ•°æ®å¤åˆ¶éƒ½æ˜¯åŸºäºä¸¤ç±»éœ€æ±‚ï¼š</p><ul><li>å¢åŠ ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œé˜²æ­¢å•ç‚¹æ•…éšœå¼•èµ·çš„ç³»ç»Ÿä¸å¯ç”¨ï¼›</li><li>æä¾›ç³»ç»Ÿæ•´ä½“æ€§èƒ½ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œè®©åˆ†å¸ƒåœ¨ä¸åŒä½ç½®çš„æ•°æ®å‰¯æœ¬éƒ½ä¸ºç”¨æˆ·æä¾›æœåŠ¡ã€‚</li></ul><p><strong>åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜</strong>ï¼šåœ¨<strong>åˆ†å¸ƒå¼ç¯å¢ƒ</strong>å¼•å…¥<strong>æ•°æ®å¤åˆ¶æœºåˆ¶</strong>åï¼Œä¸åŒæ•°æ®èŠ‚ç‚¹é—´å¯èƒ½å‡ºç°çš„ï¼Œå¹¶æ— æ³•ä¾é åº”ç”¨ç¨‹åºè‡ªèº«è§£å†³çš„<strong>æ•°æ®ä¸ä¸€è‡´æƒ…å†µ</strong>ã€‚</p><p><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šæŒ‡å¯¹ä¸€ä¸ªå‰¯æœ¬æ•°æ®è¿›è¡Œæ›´æ–°çš„åŒæ—¶ï¼Œå¿…é¡»ç¡®ä¿èƒ½å¤Ÿæ›´æ–°å…¶ä»–çš„å‰¯æœ¬ã€‚</p><h3 id="1-4-å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ"><a href="#1-4-å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ" class="headerlink" title="1.4 å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ"></a>1.4 å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Ÿ</h3><p>æ—¢ç„¶æ˜¯ç”±äºå»¶æ—¶å¼•èµ·çš„é—®é¢˜ï¼Œå¯ä»¥å°†å†™å…¥çš„åŠ¨ä½œé˜»å¡ï¼Œç›´åˆ°æ•°æ®å¤åˆ¶å®Œæˆåï¼Œæ‰å®Œæˆå†™å…¥åŠ¨ä½œã€‚</p><p>è¿™æ ·èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼š<strong>å†™å…¥çš„æ€§èƒ½å¾ˆå·®</strong>ã€‚åç»­çš„å†™è¯·æ±‚éƒ½è¦é˜»å¡åœ¨å‰ä¸€ä¸ªè¯·æ±‚çš„å†™æ“ä½œä¸Šï¼Œä¸é€‚ç”¨äºæœ‰å¤§é‡å†™è¯·æ±‚çš„åœºæ™¯ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œä¸å½±å“ç³»ç»Ÿè¿è¡Œçš„æ€§èƒ½é—´åšä¸€ä¸ªæƒè¡¡ï¼Œä»è€Œåˆ’åˆ†å‡º<strong>ä¸€è‡´æ€§çº§åˆ«</strong>ï¼š</p><ul><li>å¼ºä¸€è‡´æ€§ï¼šç³»ç»Ÿå†™å…¥ä»€ä¹ˆï¼Œè¯»å‡ºæ¥å°±æ˜¯ä»€ä¹ˆï¼Œä¼šå¯¹æ€§èƒ½æœ‰è¾ƒå¤§å½±å“ã€‚</li><li>å¼±ä¸€è‡´æ€§ï¼šç³»ç»Ÿå†™å…¥æˆåŠŸåä¸ä¿è¯å¯ä»¥ç«‹åˆ»è¯»åˆ°å†™å…¥çš„å€¼ï¼Œåªå°½å¯èƒ½çš„ä¿è¯åœ¨æŸä¸ªæ—¶é—´çº§åˆ«ï¼ˆå¦‚ç§’çº§åˆ«ï¼‰åï¼Œæ•°æ®èƒ½è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€ï¼Œç»†åˆ†ï¼š<ul><li>ä¼šè¯ä¸€è‡´æ€§ï¼šåªä¿è¯å¯¹äºå†™å…¥çš„å€¼ï¼Œåœ¨åŒä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯ä¸­å¯ä»¥è¯»å–åˆ°ä¸€è‡´çš„å€¼ï¼Œå…¶ä»–ä¼šè¯ä¸èƒ½ä¿è¯ã€‚</li><li>ç”¨æˆ·ä¸€è‡´æ€§ï¼šåªä¿è¯å¯¹äºå†™å…¥çš„å€¼ï¼Œåœ¨åŒä¸€ä¸ªç”¨æˆ·ä¸­å¯ä»¥è¯»å–åˆ°ä¸€è‡´çš„å€¼ï¼Œå…¶ä»–ç”¨æˆ·ä¸èƒ½ä¿è¯ã€‚</li></ul></li><li>æœ€ç»ˆä¸€è‡´æ€§ï¼šç‰¹æ®Šçš„å¼±ä¸€è‡´æ€§ï¼Œéå¸¸é‡è¦çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ã€‚</li></ul><p>æ¥ä¸‹æ¥å¼•å…¥å‡ ç§å…¸å‹çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œå­¦ä¹ å®ƒä»¬æ˜¯å¦‚ä½•è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ã€‚</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šä»Paxosåˆ°Zookeeper-åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</p>]]></content>
    
    
    <summary type="html">ç®€å•æ•´ç†äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§ç›¸å…³çŸ¥è¯†ï¼Œå†…å®¹åŒ…æ‹¬ï¼šå¼•æ–‡ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="consistency" scheme="http://linyishui.top/tags/consistency/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€è§„åˆ’ï¼ˆæœªå®Œæˆï¼‰</title>
    <link href="http://linyishui.top/2021031501.html"/>
    <id>http://linyishui.top/2021031501.html</id>
    <published>2021-03-15T13:57:00.000Z</published>
    <updated>2021-05-13T08:21:22.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æ€è§„åˆ’"><a href="#åŠ¨æ€è§„åˆ’" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h1><h2 id="ä¸€-æ¦‚è¿°"><a href="#ä¸€-æ¦‚è¿°" class="headerlink" title="ä¸€. æ¦‚è¿°"></a>ä¸€. æ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯åŠ¨æ€è§„åˆ’ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯åŠ¨æ€è§„åˆ’ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€è§„åˆ’ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€è§„åˆ’ï¼Ÿ</h3><p><strong>åŠ¨æ€è§„åˆ’</strong>ï¼ˆè‹±è¯­ï¼šDynamic Programmingï¼Œç®€ç§°DPï¼‰æ˜¯ä¸€ç§<strong>é€šè¿‡æŠŠåŸé—®é¢˜åˆ†è§£ä¸ºç›¸å¯¹ç®€å•çš„å­é—®é¢˜çš„æ–¹å¼æ±‚è§£å¤æ‚é—®é¢˜çš„æ–¹æ³•</strong>ã€‚å¸¸å¸¸é€‚ç”¨äº<strong>æœ‰é‡å å­é—®é¢˜</strong>å’Œ<strong>æœ€ä¼˜å­ç»“æ„</strong>ï¼ˆOptimal substructureï¼‰æ€§è´¨çš„é—®é¢˜ï¼ŒåŠ¨æ€è§„åˆ’æ–¹æ³•æ‰€è€—æ—¶é—´å¾€å¾€è¿œå°‘äºæœ´ç´ è§£æ³•ã€‚</p><p>åœ¨20ä¸–çºª50å¹´ä»£åˆï¼Œç”±ç¾å›½æ•°å­¦å®¶è´å°”æ›¼ï¼ˆR.Bellmanï¼‰ç­‰äººåœ¨ç ”ç©¶å¤šé˜¶æ®µå†³ç­–è¿‡ç¨‹çš„ä¼˜åŒ–é—®é¢˜æ—¶ï¼Œæå‡ºäº†è‘—åçš„æœ€ä¼˜åŒ–åŸç†ï¼Œä»è€Œåˆ›ç«‹äº†åŠ¨æ€è§„åˆ’ã€‚</p><p>åŠ¨æ€è§„åˆ’èƒŒåçš„åŸºæœ¬æ€æƒ³éå¸¸ç®€å•ã€‚å¤§è‡´ä¸Šï¼Œè‹¥è¦è§£ä¸€ä¸ªç»™å®šé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è§£å…¶ä¸åŒéƒ¨åˆ†ï¼ˆå³å­é—®é¢˜ï¼‰ï¼Œå†æ ¹æ®å­é—®é¢˜çš„è§£ä»¥å¾—å‡ºåŸé—®é¢˜çš„è§£ã€‚</p><p>é€šå¸¸è®¸å¤šå­é—®é¢˜éå¸¸ç›¸ä¼¼ï¼Œä¸ºæ­¤åŠ¨æ€è§„åˆ’æ³•è¯•å›¾ä»…ä»…è§£å†³æ¯ä¸ªå­é—®é¢˜ä¸€æ¬¡ï¼Œä»è€Œå‡å°‘è®¡ç®—é‡ï¼š<strong>ä¸€æ—¦æŸä¸ªç»™å®šå­é—®é¢˜çš„è§£å·²ç»ç®—å‡ºï¼Œåˆ™å°†å…¶è®°å¿†åŒ–å­˜å‚¨ï¼Œä»¥ä¾¿ä¸‹æ¬¡éœ€è¦åŒä¸€ä¸ªå­é—®é¢˜è§£ä¹‹æ—¶ç›´æ¥æŸ¥è¡¨</strong>ã€‚è¿™ç§åšæ³•åœ¨é‡å¤å­é—®é¢˜çš„æ•°ç›®å…³äºè¾“å…¥çš„è§„æ¨¡å‘ˆæŒ‡æ•°å¢é•¿æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚</p><h3 id="æ¦‚å¿µå¼•å…¥"><a href="#æ¦‚å¿µå¼•å…¥" class="headerlink" title="æ¦‚å¿µå¼•å…¥"></a>æ¦‚å¿µå¼•å…¥</h3><p>åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæœ‰ä¸€ç±»æ´»åŠ¨çš„è¿‡ç¨‹ï¼Œç”±äºå®ƒçš„ç‰¹æ®Šæ€§ï¼Œå¯å°†è¿‡ç¨‹åˆ†æˆè‹¥å¹²ä¸ªäº’ç›¸è”ç³»çš„é˜¶æ®µï¼Œåœ¨å®ƒçš„æ¯ä¸€é˜¶æ®µéƒ½éœ€è¦ä½œå‡ºå†³ç­–ï¼Œä»è€Œä½¿æ•´ä¸ªè¿‡ç¨‹è¾¾åˆ°æœ€å¥½çš„æ´»åŠ¨æ•ˆæœã€‚å› æ­¤å„ä¸ªé˜¶æ®µå†³ç­–çš„é€‰å–ä¸èƒ½ä»»æ„ç¡®å®šï¼Œå®ƒä¾èµ–äºå½“å‰é¢ä¸´çš„çŠ¶æ€ï¼Œåˆå½±å“ä»¥åçš„å‘å±•ã€‚å½“å„ä¸ªé˜¶æ®µå†³ç­–ç¡®å®šåï¼Œå°±ç»„æˆä¸€ä¸ªå†³ç­–åºåˆ—ï¼Œå› è€Œä¹Ÿå°±ç¡®å®šäº†æ•´ä¸ªè¿‡ç¨‹çš„ä¸€æ¡æ´»åŠ¨è·¯çº¿ï¼è¿™ç§æŠŠä¸€ä¸ªé—®é¢˜çœ‹ä½œæ˜¯ä¸€ä¸ªå‰åå…³è”å…·æœ‰é“¾çŠ¶ç»“æ„çš„å¤šé˜¶æ®µè¿‡ç¨‹å°±ç§°ä¸ºå¤šé˜¶æ®µå†³ç­–è¿‡ç¨‹ï¼Œè¿™ç§é—®é¢˜ç§°ä¸ºå¤šé˜¶æ®µå†³ç­–é—®é¢˜ã€‚åœ¨å¤šé˜¶æ®µå†³ç­–é—®é¢˜ä¸­ï¼Œå„ä¸ªé˜¶æ®µé‡‡å–çš„å†³ç­–ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¸æ—¶é—´æœ‰å…³çš„ï¼Œå†³ç­–ä¾èµ–äºå½“å‰çŠ¶æ€ï¼Œåˆéšå³å¼•èµ·çŠ¶æ€çš„è½¬ç§»ï¼Œä¸€ä¸ªå†³ç­–åºåˆ—å°±æ˜¯åœ¨å˜åŒ–çš„çŠ¶æ€ä¸­äº§ç”Ÿå‡ºæ¥çš„ï¼Œæ•…æœ‰â€œåŠ¨æ€â€çš„å«ä¹‰ï¼Œç§°è¿™ç§è§£å†³å¤šé˜¶æ®µå†³ç­–æœ€ä¼˜åŒ–çš„è¿‡ç¨‹ä¸ºåŠ¨æ€è§„åˆ’æ–¹æ³• [4] ã€‚</p><h3 id="åŸºæœ¬æ€æƒ³"><a href="#åŸºæœ¬æ€æƒ³" class="headerlink" title="åŸºæœ¬æ€æƒ³"></a>åŸºæœ¬æ€æƒ³</h3><p>åŠ¨æ€è§„åˆ’ç®—æ³•é€šå¸¸ç”¨äºæ±‚è§£å…·æœ‰æŸç§æœ€ä¼˜æ€§è´¨çš„é—®é¢˜ã€‚åœ¨è¿™ç±»é—®é¢˜ä¸­ï¼Œå¯èƒ½ä¼šæœ‰è®¸å¤šå¯è¡Œè§£ã€‚æ¯ä¸€ä¸ªè§£éƒ½å¯¹åº”äºä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°å…·æœ‰<a href="https://baike.baidu.com/item/%E6%9C%80%E4%BC%98%E5%80%BC">æœ€ä¼˜å€¼</a>çš„è§£ã€‚åŠ¨æ€è§„åˆ’ç®—æ³•ä¸<a href="https://baike.baidu.com/item/%E5%88%86%E6%B2%BB%E6%B3%95">åˆ†æ²»æ³•</a>ç±»ä¼¼ï¼Œå…¶åŸºæœ¬æ€æƒ³ä¹Ÿæ˜¯å°†å¾…æ±‚è§£é—®é¢˜åˆ†è§£æˆè‹¥å¹²ä¸ªå­é—®é¢˜ï¼Œå…ˆæ±‚è§£å­é—®é¢˜ï¼Œç„¶åä»<a href="https://baike.baidu.com/item/%E8%BF%99%E4%BA%9B%E5%AD%90">è¿™äº›å­</a>é—®é¢˜çš„è§£å¾—åˆ°åŸé—®é¢˜çš„è§£ã€‚ä¸åˆ†æ²»æ³•ä¸åŒçš„æ˜¯ï¼Œé€‚åˆäºç”¨åŠ¨æ€è§„åˆ’æ±‚è§£çš„é—®é¢˜ï¼Œç»åˆ†è§£å¾—åˆ°å­é—®é¢˜å¾€å¾€ä¸æ˜¯äº’ç›¸ç‹¬ç«‹çš„ã€‚è‹¥ç”¨åˆ†æ²»æ³•æ¥è§£è¿™ç±»é—®é¢˜ï¼Œåˆ™åˆ†è§£å¾—åˆ°çš„å­é—®é¢˜æ•°ç›®å¤ªå¤šï¼Œæœ‰äº›å­é—®é¢˜è¢«é‡å¤è®¡ç®—äº†å¾ˆå¤šæ¬¡ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿å­˜å·²è§£å†³çš„å­é—®é¢˜çš„ç­”æ¡ˆï¼Œè€Œåœ¨éœ€è¦æ—¶å†æ‰¾å‡ºå·²æ±‚å¾—çš„ç­”æ¡ˆï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å¤§é‡çš„é‡å¤è®¡ç®—ï¼ŒèŠ‚çœæ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªè¡¨æ¥è®°å½•æ‰€æœ‰å·²è§£çš„å­é—®é¢˜çš„ç­”æ¡ˆã€‚ä¸ç®¡è¯¥å­é—®é¢˜ä»¥åæ˜¯å¦è¢«ç”¨åˆ°ï¼Œåªè¦å®ƒè¢«è®¡ç®—è¿‡ï¼Œå°±å°†å…¶ç»“æœå¡«å…¥è¡¨ä¸­ã€‚è¿™å°±æ˜¯åŠ¨æ€è§„åˆ’æ³•çš„åŸºæœ¬æ€è·¯ã€‚å…·ä½“çš„åŠ¨æ€è§„åˆ’ç®—æ³•å¤šç§å¤šæ ·ï¼Œä½†å®ƒä»¬å…·æœ‰ç›¸åŒçš„å¡«è¡¨æ ¼å¼ [5] ã€‚</p><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><ul><li><strong>å¤šé˜¶æ®µå†³ç­–é—®é¢˜</strong></li></ul><p>å¦‚æœä¸€ç±»æ´»åŠ¨è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºè‹¥å¹²ä¸ªäº’ç›¸è”ç³»çš„é˜¶æ®µï¼Œåœ¨æ¯ä¸€ä¸ªé˜¶æ®µéƒ½éœ€ä½œå‡ºå†³ç­–ï¼ˆé‡‡å–æªæ–½ï¼‰ï¼Œä¸€ä¸ªé˜¶æ®µçš„å†³ç­–ç¡®å®šä»¥åï¼Œå¸¸å¸¸å½±å“åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µçš„å†³ç­–ï¼Œä»è€Œå°±å®Œå…¨ç¡®å®šäº†ä¸€ä¸ªè¿‡ç¨‹çš„æ´»åŠ¨è·¯çº¿ï¼Œåˆ™ç§°å®ƒä¸ºå¤šé˜¶æ®µå†³ç­–é—®é¢˜ [6] ã€‚</p><p>å„ä¸ªé˜¶æ®µçš„å†³ç­–æ„æˆä¸€ä¸ªå†³ç­–åºåˆ—ï¼Œç§°ä¸ºä¸€ä¸ªç­–ç•¥ã€‚æ¯ä¸€ä¸ªé˜¶æ®µéƒ½æœ‰è‹¥å¹²ä¸ªå†³ç­–å¯ä¾›é€‰æ‹©ï¼Œå› è€Œå°±æœ‰è®¸å¤šç­–ç•¥ä¾›æˆ‘ä»¬é€‰å–ï¼Œå¯¹åº”äºä¸€ä¸ªç­–ç•¥å¯ä»¥ç¡®å®šæ´»åŠ¨çš„æ•ˆæœï¼Œè¿™ä¸ªæ•ˆæœå¯ä»¥ç”¨æ•°é‡æ¥ç¡®å®šã€‚ç­–ç•¥ä¸åŒï¼Œæ•ˆæœä¹Ÿä¸åŒï¼Œå¤šé˜¶æ®µå†³ç­–é—®é¢˜ï¼Œå°±æ˜¯è¦åœ¨å¯ä»¥é€‰æ‹©çš„é‚£äº›ç­–ç•¥ä¸­é—´ï¼Œé€‰å–ä¸€ä¸ªæœ€ä¼˜ç­–ç•¥ï¼Œä½¿åœ¨é¢„å®šçš„æ ‡å‡†ä¸‹è¾¾åˆ°æœ€å¥½çš„æ•ˆæœ [6] ã€‚</p><ul><li><strong>åŠ¨æ€è§„åˆ’é—®é¢˜ä¸­çš„æœ¯è¯­</strong></li></ul><p><a href="https://baike.baidu.com/item/%E9%98%B6%E6%AE%B5">é˜¶æ®µ</a>ï¼šæŠŠæ‰€ç»™æ±‚è§£é—®é¢˜çš„è¿‡ç¨‹æ°å½“åœ°åˆ†æˆè‹¥å¹²ä¸ªç›¸äº’è”ç³»çš„é˜¶æ®µï¼Œä»¥ä¾¿äºæ±‚è§£ï¼Œè¿‡ç¨‹ä¸åŒï¼Œé˜¶æ®µæ•°å°±å¯èƒ½ä¸åŒï¼æè¿°é˜¶æ®µçš„å˜é‡ç§°ä¸ºé˜¶æ®µå˜é‡ã€‚åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œé˜¶æ®µå˜é‡æ˜¯ç¦»æ•£çš„ï¼Œç”¨kè¡¨ç¤ºã€‚æ­¤å¤–ï¼Œä¹Ÿæœ‰é˜¶æ®µå˜é‡æ˜¯è¿ç»­çš„æƒ…å½¢ã€‚å¦‚æœè¿‡ç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»ä½œå‡ºå†³ç­–ï¼Œä¸”åœ¨ä»»æ„ä¸¤ä¸ªä¸åŒçš„æ—¶åˆ»ä¹‹é—´å…è®¸æœ‰æ— ç©·å¤šä¸ªå†³ç­–æ—¶ï¼Œé˜¶æ®µå˜é‡å°±æ˜¯è¿ç»­çš„ [6] ã€‚</p><p><a href="https://baike.baidu.com/item/%E7%8A%B6%E6%80%81">çŠ¶æ€</a>ï¼šçŠ¶æ€è¡¨ç¤ºæ¯ä¸ªé˜¶æ®µå¼€å§‹é¢ä¸´çš„è‡ªç„¶çŠ¶å†µæˆ–å®¢è§‚æ¡ä»¶ï¼Œå®ƒä¸ä»¥äººä»¬çš„ä¸»è§‚æ„å¿—ä¸ºè½¬ç§»ï¼Œä¹Ÿç§°ä¸ºä¸å¯æ§å› ç´ ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­çŠ¶æ€å°±æ˜¯æŸé˜¶æ®µçš„å‡ºå‘ä½ç½®ï¼Œå®ƒæ—¢æ˜¯è¯¥é˜¶æ®µæŸè·¯çš„èµ·ç‚¹ï¼ŒåŒæ—¶åˆæ˜¯å‰ä¸€é˜¶æ®µæŸæ”¯è·¯çš„ç»ˆç‚¹ [6] ã€‚</p><p><a href="https://baike.baidu.com/item/%E6%97%A0%E5%90%8E%E6%95%88%E6%80%A7">æ— åæ•ˆæ€§</a>ï¼šæˆ‘ä»¬è¦æ±‚çŠ¶æ€å…·æœ‰ä¸‹é¢çš„æ€§è´¨ï¼šå¦‚æœç»™å®šæŸä¸€é˜¶æ®µçš„çŠ¶æ€ï¼Œåˆ™åœ¨è¿™ä¸€é˜¶æ®µä»¥åè¿‡ç¨‹çš„å‘å±•ä¸å—è¿™é˜¶æ®µä»¥å‰å„æ®µçŠ¶æ€çš„å½±å“ï¼Œæ‰€æœ‰å„é˜¶æ®µéƒ½ç¡®å®šæ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¹Ÿå°±ç¡®å®šäº†ã€‚æ¢å¥è¯è¯´ï¼Œè¿‡ç¨‹çš„æ¯ä¸€æ¬¡å®ç°å¯ä»¥ç”¨ä¸€ä¸ªçŠ¶æ€åºåˆ—è¡¨ç¤ºï¼Œåœ¨å‰é¢çš„ä¾‹å­ä¸­æ¯é˜¶æ®µçš„çŠ¶æ€æ˜¯è¯¥çº¿è·¯çš„å§‹ç‚¹ï¼Œç¡®å®šäº†è¿™äº›ç‚¹çš„åºåˆ—ï¼Œæ•´ä¸ªçº¿è·¯ä¹Ÿå°±å®Œå…¨ç¡®å®šã€‚ä»æŸä¸€é˜¶æ®µä»¥åçš„çº¿è·¯å¼€å§‹ï¼Œå½“è¿™æ®µçš„å§‹ç‚¹ç»™å®šæ—¶ï¼Œä¸å—ä»¥å‰çº¿è·¯ï¼ˆæ‰€é€šè¿‡çš„ç‚¹ï¼‰çš„å½±å“ã€‚çŠ¶æ€çš„è¿™ä¸ªæ€§è´¨æ„å‘³ç€è¿‡ç¨‹çš„å†å²åªèƒ½é€šè¿‡å½“å‰çš„çŠ¶æ€å»å½±å“å®ƒçš„æœªæ¥çš„å‘å±•ï¼Œè¿™ä¸ªæ€§è´¨ç§°ä¸ºæ— åæ•ˆæ€§ [6] ã€‚</p><p><a href="https://baike.baidu.com/item/%E5%86%B3%E7%AD%96">å†³ç­–</a>ï¼šä¸€ä¸ªé˜¶æ®µçš„çŠ¶æ€ç»™å®šä»¥åï¼Œä»è¯¥çŠ¶æ€æ¼”å˜åˆ°ä¸‹ä¸€é˜¶æ®µæŸä¸ªçŠ¶æ€çš„ä¸€ç§é€‰æ‹©ï¼ˆè¡ŒåŠ¨ï¼‰ç§°ä¸ºå†³ç­–ã€‚åœ¨æœ€ä¼˜æ§åˆ¶ä¸­ï¼Œä¹Ÿç§°ä¸ºæ§åˆ¶ã€‚åœ¨è®¸å¤šé—®é¢˜ä¸­ï¼Œå†³ç­–å¯ä»¥è‡ªç„¶è€Œç„¶åœ°è¡¨ç¤ºä¸ºä¸€ä¸ªæ•°æˆ–ä¸€ç»„æ•°ã€‚ä¸åŒçš„å†³ç­–å¯¹åº”ç€ä¸åŒçš„æ•°å€¼ã€‚æè¿°å†³ç­–çš„å˜é‡ç§°<a href="https://baike.baidu.com/item/%E5%86%B3%E7%AD%96%E5%8F%98%E9%87%8F">å†³ç­–å˜é‡</a>ï¼Œå› çŠ¶æ€æ»¡è¶³æ— åæ•ˆæ€§ï¼Œæ•…åœ¨æ¯ä¸ªé˜¶æ®µé€‰æ‹©å†³ç­–æ—¶åªéœ€è€ƒè™‘å½“å‰çš„çŠ¶æ€è€Œæ— é¡»è€ƒè™‘è¿‡ç¨‹çš„å†å² [6] ã€‚</p><p>å†³ç­–å˜é‡çš„èŒƒå›´ç§°ä¸ºå…è®¸å†³ç­–é›†åˆ [6] ã€‚</p><p><a href="https://baike.baidu.com/item/%E7%AD%96%E7%95%A5">ç­–ç•¥</a>ï¼šç”±æ¯ä¸ªé˜¶æ®µçš„å†³ç­–ç»„æˆçš„åºåˆ—ç§°ä¸ºç­–ç•¥ã€‚å¯¹äºæ¯ä¸€ä¸ªå®é™…çš„å¤šé˜¶æ®µå†³ç­–è¿‡ç¨‹ï¼Œå¯ä¾›é€‰å–çš„ç­–ç•¥æœ‰ä¸€å®šçš„èŒƒå›´é™åˆ¶ï¼Œè¿™ä¸ªèŒƒå›´ç§°ä¸ºå…è®¸ç­–ç•¥é›†åˆ [6] ã€‚</p><p>å…è®¸ç­–ç•¥é›†åˆä¸­è¾¾åˆ°æœ€ä¼˜æ•ˆæœçš„ç­–ç•¥ç§°ä¸ºæœ€ä¼˜ç­–ç•¥ [6] ã€‚</p><p>ç»™å®šké˜¶æ®µçŠ¶æ€å˜é‡x(k)çš„å€¼åï¼Œå¦‚æœè¿™ä¸€é˜¶æ®µçš„å†³ç­–å˜é‡ä¸€ç»ç¡®å®šï¼Œç¬¬k+1é˜¶æ®µçš„çŠ¶æ€å˜é‡x(k+1)ä¹Ÿå°±å®Œå…¨ç¡®å®šï¼Œå³x(k+1)çš„å€¼éšx(k)å’Œç¬¬ké˜¶æ®µçš„å†³ç­–u(k)çš„å€¼å˜åŒ–è€Œå˜åŒ–ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè¿™ä¸€å…³ç³»çœ‹æˆ(x(k)ï¼Œu(k))ä¸x(k+1)ç¡®å®šçš„å¯¹åº”å…³ç³»ï¼Œç”¨x(k+1)=Tk(x(k),u(k))è¡¨ç¤ºã€‚è¿™æ˜¯ä»ké˜¶æ®µåˆ°k+1é˜¶æ®µçš„çŠ¶æ€è½¬ç§»è§„å¾‹ï¼Œç§°ä¸ºçŠ¶æ€è½¬ç§»æ–¹ç¨‹ [6] ã€‚</p><p>æœ€ä¼˜åŒ–åŸç†ï¼šä½œä¸ºæ•´ä¸ªè¿‡ç¨‹çš„æœ€ä¼˜ç­–ç•¥ï¼Œå®ƒæ»¡è¶³ï¼šç›¸å¯¹å‰é¢å†³ç­–æ‰€å½¢æˆçš„çŠ¶æ€è€Œè¨€ï¼Œä½™ä¸‹çš„å­ç­–ç•¥å¿…ç„¶æ„æˆâ€œæœ€ä¼˜å­ç­–ç•¥â€ [6] ã€‚</p><p>æœ€ä¼˜æ€§åŸç†å®é™…ä¸Šæ˜¯è¦æ±‚é—®é¢˜çš„æœ€ä¼˜ç­–ç•¥çš„å­ç­–ç•¥ä¹Ÿæ˜¯æœ€ä¼˜ [6] ã€‚</p><h3 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h3><p>å¤šé˜¶æ®µå†³ç­–é—®é¢˜ä¸­ï¼Œå„ä¸ªé˜¶æ®µé‡‡å–çš„<a href="https://baike.baidu.com/item/%E5%86%B3%E7%AD%96">å†³ç­–</a>ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¸æ—¶é—´æœ‰å…³çš„ï¼Œå†³ç­–ä¾èµ–äºå½“å‰çŠ¶æ€ï¼Œåˆéšå³å¼•èµ·çŠ¶æ€çš„è½¬ç§»ï¼Œä¸€ä¸ªå†³ç­–åºåˆ—å°±æ˜¯åœ¨å˜åŒ–çš„çŠ¶æ€ä¸­äº§ç”Ÿå‡ºæ¥çš„ï¼Œæ•…æœ‰â€œåŠ¨æ€â€çš„å«ä¹‰ï¼Œç§°è¿™ç§è§£å†³å¤šé˜¶æ®µå†³ç­–æœ€ä¼˜åŒ–é—®é¢˜çš„æ–¹æ³•ä¸ºåŠ¨æ€è§„åˆ’æ–¹æ³• [7] ã€‚</p><h3 id="é€‚ç”¨æ¡ä»¶"><a href="#é€‚ç”¨æ¡ä»¶" class="headerlink" title="é€‚ç”¨æ¡ä»¶"></a>é€‚ç”¨æ¡ä»¶</h3><p>ä»»ä½•æ€æƒ³æ–¹æ³•éƒ½æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œè¶…å‡ºäº†ç‰¹å®šæ¡ä»¶ï¼Œå®ƒå°±å¤±å»äº†ä½œç”¨ã€‚åŒæ ·ï¼ŒåŠ¨æ€è§„åˆ’ä¹Ÿå¹¶ä¸æ˜¯ä¸‡èƒ½çš„ã€‚é€‚ç”¨åŠ¨æ€è§„åˆ’çš„é—®é¢˜å¿…é¡»æ»¡è¶³æœ€ä¼˜åŒ–åŸç†å’Œæ— åæ•ˆæ€§ [8] ã€‚</p><ul><li>**<a href="https://baike.baidu.com/item/%E6%9C%80%E4%BC%98%E5%8C%96%E5%8E%9F%E7%90%86">æœ€ä¼˜åŒ–åŸç†</a>**<strong>ï¼ˆæœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼‰</strong></li></ul><p>æœ€ä¼˜åŒ–åŸç†å¯è¿™æ ·é˜è¿°ï¼šä¸€ä¸ªæœ€ä¼˜åŒ–ç­–ç•¥å…·æœ‰è¿™æ ·çš„æ€§è´¨ï¼Œä¸è®ºè¿‡å»çŠ¶æ€å’Œå†³ç­–å¦‚ä½•ï¼Œå¯¹å‰é¢çš„å†³ç­–æ‰€å½¢æˆçš„çŠ¶æ€è€Œè¨€ï¼Œä½™ä¸‹çš„è¯¸å†³ç­–å¿…é¡»æ„æˆæœ€ä¼˜ç­–ç•¥ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä¸€ä¸ªæœ€ä¼˜åŒ–ç­–ç•¥çš„å­ç­–ç•¥æ€»æ˜¯æœ€ä¼˜çš„ã€‚ä¸€ä¸ªé—®é¢˜æ»¡è¶³æœ€ä¼˜åŒ–åŸç†åˆç§°å…¶å…·æœ‰æœ€ä¼˜å­ç»“æ„æ€§è´¨ [8] ã€‚</p><ul><li><strong><a href="https://baike.baidu.com/item/%E6%97%A0%E5%90%8E%E6%95%88%E6%80%A7">æ— åæ•ˆæ€§</a></strong></li></ul><p>å°†å„é˜¶æ®µæŒ‰ç…§ä¸€å®šçš„æ¬¡åºæ’åˆ—å¥½ä¹‹åï¼Œå¯¹äºæŸä¸ªç»™å®šçš„é˜¶æ®µçŠ¶æ€ï¼Œå®ƒä»¥å‰å„é˜¶æ®µçš„çŠ¶æ€æ— æ³•ç›´æ¥å½±å“å®ƒæœªæ¥çš„å†³ç­–ï¼Œè€Œåªèƒ½é€šè¿‡å½“å‰çš„è¿™ä¸ªçŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½æ˜¯è¿‡å»å†å²çš„ä¸€ä¸ªå®Œæ•´æ€»ç»“ã€‚è¿™å°±æ˜¯æ— åå‘æ€§ï¼Œåˆç§°ä¸ºæ— åæ•ˆæ€§ [8] ã€‚</p><ul><li><strong>å­é—®é¢˜çš„é‡å æ€§</strong></li></ul><p>åŠ¨æ€è§„åˆ’ç®—æ³•çš„å…³é”®åœ¨äºè§£å†³å†—ä½™ï¼Œè¿™æ˜¯åŠ¨æ€è§„åˆ’ç®—æ³•çš„æ ¹æœ¬ç›®çš„ã€‚åŠ¨æ€è§„åˆ’å®è´¨ä¸Šæ˜¯ä¸€ç§ä»¥ç©ºé—´æ¢æ—¶é—´çš„æŠ€æœ¯ï¼Œå®ƒåœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œä¸å¾—ä¸å­˜å‚¨äº§ç”Ÿè¿‡ç¨‹ä¸­çš„å„ç§çŠ¶æ€ï¼Œæ‰€ä»¥å®ƒçš„ç©ºé—´å¤æ‚åº¦è¦å¤§äºå…¶ä»–çš„ç®—æ³•ã€‚é€‰æ‹©åŠ¨æ€è§„åˆ’ç®—æ³•æ˜¯å› ä¸ºåŠ¨æ€è§„åˆ’ç®—æ³•åœ¨ç©ºé—´ä¸Šå¯ä»¥æ‰¿å—ï¼Œè€Œæœç´¢ç®—æ³•åœ¨æ—¶é—´ä¸Šå´æ— æ³•æ‰¿å—ï¼Œæ‰€ä»¥æˆ‘ä»¬èˆç©ºé—´è€Œå–æ—¶é—´</p><h3 id="1-2-ä½¿ç”¨åœºæ™¯"><a href="#1-2-ä½¿ç”¨åœºæ™¯" class="headerlink" title="1.2 ä½¿ç”¨åœºæ™¯"></a>1.2 ä½¿ç”¨åœºæ™¯</h3><p>åŠ¨æ€è§„åˆ’åœ¨æŸ¥æ‰¾æœ‰å¾ˆå¤š<strong>é‡å å­é—®é¢˜</strong>çš„æƒ…å†µçš„æœ€ä¼˜è§£æ—¶æœ‰æ•ˆã€‚å®ƒå°†é—®é¢˜é‡æ–°ç»„åˆæˆå­é—®é¢˜ã€‚ä¸ºäº†é¿å…å¤šæ¬¡è§£å†³è¿™äº›å­é—®é¢˜ï¼Œå®ƒä»¬çš„ç»“æœéƒ½é€æ¸è¢«è®¡ç®—å¹¶è¢«ä¿å­˜ï¼Œä»ç®€å•çš„é—®é¢˜ç›´åˆ°æ•´ä¸ªé—®é¢˜éƒ½è¢«è§£å†³ã€‚å› æ­¤ï¼ŒåŠ¨æ€è§„åˆ’ä¿å­˜é€’å½’æ—¶çš„ç»“æœï¼Œå› è€Œä¸ä¼šåœ¨è§£å†³åŒæ ·çš„é—®é¢˜æ—¶èŠ±è´¹æ—¶é—´ã€‚</p><p>åŠ¨æ€è§„åˆ’åªèƒ½åº”ç”¨äºæœ‰<strong>æœ€ä¼˜å­ç»“æ„</strong>çš„é—®é¢˜ã€‚æœ€ä¼˜å­ç»“æ„çš„æ„æ€æ˜¯å±€éƒ¨æœ€ä¼˜è§£èƒ½å†³å®šå…¨å±€æœ€ä¼˜è§£ï¼ˆå¯¹æœ‰äº›é—®é¢˜è¿™ä¸ªè¦æ±‚å¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³ï¼Œæ•…æœ‰æ—¶éœ€è¦å¼•å…¥ä¸€å®šçš„è¿‘ä¼¼ï¼‰ã€‚ç®€å•åœ°è¯´ï¼Œé—®é¢˜èƒ½å¤Ÿåˆ†è§£æˆå­é—®é¢˜æ¥è§£å†³ã€‚</p><p>é€‚ç”¨æƒ…å†µï¼š</p><ul><li><p><strong>æœ€ä¼˜å­ç»“æ„æ€§è´¨</strong>ï¼šå¦‚æœé—®é¢˜çš„æœ€ä¼˜è§£æ‰€åŒ…å«çš„å­é—®é¢˜çš„è§£ä¹Ÿæ˜¯æœ€ä¼˜çš„ï¼Œæˆ‘ä»¬å°±ç§°è¯¥é—®é¢˜å…·æœ‰æœ€ä¼˜å­ç»“æ„æ€§è´¨ï¼ˆå³æ»¡è¶³æœ€ä¼˜åŒ–åŸç†ï¼‰ã€‚æœ€ä¼˜å­ç»“æ„æ€§è´¨ä¸ºåŠ¨æ€è§„åˆ’ç®—æ³•è§£å†³é—®é¢˜æä¾›äº†é‡è¦çº¿ç´¢ã€‚</p></li><li><p><strong>æ— åæ•ˆæ€§</strong>ï¼šå³å­é—®é¢˜çš„è§£ä¸€æ—¦ç¡®å®šï¼Œå°±ä¸å†æ”¹å˜ï¼Œä¸å—åœ¨è¿™ä¹‹åã€åŒ…å«å®ƒçš„æ›´å¤§çš„é—®é¢˜çš„æ±‚è§£å†³ç­–å½±å“ã€‚</p></li><li><p><strong>å­é—®é¢˜é‡å æ€§è´¨</strong>ï¼šå­é—®é¢˜é‡å æ€§è´¨æ˜¯æŒ‡åœ¨ç”¨é€’å½’ç®—æ³•è‡ªé¡¶å‘ä¸‹å¯¹é—®é¢˜è¿›è¡Œæ±‚è§£æ—¶ï¼Œæ¯æ¬¡äº§ç”Ÿçš„å­é—®é¢˜å¹¶ä¸æ€»æ˜¯æ–°é—®é¢˜ï¼Œæœ‰äº›å­é—®é¢˜ä¼šè¢«é‡å¤è®¡ç®—å¤šæ¬¡ã€‚åŠ¨æ€è§„åˆ’ç®—æ³•æ­£æ˜¯åˆ©ç”¨äº†è¿™ç§å­é—®é¢˜çš„é‡å æ€§è´¨ï¼Œå¯¹æ¯ä¸€ä¸ªå­é—®é¢˜åªè®¡ç®—ä¸€æ¬¡ï¼Œç„¶åå°†å…¶è®¡ç®—ç»“æœä¿å­˜åœ¨ä¸€ä¸ªè¡¨æ ¼ä¸­ï¼Œå½“å†æ¬¡éœ€è¦è®¡ç®—å·²ç»è®¡ç®—è¿‡çš„å­é—®é¢˜æ—¶ï¼Œåªæ˜¯åœ¨è¡¨æ ¼ä¸­ç®€å•åœ°æŸ¥çœ‹ä¸€ä¸‹ç»“æœï¼Œä»è€Œè·å¾—è¾ƒé«˜çš„æ•ˆç‡ï¼Œé™ä½äº†æ—¶é—´å¤æ‚åº¦ã€‚</p></li></ul><h3 id="1-3-åŠ¨æ€è§„åˆ’ä¸è®°å¿†åŒ–æœç´¢"><a href="#1-3-åŠ¨æ€è§„åˆ’ä¸è®°å¿†åŒ–æœç´¢" class="headerlink" title="1.3 åŠ¨æ€è§„åˆ’ä¸è®°å¿†åŒ–æœç´¢"></a>1.3 åŠ¨æ€è§„åˆ’ä¸è®°å¿†åŒ–æœç´¢</h3><p><a href="https://www.luogu.com.cn/blog/interestingLSY/memdfs-and-dp">https://www.luogu.com.cn/blog/interestingLSY/memdfs-and-dp</a></p><h2 id="äºŒ-ç®—æ³•"><a href="#äºŒ-ç®—æ³•" class="headerlink" title="äºŒ. ç®—æ³•"></a>äºŒ. ç®—æ³•</h2><h3 id="2-1-DPçš„ä¸¤ç§å®ç°æ–¹å¼"><a href="#2-1-DPçš„ä¸¤ç§å®ç°æ–¹å¼" class="headerlink" title="2.1 DPçš„ä¸¤ç§å®ç°æ–¹å¼"></a>2.1 DPçš„ä¸¤ç§å®ç°æ–¹å¼</h3><ul><li>é€’å½’å®ç°</li><li>è®°å¿†åŒ–æœç´¢</li></ul><h3 id="2-2-DPå¸¸ç”¨æ¥è§£å†³çš„é—®é¢˜"><a href="#2-2-DPå¸¸ç”¨æ¥è§£å†³çš„é—®é¢˜" class="headerlink" title="2.2 DPå¸¸ç”¨æ¥è§£å†³çš„é—®é¢˜"></a>2.2 DPå¸¸ç”¨æ¥è§£å†³çš„é—®é¢˜</h3><ul><li>åˆ‡å‰²é’¢æ¡é—®é¢˜</li><li>Floydæœ€çŸ­è·¯é—®é¢˜</li><li>æœ€å¤§ä¸ä¸‹é™å­åºåˆ—</li><li>çŸ©é˜µé“¾ä¹˜</li><li>å‡¸å¤šè¾¹å½¢ä¸‰è§’å‰–åˆ†</li><li>0-1èƒŒåŒ…</li><li>æœ€é•¿å…¬å…±å­åºåˆ—</li><li>æœ€ä¼˜äºŒåˆ†æœç´¢æ ‘</li></ul><h3 id="2-3-ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„ç®—æ³•"><a href="#2-3-ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„ç®—æ³•" class="headerlink" title="2.3 ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„ç®—æ³•"></a>2.3 ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„ç®—æ³•</h3><ul><li>æœ€é•¿å…¬å…±å­åºåˆ—</li><li>Floyd-Warshallç®—æ³•</li><li>Viterbiç®—æ³•</li><li>æ±‚è§£é©¬å¯å¤«å†³ç­–è¿‡ç¨‹ä¸‹æœ€ä½³ç­–ç•¥</li></ul><h3 id="2-4-å®ç°åŸç†"><a href="#2-4-å®ç°åŸç†" class="headerlink" title="2.4 å®ç°åŸç†"></a>2.4 å®ç°åŸç†</h3><ul><li><strong>åŸºæœ¬æ€æƒ³ï¼š</strong>é—®é¢˜çš„æœ€ä¼˜è§£å¦‚æœå¯ä»¥ç”±å­é—®é¢˜çš„æœ€ä¼˜è§£æ¨å¯¼å¾—åˆ°ï¼Œåˆ™å¯ä»¥å…ˆæ±‚è§£å­é—®é¢˜çš„æœ€ä¼˜è§£ï¼Œåœ¨æ„é€ åŸé—®é¢˜çš„æœ€ä¼˜è§£ï¼›è‹¥å­é—®é¢˜<strong>æœ‰è¾ƒå¤šçš„é‡å¤å‡ºç°</strong>ï¼Œåˆ™å¯ä»¥<strong>è‡ªåº•å‘ä¸Š</strong>ä»æœ€ç»ˆå­é—®é¢˜å‘åŸé—®é¢˜é€æ­¥æ±‚è§£ã€‚</li><li>ä½¿ç”¨æ¡ä»¶ï¼š<strong>å¯åˆ†ä¸ºå¤šä¸ªç›¸å…³å­é—®é¢˜ï¼Œå­é—®é¢˜çš„è§£è¢«é‡å¤ä½¿ç”¨</strong><ul><li>Optimal substructureï¼ˆä¼˜åŒ–å­ç»“æ„ï¼‰ï¼š<ul><li>ä¸€ä¸ªé—®é¢˜çš„ä¼˜åŒ–è§£åŒ…å«äº†å­é—®é¢˜çš„ä¼˜åŒ–è§£</li><li>ç¼©å°å­é—®é¢˜é›†åˆï¼Œåªéœ€é‚£äº›ä¼˜åŒ–é—®é¢˜ä¸­åŒ…å«çš„å­é—®é¢˜ï¼Œé™ä½å®ç°å¤æ‚æ€§</li><li>æˆ‘ä»¬å¯ä»¥è‡ªä¸‹è€Œä¸Šçš„</li></ul></li><li>Subtetiesï¼ˆé‡å å­é—®é¢˜ï¼‰ï¼šåœ¨é—®é¢˜çš„æ±‚è§£è¿‡ç¨‹ä¸­ï¼Œå¾ˆå¤šå­é—®é¢˜çš„è§£å°†è¢«å¤šæ¬¡ä½¿ç”¨ã€‚</li></ul></li><li>åŠ¨æ€è§„åˆ’ç®—æ³•çš„è®¾è®¡æ­¥éª¤ï¼š<ul><li>åˆ†æä¼˜åŒ–è§£çš„ç»“æ„</li><li>é€’å½’åœ°å®šä¹‰æœ€ä¼˜è§£çš„ä»£ä»·</li><li>è‡ªåº•å‘ä¸Šåœ°è®¡ç®—ä¼˜åŒ–è§£çš„ä»£ä»·ä¿å­˜ä¹‹ï¼Œå¹¶è·å–æ„é€ æœ€ä¼˜è§£çš„ä¿¡æ¯</li><li>æ ¹æ®æ„é€ æœ€ä¼˜è§£çš„ä¿¡æ¯æ„é€ ä¼˜åŒ–è§£</li></ul></li><li>åŠ¨æ€è§„åˆ’ç‰¹ç‚¹ï¼š<ul><li>æŠŠåŸå§‹é—®é¢˜åˆ’åˆ†æˆä¸€ç³»åˆ—å­é—®é¢˜ï¼›</li><li>æ±‚è§£æ¯ä¸ªå­é—®é¢˜ä»…ä¸€æ¬¡ï¼Œå¹¶å°†å…¶ç»“æœä¿å­˜åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼Œä»¥åç”¨åˆ°æ—¶ç›´æ¥å­˜å–ï¼Œä¸é‡å¤è®¡ç®—ï¼ŒèŠ‚çœè®¡ç®—æ—¶é—´</li><li>è‡ªåº•å‘ä¸Šåœ°è®¡ç®—ã€‚</li><li>æ•´ä½“é—®é¢˜æœ€ä¼˜è§£å–å†³äºå­é—®é¢˜çš„æœ€ä¼˜è§£ï¼ˆçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼‰ï¼ˆå°†å­é—®é¢˜ç§°ä¸ºçŠ¶æ€ï¼Œæœ€ç»ˆçŠ¶æ€çš„æ±‚è§£å½’ç»“ä¸ºå…¶ä»–çŠ¶æ€çš„æ±‚è§£ï¼‰</li></ul></li></ul><h2 id="ä¸‰-ç®—æ³•é¢˜"><a href="#ä¸‰-ç®—æ³•é¢˜" class="headerlink" title="ä¸‰. ç®—æ³•é¢˜"></a>ä¸‰. ç®—æ³•é¢˜</h2><p>åŠ¨æ€è§„åˆ’ç­‰ä»·äºè®°å¿†åŒ–æœç´¢ï¼Œå­¦ä¹ æ·±åº¦ä¼˜å…ˆæœç´¢å’Œè®°å¿†åŒ–æœç´¢ï¼Œæ–¹ä¾¿å¿«é€Ÿç†è§£åŠ¨æ€è§„åˆ’</p><p>è§£å†³DPç®—æ³•é—®é¢˜ï¼Œå†™å‡ºè®°å¿†åŒ–æœç´¢çš„é€’å½’å‡½æ•°ï¼Œåˆ—å‡ºæ–¹ç¨‹åï¼Œå¯ä»¥ç”¨æ•°å­¦æ–¹æ³•ï¼Œé­”æ”¹ä¼˜åŒ–ã€‚</p><h3 id="3-1-èƒŒåŒ…é—®é¢˜"><a href="#3-1-èƒŒåŒ…é—®é¢˜" class="headerlink" title="3.1 èƒŒåŒ…é—®é¢˜"></a>3.1 èƒŒåŒ…é—®é¢˜</h3><p>èƒŒåŒ…é—®é¢˜ä½œä¸ºNPå®Œå…¨é—®é¢˜ï¼Œæš‚æ—¶ä¸å­˜åœ¨å¤šé¡¹å¼æ—¶é—´ç®—æ³•ã€‚åŠ¨æ€è§„åˆ’å±äºèƒŒåŒ…é—®é¢˜æ±‚è§£æœ€ä¼˜è§£çš„å¯è¡Œæ–¹æ³•ä¹‹ä¸€ã€‚æ­¤å¤–ï¼Œæ±‚è§£èƒŒåŒ…é—®é¢˜æœ€ä¼˜è§£è¿˜æœ‰æœç´¢æ³•ç­‰ï¼Œè¿‘ä¼¼è§£è¿˜æœ‰è´ªå¿ƒæ³•ç­‰ï¼Œåˆ†æ•°èƒŒåŒ…é—®é¢˜æœ‰æœ€ä¼˜è´ªå¿ƒè§£ç­‰ã€‚ èƒŒåŒ…é—®é¢˜å…·æœ‰æœ€ä¼˜å­ç»“æ„å’Œé‡å å­é—®é¢˜ã€‚åŠ¨æ€è§„åˆ’ä¸€èˆ¬ç”¨äºæ±‚è§£èƒŒåŒ…é—®é¢˜ä¸­çš„æ•´æ•°èƒŒåŒ…é—®é¢˜ï¼ˆå³æ¯ç§ç‰©å“æ‰€é€‰çš„ä¸ªæ•°å¿…é¡»æ˜¯æ•´æ•°ï¼‰ã€‚ </p><p>è§£æ•´æ•°èƒŒåŒ…é—®é¢˜ï¼š è®¾æœ‰nä»¶ç‰©å“ï¼Œæ¯ä»¶ä»·å€¼è®°ä¸º P<del>i</del> ï¼Œæ¯ä»¶ä½“ç§¯è®°ä¸º V<del>i</del> ï¼Œç”¨ä¸€ä¸ªæœ€å¤§å®¹ç§¯ä¸º V<del>max</del> çš„èƒŒåŒ…ï¼Œæ±‚è£…å…¥ç‰©å“çš„æœ€å¤§ä»·å€¼ã€‚ ç”¨ä¸€ä¸ªæ•°ç»„ f[i,v] è¡¨ç¤ºå–iä»¶å•†å“å¡«å……ä¸€ä¸ªå®¹ç§¯ä¸ºvçš„èƒŒåŒ…çš„æœ€å¤§ä»·å€¼ï¼Œæ˜¾ç„¶é—®é¢˜çš„è§£å°±æ˜¯ f[n,V<del>max</del>] ã€‚</p><p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/dd9c97f255a11758a2f19098205661f90cf2fa81" alt="{\displaystyle f[i,v]={\begin{cases}f[i-1,v],v&lt;V_{i}\\\max\{f[i-1,v],f[i-1,v-V_{i}]+P_{i}\},v\geq V_{i}\\0,iv=0\\\end{cases}}}"></p><p>å¯¹äºç‰¹ä¾‹0-1èƒŒåŒ…é—®é¢˜ï¼ˆå³æ¯ä»¶ç‰©å“æœ€å¤šæ”¾1ä»¶ï¼Œå¦åˆ™ä¸æ”¾å…¥ï¼‰çš„é—®é¢˜ï¼ŒçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p><p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/dd9c97f255a11758a2f19098205661f90cf2fa81" alt="{\displaystyle f[i,v]={\begin{cases}f[i-1,v],v&lt;V_{i}\\\max\{f[i-1,v],f[i-1,v-V_{i}]+P_{i}\},v\geq V_{i}\\0,iv=0\\\end{cases}}}"></p><h3 id="3-2-åˆ‡å‰²é’¢æ¡é—®é¢˜"><a href="#3-2-åˆ‡å‰²é’¢æ¡é—®é¢˜" class="headerlink" title="3.2 åˆ‡å‰²é’¢æ¡é—®é¢˜"></a>3.2 åˆ‡å‰²é’¢æ¡é—®é¢˜</h3><p>ï¼ˆ1ï¼‰å‰‘æŒ‡14-å‰ªç»³å­1</p><p>æ­¤æ¡ˆä¾‹ä¸­åŠ¨æ€è§„åˆ’æ•ˆç‡è¦ä½äºè´ªå¿ƒè§£æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ªç»³å­1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»™ä½ ä¸€æ ¹é•¿åº¦ä¸º n çš„ç»³å­ï¼Œè¯·æŠŠç»³å­å‰ªæˆæ•´æ•°é•¿åº¦çš„ m æ®µï¼ˆmã€néƒ½æ˜¯æ•´æ•°ï¼Œn&gt;1å¹¶ä¸”m&gt;1ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * æ¯æ®µç»³å­çš„é•¿åº¦è®°ä¸º k[0],k[1]...k[m-1] ã€‚</span></span><br><span class="line"><span class="comment"> * è¯·é—® k[0]*k[1]*...*k[m-1] å¯èƒ½çš„æœ€å¤§ä¹˜ç§¯æ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œå½“ç»³å­çš„é•¿åº¦æ˜¯8æ—¶ï¼Œæˆ‘ä»¬æŠŠå®ƒå‰ªæˆé•¿åº¦åˆ†åˆ«ä¸º2ã€3ã€3çš„ä¸‰æ®µï¼Œæ­¤æ—¶å¾—åˆ°çš„æœ€å¤§ä¹˜ç§¯æ˜¯18ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 1ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥: 2</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: 1</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: 2 = 1 + 1, 1 Ã— 1 = 1</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 2:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥: 10</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: 36</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: 10 = 3 + 3 + 4, 3 Ã— 3 Ã— 4 = 36</span></span><br><span class="line"><span class="comment"> * æç¤ºï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2 &lt;= n &lt;= 58</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Related Topics</span></span><br><span class="line"><span class="comment"> * æ•°å­¦</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€è§„åˆ’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jz14CuttingRope1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(cuttingRope(<span class="number">2</span>));</span><br><span class="line">        System.out.println(cuttingRope(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ±‚é•¿åº¦ä¸ºnçš„ç»³å­å‰ªæ‰åçš„æœ€å¤§ä¹˜ç§¯ï¼Œå¯ä»¥ä»å‰é¢æ¯”nå°çš„ç»³å­è½¬ç§»è€Œæ¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ç”¨ä¸€ä¸ªdpæ•°ç»„è®°å½•ä»0åˆ°né•¿åº¦çš„ç»³å­å‰ªæ‰åçš„æœ€å¤§ä¹˜ç§¯ï¼Œä¹Ÿå°±æ˜¯dp[i]è¡¨ç¤ºé•¿åº¦ä¸ºiçš„ç»³å­å‰ªæˆmæ®µåçš„æœ€å¤§ä¹˜ç§¯ï¼Œåˆå§‹åŒ–dp[2] = 1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æˆ‘ä»¬å…ˆæŠŠç»³å­å‰ªæ‰ç¬¬ä¸€æ®µï¼ˆé•¿åº¦ä¸ºjï¼‰ï¼Œå¦‚æœåªå‰ªæ‰é•¿åº¦ä¸º1ï¼Œå¯¹æœ€åçš„ä¹˜ç§¯æ— ä»»ä½•å¢ç›Šï¼Œæ‰€ä»¥ä»é•¿åº¦ä¸º2å¼€å§‹å‰ª</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å‰ªäº†ç¬¬ä¸€æ®µåï¼Œå‰©ä¸‹(i - j)é•¿åº¦å¯ä»¥å‰ªä¹Ÿå¯ä»¥ä¸å‰ªã€‚</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å‰ªçš„è¯é•¿åº¦ä¹˜ç§¯å³ä¸ºj * (i - j)ï¼›</span></span><br><span class="line"><span class="comment">     * å¦‚æœå‰ªçš„è¯é•¿åº¦ä¹˜ç§¯å³ä¸ºj * dp[i - j]ã€‚</span></span><br><span class="line"><span class="comment">     * å–ä¸¤è€…æœ€å¤§å€¼max(j * (i - j), j * dp[i - j])</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ç¬¬ä¸€æ®µé•¿åº¦jå¯ä»¥å–çš„åŒºé—´ä¸º[2,i)ï¼Œå¯¹æ‰€æœ‰jä¸åŒçš„æƒ…å†µå–æœ€å¤§å€¼ï¼Œå› æ­¤æœ€ç»ˆdp[i]çš„è½¬ç§»æ–¹ç¨‹ä¸º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * dp[i] = max(dp[i], max(j * (i - j), j * dp[i - j]))</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æœ€åè¿”å›dp[n]å³å¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ—¶é—´å¤æ‚åº¦ï¼šO(n ^ 2)</span></span><br><span class="line"><span class="comment">     * ç©ºé—´å¤æ‚åº¦ï¼šO(n)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cuttingRope</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">        dp[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; n + <span class="number">1</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">2</span>; j &lt; i; j++)&#123;</span><br><span class="line">                dp[i] = Math.max(dp[i], Math.max(j * (i - j), j * dp[i - j]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è´ªå¿ƒ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ ¸å¿ƒæ€è·¯æ˜¯ï¼šå°½å¯èƒ½æŠŠç»³å­åˆ†æˆé•¿åº¦ä¸º3çš„å°æ®µï¼Œè¿™æ ·ä¹˜ç§¯æœ€å¤§</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ­¥éª¤å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å¦‚æœ n == 2ï¼Œè¿”å›1ï¼Œå¦‚æœ n == 3ï¼Œè¿”å›2ï¼Œä¸¤ä¸ªå¯ä»¥åˆå¹¶æˆnå°äº4çš„æ—¶å€™è¿”å›n - 1</span></span><br><span class="line"><span class="comment">     * å¦‚æœ n == 4ï¼Œè¿”å›4</span></span><br><span class="line"><span class="comment">     * å¦‚æœ n &gt; 4ï¼Œåˆ†æˆå°½å¯èƒ½å¤šçš„é•¿åº¦ä¸º3çš„å°æ®µï¼Œæ¯æ¬¡å¾ªç¯é•¿åº¦nå‡å»3ï¼Œä¹˜ç§¯resä¹˜ä»¥3ï¼›æœ€åè¿”å›æ—¶ä¹˜ä»¥å°äºç­‰äº4çš„æœ€åä¸€å°æ®µ</span></span><br><span class="line"><span class="comment">     * ä»¥ä¸Š2å’Œ3å¯ä»¥åˆå¹¶</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ—¶é—´å¤æ‚åº¦ï¼šO(n)</span></span><br><span class="line"><span class="comment">     * ç©ºé—´å¤æ‚åº¦ï¼šO(1)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cuttingRope1</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n &lt; <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> n - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(n &gt; <span class="number">4</span>)&#123;</span><br><span class="line">            res *= <span class="number">3</span>;</span><br><span class="line">            n -= <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res * n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å‰‘æŒ‡14-å‰ªç»³å­2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ªç»³å­2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»™ä½ ä¸€æ ¹é•¿åº¦ä¸º n çš„ç»³å­ï¼Œè¯·æŠŠç»³å­å‰ªæˆæ•´æ•°é•¿åº¦çš„ m æ®µï¼ˆmã€néƒ½æ˜¯æ•´æ•°ï¼Œn&gt;1å¹¶ä¸”m&gt;1ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * æ¯æ®µç»³å­çš„é•¿åº¦è®°ä¸º k[0],k[1]...k[m - 1] ã€‚</span></span><br><span class="line"><span class="comment"> * è¯·é—® k[0]*k[1]*...*k[m - 1] å¯èƒ½çš„æœ€å¤§ä¹˜ç§¯æ˜¯å¤šå°‘ï¼Ÿ</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œå½“ç»³å­çš„é•¿åº¦æ˜¯8æ—¶ï¼Œæˆ‘ä»¬æŠŠå®ƒå‰ªæˆé•¿åº¦åˆ†åˆ«ä¸º2ã€3ã€3çš„ä¸‰æ®µï¼Œæ­¤æ—¶å¾—åˆ°çš„æœ€å¤§ä¹˜ç§¯æ˜¯18ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç­”æ¡ˆéœ€è¦å–æ¨¡ 1e9+7ï¼ˆ1000000007ï¼‰ï¼Œå¦‚è®¡ç®—åˆå§‹ç»“æœä¸ºï¼š1000000008ï¼Œè¯·è¿”å› 1ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 1ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥: 2</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: 1</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: 2 = 1 + 1, 1 Ã— 1 = 1</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 2:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥: 10</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: 36</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: 10 = 3 + 3 + 4, 3 Ã— 3 Ã— 4 = 36</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æç¤ºï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2 &lt;= n &lt;= 1000</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Related Topics</span></span><br><span class="line"><span class="comment"> * æ•°å­¦</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€è§„åˆ’</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¸å‰ªç»³å­1å”¯ä¸€ä¸åŒåœ¨äºæœ¬é¢˜ç›®æ¶‰åŠ â€œå¤§æ•°è¶Šç•Œæƒ…å†µä¸‹çš„æ±‚ä½™é—®é¢˜â€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jz14CuttingRope2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(cuttingRope(<span class="number">2</span>));</span><br><span class="line">        System.out.println(cuttingRope(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cuttingRope</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n &lt; <span class="number">4</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> n - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(n &gt; <span class="number">4</span>)&#123;</span><br><span class="line">            res  = res * <span class="number">3</span> % <span class="number">1000000007</span>;</span><br><span class="line">            n -= <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (res * n % <span class="number">1000000007</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…"><a href="#3-3-æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…" class="headerlink" title="3.3 æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…"></a>3.3 æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</h3><p>å‰‘æŒ‡19-æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯·å®ç°ä¸€ä¸ªå‡½æ•°ç”¨æ¥åŒ¹é…åŒ…å«&#x27;. &#x27;å’Œ&#x27;*&#x27;çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</span></span><br><span class="line"><span class="comment"> * æ¨¡å¼ä¸­çš„å­—ç¬¦&#x27;.&#x27;è¡¨ç¤ºä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼Œè€Œ&#x27;*&#x27;è¡¨ç¤ºå®ƒå‰é¢çš„å­—ç¬¦å¯ä»¥å‡ºç°ä»»æ„æ¬¡ï¼ˆå«0æ¬¡ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * åœ¨æœ¬é¢˜ä¸­ï¼ŒåŒ¹é…æ˜¯æŒ‡å­—ç¬¦ä¸²çš„æ‰€æœ‰å­—ç¬¦åŒ¹é…æ•´ä¸ªæ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²&quot;aaa&quot;ä¸æ¨¡å¼&quot;a.a&quot;å’Œ&quot;ab*ac*a&quot;åŒ¹é…ï¼Œä½†ä¸&quot;aa.a&quot;å’Œ&quot;ab*a&quot;å‡ä¸åŒ¹é…ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 1:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥:</span></span><br><span class="line"><span class="comment"> * s = &quot;aa&quot;</span></span><br><span class="line"><span class="comment"> * p = &quot;a&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: false</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: &quot;a&quot; æ— æ³•åŒ¹é… &quot;aa&quot; æ•´ä¸ªå­—ç¬¦ä¸²ã€‚</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 2:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥:</span></span><br><span class="line"><span class="comment"> * s = &quot;aa&quot;</span></span><br><span class="line"><span class="comment"> * p = &quot;a*&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: true</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: å› ä¸º &#x27;*&#x27; ä»£è¡¨å¯ä»¥åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå‰é¢çš„é‚£ä¸€ä¸ªå…ƒç´ , åœ¨è¿™é‡Œå‰é¢çš„å…ƒç´ å°±æ˜¯ &#x27;a&#x27;ã€‚å› æ­¤ï¼Œå­—ç¬¦ä¸² &quot;aa&quot; å¯è¢«è§†ä¸º &#x27;a&#x27; é‡å¤äº†ä¸€æ¬¡ã€‚</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 3:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥:</span></span><br><span class="line"><span class="comment"> * s = &quot;ab&quot;</span></span><br><span class="line"><span class="comment"> * p = &quot;.*&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: true</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: &quot;.*&quot; è¡¨ç¤ºå¯åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªï¼ˆ&#x27;*&#x27;ï¼‰ä»»æ„å­—ç¬¦ï¼ˆ&#x27;.&#x27;ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 4:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥:</span></span><br><span class="line"><span class="comment"> * s = &quot;aab&quot;</span></span><br><span class="line"><span class="comment"> * p = &quot;c*a*b&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: true</span></span><br><span class="line"><span class="comment"> * è§£é‡Š: å› ä¸º &#x27;*&#x27; è¡¨ç¤ºé›¶ä¸ªæˆ–å¤šä¸ªï¼Œè¿™é‡Œ &#x27;c&#x27; ä¸º 0 ä¸ª, &#x27;a&#x27; è¢«é‡å¤ä¸€æ¬¡ã€‚å› æ­¤å¯ä»¥åŒ¹é…å­—ç¬¦ä¸² &quot;aab&quot;ã€‚</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 5:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥:</span></span><br><span class="line"><span class="comment"> * s = &quot;mississippi&quot;</span></span><br><span class="line"><span class="comment"> * p = &quot;mis*is*p*.&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡º: false</span></span><br><span class="line"><span class="comment"> * s å¯èƒ½ä¸ºç©ºï¼Œä¸”åªåŒ…å«ä» a-z çš„å°å†™å­—æ¯ã€‚</span></span><br><span class="line"><span class="comment"> * p å¯èƒ½ä¸ºç©ºï¼Œä¸”åªåŒ…å«ä» a-z çš„å°å†™å­—æ¯ä»¥åŠå­—ç¬¦ . å’Œ *ï¼Œæ— è¿ç»­çš„ &#x27;*&#x27;ã€‚</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼šæœ¬é¢˜ä¸ä¸»ç«™ 10 é¢˜ç›¸åŒï¼šhttps://leetcode-cn.com/problems/regular-expression-matching/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Related Topics</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€è§„åˆ’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jz19IsMatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s = <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">        String p = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        System.out.println(isMatch(s, p));</span><br><span class="line"></span><br><span class="line">        s = <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">        p = <span class="string">&quot;a*&quot;</span>;</span><br><span class="line">        System.out.println(isMatch(s, p));</span><br><span class="line"></span><br><span class="line">        s = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">        p = <span class="string">&quot;.*&quot;</span>;</span><br><span class="line">        System.out.println(isMatch(s, p));</span><br><span class="line"></span><br><span class="line">        s = <span class="string">&quot;aab&quot;</span>;</span><br><span class="line">        p = <span class="string">&quot;c*a*b&quot;</span>;</span><br><span class="line">        System.out.println(isMatch(s, p));</span><br><span class="line"></span><br><span class="line">        s = <span class="string">&quot;mississippi&quot;</span>;</span><br><span class="line">        p = <span class="string">&quot;mis*is*p*.&quot;</span>;</span><br><span class="line">        System.out.println(isMatch(s, p));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­—ç¬¦é.æˆ–*ï¼Œåˆ™ç›´æ¥æ¯”è¾ƒã€‚</span></span><br><span class="line"><span class="comment">     * å­—ç¬¦ä¸º.ï¼Œåˆ™ç›´æ¥åŒ¹é…ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">     * å­—ç¬¦ä¸º*ï¼Œåˆ™æ‰¾åˆ°ä¸‹ä¸€ä¸ªä¸å…¶åŒ¹é…çš„å­—ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String s, String p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">int</span> m = p.length();</span><br><span class="line">        <span class="comment">// å­˜æ”¾å·²å¤„ç†ç»“æœ</span></span><br><span class="line">        <span class="keyword">boolean</span>[][] f = <span class="keyword">new</span> <span class="keyword">boolean</span>[n + <span class="number">1</span>][m + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= m; j++) &#123;</span><br><span class="line">                <span class="comment">//åˆ†æˆç©ºæ­£åˆ™å’Œéç©ºæ­£åˆ™ä¸¤ç§</span></span><br><span class="line">                <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line">                    f[i][j] = i == <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//éç©ºæ­£åˆ™åˆ†ä¸ºä¸¤ç§æƒ…å†µ * å’Œ é*</span></span><br><span class="line">                    <span class="keyword">if</span> (p.charAt(j - <span class="number">1</span>) != <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; (s.charAt(i - <span class="number">1</span>) == p.charAt(j - <span class="number">1</span>) || p.charAt(j - <span class="number">1</span>) == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                            f[i][j] = f[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//ç¢°åˆ° * äº†ï¼Œåˆ†ä¸ºçœ‹å’Œä¸çœ‹ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">                        <span class="comment">//ä¸çœ‹</span></span><br><span class="line">                        <span class="keyword">if</span> (j &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                            f[i][j] |= f[i][j - <span class="number">2</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//çœ‹</span></span><br><span class="line">                        <span class="keyword">if</span> (i &gt;= <span class="number">1</span> &amp;&amp; j &gt;= <span class="number">2</span> &amp;&amp; (s.charAt(i - <span class="number">1</span>) == p.charAt(j - <span class="number">2</span>) || p.charAt(j - <span class="number">2</span>) == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                            f[i][j] |= f[i - <span class="number">1</span>][j];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> f[n][m];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é¢˜æ€è·¯ï¼š</p><p>å‡è®¾ä¸»ä¸²ä¸º Aï¼Œæ¨¡å¼ä¸²ä¸º B ä»æœ€åä¸€æ­¥å‡ºå‘ï¼Œéœ€è¦å…³æ³¨æœ€åè¿›æ¥çš„å­—ç¬¦ã€‚å‡è®¾ A çš„é•¿åº¦ä¸º n ï¼ŒB çš„é•¿åº¦ä¸º m ï¼Œå…³æ³¨æ­£åˆ™è¡¨è¾¾å¼ B çš„æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯è°ï¼Œå®ƒæœ‰ä¸‰ç§å¯èƒ½ï¼Œæ­£å¸¸å­—ç¬¦ã€<code>*</code> å’Œ <code>.</code>ï¼ˆç‚¹ï¼‰ï¼Œé‚£é’ˆå¯¹è¿™ä¸‰ç§æƒ…å†µè®¨è®ºå³å¯ï¼Œå¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœ B çš„æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯æ­£å¸¸å­—ç¬¦ï¼Œé‚£å°±æ˜¯çœ‹ <code>A[n-1]</code> æ˜¯å¦ç­‰äº <code>B[m-1]</code> ï¼Œç›¸ç­‰åˆ™çœ‹ A<del>0..n-2</del> ä¸ B<del>0..mâˆ’2</del> ï¼Œä¸ç­‰åˆ™æ˜¯ä¸èƒ½åŒ¹é…ï¼Œè¿™å°±æ˜¯å­é—®é¢˜ã€‚</li><li>å¦‚æœ B çš„æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯ <code>.</code> ï¼Œå®ƒèƒ½åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œç›´æ¥çœ‹ A<del>0..n-2</del> ä¸ B<del>0..mâˆ’2</del> </li><li>å¦‚æœ BB çš„æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯ <code>*</code> å®ƒä»£è¡¨ <code>B[m-2]=c</code> å¯ä»¥é‡å¤0æ¬¡æˆ–å¤šæ¬¡ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªæ•´ä½“ c*<ul><li>æƒ…å†µä¸€ï¼š<code>A[n-1]</code> æ˜¯ 0 ä¸ª cï¼ŒB æœ€åä¸¤ä¸ªå­—ç¬¦åºŸäº†ï¼Œèƒ½å¦åŒ¹é…å–å†³äº  A<del>0..n-1</del> ä¸ B<del>0..mâˆ’3</del> æ˜¯å¦åŒ¹é…</li><li>æƒ…å†µäºŒï¼š<code>A[n-1]</code> æ˜¯å¤šä¸ª c ä¸­çš„æœ€åä¸€ä¸ªï¼ˆè¿™ç§æƒ…å†µå¿…é¡» A[n-1]=c æˆ–è€… c=â€™.â€™ï¼‰ï¼Œæ‰€ä»¥ A åŒ¹é…å®Œå¾€å‰æŒªä¸€ä¸ªï¼ŒB ç»§ç»­åŒ¹é…ï¼Œå› ä¸ºå¯ä»¥åŒ¹é…å¤šä¸ªï¼Œç»§ç»­çœ‹ A<del>0..n-2</del> ä¸ B<del>0..mâˆ’1</del> æ˜¯å¦åŒ¹é…ã€‚</li></ul></li></ol><p>è½¬ç§»æ–¹ç¨‹:</p><p><code>f[i][j]</code> ä»£è¡¨ A çš„å‰ i ä¸ªå’Œ B çš„å‰ j ä¸ªèƒ½å¦åŒ¹é…:</p><ul><li>å¯¹äºå‰é¢ä¸¤ä¸ªæƒ…å†µï¼Œå¯ä»¥åˆå¹¶æˆä¸€ç§æƒ…å†µ <code>f[i][j]</code> = <code>f[i-1][j-1]</code> </li><li>å¯¹äºç¬¬ä¸‰ç§æƒ…å†µï¼Œå¯¹äº c* åˆ†ä¸ºçœ‹å’Œä¸çœ‹ä¸¤ç§æƒ…å†µ<ul><li>ä¸çœ‹ï¼šç›´æ¥ç æ‰æ­£åˆ™ä¸²çš„åé¢ä¸¤ä¸ªï¼Œ <code>f[i][j]</code> = <code>f[i][j-2]</code></li><li>çœ‹ï¼šæ­£åˆ™ä¸²ä¸åŠ¨ï¼Œä¸»ä¸²å‰ç§»ä¸€ä¸ªï¼Œ<code>f[i][j]</code> = <code>f[i-1][j]</code></li></ul></li></ul><p>åˆå§‹æ¡ä»¶</p><p>ç‰¹åˆ¤ï¼šéœ€è¦è€ƒè™‘ç©ºä¸²ç©ºæ­£åˆ™</p><ul><li>ç©ºä¸²å’Œç©ºæ­£åˆ™æ˜¯åŒ¹é…çš„ï¼Œ<code>f[0][0]</code> = true</li><li>ç©ºä¸²å’Œéç©ºæ­£åˆ™ï¼Œä¸èƒ½ç›´æ¥å®šä¹‰ true å’Œ falseï¼Œå¿…é¡»è¦è®¡ç®—å‡ºæ¥ã€‚ï¼ˆæ¯”å¦‚A=â€™â€™ ,B=aâˆ—bâˆ—câˆ—ï¼‰</li><li>éç©ºä¸²å’Œç©ºæ­£åˆ™å¿…ä¸åŒ¹é…ï¼Œ<code>f[1][0]</code> =â€¦= <code>f[n][0]</code> =false</li><li>éç©ºä¸²å’Œéç©ºæ­£åˆ™ï¼Œé‚£è‚¯å®šæ˜¯éœ€è¦è®¡ç®—çš„äº†ã€‚</li></ul><p>å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºç©ºæ­£åˆ™å’Œéç©ºæ­£åˆ™ä¸¤ç§ï¼Œç©ºæ­£åˆ™ä¹Ÿæ˜¯æ¯”è¾ƒå¥½å¤„ç†çš„ï¼Œå¯¹éç©ºæ­£åˆ™æˆ‘ä»¬è‚¯å®šéœ€è¦è®¡ç®—ï¼Œéç©ºæ­£åˆ™çš„ä¸‰ç§æƒ…å†µï¼Œå‰é¢ä¸¤ç§å¯ä»¥åˆå¹¶åˆ°ä¸€èµ·è®¨è®ºï¼Œç¬¬ä¸‰ç§æƒ…å†µæ˜¯å•ç‹¬ä¸€ç§ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯åˆ†ä¸ºå½“å‰ä½ç½®æ˜¯ * å’Œä¸æ˜¯ * ä¸¤ç§æƒ…å†µäº†ã€‚</p><p>å¤æ‚åº¦åˆ†æ</p><p>æ—¶é—´å¤æ‚åº¦ï¼šO(mn)ï¼Œå…¶ä¸­ m å’Œ n åˆ†åˆ«æ˜¯å­—ç¬¦ä¸² s å’Œ p çš„é•¿åº¦ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºæ‰€æœ‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ¯ä¸ªçŠ¶æ€åœ¨è¿›è¡Œè½¬ç§»æ—¶çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p><p>ç©ºé—´å¤æ‚åº¦ï¼šO(mn)ï¼Œå³ä¸ºå­˜å‚¨æ‰€æœ‰çŠ¶æ€ä½¿ç”¨çš„ç©ºé—´ã€‚</p><h3 id="3-4-ç¼–å·åŠ¨æ€è§„åˆ’ï¼šæœ€å¤§ä¸ä¸‹é™å­åºåˆ—"><a href="#3-4-ç¼–å·åŠ¨æ€è§„åˆ’ï¼šæœ€å¤§ä¸ä¸‹é™å­åºåˆ—" class="headerlink" title="3.4 ç¼–å·åŠ¨æ€è§„åˆ’ï¼šæœ€å¤§ä¸ä¸‹é™å­åºåˆ—"></a>3.4 ç¼–å·åŠ¨æ€è§„åˆ’ï¼šæœ€å¤§ä¸ä¸‹é™å­åºåˆ—</h3><p>ã€€ã€€æœ¬ç±»çš„çŠ¶æ€æ˜¯åŸºç¡€çš„åŸºç¡€ï¼Œå¤§éƒ¨åˆ†çš„åŠ¨æ€è§„åˆ’éƒ½è¦ç”¨åˆ°å®ƒï¼Œæˆä¸ºä¸€ä¸ªç»´ã€‚</p><ul><li><strong>æœ€é•¿ä¸ä¸‹é™å­åºåˆ—å®šä¹‰ï¼š</strong>ä»åºåˆ—ä¸­é€‰å‡ºè‹¥å¹²ä¸ªæ•°ç»„æˆä¸€ä¸ªæ–°çš„åºåˆ—ï¼Œä¸æ”¹å˜ä»–ä»¬çš„é˜Ÿä¼çš„é¡ºåºï¼Œè¦æ±‚æ–°çš„åºåˆ—é‡Œxiâ‰¤xi+1â‰¤xi+1â€¦..ä¸¾ä¸ªä¾‹å­{4,6,5,7,3}ï¼Œæœ€é•¿ä¸ä¸‹é™å­åºåˆ—å°±æ˜¯{4,6,7}ã€‚</li><li><strong>å­é—®é¢˜çš„è¡¨ç¤ºï¼š</strong>ä»¤dp[i]è¡¨ç¤ºä»¥ç¬¬iä¸ªå…ƒç´ ç»“å°¾çš„å‰iä¸ªå…ƒç´ æ„æˆçš„æœ€é•¿ä¸ä¸‹é™å­åºåˆ—çš„é•¿åº¦</li><li><strong>ä¼˜åŒ–å­ç»“æ„</strong>ï¼šè‹¥æœ€é•¿ä¸ä¸‹é™å­åºåˆ—åŒ…æ‹¬akï¼Œåˆ™å¿…æœ‰ä¸€ä¸ªè§£åŒ…å«a1,a2â€¦ak-1çš„æœ€é•¿ä¸ä¸‹é™å­åºåˆ—ï¼Œdp[i]è¡¨ç¤ºä¸ºå‰iä¸ªå…ƒç´ çš„åºåˆ—çš„æœ€é•¿ä¸ä¸‹é™å­åºåˆ—</li><li><strong>æ–¹ç¨‹</strong>ï¼š <em>dp[i] = max{dp[j] | 0&lt;j&lt;i , ajâ‰¥ai} + 1</em></li><li><strong>ä¼ªä»£ç </strong>ï¼š</li></ul><p>ã€€ã€€ã€€ã€€è¾“å…¥a[1,â€¦,n]ã€€ã€€è¾“å‡ºï¼šæœ€é•¿å­åºåˆ—</p><p> ã€€ã€€ã€€ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626142332007-952080845.png" alt="img"></p><p><strong>æ—¶é—´å¤æ‚åº¦ï¼šO(n^2)</strong></p><h3 id="3-5-åˆ’åˆ†åŠ¨æ€è§„åˆ’ï¼šçŸ©é˜µé“¾ä¹˜ã€å‡¸å¤šè¾¹å½¢ä¸‰è§’å‰–åˆ†"><a href="#3-5-åˆ’åˆ†åŠ¨æ€è§„åˆ’ï¼šçŸ©é˜µé“¾ä¹˜ã€å‡¸å¤šè¾¹å½¢ä¸‰è§’å‰–åˆ†" class="headerlink" title="3.5 åˆ’åˆ†åŠ¨æ€è§„åˆ’ï¼šçŸ©é˜µé“¾ä¹˜ã€å‡¸å¤šè¾¹å½¢ä¸‰è§’å‰–åˆ†"></a>3.5 åˆ’åˆ†åŠ¨æ€è§„åˆ’ï¼šçŸ©é˜µé“¾ä¹˜ã€å‡¸å¤šè¾¹å½¢ä¸‰è§’å‰–åˆ†</h3><p><strong>ã€çŸ©é˜µé“¾ä¹˜ã€‘</strong></p><ul><li><strong>ä¼˜åŒ–å­ç»“æ„</strong>ï¼šè‹¥è®¡ç®—A1<del>nçš„ä¼˜åŒ–é¡ºåºåœ¨kå¤„æ–­å¼€çŸ©é˜µé“¾, å³A1</del>n=A1<del>k Ã— Ak+1</del>nï¼Œåˆ™åœ¨A1<del>nçš„ä¼˜åŒ–é¡ºåºä¸­ï¼Œå¯¹åº”äºå­é—®é¢˜A1</del>kçš„è§£å¿…é¡»æ˜¯A1-kçš„ä¼˜åŒ–è§£ï¼Œå¯¹åº”äºå­é—®é¢˜Ak+1<del>nçš„è§£å¿…é¡»æ˜¯Ak+1</del>nçš„ä¼˜åŒ–è§£</li><li><strong>å­é—®é¢˜é‡å æ€§ï¼š</strong></li></ul><p>ã€€ã€€ã€€ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626144646962-1290294296.png" alt="img"></p><ul><li><strong>æ–¹ç¨‹ï¼š</strong></li></ul><p>å‡è®¾ï¼šm[i, j] = è®¡ç®—Ai~jçš„æœ€å°ä¹˜æ³•æ•°ï¼›  A1 â€¦ AkAk+1 â€¦. An æ˜¯ä¼˜åŒ–è§£(kå®é™…ä¸Šæ˜¯ä¸å¯é¢„çŸ¥)</p><p> ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626143827583-1699093130.png" alt="img"></p><p>ã€€  <img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626144206832-946860971.png" alt="img"></p><ul><li><strong>ä¼ªä»£ç ï¼š</strong></li></ul><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼š&lt;<span class="built_in">A1</span>, <span class="built_in">A2</span>, ..., An&gt;, Aiæ˜¯çŸ©é˜µ</span><br><span class="line">è¾“å‡ºï¼šè®¡ç®—<span class="built_in">A1</span> x <span class="built_in">A2</span> x ... x Ançš„æœ€å°ä»£ä»·æ–¹æ³•</span><br><span class="line"></span><br><span class="line">Matrix-Chain-<span class="keyword">Order(p)</span></span><br><span class="line"><span class="keyword"></span>n=length(p)-<span class="number">1</span>ï¼›</span><br><span class="line">FOR i=<span class="number">1</span> TO n DO</span><br><span class="line">    m[i, i]=<span class="number">0</span>;</span><br><span class="line">FOR l=<span class="number">2</span> TO n DO <span class="comment">/* è®¡ç®—åœ°lå¯¹è§’çº¿*/</span></span><br><span class="line">    FOR i=<span class="number">1</span> TO n-l+<span class="number">1</span> DO</span><br><span class="line">        <span class="keyword">j=i+l-1;</span></span><br><span class="line"><span class="keyword"></span>        m[i, <span class="keyword">j]= </span>âˆ;</span><br><span class="line">        FOR kâ†i To <span class="keyword">jâ†1 </span>DO <span class="comment">/* è®¡ç®—m[i,j] */</span></span><br><span class="line">             q=m[i, k]+m[k+<span class="number">1</span>, <span class="keyword">j]+ </span>pi<span class="number">-1</span>pkpj</span><br><span class="line">             IF q&lt;m[i, <span class="keyword">j] </span>THEN                  m[i,<span class="keyword">j]=q; </span>s[i,<span class="keyword">j]=k;</span></span><br><span class="line"><span class="keyword"></span>Return m <span class="keyword">and </span>s.</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Print-Optimal-<span class="constructor">Parens(<span class="params">s</span>, <span class="params">i</span>, <span class="params">j</span>)</span> <span class="comment">//æ„å»ºæœ€ä¼˜è§£ï¼Œè¾“å‡ºA1-nçš„ä¼˜åŒ–è®¡ç®—é¡ºåº</span></span><br><span class="line"> IF j=i</span><br><span class="line"> THEN Print â€œAâ€i;</span><br><span class="line"> ELSE Print â€œ(â€</span><br><span class="line">     Print-Optimal-<span class="constructor">Parens(<span class="params">s</span>, <span class="params">i</span>, <span class="params">s</span>[<span class="params">i</span>, <span class="params">j</span>])</span></span><br><span class="line">     Print-Optimal-<span class="constructor">Parens(<span class="params">s</span>, <span class="params">s</span>[<span class="params">i</span>, <span class="params">j</span>]+1, <span class="params">j</span>)</span></span><br><span class="line">     Print â€œ)â€</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><ul><li>ç®—æ³•å¤æ‚åº¦<ul><li>è®¡ç®—ä»£ä»·çš„æ—¶é—´ï¼šä¸‰å±‚å¾ªç¯ O(n3)</li><li>æ„å»ºæœ€ä¼˜è§£çš„æ—¶é—´ï¼š O(n)</li><li><strong>æ€»æ—¶é—´å¤æ‚åº¦ï¼šO(n3)</strong></li></ul></li><li>ç©ºé—´å¤æ‚åº¦<ul><li>ä½¿ç”¨æ•°ç»„må’Œs</li><li>éœ€è¦<strong>ç©ºé—´O(n3)</strong></li></ul></li></ul><p> <strong>ã€ä¸‰è§’å‰–åˆ†ã€‘</strong></p><ul><li><strong>ä¼˜åŒ–å­ç»“æ„</strong>ï¼šå°†å¤šè¾¹å½¢Påˆ’åˆ†ä¸ºä¸ç›¸äº¤ä¸‰è§’å½¢çš„å¼¦çš„é›†åˆ</li><li><strong>ä¼˜åŒ–é—®é¢˜</strong>:</li></ul><p><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626150321546-748343160.png" alt="img"></p><ul><li><p><strong>æ–¹ç¨‹</strong>ï¼šè®¾t[i,j] = &lt;vi-1,vi,â€¦..,vj&gt;çš„ä¼˜åŒ–ä¸‰è§’å‰–åˆ†ä»£ä»·</p><p>ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626150546681-278989483.png" alt="img"></p></li></ul><h3 id="3-6-æ•°è½´åŠ¨æ€è§„åˆ’ï¼š0-1èƒŒåŒ…"><a href="#3-6-æ•°è½´åŠ¨æ€è§„åˆ’ï¼š0-1èƒŒåŒ…" class="headerlink" title="3.6 æ•°è½´åŠ¨æ€è§„åˆ’ï¼š0-1èƒŒåŒ…"></a>3.6 æ•°è½´åŠ¨æ€è§„åˆ’ï¼š0-1èƒŒåŒ…</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šç»™å®šnç§ç‰©å“å’Œä¸€ä¸ªèƒŒåŒ…ï¼Œç‰©å“içš„é‡é‡æ˜¯wiï¼Œä»·å€¼viï¼ŒèƒŒåŒ…å®¹é‡ä¸ºCï¼Œé—®å¦‚ä½•é€‰æ‹©è£…å…¥èƒŒåŒ…çš„ç‰©å“ï¼Œä½¿è£…å…¥èƒŒåŒ…ä¸­çš„ç‰©å“çš„æ€»ä»·å€¼æœ€å¤§ï¼Ÿå¯¹äºæ¯ç§ç‰©å“æ€»èƒ½é€‰æ‹©å®Œå…¨è£…å…¥æˆ–ä¸è£…å…¥ï¼Œä¸€ä¸ªç‰©å“æœ€å¤šè£…å…¥ä¸€æ¬¡ã€‚</li><li><strong>ç­‰ä»·æ•´æ•°è§„åˆ’é—®é¢˜ï¼š</strong></li></ul><p>ã€€ã€€ã€€ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626151529727-1771169615.png" alt="img"></p><ul><li><p><strong>Naiveçš„æ–¹æ³•</strong>ï¼šæ¯ä¸ªç‰©å“åªæœ‰ä¸¤ç§é€‰æ‹©ï¼šä¸è£…æˆ–è£…ï¼Œnä¸ªç‰©å“å…±2nä¸ªè£…å–æ–¹æ¡ˆï¼Œæ¯ä¸ªè£…å–æ–¹æ¡ˆçš„è®¡ç®—ä»£ä»·ä¸ºnï¼Œæ€»è®¡ç®—ä»£ä»·ä¸ºO(n2n)</p></li><li><p><strong>é—®é¢˜çš„åˆ’åˆ†ï¼š</strong></p><p>ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626151725491-1249436922.png" alt="img"></p></li><li><p><strong>å®šä¹‰ä»£ä»·çŸ©é˜µmä¸æ–¹ç¨‹</strong>ï¼š  </p></li><li><ul><li>***å®šä¹‰m(i, j)* :**èƒŒåŒ…å®¹é‡ä¸ºjï¼Œå¯é€‰ç‰©å“ä¸ºxi,xi+1â€¦xnæ—¶ï¼Œé—®é¢˜çš„æœ€ä¼˜è§£ä»£ä»·æ—¶m[i,j]</li><li><em>m(n, j) = 0,  0</em> â‰¤ <em>j &lt;wn</em></li><li><em>m(n, j) = vn,  j â‰¥**wn</em></li><li><em>m(i, j) = m(i+1, j), ã€€ã€€   0â‰¤</em> <em>j&lt; wi</em></li><li><em>m(i, j) = max{m(i+1, j), m(i+1, j-wi)+vi},   j â‰¥</em> <em>wi</em></li></ul></li><li><p><strong>ä¼˜åŒ–å­ç»“æ„å’Œè‡ªåº•å‘ä¸Šçš„ä»£ä»·</strong></p></li></ul><p>ã€€ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626154205161-1543350290.png" alt="img"><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626154222124-1568769512.png" alt="img"></p><ul><li><strong>ä¼ªä»£ç </strong></li></ul><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><p>è¾“å…¥ï¼šC&gt;0, wi&gt;0, vi&gt;0, 1â‰¤ iâ‰¤n<br>è¾“å‡ºï¼š(x1, x2, â€¦, xn), xiâˆˆ{0, 1}, æ»¡è¶³ âˆ‘1â‰¤iâ‰¤nwi xi â‰¤C, âˆ‘1â‰¤iâ‰¤nvi xi æœ€å¤§</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">For</span> <span class="variable">j</span><span class="operator">=</span><span class="number">0</span> <span class="variable">To</span> <span class="variable">min</span><span class="punctuation">(</span><span class="variable">wn</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">)</span> <span class="built_in">Do</span></span><br><span class="line">      <span class="variable">m</span><span class="punctuation">[</span><span class="variable">n</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span></span><br><span class="line"><span class="built_in">For</span> <span class="variable">j</span><span class="operator">=</span><span class="variable">wn</span> <span class="variable">To</span> <span class="built_in">C</span> <span class="built_in">Do</span></span><br><span class="line">      <span class="variable">m</span><span class="punctuation">[</span><span class="variable">n</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="variable">vn</span><span class="operator">;</span></span><br><span class="line"><span class="built_in">For</span> <span class="variable">i</span><span class="operator">=</span><span class="variable">n</span><span class="operator">-</span><span class="number">1</span> <span class="variable">To</span> <span class="number">2</span> <span class="built_in">Do</span></span><br><span class="line">    <span class="built_in">For</span> <span class="variable">j</span><span class="operator">=</span><span class="number">0</span> <span class="variable">To</span> <span class="variable">min</span><span class="punctuation">(</span><span class="variable">wi</span> <span class="operator">-</span><span class="number">1</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">)</span>  <span class="built_in">Do</span></span><br><span class="line">      <span class="variable">m</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="variable">m</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">+</span><span class="number">1</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span><span class="operator">;</span></span><br><span class="line">    <span class="built_in">For</span> <span class="variable">j</span><span class="operator">=</span><span class="variable">wi</span>  <span class="variable">To</span> <span class="built_in">C</span>   <span class="built_in">Do</span></span><br><span class="line">      <span class="variable">m</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span><span class="operator">=</span><span class="variable">max</span><span class="punctuation">&#123;</span><span class="variable">m</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">+</span><span class="number">1</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span><span class="operator">,</span> <span class="variable">m</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">+</span><span class="number">1</span><span class="operator">,</span> <span class="variable">j</span><span class="operator">-</span><span class="variable">wi</span><span class="punctuation">]</span><span class="operator">+</span><span class="variable">vi</span><span class="punctuation">&#125;</span><span class="operator">;</span></span><br><span class="line"><span class="built_in">If</span>  <span class="built_in">C</span><span class="operator">&lt;</span><span class="variable">w1</span>  <span class="variable">Then</span>  <span class="variable">m</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">]</span><span class="operator">=</span><span class="variable">m</span><span class="punctuation">[</span><span class="number">2</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">]</span><span class="operator">;</span></span><br><span class="line">      <span class="variable">Else</span>  <span class="variable">m</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">]</span><span class="operator">=</span><span class="variable">max</span><span class="punctuation">&#123;</span><span class="variable">m</span><span class="punctuation">[</span><span class="number">2</span><span class="operator">,</span> <span class="built_in">C</span><span class="punctuation">]</span><span class="operator">,</span> <span class="variable">m</span><span class="punctuation">[</span><span class="number">2</span><span class="operator">,</span> <span class="built_in">C</span><span class="operator">-</span><span class="variable">w1</span><span class="punctuation">]</span><span class="operator">+</span><span class="variable">v1</span><span class="punctuation">&#125;</span><span class="operator">;</span></span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">m</span>(1, C)æ˜¯æœ€ä¼˜è§£ä»£ä»·å€¼ï¼Œç›¸åº”è§£è®¡ç®—å¦‚ä¸‹: <span class="comment">//æ„é€ ä¼˜åŒ–è§£</span></span><br><span class="line">    <span class="keyword">If</span> <span class="built_in">m</span>(1, C) = <span class="built_in">m</span>(2, C)</span><br><span class="line">    Then x1 = 0;</span><br><span class="line">    <span class="keyword">Else</span> x1 = 1;</span><br><span class="line">å¦‚æœx1=0, ç”±<span class="built_in">m</span>(2, C)ç»§ç»­æ„é€ æœ€ä¼˜è§£;</span><br><span class="line">å¦‚æœx1=1, ç”±<span class="built_in">m</span>(2, C-w1)ç»§ç»­æ„é€ æœ€ä¼˜è§£.</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼š<ul><li>è®¡ç®—ä»£ä»·çš„æ—¶é—´ä¸ºO(Cn)</li><li>æ„é€ æœ€ä¼˜è§£çš„æ—¶é—´:O(Cn)</li><li><strong>æ€»æ—¶é—´å¤æ‚åº¦ä¸º:O(Cn)</strong></li></ul></li><li>ç©ºé—´å¤æ‚åº¦ï¼š<ul><li><strong>ä½¿ç”¨æ•°ç»„mï¼Œéœ€è¦ç©ºé—´O(Cn)</strong></li></ul></li></ul><h3 id="3-7-å‰ç¼€åŠ¨æ€è§„åˆ’ï¼šæœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰"><a href="#3-7-å‰ç¼€åŠ¨æ€è§„åˆ’ï¼šæœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰" class="headerlink" title="3.7 å‰ç¼€åŠ¨æ€è§„åˆ’ï¼šæœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰"></a>3.7 å‰ç¼€åŠ¨æ€è§„åˆ’ï¼šæœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰</h3><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><ul><li><p> <strong>é—®é¢˜æè¿°</strong>ï¼šZæ˜¯åºåˆ—Xä¸Yçš„å…¬å…±å­åºåˆ—å¦‚æœZæ˜¯Xçš„å­åºåˆ—ä¹Ÿæ˜¯Yçš„å­åºåˆ—ã€‚</p></li><li><p><strong>Naiveæ–¹æ³•ï¼š</strong></p><ul><li>æšä¸¾Xçš„æ¯ä¸ªå­åºåˆ—Z</li><li>æ£€æŸ¥Zæ˜¯å¦ä¸ºYçš„å­åºåˆ—</li><li><strong>T(n)=O(n2m)</strong></li></ul></li><li><p> <strong>ä¼˜åŒ–å­ç»“æ„ï¼š</strong></p></li><li><ul><li><em>è®¾X=(x1, â€¦, xm)ã€Y=(y1, â€¦, yn)æ˜¯ä¸¤ä¸ªåºåˆ—ï¼Œ LCSXY=(z1, â€¦, zk)æ˜¯Xä¸Yçš„LCSï¼Œæˆ‘ä»¬æœ‰ï¼š</em></li><li><em>å¦‚æœxm=yn, åˆ™zk=xm=yn, LCSXY = LCSXm-1Yn-1 + &lt;xm=yn&gt;,  LCSXm-1Yn-1æ˜¯Xm-1å’ŒYn-1çš„LCS.</em></li><li><em>å¦‚æœxm<strong>â‰ ynï¼Œä¸”zkâ‰ </strong>xmï¼Œåˆ™LCSXYæ˜¯Xm-1å’ŒYçš„LCSï¼Œå³ LCSXY = LCSXm-1Y</em></li><li><em>å¦‚æœxmâ‰ <strong>yn,ä¸”zkâ‰ </strong>yn,åˆ™LCSXYæ˜¯Xä¸Yn-1çš„LCSï¼Œå³ LCSXY = LCSXYn-1</em></li></ul></li></ul><p>ã€€ã€€ã€€ã€€<em><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626161250797-846687005.png" alt="img"></em></p><ul><li><strong>å­é—®é¢˜é‡å æ€§</strong></li></ul><p><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626161407046-1649798663.png" alt="img"></p><ul><li><strong>æ–¹ç¨‹ï¼š</strong></li></ul><p>ã€€ã€€ã€€ã€€<strong><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626161153121-2116602929.png" alt="img"></strong></p><ul><li> <strong>è‡ªåº•å‘ä¸Šè®¡ç®—ï¼š</strong></li></ul><p>ã€€ã€€ã€€ã€€<img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626161510812-1390787212.png" alt="img"></p><ul><li><strong>ä¼ªä»£ç </strong></li></ul><p><strong><img src="https://images2018.cnblogs.com/blog/1336655/201806/1336655-20180626164412918-1817122808.png" alt="img"></strong></p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼š<span class="variable">X</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="variable">x1</span><span class="operator">,</span><span class="variable">x2</span><span class="operator">,...,</span><span class="variable">xm</span><span class="punctuation">)</span>ï¼Œ<span class="variable">Y</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="variable">y1</span><span class="operator">,</span><span class="variable">y2</span><span class="operator">,...</span><span class="variable">yn</span><span class="punctuation">)</span></span><br><span class="line">è¾“å‡ºï¼š<span class="variable">Z</span> <span class="operator">=</span> <span class="variable">X</span>ä¸<span class="variable">Y</span>çš„æœ€é•¿å…¬å…±å­åºåˆ—</span><br><span class="line"></span><br><span class="line"><span class="built_in">C</span><span class="punctuation">[</span><span class="number">0</span><span class="operator">:</span><span class="variable">m</span><span class="operator">,</span><span class="number">0</span><span class="operator">:</span><span class="variable">n</span><span class="punctuation">]</span><span class="operator">:</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>æ˜¯<span class="variable">Xi</span>ä¸<span class="variable">Yj</span>çš„<span class="variable">LCS</span>çš„é•¿åº¦   <span class="variable">B</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="variable">m</span><span class="operator">,</span><span class="number">1</span><span class="operator">:</span><span class="variable">n</span><span class="punctuation">]</span><span class="operator">:</span></span><br><span class="line"><span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘è®¡ç®—<span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>æ—¶æ‰€é€‰æ‹©çš„å­é—®é¢˜çš„ä¼˜åŒ–è§£æ‰€å¯¹åº”çš„<span class="built_in">C</span>è¡¨çš„è¡¨é¡¹</span><br><span class="line"></span><br><span class="line"><span class="variable">LCS</span><span class="operator">-</span><span class="variable">length</span><span class="punctuation">(</span><span class="variable">X</span><span class="operator">,</span> <span class="variable">Y</span><span class="punctuation">)</span></span><br><span class="line"><span class="variable">m</span>â†<span class="variable">length</span><span class="punctuation">(</span><span class="variable">X</span><span class="punctuation">)</span>ï¼›<span class="variable">n</span>â†<span class="variable">length</span><span class="punctuation">(</span><span class="variable">Y</span><span class="punctuation">)</span>ï¼›</span><br><span class="line"><span class="built_in">For</span> <span class="variable">i</span>â†<span class="number">0</span> <span class="variable">To</span> <span class="variable">m</span> <span class="built_in">Do</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="number">0</span><span class="punctuation">]</span>â†<span class="number">0</span><span class="operator">;</span></span><br><span class="line"><span class="built_in">For</span> <span class="variable">j</span>â†<span class="number">0</span> <span class="variable">To</span> <span class="variable">n</span> <span class="built_in">Do</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="number">0</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†<span class="number">0</span><span class="operator">;</span></span><br><span class="line"><span class="built_in">For</span> <span class="variable">i</span>â†<span class="number">1</span> <span class="variable">To</span> <span class="variable">m</span> <span class="built_in">Do</span></span><br><span class="line">  <span class="built_in">For</span> <span class="variable">j</span>â†<span class="number">1</span> <span class="variable">To</span> <span class="variable">n</span> <span class="built_in">Do</span></span><br><span class="line">    <span class="built_in">If</span> <span class="variable">xi</span> <span class="operator">=</span> <span class="variable">yj</span></span><br><span class="line">    <span class="variable">Then</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†<span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span><span class="variable">j</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="operator">+</span><span class="number">1</span>ï¼›<span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†â€œâ†–â€<span class="operator">;</span></span><br><span class="line">      <span class="variable">Else</span> <span class="built_in">If</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â‰¥<span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span> <span class="variable">Then</span></span><br><span class="line">              <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†<span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span><span class="operator">;</span> <span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†â€œâ†‘â€<span class="operator">;</span></span><br><span class="line">           <span class="variable">Else</span> <span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†<span class="built_in">C</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span><span class="operator">;</span> <span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span><span class="variable">j</span><span class="punctuation">]</span>â†â€œâ†â€<span class="operator">;</span></span><br><span class="line"><span class="built_in">Return</span> <span class="built_in">C</span> <span class="variable">and</span> <span class="variable">B</span><span class="operator">.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Print</span><span class="operator">-</span><span class="variable">LCS</span><span class="punctuation">(</span><span class="variable">B</span><span class="operator">,</span> <span class="variable">X</span><span class="operator">,</span> <span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">)</span></span><br><span class="line"><span class="variable">IF</span> <span class="variable">i</span><span class="operator">=</span><span class="number">0</span> <span class="variable">or</span> <span class="variable">j</span><span class="operator">=</span><span class="number">0</span> <span class="variable">THEN</span> <span class="built_in">Return</span><span class="operator">;</span></span><br><span class="line"><span class="variable">IF</span> <span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span><span class="operator">=</span>â€œâ†–â€</span><br><span class="line"><span class="variable">THEN</span> <span class="built_in">Print</span><span class="operator">-</span><span class="variable">LCS</span><span class="punctuation">(</span><span class="variable">B</span><span class="operator">,</span> <span class="variable">X</span><span class="operator">,</span> <span class="variable">i</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span> <span class="variable">j</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">;</span></span><br><span class="line">    <span class="built_in">Print</span> <span class="variable">xi</span><span class="operator">;</span></span><br><span class="line"><span class="variable">ELSE</span> <span class="built_in">If</span> <span class="variable">B</span><span class="punctuation">[</span><span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">]</span><span class="operator">=</span>â€œâ†‘â€</span><br><span class="line">    <span class="variable">THEN</span> <span class="built_in">Print</span><span class="operator">-</span><span class="variable">LCS</span><span class="punctuation">(</span><span class="variable">B</span><span class="operator">,</span> <span class="variable">X</span><span class="operator">,</span> <span class="variable">i</span><span class="operator">-</span><span class="number">1</span><span class="operator">,</span> <span class="variable">j</span><span class="punctuation">)</span><span class="operator">;</span></span><br><span class="line">    <span class="variable">ELSE</span> <span class="built_in">Print</span><span class="operator">-</span><span class="variable">LCS</span><span class="punctuation">(</span><span class="variable">B</span><span class="operator">,</span> <span class="variable">X</span><span class="operator">,</span> <span class="variable">i</span><span class="operator">,</span> <span class="variable">j</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Print</span><span class="operator">-</span><span class="variable">LCS</span><span class="punctuation">(</span><span class="variable">B</span><span class="operator">,</span> <span class="variable">X</span><span class="operator">,</span> <span class="variable">length</span><span class="punctuation">(</span><span class="variable">X</span><span class="punctuation">)</span><span class="operator">,</span> <span class="variable">length</span><span class="punctuation">(</span><span class="variable">Y</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">      å¯æ‰“å°å‡º<span class="variable">X</span>ä¸<span class="variable">Y</span>çš„<span class="variable">LCS</span>ã€‚</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="å¤åˆ¶ä»£ç "></a></p><ul><li><p>æ—¶é—´å¤æ‚åº¦</p><p>ï¼š</p><ul><li>è®¡ç®—ä»£ä»·çš„æ—¶é—´ï¼šO(mn)</li><li>æ„é€ æœ€ä¼˜è§£çš„æ—¶é—´ï¼šO(m+n)</li><li><strong>æ€»æ—¶é—´å¤æ‚åº¦ä¸ºï¼š O(mn)</strong></li></ul></li><li><p>ç©ºé—´å¤æ‚åº¦</p><p>ï¼š</p><ul><li>ä½¿ç”¨æ•°ç»„Cå’ŒBï¼Œéœ€è¦<strong>ç©ºé—´O(mn)</strong></li></ul></li></ul><h3 id="3-8-æ ‘å½¢åŠ¨æ€è§„åˆ’ï¼šæœ€ä¼˜äºŒåˆ†æœç´¢æ ‘"><a href="#3-8-æ ‘å½¢åŠ¨æ€è§„åˆ’ï¼šæœ€ä¼˜äºŒåˆ†æœç´¢æ ‘" class="headerlink" title="3.8 æ ‘å½¢åŠ¨æ€è§„åˆ’ï¼šæœ€ä¼˜äºŒåˆ†æœç´¢æ ‘"></a>3.8 æ ‘å½¢åŠ¨æ€è§„åˆ’ï¼šæœ€ä¼˜äºŒåˆ†æœç´¢æ ‘</h3><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Š<a href="https://zh.wikipedia.org/zh-hans/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92">ç»´åŸºç™¾ç§‘-åŠ¨æ€è§„åˆ’</a>ã€‹</p><p>ğŸ”— ã€Š<a href="https://www.cnblogs.com/hithongming/p/9229871.html">ã€ç®—æ³•å¤ä¹ ã€‘åŠ¨æ€è§„åˆ’</a>ã€‹</p><p>ğŸ”— ã€Š<a href="https://www.cnblogs.com/hithongming/p/9229871.html">å¦‚ä½•ç†è§£åŠ¨æ€è§„åˆ’ï¼Ÿ</a>ã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹åŒ…æ‹¬ï¼šæ¦‚è¿°ï¼Œå®ç°ï¼Œç®—æ³•é¢˜ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="algorithm" scheme="http://linyishui.top/tags/algorithm/"/>
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
  </entry>
  
  <entry>
    <title>ç®—æ³•å¤ä¹  (ä¸‰) å›¾-æ— å‘å›¾ï¼ˆæœªå®Œæˆï¼‰</title>
    <link href="http://linyishui.top/2021030401.html"/>
    <id>http://linyishui.top/2021030401.html</id>
    <published>2021-03-04T13:36:06.000Z</published>
    <updated>2021-04-20T05:29:50.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç®—æ³•å¤ä¹ -ä¸‰-å›¾-æ— å‘å›¾"><a href="#ç®—æ³•å¤ä¹ -ä¸‰-å›¾-æ— å‘å›¾" class="headerlink" title="ç®—æ³•å¤ä¹  (ä¸‰) å›¾-æ— å‘å›¾"></a>ç®—æ³•å¤ä¹  (ä¸‰) å›¾-æ— å‘å›¾</h1><h2 id="ä¸€-å›¾"><a href="#ä¸€-å›¾" class="headerlink" title="ä¸€. å›¾"></a>ä¸€. å›¾</h2><h3 id="1-1-åº”ç”¨åœºæ™¯"><a href="#1-1-åº”ç”¨åœºæ™¯" class="headerlink" title="1.1 åº”ç”¨åœºæ™¯"></a>1.1 åº”ç”¨åœºæ™¯</h3><ul><li>åœ°å›¾ã€‚æ­£åœ¨è®¡åˆ’æ—…è¡Œçš„äººä¹Ÿè®¸æƒ³çŸ¥é“â€œä»æ™®ç½—ç»´ç™»æ–¯åˆ°æ™®æ—æ–¯é¡¿çš„æœ€çŸ­è·¯çº¿â€ã€‚å¯¹æœ€çŸ­è·¯å¾„ä¸Šç»å†è¿‡äº¤é€šå µå¡çš„æ—…è¡Œè€…å¯èƒ½ä¼šé—®ï¼šâ€œä»æ™®ç½—ç»´ç™»æ–¯åˆ°æ™®æ—æ–¯é¡¿çš„å“ªæ¡è·¯çº¿æœ€å¿«ï¼Ÿâ€è¦å›ç­”è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½è¦å¤„ç†æœ‰å…³ç»“ç‚¹ï¼ˆåå­—è·¯å£ï¼‰ä¹‹é—´å¤šæ¡è¿æ¥ï¼ˆå…¬è·¯ï¼‰çš„ä¿¡æ¯ã€‚</li><li>ç½‘é¡µä¿¡æ¯ã€‚å½“æˆ‘ä»¬åœ¨æµè§ˆç½‘é¡µæ—¶ï¼Œé¡µé¢ä¸Šéƒ½ä¼šåŒ…å«å…¶ä»–ç½‘é¡µçš„å¼•ç”¨ï¼ˆé“¾æ¥ï¼‰ã€‚é€šè¿‡å•å‡»é“¾æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªé¡µé¢è·³åˆ°å¦ä¸€ä¸ªé¡µé¢ã€‚æ•´ä¸ªäº’è”ç½‘å°±æ˜¯ä¸€å¼ å›¾ï¼Œç»“ç‚¹æ˜¯ç½‘é¡µï¼Œè¿æ¥å°±æ˜¯è¶…é“¾æ¥ã€‚å›¾ç®—æ³•æ˜¯å¸®åŠ©æˆ‘ä»¬åœ¨ç½‘ç»œä¸Šå®šä½ä¿¡æ¯çš„æœç´¢å¼•æ“çš„å…³é”®ç»„ä»¶ã€‚</li><li>ç”µè·¯ã€‚åœ¨ä¸€å—ç”µè·¯æ¿ä¸Šï¼Œæ™¶ä½“ç®¡ã€ç”µé˜»ã€ç”µå®¹ç­‰å„ç§å…ƒä»¶æ˜¯ç²¾å¯†è¿æ¥åœ¨ä¸€èµ·çš„ã€‚æˆ‘ä»¬ä½¿ç”¨è®¡ç®—æœºæ¥æ§åˆ¶åˆ¶é€ ç”µè·¯æ¿çš„æœºå™¨å¹¶æ£€æŸ¥ç”µè·¯æ¿çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚æˆ‘ä»¬æ—¢è¦æ£€æŸ¥çŸ­è·¯è¿™ç±»ç®€å•é—®é¢˜ï¼Œä¹Ÿè¦æ£€æŸ¥è¿™å¹…ç”µè·¯å›¾ä¸­çš„å¯¼çº¿åœ¨èš€åˆ»åˆ°èŠ¯ç‰‡ä¸Šæ—¶æ˜¯å¦ä¼šå‡ºç°äº¤å‰ç­‰å¤æ‚é—®é¢˜ã€‚ç¬¬ä¸€ç±»é—®é¢˜çš„ç­”æ¡ˆä»…å–å†³äºè¿æ¥ï¼ˆå¯¼çº¿ï¼‰çš„å±æ€§ï¼Œè€Œç¬¬äºŒä¸ªé—®é¢˜åˆ™ä¼šæ¶‰åŠå¯¼çº¿ã€å„ç§å…ƒä»¶<br>ä»¥åŠèŠ¯ç‰‡çš„ç‰©ç†ç‰¹æ€§ç­‰è¯¦ç»†ä¿¡æ¯ã€‚</li><li>ä»»åŠ¡è°ƒåº¦ã€‚å•†å“çš„ç”Ÿäº§è¿‡ç¨‹åŒ…å«äº†è®¸å¤šå·¥åºä»¥åŠä¸€äº›é™åˆ¶æ¡ä»¶ï¼Œè¿™äº›æ¡ä»¶ä¼šå†³å®šæŸäº›ä»»åŠ¡çš„å…ˆåæ¬¡åºã€‚å¦‚ä½•å®‰æ’æ‰èƒ½åœ¨æ»¡è¶³é™åˆ¶æ¡ä»¶çš„æƒ…å†µä¸‹ç”¨æœ€å°‘çš„æ—¶é—´å®Œæˆè¿™äº›ç”Ÿäº§å·¥åºå‘¢ï¼Ÿ<br>å•†ä¸šäº¤æ˜“ã€‚é›¶å”®å•†å’Œé‡‘èæœºæ„éƒ½ä¼šè·Ÿè¸ªå¸‚åœºä¸­çš„ä¹°å–ä¿¡æ¯ã€‚åœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œä¸€æ¡è¿æ¥å¯ä»¥è¡¨ç¤ºç°é‡‘å’Œå•†å“åœ¨ä¹°æ–¹å’Œå–æ–¹ä¹‹é—´çš„è½¬ç§»ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œç†è§£å›¾çš„è¿æ¥ç»“æ„åŸç†å¯èƒ½æœ‰åŠ©äºå¢å¼ºäººä»¬å¯¹å¸‚åœºçš„ç†è§£ã€‚</li><li>é…å¯¹ã€‚å­¦ç”Ÿå¯ä»¥ç”³è¯·åŠ å…¥å„ç§æœºæ„ï¼Œä¾‹å¦‚ç¤¾äº¤ä¿±ä¹éƒ¨ã€å¤§å­¦æˆ–æ˜¯åŒ»å­¦é™¢ç­‰ã€‚è¿™é‡Œç»“ç‚¹å°±å¯¹åº”å­¦ç”Ÿå’Œæœºæ„ï¼Œè€Œè¿æ¥åˆ™å¯¹åº”é€’äº¤çš„ç”³è¯·ã€‚æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ç”³è¯·è€…ä¸ä»–ä»¬æ„Ÿå…´è¶£çš„ç©ºä½ä¹‹é—´é…å¯¹çš„æ–¹æ³•ã€‚</li><li>è®¡ç®—æœºç½‘ç»œã€‚è®¡ç®—æœºç½‘ç»œæ˜¯ç”±èƒ½å¤Ÿå‘é€ã€è½¬å‘å’Œæ¥æ”¶å„ç§æ¶ˆæ¯çš„ç«™ç‚¹äº’ç›¸è¿æ¥ç»„æˆçš„ã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯è¿™ç§äº’è”ç»“æ„çš„æ€§è´¨ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›ç½‘ç»œä¸­çš„çº¿è·¯å’Œäº¤æ¢è®¾å¤‡èƒ½å¤Ÿé«˜æ•ˆç‡åœ°å¤„ç†ç½‘ç»œæµé‡ã€‚</li><li>è½¯ä»¶ã€‚ç¼–è¯‘å™¨ä¼šä½¿ç”¨å›¾æ¥è¡¨ç¤ºå¤§å‹è½¯ä»¶ç³»ç»Ÿä¸­å„ä¸ªæ¨¡å—ä¹‹é—´çš„å…³ç³»ã€‚å›¾ä¸­çš„ç»“ç‚¹å³æ„æˆæ•´ä¸ªç³»ç»Ÿçš„å„ç§ç±»å’Œæ¨¡å—ï¼Œè¿æ¥åˆ™ä¸ºç±»çš„æ–¹æ³•ä¹‹é—´çš„å¯èƒ½è°ƒç”¨å…³ç³»ï¼ˆé™æ€åˆ†æï¼‰ï¼Œæˆ–æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶çš„å®é™…è°ƒç”¨å…³ç³»ï¼ˆåŠ¨æ€åˆ†æï¼‰ã€‚æˆ‘ä»¬éœ€è¦åˆ†æè¿™å¹…å›¾æ¥å†³å®šå¦‚ä½•ä»¥æœ€ä¼˜çš„æ–¹å¼ä¸ºç¨‹åºåˆ†é…èµ„æºã€‚</li><li>ç¤¾äº¤ç½‘ç»œã€‚å½“ä½ åœ¨ä½¿ç”¨ç¤¾äº¤ç½‘ç«™æ—¶ï¼Œä¼šå’Œä½ çš„æœ‹å‹ä¹‹é—´å»ºç«‹èµ·æ˜ç¡®çš„å…³ç³»ã€‚è¿™é‡Œï¼Œç»“ç‚¹å¯¹åº”äººè€Œè¿æ¥åˆ™è”ç³»ç€ä½ å’Œä½ çš„æœ‹å‹æˆ–æ˜¯å…³æ³¨è€…ã€‚åˆ†æè¿™äº›ç¤¾äº¤ç½‘ç»œçš„æ€§è´¨æ˜¯å½“å‰å›¾ç®—æ³•çš„ä¸€ä¸ªé‡è¦åº”ç”¨ã€‚å¯¹å®ƒæ„Ÿå…´è¶£çš„ä¸æ­¢æ˜¯ç¤¾äº¤ç½‘ç»œçš„å…¬å¸ï¼Œè¿˜åŒ…æ‹¬æ”¿æ²»ã€å¤–äº¤ã€å¨±ä¹ã€æ•™è‚²ã€å¸‚åœºç­‰è®¸å¤šå…¶ä»–æœºæ„ã€‚</li></ul><table><thead><tr><th>åº”ç”¨</th><th>ç»“ç‚¹</th><th>è¿æ¥</th></tr></thead><tbody><tr><td>åœ°å›¾</td><td>åå­—è·¯å£</td><td>å…¬è·¯</td></tr><tr><td>ç½‘ç»œå†…å®¹</td><td>ç½‘é¡µ</td><td>è¶…é“¾æ¥</td></tr><tr><td>ç”µè·¯</td><td>å…ƒå™¨ä»¶</td><td>å¯¼çº¿</td></tr><tr><td>ä»»åŠ¡è°ƒåº¦</td><td>ä»»åŠ¡</td><td>é™åˆ¶æ¡ä»¶</td></tr><tr><td>å•†ä¸šäº¤æ˜“</td><td>å®¢æˆ·</td><td>äº¤æ˜“</td></tr><tr><td>é…å¯¹</td><td>å­¦ç”Ÿ</td><td>ç”³è¯·</td></tr><tr><td>è®¡ç®—æœºç½‘ç»œ</td><td>ç½‘ç«™</td><td>ç‰©ç†è¿æ¥</td></tr><tr><td>è½¯ä»¶</td><td>æ–¹æ³•</td><td>è°ƒç”¨å…³ç³»</td></tr><tr><td>ç¤¾äº¤ç½‘ç»œ</td><td>äºº</td><td>å‹è°Šå…³ç³»</td></tr></tbody></table><h3 id="1-2-å¸¸ç”¨æœ¯è¯­"><a href="#1-2-å¸¸ç”¨æœ¯è¯­" class="headerlink" title="1.2 å¸¸ç”¨æœ¯è¯­"></a>1.2 å¸¸ç”¨æœ¯è¯­</h3><ul><li>æŸä¸ªé¡¶ç‚¹çš„åº¦æ•°å³ä¸ºä¾é™„äºå®ƒçš„è¾¹çš„æ€»æ•°ã€‚</li><li>å­å›¾æ˜¯ç”±ä¸€å¹…å›¾çš„æ‰€æœ‰è¾¹çš„ä¸€ä¸ªå­é›†ï¼ˆä»¥åŠå®ƒä»¬æ‰€ä¾é™„çš„æ‰€æœ‰é¡¶ç‚¹ï¼‰ç»„æˆçš„å›¾ã€‚è®¸å¤šè®¡ç®—é—®é¢˜éƒ½éœ€è¦è¯†åˆ«å„ç§ç±»å‹çš„å­å›¾ï¼Œç‰¹åˆ«æ˜¯ç”±èƒ½å¤Ÿé¡ºåºè¿æ¥ä¸€ç³»åˆ—é¡¶ç‚¹çš„è¾¹æ‰€ç»„æˆçš„å­å›¾ã€‚</li><li>è·¯å¾„æ˜¯ç”±è¾¹é¡ºåºè¿æ¥çš„ä¸€ç³»åˆ—é¡¶ç‚¹ã€‚</li><li>ç®€å•è·¯å¾„æ˜¯ä¸€æ¡æ²¡æœ‰é‡å¤é¡¶ç‚¹çš„è·¯å¾„ã€‚ç¯æ˜¯ä¸€æ¡è‡³å°‘å«æœ‰ä¸€æ¡è¾¹ä¸”èµ·ç‚¹å’Œç»ˆç‚¹ç›¸åŒçš„è·¯å¾„ã€‚</li><li>ç®€å•ç¯æ˜¯ä¸€æ¡ï¼ˆé™¤äº†èµ·ç‚¹å’Œç»ˆç‚¹å¿…é¡»ç›¸åŒä¹‹å¤–ï¼‰ä¸å«æœ‰é‡å¤é¡¶ç‚¹å’Œè¾¹çš„ç¯ã€‚</li><li>è·¯å¾„æˆ–è€…ç¯çš„é•¿åº¦ä¸ºå…¶ä¸­æ‰€åŒ…å«çš„è¾¹æ•°ã€‚</li><li>å½“ä¸¤ä¸ªé¡¶ç‚¹ä¹‹é—´å­˜åœ¨ä¸€æ¡è¿æ¥åŒæ–¹çš„è·¯å¾„æ—¶ï¼Œæˆ‘ä»¬ç§°ä¸€ä¸ªé¡¶ç‚¹å’Œå¦ä¸€ä¸ªé¡¶ç‚¹æ˜¯è¿é€šçš„ã€‚</li><li>å¦‚æœä»ä»»æ„ä¸€ä¸ªé¡¶ç‚¹éƒ½å­˜åœ¨ä¸€æ¡è·¯å¾„åˆ°è¾¾å¦ä¸€ä¸ªä»»æ„é¡¶ç‚¹ï¼Œæˆ‘ä»¬ç§°è¿™å¹…å›¾æ˜¯<strong>è¿é€šå›¾</strong>ã€‚ä¸€å¹…éè¿é€šçš„å›¾ç”±è‹¥å¹²è¿é€šçš„éƒ¨åˆ†ç»„æˆï¼Œå®ƒä»¬éƒ½æ˜¯å…¶æå¤§è¿é€šå­å›¾ã€‚</li><li>æ— ç¯å›¾æ˜¯ä¸€ç§ä¸åŒ…å«ç¯çš„å›¾ã€‚</li><li>å›¾çš„å¯†åº¦æ˜¯æŒ‡å·²ç»è¿æ¥çš„é¡¶ç‚¹å¯¹å æ‰€æœ‰å¯èƒ½è¢«è¿æ¥çš„é¡¶ç‚¹å¯¹çš„æ¯”ä¾‹ã€‚åœ¨ç¨€ç–å›¾ä¸­ï¼Œè¢«è¿æ¥çš„é¡¶ç‚¹å¯¹å¾ˆå°‘ï¼›è€Œåœ¨ç¨ å¯†å›¾ä¸­ï¼Œåªæœ‰å°‘éƒ¨åˆ†é¡¶ç‚¹å¯¹ä¹‹é—´æ²¡æœ‰è¾¹è¿æ¥ã€‚</li><li>äºŒåˆ†å›¾æ˜¯ä¸€ç§èƒ½å¤Ÿå°†æ‰€æœ‰ç»“ç‚¹åˆ†ä¸ºä¸¤éƒ¨åˆ†çš„å›¾ï¼Œå…¶ä¸­å›¾çš„æ¯æ¡è¾¹æ‰€è¿æ¥çš„ä¸¤ä¸ªé¡¶ç‚¹éƒ½åˆ†åˆ«å±äºä¸åŒçš„éƒ¨åˆ†ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010113.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010116.png"></p><h3 id="1-3-å›¾ä¸æ ‘çš„å…³ç³»"><a href="#1-3-å›¾ä¸æ ‘çš„å…³ç³»" class="headerlink" title="1.3 å›¾ä¸æ ‘çš„å…³ç³»"></a>1.3 å›¾ä¸æ ‘çš„å…³ç³»</h3><p>æ ‘æ˜¯ä¸€å¹…æ— ç¯è¿é€šå›¾ã€‚äº’ä¸ç›¸è¿çš„æ ‘ç»„æˆçš„é›†åˆç§°ä¸ºæ£®æ—ã€‚è¿é€šå›¾çš„ç”Ÿæˆæ ‘æ˜¯å®ƒçš„ä¸€å¹…å­å›¾ï¼Œå®ƒå«æœ‰å›¾ä¸­çš„æ‰€æœ‰é¡¶ç‚¹ä¸”æ˜¯ä¸€æ£µæ ‘ã€‚å›¾çš„ç”Ÿæˆæ ‘æ£®æ—æ˜¯å®ƒçš„æ‰€æœ‰è¿é€šå­å›¾çš„ç”Ÿæˆæ ‘çš„é›†åˆã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010114.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010115.png"></p><p>å½“ä¸”ä»…å½“ä¸€å¹…å«æœ‰Vä¸ªç»“ç‚¹çš„å›¾æ»¡è¶³ä¸‹åˆ— 5 ä¸ªæ¡ä»¶ä¹‹ä¸€æ—¶ï¼Œå®ƒå°±æ˜¯ä¸€æ£µæ ‘ï¼š</p><ul><li>Gæœ‰V-1æ¡è¾¹ä¸”ä¸å«æœ‰ç¯ï¼›</li><li>Gæœ‰V-1æ¡è¾¹ä¸”æ˜¯è¿é€šçš„ï¼›</li><li>Gæ˜¯è¿é€šçš„ï¼Œä½†åˆ é™¤ä»»æ„ä¸€æ¡è¾¹éƒ½ä¼šä½¿å®ƒä¸å†è¿é€šï¼›</li><li>Gæ˜¯æ— ç¯å›¾ï¼Œä½†æ·»åŠ ä»»æ„ä¸€æ¡è¾¹éƒ½ä¼šäº§ç”Ÿä¸€æ¡ç¯ï¼›</li><li>Gä¸­çš„ä»»æ„ä¸€å¯¹é¡¶ç‚¹ä¹‹é—´ä»…å­˜åœ¨ä¸€æ¡ç®€å•è·¯å¾„ã€‚</li></ul><h3 id="1-4-å››ç§å›¾æ¨¡å‹"><a href="#1-4-å››ç§å›¾æ¨¡å‹" class="headerlink" title="1.4 å››ç§å›¾æ¨¡å‹"></a>1.4 å››ç§å›¾æ¨¡å‹</h3><p>4 ç§æœ€é‡è¦çš„å›¾æ¨¡å‹ï¼š</p><ul><li>æ— å‘å›¾ï¼ˆç®€å•è¿æ¥ï¼‰</li><li>æœ‰å‘å›¾ï¼ˆè¿æ¥æœ‰æ–¹å‘æ€§ï¼‰</li><li>åŠ æƒå›¾ï¼ˆè¿æ¥å¸¦æœ‰æƒå€¼ï¼‰</li><li>åŠ æƒæœ‰å‘å›¾ï¼ˆè¿æ¥æ—¢æœ‰æ–¹å‘æ€§åˆå¸¦æœ‰æƒå€¼ï¼‰</li></ul><h2 id="äºŒ-æ— å‘å›¾"><a href="#äºŒ-æ— å‘å›¾" class="headerlink" title="äºŒ. æ— å‘å›¾"></a>äºŒ. æ— å‘å›¾</h2><h4 id="ï¼ˆ1ï¼‰æ¦‚å¿µ"><a href="#ï¼ˆ1ï¼‰æ¦‚å¿µ" class="headerlink" title="ï¼ˆ1ï¼‰æ¦‚å¿µ"></a>ï¼ˆ1ï¼‰æ¦‚å¿µ</h4><p>å®šä¹‰ï¼šå›¾æ˜¯ç”±ä¸€ç»„é¡¶ç‚¹å’Œä¸€ç»„èƒ½å¤Ÿå°†ä¸¤ä¸ªé¡¶ç‚¹ç›¸è¿çš„è¾¹ç»„æˆçš„ã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨ 0 è‡³ V-1 æ¥è¡¨ç¤ºä¸€å¼ å«æœ‰ V ä¸ªé¡¶ç‚¹çš„å›¾ä¸­çš„å„ä¸ªé¡¶<br>ç‚¹ã€‚ç”¨ v-w çš„è®°æ³•æ¥è¡¨ç¤ºè¿æ¥ v å’Œ w çš„è¾¹ï¼Œw-v æ˜¯è¿™æ¡è¾¹çš„å¦ä¸€ç§è¡¨ç¤ºæ–¹æ³•ã€‚</p><p>ç»˜åˆ¶å‡ºçš„å›¾æœ‰æ—¶ä¼šè¯¯å¯¼æˆ‘ä»¬ï¼Œå› ä¸ºå›¾çš„å®šä¹‰å’Œç»˜å‡ºçš„å›¾åƒæ˜¯æ— å…³çš„ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010111.png"></p><p>ç‰¹æ®Šçš„å›¾ã€‚æˆ‘ä»¬çš„å®šä¹‰å…è®¸å‡ºç°ä¸¤ç§ç®€å•è€Œç‰¹æ®Šçš„æƒ…å†µï¼š</p><ul><li>è‡ªç¯ï¼Œå³ä¸€æ¡è¿æ¥ä¸€ä¸ªé¡¶ç‚¹å’Œå…¶è‡ªèº«çš„è¾¹ï¼›</li><li>è¿æ¥åŒä¸€å¯¹é¡¶ç‚¹çš„ä¸¤æ¡è¾¹ç§°ä¸ºå¹³è¡Œè¾¹ã€‚</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010112.png"></p><p>æ•°å­¦å®¶å¸¸å¸¸å°†å«æœ‰å¹³è¡Œè¾¹çš„å›¾ç§°ä¸ºå¤šé‡å›¾ï¼Œè€Œå°†æ²¡æœ‰å¹³è¡Œè¾¹æˆ–è‡ªç¯çš„å›¾ç§°ä¸ºç®€å•å›¾ã€‚åç»­ä¸ä¼šå‡ºç°è¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œæ‰€ä»¥ç”¨ä¸¤ä¸ªé¡¶ç‚¹å°±å¯ä»¥æŒ‡ä»£ä¸€æ¡è¾¹äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bag</span>&lt;<span class="title">Item</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Item</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node first; <span class="comment">// é“¾è¡¨çš„é¦–ç»“ç‚¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        Item item;</span><br><span class="line">        Node next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Item item)</span> </span>&#123; <span class="comment">// å’ŒStack çš„push() æ–¹æ³•å®Œå…¨ç›¸åŒ</span></span><br><span class="line">        Node oldfirst = first;</span><br><span class="line">        first = <span class="keyword">new</span> Node();</span><br><span class="line">        first.item = item;</span><br><span class="line">        first.next = oldfirst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;Item&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListIterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ListIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Item</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Node current = first;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> current != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Item <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Item item = current.item;</span><br><span class="line">            current = current.next;</span><br><span class="line">            <span class="keyword">return</span> item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Graph</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> V; <span class="comment">// é¡¶ç‚¹æ•°ç›®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> E; <span class="comment">// è¾¹çš„æ•°ç›®</span></span><br><span class="line">    <span class="keyword">private</span> Bag&lt;Integer&gt;[] adj; <span class="comment">// é‚»æ¥è¡¨ï¼šæ•°ç»„+é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Graph</span><span class="params">(<span class="keyword">int</span> V)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.V = V;</span><br><span class="line">        <span class="keyword">this</span>.E = <span class="number">0</span>;</span><br><span class="line">        adj = (Bag&lt;Integer&gt;[]) <span class="keyword">new</span> Bag[V]; <span class="comment">// åˆ›å»ºé‚»æ¥è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; V; v++) <span class="comment">// å°†æ‰€æœ‰é“¾è¡¨åˆå§‹åŒ–ä¸ºç©º</span></span><br><span class="line">            adj[v] = <span class="keyword">new</span> Bag&lt;Integer&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Graph</span><span class="params">(In in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(in.readInt()); <span class="comment">// è¯»å–Vå¹¶å°†å›¾åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">int</span> E = in.readInt(); <span class="comment">// è¯»å–E</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; E; i++) &#123; <span class="comment">// æ·»åŠ ä¸€æ¡è¾¹</span></span><br><span class="line">            <span class="keyword">int</span> v = in.readInt(); <span class="comment">// è¯»å–ä¸€ä¸ªé¡¶ç‚¹</span></span><br><span class="line">            <span class="keyword">int</span> w = in.readInt(); <span class="comment">// è¯»å–å¦ä¸€ä¸ªé¡¶ç‚¹</span></span><br><span class="line">            addEdge(v, w); <span class="comment">// æ·»åŠ ä¸€æ¡è¿æ¥å®ƒä»¬çš„è¾¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">V</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> V;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">E</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> E;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        adj[v].add(w); <span class="comment">// å°†wæ·»åŠ åˆ°vçš„é“¾è¡¨ä¸­</span></span><br><span class="line">        adj[w].add(v); <span class="comment">// å°†væ·»åŠ åˆ°wçš„é“¾è¡¨ä¸­</span></span><br><span class="line">        E++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Integer&gt; <span class="title">adj</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adj[v];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰-æ·±åº¦ä¼˜å…ˆæœç´¢"><a href="#ä¸‰-æ·±åº¦ä¼˜å…ˆæœç´¢" class="headerlink" title="ä¸‰. æ·±åº¦ä¼˜å…ˆæœç´¢"></a>ä¸‰. æ·±åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="3-1-ä»€ä¹ˆæ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ"><a href="#3-1-ä»€ä¹ˆæ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ" class="headerlink" title="3.1 ä»€ä¹ˆæ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ"></a>3.1 ä»€ä¹ˆæ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ</h3><p><strong>æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•</strong>ï¼ˆè‹±è¯­ï¼šDepth-First-Searchï¼ŒDFSï¼‰æ˜¯ä¸€ç§ç”¨äºéå†æˆ–æœç´¢æ ‘æˆ–å›¾çš„é€’å½’ç®—æ³•ï¼Œå®ƒä¼šæ²¿ç€å›¾çš„è¾¹å¯»æ‰¾å’Œèµ·ç‚¹è¿é€šçš„æ‰€æœ‰é¡¶ç‚¹ã€‚è¿™ä¸ªç®—æ³•ä¼šå°½å¯èƒ½æ·±çš„æœç´¢æ ‘çš„åˆ†æ”¯ã€‚å½“èŠ‚ç‚¹vçš„æ‰€åœ¨è¾¹éƒ½å·±è¢«æ¢å¯»è¿‡ï¼Œæœç´¢å°†å›æº¯åˆ°å‘ç°èŠ‚ç‚¹vçš„é‚£æ¡è¾¹çš„èµ·å§‹èŠ‚ç‚¹ã€‚è¿™ä¸€è¿‡ç¨‹ä¸€ç›´è¿›è¡Œåˆ°å·²å‘ç°ä»æºèŠ‚ç‚¹å¯è¾¾çš„æ‰€æœ‰èŠ‚ç‚¹ä¸ºæ­¢ã€‚å¦‚æœè¿˜å­˜åœ¨æœªè¢«å‘ç°çš„èŠ‚ç‚¹ï¼Œåˆ™é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºæºèŠ‚ç‚¹å¹¶é‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œæ•´ä¸ªè¿›ç¨‹åå¤è¿›è¡Œç›´åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«è®¿é—®ä¸ºæ­¢ã€‚</p><p>æ·±åº¦ä¼˜å…ˆæœç´¢æ˜¯å›¾è®ºä¸­çš„ç»å…¸ç®—æ³•ï¼Œåˆ©ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•å¯ä»¥äº§ç”Ÿç›®æ ‡å›¾çš„æ‹“æ‰‘æ’åºï¼Œåˆ©ç”¨æ‹“æ‰‘æ’åºè¡¨å¯ä»¥æ–¹ä¾¿çš„è§£å†³å¾ˆå¤šç›¸å…³çš„å›¾è®ºé—®é¢˜ï¼Œå¦‚æ— æƒæœ€é•¿è·¯å¾„é—®é¢˜ç­‰ç­‰ã€‚è¿™ç§ç®—æ³•ä¸ä¼šæ ¹æ®å›¾çš„ç»“æ„ç­‰ä¿¡æ¯è°ƒæ•´æ‰§è¡Œç­–ç•¥æ¥æºè¯·æ±‚ã€‚</p><h3 id="3-2-è¿·å®«é—®é¢˜å’Œ-Tremaux-æœç´¢"><a href="#3-2-è¿·å®«é—®é¢˜å’Œ-Tremaux-æœç´¢" class="headerlink" title="3.2 è¿·å®«é—®é¢˜å’Œ Tremaux æœç´¢"></a>3.2 è¿·å®«é—®é¢˜å’Œ Tremaux æœç´¢</h3><p>æ€è€ƒå›¾çš„æœç´¢è¿‡ç¨‹çš„ä¸€ç§æœ‰ç›Šçš„æ–¹æ³•æ˜¯ï¼Œè€ƒè™‘å¦ä¸€ä¸ªå’Œå®ƒç­‰ä»·çš„é—®é¢˜ï¼šåœ¨ä¸€ä¸ªç”±å„ç§é€šé“å’Œè·¯å£ç»„æˆçš„è¿·å®«ä¸­æ‰¾åˆ°å‡ºè·¯ã€‚æœ‰äº›è¿·å®«çš„è§„åˆ™å¾ˆç®€å•ï¼Œä½†å¤§å¤šæ•°è¿·å®«åˆ™éœ€è¦å¾ˆå¤æ‚çš„ç­–ç•¥æ‰è¡Œã€‚</p><p>ç”¨è¿·å®«ä»£æ›¿å›¾ã€é€šé“ä»£æ›¿è¾¹ã€è·¯å£ä»£æ›¿é¡¶ç‚¹ä»…ä»…åªæ˜¯ä¸€äº›æ–‡å­—æ¸¸æˆï¼Œä½†å°±ç›®å‰æ¥è¯´ï¼Œè¿™ä¹ˆåšå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç›´è§‚åœ°è®¤è¯†é—®é¢˜ï¼Œå‚è§ä¸‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010102.png"></p><p>æ¢ç´¢è¿·å®«è€Œä¸è¿·è·¯çš„ä¸€ç§å¤è€åŠæ³•ï¼ˆè‡³å°‘å¯ä»¥è¿½æº¯åˆ°å¿’ä¿®æ–¯å’Œç±³è¯ºé™¶çš„ä¼ è¯´ï¼‰å«åš <strong>Tremaux æœç´¢</strong>ï¼Œå‚è§ä¸‹å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010103.png"></p><p>è¦æ¢ç´¢è¿·å®«ä¸­çš„æ‰€æœ‰é€šé“ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li>é€‰æ‹©ä¸€æ¡æ²¡æœ‰æ ‡è®°è¿‡çš„é€šé“ï¼Œåœ¨ä½ èµ°è¿‡çš„è·¯ä¸Šé“ºä¸€æ¡ç»³å­ï¼›</li><li>æ ‡è®°æ‰€æœ‰ä½ ç¬¬ä¸€æ¬¡è·¯è¿‡çš„è·¯å£å’Œé€šé“ï¼›</li><li>å½“æ¥åˆ°ä¸€ä¸ªæ ‡è®°è¿‡çš„è·¯å£æ—¶ï¼ˆç”¨ç»³å­ï¼‰å›é€€åˆ°ä¸Šä¸ªè·¯å£ï¼›</li><li>å½“å›é€€åˆ°çš„è·¯å£å·²æ²¡æœ‰å¯èµ°çš„é€šé“æ—¶ç»§ç»­å›é€€ã€‚</li></ul><p>ç»³å­å¯ä»¥ä¿è¯ä½ æ€»èƒ½æ‰¾åˆ°ä¸€æ¡å‡ºè·¯ï¼Œæ ‡è®°åˆ™èƒ½ä¿è¯ä½ ä¸ä¼šä¸¤æ¬¡ç»è¿‡åŒä¸€æ¡é€šé“æˆ–è€…åŒä¸€ä¸ªè·¯å£ã€‚è¦çŸ¥é“æ˜¯å¦å®Œå…¨æ¢ç´¢äº†æ•´ä¸ªè¿·å®«éœ€è¦çš„è¯æ˜æ›´å¤æ‚ï¼Œåªæœ‰ç”¨å›¾æœç´¢æ‰èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†é—®é¢˜ã€‚</p><p>Tremaux æœç´¢å¾ˆç›´æ¥ï¼Œä½†å®ƒä¸å®Œå…¨æœç´¢ä¸€å¼ å›¾ä»ç„¶ç¨æœ‰ä¸åŒï¼Œå› æ­¤æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹å›¾çš„æœç´¢æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepthFirstSearch</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] marked;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DepthFirstSearch</span><span class="params">(Graph G, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        dfs(G, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Graph G, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        marked[v] = <span class="keyword">true</span>;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> w : G.adj(v))</span><br><span class="line">            <span class="keyword">if</span> (!marked[w]) dfs(G, w);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">marked</span><span class="params">(<span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> marked[w];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-ç®—æ³•æè¿°"><a href="#3-3-ç®—æ³•æè¿°" class="headerlink" title="3.3 ç®—æ³•æè¿°"></a>3.3 ç®—æ³•æè¿°</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010104.png"></p><p>æœç´¢è¿é€šå›¾çš„ç»å…¸é€’å½’ç®—æ³•<strong>æ·±åº¦ä¼˜å…ˆæœç´¢</strong>ï¼ˆéå†æ‰€æœ‰çš„é¡¶ç‚¹å’Œè¾¹ï¼‰å’Œ Tremaux æœç´¢ç±»ä¼¼ã€‚è¦æœç´¢ä¸€å¹…å›¾ï¼Œåªéœ€ç”¨ä¸€ä¸ªé€’å½’æ–¹æ³•æ¥éå†æ‰€æœ‰é¡¶ç‚¹ã€‚<strong>æ·±åº¦ä¼˜å…ˆæœç´¢æ ‡è®°ä¸èµ·ç‚¹è¿é€šçš„æ‰€æœ‰é¡¶ç‚¹æ‰€éœ€çš„æ—¶é—´å’Œé¡¶ç‚¹çš„åº¦æ•°ä¹‹å’Œæˆæ­£æ¯”</strong>ã€‚</p><p>åœ¨è®¿é—®å…¶ä¸­ä¸€ä¸ªé¡¶ç‚¹æ—¶ï¼š</p><ul><li>å°†å®ƒæ ‡è®°ä¸ºå·²è®¿é—®ï¼›</li><li>é€’å½’åœ°è®¿é—®å®ƒçš„æ‰€æœ‰æ²¡æœ‰è¢«æ ‡è®°è¿‡çš„é‚»å±…é¡¶ç‚¹ã€‚</li></ul><p>å®ƒä½¿ç”¨ä¸€ä¸ª boolean æ•°ç»„æ¥è®°å½•å’Œèµ·ç‚¹è¿é€šçš„æ‰€æœ‰é¡¶ç‚¹ã€‚é€’å½’æ–¹æ³•ä¼šæ ‡è®°ç»™å®šçš„é¡¶ç‚¹å¹¶è°ƒç”¨è‡ªå·±æ¥è®¿é—®è¯¥é¡¶ç‚¹çš„ç›¸é‚»é¡¶ç‚¹åˆ—è¡¨ä¸­æ‰€æœ‰æ²¡æœ‰è¢«æ ‡è®°è¿‡çš„é¡¶ç‚¹ã€‚å¦‚æœå›¾æ˜¯è¿é€šçš„ï¼Œæ¯ä¸ªé‚»æ¥é“¾è¡¨ä¸­çš„å…ƒç´ éƒ½ä¼šè¢«æ£€æŸ¥åˆ°ã€‚</p><p>ç®—æ³•éå†è¾¹å’Œè®¿é—®é¡¶ç‚¹çš„é¡ºåºä¸å›¾çš„è¡¨ç¤ºæ˜¯æœ‰å…³çš„ï¼Œè€Œä¸åªæ˜¯ä¸å›¾çš„ç»“æ„æˆ–æ˜¯ç®—æ³•æœ‰å…³ã€‚å› ä¸ºæ·±åº¦ä¼˜å…ˆæœç´¢åªä¼šè®¿é—®å’Œèµ·ç‚¹è¿é€šçš„é¡¶ç‚¹ï¼Œä½¿ç”¨ä¸‹å›¾æ‰€ç¤ºçš„ä¸€å¹…å°å‹è¿é€šå›¾ä¸ºä¾‹ï¼Œä¸€å¹…è¿é€šçš„æ— å‘å›¾ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010105.png"></p><ul><li>åœ¨ç¤ºä¾‹ä¸­ï¼Œé¡¶ç‚¹ 2 æ˜¯é¡¶ç‚¹ 0 ä¹‹åç¬¬ä¸€ä¸ªè¢«è®¿é—®çš„é¡¶ç‚¹ï¼Œå› ä¸ºå®ƒæ­£å¥½æ˜¯ 0 çš„é‚»æ¥è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li><li>æ·±åº¦ä¼˜å…ˆæœç´¢ä¸­æ¯æ¡è¾¹éƒ½ä¼šè¢«è®¿é—®ä¸¤æ¬¡ï¼Œä¸”åœ¨ç¬¬äºŒæ¬¡æ—¶æ€»ä¼šå‘ç°è¿™ä¸ªé¡¶ç‚¹å·²ç»è¢«æ ‡è®°è¿‡ã€‚è¿™æ„å‘³ç€æ·±åº¦ä¼˜å…ˆæœç´¢çš„è½¨è¿¹å¯èƒ½ä¼šæ¯”ä½ æƒ³è±¡çš„é•¿ä¸€å€ï¼ç¤ºä¾‹å›¾ä»…å«æœ‰ 8 æ¡è¾¹ï¼Œä½†éœ€è¦è¿½è¸ªç®—æ³•åœ¨é‚»æ¥è¡¨çš„ 16 ä¸ªå…ƒç´ ä¸Šçš„æ“ä½œã€‚</li></ul><p>ä¸‹å›¾æ˜¾ç¤ºçš„æ˜¯ç¤ºä¾‹ä¸­æ¯ä¸ªé¡¶ç‚¹è¢«æ ‡è®°åç®—æ³•ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Œèµ·ç‚¹ä¸ºé¡¶ç‚¹ 0ã€‚ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢çš„è½¨è¿¹ï¼Œå¯»æ‰¾æ‰€æœ‰å’Œé¡¶ç‚¹ 0 è¿é€šçš„é¡¶ç‚¹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010106.png"></p><p>æŸ¥æ‰¾å¼€å§‹äºæ„é€ å‡½æ•°è°ƒç”¨é€’å½’çš„ <code>dfs()</code> æ¥æ ‡è®°å’Œè®¿é—®é¡¶ç‚¹0ï¼Œåç»­å¤„ç†å¦‚ä¸‹æ‰€è¿°ï¼š</p><ul><li>å› ä¸ºé¡¶ç‚¹ 2 æ˜¯ 0 çš„é‚»æ¥è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸”æ²¡æœ‰è¢«æ ‡è®°è¿‡ï¼Œ<code>dfs()</code> é€’å½’è°ƒç”¨è‡ªå·±æ¥æ ‡è®°å¹¶è®¿é—®é¡¶ç‚¹ 2ï¼ˆæ•ˆæœæ˜¯ç³»ç»Ÿä¼šå°†é¡¶ç‚¹ 0 å’Œ 0 çš„é‚»æ¥è¡¨çš„å½“å‰ä½ç½®å‹å…¥æ ˆä¸­ï¼‰ã€‚</li><li>ç°åœ¨ï¼Œé¡¶ç‚¹ 0 æ˜¯ 2 çš„é‚»æ¥è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸”å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œå› æ­¤ <code>dfs()</code> è·³è¿‡äº†å®ƒã€‚æ¥ä¸‹æ¥ï¼Œé¡¶ç‚¹ 1 æ˜¯ 2 çš„é‚»æ¥è¡¨çš„ç¬¬äºŒä¸ªå…ƒç´ ä¸”æ²¡æœ‰è¢«æ ‡è®°ï¼Œ<code>dfs()</code> é€’å½’è°ƒç”¨è‡ªå·±æ¥æ ‡è®°å¹¶è®¿é—®é¡¶ç‚¹ 1ã€‚</li><li>å¯¹é¡¶ç‚¹ 1 çš„è®¿é—®å’Œå‰é¢æœ‰æ‰€ä¸åŒï¼šå› ä¸ºå®ƒçš„é‚»æ¥è¡¨ä¸­çš„æ‰€æœ‰é¡¶ç‚¹ï¼ˆ0 å’Œ 2ï¼‰éƒ½å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œå› æ­¤ä¸éœ€è¦å†è¿›è¡Œé€’å½’ï¼Œæ–¹æ³•ä» <code>dfs(1)</code> ä¸­è¿”å›ã€‚ä¸‹ä¸€æ¡è¢«æ£€æŸ¥çš„è¾¹æ˜¯ 2-3ï¼ˆåœ¨ 2 çš„é‚»æ¥è¡¨ä¸­é¡¶ç‚¹ 1 ä¹‹åçš„é¡¶ç‚¹æ˜¯ 3ï¼‰ï¼Œå› æ­¤ <code>dfs()</code> é€’å½’è°ƒç”¨è‡ªå·±æ¥æ ‡è®°å¹¶è®¿é—®é¡¶ç‚¹3ã€‚</li><li>é¡¶ç‚¹ 5 æ˜¯ 3 çš„é‚»æ¥è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸”æ²¡æœ‰è¢«æ ‡è®°ï¼Œå› æ­¤ <code>dfs()</code> é€’å½’è°ƒç”¨è‡ªå·±æ¥æ ‡è®°å¹¶è®¿é—®é¡¶ç‚¹ 5ã€‚</li><li>é¡¶ç‚¹ 5 çš„é‚»æ¥è¡¨ä¸­çš„æ‰€æœ‰é¡¶ç‚¹ï¼ˆ3 å’Œ 0ï¼‰éƒ½å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œå› æ­¤ä¸éœ€è¦å†è¿›è¡Œé€’å½’ã€‚</li><li>é¡¶ç‚¹ 4 æ˜¯ 3 çš„é‚»æ¥è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ä¸”æ²¡æœ‰è¢«æ ‡è®°è¿‡ï¼Œå› æ­¤ <code>dfs()</code> é€’å½’è°ƒç”¨è‡ªå·±æ¥æ ‡è®°å¹¶è®¿é—®é¡¶ç‚¹ 4ã€‚è¿™æ˜¯æœ€åä¸€ä¸ªéœ€è¦è¢«æ ‡è®°çš„é¡¶ç‚¹ã€‚</li><li>åœ¨é¡¶ç‚¹ 4 è¢«æ ‡è®°äº†ä¹‹åï¼Œ<code>dfs()</code> ä¼šæ£€æŸ¥å®ƒçš„é‚»æ¥è¡¨ï¼Œç„¶åå†æ£€æŸ¥ 3 çš„é‚»æ¥è¡¨ï¼Œç„¶åæ˜¯ 2 çš„é‚»æ¥è¡¨ï¼Œç„¶åæ˜¯ 0 çš„ï¼Œæœ€åå‘ç°ä¸éœ€è¦å†è¿›è¡Œä»»ä½•é€’å½’è°ƒç”¨ï¼Œå› ä¸ºæ‰€æœ‰çš„é¡¶ç‚¹éƒ½å·²ç»è¢«æ ‡è®°è¿‡äº†ã€‚</li></ul><h3 id="3-4-ä½¿ç”¨åœºæ™¯"><a href="#3-4-ä½¿ç”¨åœºæ™¯" class="headerlink" title="3.4 ä½¿ç”¨åœºæ™¯"></a>3.4 ä½¿ç”¨åœºæ™¯</h3><ul><li><strong>è¿é€šæ€§é—®é¢˜</strong> / <strong>è·¯å¾„æ£€æµ‹é—®é¢˜</strong> ï¼šæ¯”å¦‚ç»™å®šä¸€å¹…å›¾ï¼Œå›ç­”â€œä¸¤ä¸ªç»™å®šçš„é¡¶ç‚¹æ˜¯å¦è¿é€šï¼Ÿâ€æˆ–è€…â€œå›¾ä¸­æœ‰å¤šå°‘ä¸ªè¿é€šå­å›¾ï¼Ÿâ€ç­‰ç±»ä¼¼é—®é¢˜ã€‚é—®é¢˜â€œä¸¤ä¸ªç»™å®šçš„é¡¶ç‚¹æ˜¯å¦è¿é€šï¼Ÿâ€ç­‰ä»·äºâ€œä¸¤ä¸ªç»™å®šçš„é¡¶ç‚¹ä¹‹é—´æ˜¯å¦å­˜åœ¨ä¸€æ¡è·¯å¾„ï¼Ÿâ€</li><li><strong>å•ç‚¹è·¯å¾„</strong>ï¼šç»™å®šä¸€å¹…å›¾å’Œä¸€ä¸ªèµ·ç‚¹ sï¼Œå›ç­”â€œä» s åˆ°ç»™å®šç›®çš„é¡¶ç‚¹ v æ˜¯å¦å­˜åœ¨ä¸€æ¡è·¯å¾„ï¼Ÿå¦‚æœæœ‰ï¼Œæ‰¾å‡ºè¿™æ¡è·¯å¾„ã€‚â€ç­‰ç±»ä¼¼é—®é¢˜ã€‚</li></ul><p>æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ä¹‹æ‰€ä»¥æä¸ºç®€å•ï¼Œæ˜¯å› ä¸ºå®ƒæ‰€åŸºäºçš„æ¦‚å¿µä¸ºäººæ‰€ç†ŸçŸ¥å¹¶ä¸”éå¸¸å®¹æ˜“å®ç°ã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªæ—¢å°å·§è€Œåˆå¼ºå¤§çš„ç®—æ³•ï¼Œç ”ç©¶äººå‘˜ç”¨å®ƒè§£å†³äº†æ— æ•°å›°éš¾çš„é—®é¢˜ã€‚ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜åªæ˜¯æˆ‘ä»¬å°†è¦ç ”ç©¶çš„è®¸å¤šé—®é¢˜çš„å¼€å§‹ã€‚</p><h3 id="3-5-ç®—æ³•é¢˜"><a href="#3-5-ç®—æ³•é¢˜" class="headerlink" title="3.5 ç®—æ³•é¢˜"></a>3.5 ç®—æ³•é¢˜</h3><p>å‰‘æŒ‡ç¬¬12é¢˜-çŸ©é˜µä¸­çš„è·¯å¾„ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çŸ©é˜µä¸­çš„è·¯å¾„</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * è¯·è®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åˆ¤æ–­åœ¨ä¸€ä¸ªçŸ©é˜µä¸­æ˜¯å¦å­˜åœ¨ä¸€æ¡åŒ…å«æŸå­—ç¬¦ä¸²æ‰€æœ‰å­—ç¬¦çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="comment"> * è·¯å¾„å¯ä»¥ä»çŸ©é˜µä¸­çš„ä»»æ„ä¸€æ ¼å¼€å§‹ï¼Œæ¯ä¸€æ­¥å¯ä»¥åœ¨çŸ©é˜µä¸­å‘å·¦ã€å³ã€ä¸Šã€ä¸‹ç§»åŠ¨ä¸€æ ¼ã€‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸€æ¡è·¯å¾„ç»è¿‡äº†çŸ©é˜µçš„æŸä¸€æ ¼ï¼Œé‚£ä¹ˆè¯¥è·¯å¾„ä¸èƒ½å†æ¬¡è¿›å…¥è¯¥æ ¼å­ã€‚</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„3Ã—4çš„çŸ©é˜µä¸­åŒ…å«ä¸€æ¡å­—ç¬¦ä¸²â€œbfceâ€çš„è·¯å¾„ï¼ˆè·¯å¾„ä¸­çš„å­—æ¯ç”¨åŠ ç²—æ ‡å‡ºï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * [[&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;e&quot;],</span></span><br><span class="line"><span class="comment"> * [&quot;s&quot;,&quot;f&quot;,&quot;c&quot;,&quot;s&quot;],</span></span><br><span class="line"><span class="comment"> * [&quot;a&quot;,&quot;d&quot;,&quot;e&quot;,&quot;e&quot;]]</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * ä½†çŸ©é˜µä¸­ä¸åŒ…å«å­—ç¬¦ä¸²â€œabfbâ€çš„è·¯å¾„ï¼Œå› ä¸ºå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦bå æ®äº†çŸ©é˜µä¸­çš„ç¬¬ä¸€è¡Œç¬¬äºŒä¸ªæ ¼å­ä¹‹åï¼Œè·¯å¾„ä¸èƒ½å†æ¬¡è¿›å…¥è¿™ä¸ªæ ¼å­ã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 1ï¼š</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * è¾“å…¥ï¼šboard = [[&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;E&quot;],[&quot;S&quot;,&quot;F&quot;,&quot;C&quot;,&quot;S&quot;],[&quot;A&quot;,&quot;D&quot;,&quot;E&quot;,&quot;E&quot;]], word = &quot;ABCCED&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºï¼štrue</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 2ï¼š</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * è¾“å…¥ï¼šboard = [[&quot;a&quot;,&quot;b&quot;],[&quot;c&quot;,&quot;d&quot;]], word = &quot;abcd&quot;</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºï¼šfalse</span></span><br><span class="line"><span class="comment"> * æç¤ºï¼š</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 1 &lt;= board.length &lt;= 200</span></span><br><span class="line"><span class="comment"> * 1 &lt;= board[i].length &lt;= 200</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Related Topics</span></span><br><span class="line"><span class="comment"> * æ·±åº¦ä¼˜å…ˆæœç´¢</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jz12Exist</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[][] board = &#123;</span><br><span class="line">                &#123;<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;E&#x27;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;S&#x27;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;E&#x27;</span>&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        String word = <span class="string">&quot;ABCCED&quot;</span>;</span><br><span class="line">        System.out.println(exist(board, word));</span><br><span class="line">        <span class="keyword">char</span>[][] board1 = &#123;&#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>&#125;, &#123;<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>&#125;&#125;;</span><br><span class="line">        String word1 = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">        System.out.println(exist(board1, word1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´å¤æ‚åº¦ O(3^K * M * N) ï¼š</span></span><br><span class="line"><span class="comment">     *      æœ€å·®æƒ…å†µä¸‹ï¼Œéœ€è¦éå†çŸ©é˜µä¸­é•¿åº¦ä¸º K å­—ç¬¦ä¸²çš„æ‰€æœ‰æ–¹æ¡ˆï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(3^K)ï¼›</span></span><br><span class="line"><span class="comment">     *      çŸ©é˜µä¸­å…±æœ‰ MN ä¸ªèµ·ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(MN) ã€‚</span></span><br><span class="line"><span class="comment">     *      æ–¹æ¡ˆæ•°è®¡ç®—ï¼š è®¾å­—ç¬¦ä¸²é•¿åº¦ä¸º K ï¼Œæœç´¢ä¸­æ¯ä¸ªå­—ç¬¦æœ‰ä¸Šã€ä¸‹ã€å·¦ã€å³å››ä¸ªæ–¹å‘å¯ä»¥é€‰æ‹©ï¼Œèˆå¼ƒå›å¤´ï¼ˆä¸Šä¸ªå­—ç¬¦ï¼‰çš„æ–¹å‘ï¼Œå‰©ä¸‹ 3 ç§é€‰æ‹©ï¼Œå› æ­¤æ–¹æ¡ˆæ•°çš„å¤æ‚åº¦ä¸º O(3^K) ã€‚</span></span><br><span class="line"><span class="comment">     * ç©ºé—´å¤æ‚åº¦ O(K) ï¼š</span></span><br><span class="line"><span class="comment">     *      æœç´¢è¿‡ç¨‹ä¸­çš„é€’å½’æ·±åº¦ä¸è¶…è¿‡ K ï¼Œå› æ­¤ç³»ç»Ÿå› å‡½æ•°è°ƒç”¨ç´¯è®¡ä½¿ç”¨çš„æ ˆç©ºé—´å ç”¨ O(K)</span></span><br><span class="line"><span class="comment">     *      ï¼ˆå› ä¸ºå‡½æ•°è¿”å›åï¼Œç³»ç»Ÿè°ƒç”¨çš„æ ˆç©ºé—´ä¼šé‡Šæ”¾ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">     *      æœ€åæƒ…å†µä¸‹ K = MN ï¼Œé€’å½’æ·±åº¦ä¸º MN ï¼Œæ­¤æ—¶ç³»ç»Ÿæ ˆä½¿ç”¨ O(MN) çš„é¢å¤–ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">exist</span><span class="params">(<span class="keyword">char</span>[][] board, String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] words = word.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; board.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; board[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dfs(board, words, i, j, <span class="number">0</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·±åº¦ä¼˜å…ˆæœç´¢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> board äºŒç»´çŸ©é˜µ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word å•è¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i æ¨ªåæ ‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> j çºµåæ ‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k å•è¯åæ ‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦å‘½ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">dfs</span><span class="params">(<span class="keyword">char</span>[][] board, <span class="keyword">char</span>[] word, <span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æœªå‘½ä¸­ï¼šæ¨ªçºµåæ ‡è¶Šç•Œï¼ŒçŸ©é˜µå¯¹åº”ä½ç½®å…ƒç´ ä¸ç­‰äºå•è¯å¯¹åº”ä½ç½®å…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= board.length || i &lt; <span class="number">0</span> || j &gt;= board[<span class="number">0</span>].length || j &lt; <span class="number">0</span> || board[i][j] != word[k]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å•è¯éå†ç»“æŸï¼Œå…¨éƒ¨å‘½ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (k == word.length - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ‡è®°è¡¨ç¤ºå·²è®¿é—®è¿‡</span></span><br><span class="line">        board[i][j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="comment">// é€’å½’è®¿é—®ç›¸é‚»çŸ©é˜µå…ƒç´ </span></span><br><span class="line">        <span class="keyword">boolean</span> res = dfs(board, word, i + <span class="number">1</span>, j, k + <span class="number">1</span>) || dfs(board, word, i - <span class="number">1</span>, j, k + <span class="number">1</span>) ||</span><br><span class="line">                dfs(board, word, i, j + <span class="number">1</span>, k + <span class="number">1</span>) || dfs(board, word, i, j - <span class="number">1</span>, k + <span class="number">1</span>);</span><br><span class="line">        board[i][j] = word[k];</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰‘æŒ‡ç¬¬13é¢˜-æœºå™¨äººçš„è¿åŠ¨èŒƒå›´ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ°ä¸Šæœ‰ä¸€ä¸ªmè¡Œnåˆ—çš„æ–¹æ ¼ï¼Œä»åæ ‡ [0,0] åˆ°åæ ‡ [m-1,n-1] ã€‚</span></span><br><span class="line"><span class="comment"> * ä¸€ä¸ªæœºå™¨äººä»åæ ‡ [0, 0] çš„æ ¼å­å¼€å§‹ç§»åŠ¨ï¼Œå®ƒæ¯æ¬¡å¯ä»¥å‘å·¦ã€å³ã€ä¸Šã€ä¸‹ç§»åŠ¨ä¸€æ ¼ï¼ˆä¸èƒ½ç§»åŠ¨åˆ°æ–¹æ ¼å¤–ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * ä¹Ÿä¸èƒ½è¿›å…¥è¡Œåæ ‡å’Œåˆ—åæ ‡çš„æ•°ä½ä¹‹å’Œå¤§äºkçš„æ ¼å­ã€‚</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œå½“kä¸º18æ—¶ï¼Œæœºå™¨äººèƒ½å¤Ÿè¿›å…¥æ–¹æ ¼ [35, 37] ï¼Œå› ä¸º3+5+3+7=18ã€‚</span></span><br><span class="line"><span class="comment"> * ä½†å®ƒä¸èƒ½è¿›å…¥æ–¹æ ¼ [35, 38]ï¼Œå› ä¸º3+5+3+8=19ã€‚è¯·é—®è¯¥æœºå™¨äººèƒ½å¤Ÿåˆ°è¾¾å¤šå°‘ä¸ªæ ¼å­ï¼Ÿ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 1ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥ï¼šm = 2, n = 3, k = 1</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºï¼š3</span></span><br><span class="line"><span class="comment"> * ç¤ºä¾‹ 2ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¾“å…¥ï¼šm = 3, n = 1, k = 0</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºï¼š1</span></span><br><span class="line"><span class="comment"> * æç¤ºï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1 &lt;= n,m &lt;= 100</span></span><br><span class="line"><span class="comment"> * 0 &lt;= k &lt;= 20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jz13MovingCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = <span class="number">2</span>, n = <span class="number">3</span>, k = <span class="number">1</span>;</span><br><span class="line">        System.out.println(movingCount(m, n , k));</span><br><span class="line">        m = <span class="number">3</span>;</span><br><span class="line">        n = <span class="number">1</span>;</span><br><span class="line">        k = <span class="number">0</span>;</span><br><span class="line">        System.out.println(movingCount(m, n , k));</span><br><span class="line">        m = <span class="number">16</span>;</span><br><span class="line">        n = <span class="number">8</span>;</span><br><span class="line">        k = <span class="number">4</span>;</span><br><span class="line">        System.out.println(movingCount(m, n , k));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·±åº¦ä¼˜å…ˆæœç´¢</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ—¶é—´å¤æ‚åº¦ï¼šO(mn)ï¼Œå…¶ä¸­ m ä¸ºæ–¹æ ¼çš„è¡Œæ•°ï¼Œ n ä¸ºæ–¹æ ¼çš„åˆ—æ•°ã€‚</span></span><br><span class="line"><span class="comment">     * ä¸€å…±æœ‰ O(mn) ä¸ªçŠ¶æ€éœ€è¦è®¡ç®—ï¼Œæ¯ä¸ªçŠ¶æ€é€’æ¨è®¡ç®—çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œæ‰€ä»¥æ€»æ—¶é—´å¤æ‚åº¦ä¸º O(mn)ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ç©ºé—´å¤æ‚åº¦ï¼šO(mn)ï¼Œå…¶ä¸­ m ä¸ºæ–¹æ ¼çš„è¡Œæ•°ï¼Œn ä¸ºæ–¹æ ¼çš„åˆ—æ•°ã€‚æˆ‘ä»¬éœ€è¦ O(mn) å¤§å°çš„ç»“æ„æ¥è®°å½•æ¯ä¸ªä½ç½®æ˜¯å¦å¯è¾¾ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">movingCount</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span>[][] visited = <span class="keyword">new</span> <span class="keyword">boolean</span>[m][n];</span><br><span class="line">        <span class="keyword">return</span> dfs(<span class="number">0</span>, <span class="number">0</span>, m, n, k, visited);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j, <span class="keyword">int</span> m, <span class="keyword">int</span> n, <span class="keyword">int</span> k, <span class="keyword">boolean</span>[][] visited)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(i &gt;= m || j &gt;= n || k &lt; getSum(i) + getSum(j) || visited[i][j]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        visited[i][j] = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + dfs(i + <span class="number">1</span>, j, m, n, k, visited) + dfs(i, j + <span class="number">1</span>, m, n, k, visited);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = a % <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> tmp = a / <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span>(tmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            sum += tmp % <span class="number">10</span>;</span><br><span class="line">            tmp /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››-å¯»æ‰¾è·¯å¾„"><a href="#å››-å¯»æ‰¾è·¯å¾„" class="headerlink" title="å››. å¯»æ‰¾è·¯å¾„"></a>å››. å¯»æ‰¾è·¯å¾„</h2><h3 id="4-1-è·¯å¾„API"><a href="#4-1-è·¯å¾„API" class="headerlink" title="4.1 è·¯å¾„API"></a>4.1 è·¯å¾„API</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010107.png"></p><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Graph G = <span class="keyword">new</span> Graph(<span class="keyword">new</span> In(args[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">int</span> s = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">    Paths search = <span class="keyword">new</span> Paths(G, s);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> v = <span class="number">0</span>; v &lt; G.V(); v++) &#123;</span><br><span class="line">        StdOut.print(s + <span class="string">&quot; to &quot;</span> + v + <span class="string">&quot;: &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (search.hasPathTo(v))</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x : search.pathTo(v))</span><br><span class="line">                <span class="keyword">if</span> (x == s) StdOut.print(x);</span><br><span class="line">                <span class="keyword">else</span> StdOut.print(<span class="string">&quot;-&quot;</span> + x);</span><br><span class="line">        StdOut.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-å®ç°"><a href="#4-2-å®ç°" class="headerlink" title="4.2 å®ç°"></a>4.2 å®ç°</h3><p>DepthFirstPathsä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢æŸ¥æ‰¾å›¾ä¸­çš„è·¯å¾„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢æŸ¥æ‰¾å›¾ä¸­çš„è·¯å¾„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepthFirstPaths</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨æ­¤é¡¶ç‚¹ä¸Šæ˜¯å¦è°ƒç”¨è¿‡ dfs()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] marked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»èµ·ç‚¹åˆ°ä¸€ä¸ªé¡¶ç‚¹çš„å·²çŸ¥è·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªé¡¶ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] edgeTo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ·ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ G ä¸­æ‰¾å‡ºæ‰€æœ‰èµ·ç‚¹ä¸º s çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DepthFirstPaths</span><span class="params">(Graph G, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        edgeTo = <span class="keyword">new</span> <span class="keyword">int</span>[G.V()];</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">        dfs(G, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(Graph G, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        marked[v] = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> w : G.adj(v)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!marked[w]) &#123;</span><br><span class="line">                edgeTo[w] = v;</span><br><span class="line">                dfs(G, w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦å­˜åœ¨ä» s åˆ° v çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPathTo</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> marked[v];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * s åˆ° v çš„è·¯å¾„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Integer&gt; <span class="title">pathTo</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasPathTo(v)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Stack&lt;Integer&gt; path = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = v; x != s; x = edgeTo[x]) &#123;</span><br><span class="line">            path.push(x);</span><br><span class="line">        &#125;</span><br><span class="line">        path.push(s);</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®—è½¨è¿¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010109.png"></p><p>ä¸ºäº†ä¿å­˜åˆ°è¾¾æ¯ä¸ªé¡¶ç‚¹çš„å·²çŸ¥è·¯å¾„ï¼Œè¿™æ®µä»£ç ä½¿ç”¨äº†ä¸€ä¸ªä»¥é¡¶ç‚¹ç¼–å·ä¸ºç´¢å¼•çš„æ•°ç»„ edgeTo[]ï¼ŒedgeTo[w]=v è¡¨ç¤º v-w æ˜¯ç¬¬ä¸€æ¬¡è®¿é—® w æ—¶ç»è¿‡çš„è¾¹ã€‚edgeTo[] æ•°ç»„æ˜¯ä¸€æ£µç”¨çˆ¶é“¾æ¥è¡¨ç¤ºçš„ä»¥ s ä¸ºæ ¹ä¸”å«æœ‰æ‰€æœ‰ä¸ s è¿é€šçš„é¡¶ç‚¹çš„æ ‘ã€‚</p><p>ä¸‹å›¾æ˜¾ç¤ºçš„æ˜¯ç¤ºä¾‹ä¸­æ¯ä¸ªé¡¶ç‚¹è¢«æ ‡è®°å edgeTo[] çš„å†…å®¹ï¼Œèµ·ç‚¹ä¸ºé¡¶ç‚¹ 0ã€‚marked[] å’Œ adj[] çš„å†…å®¹ä¸  DepthFirstSearch çš„è½¨è¿¹ç›¸åŒï¼Œé€’å½’è°ƒç”¨å’Œè¾¹æ£€æŸ¥çš„è¯¦ç»†æè¿°ä¹Ÿå®Œå…¨ä¸€æ ·ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ·±åº¦ä¼˜å…ˆæœç´¢å‘ edgeTo[] æ•°ç»„ä¸­é¡ºåºæ·»åŠ äº† 0-2ã€2-1ã€2-3ã€3-5 å’Œ 3-4ã€‚è¿™äº›è¾¹æ„æˆäº†ä¸€æ£µä»¥èµ·ç‚¹ä¸ºæ ¹ç»“ç‚¹çš„æ ‘å¹¶æä¾›äº† pathTo() æ–¹æ³•æ‰€éœ€çš„ä¿¡æ¯ï¼Œä½¿å¾—è°ƒç”¨è€…å¯ä»¥æŒ‰ç…§å‰æ–‡æ‰€è¿°çš„æ–¹æ³•æ‰¾åˆ°ä» 0 åˆ°é¡¶ç‚¹ 1ã€2ã€3ã€4ã€5 çš„è·¯å¾„ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210301/202103010110.png"></p><h2 id="äº”-å¹¿åº¦ä¼˜å…ˆæœç´¢"><a href="#äº”-å¹¿åº¦ä¼˜å…ˆæœç´¢" class="headerlink" title="äº”. å¹¿åº¦ä¼˜å…ˆæœç´¢"></a>äº”. å¹¿åº¦ä¼˜å…ˆæœç´¢</h2><h3 id="5-1-ä»€ä¹ˆæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ"><a href="#5-1-ä»€ä¹ˆæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ" class="headerlink" title="5.1 ä»€ä¹ˆæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ"></a>5.1 ä»€ä¹ˆæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Ÿ</h3><p>å¹¿åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ï¼ˆBreadth-First Searchï¼ŒBFSï¼‰</p><p>å•ç‚¹æœ€çŸ­è·¯å¾„ã€‚ç»™å®šä¸€å¹…å›¾å’Œä¸€ä¸ªèµ·ç‚¹ sï¼Œå›ç­”â€œä» s åˆ°ç»™å®šç›®çš„é¡¶ç‚¹ v æ˜¯å¦å­˜åœ¨ä¸€æ¡è·¯å¾„ï¼Ÿå¦‚æœæœ‰ï¼Œæ‰¾å‡ºå…¶ä¸­æœ€çŸ­çš„é‚£æ¡ï¼ˆæ‰€å«è¾¹æ•°æœ€å°‘ï¼‰ã€‚â€ç­‰ç±»ä¼¼é—®é¢˜ã€‚</p><p>è§£å†³è¿™ä¸ªé—®é¢˜çš„ç»å…¸æ–¹æ³•å«åšå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆBFS)ã€‚æ·±åº¦ä¼˜å…ˆæœç´¢åœ¨è¿™ä¸ªé—®é¢˜ä¸Šæ²¡æœ‰ä»€ä¹ˆä½œä¸ºï¼Œå› ä¸ºå®ƒéå†æ•´ä¸ªå›¾çš„é¡ºåºå’Œæ‰¾å‡ºæœ€çŸ­è·¯å¾„çš„ç›®æ ‡æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¹¿åº¦ä¼˜å…ˆæœç´¢æ­£æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡æ‰å‡ºç°çš„ã€‚</p><p>è¦æ‰¾åˆ°ä» s åˆ° v çš„æœ€çŸ­è·¯å¾„ï¼Œä» s å¼€å§‹ï¼Œåœ¨æ‰€æœ‰ç”±ä¸€æ¡è¾¹å°±å¯ä»¥åˆ°è¾¾çš„é¡¶ç‚¹ä¸­å¯»æ‰¾ vï¼Œå¦‚æœæ‰¾ä¸åˆ°æˆ‘ä»¬å°±ç»§ç»­åœ¨ä¸ s è·ç¦»ä¸¤æ¡è¾¹çš„æ‰€æœ‰é¡¶ç‚¹ä¸­æŸ¥æ‰¾vï¼Œå¦‚æ­¤ä¸€ç›´è¿›è¡Œã€‚æ·±åº¦ä¼˜å…ˆæœç´¢å°±å¥½åƒæ˜¯ä¸€ä¸ªäººåœ¨èµ°è¿·å®«ï¼Œå¹¿åº¦ä¼˜å…ˆæœç´¢åˆ™å¥½åƒæ˜¯ä¸€ç»„äººåœ¨ä¸€èµ·æœå„ä¸ªæ–¹å‘èµ°è¿™åº§è¿·å®«ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç»³å­ã€‚å½“å‡ºç°æ–°çš„å‰è·¯æ—¶ï¼Œå¯ä»¥å‡è®¾ä¸€ä¸ªæ¢ç´¢è€…å¯ä»¥åˆ†è£‚ä¸ºæ›´å¤šçš„äººæ¥æœç´¢å®ƒä»¬ï¼Œå½“ä¸¤ä¸ªæ¢ç´¢è€…ç›¸é‡æ—¶ï¼Œä¼šåˆäºŒä¸ºä¸€ï¼ˆå¹¶ç»§ç»­ä½¿ç”¨å…ˆåˆ°è¾¾è€…çš„ç»³å­ï¼‰ï¼Œå‚è§ä¸‹å›¾-å¹¿åº¦ä¼˜å…ˆçš„è¿·å®«æœç´¢ã€‚</p><p><img src="C:\Users\hspcadmin\Desktop\æ–‡æ¡£\202104120101.png"></p><h3 id="5-2-ç®—æ³•æè¿°"><a href="#5-2-ç®—æ³•æè¿°" class="headerlink" title="5.2 ç®—æ³•æè¿°"></a>5.2 ç®—æ³•æè¿°</h3><p>åœ¨æ·±åº¦ä¼˜å…ˆæœç´¢ä¸­ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ªå¯ä»¥ä¸‹å‹çš„æ ˆï¼ˆè¿™æ˜¯ç”±ç³»ç»Ÿç®¡ç†çš„ï¼Œä»¥æ”¯æŒé€’å½’æœç´¢æ–¹æ³•ï¼‰ã€‚ä½¿ç”¨ LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰çš„è§„åˆ™æ¥æè¿°å‹æ ˆå’Œèµ°è¿·å®«æ—¶å…ˆæ¢ç´¢ç›¸é‚»çš„é€šé“ç±»ä¼¼ã€‚ä»æœ‰å¾…æœç´¢çš„é€šé“ä¸­é€‰æ‹©æœ€æ™šé‡åˆ°è¿‡çš„é‚£æ¡ã€‚åœ¨å¹¿åº¦ä¼˜å…ˆæœç´¢ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æŒ‰ç…§ä¸èµ·ç‚¹çš„è·ç¦»çš„é¡ºåºæ¥éå†æ‰€æœ‰é¡¶ç‚¹ï¼Œçœ‹èµ·æ¥è¿™ç§é¡ºåºå¾ˆå®¹æ˜“å®ç°ï¼šä½¿ç”¨ï¼ˆFIFOï¼Œå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—æ¥ä»£æ›¿æ ˆï¼ˆLIFOï¼Œåè¿›å…ˆå‡ºï¼‰å³å¯ã€‚æˆ‘ä»¬å°†ä»æœ‰å¾…æœç´¢çš„é€šé“ä¸­é€‰æ‹©æœ€æ—©é‡åˆ°çš„é‚£æ¡ã€‚</p><p>ç®—æ³• 4.2 å®ç°äº†å¹¿åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰å·²ç»è¢«æ ‡è®°è¿‡ä½†å…¶é‚»æ¥è¡¨è¿˜æœªè¢«æ£€æŸ¥è¿‡çš„é¡¶ç‚¹ã€‚å…ˆå°†èµ·ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åé‡å¤ä»¥ä¸‹æ­¥éª¤ç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºï¼š</p><ul><li>å–é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªé¡¶ç‚¹ v å¹¶æ ‡è®°å®ƒï¼›</li><li>å°†ä¸ v ç›¸é‚»çš„æ‰€æœ‰æœªè¢«æ ‡è®°è¿‡çš„é¡¶ç‚¹åŠ å…¥é˜Ÿåˆ—ã€‚</li></ul><p><img src="C:\Users\hspcadmin\Desktop\æ–‡æ¡£\202104120102.png"></p><p>æ­¥éª¤ï¼š</p><p><img src="C:\Users\hspcadmin\Desktop\æ–‡æ¡£\202104120103.png"></p><ul><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 0 å¹¶å°†å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 2ã€1 å’Œ 5 åŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œæ ‡è®°å®ƒä»¬å¹¶åˆ†åˆ«å°†å®ƒä»¬åœ¨ <code>edgeTo[]</code> ä¸­çš„å€¼è®¾ä¸º 0ã€‚</li><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 2 å¹¶æ£€æŸ¥å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 0 å’Œ 1ï¼Œå‘ç°ä¸¤è€…éƒ½å·²ç»è¢«æ ‡è®°ã€‚å°†ç›¸é‚»çš„é¡¶ç‚¹ 3 å’Œ 4 åŠ å…¥é˜Ÿåˆ—ï¼Œæ ‡è®°å®ƒä»¬å¹¶åˆ†åˆ«å°†å®ƒä»¬åœ¨ <code>edgeTo[]</code> ä¸­çš„å€¼è®¾ä¸º 2ã€‚</li><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 1 å¹¶æ£€æŸ¥å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 0 å’Œ 2ï¼Œå‘ç°å®ƒä»¬éƒ½å·²ç»è¢«æ ‡è®°äº†ã€‚</li><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 5 å¹¶æ£€æŸ¥å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 3 å’Œ 0ï¼Œå‘ç°å®ƒä»¬éƒ½å·²ç»è¢«æ ‡è®°äº†ã€‚</li><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 3 å¹¶æ£€æŸ¥å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 5ã€4 å’Œ 2ï¼Œå‘ç°å®ƒä»¬éƒ½å·²ç»è¢«æ ‡è®°äº†ã€‚</li><li>ä»é˜Ÿåˆ—ä¸­åˆ å»é¡¶ç‚¹ 4 å¹¶æ£€æŸ¥å®ƒçš„ç›¸é‚»é¡¶ç‚¹ 3 å’Œ 2ï¼Œå‘ç°å®ƒä»¬éƒ½å·²ç»è¢«æ ‡è®°äº†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å¹¿åº¦ä¼˜å…ˆæœç´¢æŸ¥æ‰¾å›¾ä¸­çš„è·¯å¾„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BreadthFirstPaths</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ°è¾¾è¯¥é¡¶ç‚¹çš„æœ€çŸ­è·¯å¾„æ˜¯å¦å·²çŸ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>[] marked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ°è¾¾è¯¥é¡¶ç‚¹çš„å·²çŸ¥è·¯å¾„ä¸Šçš„æœ€åä¸€ä¸ªé¡¶ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] edgeTo;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ·ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BreadthFirstPaths</span><span class="params">(Graph G, <span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        marked = <span class="keyword">new</span> <span class="keyword">boolean</span>[G.V()];</span><br><span class="line">        edgeTo = <span class="keyword">new</span> <span class="keyword">int</span>[G.V()];</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">        bfs(G, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bfs</span><span class="params">(Graph G, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">        Queue&lt;Integer&gt; queue = <span class="keyword">new</span> Queue&lt;&gt;();</span><br><span class="line">        <span class="comment">// æ ‡è®°èµ·ç‚¹</span></span><br><span class="line">        marked[s] = <span class="keyword">true</span>; </span><br><span class="line">        <span class="comment">// å°†å®ƒåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">        queue.enqueue(s); </span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// ä»é˜Ÿåˆ—ä¸­åˆ å»ä¸‹ä¸€é¡¶ç‚¹</span></span><br><span class="line">            <span class="keyword">int</span> v = queue.dequeue(); </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> w : G.adj(v)) &#123;</span><br><span class="line">                <span class="comment">// å¯¹äºæ¯ä¸ªæœªè¢«æ ‡è®°çš„ç›¸é‚»é¡¶ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (!marked[w]) &#123;</span><br><span class="line">                    <span class="comment">// ä¿å­˜æœ€çŸ­è·¯å¾„çš„æœ€åä¸€æ¡è¾¹</span></span><br><span class="line">                    edgeTo[w] = v; </span><br><span class="line">                    <span class="comment">// æ ‡è®°å®ƒï¼Œå› ä¸ºæœ€çŸ­è·¯å¾„å·²çŸ¥</span></span><br><span class="line">                    marked[w] = <span class="keyword">true</span>; </span><br><span class="line">                    <span class="comment">// å¹¶å°†å®ƒæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">                    queue.enqueue(w); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPathTo</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123; <span class="keyword">return</span> marked[v]; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Integer&gt; <span class="title">pathTo</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasPathTo(v)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Stack&lt;Integer&gt; path = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = v; x != s; x = edgeTo[x]) &#123;</span><br><span class="line">            path.push(x);</span><br><span class="line">        &#125;</span><br><span class="line">        path.push(s);</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-ä½¿ç”¨åœºæ™¯"><a href="#5-3-ä½¿ç”¨åœºæ™¯" class="headerlink" title="5.3 ä½¿ç”¨åœºæ™¯"></a>5.3 ä½¿ç”¨åœºæ™¯</h3><h2 id="å…­-è¿é€šåˆ†é‡"><a href="#å…­-è¿é€šåˆ†é‡" class="headerlink" title="å…­. è¿é€šåˆ†é‡"></a>å…­. è¿é€šåˆ†é‡</h2><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šç®—æ³•-ç¬¬4ç‰ˆã€‹</p>]]></content>
    
    
    <summary type="html">å†…å®¹ä¸»è¦æ¥è‡ªã€Šç®—æ³•-ç¬¬4ç‰ˆã€‹ï¼Œå†…å®¹åŒ…æ‹¬ï¼šå›¾ï¼Œæ— å‘å›¾ï¼Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œå¯»æ‰¾è·¯å¾„ï¼Œå¹¿åº¦ä¼˜å…ˆæœç´¢ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="algorithm" scheme="http://linyishui.top/tags/algorithm/"/>
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="graph" scheme="http://linyishui.top/tags/graph/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆå…­ï¼‰é«˜çº§ç‰¹æ€§</title>
    <link href="http://linyishui.top/2021020101.html"/>
    <id>http://linyishui.top/2021020101.html</id>
    <published>2021-02-01T13:16:33.000Z</published>
    <updated>2021-03-03T13:23:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆå…­ï¼‰é«˜çº§ç‰¹æ€§"><a href="#ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆå…­ï¼‰é«˜çº§ç‰¹æ€§" class="headerlink" title="ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆå…­ï¼‰é«˜çº§ç‰¹æ€§"></a>ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆå…­ï¼‰é«˜çº§ç‰¹æ€§</h1><h2 id="ä¸€-åˆ†åŒºè¡¨"><a href="#ä¸€-åˆ†åŒºè¡¨" class="headerlink" title="ä¸€. åˆ†åŒºè¡¨"></a>ä¸€. åˆ†åŒºè¡¨</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯åˆ†åŒºè¡¨ï¼Ÿ</h3><p>åˆ†åŒºè¡¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘è¡¨ï¼Œåº•å±‚ç”±å¤šä¸ªç‰©ç†å­è¡¨ç»„æˆã€‚ä¸€ç»„åº•å±‚è¡¨çš„å¥æŸ„å¯¹è±¡çš„å°è£…ï¼Œå¯¹åˆ†åŒºè¡¨çš„è¯·æ±‚é€šè¿‡å¥æŸ„å¯¹è±¡è½¬æ¢ä¸ºå¯¹å­˜å‚¨å¼•æ“çš„æ¥å£è°ƒç”¨ã€‚</p><p>MySQLç´¢å¼•æ ¹æ®åˆ†åŒºçš„å­è¡¨å®šä¹‰ï¼Œæ²¡æœ‰å…¨å±€ç´¢å¼•ï¼Œä¸èƒ½åƒOracleé‚£æ ·æŒ‡å®šç´¢å¼•å’Œè¡¨æ˜¯å¦åˆ†åŒºã€‚</p><p>åˆ›å»ºè¡¨æ—¶ä½¿ç”¨ PARTITION BY å­å¥å®šä¹‰æ¯ä¸ªåˆ†åŒºå­˜æ”¾çš„æ•°æ®ã€‚æ¯æ¬¡æŸ¥è¯¢æ—¶ä¼˜åŒ–å™¨æ ¹æ®åˆ†åŒºå®šä¹‰è¿‡æ»¤æ‰å…¶å®ƒåˆ†åŒºï¼Œä½¿æŸ¥è¯¢åªé¡»æ‰«æåŒ…å«æ•°æ®çš„åˆ†åŒºã€‚</p><h3 id="1-2-ä½¿ç”¨åœºæ™¯"><a href="#1-2-ä½¿ç”¨åœºæ™¯" class="headerlink" title="1.2 ä½¿ç”¨åœºæ™¯"></a>1.2 ä½¿ç”¨åœºæ™¯</h3><ul><li>æ— æ³•å…¨éƒ¨æ”¾å…¥å†…å­˜çš„å¤§è¡¨ï¼Œæˆ–æ˜¯å¤§éƒ¨åˆ†å†å²æ•°æ®ã€åªæœ‰å°‘é‡çƒ­ç‚¹æ•°æ®ã€‚</li><li>åˆ†åŒºè¡¨çš„æ•°æ®æ˜“äºç»´æŠ¤ï¼Œæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®å¯ä»¥ç›´æ¥æ¸…é™¤æ•´ä¸ªåˆ†åŒºï¼›è¿˜å¯ä»¥å¯¹ä¸€ä¸ªåˆ†åŒºè¿›è¡Œä¼˜åŒ–ã€æ£€æŸ¥ã€ä¿®å¤ç­‰æ“ä½œã€‚</li><li>åˆ†åŒºè¡¨çš„æ•°æ®å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†è®¾å¤‡ä¸Šã€‚</li><li>ä½¿ç”¨åˆ†åŒºè¡¨å¯ä»¥é¿å…ä¸€äº›ç‰¹æ®Šç“¶é¢ˆï¼Œå¦‚InnoDBçš„å•ä¸ªç´¢å¼•çš„äº’æ–¥è®¿é—®ã€ext3æ–‡ä»¶ç³»ç»Ÿçš„inodeé”ç«äº‰ç­‰ã€‚</li><li>å¯ä»¥å¤‡ä»½å’Œæ¢å¤ç‹¬ç«‹çš„åˆ†åŒºï¼Œåœ¨å¤§æ•°æ®é›†çš„åœºæ™¯æœ‰å¾ˆå¥½çš„æ•ˆæœã€‚</li></ul><h3 id="1-3-ä½¿ç”¨é™åˆ¶"><a href="#1-3-ä½¿ç”¨é™åˆ¶" class="headerlink" title="1.3 ä½¿ç”¨é™åˆ¶"></a>1.3 ä½¿ç”¨é™åˆ¶</h3><ul><li>ä¸€ä¸ªè¡¨æœ€å¤šæœ‰1024ä¸ªåˆ†åŒºã€‚</li><li>MySQL 5.1ä¸­åˆ†åŒºè¡¨è¾¾å¼å¿…é¡»è¿”å›æ•´æ•°ï¼ŒMySQL 5.5çš„æŸäº›åœºæ™¯å¯ä»¥ç›´æ¥ä½¿ç”¨åˆ—è¿›è¡Œåˆ†åŒºã€‚</li><li>è‹¥åˆ†åŒºå­—æ®µä¸­æœ‰ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•çš„åˆ—ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¸»é”®åˆ—å’Œå”¯ä¸€ç´¢å¼•åˆ—éƒ½å¿…é¡»åŒ…å«è¿›æ¥ã€‚</li><li>åˆ†åŒºè¡¨æ— æ³•ä½¿ç”¨å¤–é”®çº¦æŸã€‚</li></ul><h3 id="1-4-å®ç°åŸç†"><a href="#1-4-å®ç°åŸç†" class="headerlink" title="1.4 å®ç°åŸç†"></a>1.4 å®ç°åŸç†</h3><p>åˆ†åŒºè¡¨ç”±å¤šä¸ªç›¸å…³åº•å±‚è¡¨å®ç°ï¼Œåº•å±‚è¡¨ç”±å¥æŸ„å¯¹è±¡è¡¨ç¤ºï¼Œå­˜å‚¨å¼•æ“ç®¡ç†åˆ†åŒºçš„å„ä¸ªåº•å±‚è¡¨ä¸æ™®é€šè¡¨ç›¸åŒï¼Œåˆ†åŒºè¡¨çš„ç´¢å¼•åªæ˜¯åœ¨å„ä¸ªåº•å±‚è¡¨ä¸Šå„è‡ªåŠ ä¸Šä¸€ä¸ªå®Œå…¨ç›¸åŒçš„ç´¢å¼•ã€‚</p><p>å‡ ç§æ“ä½œçš„é€»è¾‘ï¼šè™½ç„¶éƒ½è¦é”ä½æ‰€æœ‰åº•å±‚è¡¨ï¼Œä½†å…¶å®åªæ˜¯è¡Œçº§é”</p><ul><li>SELECT æŸ¥è¯¢ï¼šæŸ¥è¯¢ä¸€ä¸ªåˆ†åŒºè¡¨æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨ï¼Œä¼˜åŒ–å™¨å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥è¿‡æ»¤éƒ¨åˆ†åˆ†åŒºï¼Œç„¶åè°ƒç”¨å¯¹åº”å­˜å‚¨å¼•æ“æ¥å£è®¿é—®å„ä¸ªåˆ†åŒºçš„æ•°æ®ã€‚</li><li>INSERT æ“ä½œï¼šå†™å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰çš„åº•å±‚è¡¨ï¼Œç„¶åç¡®å®šåœ¨å“ªä¸ªåˆ†åŒºæ¥æ”¶è¿™æ¡è®°å½•ï¼Œå¹¶æŠŠè®°å½•å†™å…¥åº•å±‚è¡¨ã€‚</li><li>DELETE æ“ä½œï¼šåˆ é™¤ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨ï¼Œç„¶åç¡®å®šæ•°æ®å¯¹åº”çš„åˆ†åŒºï¼Œæœ€åå¯¹ç›¸åº”åº•å±‚è¡¨è¿›è¡Œåˆ é™¤æ“ä½œã€‚</li><li>UPDATE æ“ä½œï¼šæ›´æ–°ä¸€æ¡è®°å½•æ—¶ï¼Œåˆ†åŒºå±‚å…ˆæ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨ï¼ŒMySQLè¦å…ˆç¡®å®šæ›´æ–°çš„è®°å½•åœ¨å“ªä¸ªåˆ†åŒºï¼Œç„¶åå–å‡ºæ•°æ®å¹¶æ›´æ–°ï¼Œå†åˆ¤æ–­æ›´æ–°åçš„æ•°æ®åº”è¯¥æ”¾åœ¨å“ªä¸ªåˆ†åŒºï¼Œæœ€åå¯¹åº•å±‚è¡¨è¿›è¡Œå†™å…¥æ“ä½œï¼Œå¹¶å¯¹åŸæ•°æ®æ‰€åœ¨åº•å±‚è¡¨è¿›è¡Œåˆ é™¤æ“ä½œã€‚</li></ul><h3 id="1-5-åˆ†åŒºè¡¨çš„ç±»å‹"><a href="#1-5-åˆ†åŒºè¡¨çš„ç±»å‹" class="headerlink" title="1.5 åˆ†åŒºè¡¨çš„ç±»å‹"></a>1.5 åˆ†åŒºè¡¨çš„ç±»å‹</h3><p>åˆ†åŒºè¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨å„ç§å‡½æ•°ï¼Œä½†è¿”å›å€¼ä¸€å®šè¦æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•´æ•°ï¼Œä¸”ä¸èƒ½æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼ˆæ¡ˆä¾‹ä½¿ç”¨YEARå‡½æ•°æ ¹æ®æ—¶é—´è¿›è¡Œåˆ†åŒºï¼‰ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sqles (</span><br><span class="line">order_date DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="comment">--other columns</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(<span class="keyword">YEAR</span>(order_date)) (</span><br><span class="line"><span class="keyword">PARTITION</span> p_2010 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2010</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p_2011 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2011</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p_2012 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2012</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p_catchall <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>MySQLæ”¯æŒé”®å€¼ã€å“ˆå¸Œå’Œåˆ—è¡¨åˆ†åŒºï¼Œä»¥åŠä½¿ç”¨ RANGE COLUMNS ç±»å‹çš„åˆ†åŒºã€‚</p><p>ç³»ç»Ÿé€šè¿‡å­åˆ†åŒºå¯é™ä½ç´¢å¼•çš„äº’æ–¥è®¿é—®ç«äº‰ã€‚æœ€è¿‘ä¸€å¹´çš„åˆ†åŒºæ•°æ®ä¼šè¢«é¢‘ç¹è®¿é—®ï¼Œå¯¼è‡´å¤§é‡çš„äº’æ–¥é‡çš„ç«äº‰ã€‚ä½¿ç”¨å“ˆå¸Œå­åˆ†åŒºå¯ä»¥å°†æ•°æ®åˆ‡æˆå¤šä¸ªå°ç‰‡ï¼Œå¤§å¤§é™ä½äº’æ–¥é‡çš„ç«äº‰é—®é¢˜ã€‚</p><h3 id="1-6-åˆç†ä½¿ç”¨åˆ†åŒºè¡¨"><a href="#1-6-åˆç†ä½¿ç”¨åˆ†åŒºè¡¨" class="headerlink" title="1.6 åˆç†ä½¿ç”¨åˆ†åŒºè¡¨"></a>1.6 åˆç†ä½¿ç”¨åˆ†åŒºè¡¨</h3><p>å‡è®¾ä¸€ä¸ªéœ€æ±‚ï¼šéœ€è¦ä»ä¸€ä¸ªå¤§è¡¨ä¸­æŸ¥å‡ºä¸€æ®µæ—¶é—´çš„è®°å½•ï¼Œè¡¨ä¸­åŒ…å«å¤šå¹´çš„å†å²æ•°æ®ï¼ŒæŒ‰ç…§æ—¶é—´æ’åºã€‚ä»…ä»…å‡ ä¸ªæœˆçš„æ•°æ®å¯èƒ½ä¼šæœ‰ä¸Šäº¿æˆ–åäº¿æ¡è®°å½•ã€‚</p><p>é¦–å…ˆä¸èƒ½æ¯æ¬¡æŸ¥è¯¢æ—¶æ‰«æå…¨è¡¨ï¼Œå¹¶ä¸”è€ƒè™‘ç´¢å¼•åœ¨ç©ºé—´å’Œç»´æŠ¤ä¸Šçš„æ¶ˆè€—ä¹Ÿä¸èƒ½ä½¿ç”¨ï¼ˆå¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„ç¢ç‰‡ï¼Œå¯¼è‡´ä¸€ä¸ªæŸ¥è¯¢æœ‰æˆåƒä¸Šä¸‡çš„éšæœºI/Oï¼‰ã€‚</p><p>åªèƒ½<strong>è®©æ‰€æœ‰çš„æŸ¥è¯¢åªåœ¨æ•°æ®è¡¨ä¸Šåšé¡ºåºæ‰«æ</strong>ï¼Œæˆ–è€…<strong>å°†æ•°æ®è¡¨å’Œç´¢å¼•éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­</strong>ã€‚</p><p><strong>æ•°æ®é‡å¤§æ—¶ï¼Œé™¤éæ˜¯ç´¢å¼•è¦†ç›–æŸ¥è¯¢ï¼Œå¦åˆ™B-Treeç´¢å¼•æ— æ³•èµ·ä½œç”¨äº†ï¼Œæ•°æ®åº“æœåŠ¡å™¨éœ€è¦æ ¹æ®ç´¢å¼•æ‰«æçš„ç»“æœå›è¡¨ï¼ŒæŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œè‹¥æ•°æ®é‡å·¨å¤§ï¼Œè¿™å°†äº§ç”Ÿå¤§é‡éšæœºI/Oï¼Œå¯¼è‡´å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¹¶ä¸”ç´¢å¼•çš„ç»´æŠ¤ä»£ä»·ä¹Ÿå¾ˆé«˜</strong>ã€‚</p><p>åˆ†åŒºå¯ä»¥çœ‹ä½œåˆå§‹å½¢æ€çš„ç´¢å¼•ï¼Œä»¥éå¸¸å°çš„ä»£ä»·å®šä½åˆ°æ•°æ®åœ¨å“ªä¸€ç‰‡åŒºåŸŸï¼Œåœ¨åŒºåŸŸå†…å¯ä»¥åšé¡ºåºæ‰«æã€å¯ä»¥å»ºç´¢å¼•ã€å¯ä»¥å°†æ•°æ®ç¼“å­˜åˆ°å†…å­˜ã€‚åˆ†åŒºæ— éœ€é¢å¤–çš„æ•°æ®ç»“æ„è®°å½•æ¯ä¸ªåˆ†åŒºæœ‰å“ªäº›æ•°æ®ï¼ˆå› ä¸ºä¸éœ€è¦ç²¾ç¡®å®šä½æ•°æ®ä½ç½®ï¼‰ã€‚</p><p>ä¿è¯å¤§æ•°æ®é‡å¯æ‰©å±•æ€§çš„ç­–ç•¥ï¼š</p><ul><li><strong>å…¨é‡æ‰«ææ•°æ®ï¼Œä¸è¦ä»»ä½•ç´¢å¼•</strong>ï¼šåªè¦èƒ½ç”¨WHEREæ¡ä»¶å°†éœ€è¦çš„æ•°æ®é™åˆ¶åœ¨å°‘æ•°åˆ†åŒºä¸­ï¼Œæ•ˆç‡æ˜¯å¾ˆé«˜çš„ï¼Œéœ€è¦ä¸€äº›ç®€å•è¿ç®—ä¿è¯å“åº”æ—¶é—´èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œæ­¤ç­–ç•¥é€‚ç”¨äºæ­£å¸¸æ–¹å¼è®¿é—®å¤§é‡æ•°æ®æ—¶ã€‚</li><li><strong>ç´¢å¼•æ•°æ®ï¼Œå¹¶åˆ†ç¦»çƒ­ç‚¹</strong>ï¼šå½“æ•°æ®æœ‰æ˜æ˜¾çš„çƒ­ç‚¹ï¼Œæ­¤å¤–çš„æ•°æ®å¾ˆå°‘ä¼šè¢«è®¿é—®åˆ°ï¼Œå¯ä»¥å°†è¿™éƒ¨åˆ†çƒ­ç‚¹æ•°æ®å•ç‹¬æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºï¼Œä»è€Œæœ‰æœºä¼šå…¨éƒ¨ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œä½¿æŸ¥è¯¢åªç”¨è®¿é—®ä¸€ä¸ªå¾ˆå°çš„åˆ†åŒºè¡¨ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„ä½¿ç”¨ç´¢å¼•å’Œç¼“å­˜ã€‚</li></ul><h3 id="1-7-å¸¸è§é—®é¢˜"><a href="#1-7-å¸¸è§é—®é¢˜" class="headerlink" title="1.7 å¸¸è§é—®é¢˜"></a>1.7 å¸¸è§é—®é¢˜</h3><p>ä¸Šè¿°ä¸¤ç§åˆ†åŒºç­–ç•¥éƒ½åŸºäºæŸ¥è¯¢èƒ½å¤Ÿè¿‡æ»¤åˆ°é¢å¤–åˆ†åŒºã€åˆ†åŒºæœ¬èº«å¹¶ä¸ä¼šå¸¦æ¥é¢å¤–çš„ä»£ä»·ï¼Œä½†åœ¨ä¸€äº›åœºæ™¯ä¸‹è¿™ä¸¤ç§å‡è®¾ä¼šæœ‰é—®é¢˜ï¼š</p><ul><li><strong>NULLå€¼ä½¿åˆ†åŒºè¿‡æ»¤æ— æ•ˆ</strong>ï¼š<ul><li>æ‰€æœ‰çš„NULLå€¼æˆ–éæ³•å€¼ä¼šè¢«å­˜æ”¾åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºï¼›æ‰€ä»¥å¦‚æŸ¥è¯¢ <code>WHERE order_date BETWEEN &#39;2012-01-01&#39; AND &#39;2012-01-31&#39;</code> ä¼šæ£€æŸ¥2012åˆ†åŒºå’Œç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œå› ä¸ºYEARå‡½æ•°åœ¨æ¥æ”¶éæ³•å€¼æ—¶å¯èƒ½ä¼šè¿”å›NULLã€‚</li><li>å½“ç¬¬ä¸€ä¸ªåˆ†åŒºç‰¹åˆ«å¤§æ—¶ï¼Œä»£ä»·ä¼šå¾ˆé«˜ï¼Œå°¤å…¶æ˜¯ç­–ç•¥<strong>å…¨é‡æ‰«ææ•°æ®ï¼Œä¸è¦ä»»ä½•ç´¢å¼•</strong>ï¼›ä¸ºäº†é¿å…æ­¤çŠ¶å†µï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸ç”¨çš„ç¬¬ä¸€åˆ†åŒºï¼Œé€šè¿‡ <code>PARTITION p_nulls VALUES LESS THAN(0)</code> æ¥åˆ›å»ºï¼Œè¿™æ ·å¦‚æœæ’å…¥çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„æƒ…å†µä¸‹ç¬¬ä¸€åˆ†åŒºæ˜¯ç©ºçš„ï¼Œå³ä½¿éœ€è¦æ£€æµ‹ç¬¬ä¸€åˆ†åŒºä¹Ÿä¸ä¼šæœ‰å¤ªé«˜ä»£ä»·ã€‚</li></ul></li><li><strong>åˆ†åŒºåˆ—å’Œç´¢å¼•åˆ—ä¸åŒ¹é…</strong>ï¼šäºŒè€…ä¸åŒ¹é…ä¼šå¯¼è‡´æŸ¥è¯¢æ— æ³•è¿›è¡Œåˆ†åŒºè¿‡æ»¤ï¼Œæ¯”å¦‚åœ¨åˆ—aä¸Šå®šä¹‰äº†ç´¢å¼•ï¼Œåœ¨åˆ—bä¸Šè¿›è¡Œåˆ†åŒºï¼Œè¿™æ ·æ¯ä¸ªåˆ†åŒºéƒ½æœ‰ç‹¬ç«‹çš„ç´¢å¼•ï¼Œæ‰€ä»¥æ‰«æåˆ—bä¸Šçš„ç´¢å¼•éœ€è¦æ‰«ææ¯ä¸ªåˆ†åŒºå¯¹åº”çš„ç´¢å¼•ï¼Œè™½ç„¶æ‰«æé€Ÿåº¦å¹¶ä¸æ˜¯ç‰¹åˆ«æ…¢ï¼Œä½†è¿˜æ˜¯åº”è¯¥å°½é‡é¿å…å»ºç«‹å’Œåˆ†åŒºåˆ—ä¸åŒ¹é…çš„ç´¢å¼•ï¼Œé™¤éæŸ¥è¯¢ä¸­è¿˜åŒæ—¶åŒ…å«äº†å¯ä»¥è¿‡æ»¤åˆ†åŒºçš„æ¡ä»¶ã€‚</li><li><strong>é€‰æ‹©åˆ†åŒºçš„æˆæœ¬å¯èƒ½å¾ˆé«˜</strong>ï¼šä¸åŒçš„åˆ†åŒºç±»å‹å®ç°æ–¹å¼ä¸åŒï¼Œæ€§èƒ½ä¹Ÿä¸åŒï¼›èŒƒå›´åˆ†åŒºåœ¨åˆ¤æ–­è®°å½•æ•°æ®å±äºå“ªä¸€åˆ†åŒºçš„æˆæœ¬å¾ˆé«˜ï¼Œå› ä¸ºæœåŠ¡å™¨è¦æ‰«ææ‰€æœ‰çš„åˆ†åŒºå®šä¹‰çš„åˆ—è¡¨ï¼Œè¿™æ ·çš„çº¿æ€§æœç´¢ä¼šéšåˆ†åŒºæ•°å¢å¤šæˆæœ¬å˜é«˜ã€‚å¯¹äºé”®åˆ†åŒºæˆ–å“ˆå¸Œåˆ†åŒºåˆ™æ²¡æœ‰æ­¤é—®é¢˜ï¼Œ100ä¸ªå·¦å³çš„åˆ†åŒºæ•°ä¸ä¼šæœ‰é—®é¢˜ã€‚</li><li><strong>æ‰“å¼€å¹¶é”ä½æ‰€æœ‰åº•å±‚è¡¨çš„æˆæœ¬å¯èƒ½å¾ˆé«˜</strong>ï¼šæ­¤æ“ä½œå‘ç”Ÿäºåˆ†åŒºè¿‡æ»¤ä¹‹å‰ï¼Œæ— æ³•é€šè¿‡åˆ†åŒºè¿‡æ»¤é™ä½å¼€é”€ï¼Œå¯¹äºä¸€äº›æœ¬æ¥å¾ˆå¿«çš„æ“ä½œï¼Œå¦‚æ ¹æ®ä¸»é”®æŸ¥è¯¢å•è¡Œï¼Œä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼›å¯ä»¥é€šè¿‡æ‰¹é‡æ“ä½œçš„æ–¹å¼æ¥é™ä½å•ä¸ªå¼€é”€ï¼Œå¦‚æ‰¹é‡æ’å…¥æˆ– LOAD DATA INFILEã€ä¸€æ¬¡åˆ é™¤å¤šè¡Œæ•°æ®ç­‰ï¼ŒåŒæ—¶éœ€è¦é™åˆ¶åˆ†åŒºçš„ä¸ªæ•°ã€‚</li><li><strong>ç»´æŠ¤åˆ†åŒºçš„æˆæœ¬å¯èƒ½å¾ˆé«˜</strong>ï¼šæ–°å¢æˆ–åˆ é™¤åˆ†åŒºç­‰æ“ä½œå¾ˆå¿«ï¼ˆä¸åŒ…æ‹¬åˆ é™¤å¤§åˆ†åŒºï¼‰ï¼Œè€Œé‡ç»„åˆ†åŒºï¼ˆå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶åˆ†åŒºï¼Œç„¶åå°†æ•°æ®å¤åˆ¶åˆ°å…¶ä¸­ï¼Œæœ€ååˆ é™¤åŸåˆ†åŒºï¼‰æˆ–ç±»ä¼¼ALTERè¯­å¥çš„æ“ä½œéœ€è¦å¤åˆ¶æ•°æ®ã€‚</li></ul><p>ä½¿ç”¨åˆ†åŒºè¡¨çš„é™åˆ¶ï¼š</p><ul><li>æ‰€æœ‰åˆ†åŒºè¦ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ï¼›</li><li>åˆ†åŒºå¯ä»¥ä½¿ç”¨çš„å‡½æ•°æˆ–è¡¨è¾¾å¼å—é™ï¼›</li><li>ä¸€äº›å­˜å‚¨å¼•æ“ä¸æ”¯æŒåˆ†åŒºæˆ–æœ‰æ›´å¤šé™åˆ¶ï¼›</li></ul><h3 id="1-8-ä¼˜åŒ–æŸ¥è¯¢"><a href="#1-8-ä¼˜åŒ–æŸ¥è¯¢" class="headerlink" title="1.8 ä¼˜åŒ–æŸ¥è¯¢"></a>1.8 ä¼˜åŒ–æŸ¥è¯¢</h3><p>åˆ†åŒºè¿™ç§ç²—ç²’åº¦ç´¢å¼•å¯ä»¥è®©æŸ¥è¯¢æ‰«ææ›´å°‘çš„æ•°æ®ï¼Œå¯¹äºè®¿é—®åˆ†åŒºè¡¨æ¥è¯´ï¼Œé‡è¦çš„ä¸€ç‚¹æ˜¯WHEREæ¡ä»¶ä¸­åŠ å…¥åˆ†åŒºåˆ—ï¼Œå³ä½¿çœ‹èµ·æ¥å¾ˆå¤šä½™ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä½¿ä¼˜åŒ–å™¨è¿‡æ»¤æ‰æ— éœ€è®¿é—®çš„åˆ†åŒºã€‚</p><p>é€šè¿‡EXPLAIN PARTITIONè§‚å¯Ÿä¼˜åŒ–å™¨æ˜¯å¦æ‰§è¡Œäº†åˆ†åŒºè¿‡æ»¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯MySQLåªèƒ½åœ¨ä½¿ç”¨åˆ†åŒºå‡½æ•°çš„åˆ—æœ¬èº«è¿›è¡Œæ¯”è¾ƒæ—¶æ‰èƒ½è¿‡æ»¤åˆ†åŒºï¼Œè€Œä¸èƒ½æ ¹æ®è¡¨è¾¾å¼çš„å€¼å»è¿‡æ»¤åˆ†åŒºï¼š<strong>æŸ¥è¯¢æ—¶åªèƒ½é€šè¿‡åˆ—æ¥è¿‡æ»¤åˆ†åŒº</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æ— æ³•è¿‡æ»¤åˆ†åŒºï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sales_by_day <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(<span class="keyword">day</span>) <span class="operator">=</span> <span class="number">2010</span></span><br><span class="line"><span class="comment">--å¯ä»¥è¿‡æ»¤åˆ†åŒºï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sales_by_day <span class="keyword">WHERE</span> <span class="keyword">day</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2010-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2010-12-31&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="1-9-åˆå¹¶è¡¨"><a href="#1-9-åˆå¹¶è¡¨" class="headerlink" title="1.9 åˆå¹¶è¡¨"></a>1.9 åˆå¹¶è¡¨</h3><p>åˆå¹¶è¡¨ï¼ˆMerge Tableï¼‰æ˜¯ç®€å•ç‰ˆçš„åˆ†åŒºå®ç°ï¼Œåˆ†åŒºè¡¨æ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œç”¨æˆ·æ— æ³•è®¿é—®åº•å±‚çš„å„ä¸ªåˆ†åŒºï¼Œä½†ç”¨æˆ·å¯ä»¥å•ç‹¬è®¿é—®åˆå¹¶è¡¨çš„å„ä¸ªå­è¡¨ã€‚</p><p>åˆ†åŒºè¡¨ä¸ä¼˜åŒ–å™¨æ›´ç´§å¯†ç»“åˆï¼Œè€Œåˆå¹¶è¡¨åˆ™æ˜¯è¦è¢«æ·˜æ±°çš„æŠ€æœ¯ã€‚</p><p>åç»­çœç•¥ã€‚</p><h2 id="äºŒ-è§†å›¾"><a href="#äºŒ-è§†å›¾" class="headerlink" title="äºŒ. è§†å›¾"></a>äºŒ. è§†å›¾</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ</h3><ul><li>è§†å›¾åœ¨MySQL 5.0ç‰ˆæœ¬å¼•å…¥ï¼›</li><li>æœ¬èº«æ˜¯è™šæ‹Ÿè¡¨ï¼Œä¸å­˜å‚¨æ•°æ®ï¼Œè®¿é—®è§†å›¾æ—¶ä»å®ä½“è¡¨è·å–æ•°æ®ï¼›</li><li>è§†å›¾ä¸è¡¨åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ï¼Œä¸èƒ½å¯¹è§†å›¾åˆ›å»ºè§¦å‘å™¨ï¼›</li></ul><h3 id="2-2-è§†å›¾çš„ä¸¤ç§å®ç°ç®—æ³•"><a href="#2-2-è§†å›¾çš„ä¸¤ç§å®ç°ç®—æ³•" class="headerlink" title="2.2 è§†å›¾çš„ä¸¤ç§å®ç°ç®—æ³•"></a>2.2 è§†å›¾çš„ä¸¤ç§å®ç°ç®—æ³•</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> Oceania <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Country <span class="keyword">WHERE</span> Continent <span class="operator">=</span> <span class="string">&#x27;Oceania&#x27;</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"><span class="keyword">SELECT</span> code, name <span class="keyword">FROM</span> Oceania <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Australia&#x27;</span>;</span><br></pre></td></tr></table></figure><p>è§†å›¾çš„ä¸¤ç§å®ç°ï¼š</p><ul><li><p><strong>ä¸´æ—¶è¡¨ç®—æ³•</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> TMP_Oceania <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Country <span class="keyword">WHERE</span> Continent <span class="operator">=</span> <span class="string">&#x27;Oceania&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> code, name <span class="keyword">FROM</span> TMP_Oceania <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Australia&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆå¹¶ç®—æ³•</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> code, name <span class="keyword">FROM</span> Country <span class="keyword">WHERE</span> Continent <span class="operator">=</span> <span class="string">&#x27;Oceania&#x27;</span> <span class="keyword">AND</span> name <span class="operator">=</span> <span class="string">&#x27;Australia&#x27;</span>;</span><br></pre></td></tr></table></figure></li></ul><p>å¯ä»¥åœ¨ <code>EXPLAIN EXTENDED</code> åä½¿ç”¨ <code>SHOW WARNINGS</code> æŸ¥çœ‹ä½¿ç”¨è§†å›¾çš„æŸ¥è¯¢é‡å†™åçš„ç»“æœï¼Œä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ä¼šæ˜¾ç¤ºä¸ºæ´¾ç”Ÿè¡¨ï¼ˆDERIVEDï¼‰ï¼š<code>EXPLAIN SELECT * FROM View</code> ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210201/202102010101.png"></p><p>åªè¦æ— æ³•åœ¨åŸè¡¨è®°å½•å’Œè§†å›¾è®°å½•å»ºç«‹ä¸€å¯¹ä¸€æ˜ å°„çš„åœºæ™¯éƒ½æ— æ³•ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°è§†å›¾ï¼Œå¦‚ GROUP BYï¼ŒDISTINCTï¼Œèšåˆå‡½æ•°ï¼ŒUNIONï¼Œå­æŸ¥è¯¢ç­‰ã€‚</p><h3 id="2-3-å¯æ›´æ–°è§†å›¾"><a href="#2-3-å¯æ›´æ–°è§†å›¾" class="headerlink" title="2.3 å¯æ›´æ–°è§†å›¾"></a>2.3 å¯æ›´æ–°è§†å›¾</h3><p>å¯æ›´æ–°è§†å›¾å°±æ˜¯èƒ½å¤Ÿé€šè¿‡æ›´æ–°è§†å›¾æ¥æ›´æ–°è§†å›¾æ¶‰åŠçš„è¡¨ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE Oceania <span class="keyword">SET</span> Population <span class="operator">=</span> Population <span class="operator">*</span> <span class="number">1.1</span> <span class="keyword">WHERE</span> Name <span class="operator">=</span> <span class="string">&#x27;Australia&#x27;</span>;</span><br></pre></td></tr></table></figure><p>è§†å›¾å®šä¹‰åŒ…å« GROUP BYï¼Œèšåˆå‡½æ•°ï¼ŒUNIONç­‰æƒ…å†µä¸èƒ½æ›´æ–°ç›¸å…³è¡¨ï¼Œæ‰€æœ‰ä½¿ç”¨ä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾ä¸èƒ½æ›´æ–°ï¼Œè¢«æ›´æ–°çš„åˆ—å¿…é¡»æ¥è‡ªåŒä¸€å¼ è¡¨ã€‚</p><p><code>CHECK OPTION</code> è¡¨ç¤ºä»»ä½•é€šè¿‡è§†å›¾æ›´æ–°çš„è¡Œï¼Œéƒ½å¿…é¡»ç¬¦åˆè§†å›¾æœ¬èº«çš„WHEREæ¡ä»¶å®šä¹‰ï¼Œä¸èƒ½æ›´æ–°è§†å›¾å®šä¹‰åˆ—å¤–çš„åˆ—ã€‚</p><h3 id="2-4-è§†å›¾å¯¹æ€§èƒ½çš„å½±å“"><a href="#2-4-è§†å›¾å¯¹æ€§èƒ½çš„å½±å“" class="headerlink" title="2.4 è§†å›¾å¯¹æ€§èƒ½çš„å½±å“"></a>2.4 è§†å›¾å¯¹æ€§èƒ½çš„å½±å“</h3><p>è§†å›¾åœ¨æŸäº›åœºæ™¯ä¹Ÿå¯ä»¥å¸®åŠ©æé«˜æ€§èƒ½ï¼Œ</p><ul><li><p>é‡æ„Schemaæ—¶ä½¿ç”¨è§†å›¾ï¼Œä¿®æ”¹è¡¨ç»“æ„æ—¶ä¸ä¼šå½±å“åº”ç”¨è¿è¡Œï¼›</p></li><li><p>ä½¿ç”¨è§†å›¾å®ç°åŸºäºåˆ—çš„æƒé™æ§åˆ¶ï¼Œä¸éœ€è¦çœŸæ­£çš„åœ¨ç³»ç»Ÿåˆ›å»ºæƒé™ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> XX <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> XXX;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> public.<span class="operator">*</span> <span class="keyword">TO</span> public_user;</span><br></pre></td></tr></table></figure></li><li><p>è§†å›¾å¹¶æ²¡æœ‰çœ‹èµ·æ¥é‚£æ ·ç®€å•ï¼Œä½¿ç”¨è§†å›¾æç¤ºæ€§èƒ½éœ€è¦åšæ¯”è¾ƒè¯¦ç»†çš„æµ‹è¯•ï¼Œä¸´æ—¶è¡¨ç®—æ³•å®ç°çš„è§†å›¾åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æ€§èƒ½å¾ˆç³Ÿç³•ï¼Œåˆå¹¶ç®—æ³•å®ç°çš„è§†å›¾ä¹Ÿä¼šæœ‰é¢å¤–å¼€é”€ï¼Œå¹¶ä¸”è§†å›¾çš„æ€§èƒ½å¾ˆéš¾é¢„æµ‹ã€‚</p></li></ul><h3 id="2-5-ä½¿ç”¨è§†å›¾çš„ä¸€äº›é™åˆ¶"><a href="#2-5-ä½¿ç”¨è§†å›¾çš„ä¸€äº›é™åˆ¶" class="headerlink" title="2.5 ä½¿ç”¨è§†å›¾çš„ä¸€äº›é™åˆ¶"></a>2.5 ä½¿ç”¨è§†å›¾çš„ä¸€äº›é™åˆ¶</h3><ul><li>MySQLä¸æ”¯æŒç‰©åŒ–è§†å›¾ï¼ŒæŒ‡å°†è§†å›¾ç»“æœæ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ªå¯ä»¥æŸ¥çœ‹çš„è¡¨ï¼Œå¹¶å®šæ—¶ä»åŸå§‹è¡¨åˆ·æ–°æ•°æ®åˆ°è¿™ä¸ªè¡¨ï¼›</li><li>MySQLè§†å›¾ä¸æ”¯æŒåˆ›å»ºç´¢å¼•ï¼Œä½†å¯ä»¥ä½¿ç”¨ç¼“å­˜è¡¨æˆ–æ±‡æ€»è¡¨æ¨¡æ‹Ÿç‰©åŒ–è§†å›¾å’Œç´¢å¼•ï¼›</li><li>MySQLä¸ä¼šä¿å­˜è§†å›¾å®šä¹‰çš„åŸå§‹SQLè¯­å¥ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨è§†å›¾çš„ <code>.frm</code> æ–‡ä»¶æœ€åä¸€è¡Œè·å–ä¿¡æ¯2ï¼Œå¦‚æœæœ‰FILEæƒé™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨SQLè¯­å¥çš„ <code>LOAD_FILE()</code> è¯»å– <code>.frm</code> çš„è§†å›¾åˆ›å»ºä¿¡æ¯ï¼Œå†å¤„ç†æ‰è½¬ä¹‰å­—ç¬¦ç­‰ã€‚</li></ul><h2 id="ä¸‰-å¤–é”®çº¦æŸ"><a href="#ä¸‰-å¤–é”®çº¦æŸ" class="headerlink" title="ä¸‰. å¤–é”®çº¦æŸ"></a>ä¸‰. å¤–é”®çº¦æŸ</h2><p>InnoDBå¼•æ“æ”¯æŒå¤–é”®ã€‚</p><p>ä¼˜ç‚¹ï¼š</p><ul><li>å¦‚æœæƒ³ç¡®ä¿ä¸¤ä¸ªè¡¨å§‹ç»ˆæœ‰ä¸€è‡´æ€§çš„æ•°æ®ï¼Œä½¿ç”¨å¤–é”®æ¯”åœ¨åº”ç”¨ä¸­ä¿è¯ä¸€è‡´æ€§è¦é«˜æ•ˆçš„å¤šï¼Œçº§è”æ›´æ–°å’Œåˆ é™¤ä¹Ÿè¦æ›´å¿«ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>InnoDBå¼ºåˆ¶å¤–é”®ä½¿ç”¨ç´¢å¼•ï¼Œå½“å¤–é”®åˆ—çš„é€‰æ‹©æ€§å¾ˆä½ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªéå¸¸å¤§ä¸”é€‰æ‹©æ€§å¾ˆä½çš„ç´¢å¼•ï¼Œä¸”è¯¥ç´¢å¼•é™¤äº†åšå¤–é”®é™åˆ¶æ²¡æœ‰å…¶ä»–ä½œç”¨ã€‚</li><li>ä½¿ç”¨å¤–é”®éœ€è¦æˆæœ¬ï¼Œæ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶éƒ½è¦åœ¨å¦ä¸€å¼ è¡¨ä¸­å¤šæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢æ“ä½œã€‚</li><li>æŸ¥è¯¢éœ€è¦é¢å¤–è®¿é—®ä¸€äº›è¡¨ï¼Œæ„å‘³ç€éœ€è¦é¢å¤–çš„é”ã€‚è‹¥å‘å­è¡¨å†™å…¥ä¸€æ¡è®°å½•ï¼Œå¤–é”®çº¦æŸä½¿InnoDBæ£€æŸ¥çˆ¶è¡¨ä¸­å¯¹åº”çš„è®°å½•è¿›è¡ŒåŠ é”æ“ä½œï¼Œç¡®ä¿è¯¥è®°å½•ä¸ä¼šåœ¨äº‹åŠ¡å®Œæˆæ—¶è¢«åˆ é™¤ï¼Œä¼šå¯¼è‡´é¢å¤–çš„é”ç­‰å¾…ï¼Œç”šè‡³å¯¼è‡´ä¸€äº›éš¾ä»¥æ’æŸ¥çš„æ­»é”ã€‚</li></ul><p>å¯ä»¥ä½¿ç”¨è§¦å‘å™¨æ¥ä»£æ›¿å¤–é”®ï¼Œå½“å¤–é”®åªæ˜¯ç”¨ä½œæ•°å€¼çº¦æŸã€‚å¦‚æœåªæ˜¯æŠŠå¤–é”®åšçº¦æŸï¼Œåœ¨åº”ç”¨å±‚å®ç°ä¼šæ›´å¥½ï¼Œå› ä¸ºå¤–é”®ä¼šå¸¦æ¥å¤§é‡çš„é¢å¤–æ¶ˆè€—ï¼Œå¾ˆå¤šè¿‡å¾€çš„ç»éªŒå‘Šè¯‰æˆ‘ä»¬åœ¨åˆ é™¤å¤–é”®æ—¶æ€§èƒ½ä¼šæœ‰å¤§å¹…æå‡ã€‚</p><h2 id="å››-åœ¨MySQLå†…éƒ¨å­˜å‚¨ä»£ç "><a href="#å››-åœ¨MySQLå†…éƒ¨å­˜å‚¨ä»£ç " class="headerlink" title="å››. åœ¨MySQLå†…éƒ¨å­˜å‚¨ä»£ç "></a>å››. åœ¨MySQLå†…éƒ¨å­˜å‚¨ä»£ç </h2><h3 id="4-1-å­˜å‚¨ä»£ç çš„æ–¹å¼"><a href="#4-1-å­˜å‚¨ä»£ç çš„æ–¹å¼" class="headerlink" title="4.1 å­˜å‚¨ä»£ç çš„æ–¹å¼"></a>4.1 å­˜å‚¨ä»£ç çš„æ–¹å¼</h3><p>ä¸»è¦åŒºåˆ«åœ¨äºæ‰§è¡Œçš„ä¸Šä¸‹æ–‡â€”è¾“å…¥å’Œè¾“å‡º</p><ul><li>è§¦å‘å™¨</li><li>å­˜å‚¨è¿‡ç¨‹ï¼šå¯ä»¥æ¥æ”¶å‚æ•°è¿”å›å€¼</li><li>å‡½æ•°ï¼šå¯ä»¥æ¥æ”¶å‚æ•°è¿”å›å€¼</li><li>å®šæ—¶ä»»åŠ¡ / äº‹ä»¶</li></ul><h3 id="4-2-å­˜å‚¨ä»£ç çš„ä¼˜ç¼ºç‚¹"><a href="#4-2-å­˜å‚¨ä»£ç çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="4.2 å­˜å‚¨ä»£ç çš„ä¼˜ç¼ºç‚¹"></a>4.2 å­˜å‚¨ä»£ç çš„ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>æœåŠ¡å™¨å†…éƒ¨æ‰§è¡Œï¼Œç¦»æ•°æ®æœ€è¿‘ï¼Œå¯ä»¥èŠ‚çœå¸¦å®½å’Œç½‘ç»œå»¶è¿Ÿï¼›</li><li>è¿™æ˜¯ä¸€ç§ä»£ç é‡ç”¨ï¼Œæ–¹ä¾¿ç»Ÿä¸€ä¸šåŠ¡è§„åˆ™ï¼Œä¿è¯æŸäº›è¡Œä¸ºæ€»æ˜¯ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„å®‰å…¨æ€§ï¼›</li><li>ç®€åŒ–ä»£ç çš„ç»´æŠ¤å’Œç‰ˆæœ¬æ›´æ–°ï¼›</li><li>å¸®åŠ©æå‡å®‰å…¨æ€§ï¼Œæä¾›äº†æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œåº”ç”¨å¯ä»¥é€šè¿‡å­˜å‚¨è¿‡ç¨‹çš„æ¥å£è®¿é—®æ²¡æœ‰æƒé™çš„è¡¨ï¼›</li><li>æœåŠ¡å™¨ç«¯å¯ä»¥ç¼“å­˜å­˜å‚¨è¿‡ç¨‹çš„æ‰§è¡Œè®¡åˆ’ï¼Œé™ä½äº†éœ€è¦åå¤è°ƒç”¨çš„è¿‡ç¨‹çš„æ¶ˆè€—ï¼›</li><li>åœ¨æœåŠ¡å™¨ç«¯éƒ¨ç½²ï¼Œå¤‡ä»½å’Œç»´æŠ¤éƒ½åœ¨æœåŠ¡å™¨ç«¯å®Œæˆï¼›</li><li>å¯ä»¥åœ¨åº”ç”¨å¼€å‘å’Œæ•°æ®åº“å¼€å‘é—´æ›´å¥½çš„åˆ†å·¥ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>MySQLæ²¡æœ‰æä¾›å¥½ç”¨çš„å¼€å‘å’Œè°ƒè¯•å·¥å…·ï¼Œç¼–å†™å­˜å‚¨ä»£ç éš¾åº¦è¾ƒé«˜ï¼›</li><li>å­˜å‚¨ä»£ç ç›¸æ¯”åº”ç”¨ä»£ç æ•ˆç‡è¦å·®ä¸€äº›ï¼Œå¾ˆéš¾å®ç°å¤æ‚é€»è¾‘ï¼›</li><li>å­˜å‚¨ä»£ç å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„å¤æ‚æ€§ï¼ŒåŸæœ¬åªéœ€éƒ¨ç½²åº”ç”¨ä»£ç å’Œåº“è¡¨ç»“æ„å˜æ›´ï¼Œè¿˜éœ€è¦é¢å¤–éƒ¨ç½²å†…éƒ¨å­˜å‚¨ä»£ç ï¼›</li><li>éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¼šå¸¦æ¥å®‰å…¨éšæ‚£ï¼Œåªè¦ç ´è§£æ•°æ®åº“å°±å°†åŠŸèƒ½å’Œæ•°æ®å…¨éƒ¨è·å–ï¼›</li><li>å­˜å‚¨è¿‡ç¨‹ç»™æ•°æ®åº“æœåŠ¡å™¨å¸¦æ¥é¢å¤–çš„å‹åŠ›ï¼Œæ•°æ®åº“æœåŠ¡å™¨çš„æ‰©å±•æ€§è¦è¿œå·®äºåº”ç”¨æœåŠ¡å™¨ã€‚</li><li>æ— æ³•æ§åˆ¶å­˜å‚¨ç¨‹åºçš„èµ„æºæ¶ˆè€—ï¼Œå¯èƒ½ä¸€ä¸ªé”™è¯¯å°±æŠŠæœåŠ¡å™¨æ‹–æ­»ã€‚</li><li>å­˜å‚¨ä»£ç çš„å®ç°æœ‰å¾ˆå¤šé™åˆ¶ï¼Œè°ƒè¯•ä¹Ÿå¾ˆå›°éš¾ï¼Œéš¾ä»¥å®šä½é—®é¢˜ã€‚</li><li>ä¸åŸºäºè¯­å¥çš„äºŒè¿›åˆ¶æ—¥å¿—å¤åˆ¶åˆä½œçš„ä¸å¥½ã€‚</li></ul><h3 id="4-3-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°"><a href="#4-3-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°" class="headerlink" title="4.3 å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°"></a>4.3 å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°</h3><p>ä¼˜åŒ–å™¨å¯¹å­˜å‚¨ä»£ç çš„é™åˆ¶ï¼š</p><ul><li>ä¼˜åŒ–å™¨æ— æ³•ä½¿ç”¨å…³é”®å­—DETERMINISTICæ¥ä¼˜åŒ–å•ä¸ªæŸ¥è¯¢ä¸­å¤šæ¬¡è°ƒç”¨å­˜å‚¨å‡½æ•°çš„æƒ…å†µã€‚</li><li>ä¼˜åŒ–å™¨æ— æ³•è¯„ä¼°å­˜å‚¨å‡½æ•°çš„æ‰§è¡Œæˆæœ¬ã€‚</li><li>æ¯ä¸ªè¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨è¿‡ç¨‹çš„æ‰§è¡Œè®¡åˆ’ç¼“å­˜ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿æ¥éœ€è¦è°ƒç”¨åŒä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œå°±ä¼šæµªè´¹ç©ºé—´æ¥åå¤ç¼“å­˜åŒæ ·çš„æ‰§è¡Œè®¡åˆ’ï¼ˆè¿æ¥æ± æˆ–æŒä¹…åŒ–è¿æ¥ä¼šé€ æˆç¼“å­˜æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚</li><li>å­˜å‚¨è¿‡ç¨‹å’Œå¤åˆ¶æ˜¯ä¸€å¯¹è¯¡å¼‚çš„ç»„åˆï¼Œæœ€å¥½ä¸è¦å¤åˆ¶å¯¹å­˜å‚¨ç¨‹åºçš„è°ƒç”¨ï¼Œç›´æ¥å¤åˆ¶å…¶æ”¹å˜çš„æ•°æ®ã€‚MySQL 5.1 åå¼•å…¥è¡Œå¤åˆ¶ã€‚</li></ul><h3 id="4-4-è§¦å‘å™¨"><a href="#4-4-è§¦å‘å™¨" class="headerlink" title="4.4 è§¦å‘å™¨"></a>4.4 è§¦å‘å™¨</h3><h4 id="4-4-1-ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿ"><a href="#4-4-1-ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿ" class="headerlink" title="4.4.1 ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿ"></a>4.4.1 ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿ</h4><ul><li>è§¦å‘å™¨å¯ä»¥è®©ä½ åœ¨æ‰§è¡Œ INSERTã€UPDATEæˆ–DELETEæ—¶ï¼Œæ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œã€‚</li><li>å¯ä»¥æŒ‡å®šæ˜¯åœ¨SQLè¯­å¥å‰æˆ–åè§¦å‘ï¼Œè§¦å‘å™¨æœ¬èº«æ²¡æœ‰è¿”å›å€¼ï¼Œä½†å¯ä»¥è¯»å–æˆ–æ”¹å˜è§¦å‘SQLè¯­å¥æ‰€å½±å“çš„æ•°æ®ã€‚</li><li>ä½¿ç”¨è§¦å‘å™¨å¯ä»¥å‡å°‘å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œç®€åŒ–åº”ç”¨é€»è¾‘ï¼Œä¸€å®šç¨‹åº¦ä¸Šæé«˜æ€§èƒ½ã€‚</li></ul><h4 id="4-4-2-ä½¿ç”¨æ³¨æ„"><a href="#4-4-2-ä½¿ç”¨æ³¨æ„" class="headerlink" title="4.4.2 ä½¿ç”¨æ³¨æ„"></a>4.4.2 ä½¿ç”¨æ³¨æ„</h4><ul><li>å¯¹æ¯ä¸ªè¡¨çš„æ¯ä¸ªäº‹ä»¶ï¼Œæœ€å¤šåªèƒ½å®šä¹‰ä¸€ä¸ªè§¦å‘å™¨ï¼ˆå¦‚ä¸èƒ½å†AFTER INSERTä¸Šå®šä¹‰ä¸¤ä¸ªè§¦å‘å™¨ï¼‰ã€‚</li><li>MySQLåªæ”¯æŒåŸºäºè¡Œçš„è§¦å‘ï¼Œå³è§¦å‘å™¨å§‹ç»ˆé’ˆå¯¹ä¸€æ¡è®°å½•ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ•´ä¸ªSQLè¯­å¥ï¼Œå½“æ•°æ®é›†å˜å¾—å¾ˆå¤§æ—¶ï¼Œæ•ˆç‡ä¼šå¾ˆä½ã€‚</li><li>è§¦å‘å™¨ä¼šæ©ç›–æœåŠ¡å™¨èƒŒåå¾ˆå¤šå·¥ä½œï¼Œè€Œè§¦å‘å™¨çš„é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚</li><li>è§¦å‘å™¨å¯èƒ½ä¼šå¯¼è‡´æ­»é”å’Œé”ç­‰å¾…ï¼Œè§¦å‘å™¨æ‰§è¡Œå¤±è´¥ä¼šå¯¼è‡´SQLä¹Ÿå¤±è´¥ï¼Œä½†ä¸ä¼šæœ‰ç›´æ¥æ˜ç¡®çš„æç¤ºã€‚</li><li>è§¦å‘å™¨åœ¨InnoDBè¡¨ä¸Šæ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆçš„ï¼Œæ‰§è¡Œæ“ä½œæ˜¯åŸå­çš„ï¼ŒåŸå­æ“ä½œå’Œè§¦å‘å™¨æ“ä½œä¼šåŒæ—¶å¤±è´¥æˆ–æˆåŠŸã€‚</li><li>åœ¨InnoDBä¸Šä½¿ç”¨è§¦å‘å™¨å»æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§è¦å°å¿ƒMVCCï¼Œå¯èƒ½ä¼šå¾—åˆ°é”™è¯¯ç»“æœã€‚</li></ul><h3 id="4-5-äº‹ä»¶"><a href="#4-5-äº‹ä»¶" class="headerlink" title="4.5 äº‹ä»¶"></a>4.5 äº‹ä»¶</h3><ul><li>MySQL 5.1 å¼•å…¥äº‹ä»¶ä½œä¸ºä¸€ç§æ–°çš„å­˜å‚¨ä»£ç çš„æ–¹å¼ï¼ŒMySQLå†…éƒ¨å®ç°çš„ç±»ä¼¼äºLinuxçš„å®šæ—¶ä»»åŠ¡ã€‚</li><li>æŒ‡å®šMySQLåœ¨æŸä¸ªæ—¶é—´æ‰§è¡Œä¸€æ®µSQLä»£ç ï¼Œæˆ–è€…æ¯éš”ä¸€ä¸ªæ—¶é—´é—´éš”ã€‚å…¶ä¸­å¤æ‚çš„SQLå°è£…åœ¨ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œäº‹ä»¶æ‰§è¡Œæ—¶åªéœ€åšä¸€ä¸ªç®€å•çš„è°ƒç”¨ã€‚</li><li>äº‹ä»¶åœ¨ä¸€ä¸ªç‹¬ç«‹äº‹ä»¶è°ƒåº¦çº¿ç¨‹ä¸­è¢«åˆå§‹åŒ–ï¼Œè¯¥çº¿ç¨‹å’Œå¤„ç†è¿æ¥çš„çº¿ç¨‹æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¸æ¥æ”¶ä»»ä½•å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•è¿”å›å€¼ã€‚å¯ä»¥åœ¨MySQLçš„æ—¥å¿—ä¸­çœ‹åˆ°å‘½ä»¤çš„æ‰§è¡Œæ—¥å¿—ï¼Œåœ¨è¡¨ INFORMATION_SCHEMA.EVENTS ä¸­çœ‹åˆ°å„ä¸ªäº‹ä»¶çŠ¶æ€ã€‚</li><li>äº‹ä»¶å®ç°æœºåˆ¶æœ¬èº«å¼€é”€ä¸å¤§ï¼Œä½†äº‹ä»¶éœ€è¦æ‰§è¡ŒSQLï¼Œè¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼›äº‹ä»¶å’Œå…¶ä»–å­˜å‚¨ç¨‹åºä¸€æ ·ï¼Œåœ¨å’ŒåŸºäºè¯­å¥çš„å¤åˆ¶ä¸€èµ·å·¥ä½œæ—¶å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</li><li>å®šæ—¶äº‹ä»¶å¯èƒ½ä¼šæ‰§è¡Œå¾ˆä¹…ï¼Œå‰ä¸€ä¸ªäº‹ä»¶æœªæ‰§è¡Œå®Œï¼Œåä¸€ä¸ªäº‹ä»¶å¼€å§‹æ‰§è¡Œï¼Œå¼€å‘è¦è‡ªå·±å¤„ç†è¿™ç§æƒ…å†µä¸‹çš„å¹¶å‘ï¼ˆå¯ä»¥ä½¿ç”¨ <code>GET_LOCK()</code> ç¡®ä¿å½“å‰æ€»æ˜¯åªæœ‰ä¸€ä¸ªäº‹ä»¶åœ¨æ‰§è¡Œ-åŠ é”ï¼‰ã€‚</li><li>é€šè¿‡ <code>SET GLOBAL event_scheduler := 1;</code> è®¾ç½®äº‹ä»¶è°ƒåº¦çº¿ç¨‹ï¼Œè®¾ç½®åæ­¤çº¿ç¨‹æ‰§è¡Œå„ä¸ªç”¨æˆ·æŒ‡å®šçš„äº‹ä»¶ä¸­çš„å„æ®µSQLä»£ç ã€‚</li><li>äº‹ä»¶è°ƒåº¦æœ¬èº«æ˜¯ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼ŒMySQLåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç”¨äºäº‹ä»¶æ‰§è¡Œï¼Œè¿›ç¨‹å’Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯äº‹ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒçŠ¶æ€æ€»ä¸º Connect ã€‚</li></ul><h2 id="äº”-æ¸¸æ ‡"><a href="#äº”-æ¸¸æ ‡" class="headerlink" title="äº”. æ¸¸æ ‡"></a>äº”. æ¸¸æ ‡</h2><p>æš‚ç•¥ã€‚</p><h2 id="å…­-ç»‘å®šå˜é‡"><a href="#å…­-ç»‘å®šå˜é‡" class="headerlink" title="å…­. ç»‘å®šå˜é‡"></a>å…­. ç»‘å®šå˜é‡</h2><h3 id="6-1-ä»€ä¹ˆæ˜¯ç»‘å®šå˜é‡ï¼Ÿ"><a href="#6-1-ä»€ä¹ˆæ˜¯ç»‘å®šå˜é‡ï¼Ÿ" class="headerlink" title="6.1 ä»€ä¹ˆæ˜¯ç»‘å®šå˜é‡ï¼Ÿ"></a>6.1 ä»€ä¹ˆæ˜¯ç»‘å®šå˜é‡ï¼Ÿ</h3><ul><li><p>MySQL 4.1 ç‰ˆæœ¬å¼•å…¥ç»‘å®šå˜é‡ï¼ˆprepared statementï¼‰ï¼Œç”¨äºæé«˜å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯æ•°æ®ä¼ è¾“çš„æ•ˆç‡ã€‚</p></li><li><p>æµç¨‹ï¼šåˆ›å»ºä¸€ä¸ªç»‘å®šå˜é‡çš„SQLæ—¶ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªSQLè¯­å¥çš„åŸå‹ï¼›æœåŠ¡ç«¯æ”¶åˆ°åï¼Œè§£æå¹¶å­˜å‚¨è¿™ä¸ªSQLè¯­å¥çš„éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªSQLè¯­å¥å¤„ç†å¥æŸ„ï¼Œä»¥åæ¯æ¬¡æ‰§è¡Œæ­¤ç±»æŸ¥è¯¢ï¼Œå®¢æˆ·ç«¯éƒ½æŒ‡å®šä½¿ç”¨è¿™ä¸ªå¥æŸ„ã€‚</p></li><li><p>è¯­æ³•ï¼šç”¨é—®å·æ ‡è®°å¯ä»¥æ¥æ”¶å‚æ•°çš„ä½ç½®ï¼Œé€šè¿‡å‘æœåŠ¡å™¨ç«¯å‘é€å„ä¸ªé—®å·çš„å–å€¼å’Œè¿™ä¸ªSQLçš„å¥æŸ„æ¥æ‰§è¡ŒæŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb1(col1, col2, col3) <span class="keyword">VALUES</span> (?, ?, ?);</span><br></pre></td></tr></table></figure></li></ul><h3 id="6-2-ç»‘å®šå˜é‡ä¸ºä½•èƒ½æé«˜æ€§èƒ½ï¼Ÿ"><a href="#6-2-ç»‘å®šå˜é‡ä¸ºä½•èƒ½æé«˜æ€§èƒ½ï¼Ÿ" class="headerlink" title="6.2 ç»‘å®šå˜é‡ä¸ºä½•èƒ½æé«˜æ€§èƒ½ï¼Ÿ"></a>6.2 ç»‘å®šå˜é‡ä¸ºä½•èƒ½æé«˜æ€§èƒ½ï¼Ÿ</h3><ul><li>åœ¨æœåŠ¡å™¨ç«¯åªéœ€è§£æä¸€æ¬¡SQLè¯­å¥ã€‚</li><li>åœ¨æœåŠ¡å™¨ç«¯æŸäº›ä¼˜åŒ–å™¨çš„å·¥ä½œåªéœ€æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºä¼šç¼“å­˜ä¸€éƒ¨åˆ†æ‰§è¡Œè®¡åˆ’ã€‚</li><li>ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼åªå‘é€å‚æ•°å’Œå¥æŸ„ï¼Œæ¯”æ¯æ¬¡éƒ½å‘é€ASCIIç æ–‡æœ¬æ•ˆç‡è¦é«˜ï¼Œæ¯”å¦‚ä¸€ä¸ªäºŒè¿›åˆ¶çš„æ—¥æœŸåªéœ€ä¸‰ä¸ªå­—èŠ‚ï¼Œè€Œåè€…åˆ™éœ€è¦åä¸ªå­—èŠ‚ï¼›å¯ä»¥åˆ†å—ä¼ è¾“ï¼Œè€Œæ— éœ€ä¸€æ¬¡æ€§ä¼ è¾“ï¼›è¿˜èŠ‚çœäº†å°†æ•°æ®ä»åŸå§‹æ ¼å¼è½¬ä¸ºæ–‡æœ¬æ ¼å¼çš„å¼€é”€ã€‚</li><li>åªä¼ è¾“å‚æ•°ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè¯­å¥ï¼Œç½‘ç»œå¼€é”€é™ä½ã€‚</li><li>MySQLç›´æ¥å°†å‚æ•°å­˜å‚¨åˆ°ç¼“å­˜ï¼Œä¸éœ€è¦åœ¨å†…å­˜ä¸­å¤šæ¬¡å¤åˆ¶ã€‚</li></ul><h3 id="6-3-ä¼˜åŒ–"><a href="#6-3-ä¼˜åŒ–" class="headerlink" title="6.3 ä¼˜åŒ–"></a>6.3 ä¼˜åŒ–</h3><p>æ¯”å¦‚å½“æ‰§è¡Œè®¡åˆ’éœ€è¦æ ¹æ®ä¼ å…¥çš„å‚æ•°è®¡ç®—æ—¶ï¼ŒMySQLæ— æ³•ç¼“å­˜è¿™éƒ¨åˆ†è®¡åˆ’ã€‚</p><p>æ ¹æ®ä¼˜åŒ–å™¨å·¥ä½œé˜¶æ®µï¼Œåˆ’åˆ†ä¸‰ç±»ä¼˜åŒ–ï¼š</p><ol><li><strong>å‡†å¤‡é˜¶æ®µ</strong>ï¼šæœåŠ¡å™¨è§£æSQLè¯­å¥ï¼Œç§»é™¤ä¸å¯èƒ½æ¡ä»¶ï¼Œå¹¶ä¸”é‡å†™å­æŸ¥è¯¢ã€‚</li><li><strong>ç¬¬ä¸€æ¬¡æ‰§è¡Œ</strong>ï¼šæœåŠ¡å™¨å…ˆç®€åŒ–åµŒå¥—å¾ªç¯çš„å…³è”ï¼Œå¹¶å°†å¤–å…³è”è½¬æ¢æˆå†…å…³è”ã€‚</li><li><strong>æ¯æ¬¡SQLè¯­å¥æ‰§è¡Œ</strong>ï¼š<ul><li>è¿‡æ»¤åˆ†åŒº</li><li>å°½é‡ç§»é™¤ <code>COUNT()</code> ã€<code>MIN()</code> å’Œ <code>MAX()</code> </li><li>ç§»é™¤å¸¸æ•°è¡¨è¾¾å¼</li><li>åšå¿…è¦çš„ç­‰å€¼ä¼ æ’­</li><li>åˆ†æå’Œä¼˜åŒ– ref ã€range å’Œç´¢å¼•ä¼˜åŒ–ç­‰è®¿é—®æ•°æ®çš„æ–¹æ³•</li><li>ä¼˜åŒ–å…³è”é¡ºåº</li></ul></li></ol><h3 id="6-4-SQLæ¥å£çš„ç»‘å®šå˜é‡"><a href="#6-4-SQLæ¥å£çš„ç»‘å®šå˜é‡" class="headerlink" title="6.4 SQLæ¥å£çš„ç»‘å®šå˜é‡"></a>6.4 SQLæ¥å£çš„ç»‘å®šå˜é‡</h3><p>MySQL åœ¨ 4.1 ç‰ˆæœ¬ä¸­æ”¯æŒäº†SQLæ¥å£çš„ç»‘å®šå˜é‡ï¼Œä¸éœ€è¦ä½¿ç”¨äºŒè¿›åˆ¶ä¼ è¾“åè®®ä¹Ÿå¯ä»¥ç›´æ¥ä»¥SQLçš„æ–¹å¼ä½¿ç”¨ç»‘å®šå˜é‡ã€‚</p><p>æœåŠ¡å™¨ä¼šå°†SQLè¯­å¥ç¿»è¯‘ï¼Œæ— éœ€ä½¿ç”¨äºŒè¿›åˆ¶åè®®ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@sql</span> :<span class="operator">=</span> <span class="string">&#x27;SELECT actor_id, first_name, last_name FROM actor WHERE first_name = ?&#x27;</span>;</span><br><span class="line"><span class="keyword">PREPARE</span> stmt_fetch_actor <span class="keyword">FROM</span> <span class="variable">@sql</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@actor</span>_name :<span class="operator">=</span> <span class="string">&#x27;Penelope&#x27;</span></span><br><span class="line"><span class="keyword">EXECUTE</span> stmt_fetch_actor <span class="keyword">USING</span> <span class="variable">@actor</span>_name;</span><br><span class="line">DEALLOATE <span class="keyword">PREPARE</span> stmt_fetch_actor;</span><br></pre></td></tr></table></figure><p>è¿™ç§å†™æ³•çš„ä¸»è¦ç”¨é€”æ˜¯åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œå¯ä»¥çµæ´»çš„æ‹¼æ¥å­—ç¬¦ä¸²ç­‰å‚æ•°æ„å»ºSQLè¯­å¥ï¼Œé™¤æ­¤å¤–ç›¸æ¯”äºŒè¿›åˆ¶åè®®å°±æ²¡ä»€ä¹ˆä¼˜åŠ¿äº†ã€‚</p><p>ä½¿ç”¨é™åˆ¶ï¼š</p><ul><li>ç»‘å®šå˜é‡æ˜¯ä¼šè¯çº§åˆ«ï¼Œè¿æ¥ä¹‹é—´ä¸èƒ½å…±ç”¨ç»‘å®šå˜é‡å¥æŸ„ã€‚ä¸€æ—¦è¿æ¥æ–­å¼€ï¼ŒåŸæ¥çš„å¥æŸ„ä¹Ÿä¸èƒ½ä½¿ç”¨ï¼Œä½¿ç”¨è¿æ¥æ± å’ŒæŒä¹…åŒ–è¿æ¥å¯ä»¥ç¼“è§£æ­¤é—®é¢˜ã€‚</li><li>MySQL 5.1 ä¹‹å‰ç‰ˆæœ¬ï¼Œç»‘å®šå˜é‡çš„SQLä¸èƒ½ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚</li><li>åªæ‰§è¡Œä¸€æ¬¡çš„SQLï¼Œä½¿ç”¨ç»‘å®šå˜é‡ä¼šå¤šä¸€æ¬¡é¢å¤–çš„å‡†å¤‡é˜¶æ®µæ¶ˆè€—ï¼Œå’Œä¸€æ¬¡é¢å¤–çš„ç½‘ç»œå¼€é”€ã€‚</li><li>ä¸èƒ½åœ¨å­˜å‚¨å‡½æ•°ä¸­ä½¿ç”¨ã€‚</li><li>æœªé‡Šæ”¾çš„ç»‘å®šå˜é‡èµ„æºå®¹æ˜“é€ æˆèµ„æºæ³„éœ²ï¼Œå¯¹æ‰€æœ‰çº¿ç¨‹é€ æˆå½±å“ã€‚</li><li>å¦‚BEGINç­‰æ“ä½œæ— æ³•åœ¨ç»‘å®šå˜é‡ä¸­å®Œæˆã€‚</li></ul><h3 id="6-5-ä¸‰ç§ç»‘å®šå˜é‡çš„åŒºåˆ«"><a href="#6-5-ä¸‰ç§ç»‘å®šå˜é‡çš„åŒºåˆ«" class="headerlink" title="6.5 ä¸‰ç§ç»‘å®šå˜é‡çš„åŒºåˆ«"></a>6.5 ä¸‰ç§ç»‘å®šå˜é‡çš„åŒºåˆ«</h3><ul><li><strong>å®¢æˆ·ç«¯æ¨¡æ‹Ÿçš„ç»‘å®šå˜é‡</strong>ï¼šæ¥æ”¶ä¸€ä¸ªå¸¦å‚æ•°çš„SQLï¼Œå°†æŒ‡å®šçš„å€¼å¸¦å…¥ï¼Œæœ€åå°†å®Œæ•´çš„æŸ¥è¯¢å‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚</li><li><strong>æœåŠ¡ç«¯çš„ç»‘å®šå˜é‡</strong>ï¼šå®¢æˆ·ç«¯ä½¿ç”¨ç‰¹æ®Šçš„äºŒè¿›åˆ¶åè®®å°†å¸¦å‚æ•°çš„å­—ç¬¦ä¸²å‘é€åˆ°æœåŠ¡å™¨ç«¯ï¼Œç„¶åä½¿ç”¨äºŒè¿›åˆ¶åè®®å°†å…·ä½“çš„å‚æ•°å€¼å‘é€ç»™æœåŠ¡å™¨ç«¯å¹¶æ‰§è¡Œã€‚</li><li><strong>SQLæ¥å£çš„ç»‘å®šå˜é‡</strong>ï¼šå®¢æˆ·ç«¯å…ˆå‘é€ä¸€ä¸ªå¸¦å‚æ•°çš„å­—ç¬¦ä¸²åˆ°æœåŠ¡å™¨ï¼Œç±»ä¼¼äºä½¿ç”¨PREPAREçš„SQLè¯­å¥ï¼Œç„¶åå‘é€è®¾ç½®å‚æ•°çš„SQLï¼Œæœ€åä½¿ç”¨EXECUTEæ¥æ‰§è¡ŒSQLï¼Œä½¿ç”¨æ™®é€šçš„æ–‡æœ¬ä¼ è¾“åè®®ã€‚</li></ul><h2 id="ä¸ƒ-ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"><a href="#ä¸ƒ-ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="ä¸ƒ. ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"></a>ä¸ƒ. ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h2><p>æš‚ç•¥ã€‚</p><h2 id="å…«-æ’ä»¶"><a href="#å…«-æ’ä»¶" class="headerlink" title="å…«. æ’ä»¶"></a>å…«. æ’ä»¶</h2><p>æš‚ç•¥ã€‚</p><h2 id="ä¹-å­—ç¬¦é›†å’Œæ ¡å¯¹"><a href="#ä¹-å­—ç¬¦é›†å’Œæ ¡å¯¹" class="headerlink" title="ä¹. å­—ç¬¦é›†å’Œæ ¡å¯¹"></a>ä¹. å­—ç¬¦é›†å’Œæ ¡å¯¹</h2><p>æš‚ç•¥ã€‚</p><h2 id="å-å…¨æ–‡ç´¢å¼•"><a href="#å-å…¨æ–‡ç´¢å¼•" class="headerlink" title="å. å…¨æ–‡ç´¢å¼•"></a>å. å…¨æ–‡ç´¢å¼•</h2><h3 id="10-1-ä»€ä¹ˆæ˜¯å…¨æ–‡ç´¢å¼•ï¼Ÿ"><a href="#10-1-ä»€ä¹ˆæ˜¯å…¨æ–‡ç´¢å¼•ï¼Ÿ" class="headerlink" title="10.1 ä»€ä¹ˆæ˜¯å…¨æ–‡ç´¢å¼•ï¼Ÿ"></a>10.1 ä»€ä¹ˆæ˜¯å…¨æ–‡ç´¢å¼•ï¼Ÿ</h3><ul><li><strong>åœºæ™¯</strong>ï¼šå¦‚æœæƒ³è¦é€šè¿‡å…³é”®å­—çš„åŒ¹é…æ¥è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤ï¼Œéœ€è¦åŸºäºç›¸ä¼¼åº¦çš„æŸ¥è¯¢è€Œä¸æ˜¯ç²¾ç¡®çš„æ•°æ®æ¯”è¾ƒï¼Œå…¨æ–‡ç´¢å¼•ä¸“ä¸ºæ­¤åœºæ™¯è®¾è®¡ã€‚</li><li><strong>æ”¯æŒ</strong>ï¼šå„ç§å­—ç¬¦ä¸²å†…å®¹çš„æœç´¢ï¼ŒåŒ…æ‹¬CHARã€VARCHARå’ŒTEXTç±»å‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æœç´¢å’Œå¸ƒå°”æœç´¢ã€‚</li><li>äº’è”ç½‘æœç´¢å¼•æ“æŠ€æœ¯å’Œå…¨æ–‡ç´¢å¼•åŸºæœ¬åŸç†ç›¸åŒã€‚</li></ul><h3 id="10-2-è‡ªç„¶è¯­è¨€çš„å…¨æ–‡ç´¢å¼•"><a href="#10-2-è‡ªç„¶è¯­è¨€çš„å…¨æ–‡ç´¢å¼•" class="headerlink" title="10.2 è‡ªç„¶è¯­è¨€çš„å…¨æ–‡ç´¢å¼•"></a>10.2 è‡ªç„¶è¯­è¨€çš„å…¨æ–‡ç´¢å¼•</h3><p>è¯¥å¼•æ“ä¼šè®¡ç®—æ¯ä¸€ä¸ªæ–‡æ¡£å¯¹è±¡å’ŒæŸ¥è¯¢çš„ç›¸å…³åº¦ï¼Œç›¸å…³åº¦åŸºäºåŒ¹é…çš„å…³é”®è¯ä¸ªæ•°ï¼Œä»¥åŠå…³é”®è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚å‡ºç°æ¬¡æ•°è¶Šå°‘çš„è¯è¯­ï¼ŒåŒ¹é…æ—¶çš„ç›¸å…³åº¦å°±è¶Šé«˜ï¼Œå¸¸è§çš„è¯è¯­å°†ä¸ä¼šæœç´¢ï¼ˆè¶…è¿‡50%çš„è®°å½•éƒ½å‡ºç°ï¼‰ï¼Œå³ä½¿ä¸åœ¨åœç”¨è¯åˆ—è¡¨ä¸­å‡ºç°ã€‚</p><p>å¯ä»¥æ ¹æ®WHEREå­å¥ä¸­çš„MATCH AGAINSTæ¥åŒºåˆ†æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨å…¨æ–‡ç´¢å¼•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> film_text;</span><br><span class="line"><span class="comment">--index_typeä¸ºFULLTEXTï¼Œå‡è®¾ä¸¤ä¸ªå­—æ®µtitle, descriptionå»ºç«‹äº†å…¨æ–‡ç´¢å¼•</span></span><br><span class="line"><span class="keyword">select</span> film_id, title, <span class="keyword">RIGHT</span>(description, <span class="number">25</span>), <span class="keyword">MATCH</span>(title, description) AGAINST(<span class="string">&#x27;factory casualties&#x27;</span>) <span class="keyword">AS</span> relevance </span><br><span class="line"><span class="keyword">FROM</span> film_text</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(title, description) AGAINST(<span class="string">&#x27;factory casualties&#x27;</span>);</span><br><span class="line"><span class="comment">--MySQLå°†æœç´¢è¯è¯­åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å…³é”®è¯è¿›è¡Œæœç´¢ï¼Œå‡½æ•°MATCH()ä¼šè¿”å›å…³é”®è¯åŒ¹é…çš„ç›¸å…³åº¦</span></span><br></pre></td></tr></table></figure><p>åœ¨MATCHå‡½æ•°ä¸­æŒ‡å®šçš„åˆ—å¿…é¡»å’Œå…¨æ–‡ç´¢å¼•æŒ‡å®šçš„åˆ—ç›¸åŒï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨å…¨æ–‡ç´¢å¼•ï¼Œå› ä¸ºå…¨æ–‡ç´¢å¼•ä¸ä¼šè®°å½•å…³é”®å­—æ¥è‡ªå“ªä¸€åˆ—ã€‚ä¹Ÿæ„å‘³ç€æ— æ³•ä½¿ç”¨å…¨æ–‡ç´¢å¼•æ¥æŸ¥è¯¢æŸä¸ªå…³é”®å­—æ˜¯å¦åœ¨æŸä¸€åˆ—ä¸­å­˜åœ¨ã€‚</p><h3 id="10-3-å¸ƒå°”å…¨æ–‡ç´¢å¼•"><a href="#10-3-å¸ƒå°”å…¨æ–‡ç´¢å¼•" class="headerlink" title="10.3 å¸ƒå°”å…¨æ–‡ç´¢å¼•"></a>10.3 å¸ƒå°”å…¨æ–‡ç´¢å¼•</h3><p>ç”¨æˆ·å¯ä»¥åœ¨å¸ƒå°”æœç´¢çš„æŸ¥è¯¢ä¸­è‡ªå®šä¹‰æŸä¸ªè¢«æœç´¢è¯è¯­çš„ç›¸å…³æ€§ï¼Œé€šè¿‡åœç”¨è¯åˆ—è¡¨è¿‡æ»¤æ‰â€œå™ªå£°â€è¯ï¼Œè¦æ±‚æœç´¢å…³é”®è¯é•¿åº¦éœ€è¦å¤§äº <code>ft_min_word_len</code> ä¸”å°äº <code>ft_max_word_len</code> ï¼Œæœç´¢ç»“æœæœªç»æ’åºã€‚</p><p>é€šè¿‡<strong>å‰ç¼€ä¿®é¥°ç¬¦</strong>æ¥å®šåˆ¶å¸ƒå°”æœç´¢ï¼š</p><ul><li>dinosaurï¼šåŒ…å«dinosaurçš„è¡Œrankå€¼æ›´é«˜</li><li>~dinosaurï¼šåŒ…å«dinosaurçš„è¡Œrankå€¼æ›´ä½</li><li>+dinosaurï¼šè¡Œè®°å½•å¿…é¡»åŒ…å«dinosaur</li><li>-dinosaurï¼šè¡Œè®°å½•ä¸å¯ä»¥åŒ…å«dinosaur</li><li>dino*ï¼šåŒ…å«ä»¥dinoå¼€å¤´çš„å•è¯çš„è¡Œrankå€¼æ›´é«˜</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æŸ¥è¯¢å¿…é¡»åŒæ—¶åŒ…å«factoryå’Œcasualties</span></span><br><span class="line"><span class="keyword">SELECT</span> film_id, title, <span class="keyword">RIGHT</span>(description, <span class="number">25</span>)</span><br><span class="line"><span class="keyword">FROM</span> film_text</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(title, description)</span><br><span class="line">AGAINST(<span class="string">&#x27;+factory +casualties&#x27;</span> <span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE);</span><br><span class="line"></span><br><span class="line"><span class="comment">--æŸ¥è¯¢ä¸­ä½¿ç”¨æ‹¬å·è¿›è¡ŒçŸ­è¯­æœç´¢</span></span><br><span class="line"><span class="keyword">SELECT</span> film_id, title, <span class="keyword">RIGHT</span>(description, <span class="number">25</span>)</span><br><span class="line"><span class="keyword">FROM</span> film_text</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(title, description)</span><br><span class="line">AGAINST(<span class="string">&#x27;&quot;spirited casualties&quot;&#x27;</span> <span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE);</span><br></pre></td></tr></table></figure><p>çŸ­è¯­æœç´¢è¾ƒæ…¢ï¼Œå› ä¸ºå•ä½¿ç”¨å…¨æ–‡ç´¢å¼•æ— æ³•åˆ¤æ–­æ˜¯å¦ç²¾ç¡®åŒ¹é…åˆ°çŸ­è¯­ï¼Œé€šå¸¸è¿˜è¦æŸ¥è¯¢åŸæ–‡ç¡®å®šè®°å½•æ˜¯å¦åŒ…å«å®Œæ•´çš„çŸ­è¯­ï¼Œå› ä¸ºéœ€è¦å›è¡¨è¿‡æ»¤ï¼Œæ‰€ä»¥æ•ˆç‡ä¸é«˜ã€‚</p><h3 id="10-4-ä½¿ç”¨é™åˆ¶"><a href="#10-4-ä½¿ç”¨é™åˆ¶" class="headerlink" title="10.4 ä½¿ç”¨é™åˆ¶"></a>10.4 ä½¿ç”¨é™åˆ¶</h3><ul><li>å…¨æ–‡ç´¢å¼•åªèƒ½é€šè¿‡è¯é¢‘æ¥åˆ¤æ–­ç›¸å…³æ€§ï¼Œç´¢å¼•ä¸ä¼šè®°å½•ç´¢å¼•è¯åœ¨å­—ç¬¦ä¸²çš„ä½ç½®ã€‚</li><li>å…¨æ–‡ç´¢å¼•åªæœ‰å…¨éƒ¨åœ¨å†…å­˜ä¸­æ—¶æ‰æœ‰è¾ƒå¥½çš„æ€§èƒ½ï¼Œä½¿ç”¨ç²¾ç¡®çŸ­è¯­æœç´¢æ—¶ï¼Œéœ€è¦æ•°æ®å’Œç´¢å¼•éƒ½åœ¨å†…å­˜ä¸­ã€‚</li><li>å…¨æ–‡ç´¢å¼•ç›¸æ¯”å…¶ä»–ç´¢å¼•åœ¨ INSERTã€UPDATE å’Œ DELETE æ“ä½œçš„ä»£ä»·éƒ½å¾ˆå¤§ï¼š<ul><li>ä¿®æ”¹æ–‡æœ¬ä¸­çš„100ä¸ªå•è¯ï¼Œéœ€è¦100æ¬¡ç´¢å¼•æ“ä½œï¼Œè€Œä¸æ˜¯ä¸€æ¬¡ã€‚</li><li>ä¸€èˆ¬æƒ…å†µï¼Œåˆ—é•¿åº¦ä¸ä¼šå½±å“å…¶ä»–ç´¢å¼•ç±»å‹ï¼Œä½†å¯¹äºå…¨æ–‡ç´¢å¼•ï¼Œä¸ªä½æ•°å•è¯æ–‡æœ¬å’Œ10000ä¸ªå•è¯çš„æ–‡æœ¬ï¼Œæ€§èƒ½å¯èƒ½ç›¸å·®å‡ ä¸ªæ•°é‡çº§ã€‚</li><li>å…¨æ–‡ç´¢å¼•æœ‰æ›´å¤šç¢ç‰‡ï¼Œå¯èƒ½éœ€è¦åšæ›´å¤šçš„ <code>OPTIMIZE TABLE</code> æ“ä½œã€‚</li></ul></li><li>å…¨æ–‡ç´¢å¼•å½±å“ä¼˜åŒ–å™¨ï¼š<ul><li>æŸ¥è¯¢ä¸­ä½¿ç”¨äº† <code>MATCH AGAINST</code> å­å¥ï¼Œå¯¹åº”åˆ—æœ‰å¯ç”¨çš„å…¨æ–‡ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µä¸€å®šä¼šä½¿ç”¨å…¨æ–‡ç´¢å¼•ï¼Œå³ä½¿å¯èƒ½æœ‰æ€§èƒ½æ›´å¥½çš„å…¶ä»–ç´¢å¼•ã€‚</li><li>å…¨æ–‡ç´¢å¼•åªèƒ½ç”¨ä½œå…¨æ–‡æœç´¢åŒ¹é…ï¼Œä»»ä½•å…¶ä»–æ“ä½œï¼Œå¦‚WHEREæ¡ä»¶æ¯”è¾ƒï¼Œéƒ½éœ€è¦åœ¨MySQLå®Œæˆå…¨æ–‡æœç´¢è¿”å›è®°å½•åæ‰èƒ½è¿›è¡Œï¼Œæ™®é€šç´¢å¼•å¯ä»¥åœ¨å¤„ç†WHEREæ¡ä»¶æ—¶ä¸€æ¬¡åˆ¤æ–­å¤šä¸ªæ¯”è¾ƒè¡¨è¾¾å¼ã€‚</li><li>å…¨æ–‡ç´¢å¼•ä¸å­˜å‚¨ç´¢å¼•åˆ—çš„å®é™…å€¼ï¼Œç´¢å¼•ä¸èƒ½ç”¨ä½œç´¢å¼•è¦†ç›–æ‰«æã€‚</li><li>é™¤äº†ç›¸å…³æ€§æ’åºï¼Œå…¨æ–‡ç´¢å¼•ä¸èƒ½ç”¨äºå…¶ä»–æ’åºã€‚</li></ul></li></ul><h2 id="åä¸€-åˆ†å¸ƒå¼ï¼ˆXAï¼‰äº‹åŠ¡"><a href="#åä¸€-åˆ†å¸ƒå¼ï¼ˆXAï¼‰äº‹åŠ¡" class="headerlink" title="åä¸€. åˆ†å¸ƒå¼ï¼ˆXAï¼‰äº‹åŠ¡"></a>åä¸€. åˆ†å¸ƒå¼ï¼ˆXAï¼‰äº‹åŠ¡</h2><h3 id="11-1-MySQLä¸­çš„XAäº‹åŠ¡"><a href="#11-1-MySQLä¸­çš„XAäº‹åŠ¡" class="headerlink" title="11.1 MySQLä¸­çš„XAäº‹åŠ¡"></a>11.1 MySQLä¸­çš„XAäº‹åŠ¡</h3><p>å­˜å‚¨å¼•æ“çš„äº‹åŠ¡ç‰¹æ€§èƒ½ä¿è¯åœ¨å­˜å‚¨å¼•æ“çº§åˆ«å®ç°ACIDï¼Œåˆ†å¸ƒå¼äº‹åŠ¡åˆ™å¯ä»¥æ‰©å±•åˆ°æ•°æ®åº“å±‚é¢ï¼Œä»¥åŠå¤šä¸ªæ•°æ®åº“ä¹‹é—´ã€‚é€šè¿‡<strong>ä¸¤é˜¶æ®µæäº¤</strong>æ¥å®ç°ã€‚</p><p>MySQL åœ¨ 5.0 ç‰ˆæœ¬æ”¯æŒ XA äº‹åŠ¡ï¼ŒXAäº‹åŠ¡éœ€è¦æœ‰ä¸€ä¸ªäº‹åŠ¡åè°ƒå™¨æ¥ä¿è¯æ‰€æœ‰çš„äº‹åŠ¡å‚ä¸è€…éƒ½å®Œæˆäº†å‡†å¤‡å·¥ä½œï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰ï¼›å¦‚æœåè°ƒå™¨æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡å¥½çš„æ¶ˆæ¯ï¼Œå°±ä¼šå‘Šè¯‰äº‹åŠ¡å¯ä»¥æäº¤äº†ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰ã€‚MySQLåœ¨ XA äº‹åŠ¡ä¸­çš„è§’è‰²æ˜¯å‚ä¸è€…è€Œä¸æ˜¯åè°ƒè€…ã€‚</p><h3 id="11-2-å†…éƒ¨XAäº‹åŠ¡"><a href="#11-2-å†…éƒ¨XAäº‹åŠ¡" class="headerlink" title="11.2 å†…éƒ¨XAäº‹åŠ¡"></a>11.2 å†…éƒ¨XAäº‹åŠ¡</h3><h4 id="ï¼ˆ1ï¼‰äºŒè¿›åˆ¶æ—¥å¿—åœ¨ä½¿ç”¨XAäº‹åŠ¡"><a href="#ï¼ˆ1ï¼‰äºŒè¿›åˆ¶æ—¥å¿—åœ¨ä½¿ç”¨XAäº‹åŠ¡" class="headerlink" title="ï¼ˆ1ï¼‰äºŒè¿›åˆ¶æ—¥å¿—åœ¨ä½¿ç”¨XAäº‹åŠ¡"></a>ï¼ˆ1ï¼‰äºŒè¿›åˆ¶æ—¥å¿—åœ¨ä½¿ç”¨XAäº‹åŠ¡</h4><p>MySQLæœ¬èº«çš„æ’ä»¶å¼æ¶æ„å¯¼è‡´å…¶å†…éƒ¨éœ€è¦ä½¿ç”¨XAäº‹åŠ¡ã€‚MySQLä¸­å„ä¸ªå­˜å‚¨å¼•æ“ç›¸äº’ç‹¬ç«‹ï¼Œæ— æ³•æ„ŸçŸ¥å¯¹æ–¹çš„å­˜åœ¨ï¼Œæ‰€ä»¥ä¸€ä¸ªè·¨å­˜å‚¨å¼•æ“çš„äº‹åŠ¡éœ€è¦ä¸€ä¸ªå¤–éƒ¨çš„åè°ƒè€…ï¼Œå¦åˆ™æ— æ³•æ»¡è¶³ACIDã€‚</p><p>å­˜å‚¨å¼•æ“æäº¤çš„åŒæ—¶ï¼Œéœ€è¦å°†æäº¤ä¿¡æ¯å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¯ä»¥æŠŠäºŒè¿›åˆ¶æ—¥å¿—æ“ä½œçœ‹ä½œä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨å¼•æ“ã€‚</p><h4 id="ï¼ˆ2ï¼‰XAäº‹åŠ¡å½±å“æ€§èƒ½"><a href="#ï¼ˆ2ï¼‰XAäº‹åŠ¡å½±å“æ€§èƒ½" class="headerlink" title="ï¼ˆ2ï¼‰XAäº‹åŠ¡å½±å“æ€§èƒ½"></a>ï¼ˆ2ï¼‰XAäº‹åŠ¡å½±å“æ€§èƒ½</h4><p>XAäº‹åŠ¡å¯¼è‡´MySQLæ€§èƒ½å¤§å¹…ä¸‹é™ï¼Œç›´æ¥ç ´åäº†MySQLå†…éƒ¨çš„æ‰¹é‡æäº¤ï¼ˆä¸€ç§é€šè¿‡å•ç£ç›˜I/Oæ“ä½œå®Œæˆå¤šä¸ªäº‹åŠ¡æäº¤çš„æŠ€æœ¯ï¼Œå·²æœ‰å¤šç§è§£å†³æ–¹æ¡ˆï¼‰ï¼Œä½¿å¾—MySQLä¸å¾—ä¸è¿›è¡Œå¤šæ¬¡é¢å¤–çš„ <code>fsync()</code> è°ƒç”¨ã€‚</p><p>ä¸€ä¸ªäº‹åŠ¡è‹¥æ˜¯å¼€å¯äº†äºŒè¿›åˆ¶æ—¥å¿—ï¼Œä¸ä»…éœ€è¦å¯¹äºŒè¿›åˆ¶æ—¥å¿—è¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒInnoDBäº‹åŠ¡æ—¥å¿—è¿˜éœ€è¦ä¸¤æ¬¡æ—¥å¿—æŒä¹…åŒ–æ“ä½œã€‚å³<strong>äºŒè¿›åˆ¶æ—¥å¿—å®‰å…¨çš„äº‹åŠ¡å®ç°éœ€è¦è‡³å°‘ä¸‰æ¬¡ <code>fsync()</code> æ“ä½œã€‚</strong></p><h4 id="ï¼ˆ3ï¼‰é…ç½®é¡¹"><a href="#ï¼ˆ3ï¼‰é…ç½®é¡¹" class="headerlink" title="ï¼ˆ3ï¼‰é…ç½®é¡¹"></a>ï¼ˆ3ï¼‰é…ç½®é¡¹</h4><p>å¯ä»¥é€šè¿‡å°† <code>innodb_support_xa</code> è®¾ç½®ä¸º0 å…³é—­äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆå¤åˆ¶éœ€è¦äºŒè¿›åˆ¶æ—¥å¿—å’ŒXAäº‹åŠ¡çš„æ”¯æŒï¼Œæ‰€ä»¥æ­¤è®¾ç½®ä¹Ÿä¼šä½¿å¤åˆ¶æ— æ³•ä½¿ç”¨ï¼‰ã€‚</p><p>å°† <code>sync_binlog</code> è®¾ç½®ä¸º1ï¼Œä¿è¯å­˜å‚¨å¼•æ“å’ŒäºŒè¿›åˆ¶æ—¥å¿—æ˜¯çœŸæ­£åŒæ­¥çš„ã€‚å¦åˆ™äº‹åŠ¡æäº¤äº†äºŒè¿›åˆ¶æ—¥å¿—å´å¯èƒ½æœªâ€œæäº¤â€åˆ°ç£ç›˜ã€‚</p><h3 id="11-3-å¤–éƒ¨XAäº‹åŠ¡"><a href="#11-3-å¤–éƒ¨XAäº‹åŠ¡" class="headerlink" title="11.3 å¤–éƒ¨XAäº‹åŠ¡"></a>11.3 å¤–éƒ¨XAäº‹åŠ¡</h3><p>MySQLèƒ½å¤Ÿä½œä¸ºå‚ä¸è€…å®Œæˆä¸€ä¸ªå¤–éƒ¨çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½†å…¶å¯¹XAåè®®çš„æ”¯æŒè¿˜ä¸å®Œæ•´ï¼Œå¦‚å½“å‰ç‰ˆæœ¬è¿˜ä¸æ”¯æŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šä¸ªè¿æ¥å¯ä»¥åšå…³è”ã€‚</p><p>å› ä¸ºé€šä¿¡å»¶è¿Ÿå’Œå‚ä¸è€…æœ¬èº«å¯èƒ½å¤±è´¥ï¼Œå¤–éƒ¨XAäº‹åŠ¡ä¼šæ¯”å†…éƒ¨çš„æ¶ˆè€—æ›´å¤§ã€‚å¯¹äºç½‘ç»œç¯å¢ƒä¸ç¨³å®šæˆ–ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…è€Œä¸æäº¤ï¼Œéœ€è¦é¿å…ä½¿ç”¨XAäº‹åŠ¡ï¼Œå®ƒä¼šå½±å“æ‰€æœ‰å‚ä¸è€…ã€‚</p><p>XAäº‹åŠ¡æ˜¯ä¸€ç§åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´åŒæ­¥æ•°æ®çš„æ–¹æ³•ï¼Œä¸èƒ½ä½¿ç”¨MySQLæœ¬èº«çš„å¤åˆ¶ï¼Œä»¥åŠæ€§èƒ½éç“¶é¢ˆæ—¶å¯ä»¥å°è¯•ä½¿ç”¨ã€‚</p><h2 id="åäºŒ-æŸ¥è¯¢ç¼“å­˜"><a href="#åäºŒ-æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="åäºŒ. æŸ¥è¯¢ç¼“å­˜"></a>åäºŒ. æŸ¥è¯¢ç¼“å­˜</h2><h3 id="12-1-ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜ï¼Ÿ"><a href="#12-1-ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜ï¼Ÿ" class="headerlink" title="12.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜ï¼Ÿ"></a>12.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜ï¼Ÿ</h3><p>MySQLå¯ä»¥ç¼“å­˜æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼Œç›¸åŒç±»å‹çš„SQLå¯ä»¥è·³è¿‡SQLçš„è§£æå’Œæ‰§è¡Œè®¡åˆ’ç”Ÿæˆé˜¶æ®µï¼›æŸ¥è¯¢ç¼“å­˜æ˜¯å¦ä¸€ç§ç¼“å­˜ç±»å‹ï¼Œç¼“å­˜å®Œæ•´çš„SELECTç»“æœã€‚</p><p>å‘½ä¸­æŸ¥è¯¢ç¼“å­˜åä¼šç›´æ¥è¿”å›ç»“æœï¼Œè·³è¿‡äº†è§£æã€ä¼˜åŒ–å’Œæ‰§è¡Œé˜¶æ®µã€‚</p><p>æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢æ¶‰åŠçš„æ¯å¼ è¡¨ï¼Œå½“è¡¨å‘ç”Ÿå˜åŒ–ä¼šå¯¼è‡´ç›¸å…³çš„ç¼“å­˜æ•°æ®å¤±æ•ˆï¼›è™½ç„¶çœ‹èµ·æ¥è¿™ç§å®ç°æ¯”è¾ƒä½æ•ˆç‡ï¼Œå› ä¸ºè¡¨å˜åŒ–æ—¶æœªå¿…ä¼šå¯¼è‡´æ•°æ®æŸ¥è¯¢ç»“æœæœ‰å˜æ›´ï¼Œä½†è¿™æ ·çš„å®ç°ä»£ä»·å¾ˆå°ã€‚</p><p>æŸ¥è¯¢ç¼“å­˜å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ã€‚</p><h3 id="12-2-è°¨æ…ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜"><a href="#12-2-è°¨æ…ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="12.2 è°¨æ…ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜"></a>12.2 è°¨æ…ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜</h3><p>æŸ¥è¯¢ç¼“å­˜æ˜¯ä¸€ä¸ªå½±å“æœåŠ¡å™¨æ‰©å±•æ€§çš„å› ç´ ï¼Œå¯èƒ½ä¼šå˜æˆæ•´ä¸ªæœåŠ¡å™¨çš„èµ„æºç«äº‰ç‚¹ï¼Œåœ¨å¤šæ ¸æœåŠ¡å™¨ä¸Šç”šè‡³å¯èƒ½å¯¼è‡´æœåŠ¡å™¨åƒµæ­»ã€‚é»˜è®¤å»ºè®®å…³é—­æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœåˆ¤æ–­æŸ¥è¯¢ç¼“å­˜å¾ˆæœ‰ä½œç”¨ï¼Œä¹Ÿåº”è¯¥åªé…ç½®ä¸€ä¸ªè¾ƒå°çš„æŸ¥è¯¢ç¼“å­˜ç©ºé—´ï¼ˆå¦‚å‡ åå…†ï¼‰ã€‚</p><h3 id="12-3-MySQLå¦‚ä½•åˆ¤æ–­ç¼“å­˜å‘½ä¸­ï¼Ÿ"><a href="#12-3-MySQLå¦‚ä½•åˆ¤æ–­ç¼“å­˜å‘½ä¸­ï¼Ÿ" class="headerlink" title="12.3 MySQLå¦‚ä½•åˆ¤æ–­ç¼“å­˜å‘½ä¸­ï¼Ÿ"></a>12.3 MySQLå¦‚ä½•åˆ¤æ–­ç¼“å­˜å‘½ä¸­ï¼Ÿ</h3><p>ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼å¼•ç”¨ï¼Œå“ˆå¸Œå€¼åŒ…æ‹¬æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®çš„ç‰ˆæœ¬ç­‰ä¸€äº›å…¶ä»–å¯èƒ½ä¼šå½±å“è¿”å›ç»“æœçš„ä¿¡æ¯ã€‚</p><p>å½“åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­æ—¶ï¼ŒMySQLä¸ä¼šè§£æã€æ­£è§„åŒ–æˆ–å‚æ•°åŒ–æŸ¥è¯¢è¯­å¥ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨SQLè¯­å¥å’Œå…¶ä»–æ”¶åˆ°çš„åŸå§‹ä¿¡æ¯æ¥åˆ¤æ–­ã€‚<strong>ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼Œå¦‚ç©ºæ ¼ã€æ³¨é‡Šç­‰éƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸å‘½ä¸­</strong>ã€‚</p><p>å½“æŸ¥è¯¢è¯­å¥ä¸­æœ‰ä¸€äº›ä¸ç¡®å®šçš„æ•°æ®æ—¶ï¼Œä¸ä¼šè¢«ç¼“å­˜ã€‚å¦‚å‡½æ•° <code>NOW()</code> æˆ– <code>CURRENT_DATE()</code> çš„æŸ¥è¯¢ä¸ä¼šè¢«ç¼“å­˜ï¼Œä»¥åŠ <code>CURRENT_USER</code> æˆ– <code>CONNECTION_ID()</code> ã€‚æ€»ç»“ï¼Œ<strong>æŸ¥è¯¢åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€mysqlåº“çš„ç³»ç»Ÿè¡¨ï¼Œæˆ–ä»»ä½•åŒ…å«åˆ—çº§åˆ«æƒé™çš„è¡¨ï¼Œéƒ½ä¸ä¼šè¢«ç¼“å­˜</strong>ã€‚</p><p>MySQLå¹¶ä¸è§£æSQLï¼Œå®ƒå¦‚ä½•çŸ¥é“æŸ¥è¯¢ä¸­å«æœ‰ä¸ç¡®å®šçš„å‡½æ•°ï¼ŸMySQLé€šè¿‡ä¸€ä¸ªå¤§å°å†™ä¸æ•æ„Ÿçš„æ£€æŸ¥ç¡®è®¤SQLè¯­å¥æ˜¯å¦ä»¥SELå¼€å¤´ã€‚æŸ¥è¯¢ç¼“å­˜æ˜¯åœ¨å®Œæ•´çš„SELECTè¯­å¥åŸºç¡€ä¹‹ä¸Šï¼Œåªæœ‰åœ¨åˆšæ”¶åˆ°SQLè¯­å¥æ—¶æ£€æŸ¥ï¼Œæ‰€ä»¥å­æŸ¥è¯¢å’Œå­˜å‚¨è¿‡ç¨‹éƒ½æ— æ³•ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚</p><h3 id="12-4-ä½¿ç”¨é™åˆ¶"><a href="#12-4-ä½¿ç”¨é™åˆ¶" class="headerlink" title="12.4 ä½¿ç”¨é™åˆ¶"></a>12.4 ä½¿ç”¨é™åˆ¶</h3><ul><li>å¼€å¯æŸ¥è¯¢ç¼“å­˜ä¼šå¯¹è¯»å†™æ“ä½œéƒ½å¸¦æ¥é¢å¤–çš„æ¶ˆè€—ï¼š<ul><li>è¯»æŸ¥è¯¢åœ¨å¼€å§‹å‰è¦æ£€æŸ¥æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼›</li><li>è¯»æŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼Œåœ¨æ‰§è¡Œå®Œæˆåï¼ŒMySQLæ£€æŸ¥è¿˜æœªè¢«ç¼“å­˜ï¼Œä¼šå°†ç»“æœå­˜å…¥æŸ¥è¯¢ç¼“å­˜ï¼›</li><li>å‘æŸä¸ªè¡¨å†™å…¥æ•°æ®æ—¶ï¼ŒMySQLè¦å°†ç›¸å…³ç¼“å­˜è®¾ç½®å¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜å¾ˆå¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤š</li></ul></li><li>å¯¹æŸ¥è¯¢ç¼“å­˜æ“ä½œæ˜¯ä¸€ä¸ªåŠ é”æ’ä»–æ“ä½œã€‚</li><li>äº‹åŠ¡ä¸­ä¿®æ”¹æŸè¡¨ä¼šä½¿å¯¹åº”æŸ¥è¯¢ç¼“å­˜éƒ½è®¾ç½®å¤±æ•ˆï¼Œä½†InnoDBçš„å¤šç‰ˆæœ¬ç‰¹æ€§ä¼šæš‚æ—¶å°†è¿™ä¸ªä¿®æ”¹å¯¹å…¶ä»–äº‹åŠ¡å±è”½ï¼Œæ­¤äº‹åŠ¡æäº¤å‰ï¼Œè¿™ä¸ªè¡¨çš„ç›¸å…³æŸ¥è¯¢æ— æ³•è¢«ç¼“å­˜ï¼Œåªèƒ½åœ¨äº‹åŠ¡æäº¤åæ‰è¢«ç¼“å­˜ã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ä¼šå¤§å¤§é™ä½æŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚</li><li>æŸ¥è¯¢ç¼“å­˜å¯èƒ½ä¼šä½¿ç”¨å¤§é‡çš„å†…å­˜ï¼Œå¹¶ä¸”å› ä¸ºæ“ä½œé ä¸€ä¸ªå…¨å±€é”ä¿æŠ¤ï¼Œæ‰€æœ‰éœ€è¦åšè¯¥æ“ä½œçš„æŸ¥è¯¢éƒ½è¦ç­‰å¾…è¿™ä¸ªé”ã€‚</li></ul><h3 id="12-5-æŸ¥è¯¢ç¼“å­˜å¦‚ä½•ä½¿ç”¨å†…å­˜"><a href="#12-5-æŸ¥è¯¢ç¼“å­˜å¦‚ä½•ä½¿ç”¨å†…å­˜" class="headerlink" title="12.5 æŸ¥è¯¢ç¼“å­˜å¦‚ä½•ä½¿ç”¨å†…å­˜"></a>12.5 æŸ¥è¯¢ç¼“å­˜å¦‚ä½•ä½¿ç”¨å†…å­˜</h3><p>æŸ¥è¯¢ç¼“å­˜å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚é™¤äº†æŸ¥è¯¢ç»“æœï¼Œè¿˜è¦å­˜æ”¾ä¸€äº›ç»´æŠ¤ç›¸å…³çš„æ•°æ®ï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿï¼šï¼ˆå¤§æ¦‚éœ€è¦40KBçš„å†…å­˜èµ„æºï¼‰</p><ul><li>ç¡®å®šå“ªäº›å†…å­˜ç›®å‰å¯ç”¨ï¼›</li><li>å“ªäº›å·²ç»ç”¨æ‰ï¼›</li><li>å“ªäº›ç”¨æ¥å­˜å‚¨æ•°æ®è¡¨å’ŒæŸ¥è¯¢ç»“æœä¹‹å‰çš„æ˜ å°„ï¼›</li><li>å“ªäº›ç”¨æ¥å­˜å‚¨æ•°æ®è¡¨å’ŒæŸ¥è¯¢ç»“æœä¹‹å‰çš„æ˜ å°„ï¼›</li><li>å“ªäº›ç”¨æ¥å­˜å‚¨æŸ¥è¯¢å­—ç¬¦ä¸²å’ŒæŸ¥è¯¢ç»“æœã€‚</li></ul><p>MySQLç”¨äºæŸ¥è¯¢ç¼“å­˜çš„å†…å­˜è¢«åˆ†ä¸ºä¸€ä¸ªä¸ªçš„æ•°æ®å—ï¼Œæ•°æ®å—æ˜¯å˜é•¿çš„ã€‚æ¯ä¸ªæ•°æ®å—å­˜å‚¨äº†è‡ªå·±çš„ç±»å‹ã€å¤§å°å’Œæ•°æ®æœ¬èº«ï¼Œè¿˜å¤–åŠ æŒ‡å‘å‰ä¸€ä¸ªå’Œåä¸€ä¸ªæ•°æ®å—çš„æŒ‡é’ˆã€‚</p><p>æ•°æ®å—ç±»å‹ï¼šä¸åŒå­˜å‚¨å—åœ¨å†…å­˜ä½¿ç”¨ä¸Šæ²¡æœ‰ä¸åŒ</p><ul><li>å­˜å‚¨æŸ¥è¯¢ç»“æœ</li><li>å­˜å‚¨æŸ¥è¯¢å’Œæ•°æ®è¡¨çš„æ˜ å°„</li><li>å­˜å‚¨æŸ¥è¯¢æ–‡æœ¬</li></ul><p>ä½¿ç”¨æµç¨‹ï¼š</p><ul><li>æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå…ˆåˆå§‹åŒ–æŸ¥è¯¢ç¼“å­˜éœ€è¦çš„å†…å­˜ï¼Œå†…å­˜æ± åˆå§‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç©ºé—²å—ã€‚ç©ºé—²å—çš„å¤§å°å°±æ˜¯æ‰€é…ç½®æŸ¥è¯¢ç¼“å­˜å¤§å°å†å‡å»ç”¨äºç»´æŠ¤å…ƒæ•°æ®çš„æ•°æ®ç»“æ„æ‰€æ¶ˆè€—çš„ç©ºé—´ã€‚</li><li>å½“æœ‰æŸ¥è¯¢ç»“æœéœ€è¦ç¼“å­˜æ—¶ï¼ŒMySQLå…ˆä»å¤§çš„ç©ºé—´å—ä¸­ç”³è¯·ä¸€ä¸ªæ•°æ®å—ç”¨äºå­˜å‚¨ç»“æœã€‚è¿™ä¸ªæ•°æ®å—éœ€è¦å¤§äºé…ç½® <code>query_cache_min_res_unit</code> ï¼Œå³ä½¿æŸ¥è¯¢ç»“æœè¿œè¿œå°äºæ­¤ã€‚å› ä¸ºéœ€è¦åœ¨æŸ¥è¯¢å¼€å§‹è¿”å›ç»“æœçš„æ—¶å€™å°±åˆ†é…ç©ºé—´ï¼Œæ­¤æ—¶æ˜¯æ— æ³•é¢„çŸ¥æŸ¥è¯¢ç»“æœæœ‰å¤šå¤§ï¼ŒMySQLæ— æ³•ä¸ºæ¯ä¸ªæŸ¥è¯¢ç»“æœç²¾ç¡®åˆ†é…ç©ºé—´ã€‚</li></ul><p>åˆ†é…å†…å­˜å—æ“ä½œå¾ˆæ…¢ï¼Œéœ€è¦å…ˆé”ä½ç©ºé—´å—ï¼Œç„¶åæ‰¾åˆ°åˆé€‚å¤§å°çš„æ•°æ®å—ã€‚å½“éœ€è¦ç¼“å­˜ä¸€ä¸ªæŸ¥è¯¢ç»“æœæ—¶ï¼ŒMySQLå…ˆé€‰æ‹©ä¸€ä¸ªå°½å¯èƒ½å°çš„å†…å­˜å—ï¼Œç„¶åå°†ç»“æœå­˜å…¥å…¶ä¸­ã€‚å¦‚æœæ•°æ®å—å…¨éƒ¨ç”¨å®Œï¼Œä½†ä»æœ‰æ•°æ®éœ€è¦å­˜å‚¨ï¼ŒMySQLä¼šç”³è¯·ä¸€å—æ–°æ•°æ®å—ï¼ˆå°½é‡å°ï¼‰ã€‚æŸ¥è¯¢å®Œæˆåæœ‰å‰©ä½™ä¼šè¢«é‡Šæ”¾ã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210201/202102010102.png"></p><p>ä¸Šè¿°åˆ†é…å†…å­˜å—å¹¶éæŒ‡<strong>é€šè¿‡å‡½æ•° <code>malloc()</code> å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜</strong>ï¼Œæ­¤æ“ä½œåªåœ¨åˆæ¬¡åˆ›å»ºæŸ¥è¯¢ç¼“å­˜æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚æŒ‡çš„æ˜¯åœ¨ç©ºé—²å—åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å†…å­˜å—ï¼Œæˆ–è€…ä»æ­£åœ¨ä½¿ç”¨çš„ã€å¾…æ·˜æ±°çš„å†…å­˜å—ä¸­å›æ”¶å†ä½¿ç”¨ï¼ˆMySQLè‡ªå·±ç®¡ç†å†…å­˜ï¼‰ã€‚</p><p>å‡è®¾å¹³å‡æŸ¥è¯¢ç»“æœå¾ˆå°ï¼ŒæœåŠ¡å™¨åœ¨å¹¶å‘åœ°å‘ä¸åŒçš„ä¸¤ä¸ªè¿æ¥è¿”å›ç»“æœï¼Œè¿”å›ç»“æœåMySQLå›æ”¶å‰©ä½™æ•°æ®å—ç©ºé—´æ—¶ä¼šå‘ç°ï¼Œå›æ”¶çš„æ•°æ®å—å°äº <code>query_cache_min_res_unit</code> ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åœ¨åç»­çš„å†…å­˜å—ä¸­åˆ†é…ä½¿ç”¨ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210201/202102010103.png"></p><h3 id="12-6-é€‚ç”¨åœºæ™¯"><a href="#12-6-é€‚ç”¨åœºæ™¯" class="headerlink" title="12.6 é€‚ç”¨åœºæ™¯"></a>12.6 é€‚ç”¨åœºæ™¯</h3><p>ç†è®ºä¸Šå¯ä»¥é€šè¿‡å¯¹æ¯”æ‰“å¼€å’Œå…³é—­æŸ¥è¯¢ç¼“å­˜çš„ç³»ç»Ÿæ•ˆç‡æ¥åˆ¤æ–­ï¼šå…³é—­æŸ¥è¯¢ç¼“å­˜æ—¶ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½éœ€è¦å®Œæ•´çš„æ‰§è¡Œï¼Œæ¯æ¬¡å†™æ“ä½œæ‰§è¡Œå®Œæˆåç«‹åˆ»è¿”å›ï¼›æ‰“å¼€æŸ¥è¯¢ç¼“å­˜æ—¶ï¼Œæ¯æ¬¡è¯»è¯·æ±‚å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœå‘½ä¸­åˆ™ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™å°±å®Œæ•´åœ°æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ¯æ¬¡å†™æ“ä½œåˆ™éœ€è¦æ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯å¦æœ‰éœ€è¦å¤±æ•ˆçš„ç¼“å­˜ï¼Œç„¶åå†è¿”å›ã€‚</p><p>å¯¹äºä¸€äº›éœ€è¦æ¶ˆè€—å¤§é‡èµ„æºçš„æŸ¥è¯¢é€šå¸¸éƒ½é€‚åˆä½¿ç”¨ç¼“å­˜ï¼Œå¦‚æ±‡æ€»è®¡ç®—æŸ¥è¯¢ <code>COUNT()</code> ï¼›è¾ƒä¸ºå¤æ‚çš„SELECTè¯­å¥ï¼Œå¦‚å¤šè¡¨JOINåè¿˜éœ€è¦åšæ’åºå’Œåˆ†é¡µï¼Œæ­¤ç±»æŸ¥è¯¢æ¯æ¬¡æ‰§è¡Œæ¶ˆè€—éƒ½å¾ˆå¤§ï¼Œä½†è¿”å›ç»“æœé›†å¾ˆå°ï¼Œéå¸¸é€‚åˆæŸ¥è¯¢ç¼“å­˜ï¼ˆUPDATEã€DELETE å’Œ INSERT æ“ä½œè¦å æ¯”å°ï¼‰ã€‚</p><p>ä¸€ä¸ªåˆ¤æ–­æŸ¥è¯¢ç¼“å­˜æ˜¯å¦æœ‰æ•ˆçš„ç›´æ¥æ•°æ®æ˜¯å‘½ä¸­ç‡ï¼Œå³ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœå æ€»æŸ¥è¯¢çš„æ¯”ç‡ã€‚å½“MySQLæ¥æ”¶åˆ°ä¸€ä¸ªSELECTæŸ¥è¯¢æ—¶ï¼Œè¦ä¹ˆå¢åŠ  <code>Qcache_hits</code> çš„å€¼ï¼Œè¦ä¹ˆå¢åŠ  <code>Com_select</code> çš„å€¼ã€‚è®¡ç®—æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡ï¼š <code>Qcache_hits / ( Qcache_hits + Com_select )</code> ã€‚å‘½ä¸­ç‡å¤šå¤§æ‰åˆé€‚å¾ˆéš¾åˆ¤æ–­ï¼Œæœ‰æ—¶å³ä½¿å¾ˆä½çš„å‘½ä¸­ç‡å¯¹äºæ€§èƒ½æå‡ä¹Ÿæœ‰å¥½å¤„ã€‚</p><p>ç¼“å­˜æœªå‘½ä¸­çš„å‡ ç§å¯èƒ½ï¼š</p><ul><li>æŸ¥è¯¢è¯­å¥æ— æ³•è¢«ç¼“å­˜ï¼Œå¦‚åŒ…å«ä¸ç¡®å®šçš„å‡½æ•°ã€æŸ¥è¯¢ç»“æœå¤ªå¤§è€Œæ— æ³•ç¼“å­˜ï¼Œéƒ½ä¼šå¯¼è‡´çŠ¶æ€å€¼ <code>Qcache_not_cached</code> å¢åŠ ã€‚</li><li>MySQLä»æœªå¤„ç†è¿™ä¸ªæŸ¥è¯¢ï¼Œæ‰€ä»¥ç»“æœä¹Ÿä¸æ›¾è¢«ç¼“å­˜è¿‡ã€‚</li><li>è™½ç„¶ç¼“å­˜äº†ç»“æœï¼Œä½†ç”±äºæŸ¥è¯¢ç¼“å­˜çš„å†…å­˜ç”¨å®Œï¼Œéœ€è¦å°†æŸäº›ç¼“å­˜ç§»é™¤ï¼›æˆ–æ˜¯æ•°æ®è¡¨è¢«ä¿®æ”¹å¯¼è‡´ç¼“å­˜å¤±æ•ˆã€‚</li><li>å¤§é‡ç¼“å­˜æœªå‘½ä¸­ï¼Œä½†å®é™…ä¸Šç»å¤§æ•°æŸ¥è¯¢éƒ½ç¼“å­˜äº†ï¼š<ul><li>æŸ¥è¯¢ç¼“å­˜è¿˜æœªå®Œæˆé¢„çƒ­ï¼›</li><li>æŸ¥è¯¢è¯­å¥ä¹‹å‰ä»æœªæ‰§è¡Œï¼Œè‹¥åº”ç”¨ä¸ä¼šé‡å¤æ‰§è¡Œä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼Œå³ä½¿å®Œæˆé¢„çƒ­ä»ä¼šæœ‰å¾ˆå¤šç¼“å­˜æœªå‘½ä¸­ï¼›</li><li>ç¼“å­˜å¤±æ•ˆæ“ä½œè¿‡å¤šã€‚</li></ul></li></ul><p>å‡ ç§æ£€æŸ¥æ–¹æ¡ˆï¼š</p><ul><li>é€šè¿‡å‚æ•° <code>Com_*</code> æ¥æŸ¥çœ‹æ•°æ®ä¿®æ”¹çš„æƒ…å†µï¼ŒåŒ…æ‹¬ Com_updateï¼ŒCom_deleteç­‰ã€‚</li><li>é€šè¿‡ <code>Qcache_lowmem_prunes</code> æ¥æŸ¥çœ‹æœ‰å¤šå°‘æ¬¡å¤±æ•ˆæ˜¯ç”±äºå†…å­˜ä¸è¶³å¯¼è‡´çš„ã€‚</li><li>é€šè¿‡æŸ¥çœ‹ <code>Com_select</code> å’Œ <code>Qcache_inserts</code> çš„ç›¸å¯¹å€¼æ¥æŸ¥çœ‹æ˜¯å¦ç¼“å­˜ç»“æœæœªè¢«å…¶ä»–SELECTè¯­å¥ä½¿ç”¨ã€‚å¦‚æœæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯ç¼“å­˜æœªå‘½ä¸­ï¼Œç„¶åéœ€è¦å°†æŸ¥è¯¢ç»“æœæ”¾åˆ°ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆäºŒè€…å€¼åº”è¯¥ç›¸å½“ï¼Œæ‰€ä»¥æœŸæœ›çš„æƒ…å†µåº”è¯¥æ˜¯ <code>Qcache_inserts</code> è¿œè¿œå°äº <code>Com_select</code> ã€‚</li><li>æ›´ç›´è§‚çš„æ–¹æ¡ˆï¼šå‘½ä¸­å’Œå†™å…¥çš„æ¯”ç‡ï¼Œå³ <code>Qcache_hits</code> å’Œ <code>Qcache_inserts</code> çš„æ¯”å€¼ï¼Œå½“ç»“æœå¤§äº3 : 1æ—¶ä¸€èˆ¬è¡¨ç¤ºç¼“å­˜æ˜¯æœ‰æ•ˆçš„ï¼Œæœ€å¥½æ˜¯èƒ½è¾¾åˆ°10 : 1ã€‚</li></ul><h3 id="12-7-é…ç½®å’Œç»´æŠ¤"><a href="#12-7-é…ç½®å’Œç»´æŠ¤" class="headerlink" title="12.7 é…ç½®å’Œç»´æŠ¤"></a>12.7 é…ç½®å’Œç»´æŠ¤</h3><p>é…ç½®å‚æ•°ï¼š</p><ul><li>query_cache_typeï¼šæ˜¯å¦æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œæœ‰ OFFã€ONæˆ–DEMANDï¼ŒDEMANDè¡¨ç¤ºåªæœ‰åœ¨æŸ¥è¯¢è¯­å¥ä¸­æ˜ç¡®å†™æ˜SQL_CACHEçš„è¯­å¥æ‰æ”¾å…¥æŸ¥è¯¢ç¼“å­˜ã€‚</li><li>query_cache_sizeï¼šæŸ¥è¯¢ç¼“å­˜ä½¿ç”¨çš„æ€»å†…å­˜ç©ºé—´ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¿…é¡»æ˜¯1024çš„æ•´æ•°å€ã€‚</li><li>query_cache_min_res_unitï¼šåœ¨æŸ¥è¯¢ç¼“å­˜ä¸­åˆ†é…å†…å­˜å—æ—¶çš„æœ€å°å•ä½ã€‚</li><li>query_cache_limitï¼šMySQLèƒ½ç¼“å­˜çš„æœ€å¤§æŸ¥è¯¢ç»“æœï¼Œè¶…è¿‡æ­¤å€¼ä¸ä¼šè¢«ç¼“å­˜ï¼Œåªæœ‰ç»“æœå…¨éƒ¨è¿”å›æ—¶æ‰èƒ½çŸ¥é“æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚</li><li>query_cache_wlock_invalidateï¼šæŸä¸ªè¡¨è¢«å…¶ä»–è¿æ¥é”ä½ï¼Œæ˜¯å¦ä¾ç„¶å¯ä»¥ä»æŸ¥è¯¢ç¼“å­˜ä¸­è¿”å›ç»“æœã€‚</li></ul><p>å¦‚ä½•å‡å°‘ç¢ç‰‡ï¼šæš‚ç•¥ã€‚</p><p>æä¾›æŸ¥è¯¢ç¼“å­˜çš„ä½¿ç”¨ç‡ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210201/202102010104.png"></p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šé«˜æ€§èƒ½MySQLã€‹</p>]]></content>
    
    
    <summary type="html">ã€Šé«˜æ€§èƒ½MySQLã€‹è¯»ä¹¦ç¬”è®°ï¼Œå†…å®¹ï¼šåˆ†åŒºè¡¨ï¼Œè§†å›¾ï¼Œå¤–é”®çº¦æŸï¼Œå†…éƒ¨å­˜å‚¨ä»£ç ï¼Œæ¸¸æ ‡ï¼Œç»‘å®šå˜é‡ï¼Œç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼Œå…¨æ–‡ç´¢å¼•ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŸ¥è¯¢ç¼“å­˜ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆäº”ï¼‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–</title>
    <link href="http://linyishui.top/2020122901.html"/>
    <id>http://linyishui.top/2020122901.html</id>
    <published>2020-12-29T12:13:34.000Z</published>
    <updated>2021-03-03T13:14:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆäº”ï¼‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–"><a href="#ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆäº”ï¼‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆäº”ï¼‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–"></a>ã€Šé«˜æ€§èƒ½MySQLã€‹ï¼ˆäº”ï¼‰æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–</h1><p>æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–ã€åº“è¡¨ç»“æ„ä¼˜åŒ–éœ€è¦é½å¤´å¹¶è¿›ã€‚</p><h2 id="ä¸€-ä¸ºä»€ä¹ˆæŸ¥è¯¢é€Ÿåº¦ä¼šæ…¢"><a href="#ä¸€-ä¸ºä»€ä¹ˆæŸ¥è¯¢é€Ÿåº¦ä¼šæ…¢" class="headerlink" title="ä¸€. ä¸ºä»€ä¹ˆæŸ¥è¯¢é€Ÿåº¦ä¼šæ…¢"></a>ä¸€. ä¸ºä»€ä¹ˆæŸ¥è¯¢é€Ÿåº¦ä¼šæ…¢</h2><p>æŸ¥è¯¢æ˜¯ä¸€é¡¹ä»»åŠ¡ï¼Œç”±ä¸€ç³»åˆ—å­ä»»åŠ¡ç»„æˆï¼Œæ¯ä¸ªå­ä»»åŠ¡éƒ½è¦æ¶ˆè€—ä¸€å®šæ—¶é—´ï¼Œä¼˜åŒ–æŸ¥è¯¢å°±æ˜¯è¦ä¹ˆæ¶ˆé™¤ä¸€éƒ¨åˆ†å­ä»»åŠ¡ã€è¦ä¹ˆå‡å°‘å­ä»»åŠ¡çš„æ‰§è¡Œæ¬¡æ•°ã€è¦ä¹ˆæä¾›å­ä»»åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ã€‚</p><p>æŸ¥è¯¢çš„ç”Ÿå‘½å‘¨æœŸå¤§è‡´åŒ…æ‹¬ï¼šä»å®¢æˆ·ç«¯ã€åˆ°æœåŠ¡å™¨ã€æœåŠ¡å™¨è¿›è¡Œè§£æã€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€æ‰§è¡Œã€è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚å…¶ä¸­æ‰§è¡Œæ˜¯æœ€é‡è¦çš„é˜¶æ®µï¼ŒåŒ…æ‹¬å¤§é‡æ£€ç´¢æ•°æ®åˆ°å­˜å‚¨å¼•æ“ä»¥åŠåç»­æ•°æ®å¤„ç†ï¼Œå¦‚æ’åºã€åˆ†ç»„ç­‰ã€‚</p><p>æŸ¥è¯¢ä¼šåœ¨å¦‚ç½‘ç»œã€CPUè®¡ç®—ã€ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯å’Œæ‰§è¡Œè®¡åˆ’ã€é”ç­‰å¾…ï¼ˆäº’æ–¥ç­‰å¾…ï¼‰ç­‰æ“ä½œä¸ŠèŠ±è´¹æ—¶é—´ã€‚æ…¢æŸ¥è¯¢æ™®ééƒ½ä¼šå­˜åœ¨å¦‚æ“ä½œè¢«é¢å¤–çš„é‡å¤æ‰§è¡Œäº†å¤šæ¬¡ã€æŸäº›æ“ä½œæ‰§è¡Œçš„å¤ªæ…¢ç­‰é—®é¢˜ã€‚</p><h2 id="äºŒ-ä¼˜åŒ–æ•°æ®è®¿é—®"><a href="#äºŒ-ä¼˜åŒ–æ•°æ®è®¿é—®" class="headerlink" title="äºŒ. ä¼˜åŒ–æ•°æ®è®¿é—®"></a>äºŒ. ä¼˜åŒ–æ•°æ®è®¿é—®</h2><p>å¤§éƒ¨åˆ†æ€§èƒ½ä½ä¸‹çš„æŸ¥è¯¢éƒ½å¯ä»¥é€šè¿‡å‡å°‘è®¿é—®çš„æ•°æ®é‡æ¥ä¼˜åŒ–ï¼š</p><ol><li>æ£€æŸ¥æ˜¯å¦è®¿é—®äº†å¤ªå¤šçš„è¡Œæˆ–åˆ—ï¼›</li><li>ç¡®è®¤MySQLæœåŠ¡å™¨å±‚æ˜¯å¦åœ¨åˆ†æå¤§é‡è¶…è¿‡éœ€è¦çš„æ•°æ®è¡Œã€‚</li></ol><h3 id="2-1-æ˜¯å¦å‘æ•°æ®åº“è¯·æ±‚äº†ä¸éœ€è¦çš„æ•°æ®"><a href="#2-1-æ˜¯å¦å‘æ•°æ®åº“è¯·æ±‚äº†ä¸éœ€è¦çš„æ•°æ®" class="headerlink" title="2.1 æ˜¯å¦å‘æ•°æ®åº“è¯·æ±‚äº†ä¸éœ€è¦çš„æ•°æ®"></a>2.1 æ˜¯å¦å‘æ•°æ®åº“è¯·æ±‚äº†ä¸éœ€è¦çš„æ•°æ®</h3><ul><li><strong>æŸ¥è¯¢ä¸éœ€è¦çš„è®°å½•</strong>ï¼šæ¯”å¦‚æŸ¥è¯¢å¤§é‡æ•°æ®åï¼Œå†ä»…æ˜¾ç¤ºå‰é¢Nè¡Œã€‚æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯æŸ¥è¯¢åŠ LIMITã€‚</li><li><strong>å¤šè¡¨å…³è”æ—¶è¿”å›å…¨éƒ¨åˆ—</strong>ï¼šæ¯”å¦‚ SELECT * FROM A JOIN B JOIN C ï¼Œå®é™…ä¸Šä»…éœ€è¦Aè¡¨çš„åˆ—ï¼Œæ”¹ä¸º SELECT A.* æœ€å¥½æ˜ç¡®æŒ‡å®šæ¯ä¸ªè¿”å›åˆ—ã€‚</li><li><strong>æ€»æ˜¯å–å‡ºå…¨éƒ¨åˆ—</strong>ï¼šæ¯æ¬¡ä½¿ç”¨ <code>SELECT *</code> æ—¶éƒ½è¦ä»”ç»†æ€è€ƒæ˜¯å¦éœ€è¦å…¨éƒ¨åˆ—ï¼Œæœ‰æ—¶DBAä¼šç¦æ­¢ç±»ä¼¼å†™æ³•ã€‚</li><li><strong>é‡å¤æŸ¥è¯¢ç›¸åŒçš„æ•°æ®</strong>ï¼šæ¯”å¦‚ç”¨æˆ·è¯„è®ºæ—¶è¦è·å–å¤´åƒURLï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜è¿™ç±»æ•°æ®ï¼Œé¿å…æ¯æ¬¡éƒ½è¦é‡å¤æŸ¥è¯¢ã€‚</li></ul><h3 id="2-2-æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•"><a href="#2-2-æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•" class="headerlink" title="2.2 æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•"></a>2.2 æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•</h3><p>è¡¡é‡æŸ¥è¯¢å¼€é”€çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼šæ…¢æŸ¥è¯¢æ—¥å¿—åŒ…å«è¿™ä¸‰é¡¹å†…å®¹</p><ul><li><strong>å“åº”æ—¶é—´</strong>ï¼šæœåŠ¡æ—¶é—´+æ’é˜Ÿæ—¶é—´ï¼Œä½†å®é™…æµ‹é‡å¾€å¾€æ— æ³•åŒºåˆ†äºŒè€…ï¼›</li><li><strong>æ‰«æçš„è¡Œæ•°</strong>ï¼šEXPLAINçš„typeåˆ—ååº”äº†è®¿é—®ç±»å‹ï¼Œå¦‚å…¨è¡¨æ‰«æã€ç´¢å¼•æ‰«æã€èŒƒå›´æ‰«æã€å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ã€å¸¸æ•°å¼•ç”¨ç­‰ï¼Œé€Ÿåº¦ç”±æ…¢è‡³å¿«ï¼Œæ‰«æè¡Œæ•°ç”±å¤šåˆ°å°‘ï¼›è®¿é—®ç±»å‹ä¸å¤Ÿåˆé€‚æ—¶ï¼Œæœ€å¥½åˆ›å»ºä¸€ä¸ªåˆé€‚çš„ç´¢å¼•ï¼›<strong>MySQLä¸ä¼šè¿”å›çœŸå®çš„æ‰«æè¡Œæ•°ï¼Œåªä¼šå‘ŠçŸ¥ç”Ÿæˆç»“æœæ—¶ä¸€å…±æ‰«æäº†å¤šå°‘è¡Œï¼Œä½†å¯èƒ½å¤§éƒ¨åˆ†è¡Œæ˜¯è¢«WHEREæ¡ä»¶è¿‡æ»¤</strong>ï¼›</li><li><strong>è¿”å›çš„è¡Œæ•°</strong>ï¼šæ‰«æçš„è¡Œæ•°å’Œè¿”å›è¡Œæ•°çš„æ¯”å€¼é€šå¸¸åº”è¯¥å¾ˆå°ï¼Œä»‹äº1:1å’Œ1:10ä¹‹é—´ï¼Œå½“ç„¶æœ‰æ—¶ä¹Ÿä¼šå¾ˆå¤§ï¼ˆæ¯”å¦‚åˆ†ç»„ç»Ÿè®¡æŸ¥è¯¢ï¼‰ã€‚</li></ul><p>EXPLAINçš„ Using where è¡¨ç¤ºMySQLå°†é€šè¿‡WHEREæ¡ä»¶ç­›é€‰å­˜å‚¨å¼•æ“è¿”å›çš„è®°å½•ï¼ŒMySQLåº”ç”¨Whereæ¡ä»¶æœ‰ä¸‰ç§æ–¹å¼ï¼Œç”±å¥½åˆ°åä¾æ¬¡æ˜¯ï¼š</p><ol><li>åœ¨ç´¢å¼•ä¸­ä½¿ç”¨WHEREæ¡ä»¶æ¥è¿‡æ»¤ä¸åŒ¹é…çš„è®°å½•ï¼Œåœ¨å­˜å‚¨å¼•æ“å±‚å®Œæˆã€‚</li><li>ä½¿ç”¨ç´¢å¼•è¦†ç›–æ‰«æï¼ˆExtraåˆ—å‡ºç°Using indexï¼‰è¿”å›è®°å½•ï¼Œç›´æ¥ä»ç´¢å¼•ä¸­è¿‡æ»¤ä¸éœ€è¦çš„è®°å½•å¹¶è¿”å›å‘½ä¸­çš„ç»“æœï¼Œåœ¨æœåŠ¡å™¨å±‚å®Œæˆï¼Œä½†æ— éœ€å›è¡¨æŸ¥è¯¢è®°å½•ã€‚</li><li>ä»æ•°æ®è¡¨è¿”å›æ•°æ®ï¼Œè¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼ˆExtraåˆ—å‡ºç°Using whereï¼‰ï¼Œåœ¨æœåŠ¡å™¨å±‚å®Œæˆï¼Œéœ€è¦å…ˆä»æ•°æ®è¡¨è¯»å‡ºè®°å½•ç„¶åè¿‡æ»¤ã€‚</li></ol><p>æ‰«æè¡Œæ•°è¿œè¿œå¤§äºè¿”å›è¡Œæ•°ï¼Œéœ€è¦ä¼˜åŒ–ï¼š</p><ul><li>ä½¿ç”¨ç´¢å¼•è¦†ç›–æ‰«æã€‚</li><li>æ”¹å˜åº“è¡¨ç»“æ„ï¼Œå¦‚ä½¿ç”¨å•ç‹¬çš„æ±‡æ€»è¡¨ã€‚</li><li>é‡å†™å¤æ‚æŸ¥è¯¢ï¼Œè®©MySQLä¼˜åŒ–å™¨å¯ä»¥ä»¥æ›´ä¼˜åŒ–çš„æ–¹å¼æ‰§è¡Œã€‚</li></ul><h3 id="2-3-é‡æ„æŸ¥è¯¢çš„æ–¹å¼"><a href="#2-3-é‡æ„æŸ¥è¯¢çš„æ–¹å¼" class="headerlink" title="2.3 é‡æ„æŸ¥è¯¢çš„æ–¹å¼"></a>2.3 é‡æ„æŸ¥è¯¢çš„æ–¹å¼</h3><h4 id="2-3-1-åˆ¤æ–­ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢"><a href="#2-3-1-åˆ¤æ–­ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢" class="headerlink" title="2.3.1 åˆ¤æ–­ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢"></a>2.3.1 åˆ¤æ–­ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢</h4><p>è®¾è®¡æŸ¥è¯¢æ—¶éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæ˜¯å¦éœ€è¦å°†ä¸€ä¸ªå¤æ‚æŸ¥è¯¢æ‹†åˆ†ä¸ºå¤šä¸ªç®€å•æŸ¥è¯¢ï¼Ÿæˆ‘ä»¬æ™®éä¼šé€‰æ‹©è®©æ•°æ®åº“å°½å¯èƒ½çš„å®Œæˆæ›´å¤šçš„å·¥ä½œï¼Œå› ä¸ºä¸‹æ„è¯†ä¼šè®¤ä¸ºç½‘ç»œé€šä¿¡ã€æŸ¥è¯¢è§£æå’Œä¼˜åŒ–æ˜¯ä¸€ä»¶ä»£ä»·å¾ˆé«˜çš„äº‹æƒ…ã€‚</p><p>ä½†å¯¹äºMySQLæ¥è¯´ï¼Œè¿™ç§å¸¸è¯†æ˜¯ä¸å‡†ç¡®çš„ï¼š</p><ol><li>MySQLçš„è¿æ¥å’Œæ–­å¼€éƒ½å¾ˆè½»é‡ï¼›</li><li>ç°ä»£ç½‘ç»œé€Ÿåº¦è¶Šæ¥è¶Šå¿«ï¼Œæ— è®ºæ˜¯å¸¦å®½è¿˜æ˜¯å»¶è¿Ÿï¼›</li><li>MySQLæ¯ç§’èƒ½åœ¨å†…å­˜æ‰«æä¸Šç™¾ä¸‡è¡Œæ•°æ®ï¼Œç›¸æ¯”ä¸‹å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯è¦æ…¢å¾ˆå¤šï¼Œå…¶ä»–æ¡ä»¶ä¸å˜çš„æƒ…å†µä¸‹è¶Šå°‘æŸ¥è¯¢æ˜¯æ›´å¥½ï¼›</li><li>ä¸€äº›æƒ…å†µä¸‹åˆ‡ä¸ºå°æŸ¥è¯¢èƒ½å‡å°‘å·¥ä½œé‡ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¸¦æ¥æ•´ä½“æ€§èƒ½çš„æå‡ï¼Œå°äº‹åŠ¡ç»å¸¸èƒ½æ›´é«˜æ•ˆï¼Œå¹¶ä¸”è‹¥ä¸­é—´æš‚åœä¸€æ®µæ—¶é—´ï¼Œä¹Ÿå¯ä»¥æŠŠä¸€æ¬¡æ€§çš„å‹åŠ›åˆ†æ•£åˆ°å¤§çš„æ—¶é—´æ®µï¼Œé™ä½å¯¹æœåŠ¡å™¨çš„å½±å“å’Œé”çš„æŒæœ‰æ—¶é—´ã€‚</li></ol><h4 id="2-3-2-åˆ‡åˆ†æŸ¥è¯¢"><a href="#2-3-2-åˆ‡åˆ†æŸ¥è¯¢" class="headerlink" title="2.3.2 åˆ‡åˆ†æŸ¥è¯¢"></a>2.3.2 åˆ‡åˆ†æŸ¥è¯¢</h4><p>æœ€å¸¸è§çš„æ¡ˆä¾‹ï¼Œæ¯”å¦‚è¦<strong>å®šæœŸæ¸…é™¤å¤§é‡æ•°æ®</strong>ï¼Œå¦‚æœä¸€ä¸ªè¯­å¥ä¸€æ¬¡å®Œæˆå¯èƒ½ä¼šé”ä½å¾ˆå¤šæ•°æ®ã€å æ»¡æ•´ä¸ªäº‹åŠ¡æ—¥å¿—ã€æ¶ˆè€—è¿‡å¤šç³»ç»Ÿèµ„æºã€é˜»å¡å¾ˆå¤šå°ä½†é‡è¦çš„æŸ¥è¯¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯ä¸€ä¸‡è¡Œåˆ é™¤ä¸€æ¬¡</span></span><br><span class="line">rows_affected = <span class="number">0</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">rows_affected = do_query(<span class="string">&quot;DELETE FROM messages WHERE created &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">while</span> rows_affected &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="2-3-3-åˆ†è§£å…³è”æŸ¥è¯¢"><a href="#2-3-3-åˆ†è§£å…³è”æŸ¥è¯¢" class="headerlink" title="2.3.3 åˆ†è§£å…³è”æŸ¥è¯¢"></a>2.3.3 åˆ†è§£å…³è”æŸ¥è¯¢</h4><p><strong>å¯¹æ¯ä¸ªè¡¨è¿›è¡Œä¸€æ¬¡å•è¡¨æŸ¥è¯¢ï¼Œåœ¨åº”ç”¨å±‚å¯¹ç»“æœè¿›è¡Œå…³è”</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--å…³è”æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> tag</span><br><span class="line"><span class="keyword">JOIN</span> tag_post</span><br><span class="line"><span class="keyword">ON</span> tag_post.tag_id <span class="operator">=</span> tag.tag_id</span><br><span class="line"><span class="keyword">JOIN</span> post</span><br><span class="line"><span class="keyword">ON</span> tag_post.post_id <span class="operator">=</span> post.post_id</span><br><span class="line"><span class="keyword">WHERE</span> tag.tag <span class="operator">=</span> <span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="comment">--åˆ†è§£ä¸ºä¸‰æ¬¡å•è¡¨æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag <span class="keyword">WHERE</span> tag <span class="operator">=</span> <span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag_post <span class="keyword">WHERE</span> tag_id <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> post <span class="keyword">WHERE</span> post_id <span class="keyword">IN</span> (<span class="number">123</span>,<span class="number">456</span>,<span class="number">567</span>,<span class="number">9098</span>,<span class="number">8904</span>);</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼š</p><ul><li>è®©ç¼“å­˜æ•ˆç‡æ›´é«˜ï¼Œå•è¡¨ç»“æœæ–¹ä¾¿è¿›è¡Œç¼“å­˜ï¼Œå·²ç¼“å­˜çš„æ•°æ®ä¸‹æ¬¡å°±å¯ä»¥è·³è¿‡ï¼›å…³è”çš„è¡¨å‘ç”Ÿå˜åŒ–ä¼šä½¿MySQLæŸ¥è¯¢ç¼“å­˜å¤±æ•ˆï¼›</li><li>æŸ¥è¯¢åˆ†è§£åå¯ä»¥å‡å°‘é”çš„ç«äº‰ï¼›</li><li>åº”ç”¨å±‚åšå…³è”æ›´å®¹æ˜“å¯¹æ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œæ–¹ä¾¿é«˜æ€§èƒ½å’Œå¯æ‰©å±•ï¼›</li><li>æŸ¥è¯¢æ•ˆç‡æœ¬èº«ä¹Ÿæœ‰æå‡ï¼Œä¸Šè¿°ä¾‹å­ä½¿ç”¨ <code>IN()</code> ä»£æ›¿å…³è”æŸ¥è¯¢å¯ä»¥ä½¿MySQLæŒ‰ç…§IDé¡ºåºæŸ¥è¯¢ï¼Œè¦æ¯”éšæœºå…³è”é«˜æ•ˆã€‚</li><li>å‡å°‘å†—ä½™è®°å½•çš„æŸ¥è¯¢ï¼Œåœ¨åº”ç”¨å±‚åšå…³è”æ„å‘³ç€æŸæ¡è®°å½•åªéœ€æŸ¥è¯¢ä¸€æ¬¡ï¼Œè€Œåœ¨æ•°æ®åº“å…³è”æŸ¥è¯¢å¯èƒ½éœ€è¦é‡å¤çš„è®¿é—®ä¸€éƒ¨åˆ†æ•°æ®ã€‚</li></ul><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>åº”ç”¨æ–¹ä¾¿ç¼“å­˜å•ä¸ªæŸ¥è¯¢çš„ç»“æœæ—¶ï¼›</li><li>å¯ä»¥å°†æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„MySQLæœåŠ¡å™¨æ—¶ï¼›</li><li>èƒ½å¤Ÿä½¿ç”¨ <code>IN()</code> ä»£æ›¿å…³è”æŸ¥è¯¢æ—¶ï¼›</li><li>å½“æŸ¥è¯¢ä¸­ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®è¡¨æ—¶ã€‚</li></ul><h2 id="ä¸‰-æŸ¥è¯¢æ‰§è¡Œçš„åŸºç¡€"><a href="#ä¸‰-æŸ¥è¯¢æ‰§è¡Œçš„åŸºç¡€" class="headerlink" title="ä¸‰. æŸ¥è¯¢æ‰§è¡Œçš„åŸºç¡€"></a>ä¸‰. æŸ¥è¯¢æ‰§è¡Œçš„åŸºç¡€</h2><h3 id="3-1-ä¸€ä¸ªæŸ¥è¯¢åœ¨MySQLä¸­çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#3-1-ä¸€ä¸ªæŸ¥è¯¢åœ¨MySQLä¸­çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3.1 ä¸€ä¸ªæŸ¥è¯¢åœ¨MySQLä¸­çš„æ‰§è¡Œè¿‡ç¨‹"></a>3.1 ä¸€ä¸ªæŸ¥è¯¢åœ¨MySQLä¸­çš„æ‰§è¡Œè¿‡ç¨‹</h3><p>MySQLæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢çš„è¿‡ç¨‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201201/202012280108.png"></p><ol><li>å®¢æˆ·ç«¯å‘é€ä¸€æ¡æŸ¥è¯¢ç»™æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œè‹¥å‘½ä¸­ç¼“å­˜å°±ç«‹å³è¿”å›ç»“æœã€‚å¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li><li>æœåŠ¡å™¨è¿›è¡ŒSQLè§£æã€é¢„å¤„ç†ï¼Œå†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ã€‚</li><li>æ ¹æ®æ‰§è¡Œè®¡åˆ’è°ƒç”¨å­˜å‚¨å¼•æ“çš„APIæ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</li><li>å°†ç»“æœè¿”å›å®¢æˆ·ç«¯ã€‚</li></ol><h3 id="3-2-MySQL-å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡åè®®"><a href="#3-2-MySQL-å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡åè®®" class="headerlink" title="3.2 MySQL å®¢æˆ·ç«¯ / æœåŠ¡å™¨é€šä¿¡åè®®"></a>3.2 MySQL å®¢æˆ·ç«¯ / æœåŠ¡å™¨é€šä¿¡åè®®</h3><p>MySQL å®¢æˆ·ç«¯ / æœåŠ¡å™¨é€šä¿¡åè®®æ˜¯<strong>åŠåŒå·¥åè®®</strong>ï¼Œå³è¦ä¹ˆæœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€è¦ä¹ˆå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚</p><p>ä¼˜ç‚¹æ˜¯é€šä¿¡ç®€å•å¿«é€Ÿï¼Œç¼ºç‚¹æ˜¯æ— æ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚ä¸€æ–¹ä¸€æ—¦å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹åªèƒ½æ¥æ”¶å®Œæ•´æ¶ˆæ¯åæ‰èƒ½è¿›è¡Œå“åº”ã€‚ä¸€æ–¹ä¸èƒ½ä½¿å¦ä¸€æ–¹åœæ­¢ï¼ŒMySQLä¸€èˆ¬è¦ç­‰æ‰€æœ‰æ•°æ®éƒ½å‘é€ç»™å®¢æˆ·ç«¯åæ‰èƒ½é‡Šæ”¾æŸ¥è¯¢æ‰€å ç”¨çš„èµ„æºï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ç¼“å­˜æ•°æ®å¯ä»¥å‡è½»æœåŠ¡å™¨å‹åŠ›ï¼Œè®©æŸ¥è¯¢å°½å¿«ç»“æŸæ—©ç‚¹é‡Šæ”¾èµ„æºã€‚</p><p>æŸ¥çœ‹MySQLè¿æ¥/çº¿ç¨‹çš„çŠ¶æ€ï¼š<code>SHOW FULL PROCESSLIST</code> </p><ul><li>Sleepï¼šçº¿ç¨‹æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ–°çš„è¯·æ±‚ã€‚</li><li>Queryï¼šçº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢æˆ–æ­£åœ¨å°†ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li><li>Lockedï¼šåœ¨MySQLæœåŠ¡å™¨å±‚ï¼Œè¯¥çº¿ç¨‹æ­£åœ¨ç­‰å¾…è¡¨é”ï¼›å­˜å‚¨å¼•æ“çº§åˆ«çš„é”ï¼ˆå¦‚è¡Œé”ï¼‰ä¸ä¼šä½“ç°åœ¨çº¿ç¨‹çŠ¶æ€ã€‚</li><li>Analyzing and statisticsï¼šçº¿ç¨‹æ­£åœ¨æ”¶é›†å­˜å‚¨å¼•æ“çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ã€‚</li><li>Copying to tmp table [on disk]ï¼šçº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†ç»“æœé›†éƒ½å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œä¸€èˆ¬æ˜¯åœ¨åšGROUP BYæ“ä½œã€æ–‡ä»¶æ’åºã€UNIONæ“ä½œç­‰ï¼›on diskè¡¨ç¤ºæ­£åœ¨å°†ä¸€ä¸ªå†…å­˜è¡¨æ”¾åˆ°ç£ç›˜ã€‚</li><li>Sorting resultï¼šçº¿ç¨‹æ­£åœ¨å¯¹ç»“æœé›†è¿›è¡Œæ’åºã€‚</li><li>Sending dataï¼šçº¿ç¨‹å¯èƒ½åœ¨å¤šä¸ªçŠ¶æ€é—´ä¼ é€æ•°æ®ã€æˆ–è€…ç”Ÿæˆç»“æœé›†ã€æˆ–è€…åœ¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ã€‚</li></ul><h3 id="3-3-æŸ¥è¯¢ä¼˜åŒ–å¤„ç†"><a href="#3-3-æŸ¥è¯¢ä¼˜åŒ–å¤„ç†" class="headerlink" title="3.3 æŸ¥è¯¢ä¼˜åŒ–å¤„ç†"></a>3.3 æŸ¥è¯¢ä¼˜åŒ–å¤„ç†</h3><p>æŸ¥è¯¢çš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸‹ä¸€æ­¥æ˜¯<strong>å°†ä¸€ä¸ªSQLè½¬æ¢ä¸ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’</strong>ï¼ŒMySQLæŒ‰ç…§æ‰§è¡Œè®¡åˆ’å’Œå­˜å‚¨å¼•æ“äº¤äº’ï¼š</p><ul><li><strong>è§£æSQL</strong>ï¼šMySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­å¥è¿›è¡Œè§£æï¼Œç”Ÿæˆä¸€æ£µè§£ææ ‘ï¼Œé€šè¿‡MySQLè¯­æ³•è§„åˆ™è¿›è¡ŒéªŒè¯å’Œè§£ææŸ¥è¯¢ï¼ˆå¦‚å…³é”®å­—æ˜¯å¦æ­£ç¡®ã€é¡ºåºæ˜¯å¦æ­£ç¡®ã€å¼•å·å‰åæ˜¯å¦åŒ¹é…ï¼‰ã€‚</li><li><strong>é¢„å¤„ç†</strong>ï¼šæ ¹æ®ä¸€äº›MySQLè§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ï¼ˆæ•°æ®è¡¨å’Œåˆ—æ˜¯å¦å­˜åœ¨ã€åå­—æˆ–åˆ«åæ˜¯å¦æœ‰æ­§ä¹‰ï¼‰ï¼ŒéªŒè¯æƒé™ã€‚</li><li><strong>ä¼˜åŒ–SQLæ‰§è¡Œè®¡åˆ’</strong></li></ul><p><strong>æŸ¥è¯¢ä¼˜åŒ–å™¨</strong>ï¼šMySQLä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œé¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬å¹¶é€‰æ‹©æœ€å°çš„ä¸€ä¸ªã€‚</p><p>å¯¼è‡´ä¼˜åŒ–å™¨é€‰æ‹©é”™è¯¯æ‰§è¡Œè®¡åˆ’çš„åŸå› ï¼š</p><ul><li>ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Œè¯„ä¼°æˆæœ¬ä¾èµ–å­˜å‚¨å¼•æ“æä¾›çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæœ‰æ—¶ä¿¡æ¯çš„åå·®ä¼šå¾ˆå¤§ï¼Œå¦‚MVCCæ¶æ„å¹¶ä¸ç»´æŠ¤æ•°æ®è¡¨è¡Œæ•°çš„ç²¾ç¡®ç»Ÿè®¡ã€‚</li><li>æ‰§è¡Œè®¡åˆ’çš„æˆæœ¬ä¼°ç®—å¹¶ä¸ç­‰ä»·äºå®é™…æ‰§è¡Œçš„æˆæœ¬ï¼Œå¦‚è¯»å–çš„é¡µé¢å¯èƒ½åœ¨å†…å­˜æˆ–ç£ç›˜ï¼Œå…·ä½“è¦å¤šå°‘æ¬¡ç‰©ç†I/Oæ— æ³•å¾—çŸ¥ã€‚</li><li>MySQLçš„æœ€ä¼˜å¹¶ä¸ä¸€å®šæ˜¯æœ€å¿«çš„æ‰§è¡Œæ–¹å¼ï¼Œåªæ˜¯åŸºäºæˆæœ¬æ¨¡å‹çš„æœ€ä¼˜è®¡åˆ’ã€‚</li><li>MySQLå¹¶ä¸è€ƒè™‘å…¶ä»–å¹¶å‘æ‰§è¡Œçš„æŸ¥è¯¢ã€‚</li><li>MySQLå¹¶ä¸è€ƒè™‘ä¸å—æ§åˆ¶çš„æ“ä½œçš„æˆæœ¬ï¼Œå¦‚å­˜å‚¨è¿‡ç¨‹æˆ–è‡ªå®šä¹‰å‡½æ•°ã€‚</li><li>æœ‰äº›ç‰¹æ®Šæƒ…å†µå¹¶ä¸åŸºäºæˆæœ¬é€‰æ‹©ä¼˜åŒ–ï¼Œå¦‚å…¨æ–‡æœç´¢çš„ <code>MATCH()</code> å­å¥ï¼Œå­˜åœ¨å…¨æ–‡ç´¢å¼•å°±ä¼šä½¿ç”¨ï¼Œå³ä½¿æœ‰æ—¶åˆ«çš„ç´¢å¼•å’ŒWHEREæ¡ä»¶ä¼šæ›´å¿«ã€‚</li></ul><p>ä¼˜åŒ–å™¨çš„ä¼˜åŒ–ç­–ç•¥ï¼š</p><ul><li>é™æ€ä¼˜åŒ–ï¼šç›´æ¥å¯¹è§£ææ ‘è¿›è¡Œåˆ†æï¼Œå¹¶å®Œæˆä¼˜åŒ–ã€‚</li><li>åŠ¨æ€ä¼˜åŒ–ï¼šä¸æŸ¥è¯¢çš„ä¸Šä¸‹æ–‡æˆ–å…¶ä»–å› ç´ æœ‰å…³ï¼Œå¦‚WHEREæ¡ä»¶å–å€¼ã€ç´¢å¼•ä¸­æ¡ç›®å¯¹åº”çš„æ•°æ®è¡Œæ•°ç­‰ï¼Œéœ€è¦æ¯æ¬¡æŸ¥è¯¢æ—¶é‡æ–°è¯„ä¼°ã€‚</li></ul><p>èƒ½å¤Ÿä¼˜åŒ–çš„ç±»å‹ï¼š</p><ul><li>é‡æ–°å®šä¹‰å…³è”è¡¨çš„é¡ºåº</li><li>å°†å¤–è¿æ¥è½¬åŒ–ä¸ºå†…è¿æ¥</li><li>ä½¿ç”¨ç­‰ä»·å˜æ¢è§„åˆ™</li><li>ä¼˜åŒ– <code>COUNT()</code> ã€<code>MIN()</code> å’Œ <code>MAX()</code> ï¼Œæ‰¾åˆ°æŸä¸€åˆ—æœ€å°å€¼åªéœ€æŸ¥è¯¢å¯¹åº”B-Treeç´¢å¼•æœ€å·¦ç«¯çš„è®°å½•ï¼Œä½¿ç”¨æ­¤ç±»ä¼˜åŒ–åœ¨EXPLAINä¸­ä¼šå‡ºç° <code>Select tables optimized away</code> è¡¨ç¤ºä¼˜åŒ–å™¨ä»æ‰§è¡Œè®¡åˆ’ä¸­ç§»é™¤è¯¥è¡¨ï¼Œç”¨ä¸€ä¸ªå¸¸æ•°å–ä»£ã€‚</li><li>é¢„ä¼°å¹¶è½¬åŒ–ä¸ºå¸¸æ•°è¡¨è¾¾å¼</li><li>è¦†ç›–ç´¢å¼•æ‰«æ</li><li>å­æŸ¥è¯¢ä¼˜åŒ–</li><li>æå‰ç»ˆæ­¢æŸ¥è¯¢</li><li>ç­‰å€¼ä¼ æ’­</li><li>åˆ—è¡¨ <code>IN()</code> çš„æ¯”è¾ƒ</li></ul><h3 id="3-4-MySQLå¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢"><a href="#3-4-MySQLå¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢" class="headerlink" title="3.4 MySQLå¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢"></a>3.4 MySQLå¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢</h3><h4 id="3-4-1-MySQLä¸­çš„å…³è”æŸ¥è¯¢"><a href="#3-4-1-MySQLä¸­çš„å…³è”æŸ¥è¯¢" class="headerlink" title="3.4.1 MySQLä¸­çš„å…³è”æŸ¥è¯¢"></a>3.4.1 MySQLä¸­çš„å…³è”æŸ¥è¯¢</h4><p>MySQLä¸­æ¯ä¸ªæŸ¥è¯¢éƒ½æ˜¯ä¸€æ¬¡å…³è”ã€‚æ¯”å¦‚å¯¹äºUNIONæŸ¥è¯¢ï¼ŒMySQLå…ˆå°†ä¸€ç³»åˆ—å•ä¸ªæŸ¥è¯¢çš„ç»“æœæ”¾åœ¨ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œç„¶åå†é‡æ–°è¯»å‡ºä¸´æ—¶è¡¨æ•°æ®å®ŒæˆUNIONæŸ¥è¯¢ã€‚</p><p>MySQLä¸­å…³è”æŸ¥è¯¢æµç¨‹ï¼š</p><ul><li>MySQLå¯¹ä»»ä½•å…³è”éƒ½æ‰§è¡ŒåµŒå¥—å¾ªç¯å…³è”æ“ä½œï¼Œå³MySQLå…ˆåœ¨ä¸€ä¸ªè¡¨ä¸­å¾ªç¯å–å‡ºå•æ¡æ•°æ®ï¼Œç„¶åå†åµŒå¥—å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªè¡¨ä¸­å¯»æ‰¾åŒ¹é…çš„è¡Œï¼Œä¾æ¬¡ä¸‹å»ç›´åˆ°æ‰¾åˆ°æ‰€æœ‰è¡¨ä¸­åŒ¹é…çš„è¡Œä¸ºæ­¢ã€‚</li><li>ç„¶åæ ¹æ®å„ä¸ªè¡¨åŒ¹é…çš„è¡Œï¼Œè¿”å›æŸ¥è¯¢ä¸­éœ€è¦çš„å„ä¸ªåˆ—ã€‚</li><li>MySQLä¼šå°è¯•åœ¨æœ€åä¸€ä¸ªå…³è”è¡¨ä¸­æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è¡Œï¼Œå¦‚æœæœ€åä¸€ä¸ªå…³è”è¡¨æ— æ³•æ‰¾åˆ°æ›´å¤šçš„è¡Œï¼Œè¿”å›åˆ°ä¸Šä¸€å±‚å…³è”è¡¨ç»§ç»­æŸ¥æ‰¾æ›´å¤šåŒ¹é…çš„è®°å½•ï¼Œä¾æ¬¡è¿­ä»£æ‰§è¡Œã€‚</li></ul><p>å…³è”æ“ä½œ1å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tab1.col1, tab2.col2</span><br><span class="line"><span class="keyword">FROM</span> tab1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tab2 <span class="keyword">USING</span>(col3)</span><br><span class="line"><span class="keyword">WHERE</span> tab1.col1 <span class="keyword">IN</span>(<span class="number">5</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure><p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030101.png"></p><p>å…³è”æ“ä½œ2å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> tab1.col1, tab2.col2</span><br><span class="line"><span class="keyword">FROM</span> tab1 <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> tab2 <span class="keyword">USING</span>(col3)</span><br><span class="line"><span class="keyword">WHERE</span> tab1.col1 <span class="keyword">IN</span>(<span class="number">5</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure><p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030102.png"></p><p>å…³è”æ“ä½œ1çš„å†…è¿æ¥ä½¿ç”¨æ³³é“å›¾è¡¨ç¤ºï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030103.png"></p><h4 id="3-4-2-æ‰§è¡Œè®¡åˆ’"><a href="#3-4-2-æ‰§è¡Œè®¡åˆ’" class="headerlink" title="3.4.2 æ‰§è¡Œè®¡åˆ’"></a>3.4.2 æ‰§è¡Œè®¡åˆ’</h4><p>MySQLå¹¶ä¸åƒå…¶ä»–å…³ç³»å‹æ•°æ®åº“é‚£æ ·ç”ŸæˆæŸ¥è¯¢å­—èŠ‚ç æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œè€Œæ˜¯<strong>ç”ŸæˆæŸ¥è¯¢çš„ä¸€æ£µæŒ‡ä»¤æ ‘</strong>ï¼Œæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’åŒ…å«äº†é‡æ„æŸ¥è¯¢çš„å…¨éƒ¨ä¿¡æ¯ã€‚</p><p>å¯¹æŸä¸ªæŸ¥è¯¢æ‰§è¡Œ <code>EXPLAIN EXTENDED</code> ï¼Œç„¶åå†æ‰§è¡Œ <code>SHOW WARNINGS</code> å¯ä»¥çœ‹åˆ°é‡æ„å‡ºçš„æŸ¥è¯¢ã€‚</p><p>ä»»æ„å¤šè¡¨æŸ¥è¯¢éƒ½å¯ä»¥ä½¿ç”¨ä¸€æ£µæ ‘è¡¨ç¤ºï¼Œå¦‚ä¸‹å›¾ä¸ºä¸€ä¸ªå››è¡¨å…³è”æ“ä½œï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030104.png"></p><p>ä¸Šå›¾è¿™ç§å¹³è¡¡æ ‘å¹¶éMySQLæ‰§è¡ŒæŸ¥è¯¢çš„æ–¹å¼ï¼ŒMySQLæ€»æ˜¯ä»ä¸€ä¸ªè¡¨å¼€å§‹åµŒå¥—å¾ªç¯ã€å›æº¯å®Œæˆæ‰€æœ‰è¡¨å…³è”ï¼Œæ‰€ä»¥æ˜¯ä¸‹å›¾è¿™ç§<strong>å·¦ä¾§æ·±åº¦ä¼˜å…ˆæ ‘</strong>ï¼š</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030105.png"></p><h4 id="3-4-3-å…³è”æŸ¥è¯¢ä¼˜åŒ–å™¨"><a href="#3-4-3-å…³è”æŸ¥è¯¢ä¼˜åŒ–å™¨" class="headerlink" title="3.4.3 å…³è”æŸ¥è¯¢ä¼˜åŒ–å™¨"></a>3.4.3 å…³è”æŸ¥è¯¢ä¼˜åŒ–å™¨</h4><p>å…³è”æŸ¥è¯¢ä¼˜åŒ–æ˜¯ä¼˜åŒ–å™¨æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå†³å®šå¤šä¸ªè¡¨å…³è”çš„é¡ºåºã€‚ä¼˜åŒ–å™¨é€šè¿‡è¯„ä¼°ä¸åŒé¡ºåºçš„æˆæœ¬é€‰æ‹©ä¸€ä¸ªä»£ä»·æœ€å°çš„å…³è”é¡ºåºã€‚</p><p>æœ‰æ—¶ä¼˜åŒ–å™¨é€‰æ‹©çš„å¹¶éä¸€å®šæ˜¯æœ€ä¼˜é¡ºåºï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ <code>STRAIGHT_JOIN</code> å…³é”®å­—é‡å†™æŸ¥è¯¢ï¼Œè®©ä¼˜åŒ–å™¨æŒ‰æŒ‡å®šé¡ºåºæ‰§è¡Œï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¼˜åŒ–å™¨çš„åˆ¤æ–­è¦æ¯”å¼€å‘è€…ç²¾å‡†ã€‚</p><p>ä¼˜åŒ–å™¨å¦‚ä½•è®¡ç®—æˆæœ¬ï¼š</p><ul><li>ä¸€èˆ¬ä¼šéå†æ¯ä¸ªè¡¨é€ä¸ªåšåµŒå¥—å¾ªç¯è®¡ç®—æ¯ä¸€æ£µæ‰§è¡Œè®¡åˆ’æ ‘çš„æˆæœ¬ã€‚</li><li>ä½†å¦‚æœæœ‰è¶…è¿‡Nä¸ªè¡¨å…³è”ï¼Œéœ€è¦æ£€æŸ¥Nçš„é˜¶ä¹˜ç§å…³è”é¡ºåºï¼›æ¯”å¦‚N=10æ—¶å°±æœ‰3628800ç§å…³è”é¡ºåºï¼Œè¿‡å¤šçš„å¯èƒ½å¯¼è‡´ä¼˜åŒ–å™¨ä¸å¯èƒ½é€ä¸€è¯„ä¼°æ¯ç§é¡ºåºçš„æˆæœ¬ï¼›</li><li>å½“æœç´¢ç©ºé—´ç‰¹åˆ«å¤§æ—¶ï¼Œä¼˜åŒ–å™¨é€‰æ‹©è´ªå©ªæœç´¢æ–¹å¼ï¼Œè€Œéé€ä¸ªè¯„ä¼°ã€‚</li></ul><h3 id="3-5-æ’åºä¼˜åŒ–"><a href="#3-5-æ’åºä¼˜åŒ–" class="headerlink" title="3.5 æ’åºä¼˜åŒ–"></a>3.5 æ’åºä¼˜åŒ–</h3><ul><li>æ— è®ºæ€æ ·ï¼Œæ’åºéƒ½æ˜¯ä¸€ä¸ªæˆæœ¬å¾ˆé«˜çš„æ“ä½œï¼Œåœ¨ä¸èƒ½ä½¿ç”¨ç´¢å¼•æ’åºæ—¶ï¼Œæ•°æ®é‡å°çš„æ’åºä¼šåœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œæ•°æ®é‡å¤§æ—¶éœ€è¦ä½¿ç”¨ç£ç›˜ï¼›</li><li>åˆ¤æ–­æ¡ä»¶æ˜¯éœ€è¦æ’åºçš„æ•°æ®é‡æ˜¯å¦å°äº<strong>æ’åºç¼“å†²åŒº</strong>ï¼›</li><li>å†…å­˜ä¸­ç›´æ¥ä½¿ç”¨å¿«é€Ÿæ’åºï¼›å†…å­˜ä¸å¤Ÿæ’åºï¼Œå…ˆå°†æ•°æ®åˆ†å—ï¼Œæ¯ä¸ªå—è¿›è¡Œå¿«é€Ÿæ’åºï¼Œç»“æœå­˜æ”¾åœ¨ç£ç›˜ï¼Œç„¶åå°†æ’å¥½åºçš„å„ä¸ªå—åˆå¹¶ï¼Œå¹¶è¿”å›æœ€ç»ˆç»“æœã€‚</li><li>åœ¨å…³è”æŸ¥è¯¢æ—¶å¦‚æœéœ€è¦æ’åºï¼ŒMySQLåˆ†ä¸¤ç§æƒ…å†µæ¥å¤„ç†ï¼š<ul><li>ORDER BY å­å¥ä¸­æ‰€æœ‰åˆ—éƒ½æ¥è‡ªäºå…³è”çš„ç¬¬ä¸€ä¸ªè¡¨ï¼ŒMySQLåœ¨å¤„ç†ç¬¬ä¸€ä¸ªè¡¨æ—¶å°±è¿›è¡Œæ–‡ä»¶æ’åºï¼Œè¿™ç§æƒ…å†µEXPLAIN çš„ Extra å­—æ®µä¼šæœ‰ <code>Using filesort</code> ï¼›</li><li>å…¶ä»–æƒ…å†µä¸‹ï¼ŒMySQLéƒ½ä¼šå°†å…³è”çš„ç»“æœæ”¾åˆ°ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œç„¶ååœ¨æ‰€æœ‰çš„å…³è”ç»“æŸåå†è¿›è¡Œæ–‡ä»¶æ’åºï¼Œè¿™ç§æƒ…å†µEXPLAIN çš„ Extra å­—æ®µä¼šæœ‰ <code>Using temporary; Using filesort</code> ï¼›æŸ¥è¯¢ä¸­æœ‰LIMITä¼šåœ¨æ’åºååº”ç”¨ï¼ŒMySQL 5.6 ç‰ˆæœ¬åï¼Œå½“åªéœ€è¿”å›éƒ¨åˆ†æ’åºç»“æœæ—¶ä¸ä¼šå¯¹æ‰€æœ‰ç»“æœè¿›è¡Œæ’åºã€‚</li></ul></li></ul><h2 id="å››-æŸ¥è¯¢ä¼˜åŒ–å™¨"><a href="#å››-æŸ¥è¯¢ä¼˜åŒ–å™¨" class="headerlink" title="å››. æŸ¥è¯¢ä¼˜åŒ–å™¨"></a>å››. æŸ¥è¯¢ä¼˜åŒ–å™¨</h2><h3 id="4-1-æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å±€é™æ€§"><a href="#4-1-æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å±€é™æ€§" class="headerlink" title="4.1 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å±€é™æ€§"></a>4.1 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å±€é™æ€§</h3><h4 id="4-1-1-å…³è”å­æŸ¥è¯¢"><a href="#4-1-1-å…³è”å­æŸ¥è¯¢" class="headerlink" title="4.1.1 å…³è”å­æŸ¥è¯¢"></a>4.1.1 å…³è”å­æŸ¥è¯¢</h4><p>MySQLå­æŸ¥è¯¢ååˆ†ç³Ÿç³•ï¼Œç‰¹åˆ«æ˜¯WHEREæ¡ä»¶åŒ…å« <code>IN()</code> çš„å­æŸ¥è¯¢è¯­å¥ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> film </span><br><span class="line"><span class="keyword">WHERE</span> film_id <span class="keyword">IN</span>(</span><br><span class="line"><span class="keyword">SELECT</span> film_id <span class="keyword">FROM</span> film_actor <span class="keyword">WHERE</span> actor_id <span class="operator">=</span> <span class="number">1</span>);</span><br><span class="line"><span class="comment">--MySQLä¼šå…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œè¿”å›æ‰€æœ‰actor_id = 1çš„film_idï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šè®¤ä¸ºä¼šå¦‚ä¸‹æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> film </span><br><span class="line"><span class="keyword">WHERE</span> film_id <span class="keyword">IN</span>(XXX, XXX, ......, XXX);</span><br><span class="line"><span class="comment">--ä½†å®é™…ä¸Šï¼ŒMySQLä¼šå°†å¤–å±‚è¡¨å‹åˆ°å­æŸ¥è¯¢ä¸­ï¼Œå› ä¸ºå®ƒè®¤ä¸ºè¿™æ ·å¯ä»¥æ›´å¿«çš„æ‰¾åˆ°æ•°æ®è¡Œï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> film </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span>(</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> film_actor <span class="keyword">WHERE</span> actor_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> film.film_id <span class="operator">=</span> film_actor.film_id);</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101030106.png"></p><p>MySQLé€‰æ‹©å…ˆå¯¹fileè¡¨è¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ ¹æ®è¿”å›çš„film_idé€ä¸ªæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå½“æ•°æ®é‡å¤§æ—¶è¿™ç§æ‰§è¡Œæ€§èƒ½ä¼šå¾ˆç³Ÿç³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹å†™æŸ¥è¯¢å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ä½¿ç”¨å†…è¿æ¥ä»£æ›¿INå­æŸ¥è¯¢ï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> film.<span class="operator">*</span> <span class="keyword">FROM</span> film </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> film_actor <span class="keyword">USING</span>(film_id)</span><br><span class="line"><span class="keyword">WHERE</span> actor_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">--ä½¿ç”¨å‡½æ•°GROUP_CONCATæ‹¼æ¥ä¸€ä¸ªé€—å·åˆ†éš”çš„åˆ—è¡¨ï¼š</span></span><br><span class="line">ï¼ˆçœç•¥ï¼‰</span><br></pre></td></tr></table></figure><h4 id="4-1-2-UNIONå–LIMITæ—¶å†…å¤–å±‚ä¼˜åŒ–"><a href="#4-1-2-UNIONå–LIMITæ—¶å†…å¤–å±‚ä¼˜åŒ–" class="headerlink" title="4.1.2 UNIONå–LIMITæ—¶å†…å¤–å±‚ä¼˜åŒ–"></a>4.1.2 UNIONå–LIMITæ—¶å†…å¤–å±‚ä¼˜åŒ–</h4><p>æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›å¯¹UNIONçš„ç»“æœé›†åªè·å–å‰Næ¡è®°å½•ï¼Œå¯ä»¥åœ¨æ¯ä¸ªå­å¥ä¸­æ·»åŠ LIMITï¼Œä¸ºäº†ä¿è¯è·å–æ­£ç¡®çš„é¡ºåºï¼Œéœ€è¦åœ¨å¤–å±‚å†å¢åŠ ä¸€ä¸ªå…¨å±€çš„ ORDER BY å’Œ LIMIT æ“ä½œã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> a,b <span class="keyword">FROM</span> xx1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a)</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">(<span class="keyword">SELECT</span> a,b <span class="keyword">FROM</span> xx2 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a)</span><br><span class="line">LIMIT <span class="number">20</span></span><br><span class="line"><span class="comment">-- æ”¹å†™ä¸º</span></span><br><span class="line">(<span class="keyword">SELECT</span> a,b <span class="keyword">FROM</span> xx1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a LIMIT <span class="number">20</span>)</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">(<span class="keyword">SELECT</span> a,b <span class="keyword">FROM</span> xx2 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a LIMIT <span class="number">20</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> a</span><br><span class="line">LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure><h4 id="4-1-3-ç´¢å¼•åˆå¹¶ä¼˜åŒ–"><a href="#4-1-3-ç´¢å¼•åˆå¹¶ä¼˜åŒ–" class="headerlink" title="4.1.3 ç´¢å¼•åˆå¹¶ä¼˜åŒ–"></a>4.1.3 ç´¢å¼•åˆå¹¶ä¼˜åŒ–</h4><p>WHEREå­å¥åŒ…å«å¤šä¸ªå¤æ‚æ¡ä»¶æ—¶ï¼ŒMySQLå¯ä»¥è®¿é—®å•ä¸ªè¡¨çš„å¤šä¸ªç´¢å¼•ä»¥åˆå¹¶å’Œäº¤å‰è¿‡æ»¤çš„æ–¹å¼æ¥å®šä½éœ€è¦æŸ¥æ‰¾çš„è¡Œã€‚</p><h4 id="4-1-4-ç­‰å€¼ä¼ é€’"><a href="#4-1-4-ç­‰å€¼ä¼ é€’" class="headerlink" title="4.1.4 ç­‰å€¼ä¼ é€’"></a>4.1.4 ç­‰å€¼ä¼ é€’</h4><p>å¦‚ä¸€ä¸ªéå¸¸å¤§çš„ <code>IN()</code> åˆ—è¡¨ï¼Œä¼˜åŒ–å™¨å‘ç°æœ‰WHEREã€ONæˆ–USINGçš„å­å¥ï¼Œå°†è¿™ä¸ªåˆ—è¡¨çš„å€¼å’Œå¦å¤–ä¸€ä¸ªè¡¨çš„æŸä¸ªåˆ—å…³è”ã€‚ä¼˜åŒ–å™¨ä¼šå°†åˆ—è¡¨éƒ½å¤åˆ¶åº”ç”¨åˆ°å…³è”çš„å„ä¸ªè¡¨ä¸­ï¼Œåˆ—è¡¨ç‰¹åˆ«å¤§ä¼šå¯¼è‡´æ— æ³•é«˜æ•ˆçš„ä»è¡¨ä¸­è¿‡æ»¤è®°å½•ã€‚</p><h4 id="4-1-5-å¹¶è¡Œæ‰§è¡Œ"><a href="#4-1-5-å¹¶è¡Œæ‰§è¡Œ" class="headerlink" title="4.1.5 å¹¶è¡Œæ‰§è¡Œ"></a>4.1.5 å¹¶è¡Œæ‰§è¡Œ</h4><p>MySQLæ— æ³•åˆ©ç”¨å¤šæ ¸æ¥å¹¶è¡Œæ‰§è¡ŒæŸ¥è¯¢ã€‚</p><h4 id="4-1-6-å“ˆå¸Œå…³è”"><a href="#4-1-6-å“ˆå¸Œå…³è”" class="headerlink" title="4.1.6 å“ˆå¸Œå…³è”"></a>4.1.6 å“ˆå¸Œå…³è”</h4><p>MySQLåªæ”¯æŒåµŒå¥—å¾ªç¯å…³è”ï¼Œåªèƒ½é€šè¿‡å»ºç«‹å“ˆå¸Œç´¢å¼•æ¥å˜ç›¸çš„å®ç°å“ˆå¸Œå…³è”</p><h4 id="4-1-7-æ¾æ•£ç´¢å¼•æ‰«æ"><a href="#4-1-7-æ¾æ•£ç´¢å¼•æ‰«æ" class="headerlink" title="4.1.7 æ¾æ•£ç´¢å¼•æ‰«æ"></a>4.1.7 æ¾æ•£ç´¢å¼•æ‰«æ</h4><p>MySQLä¸æ”¯æŒæ¾æ•£ç´¢å¼•æ‰«æï¼Œæ— æ³•æŒ‰ç…§ä¸è¿ç»­çš„æ–¹å¼æ‰«æä¸€ä¸ªç´¢å¼•ã€‚å‡è®¾æœ‰ç´¢å¼• <code>(A,B)</code> æŸ¥è¯¢ <code>SELECT ... FROM TB WHERE B BETWEEN 2 AND 3</code> å› ä¸ºç´¢å¼•å‰å¯¼å­—æ®µæ˜¯Aï¼Œä½†æŸ¥è¯¢åªæŒ‡å®šäº†Bï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œåªèƒ½å…¨è¡¨æ‰«æã€‚</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101210101.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101210102.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210101/202101210103.png"></p><h4 id="4-1-8-æœ€å¤§å€¼å’Œæœ€å°å€¼ä¼˜åŒ–"><a href="#4-1-8-æœ€å¤§å€¼å’Œæœ€å°å€¼ä¼˜åŒ–" class="headerlink" title="4.1.8 æœ€å¤§å€¼å’Œæœ€å°å€¼ä¼˜åŒ–"></a>4.1.8 æœ€å¤§å€¼å’Œæœ€å°å€¼ä¼˜åŒ–</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(actor_id) <span class="keyword">FROM</span> actor <span class="keyword">WHERE</span> first_name <span class="operator">=</span> <span class="string">&#x27;XX&#x27;</span>;</span><br><span class="line"><span class="comment">--å› ä¸ºfirst_nameå¹¶æ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥MySQLä¼šè¿›è¡Œä¸€æ¬¡å…¨è¡¨æ‰«æï¼Œé€šè¿‡SHOW STATUSç¡®è®¤</span></span><br><span class="line">FLUSH STATUS;</span><br><span class="line"><span class="keyword">SELECT</span> ...;</span><br><span class="line"><span class="keyword">SHOW</span> STATUS;</span><br><span class="line"><span class="comment">--ä¼˜åŒ–ï¼šä½¿ç”¨LIMITé‡å†™</span></span><br><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> actor USE INDEX(<span class="keyword">PRIMARY</span>) <span class="keyword">WHERE</span> first_name <span class="operator">=</span> <span class="string">&#x27;XX&#x27;</span> LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="4-2-æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æç¤º"><a href="#4-2-æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æç¤º" class="headerlink" title="4.2 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æç¤º"></a>4.2 æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æç¤º</h3><p>æš‚ç•¥ã€‚</p><h3 id="4-3-ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢"><a href="#4-3-ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢" class="headerlink" title="4.3 ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢"></a>4.3 ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢</h3><h4 id="4-3-1-ä¼˜åŒ–COUNT"><a href="#4-3-1-ä¼˜åŒ–COUNT" class="headerlink" title="4.3.1 ä¼˜åŒ–COUNT()"></a>4.3.1 ä¼˜åŒ–COUNT()</h4><p>COUNT(*) ç»Ÿè®¡ç»“æœé›†çš„è¡Œæ•°ï¼ŒCOUNT(row) ç»Ÿè®¡æŸä¸ªåˆ—å€¼çš„æ•°é‡ï¼ŒäºŒè€…å«ä¹‰ä¸åŒã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ä¸€ä¸ªæŸ¥è¯¢ç»Ÿè®¡ä¸åŒé¢œè‰²</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(IF(color <span class="operator">=</span> <span class="string">&#x27;blue&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> blue, <span class="built_in">SUM</span>(IF(color <span class="operator">=</span> <span class="string">&#x27;red&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">AS</span> red <span class="keyword">FROM</span> items;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(color <span class="operator">=</span> <span class="string">&#x27;blue&#x27;</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>) <span class="keyword">AS</span> blue, <span class="built_in">COUNT</span>(color <span class="operator">=</span> <span class="string">&#x27;red&#x27;</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>) <span class="keyword">AS</span> red <span class="keyword">FROM</span> items;</span><br></pre></td></tr></table></figure><p>ä¸éœ€è¦ç²¾ç¡®å€¼æ—¶å¯ä»¥ä½¿ç”¨è¿‘ä¼¼å€¼ä»£æ›¿ï¼Œæ¯”å¦‚EXPLAINçš„ä¼°ç®—è¡Œæ•°ã€‚</p><p>COUNT() ä¸€èˆ¬éƒ½éœ€è¦æ‰«æå¤§é‡çš„æ•°æ®è¡Œæ‰èƒ½è·å¾—ç²¾ç¡®çš„ç»“æœï¼Œåªèƒ½åŠ ç´¢å¼•è¦†ç›–æ‰«æï¼Œå¦‚æœè¿™æ ·è¿˜ä¸èƒ½è§£å†³æ€§èƒ½é—®é¢˜ï¼Œåªèƒ½è€ƒè™‘ä¿®æ”¹åº”ç”¨çš„æ¶æ„ï¼Œæ¯”å¦‚å¢åŠ æ±‡æ€»è¡¨ / ç¼“å­˜ç³»ç»Ÿç­‰ã€‚</p><h4 id="4-3-2-ä¼˜åŒ–å…³è”æŸ¥è¯¢"><a href="#4-3-2-ä¼˜åŒ–å…³è”æŸ¥è¯¢" class="headerlink" title="4.3.2 ä¼˜åŒ–å…³è”æŸ¥è¯¢"></a>4.3.2 ä¼˜åŒ–å…³è”æŸ¥è¯¢</h4><ul><li>ç¡®ä¿ONæˆ–USINGå­å¥çš„åˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œåˆ›å»ºç´¢å¼•æ—¶è¦è€ƒè™‘å…³è”çš„é¡ºåºï¼Œå½“è¡¨Aå’ŒBç”¨åˆ—cå…³è”ï¼Œè‹¥ä¼˜åŒ–å™¨çš„å…³è”é¡ºåºçš„Bã€Aï¼Œé‚£ä¹ˆBè¡¨å°±ä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Œ<strong>ä¸€èˆ¬å…³è”åªéœ€åœ¨å…³è”é¡ºåºçš„ç¬¬äºŒå¼ è¡¨å¯¹åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•</strong>ã€‚</li><li>ç¡®ä¿ä»»ä½•çš„GROUP BYå’ŒORDER BYä¸­çš„è¡¨è¾¾å¼åªæ¶‰åŠåˆ°ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ ·MySQLæ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚</li><li>å‡çº§MySQLæ—¶æ³¨æ„å…³è”è¯­æ³•ã€è¿ç®—ç¬¦ä¼˜å…ˆçº§ç­‰å…¶ä»–å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–çš„åœ°æ–¹ï¼Œæ™®é€šå…³è”å¯èƒ½ä¼šå˜æˆç¬›å¡å°”ç§¯ï¼Œä¸åŒç±»å‹çš„å…³è”å¯èƒ½ä¼šç”Ÿæˆä¸åŒçš„ç»“æœã€‚</li></ul><h4 id="4-3-3-ä¼˜åŒ–å­æŸ¥è¯¢"><a href="#4-3-3-ä¼˜åŒ–å­æŸ¥è¯¢" class="headerlink" title="4.3.3 ä¼˜åŒ–å­æŸ¥è¯¢"></a>4.3.3 ä¼˜åŒ–å­æŸ¥è¯¢</h4><p>å°½å¯èƒ½ç”¨å…³è”æŸ¥è¯¢ä»£æ›¿å­æŸ¥è¯¢ã€‚</p><h4 id="4-3-4-ä¼˜åŒ–GROUP-BYå’ŒDISTINCT"><a href="#4-3-4-ä¼˜åŒ–GROUP-BYå’ŒDISTINCT" class="headerlink" title="4.3.4 ä¼˜åŒ–GROUP BYå’ŒDISTINCT"></a>4.3.4 ä¼˜åŒ–GROUP BYå’ŒDISTINCT</h4><p>MySQLä¼˜åŒ–å™¨ä¼šåœ¨å†…éƒ¨å¤„ç†æ—¶ç›¸äº’è½¬æ¢è¿™ä¸¤ç±»æŸ¥è¯¢ï¼Œä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ï¼›è‹¥ç´¢å¼•æ— æ³•ä½¿ç”¨ï¼ŒGROUP BY ä¼šä½¿ç”¨<strong>ä¸´æ—¶è¡¨</strong>æˆ–<strong>æ–‡ä»¶æ’åº</strong>æ¥åšåˆ†ç»„ã€‚</p><p>å¯¹å…³è”æŸ¥è¯¢åšåˆ†ç»„ï¼Œå¹¶ä¸”æŒ‰ç…§æŸ¥æ‰¾è¡¨ä¸­çš„æŸä¸ªåˆ—è¿›è¡Œåˆ†ç»„ï¼Œé‡‡ç”¨æŸ¥æ‰¾è¡¨çš„æ ‡è¯†åˆ—æ•ˆç‡ä¼šè¾ƒé«˜ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æ•ˆç‡å·®</span></span><br><span class="line"><span class="keyword">SELECT</span> actor.first_name,actor.last_name, <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> film_actor</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> actor <span class="keyword">USING</span>(actor_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> actor.first_name,actor.last_name</span><br><span class="line"><span class="comment">--æ•ˆç‡é«˜</span></span><br><span class="line"><span class="keyword">SELECT</span> actor.first_name,actor.last_name, <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> film_actor</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> actor <span class="keyword">USING</span>(actor_id)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> actor.actor_id</span><br><span class="line"><span class="comment">--è¿™ç§å†™æ³•åªæ˜¯åœ¨å§“åå’Œactor_idç›´æ¥å…³è”çš„æƒ…å†µä¸‹å¯ä»¥è¿™æ ·ç”¨ï¼Œä¸”æœ‰ä¸€äº›é—®é¢˜</span></span><br></pre></td></tr></table></figure><h4 id="4-3-5-ä¼˜åŒ–LIMITåˆ†é¡µ"><a href="#4-3-5-ä¼˜åŒ–LIMITåˆ†é¡µ" class="headerlink" title="4.3.5 ä¼˜åŒ–LIMITåˆ†é¡µ"></a>4.3.5 ä¼˜åŒ–LIMITåˆ†é¡µ</h4><p>åˆ†é¡µæ“ä½œï¼šä½¿ç”¨LIMITåŠ åç§»é‡å®ç°ï¼ŒåŠ ä¸Šåˆé€‚çš„ORDER BYå­å¥ã€‚</p><p>åç§»é‡éå¸¸å¤§æ—¶ï¼Œæ¯”å¦‚ LIMIT 10000,20 åªè¿”å›20æ¡æ•°æ®æŠ›å¼ƒå‰é¢10000æ¡è®°å½•ã€‚ä¼˜åŒ–è¦ä¹ˆåœ¨é¡µé¢ä¸­é™åˆ¶åˆ†é¡µçš„æ•°é‡ï¼Œè¦ä¹ˆä¼˜åŒ–å¤§åç§»é‡çš„æ€§èƒ½ã€‚</p><ul><li><p><strong>å»¶è¿Ÿå…³è”</strong>ï¼šæœ€ç®€å•å°±æ˜¯ä½¿ç”¨ç´¢å¼•è¦†ç›–æ‰«æï¼Œè€Œä¸æ˜¯è¿”å›æ‰€æœ‰åˆ—ã€‚ç„¶åæ ¹æ®éœ€è¦å†åšä¸€æ¬¡å…³è”æ“ä½œè¿”å›æ‰€æœ‰åˆ—ï¼Œè¿™ç§æ”¹æ³•å¯¹äºåç§»é‡å¤§çš„æƒ…å†µæ•ˆç‡æå‡æ¯”è¾ƒé«˜ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> film_id,description <span class="keyword">FROM</span> film <span class="keyword">ORDER</span> <span class="keyword">BY</span> title LIMIT <span class="number">50</span>,<span class="number">5</span>;</span><br><span class="line"><span class="comment">--ä¼˜åŒ–ä¸ºï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> film.film_id, film.description </span><br><span class="line"><span class="keyword">FROM</span> film</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span>(<span class="keyword">SELECT</span> film_id <span class="keyword">FROM</span> film <span class="keyword">ORDER</span> <span class="keyword">BY</span> title LIMIT <span class="number">50</span>,<span class="number">5</span>) <span class="keyword">AS</span> lim <span class="keyword">USING</span>(film_id)</span><br></pre></td></tr></table></figure></li><li><p>LIMITå¯ä»¥è½¬æ¢ä¸ºå·²çŸ¥ä½ç½®çš„æŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ä¸Šè¿°æŸ¥è¯¢å¯æ”¹ä¸ºï¼š</span></span><br><span class="line"><span class="keyword">SELECT</span> film_id, description </span><br><span class="line"><span class="keyword">FROM</span> film</span><br><span class="line"><span class="keyword">WHERE</span> position <span class="keyword">BETWEEN</span> <span class="number">50</span> <span class="keyword">TO</span> <span class="number">54</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> position;</span><br></pre></td></tr></table></figure></li><li><p>LIMITæŸ¥è¯¢ä¸»è¦é—®é¢˜æ˜¯OFFSETä¼šå¯¼è‡´MySQLæ‰«æå¤§é‡ä¸éœ€è¦çš„è¡Œå¹¶ä¸”ä¸¢å¼ƒæ‰ï¼Œå¯ä»¥è®°å½•ä¸Šæ¬¡å–æ•°æ®çš„ä½ç½®ï¼Œä¸‹æ¬¡ç›´æ¥ä»è¯¥ä½ç½®å¼€å§‹æ‰«æï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œè¿”å›ä¸»é”®ä¸º16049åˆ°16030çš„ç§Ÿå€Ÿè®°å½•</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> rental</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> rental_id <span class="keyword">DESC</span> LIMIT <span class="number">20</span>;</span><br><span class="line"><span class="comment">--ä¸‹æ¬¡æŸ¥è¯¢ç›´æ¥ä»16030å¼€å§‹</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> rental</span><br><span class="line"><span class="keyword">WHERE</span> rental_id <span class="operator">&lt;</span> <span class="number">16030</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> rental_id <span class="keyword">DESC</span> LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-3-6-ä¼˜åŒ–-SQL-CALC-FOUND-ROWS"><a href="#4-3-6-ä¼˜åŒ–-SQL-CALC-FOUND-ROWS" class="headerlink" title="4.3.6 ä¼˜åŒ– SQL_CALC_FOUND_ROWS"></a>4.3.6 ä¼˜åŒ– SQL_CALC_FOUND_ROWS</h4><p>åˆ†é¡µçš„ä¸€ä¸ªå¸¸ç”¨æŠ€å·§æ˜¯<strong>åœ¨LIMITè¯­å¥ä¸­åŠ ä¸ŠSQL_CALC_FOUND_ROWSæç¤º</strong>ï¼Œä»è€Œè·å¾—å»æ‰LIMITä»¥åæ»¡è¶³æ¡ä»¶çš„è¡Œæ•°ï¼Œä½œä¸ºåˆ†é¡µçš„æ€»æ•°ï¼Œå¥½åƒæ˜¯MySQLé¢„æµ‹åˆ°äº†æ€»è¡Œæ•°ï¼Œä½†å®é™…ä¸ŠMySQLéœ€è¦æ‰«ææ‰«ææ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œæ¥å¾—åˆ°è¡Œæ•°ã€‚</p><p>æ‰€ä»¥æ·»åŠ æ­¤æç¤ºåï¼Œä¸ç®¡æ˜¯å¦éœ€è¦ï¼ŒMySQLéƒ½ä¼šæ‰«ææ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œè€Œä¸æ˜¯æ»¡è¶³LIMITçš„è¡Œæ•°åå°±ç»ˆæ­¢æ‰«æã€‚</p><h4 id="4-3-7-ä¼˜åŒ–-UNION-æŸ¥è¯¢"><a href="#4-3-7-ä¼˜åŒ–-UNION-æŸ¥è¯¢" class="headerlink" title="4.3.7 ä¼˜åŒ– UNION æŸ¥è¯¢"></a>4.3.7 ä¼˜åŒ– UNION æŸ¥è¯¢</h4><p>MySQLæ€»æ˜¯ä¼šé€šè¿‡åˆ›å»ºå¹¶å¡«å……ä¸´æ—¶è¡¨çš„æ–¹å¼æ¥æ‰§è¡Œ UNION æŸ¥è¯¢ï¼Œæ‰€ä»¥å¯¼è‡´å¾ˆå¤šä¼˜åŒ–ç­–ç•¥å—é™ï¼ˆç»å¸¸è¦æ‰‹å·¥å°†WHEREï¼ŒLIMITï¼ŒORDER BYæ”¾åˆ°UNIONå­æŸ¥è¯¢ä¸­ä»¥ä¾¿ä¼˜åŒ–å™¨ä¼˜åŒ–ï¼‰ã€‚</p><p>é™¤éå¿…é¡»è¦æœåŠ¡å™¨æ¶ˆé™¤é‡å¤çš„è¡Œï¼Œå¦åˆ™ä¸€å®šè¦ä½¿ç”¨UNION ALLï¼Œæ²¡æœ‰ALLæ—¶MySQLä¼šç»™ä¸´æ—¶è¡¨å¢åŠ DISTINCTé€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªä¸´æ—¶è¡¨åšå”¯ä¸€æ€§æ£€æŸ¥ï¼Œè¿™æ ·çš„ä»£ä»·éå¸¸é«˜ã€‚</p><h4 id="4-3-8-é™æ€æŸ¥è¯¢åˆ†æ"><a href="#4-3-8-é™æ€æŸ¥è¯¢åˆ†æ" class="headerlink" title="4.3.8 é™æ€æŸ¥è¯¢åˆ†æ"></a>4.3.8 é™æ€æŸ¥è¯¢åˆ†æ</h4><p>Percona Toolkitä¸­çš„pt-query-advisorèƒ½å¤Ÿè§£ææŸ¥è¯¢æ—¥å¿—ï¼Œåˆ†ææŸ¥è¯¢æ¨¡å¼ï¼Œç»™å‡ºæ‰€æœ‰å¯èƒ½å­˜åœ¨æ½œåœ¨é—®é¢˜çš„æŸ¥è¯¢ï¼Œå¹¶ç»™å‡ºè¶³å¤Ÿè¯¦ç»†çš„å»ºè®®ã€‚</p><h4 id="4-3-9-ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å˜é‡"><a href="#4-3-9-ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å˜é‡" class="headerlink" title="4.3.9 ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å˜é‡"></a>4.3.9 ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å˜é‡</h4><p>æš‚ç•¥ã€‚</p><h3 id="4-4-æ¡ˆä¾‹"><a href="#4-4-æ¡ˆä¾‹" class="headerlink" title="4.4 æ¡ˆä¾‹"></a>4.4 æ¡ˆä¾‹</h3><h3 id="4-4-1-æ„å»ºä¸€ä¸ªé˜Ÿåˆ—è¡¨"><a href="#4-4-1-æ„å»ºä¸€ä¸ªé˜Ÿåˆ—è¡¨" class="headerlink" title="4.4.1 æ„å»ºä¸€ä¸ªé˜Ÿåˆ—è¡¨"></a>4.4.1 æ„å»ºä¸€ä¸ªé˜Ÿåˆ—è¡¨</h3><ul><li><p>ä¸€ä¸ªè¡¨åŒ…å«å¤šç§ç±»å‹çš„è®°å½•ï¼šæœªå¤„ç†çš„è®°å½•ã€å·²å¤„ç†è®°å½•ã€æ­£åœ¨å¤„ç†è®°å½•ã€‚</p></li><li><p>ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹åœ¨è¡¨ä¸­æŸ¥æ‰¾æœªå¤„ç†çš„è®°å½•ï¼Œç„¶åæ ‡è®°ä¸ºæ­£åœ¨å¤„ç†ï¼Œå¤„ç†å®Œæˆåå†æ›´æ–°ä¸ºå·²å¤„ç†çŠ¶æ€ã€‚</p></li><li><p>ä¸åˆç†çš„åœ°æ–¹ï¼š</p><ul><li>éšç€é˜Ÿåˆ—è¡¨è¶Šæ¥è¶Šå¤§å’Œç´¢å¼•æ·±åº¦çš„å¢åŠ ï¼Œæ‰¾åˆ°æœªå¤„ç†è®°å½•çš„é€Ÿåº¦è¶Šæ¥è¶Šæ…¢ï¼›å¯ä»¥å°†é˜Ÿåˆ—è¡¨æ‹†åˆ†ä¸ºå·²å¤„ç†å’Œæœªå¤„ç†ä¸¤éƒ¨åˆ†æ¥ä¼˜åŒ–ã€‚</li><li>å¤„ç†è¿‡ç¨‹ä¸€èˆ¬åŒ…æ‹¬ä¸¤æ­¥ï¼šæ‰¾åˆ°æœªå¤„ç†è®°å½•ï¼Œç„¶ååŠ é”ã€‚å‰è€…å¢åŠ æœåŠ¡å™¨å‹åŠ›ï¼ŒåŠ é”åˆ™è®©å„ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹å¢åŠ ç«äº‰ã€‚</li></ul></li><li><p>å¦‚ä½•è®©æ¶ˆè´¹è€…æ ‡è®°æ­£åœ¨å¤„ç†çš„è®°å½•ï¼Œè€Œä¸ä½¿å¤šä¸ªæ¶ˆè´¹è€…é‡å¤å¤„ç†åŒä¸€è®°å½•ï¼Ÿ</p><ul><li><p>ä»»ä½•æƒ…å†µéƒ½åº”é¿å…ä½¿ç”¨ SELECT FOR UPDATE ï¼Œä¼šå¯¼è‡´å¤§é‡äº‹åŠ¡é˜»å¡å¹¶ç­‰å¾…ï¼›</p></li><li><p>ç”¨ä¸€ä¸ªå±æ€§åˆ—æ ‡è¯†æ­£åœ¨å¤„ç†è®°å½•çš„è¿æ¥IDã€‚</p></li><li><p>```sql<br>BEGIN;<br>â€“æŸ¥æ‰¾æœªæœ‰çº¿ç¨‹å¤„ç†ä¸”çŠ¶æ€ä¸ºå¾…å‘é€çš„è®°å½•ID<br>SELECT id<br>FROM unsent_emails<br>WHERE owner = 0<br>  AND status = â€˜unsentâ€™<br>LIMIT 10 FOR UPDATE;<br>â€“resultï¼š123ï¼Œ456ï¼Œ789<br>â€“æ›´æ–°è¿™äº›è®°å½•çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿æ¥IDå†™å…¥owner<br>UPDATE unsent_emails<br>SET status = â€˜claimedâ€™, owner = CONNECTION_ID()<br>WHERE id IN(123, 456, 789);<br>COMMIT;</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* ä¸Šè¿°<span class="keyword">SELECT</span>èµ°äº†ç´¢å¼•ï¼Œä½†<span class="keyword">FOR</span> <span class="keyword">UPDATE</span>é”ä¼šä½¿å…¶ä»–æŸ¥è¯¢é˜»å¡ï¼Œå¯ä»¥æ”¹è¿›å¦‚ä¸‹ï¼ˆæ— éœ€ç”¨<span class="keyword">SELECT</span>æŸ¥è¯¢å“ªäº›è®°å½•è¿˜æœªè¢«å¤„ç†ï¼Œå¯ä»¥ç”¨æ¥æ”¹å†™æ‰€æœ‰çš„<span class="keyword">SELECT</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>ï¼‰ï¼š</span><br><span class="line"></span><br><span class="line">  ```<span class="keyword">sql</span></span><br><span class="line">  <span class="keyword">SET</span> AUTOCOMMIT = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">COMMIT</span>;</span><br><span class="line">  <span class="comment">--</span></span><br><span class="line">  <span class="keyword">UPDATE</span> unsent_emails</span><br><span class="line">  <span class="keyword">SET</span> status = <span class="string">&#x27;claimed&#x27;</span>, owner = CONNECTION_ID()</span><br><span class="line">  <span class="keyword">WHERE</span> owner = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">AND</span> status = <span class="string">&#x27;unsent&#x27;</span></span><br><span class="line">  <span class="keyword">LIMIT</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">SET</span> AUTOCOMMIT = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">SELECT</span> id</span><br><span class="line">  <span class="keyword">FROM</span> unsent_emails</span><br><span class="line">  <span class="keyword">WHERE</span> owner = CONNECTION_ID()</span><br><span class="line">    <span class="keyword">AND</span> status = <span class="string">&#x27;claimed&#x27;</span>;</span><br><span class="line">  <span class="comment">--resultï¼š123ï¼Œ456ï¼Œ789</span></span><br><span class="line">  <span class="comment">--æ›´æ–°è¿™äº›è®°å½•çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿æ¥IDå†™å…¥owner</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>åŸºç¡€åŸåˆ™ï¼š</p><ul><li>é™¤éä¸å¾—å·²ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨è½®è¯¢ã€‚</li><li>å°½é‡ç”¨UPDATEä»£æ›¿ SELECT FOR UPDATEï¼Œäº‹åŠ¡æäº¤è¶Šå¿«ï¼ŒæŒæœ‰é”çš„æ—¶é—´å°±è¶ŠçŸ­ï¼Œå¯ä»¥å¤§å¤§å‡å°‘ç«äº‰å’ŒåŠ é€Ÿä¸²è¡Œæ‰§è¡Œæ•ˆç‡ã€‚</li><li>å°†å·²ç»å¤„ç†å®Œæˆå’Œæœªå¤„ç†æ•°æ®åˆ†å¼€ï¼Œä¿è¯æ•°æ®é›†è¶³å¤Ÿå°ã€‚</li><li>æ— æ³•ä¼˜åŒ–çš„æŸ¥è¯¢å°è¯•ç”¨ä¸åŒç­–ç•¥æ¥å®ç°ç›¸åŒç›®çš„ã€‚</li><li>ä»»åŠ¡é˜Ÿåˆ—æœ€å¥½èƒ½ä»æ•°æ®åº“ç§»é™¤ï¼Œä½¿ç”¨Redisã€memcachedã€Q4Må¼•æ“ç­‰æ–¹æ¡ˆã€‚</li></ul></li></ul><h3 id="4-4-2-è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»"><a href="#4-4-2-è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»" class="headerlink" title="4.4.2 è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»"></a>4.4.2 è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»</h3><p>æ„Ÿè§‰ä¸æ˜¯å¸¸ç”¨çš„åœºæ™¯ï¼Œæš‚ç•¥ã€‚</p><hr><p>å‚è€ƒï¼š</p><p>ğŸ”— ã€Šé«˜æ€§èƒ½MySQLã€‹</p>]]></content>
    
    
    <summary type="html">ã€Šé«˜æ€§èƒ½MySQLã€‹è¯»ä¹¦ç¬”è®°ï¼Œå†…å®¹ï¼šä¸ºä»€ä¹ˆæŸ¥è¯¢é€Ÿåº¦ä¼šæ…¢ï¼Œä¼˜åŒ–æ•°æ®è®¿é—®ï¼ŒæŸ¥è¯¢æ‰§è¡Œçš„åŸºç¡€ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ç­‰ã€‚</summary>
    
    
    
    <category term="æŠ€æœ¯æ–‡æ¡£" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
  </entry>
  
</feed>
