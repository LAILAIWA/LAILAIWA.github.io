<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>俺的部落格</title>
  
  <subtitle>俺寻思俺需要记点东西</subtitle>
  <link href="http://linyishui.top/atom.xml" rel="self"/>
  
  <link href="http://linyishui.top/"/>
  <updated>2022-01-04T07:21:20.000Z</updated>
  <id>http://linyishui.top/</id>
  
  <author>
    <name>Lys</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Oracle-AWR报告 &lt;整&gt;</title>
    <link href="http://linyishui.top/2021123001.html"/>
    <id>http://linyishui.top/2021123001.html</id>
    <published>2021-12-31T07:01:22.000Z</published>
    <updated>2022-01-04T07:21:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Oracle-AWR报告"><a href="#Oracle-AWR报告" class="headerlink" title="Oracle-AWR报告"></a>Oracle-AWR报告</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><h3 id="1-1-什么是AWR报告？"><a href="#1-1-什么是AWR报告？" class="headerlink" title="1.1 什么是AWR报告？"></a>1.1 什么是AWR报告？</h3><p>AWR (Automatic Workload Repository) 是自动负载信息库的英文缩写，是Oracle 10g以后版本提供的一种性能收集和分析工具，能提供一个时间段内整个系统资源使用情况的报告，通过报告可以了解一个系统的整个运行情况，生成的报告包括多个部分。</p><p>AWR每小时对 <code>v$active_session_history</code> 视图（内存中的ASH采集信息，理论为1小时）进行采样一次，并将信息保存到磁盘中，并且保留7天，7天后旧的记录才会被覆盖。这些采样信息被保存在 <code>wrh$_active_session_history</code> 视图（写入AWR库中的ASH信息，理论为1小时以上）中。而这个采样频率（1小时）和保留时间（7天）是可以根据实际情况进行调整的。</p><h3 id="1-2-使用场景"><a href="#1-2-使用场景" class="headerlink" title="1.2 使用场景"></a>1.2 使用场景</h3><ul><li>查看数据库详细运行状态</li><li>测试过程中发现数据库出现瓶颈但无法定位到具体原因时，可以借用AWR报告进行分析定位。</li></ul><p>数据库出现性能问题，一般都在三个地方：IO、内存、CPU，这三个地方又是息息相关的。当IO负载增大时，肯定需要更多的内存来存放，同时也需要CPU花费更多的时间来过滤这些数据。相反，CPU时间花费多的话，有可能是解析SQL语句，也可能是过滤太多的数据，倒不一定是和IO或内存有关系。</p><ul><li>CPU：解析SQL语句，生成的执行计划。</li><li>内存：SQL语句和执行计划都需要在内存保留一段时间，还有取到的数据，根据LRU算法也会尽量在内存中保留，在执行SQL语句过程中，各种表之间的连接，排序等操作也要占用内存。</li><li>IO：如果需要的数据不在内存中，则需要到磁盘中去取，就会涉及到物理IO了；还有表之间的连接数据太多，以及排序等操作内存放不下的时候，需要用到临时表空间，也会消耗物理IO。</li></ul><p>ORACLE分配的内存中PGA一般只占20%，对于专用服务器模式，每次执行SQL语句、表数据的运算等操作，都在PGA中进行的，也就是说只能用ORACL分配内存的20%左右。如果多个用户都执行多表关联，而且表数据又多，再加上关联不当的话，内存就成为瓶颈了，所以优化SQL很重要的一点就是，减少逻辑读和物理读。</p><h3 id="1-3-生成AWR报告"><a href="#1-3-生成AWR报告" class="headerlink" title="1.3 生成AWR报告"></a>1.3 生成AWR报告</h3><p>Linux使用sqlplus生成AWR报告，安装：<a href="https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html">Instant Client for Linux x86-64</a></p><p>下载basic和sqlplus的rpm包后，上传到tmp目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">rpm -ivh oracle-instantclientXXX-basic-XXX-1.x86_64.rpm</span><br><span class="line">rpm -ivh oracle-instantclientXXX-sqlplus-XXX-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>安装完毕后，生成的客户端目录在 <strong>/usr/lib/oracle/12.2/client64</strong> ，在该目录下新建<strong>network</strong>目录，并编写<strong>tnsnames.ora</strong>文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir network</span><br><span class="line">vi tnsnames.ora</span><br><span class="line"></span><br><span class="line">testdb =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = XXX.XXX.XXX.XXX)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SID = testdb)</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p>修改完成后按下 <code>esc</code> + <code>:wq</code> 保存退出。</p><p>配置环境变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bash_profile</span><br><span class="line"></span><br><span class="line">export  ORACLE_HOME=/usr/lib/oracle/12.2/client64</span><br><span class="line">export  TNS_ADMIN=$ORACLE_HOME/network</span><br><span class="line">export  LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/local/lib:$LD_LIBRARY_PATH:.</span><br><span class="line">export  ORABIN=$ORACLE_HOME/bin</span><br><span class="line">export  NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span><br><span class="line">export ORACLE_SID=orcl</span><br><span class="line">PATH=$PATH:$ORACLE_HOME/bin:$ORABIN</span><br><span class="line"></span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure><p>登陆sqlplus：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sqlplus sys@XXX.XXX.XXX.XXX:1521/orcl AS SYSDBA</span><br><span class="line"><span class="meta">sql&gt;</span><span class="bash"> @/u01/app/oracle/12c/rdbms/admin/awrrpt.sql</span></span><br><span class="line"></span><br><span class="line">Enter value of report_type</span><br><span class="line"><span class="meta">#</span><span class="bash"> 意思是生成报告的格式有两种，html和txt，这里选择html</span></span><br><span class="line">Enter value of num_days</span><br><span class="line"><span class="meta">#</span><span class="bash"> 收集几天的报告信息，数字，可以输入1</span></span><br><span class="line">Enter value of begin_snap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入开始快照id，要根据日志打印的快照id范围来填</span></span><br></pre></td></tr></table></figure><p>生成的 <code>.lst</code> 文件直接拷贝为html打开即可。</p><h2 id="二-相关知识点"><a href="#二-相关知识点" class="headerlink" title="二. 相关知识点"></a>二. 相关知识点</h2><h3 id="2-1-硬解析和软解析"><a href="#2-1-硬解析和软解析" class="headerlink" title="2.1 硬解析和软解析"></a>2.1 硬解析和软解析</h3><h4 id="（1）SQL执行过程"><a href="#（1）SQL执行过程" class="headerlink" title="（1）SQL执行过程"></a>（1）SQL执行过程</h4><p>Oracle中SQL的执行过程：</p><ol><li><strong>语法检查</strong>（syntax check）：检查此SQL的拼写是否符合语法。如关键字书写错误等。</li><li><strong>语义检查</strong>（semantic check）：诸如检查SQL语句中的访问对象是否存在及该用户是否具备相应的权限。如 <code>ORA-00942: table or view does not exist</code> 等。</li><li>对SQL语句进行<strong>解析</strong>（prase）：利用内部算法对SQL进行解析，生成解析树（parse tree）及执行计划（execution plan）。</li><li>执行SQL，返回结果（execute and return）。</li></ol><h4 id="（2）什么是软、硬解析？"><a href="#（2）什么是软、硬解析？" class="headerlink" title="（2）什么是软、硬解析？"></a>（2）什么是软、硬解析？</h4><p>硬解析和软解析就发生在第三步。Oracle利用hash算法来取得SQL的hash值，然后在library cache里查找是否存在该hash值；</p><ul><li>假设存在，则将此SQL与cache中的进行比较；</li><li>假设“相同”，就将利用已有的解析树与执行计划，而省略了优化器的相关工作。这也就是软解析的过程。</li></ul><p>当然，如果上面的2个假设中任有一个不成立，那么优化器都将进行创建解析树、生成执行计划的动作。这个过程就叫硬解析。创建解析树、生成执行计划对于SQL的执行来说是开销昂贵的动作；以及会占据重要的门闩（latch）资源，严重的影响系统的规模的扩大（即限制了系统的并发行）， 而且引起的问题不能通过增加内存条和cpu的数量来解决。所以应当极力避免硬解析，尽量使用软解析。</p><blockquote><p>闩是锁的细化，可以理解为是一种轻量级的串行化设备。当进程申请到闩后，则这些闩用于保护共享内存的数在同一时刻不会被两个以上的进程修改。在硬解析时，需要申请闩的使用，而闩的数量在有限的情况下需要等待。大量的闩的使用由此造成需要使用闩的进程排队越频繁，性能则逾低下。</p><p>绝大多数latch问题都与没有使用绑定变量有关：</p><ul><li>library-cache latch（库缓存latch）</li><li>重做日志生成问题（redo-allocation latch，重做日志的分配latch ）</li><li>缓存竞争问题（cache-buffers LRU-chain latch，缓存的最近最少使用链latch）</li><li>缓存中的热块（cache-buffers chain latch，缓存链latch）</li></ul></blockquote><p><strong>软解析执行过程</strong>：</p><ul><li>语法、语义及权限检查;</li><li>将整条SQL hash后从库缓存中执行计划。</li></ul><p><strong>硬解析执行过程</strong>：</p><ul><li>语法、语义及权限检查;</li><li>查询转换，通过应用各种不同的转换技巧，会生成语义上等同的新的SQL语句，如 <code>count(1)</code> 会转为 <code>count(*)</code> 。</li><li>根据统计信息生成执行计划，找出成本最低的路径，这一步比较耗时</li><li>将游标信息（执行计划）保存到库缓存（library cache）。</li></ul><p>还包括一种软软解析，指设置了session_cursor_cache后，Cursor被直接Cache在当前Session的PGA中的，在解析的时候只需要对其语法分析、权限对象分析之后就可以转到PGA中查找。</p><p>DDL和DML：</p><ul><li>DDL：CREATE,DROP,ALTER等，必然进行硬解析。</li><li>DML：INSERT,UPDATE,DELETE,SELECT等，进行硬解析或软解析。</li></ul><p>硬解析和软解析模拟：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 硬解析，不使用绑定变量</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> object_id<span class="operator">=</span><span class="number">20</span>; </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> object_id<span class="operator">=</span><span class="number">30</span>; </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> object_id<span class="operator">=</span><span class="number">40</span>; </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> object_id<span class="operator">=</span><span class="number">50</span>; </span><br><span class="line"></span><br><span class="line"># 软解析，使用绑定变量</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">  sql_stat varchar2(<span class="number">200</span>);</span><br><span class="line">  p00      number(<span class="number">10</span>);</span><br><span class="line">  p01      varchar2(<span class="number">20</span>);</span><br><span class="line">  p02      varchar2(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  p00 :<span class="operator">=</span> <span class="number">3</span>; </span><br><span class="line">  p01 :<span class="operator">=</span> <span class="string">&#x27;321&#x27;</span>; </span><br><span class="line">  p02 :<span class="operator">=</span> <span class="string">&#x27;34030&#x27;</span>;</span><br><span class="line">  sql_stat :<span class="operator">=</span> <span class="string">&#x27;update xxx_table set XXX_time = TO_NUMBER(TO_CHAR(SYSDATE,&#x27;&#x27;YYYYMMDD.HH24MISS&#x27;&#x27;)), XXX_no = &#x27;</span><span class="operator">||</span> p00 <span class="operator">||</span><span class="string">&#x27;,    XXX_desc = &#x27;</span><span class="operator">||</span> p01 <span class="operator">||</span><span class="string">&#x27;    where XXX_ID = &#x27;</span><span class="operator">||</span> p02 <span class="operator">||</span><span class="string">&#x27;   and XXX_no != &#x27;&#x27;4&#x27;&#x27; &#x27;</span>;</span><br><span class="line">  dbms_output.put_line(sql_stat);</span><br><span class="line">  <span class="keyword">execute</span> immediate sql_stat;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h4 id="（3）绑定变量"><a href="#（3）绑定变量" class="headerlink" title="（3）绑定变量"></a>（3）绑定变量</h4><p>日常使用中，硬解析过高常常因为SQL未使用绑定变量导致。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用绑定变量</span></span><br><span class="line"><span class="keyword">select</span> xxx <span class="keyword">from</span> table_a <span class="keyword">where</span> a <span class="operator">=</span> :a <span class="keyword">and</span> b <span class="operator">=</span> :b;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不使用绑定变量</span></span><br><span class="line"><span class="keyword">select</span> xxx <span class="keyword">from</span> table_a <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> b <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> xxx <span class="keyword">from</span> table_a <span class="keyword">where</span> a <span class="operator">=</span> <span class="number">2</span> <span class="keyword">and</span> b <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;</span><br></pre></td></tr></table></figure><p>Oracle接收SQL后，首先根据Hash算法得到Hash值，然后在共享池寻找是否有匹配的SQL。如果存在则直接用已有的SQL执行计划来执行，最后返回结果。如果不存在，则需要执行硬解析。</p><p>绑定变量只是起到占位的作用，让Oracle每次对用户发来的SQL做hash运算时，运算出的结果都是同样的Hash值，于是将所有的用户发来的SQL看作是同一个SQL来对象。</p><p>所以合理的使用绑定变量后，Oracle可以在共享池中命中相同SQL，然后从而避免了高昂的硬解析操作，以及减少latch争用，特别是在这个SQL调用次数较多和频繁的场景下。</p><h4 id="（4）Oracle排查硬解析SQL"><a href="#（4）Oracle排查硬解析SQL" class="headerlink" title="（4）Oracle排查硬解析SQL"></a>（4）Oracle排查硬解析SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看系统解析统计信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%parse%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 硬解析统计信息，通过观察value变化可以来确定SQL是否走了硬解析</span></span><br><span class="line"><span class="keyword">select</span> name,class,<span class="keyword">value</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;parse count (hard)&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.value,b.name <span class="keyword">from</span> v$mystat a, v$statname b </span><br><span class="line"><span class="keyword">where</span> a.STATISTIC#<span class="operator">=</span>b.STATISTIC# <span class="keyword">and</span> b.name <span class="keyword">like</span> <span class="string">&#x27;%parse%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定SQL内容的执行信息，如解析次数，加载次数，执行次数等</span></span><br><span class="line"><span class="keyword">select</span> sql_text,s.parse_calls,loads,executions,FORCE_MATCHING_SIGNATURE </span><br><span class="line"><span class="keyword">from</span> v$<span class="keyword">sql</span> s <span class="keyword">where</span> sql_text <span class="keyword">like</span> <span class="string">&#x27;update XXX_table%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> sql_id,sql_text,executions,last_load_time <span class="keyword">from</span> v$sqlarea </span><br><span class="line"><span class="keyword">where</span> sql_text <span class="keyword">like</span> <span class="string">&#x27;update XXX_table%&#x27;</span></span><br><span class="line"><span class="keyword">and</span> last_load_time <span class="operator">&gt;</span> trunc(sysdate<span class="number">-1</span><span class="operator">/</span><span class="number">24</span>) <span class="keyword">order</span> <span class="keyword">by</span> last_load_time <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按解析次数排序，找出解析次数较多的SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> sql_id,substr(sql_text,<span class="number">1</span>,<span class="number">40</span>) <span class="keyword">sql</span>, parse_calls, executions, hash_value,address <span class="keyword">FROM</span> V$SQLAREA <span class="keyword">WHERE</span> parse_calls <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">order</span> <span class="keyword">by</span> parse_calls <span class="keyword">desc</span>;</span><br><span class="line"><span class="comment">-- 变种1</span></span><br><span class="line"><span class="keyword">SELECT</span> sql_id,sql_text, parse_calls,loads, executions, hash_value,address <span class="keyword">FROM</span> V$SQLAREA </span><br><span class="line"><span class="keyword">WHERE</span> parse_calls <span class="operator">&gt;</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">and</span> kept_versions <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">and</span> executions <span class="operator">&lt;</span> <span class="number">2</span><span class="operator">*</span>parse_calls</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> parse_calls <span class="keyword">desc</span>;</span><br><span class="line"><span class="comment">-- 变种2</span></span><br><span class="line"><span class="keyword">SELECT</span> sql_id,sql_text, parse_calls,loads, executions, hash_value,address <span class="keyword">FROM</span> V$SQLAREA </span><br><span class="line"><span class="keyword">WHERE</span> executions <span class="operator">&gt;</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> executions <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查找指定的SQL内容，Oracle根据hash_value来查找SQL，所以不同hash值会解析多次</span></span><br><span class="line"><span class="keyword">SELECT</span> sql_id,sql_text, parse_calls,loads, executions, hash_value,address </span><br><span class="line"><span class="keyword">FROM</span> V$SQLAREA </span><br><span class="line"><span class="keyword">WHERE</span> sql_text <span class="keyword">like</span> <span class="string">&#x27;%SELECT xxx FROM xxx%&#x27;</span></span><br></pre></td></tr></table></figure><p>硬解析的SQL会在 <code>v$sql_shared_cursor</code> 返回字段为Y：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> v$<span class="keyword">sql</span> t <span class="keyword">where</span> t.SQL_ID <span class="operator">=</span> <span class="string">&#x27;5auzajv4fy8gm&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sqlarea t <span class="keyword">where</span> t.SQL_ID <span class="operator">=</span> <span class="string">&#x27;5auzajv4fy8gm&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sql_shared_cursor <span class="keyword">where</span> SQL_ID <span class="operator">=</span> <span class="string">&#x27;5auzajv4fy8gm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分组汇总硬解析次数最多的SQL内容</span></span><br><span class="line"><span class="keyword">SELECT</span> substr (sql_text,<span class="number">0</span>, <span class="number">40</span>), <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> v$sql_shared_cursor c, v$<span class="keyword">sql</span> s</span><br><span class="line"><span class="keyword">where</span> c.sql_id <span class="operator">=</span> s.sql_id </span><br><span class="line">  <span class="keyword">and</span> (UNBOUND_CURSOR <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line">     SQL_TYPE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> OPTIMIZER_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> OUTLINE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> STATS_ROW_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> LITERAL_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> FORCE_HARD_PARSE <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> EXPLAIN_PLAN_CURSOR <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span> </span><br><span class="line"> BUFFERED_DML_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PDML_ENV_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> INST_DRTLD_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> SLAVE_QC_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> TYPECHECK_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> AUTH_CHECK_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> BIND_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> DESCRIBE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LANGUAGE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> TRANSLATION_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> BIND_EQUIV_FAILURE <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> INSUFF_PRIVS <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> INSUFF_PRIVS_REM <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> REMOTE_TRANS_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LOGMINER_SESSION_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> INCOMP_LTRL_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> OVERLAP_TIME_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> EDITION_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> MV_QUERY_GEN_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> USER_BIND_PEEK_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> TYPCHK_DEP_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> NO_TRIGGER_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> FLASHBACK_CURSOR <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> ANYDATA_TRANSFORMATION <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PDDL_ENV_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> TOP_LEVEL_RPI_CURSOR <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> DIFFERENT_LONG_LENGTH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LOGICAL_STANDBY_APPLY <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> DIFF_CALL_DURN <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> BIND_UACS_DIFF <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PLSQL_CMP_SWITCHS_DIFF <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> CURSOR_PARTS_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> STB_OBJECT_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> CROSSEDITION_TRIGGER_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PQ_SLAVE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> TOP_LEVEL_DDL_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> MULTI_PX_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> BIND_PEEKED_PQ_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> MV_REWRITE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> ROLL_INVALID_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> OPTIMIZER_MODE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PX_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> MV_STALEOBJ_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> FLASHBACK_TABLE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LITREP_COMP_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PLSQL_DEBUG <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LOAD_OPTIMIZER_STATS <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> ACL_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> FLASHBACK_ARCHIVE_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LOCK_USER_SCHEMA_FAILED <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> REMOTE_MAPPING_MISMATCH <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> LOAD_RUNTIME_HEAP_FAILED <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> HASH_MATCH_FAILED <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> PURGED_CURSOR <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> BIND_LENGTH_UPGRADEABLE <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span><span class="keyword">OR</span></span><br><span class="line"> USE_FEEDBACK_STATS <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> substr (sql_text,<span class="number">0</span>, <span class="number">40</span>)</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">count</span> (<span class="operator">*</span>) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><h2 id="三-AWR解析"><a href="#三-AWR解析" class="headerlink" title="三. AWR解析"></a>三. AWR解析</h2><h3 id="3-1-数据库信息"><a href="#3-1-数据库信息" class="headerlink" title="3.1 数据库信息"></a>3.1 数据库信息</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010101.png"></p><ul><li>数据库的版本</li><li>数据库 DBID</li><li>数据库实例名称及实例号</li><li>数据库最近一次启动时间</li><li>数据库版本</li><li>数据库是否为rac</li></ul><h3 id="3-2-服务器信息"><a href="#3-2-服务器信息" class="headerlink" title="3.2 服务器信息"></a>3.2 服务器信息</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010102.png"></p><ul><li>数据库主机名</li><li>数据库主机平台</li><li>服务器CPU及核数</li><li>服务器CPU个数</li><li>服务器内存大小</li></ul><h3 id="3-3-SnapShot信息"><a href="#3-3-SnapShot信息" class="headerlink" title="3.3 SnapShot信息"></a>3.3 SnapShot信息</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010103.png"></p><ul><li>awr报告的起止时间以及当时的session数量等</li><li>awr报告持续时间</li><li>DB 时间</li></ul><p>DB Time= session time spent in database.</p><p>DB Time= CPU Time + Non IDLE wait time.</p><p>可以看到DB Time比 Elapsed大，如果大很多并且有性能问题，需再进一步分析</p><h3 id="3-4-Shared-Pool-Statistics"><a href="#3-4-Shared-Pool-Statistics" class="headerlink" title="3.4 Shared Pool Statistics"></a>3.4 Shared Pool Statistics</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010104.png"></p><p>% SQL with executions&gt;1指的是执行次数大于1的SQL比例，越大越好，如过小则可能是为使用绑定变量导致</p><ul><li><p><code>Memory Usage %</code> ：</p><ul><li><p>该指标指的是Oracle数据库Shared Pool的使用率，适用于OLTP系统。</p></li><li><p>该指标一般要求在70%-85%之间。</p></li><li><p>过高说明Shared Pool 剩余空间不足，我们需要查找具体原因或者增加其空间。</p></li><li><p>过低说明Shared Pool 剩余空间过多，造成内存的浪费需要减少Shared Pool 的大小。</p></li></ul></li><li><p><code>% SQL with executions&gt;1</code> :</p><ul><li>该指标指的是Shared Pool 中的SQL语句执行次数大于1的比例，适用于OLTP系统。</li><li>该指标越高越好，如过低说明SQL 未被复用，请检查绑定变量的问题。</li><li>该指标可和上节Instance Efficiency Percentages 部分中的Parse相关指标作对比。</li></ul></li><li><p><code>% Memory for SQL w/exec&gt;1</code> ：</p><ul><li>该指标指的是执行次数大于1的SQL语句占用的Shared Pool内存比例。</li><li>该指标越低说明Shared Pool内存更多的被用在存储不能复用的语句上。从侧面反映出硬解析比较严重。</li></ul></li></ul><h3 id="3-5-Load-Profile"><a href="#3-5-Load-Profile" class="headerlink" title="3.5 Load Profile"></a>3.5 Load Profile</h3><p>了解系统负载的情况：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010105.png"></p><ul><li><strong>DB CPU(s) per second</strong>：说明的是每秒钟同时工作的CPU数量，从主机配置可以看到共24个虚拟cpu，而DB CPU(s) per second只有0.2则说明cpu没有瓶颈</li></ul><p>其次关注hard parses和 parses的比例，如硬解析率非常高则需要查看cursor_sharing参数和应用程序的绑定变量问题，一般都是由于绑定变量引起的。</p><h3 id="3-6-Instance-Efficiency-Percentages"><a href="#3-6-Instance-Efficiency-Percentages" class="headerlink" title="3.6 Instance Efficiency Percentages"></a>3.6 Instance Efficiency Percentages</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010106.png"></p><p>上面的百分比越高越好，<code>% Non-Parse CPU</code> 指的是数据的CPU资源有78.03%用在非解析上，不算高。理论上说上述比例应接近100%。</p><h4 id="3-6-1-Buffer-Nowait"><a href="#3-6-1-Buffer-Nowait" class="headerlink" title="3.6.1 Buffer Nowait %"></a>3.6.1 Buffer Nowait %</h4><p>该指标指的是可立即访问SGA 中所有数据而不用等待的次数的比例，该指标应接近100%</p><p>如发现该指标过低,则检查awr报告中 <strong>Buffer Wait Statistics</strong> 部分来查看哪种类型的块导致等待。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010113.png"></p><h4 id="3-6-2-Redo-NoWait"><a href="#3-6-2-Redo-NoWait" class="headerlink" title="3.6.2 Redo NoWait %"></a>3.6.2 Redo NoWait %</h4><p>该指标指的是redo条目（redo-entries）在redo log中可立即生成而不用等待的次数与全部redo entries的比例。redo entry对应的是每一个DML语句。</p><p>计算公式：<code>100 x (1- (redo log space requests/redo entries)</code> </p><ul><li><strong>redo log space requests</strong> 该请求会在数据库进程请求生成redo entry，而这时redo log空间满的情况下发生，这时数据库会被动的进行日志切换以使事务可以继续进行。</li><li><strong>redo entries</strong> 会在每次redo entry 写入 redo log时增加</li></ul><p>上述2个值可通过视图 <code>v$sysstat</code> 查看，<strong>注意它们的值是累积的</strong>。一般来说我们需要保持redo log space requests的值不增长。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;redo log space requests&#x27;</span>, <span class="string">&#x27;redo entries&#x27;</span>);</span><br></pre></td></tr></table></figure><p>如果该参数过低:</p><ol><li>如redo log切换十分频繁(约15分钟切换一次)，则需要增加online redo log大小。</li><li>如果redo log切换不频繁，则说明可能是磁盘IO性能太慢，需将online redo log放置到高性能磁盘中。</li></ol><h4 id="3-6-3-Buffer-Hit"><a href="#3-6-3-Buffer-Hit" class="headerlink" title="3.6.3 Buffer Hit %"></a>3.6.3 Buffer Hit %</h4><p>该指标指的是数据库请求的数据在buffer cache中直接命中的比例。该指标越高代表oracle在buffer cache直接找到需要的数据越多，从而不需要从磁盘进行读取。buffer cache（内存）中读取的速率是从磁盘读取速率的成百上千倍。</p><p>该参数在OLAP和DSS系统中不太重要，因为他们有大量的全表扫描或者并行操作。并行操作有时会跳过buffer cache 而使用PGA。该参数对于OLTP系统非常重要，需要保持在90%以上，因为其有大量连续的操作，从磁盘读取将大大影响系统性能。</p><p>如该指标过低可使用 <strong>data buffer cache advisory</strong> 查看合适建议并修改 <strong>db_cache_size</strong> 参数大小。</p><h4 id="3-6-4-In-memory-Sort"><a href="#3-6-4-In-memory-Sort" class="headerlink" title="3.6.4 In-memory Sort %"></a>3.6.4 In-memory Sort %</h4><p>该参数反应了内存内排序和磁盘排序之间的比例，计算公式为 ：<code>(DeltaMemorySorts / (DeltaDiskSorts + DeltaMemorySorts)) * 100</code> 。disk sort的在temp表空间中进行，他的速度比内存排序慢成百上千倍。</p><p>该查询的值为累计值，计算时应取观察时间段的差值（从instance启动开始）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;sorts (memory)&#x27;</span>, <span class="string">&#x27;sorts (disk)&#x27;</span>);</span><br></pre></td></tr></table></figure><p>存储区域：</p><ul><li>专用服务器( dedicated )类型中，排序区域分配在PGA中。</li><li>共享服务器(shared)类型中，排序区域在 large pool 中，由于是共用的无法手动指定各个session使用的大小。</li></ul><p>如该指标过低，需增加sort area 的大小。in-memory sorts的大小被sort_area_size或者pga_aggregate_target控制。</p><h4 id="3-6-5-Library-Hit"><a href="#3-6-5-Library-Hit" class="headerlink" title="3.6.5 Library Hit %"></a>3.6.5 Library Hit %</h4><p>library cache hit ratio，指的是将要执行的SQL 语句或者PL/SQL 代码已经存在于shared pool中的library cache中并可复用。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010114.png"></p><p>查看：</p><ul><li><p><strong>监控库缓冲命中率及重载率(9i及以上)：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span> (pins) &quot;Eexcutions&quot;,</span><br><span class="line">       <span class="built_in">sum</span>(pinhits) &quot;Hits&quot;,</span><br><span class="line">       round((( <span class="built_in">sum</span> (pinhits) <span class="operator">/</span> <span class="built_in">sum</span> (pins)) <span class="operator">*</span> <span class="number">100</span>),<span class="number">2</span> ) &quot;PinHitRatio&quot;,</span><br><span class="line">       <span class="built_in">sum</span>(reloads) &quot;Misses&quot;,</span><br><span class="line">     round((( <span class="built_in">sum</span> (pins) <span class="operator">/</span> (<span class="built_in">sum</span> (pins) <span class="operator">+</span> <span class="built_in">sum</span>(reloads))) <span class="operator">*</span> <span class="number">100</span> ),<span class="number">2</span>) &quot;RelodHitRatio&quot;</span><br><span class="line">  <span class="keyword">from</span> v$librarycache;</span><br></pre></td></tr></table></figure></li><li><p>**查看库缓冲命中率(10g及以上)**：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysmetric <span class="keyword">where</span> metric_name <span class="operator">=</span> <span class="string">&#x27;Library Cache Hit Ratio&#x27;</span>;</span><br></pre></td></tr></table></figure></li></ul><p>如果该指标过低说明SQL过早的被挤出shared pool，可能是由于shared pool过小导致。需要和软解析(soft parse)率进行比较，如过两者都低，需检查解析问题，如绑定变量是否使用。</p><h4 id="3-6-6-Soft-Parse"><a href="#3-6-6-Soft-Parse" class="headerlink" title="3.6.6 Soft Parse %"></a>3.6.6 Soft Parse %</h4><p>软解析指的是需要执行的SQL语句或PL/SQL程序可以在library cache中找到并重复使用。计算公式为：<code>((DeltaParseCountTotal - DeltaParseCountHard) / DeltaParseCountTotal) * 100</code> </p><p>可以通过 <code>v$sysstat</code> 查看到，注意该参数是累积的，计算时需计算时间段的差值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;parse count (hard)&#x27;</span>, <span class="string">&#x27;parse count (total)&#x27;</span>);</span><br></pre></td></tr></table></figure><p>如该指标过低(80%),需检查是否有绑定变量问题，并查看parse 的TOP SQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysmetric <span class="keyword">where</span> metric_name <span class="operator">=</span> <span class="string">&#x27;Library Cache Hit Ratio&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如果该指标很高，也不代表不能优化，也需要查看排在前列的语句是否需要优化</p><h4 id="3-6-7-Execute-to-Parse"><a href="#3-6-7-Execute-to-Parse" class="headerlink" title="3.6.7 Execute to Parse %"></a>3.6.7 Execute to Parse %</h4><p>该指标是SQL执行次数和解析次数的比值，计算公式为：<code>round(100*(1-parse/exe),2)</code> 。</p><p>从公式可以看出:</p><ul><li>当parse和execute相差不大时，比值趋近于0，说明每次执行都会进行解析</li><li>当parse远小于execute使，比值接近1，说明解析一次可以执行多次，这是非常好的</li></ul><p>可以通过 <code>v$sysstat</code> 查看到，注意该参数是累积的，计算时需时时间段的差值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;parse count (total)&#x27;</span>, <span class="string">&#x27;execute count&#x27;</span>);</span><br></pre></td></tr></table></figure><p>有人会建议设置cursor sharing = similar，会针对相似语句使用软解析，但这样是不可取的，可能会导致性能问题。</p><p>若该指标过低，往往是开发人员的程序造成的，如未使用绑定变量。可参考 <a href="https://asktom.oracle.com/pls/asktom/f?p=100:11:0::::P11_QUESTION_ID:1594740500346667363">官方</a> ：</p><ul><li>You should do it in a single SQL statement if at all possible.</li><li>If you cannot do it in a single SQL Statement, then do it in PL/SQL.</li><li>If you cannot do it in PL/SQL, try a Java Stored Procedure.</li><li>If you cannot do it in Java, do it in a C external procedure.</li><li>If you cannot do it in a C external routine, you might want to seriously think about why it is you need to do it…</li></ul><h4 id="3-6-8-Latch-Hit"><a href="#3-6-8-Latch-Hit" class="headerlink" title="3.6.8 Latch Hit %"></a>3.6.8 Latch Hit %</h4><p>该指标指的是latch不需要等待即可获取的比例。计算公式为：<code>SELECT (1 - (Sum(misses) / Sum(gets))) * 100 FROM v$latch;</code> 。</p><p>可以从 <code>v$latch</code> 视图获取相关信息：</p><ul><li>GETS:以 willing-to-wait 模式请求latch的次数</li><li>MISSES:以 willing-to-wait 模式请求latch但是需要等待的次数</li><li>SLEEPS:以 willing-to-wait 模式请求latch需要等待并且超时的次数</li><li>IMMEDIATE_GETS:以no-wait模式请求latch的次数</li><li>IMMEDIATE_MISSES:以no-wait模式请求latch且失败(miss)的次数</li><li>SPIN_GETS:以willing-to-wait模式请求latch需要等待，但是在spin中获得的次数</li></ul><p>latch是Oracle的一种轻量级的锁，用于保护共享内存，如确保一个数据块同一时间只能被一个session访问等等</p><ul><li>Cache Buffer Chains</li><li>Redo Copy Latch</li><li>…..</li></ul><p>latch获取有2种方式</p><ol><li><p>willing-to-wait：大部分latch采用如下模式，若第一次未取得latch时采用等待的方法。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010115.png"></p></li><li><p>no-wait：少部分latch采用这种模式，当第一次获取不到该latch时就不进行等待，直接进入sleep状态。</p></li></ol><p>如此指标低于90%则说明latch等待严重，可查看awr报告的等待事件部分。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010116.png"></p><p>如上图表明library cache存在冲突。</p><h4 id="3-6-9-Parse-CPU-to-Parse-Elapsd"><a href="#3-6-9-Parse-CPU-to-Parse-Elapsd" class="headerlink" title="3.6.9 Parse CPU to Parse Elapsd %"></a>3.6.9 Parse CPU to Parse Elapsd %</h4><p>该指标指的是解析过程中CPU时间占的比重。由于解析需要CPU进行操作，如在解析过程中有什么东西阻止进程访问CPU，则会导致该比例过小。如该比例为100%说明解析过程中没有等待。该指标的计算公式为：<code>(parse time cpu/parse time elapsed)*100</code> </p><p>数值可从 <code>v$sysstat</code> 视图获取，注意该参数是累积的，计算时需时时间段的差值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;parse time cpu&#x27;</span>, <span class="string">&#x27;parse time elapsed&#x27;</span>);</span><br></pre></td></tr></table></figure><p>如此指标过低说明可能为shared pool 存在冲突，可能为shared pool过小或未使用绑定变量所致。</p><h4 id="3-6-10-Non-Parse-CPU"><a href="#3-6-10-Non-Parse-CPU" class="headerlink" title="3.6.10 % Non-Parse CPU"></a>3.6.10 % Non-Parse CPU</h4><p>该参数的意义就像是字面上的，表明的是用在非解析上面的CPU时间。该指标的计算公式为：<code>(parse time cpu/CPU used by this session)*100</code> 。</p><p>数值可从 <code>v$sysstat</code> 视图获取，注意该参数是累积的，计算时需时时间段的差值：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$sysstat <span class="keyword">where</span> name <span class="keyword">in</span> (<span class="string">&#x27;parse time cpu&#x27;</span>, <span class="string">&#x27;CPU used by this session&#x27;</span>);</span><br></pre></td></tr></table></figure><p>如此指标过低(95%)说明CPU时间用在解析上的时间过多，一般是由于SQL未复用导致，也就是未使用绑定变量。</p><h3 id="3-7-Top-10-Foreground-Events-by-Total-Wait-Time"><a href="#3-7-Top-10-Foreground-Events-by-Total-Wait-Time" class="headerlink" title="3.7 Top 10 Foreground Events by Total Wait Time"></a>3.7 Top 10 Foreground Events by Total Wait Time</h3><p>这里是排名前十的前台等待事件：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010107.png"></p><ol><li>首先看wait class栏位，如果是 User I/O , System I/O, Others这种的可以不用太担心，如发现Concurrency这类等待需要特别关心</li><li>其次看等待时间，wait avg=total wait time(总等待时间)/waits(等待次数),最主要看平均等待时间是否正常</li></ol><h4 id="3-7-1-db-file-sequential-read"><a href="#3-7-1-db-file-sequential-read" class="headerlink" title="3.7.1 db file sequential read"></a>3.7.1 db file sequential read</h4><ul><li><strong>物理读</strong>发生在一个用户需要的数据块不在SGA，从而将其从磁盘读取到SGA中。如果此时别的会话需要该数据块则必须等待这个过程结束，这时就产生了等待。</li><li><strong>顺序读</strong>是物理读的一种方式，这里的顺序指的是读取数据块到一个连续的内存区域，而且总是读取单个数据块(single-block read)。</li></ul><p>如果该等待严重说明数据块存在严重的争用情况。</p><p>单个数据块读（single-block read）是由SQL语句引起的，用户发出或者递归调用，一般发生在以下情况：</p><ul><li>索引扫描</li><li>表扫描（access by rowid）</li><li>全表扫描（很少发生，例如刚好在extent边缘恰巧被分割成单块，或者已经在buffer cache中）</li></ul><p>由于物理读是非常正常的，出现这个等待事件不意味着数据库出现性能问题。但是如果在AWR报告等待事件相关中看到其处于非常前的位置时就需要引起我们的注意了。</p><p>特别需要关注Avg Waits 参数，最好小于10ms，这里可采用如下方法进行解决：</p><ul><li>将数据文件放在高速磁盘中，提高读取性能，避免热块。</li><li>将数据文件放在LUN（即一些存储设备）中，可确保数据块分散在足够多的磁盘中。</li></ul><p>在优化磁盘的同时，我们还需要注意应用程序的SQL语句问题，因为一般这种等待都是由SQL语句造成的，我们需要找出找出相应的SQL语句。可能是索引使用不当导致，这时我们可以定位到具体的表或索引，通过执行计划判断索引是否合理，是否需要走全表扫描等等方式来进行优化。</p><p>如下是一些常用的诊断方式，通过如下方式定位到具体的会话，在通过sql_id或hash_value找出具体的语句用于优化：</p><ol><li><p>查看当前正在等待的会话：</p><p>我们可以查看 <code>v$session_wait</code> 视图的TIME_WAITED栏位来定位当前哪个会话等待sequential read过长时间（实时）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session_Wait <span class="keyword">where</span> event <span class="operator">=</span> <span class="string">&#x27;db file sequential read&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>P1代表File ID，可通过dba_data_File视图的FILE_ID字段看出是哪个数据文件。</li><li>P2代表 First block，即该块在数据文件上开始的位置。</li><li>P3代表块数，由于sequential read为单块读，则该值始终为1。</li></ul><p>我们可以通过P1，P2参数得出对象的名称和类型：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">   segment_name,</span><br><span class="line">   segment_type</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">   dba_extents</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">   file_id <span class="operator">=</span> <span class="number">128</span> </span><br><span class="line"><span class="keyword">and</span></span><br><span class="line">   <span class="number">3277531</span> <span class="keyword">between</span> </span><br><span class="line">   (block_id <span class="keyword">and</span> block_id <span class="operator">+</span> blocks <span class="operator">-</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>查看从实例启动以来等待的会话：</p><p>使用 <code>v$session_event</code> 视图来定位哪个会话等待sequential read过长时间（非实时）。也可使用 <code>v$system_event</code> 视图查看系统整体的等待事件。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sid, total_waits, time_waited</span><br><span class="line">  <span class="keyword">FROM</span> v$session_event</span><br><span class="line"> <span class="keyword">WHERE</span> event<span class="operator">=</span><span class="string">&#x27;db file sequential read&#x27;</span></span><br><span class="line">  <span class="keyword">and</span> total_waits<span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">3</span> <span class="keyword">desc</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure><p>注意由于SID是可以复用的，这样查出来的有可能有问题。比如查看SID为617的会话对应的语句也有可能是上个SQL语句导致的sequential read等待，这点需要注意。</p></li></ol><ul><li><p>查看高物理读的数据文件：可以通过awr报告中的 <code>Tablespace IO Stats</code> 和 <code>File IO Stats</code> 区域来定位最多IO操作的表空间和数据文件，如果可以请将其放置在高速的磁盘中（SSD）。</p></li><li><p>查看高物理读的SQL语句：同样可以查看v$sql中高物理读的语句以及awr报告中的 <code>SQL ordered by Reads</code> 区域</p></li></ul><h4 id="3-7-2-db-file-scattered-read"><a href="#3-7-2-db-file-scattered-read" class="headerlink" title="3.7.2 db file scattered read"></a>3.7.2 db file scattered read</h4><p>离散读是物理读的一种方式，这里的离散指的是读取数据块到一块离散(不连续)的内存区域，而且一般读取多个数据块（multi-block read），可能为单个数据库。每次读取的块数由 <code>DB_FILE_MULTIBLOCK_READ_COUNT</code> 参数控制，这点不同于sequential read。</p><p>下图为各种读取方式的比较：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010122.png"></p><p>多数据块读（multi-block read）是由SQL语句引起的，用户发出或者递归调用，一般发生在以下情况：</p><ul><li>全表扫描( full table scans )</li><li>索引快速全扫描( index fast full scans)</li></ul><p>在优化磁盘的同时，我们还需要注意应用程序的SQL语句问题，因为一般这种等待都是SQL语句造成的，我们需要找出相应的SQL语句：</p><ol><li>通过执行计划进行优化判断全表扫描或者索引全扫描是否合理，是否使用了合适的驱动表，以需要达到减少物理读和逻辑读的目的。</li><li>执行计划中 <code>HASH JOIN</code> 和 <code>SORT MERGE</code> 动作（operation）会导致scattered read。</li><li>可增加 <code>DB_FILE_MULTIBLOCK_READ_COUNT</code> 参数的值来减少IO次数。</li><li>调整 <code>HASH_AREA_SIZE</code> 和 <code>OPTIMIZER_INDEX_COST_ADJ</code> 参数的值也可用来优化scattered read。</li><li>保证统计信息的及时性。</li></ol><p>与db file sequential read的区别在event值为 <code>db file scattered read</code> 。</p><h4 id="3-7-3-log-file-sync"><a href="#3-7-3-log-file-sync" class="headerlink" title="3.7.3 log file sync"></a>3.7.3 log file sync</h4><p>当用户提交（commit）语句时，一个进程会建立一个redo记录并把它拷贝至SGA中的log buffer中，然后这个进程会通知LGWR进程再将log buffer中的内容写入日志文件（redo file）中，同时清空log buffer的内容，最后返回完成消息，这就完成了一次commit操作。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010123.png"></p><p>commit动作在LGWR进程没有返回完成消息前是不会完成的，我们把LGWR将log buffer中的内容写入日志文件（redo file）以及返回完成消息的这段时间标记为log file sync等待事件，它有个1s的超时时间。这个等待事件往往伴随着log file parallel write等待事件。</p><p>log buffer大小：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">parameter</span> log_buffer</span><br></pre></td></tr></table></figure><p>这里需要注意的是LGWR写log buffer内容至日志文件有多种情况：</p><ul><li>每三秒钟</li><li>每一次commit</li><li>当其1/3满的时候</li><li>当其达到1M的时候</li></ul><p>查看LGWR进程等待情况（整体）：通过上面的讲解我们知道log file sync事件和LWGR进程相关，我们可以查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sid, event, time_waited, time_waited_micro</span><br><span class="line">  <span class="keyword">from</span> v$session_event</span><br><span class="line"> <span class="keyword">where</span> sid <span class="keyword">in</span> (<span class="keyword">select</span> sid <span class="keyword">from</span> v$session <span class="keyword">where</span> program <span class="keyword">like</span> <span class="string">&#x27;%LGWR%&#x27;</span>)</span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><p>可以看到LGWR进程主要的等待有哪些，哪些等待比较严重：</p><ol><li>rdbms ipc message表示LGWR正在等待写redo log，表示其处于空闲状体，我们不必理会。</li><li>log file single/parallel write即我们今天所说的LGWR写redo文件。</li></ol><p>查询当前LGWR进程状态（实时）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.<span class="operator">*</span></span><br><span class="line">  <span class="keyword">from</span> v$Session_wait a, v$session b</span><br><span class="line"> <span class="keyword">where</span> a.sid <span class="operator">=</span> b.sid</span><br><span class="line">   <span class="keyword">and</span> b.program <span class="keyword">like</span> <span class="string">&#x27;%LGWR%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如发现为log file write等说明目前LGWR进程正在繁忙。如等待事件为log file parallel write 则其参数意义如下</p><ul><li>P1：需要写入的redo log的数量，即日志文件组的成员数量。</li><li>P2：需要写入每个redo log 成员的redo block数。</li><li>P3：写入完成需要进行的I/O请求次数。</li></ul><p>如果log file sync等待事件占有过多的CPU时间，我们就需要注意了：</p><ol><li>低速的磁盘可能会导致LGWR进程写文件较慢从而导致log file sync等待，我们可以简单的通过avg waits来判断，如超过15ms则说明磁盘可能是瓶颈，需要放到高速的磁盘，另外加日志组中成员文件放在不同的磁盘中。</li><li>服务器CPU内存资源不足会导致进程相应缓慢，同样会增加log file sync等待，所以在调优时首先保证系统资源充足。</li><li>数据库锁及latch也会影响log file sync等待。</li><li>过大的log buffer大小，log buffer过大可能导致刷新过于次数过低，从而导致单次刷新过慢。</li><li>过多的commit操作，通过上面我们知道每次commit操作都会导致LGWR写操作，如commit过多则该等待则会明显的上升。</li></ol><h4 id="3-7-4-log-file-parallel-write"><a href="#3-7-4-log-file-parallel-write" class="headerlink" title="3.7.4 log file parallel write"></a>3.7.4 log file parallel write</h4><p>为了冗余考虑，redo log组一般都会有多个成员，log file parallel write中的parallel指的是并行的写入多个redo log成员文件。log file parallel write指的是LGWR进程并行的将log buffer中的内容写入redo log，在全部写入到所有redo log前的等待计入log file parallel write 等待事件。</p><p>查看redo log文件情况：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> thread#, <span class="keyword">group</span>#, members, bytes <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> byte_mb, status</span><br><span class="line"> <span class="keyword">FROM</span> v$log</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> thread#, <span class="keyword">group</span>#;</span><br></pre></td></tr></table></figure><blockquote><p>log file sync（LFS）和log file parallel write（LFPW）对比：</p><p>通过上面的定义我们知道LFS和LFPW都是等待LGWR进程完成I/O操作。</p><ul><li>LFS是用户进程等待LGWR进程完成I/O操作。</li><li>LFPW是LGWR进程本身等待其I/O操作完成。</li></ul><p>例如有五个用户进程同时commit，每个完成耗时都是10ms。则LFS次数增加五次，LFS的wait time增加50ms。而LFPW次数增加一次，LFPW的wait time增加10ms。注意LGWR 进行写日志动作原因有很多，用户commit只是其中一个。</p><ul><li>每三秒钟</li><li>每一次commit/rollback</li><li>当其 1/3满的时候，这个由_LOG_IO_SIZE参数控制</li><li>当其达到1M的时候</li></ul></blockquote><p>减少日志组中成员的数量可减少I/O此时从而减少log file parallel write等待。</p><p>查看日志切换频率：直接将如下代码执行，PLSQL请使用command界面。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">column</span> h0 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h1 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h2 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h3 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h4 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h5 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h6 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h7 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h8 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h9 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h10 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h11 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h12 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h13 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h14 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h15 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h16 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h17 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h18 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h19 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h20 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h21 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h22 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> h23 format <span class="number">999</span></span><br><span class="line"><span class="keyword">column</span> avg format <span class="number">999.99</span></span><br><span class="line"><span class="keyword">column</span> <span class="keyword">day</span> format a6</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> TRUNC (first_time) &quot;Date&quot;, TO_CHAR (first_time, <span class="string">&#x27;Dy&#x27;</span>) &quot;Day&quot;, <span class="built_in">COUNT</span> (<span class="number">1</span>) &quot;Total&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;00&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) h0,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;01&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h1&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;02&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h2&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;03&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h3&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;04&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h4&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;05&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h5&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;06&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h6&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;07&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h7&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;08&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h8&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;09&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h9&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;10&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h10&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h11&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;12&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h12&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h13&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h14&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h15&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h16&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;17&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h17&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;18&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h18&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;19&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h19&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;20&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h20&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;21&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h21&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;22&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h22&quot;,</span><br><span class="line"><span class="built_in">SUM</span> (DECODE (TO_CHAR (first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;23&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h23&quot;, ROUND (<span class="built_in">COUNT</span> (<span class="number">1</span>) <span class="operator">/</span> <span class="number">24</span>, <span class="number">2</span>) &quot;Avg&quot;</span><br><span class="line"><span class="keyword">FROM</span> gv$log_history</span><br><span class="line"><span class="keyword">WHERE</span> first_time <span class="operator">&gt;=</span> trunc(SYSDATE) <span class="operator">-</span> <span class="number">30</span></span><br><span class="line"><span class="keyword">and</span> thread# <span class="operator">=</span> inst_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> TRUNC (first_time), TO_CHAR (first_time, <span class="string">&#x27;Dy&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h4 id="3-7-5-log-buffer-space"><a href="#3-7-5-log-buffer-space" class="headerlink" title="3.7.5 log buffer space"></a>3.7.5 log buffer space</h4><p>log buffer space这个等待事件一般来说很少发生，一旦等待比较严重往往说明是系统的设置问题。Oracle的一些DML操作（insert,update,insert）会产生redo条目，并存储在log buffer中，当发生以下情况时LGWR进程会把log buffer中的信息写入redo log，之后清空log buffer。当redo条目的产生速度快于LGWR清理的速度就会发生redo log space requests等待事件。</p><ol><li>每三秒钟</li><li>每一次commit/rollback</li><li>当其 1/3满的时候，这个由_LOG_IO_SIZE参数控制</li><li>当其达到1M的时候</li></ol><p>log buffer的大小由参数log_buffer参数决定。默认值为512k或者128k*CPU数量，一般来说这个默认值是够用的。如果系统DML操作很多且这个等待事件比较严重时可以考虑增加log buffer参数的大小。修改该参数需要重启数据库。</p><p>log buffer过大也会有问题。上面说到当log bufffer达到1/3满时LGWR进程会清空log buffer。如log buffer为10m，则意味着在没有commit/rollbak的情况下，需要等到3m才会切换，这样会导致LGWR写入redo log缓慢，从而导致log file sync等待。所以我们在调优log buffer space时不应该增加其他等待事件，需要取得一个平衡。</p><p>如何调优：</p><ol><li>IO性能不好会导致LGWR进程清空log buffer过慢从而导致log buffer space等待，这时需要将redo log放在高速的磁盘（SSD）或裸设备上。</li><li>减少应用的commit活动，或者使用nologging选项，仅更新表中需要更新的栏位。</li><li>物化视图更新使用fast代替complete模式。</li><li>查看 log file switch 是否频繁。</li></ol><h4 id="3-7-6-SQL-Net-message-from-dblink"><a href="#3-7-6-SQL-Net-message-from-dblink" class="headerlink" title="3.7.6 SQL*Net message from dblink"></a>3.7.6 SQL*Net message from dblink</h4><p>这个等待事件发生在会话在等待从远程数据库获取信息，该信息是通过dblink进行传输的，oracle把该等待事件归类于network类。</p><ul><li><p>查询实时的等待：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session_wait <span class="keyword">where</span> event<span class="operator">=</span> <span class="string">&#x27;SQL*Net message from dblink&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><p>P1代表driver id。</p></li><li><p>P2代表通过dblink传输的字节数。</p></li></ul></li><li><p>查询非实时的等待：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> v$session_event</span><br><span class="line"><span class="keyword">where</span> event <span class="keyword">like</span> <span class="string">&#x27;%SQL*Net message from  dblink%&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> time_waited <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><p>注意这里的信息是从实例起来的汇总，同时由于SID是可以复用的，所以查看出来的SID并不代表上次的语句是这个等待。</p></li></ul><p>当我们的SQL语句通过dblink访问远程数据库时，需要先将远程数据传输到本地再进行处理，在完成这个动作之前该会话处于SQL*Net message from dblink等待。该等待主要发生在如下几种情形：</p><ol><li>数据库中有大量的物化视图需要定时同步远程数据库至本地。</li><li>数据库中有大量SQL语句需要通过dblink从远程获取数据。</li></ol><p>如何调优：</p><ol><li>针对物化视图我们首先需要减少不必要的物化视图数量，同时采用增量更新的方式，对于DML操作频繁的主表我们需要提高刷新频率。</li><li>针对SQL语句中有大量dblink的语句我们需要尽量减少dblink的访问。</li><li>如果不能减少可以通过在源库建立view的方式使其在源库执行。</li><li>也可以使用DRIVING_SITE hint的方式，手动指定oracle让其在源库执行。</li></ol><h4 id="3-7-7-SQL-Net-message-to-dblink"><a href="#3-7-7-SQL-Net-message-to-dblink" class="headerlink" title="3.7.7 SQL*Net message to dblink"></a>3.7.7 SQL*Net message to dblink</h4><p>这个等待事件发生在会话在等待一个远程数据库一个确认信息，确认其发送的数据远程数据库是否收到，该数据通过dblink发送。一般是由于目标服务器无法及时接受信息，Oracle将该等待事件列为Network类。</p><ul><li><p>查询实时的等待：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session_wait <span class="keyword">where</span> event <span class="operator">=</span> <span class="string">&#x27;SQL*Net message to dblink&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>P1代表driver id。</li><li>P2代表通过dblink传输的字节数。</li></ul></li><li><p>查询非实时的等待：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">  <span class="keyword">from</span> v$session_event</span><br><span class="line"> <span class="keyword">where</span> event <span class="keyword">like</span> <span class="string">&#x27;%SQL*Net message to dblink%&#x27;</span></span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> time_waited <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><p>注意这里的信息是从实例起来的汇总，同时由于SID是可以复用的，所以查看出来的SID并不代表上次的语句是这个等待</p></li></ul><p>当我们的SQL语句通过dblink访问远程数据库时，需要先将远程数据传输到本地再进行处理，这时远端数据库会发送数据至本地，此时远端数据库如不能及时接受消息，会话处于SQL*Net message to dblink等待。该等待主要发生在如下几种情形：</p><ol><li>数据库中有大量的物化视图需要定时同步远程数据库至本地。</li><li>数据库中有大量SQL语句需要通过dblink从远程获取数据。</li></ol><p>如何调优：</p><ol><li>针对物化视图我们首先需要减少不必要的物化视图数量，同时采用增量更新的方式，对于DML操作频繁的主表我们需要提高刷新频率。</li><li>针对SQL语句中有大量dblink的语句我们需要尽量减少dblink的访问。</li><li>如果不能减少可以通过在源库建立view的方式使其在源库执行。</li><li>也可以使用DRIVING_SITE hint的方式，手动指定oracle让其在源库执行。</li></ol><h4 id="3-7-8-SQL-Net-message-from-client"><a href="#3-7-8-SQL-Net-message-from-client" class="headerlink" title="3.7.8 SQL*Net message from client"></a>3.7.8 SQL*Net message from client</h4><p>这个等待事件发生在会话在完成请求后等待后续client发送命令，查询 <code>v$session</code> 可以看到处于这种等待事件的session状态为非活动。Oracle将该等待事件列为Idle类，对于此类等待我们无须理会。</p><p>通过如下语句查询实时的等待事件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> v$session_wait</span><br><span class="line"><span class="keyword">where</span> event <span class="operator">=</span> <span class="string">&#x27;SQL*Net message from client&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sid</span><br></pre></td></tr></table></figure><h4 id="3-7-9-SQL-Net-message-to-client"><a href="#3-7-9-SQL-Net-message-to-client" class="headerlink" title="3.7.9 SQL*Net message to client"></a>3.7.9 SQL*Net message to client</h4><p>这个等待事件发生在会话发送数据到客户端时客户端无法及时接受时发生，Oracle将该等待事件列为Network类。</p><p>通过如下语句查询实时的等待事件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> v$session_wait</span><br><span class="line"><span class="keyword">where</span> event <span class="operator">=</span> <span class="string">&#x27;SQL*Net message to client&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sid</span><br></pre></td></tr></table></figure><p>查询非实时的等待事件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> v$session_event</span><br><span class="line"><span class="keyword">where</span> event <span class="operator">=</span><span class="string">&#x27;SQL*Net message to client&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> time_waited <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><p>该等待一般是由网络问题导致。</p><h3 id="3-8-Wait-Events-Statistics"><a href="#3-8-Wait-Events-Statistics" class="headerlink" title="3.8 Wait Events Statistics"></a>3.8 Wait Events Statistics</h3><h4 id="3-8-1-Time-Model-Statistics"><a href="#3-8-1-Time-Model-Statistics" class="headerlink" title="3.8.1 Time Model Statistics"></a>3.8.1 Time Model Statistics</h4><p>该视图说明的是各过程所占的资源比例：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010108.png"></p><p>我们注意到所有 <code>% of DB Time</code> 总和大于100%，因为这是一个累计的比例，下面DB CPU相关的过程包含在DB CPU中。我们需要注意的是一些异常的高占用情况，如hard parse elapsed time (硬解析时间)占用时间过长等。</p><ul><li>Statistic Name：表示状态的名称。</li><li>Time (s)：表示在awr报告时间内持续的时间。</li><li>% of DB Time：表示和DB Time相比其占用的比例。<code>DB Time=DB CPU+Non-Idle Wait Time</code> 。</li></ul><p>Oracle进程(服务器，前台，影子等)的运行需要消耗CPU时间，我们把这些时间成为DB CPU ，注意后台进程的消耗不包括在DB Time中。如果一个进程不消耗CPU资源，它就会处于等待状态。等待包含空闲等待和非空闲等待，非空闲等待（顺序读,离散读,log sync,锁,闩等）所消耗的时间我们称为 <code>Non-Idle Wait Time</code> 。</p><ul><li>sql execute elapsed time：表示执行SQL语句语句所用的时间，102%说明大部分DB Time都在执行SQL语句，这是非常好的，说明DB Time没有浪费在其他动作上，如解析。</li><li>DB CPU：如上面所说表示消耗CPU的时间。</li><li>parse time elapsed：表示解析所占用的时间。</li><li>hard parse elapsed time：表示硬解析所占用的时间。</li><li>DB time = DB CPU+Non-Idle Wait Time。</li><li>background elapsed time：表示后台进程持续的时间。</li><li>background cpu time：表示后台进程的CPU时间。</li></ul><p><strong>如何计算Non-Idle Wait Time？</strong></p><p><code>Non-Idle Wait Time=DB Time-DB CPU</code> 通过上面公式我们可以计算非空闲等待时间的时间.回到上图，Non-Idle Wait Time=18877-11432=7445。</p><p><strong>80/20原则</strong>：这个原则告诉我们80%的等待是由20%的事件造成的，我们需要集中精力解决排行前几的事件</p><h4 id="3-8-2-Operating-System-Statistics"><a href="#3-8-2-Operating-System-Statistics" class="headerlink" title="3.8.2 Operating System Statistics"></a>3.8.2 Operating System Statistics</h4><p>该视图是操作系统层面的性能指标</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010109.png"></p><p>该部分说明的是OS层面的一些状态信息,如CPU,IO</p><ul><li>CPU使用率=BUSY_TIME/(BUSY_TIME+IDLE_TIME)=20%。</li><li>BUSY_TIME=SYS_TIME+USER_TIME。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010110.png"></p><p>这里需要注意%iowait，他代表CPU在等待io操作完成，这个可能是io过慢或者io操作过多导致。</p><h4 id="3-8-3-Wait-Class"><a href="#3-8-3-Wait-Class" class="headerlink" title="3.8.3 Wait Class"></a>3.8.3 Wait Class</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010117.png"></p><p>这部分是根据等待的类型来排序等待事件。</p><h4 id="3-8-4-Wait-Events"><a href="#3-8-4-Wait-Events" class="headerlink" title="3.8.4 Wait Events"></a>3.8.4 Wait Events</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010118.png"></p><p>这部分以具体的等待事件名称来进行排序，让我们可以清晰的知道是什么等待事件占的比例高。</p><h4 id="3-8-5-Background-Wait-Events"><a href="#3-8-5-Background-Wait-Events" class="headerlink" title="3.8.5 Background Wait Events"></a>3.8.5 Background Wait Events</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010119.png"></p><p>这部分是以后台进程的等待事件来进行排序的，让我们知道后台等待事件哪些占用的比例高。</p><h4 id="3-8-6-Service-Statistics"><a href="#3-8-6-Service-Statistics" class="headerlink" title="3.8.6 Service Statistics"></a>3.8.6 Service Statistics</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010120.png"></p><p>这部分是根据服务名称来所消耗的DB Time进行排序的。<code>SYS$USERS</code> 指的是用户连接是没有制定服务名称时默认的服务名。</p><h4 id="3-8-7-Service-Wait-Class-Stats"><a href="#3-8-7-Service-Wait-Class-Stats" class="headerlink" title="3.8.7 Service Wait Class Stats"></a>3.8.7 Service Wait Class Stats</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010121.png"></p><p>这部分是将上一部分的DB Time细分后展现。</p><h3 id="3-9-SQL-Statistics"><a href="#3-9-SQL-Statistics" class="headerlink" title="3.9 SQL Statistics"></a>3.9 SQL Statistics</h3><p>接下来是最重要的一块，能帮助我们定位占用相关资源的TOP SQL语句：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010111.png"></p><h4 id="3-9-1-SQL-ordered-by-Elapsed-Time"><a href="#3-9-1-SQL-ordered-by-Elapsed-Time" class="headerlink" title="3.9.1 SQL ordered by Elapsed Time"></a>3.9.1 SQL ordered by Elapsed Time</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010112.png"></p><p>上图为根据持续时间排序的SQL语句，所有栏位可根据字面上意思得出意义</p><ul><li>如executions过多可能会引起CPU占用率高</li><li>如executions低，而elapsed time很高，则需要优化该SQL，降低执行时间</li></ul><p>需要注意的是execution如果为0不代表未执行，代表在awr报告的持续范围内该语句未执行完成。</p><h4 id="3-9-2-SQL-ordered-by-CPU-Time"><a href="#3-9-2-SQL-ordered-by-CPU-Time" class="headerlink" title="3.9.2 SQL ordered by CPU Time"></a>3.9.2 SQL ordered by CPU Time</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010124.png"></p><p>这部分是按SQL语句消耗的CPU时间来排序的。</p><h4 id="3-9-3-SQL-ordered-by-Gets"><a href="#3-9-3-SQL-ordered-by-Gets" class="headerlink" title="3.9.3 SQL ordered by Gets"></a>3.9.3 SQL ordered by Gets</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010125.png"></p><p>该部分是按SQL语句的逻辑读来排序的。这里需要注意的是执行次数非常多的语句，可能会导致操作系统CPU使用率飙升。</p><h4 id="3-9-4-SQL-ordered-by-Reads"><a href="#3-9-4-SQL-ordered-by-Reads" class="headerlink" title="3.9.4 SQL ordered by Reads"></a>3.9.4 SQL ordered by Reads</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010126.png"></p><p>这部分是按SQL语句的物理读来排序的。</p><h4 id="3-9-5-SQL-ordered-by-Executions"><a href="#3-9-5-SQL-ordered-by-Executions" class="headerlink" title="3.9.5 SQL ordered by Executions"></a>3.9.5 SQL ordered by Executions</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010127.png"></p><p>这部分是按SQL语句的执行次数来进行排序的。这里需要注意的是执行次数非常多的语句，可能会导致操作系统CPU使用率飙升。</p><h4 id="3-9-6-SQL-ordered-by-Parse-Calls"><a href="#3-9-6-SQL-ordered-by-Parse-Calls" class="headerlink" title="3.9.6 SQL ordered by Parse Calls"></a>3.9.6 SQL ordered by Parse Calls</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010128.png"></p><p>这部分是按SQL语句的解析次数进行排序的.</p><ul><li><code>Parse Calls/Executions &gt; 1</code> ：说明每次执行需要多次解析。</li><li><code>Parse Calls/Executions &lt; 1</code> ：说明一次解析可供多次执行使用。</li></ul><p>越接近1说明解析没有被复用。</p><h4 id="3-9-7-SQL-ordered-by-Sharable-Memory"><a href="#3-9-7-SQL-ordered-by-Sharable-Memory" class="headerlink" title="3.9.7 SQL ordered by Sharable Memory"></a>3.9.7 SQL ordered by Sharable Memory</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010129.png"></p><p>该部分按SQL语句使用的共享内存排序。</p><h4 id="3-9-8-SQL-ordered-by-Version-Count"><a href="#3-9-8-SQL-ordered-by-Version-Count" class="headerlink" title="3.9.8 SQL ordered by Version Count"></a>3.9.8 SQL ordered by Version Count</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211201/202112010130.png"></p><p>该部分按照SQL 语句的version count数量进行排序。version count 多说明相同语句在内存中shared pool没有被复用，需要查看具体原因。</p><h4 id="3-9-9-Complete-List-of-SQL-Text"><a href="#3-9-9-Complete-List-of-SQL-Text" class="headerlink" title="3.9.9 Complete List of SQL Text"></a>3.9.9 Complete List of SQL Text</h4><p>这里列出了上面提到的所有SQL语句的全部语句。</p><hr><p>参考：</p><p>🔗 《<a href="http://www.zhaibibei.cn/awr/">Oracle awr 报告全解析</a>》</p><p>🔗 《<a href="https://cloud.tencent.com/developer/article/1861840">Oracle-绑定变量binding variable解读 </a>》</p>]]></content>
    
    
    <summary type="html">整理Oracle-AWR报告相关内容，内容主要来自博主《宅必备》，包括：简述（什么是AWR、使用场景、如何生成AWR），相关知识点（硬解析和软解析），AWR解析等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="sql" scheme="http://linyishui.top/tags/sql/"/>
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>海量数据处理</title>
    <link href="http://linyishui.top/2021121801.html"/>
    <id>http://linyishui.top/2021121801.html</id>
    <published>2021-12-18T11:19:32.000Z</published>
    <updated>2021-12-27T07:01:22.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="海量数据处理"><a href="#海量数据处理" class="headerlink" title="海量数据处理"></a>海量数据处理</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><h2 id="二-常见方案"><a href="#二-常见方案" class="headerlink" title="二. 常见方案"></a>二. 常见方案</h2><ul><li>Hash方法</li><li>Bitmap方法</li><li>Bloom filter方法</li><li>数据库优化</li><li>倒排索引</li><li>外排序</li><li>Trie树</li><li>堆</li><li>双层桶</li><li>MapReduce</li></ul><h3 id="2-1-Hash"><a href="#2-1-Hash" class="headerlink" title="2.1 Hash"></a>2.1 Hash</h3><p>详细内容：《<a href="../2020070501.html" title="Title">散列表</a>》</p><p>Hash方法用来快速存取，因为其查找时间复杂度为 O(1) ，可以用来统计海量数据和分类等。</p><h3 id="2-2-Bitmap"><a href="#2-2-Bitmap" class="headerlink" title="2.2 Bitmap"></a>2.2 Bitmap</h3><p>Bitmap即位图，使用位数组来表示某些元素是否存在。适用于海量数据的快速查找、判重和删除等。</p><p>生成一个N位长的二进制串，假设集合为{2, 7, 4, 9, 1, 10}，则为10位的串，将值对应下标设置为1，结果为：1101001011，因为数组下标本身有序，所以最终相当于做了一次排序（时间复杂度为O(n)，以空间N换时间，并且要提前直到数组中取值范围）。</p><h3 id="2-3-Bloom-Filter"><a href="#2-3-Bloom-Filter" class="headerlink" title="2.3 Bloom Filter"></a>2.3 Bloom Filter</h3><p>判断元素是否存在于一个集合中，常规做法需要存储所有元素然后再进行比较查找，比如拦截垃圾邮件的功能，需要记录发送垃圾邮件的地址，假设发送者不断注册随机地址，每个地址需要16B，一亿个地址就需要1.6GB左右的空间。</p><p>Bloom Filter：</p><ul><li>可以用来检测一个元素是否属于某个集合。</li><li>结合了位图与散列函数，牺牲准确率来换取空间和时间效率的提高，判断不属于时绝对准确，但判断属于时则未必准确。</li><li>初始化为一个m位的位数组，定义k个不同的散列函数能把集合元素映射到位数组，当向集合中插入元素时，根据k个散列函数得到k个位，将这些位置为1。当需要查询元素是否属于集合时，只要根据散列函数计算出其对应的k个位，并判断：如果有任一位不为1就可以判断元素不在该集合；全为1则可能在集合中。</li><li>如何根据输入元素个数n，来确定位数组m的大小和Hash函数。<code>k = (ln2) * (m/n)</code> 时错误率最小，要求错误率不大于E时，m至少要等于 <code>n * lg(1/E)</code> 才能表示任意n个元素的集合。但m仍要取更大一些，因为要保证位数组至少一半为0，所以应该 <code>m &gt;= nlg(1/E) * lgE</code> ，大概就是nlg(1/E)的1.44倍。</li></ul><p>Bloom Filter只能判断插入元素，删除元素则会影响多个元素的检测。可以通过扩展方法支持元素的删除操作：</p><ul><li>CBF（Counting Bloom Filter）将位数组的位扩展为Counter</li><li>SBF（Spectral Bloom Filter）用counter中的最小值近似表示集合元素出现的次数。</li></ul><h3 id="2-4-数据库优化"><a href="#2-4-数据库优化" class="headerlink" title="2.4 数据库优化"></a>2.4 数据库优化</h3><ol><li><strong>数据分区</strong>：减少需要处理的数据规模。</li><li><strong>索引</strong>：正确的构建索引，大表索引本身比较占物理空间，创建和维护都比较耗费时间，要考虑索引的填充因子和聚集非聚集。</li><li><strong>批处理</strong>：对数据进行切分，最后将结果合并。</li><li><strong>临时表或中间表</strong>：大表变小表，保留中间数据。</li><li>……</li></ol><h3 id="2-5-倒排索引"><a href="#2-5-倒排索引" class="headerlink" title="2.5 倒排索引"></a>2.5 倒排索引</h3><p>倒排索引也叫反向索引，用来存储在全文搜索下某个单词在一个或一组文档的位置。</p><p>分类：</p><ul><li>一条记录的水平反向索引包含每个引用单词的文档的列表。</li><li>一个单词的水平反向索引又包含每个单词在一个文档中的位置。</li></ul><p>假设有文本内容：</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">D1:</span> The GDP increased</span><br><span class="line"><span class="symbol">D2:</span> The <span class="keyword">text</span> <span class="built_in">is</span> this</span><br><span class="line"><span class="symbol">D3:</span> My name <span class="built_in">is</span></span><br></pre></td></tr></table></figure><p>倒排索引：</p><ul><li>The：D1，D2</li><li>GDP：D1</li><li>increased：D1</li><li>text：D2</li><li>is：D2，D3</li><li>name：D3</li><li>…</li></ul><p>正向索引为文档到单词，反向则是单词到文档。在处理复杂的多关键字查询时，反向索引可以先完成查询的交、并逻辑运算，再对记录进行存取，把对记录的查询转换为对地址集合的查询。一般多应用于文档检索系统，常见的关系型数据库中的全文索引就是倒排索引。</p><h3 id="2-6-外排序"><a href="#2-6-外排序" class="headerlink" title="2.6 外排序"></a>2.6 外排序</h3><p>待排序元素数目较多，无法一次放入内存时，需要以文件的形式存放于外存，排序时分批调入内存处理。适用于大数据的排序和去重，效率很低且消耗大量I/O。</p><p>一般采用归并排序来实现：</p><ol><li>生成若干初始归并段，文件预处理。</li><li>把含有n个记录的文件，按内存大小划分为若干长度为L的子文件，分别将子文件调入内存，排序后送回外存。</li><li>进行多路归并，将初始段进行多遍归并，最后形成整个文件的单一归并段。</li></ol><h3 id="2-7-Trie树"><a href="#2-7-Trie树" class="headerlink" title="2.7 Trie树"></a>2.7 Trie树</h3><p>Trie树，又叫字典树或键树。用于快速字符串检索的多叉树结构，统计和排序大量的字符串，原理是利用字符串的公共前缀来减少时空开销，可以减少无谓的字符串比较，查询效率高于散列表。</p><p>基本特性：</p><ul><li>根节点不包含字符，除根节点外都只包含一个字符。</li><li>从根节点到某一阶段，路径上经过的字符串连接起来构成对应的字符串。</li><li>每个节点的所有子节点包含的字符都不相同。</li></ul><p>该结构重复度高比较消耗内存，当公共前缀率较低时不建议使用该方案。</p><h3 id="2-8-堆"><a href="#2-8-堆" class="headerlink" title="2.8 堆"></a>2.8 堆</h3><p>采用堆的数据结构，只需扫描一遍就可以得到所有前n元素，适合海量的数据处理。</p><p>求海量数据中前n大/小的值中位数：</p><table><thead><tr><th align="center">堆类型</th><th>作用</th></tr></thead><tbody><tr><td align="center">最大堆</td><td>求前n小</td></tr><tr><td align="center">最小堆</td><td>求前n大</td></tr><tr><td align="center">双堆</td><td>中位数</td></tr></tbody></table><h3 id="2-9-双层桶"><a href="#2-9-双层桶" class="headerlink" title="2.9 双层桶"></a>2.9 双层桶</h3><p>桶排序的思想是把[0, 1)划分为n个大小相同的子区间，每个子区间代表一个桶，将n个记录分配到各个桶中。关键字均匀分布在各个桶中，对关键字进行插入排序，将各非空桶中的记录连接起来。</p><p>桶排序的平均时间复杂度为 O(n) ，最坏情况为 O(n^2^) ，只适用于关键字取值范围小的情况，否则所需桶数目过多会浪费空间和计算时间。适合于寻找第K大的数、寻找中位数、寻找不重复或重复的数字等。</p><h3 id="2-10-MapReduce"><a href="#2-10-MapReduce" class="headerlink" title="2.10 MapReduce"></a>2.10 MapReduce</h3><p>MapReduce常用于云计算技术，是一种并行计算的分布式编程模型，支持大型分布式集群系统在大数据集上工作。</p><p>核心操作是：</p><ul><li>Map：映射，把一组键值对映射为一组新的键值对，通过Map程序将数据切割为不相干的区块，分配给大量的计算机达到分布式计算的效果。</li><li>Reduce：化简，通过指定并发的Reduce函数将结果汇总，保证所有的键值对共享相同的键组。</li></ul><p>Hadoop框架实现了MapReduce算法，把应用程序分割为许多很小的工作单元，每个单元可以在集群节点上重复执行。还提供了一个分布式文件系统GFS等。</p><p>分布式计算会导致网络间进行大量频繁的数据交换，输入数据保存在机器的本地磁盘上，系统划分数据段，将原始文件划分到各个段中，并进行备份分配到不同的机器上。从而可以保证大部分数据都可以本地读取，减少对网络带宽的占用。</p><h2 id="三-案例"><a href="#三-案例" class="headerlink" title="三. 案例"></a>三. 案例</h2><h3 id="3-1-Top-K-问题"><a href="#3-1-Top-K-问题" class="headerlink" title="3.1 Top K 问题"></a>3.1 Top K 问题</h3><p>在海量数据中找到出现频率最高的前K个数据。较好的方案为：分治 + Trie树/hash + 小顶堆。</p><p>将数据集通过Hash分解为多个小的数据集，然后使用Trie树或Hash统计每个小数据集中的query词频，之后用小顶堆求出每个数据集中频率最高的前K个数，最后合并所有数据集算出最终的Top K。</p><p>假设有1亿个浮点数，找出最大的10000个数？</p><ul><li><strong>全排序</strong>：全部数据一次排序，比较快的排序算法如快排一般为 O(nlogn)，每个浮点数占4B，1亿个大概需要400M内存。</li><li><strong>局部淘汰法</strong>：用一个容器放置前10000个数，依次与容器内最小数字相比，只要大于最小数字就交换。时间复杂度为 O(n + m^2^)，m为容器大小。</li><li><strong>分治法</strong>：将1亿条数据切分为100份，每份100万条，找出每份中最大的10000个（通过快排将数据分为两堆，大堆个数大于10000，继续对大堆快排成两堆；如果小于10000，则对小堆快排一次，找到第10000-n大的数字，递归该流程），最后在100*10000个中找到最终的最大10000。</li><li><strong>Hash法</strong>：先通过Hash去重，再通过分治或最小堆求出结果。</li><li><strong>最小堆</strong>：先读入前10000个数来创建大小为10000的小顶堆。建堆的时间复杂度为 O(mlogm) ，m即大小10000。遍历后续数字并与堆顶比较，当大于堆顶时则替换堆顶元素并重新调整小顶堆。最后按中序遍历输出堆中数字。时间复杂度为  O(mlogm) ，空间复杂度为m。</li></ul><p>解决该问题比较适合采用MapReduce框架来解决，只需编写一个Map函数和两个Reduce函数，然后提交到Hadoop上即可。</p><ul><li>通过Map将数据划分到不同机器处理。采用Hash算法，将Hash值相同的数据交给同一个Reduce Task。</li><li>每个机器通过Reduce算出各自出现次数最多的前N个数据，最后汇总。采用HashMap统计每个词的出现频率，第二个Reduce统计所有Reduce Task输出数据中的Top K。</li></ul><h3 id="3-2-重复问题"><a href="#3-2-重复问题" class="headerlink" title="3.2 重复问题"></a>3.2 重复问题</h3><p>可以使用Bitmap即位图法来实现。</p><p>如从文件中解析出不同号码个数，假设为8位，则存储8位整数需要99Mbit，约等于12MB内存。</p><h3 id="3-3-排序问题"><a href="#3-3-排序问题" class="headerlink" title="3.3 排序问题"></a>3.3 排序问题</h3><p>分治法或位图法。</p><hr><p>参考：</p><p>🔗 </p>]]></content>
    
    
    <summary type="html">海量数据优化。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="sql" scheme="http://linyishui.top/tags/sql/"/>
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>优化分页查询</title>
    <link href="http://linyishui.top/2021121201.html"/>
    <id>http://linyishui.top/2021121201.html</id>
    <published>2021-12-12T13:26:49.000Z</published>
    <updated>2021-12-20T11:19:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="优化分页查询"><a href="#优化分页查询" class="headerlink" title="优化分页查询"></a>优化分页查询</h1><h2 id="一-分页查询"><a href="#一-分页查询" class="headerlink" title="一. 分页查询"></a>一. 分页查询</h2><h3 id="1-1-使用场景"><a href="#1-1-使用场景" class="headerlink" title="1.1 使用场景"></a>1.1 使用场景</h3><p>当数据量较大时，不需要一次性全部展示给用户；又或者出于性能考虑需要对数据做分批处理。这类场景需要对查询做分页处理，将数据按页做切割依次返回单页结果。</p><h3 id="1-2-不同数据库的常见分页查询写法"><a href="#1-2-不同数据库的常见分页查询写法" class="headerlink" title="1.2 不同数据库的常见分页查询写法"></a>1.2 不同数据库的常见分页查询写法</h3><p>Oracle：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> RST2.<span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> RST1.<span class="operator">*</span>, rownum RN <span class="keyword">from</span> (             </span><br><span class="line">        <span class="keyword">select</span> xxxx <span class="keyword">from</span> table_xxx <span class="keyword">where</span> XXXX</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> XXXX         </span><br><span class="line">    ) RST1 </span><br><span class="line"><span class="keyword">where</span> rownum <span class="operator">&lt;=</span> (<span class="number">0</span> <span class="operator">+</span> <span class="number">1</span>) <span class="operator">*</span> <span class="number">10000</span>) RST2 <span class="keyword">where</span> RST2.RN <span class="operator">&gt;</span> <span class="number">0</span> <span class="operator">*</span> <span class="number">10000</span>; </span><br></pre></td></tr></table></figure><p><strong>注意</strong>：如果rownum和order by写在同一层，sql会先生成rownum后执行order by子句，因而导致排序后结果不对。&lt;=写在内层在数据量大时要比外层效率高，因为在CBO优化模式下，Oracle可以将外层的查询条件推到内层查询中，以提高内层查询的执行效率。</p><p>MySQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> xxxx <span class="keyword">FROM</span> table_xxx LIMIT M,N</span><br></pre></td></tr></table></figure><h3 id="1-3-分页为何要加排序？什么是稳定分页？"><a href="#1-3-分页为何要加排序？什么是稳定分页？" class="headerlink" title="1.3 分页为何要加排序？什么是稳定分页？"></a>1.3 分页为何要加排序？什么是稳定分页？</h3><p>当表数据量为百万或者千万级时，随着偏移量增大，分页查询执行速度越来越慢，可以分析后发现主要由于Order By导致。那么分页为什么要加排序呢？</p><p>首先，如果分页查询使用的场景对数据一致/重复度不敏感的话，Order By不是必须的。但如果对此有要求就一定要添加排序操作。因为数据库提供的分页操作本身是不稳定的，不能保证查询按行顺序返回，除非排序能够保证唯一性，当ORDER BY的字段值相同时，数据的排序就会变得随机。</p><ul><li>如果没有指定ORDER BY语句，则数据库不保证以特定顺序返回结果。 有些人认为，如果没有指定order by子句，行总是以聚簇索引顺序或物理磁盘顺序返回。 然而，这是不正确的，因为在查询处理期间可以改变行顺序的许多因素，例如并行的HASH连接是更改行顺序的操作符的一个很好的例子。</li><li>如果指定ORDER BY语句，数据库将对行进行排序，并按请求的顺序返回。 但是，如果该顺序不是确定性的，即可能有重复的值，则在每个具有相同值的组中，由于与上述相同的原因，该顺序是“随机的”。确保确定性顺序的唯一方法是在ORDER BY子句中包含保证的唯一列或列组（例如主键）。</li></ul><p>但即使加上Order By，数据库的分页方法也不算稳定的数据库分页，因为无法应对分页查询时插入新行的场景。有一种实现稳定分页的方法，叫做<strong>键集分页</strong>。主要思想不是通过告诉数据库要跳过多少行来跳过 “看过的行”，并希望在这期间没有增加任何行，而是使用一个独特的标识来确定哪些行已经被看过哪些没有。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> xxx</span><br><span class="line">  <span class="keyword">FROM</span> xxx</span><br><span class="line"> <span class="keyword">WHERE</span> xxx</span><br><span class="line">   <span class="keyword">AND</span> id <span class="operator">&lt;</span> ?last_seen_id</span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure><p>无论如何都需要一个建立明确顺序的ORDER BY。从而使用这些列来确定你之前收到数据的地方。</p><h2 id="二-Oracle优化"><a href="#二-Oracle优化" class="headerlink" title="二. Oracle优化"></a>二. Oracle优化</h2><p>首先是分页内的查询SQL先尽量优化到最优：</p><ul><li>正确的构建索引。</li><li>减少表之间的关联。</li><li>简化查询的字段。</li><li>等等。</li></ul><p>Oracle有多种方案可以实现类似分页的效果：</p><ul><li><p>偏移量：适用于Oracle12c或更高版本的数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> fieldA, fieldB </span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">table</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> fieldA </span><br><span class="line"><span class="keyword">OFFSET</span> <span class="number">5</span> <span class="keyword">ROWS</span> <span class="keyword">FETCH</span> NEXT <span class="number">14</span> <span class="keyword">ROWS</span> <span class="keyword">ONLY</span></span><br></pre></td></tr></table></figure></li><li><p>函数：如果为Oracle11g或更低版本的数据库，请使用分析功能 <code>RowNumber()</code> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> fieldA, fieldB</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> fieldA, fieldB,</span><br><span class="line">        <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> fieldA) rowRank</span><br><span class="line">    <span class="keyword">FROM</span> table_name</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span> rowRank <span class="keyword">BETWEEN</span> <span class="number">5</span> <span class="keyword">AND</span> <span class="number">14</span>;</span><br></pre></td></tr></table></figure></li><li><p>RowNum：适用于Oracle11g或更低版本的数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> T.<span class="operator">*</span> <span class="keyword">FROM</span> ( </span><br><span class="line"><span class="keyword">SELECT</span> T.<span class="operator">*</span>, rowNum <span class="keyword">as</span> rowIndex</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> fieldA, fieldB,</span><br><span class="line">    <span class="keyword">FROM</span> table_name</span><br><span class="line">)T)T</span><br><span class="line"><span class="keyword">WHERE</span> rowIndex <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">AND</span> rowIndex <span class="operator">&lt;=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure></li></ul><p>高版本数据库建议使用方案1，否则可以采用方案三。</p><p><code>OFFSET n ROWS FETCH NEXT m ROWS ONLY</code> 或 <code>rownum</code> 语法上未要求一定配套Order By，但语义上还是要加上。如果不添加ORDER BY子句，数据库可能以任何顺序返回结果。因此需要在ORDER BY子句中建立一个明确的行的顺序（以便没有行与另一行是对等的）。实际使用中都应该在ORDER BY子句中包含一些唯一键，如 <code>ORDER BY time_stamp DESC, id DESC</code> 。</p><p>对于最常见的等值表连接查询，CBO一般可能会采用两种连接方式NESTED LOOP和HASH JOIN（MERGE JOIN效率比HASH JOIN效率低，一般CBO不会考虑）。在这里，由于使用了分页，因此指定了一个返回的最大记录数，NESTED LOOP在返回记录数超过最大值时可以马上停止并将结果返回给中间层，而HASH JOIN必须处理完所有结果集（MERGE JOIN也是）。那么在大部分的情况下，对于分页查询选择NESTED LOOP作为查询的连接方法具有较高的效率（分页查询的时候绝大部分的情况是查询前几页·的数据，越靠后面的页数访问几率越小）。</p><p>当数据量很大时就要考虑分库分表或者分区，以及历史数据归档等。</p><h2 id="三-MySQL优化"><a href="#三-MySQL优化" class="headerlink" title="三. MySQL优化"></a>三. MySQL优化</h2><h3 id="3-1-语法"><a href="#3-1-语法" class="headerlink" title="3.1 语法"></a>3.1 语法</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> LIMIT [<span class="keyword">offset</span>,] <span class="keyword">rows</span> <span class="operator">|</span> `<span class="keyword">rows</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span> ` </span><br><span class="line">(LIMIT <span class="keyword">offset</span>, `length`)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> XXX</span><br><span class="line"><span class="keyword">FROM</span> XXX</span><br><span class="line"><span class="keyword">where</span> XXX</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> id <span class="keyword">asc</span> </span><br><span class="line">LIMIT <span class="number">2000</span> <span class="keyword">OFFSET</span> <span class="number">50000</span></span><br><span class="line"><span class="comment">-- LIMIT 2000,50000</span></span><br></pre></td></tr></table></figure><ul><li><p>参数1：指定返回记录行的偏移量。</p></li><li><p>参数2：指定返回记录行的最大数目。</p></li><li><p>只提供一个参数 <code>limit 5000</code> 表示最大行数。</p></li></ul><p>对于数据规模不算大的场景，只需要注意 WHERE 和 Order By 上使用组合索引。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_XX <span class="keyword">WHERE</span> XXX_A <span class="operator">=</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">50</span>, <span class="number">10</span></span><br><span class="line"><span class="comment">-- 创建字段为(XXX_A, id)的组合索引</span></span><br></pre></td></tr></table></figure><p>当数据量越大，偏移量也就越大，LIMIT执行速度会缓慢下降：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_XX <span class="keyword">WHERE</span> XXX_A <span class="operator">=</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">10</span></span><br></pre></td></tr></table></figure><p>这条语句将会扫描10010条数据，如果数据量很大，每次取10条数据都得扫描远远超过10条的数据，甚至筛选上百万条数据后然后选择10条。</p><h3 id="3-2-优化"><a href="#3-2-优化" class="headerlink" title="3.2 优化"></a>3.2 优化</h3><p>分页有两类情况：</p><ol><li>固定一页一页顺序查询。</li><li>跳转页面只查指定页数据。</li></ol><p>固定按页查询，可以记住每次分页的最大最小值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询下一页</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> message <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">order</span> <span class="keyword">by</span> id <span class="keyword">asc</span> limit <span class="number">10</span>;</span><br><span class="line"><span class="comment">-- 查询上一页</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> message <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">99990</span> <span class="keyword">order</span> <span class="keyword">by</span> id <span class="keyword">desc</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>查询指定页：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 从前向后跳</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> message <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">ASC</span> LIMIT <span class="number">10</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从后向前条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> message <span class="keyword">WHERE</span> id <span class="operator">&lt;</span> <span class="number">99990</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">DESC</span> LIMIT <span class="number">20</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>缺点：必须有一个数值型递增序列字段。</p><p>还可以通过子查询的方式来优化，仅限于主键排序：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_XX <span class="keyword">WHERE</span> id <span class="operator">&gt;=</span> </span><br><span class="line">(<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> table_XX <span class="keyword">WHERE</span> XXX_A <span class="operator">=</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">1</span>) LIMIT <span class="number">10</span> </span><br></pre></td></tr></table></figure><p>或者使用JOIN分页的方式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `content` <span class="keyword">AS</span> t1   </span><br><span class="line"><span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> `content` <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">desc</span> LIMIT &quot;.($page-1)*$pagesize.&quot;, <span class="number">1</span>) <span class="keyword">AS</span> t2   </span><br><span class="line"><span class="keyword">WHERE</span> t1.id <span class="operator">&lt;=</span> t2.id <span class="keyword">ORDER</span> <span class="keyword">BY</span> t1.id <span class="keyword">desc</span> LIMIT $pagesize; </span><br></pre></td></tr></table></figure><p>子查询是在索引上完成的，而普通的查询时在数据文件上完成的，通常来说，索引文件要比数据文件小得多，所以操作起来也会更有效率。</p><p>可以利用类似策略模式的方式去处理分页，比如判断如果是一百页以内，就使用最基本的分页方式，大于一百页，则使用子查询的分页方式。</p><p>当数据规模达到百万或千万级，LIMIT分页会存在较大性能问题。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 平均用时6.6秒 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `cdb_posts` <span class="keyword">ORDER</span> <span class="keyword">BY</span> pid LIMIT <span class="number">1000000</span> , <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 平均用时0.6秒 </span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `cdb_posts` <span class="keyword">WHERE</span> pid <span class="operator">&gt;=</span> (<span class="keyword">SELECT</span> pid <span class="keyword">FROM</span>  </span><br><span class="line">`cdb_posts` <span class="keyword">ORDER</span> <span class="keyword">BY</span> pid LIMIT <span class="number">1000000</span> , <span class="number">1</span>) LIMIT <span class="number">30</span></span><br></pre></td></tr></table></figure><p>因为要<strong>取出所有字段内容</strong>，第一种需要跨越大量数据块并取出，而第二种基本通过直接根据索引字段定位后，才取出相应内容，效率自然大大提升。对limit的优化，不是直接使用limit，而是首先获取到offset的id，然后直接使用limit size来获取数据。</p><p>可以看出，越往后分页，LIMIT语句的偏移量就会越大，两者速度差距也会越明显。实际应用中，可以利用类似策略模式的方式去处理分页，比如判断如果是一百页以内，就使用最基本的分页方式，大于一百页，则使用子查询的分页方式。</p><p>总结优化步骤：</p><ol><li><p>使用索引字段或主键进行排序。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> film_id, description <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> film_id limit <span class="number">50</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure></li><li><p>记录上次返回的主键，在下次查询时使用主键过滤。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> film_id, description <span class="keyword">from</span> film </span><br><span class="line"><span class="keyword">where</span> film_id <span class="operator">&gt;</span> <span class="number">55</span> <span class="keyword">and</span> film_id <span class="operator">&lt;=</span> <span class="number">60</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> film_id </span><br><span class="line">limit <span class="number">1</span>,<span class="number">5</span>;</span><br></pre></td></tr></table></figure></li></ol><hr><p>参考：</p><p>🔗 《<a href="https://use-the-index-luke.com/no-offset">We need tool support for keyset pagination (use-the-index-luke.com)</a>》</p>]]></content>
    
    
    <summary type="html">海量数据分页查询时如何针对性优化。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="sql" scheme="http://linyishui.top/tags/sql/"/>
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>《高性能MySQL》（七）优化服务器设置</title>
    <link href="http://linyishui.top/2021112901.html"/>
    <id>http://linyishui.top/2021112901.html</id>
    <published>2021-11-29T13:22:16.000Z</published>
    <updated>2021-11-30T02:37:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="《高性能MySQL》（七）优化服务器设置"><a href="#《高性能MySQL》（七）优化服务器设置" class="headerlink" title="《高性能MySQL》（七）优化服务器设置"></a>《高性能MySQL》（七）优化服务器设置</h1><h2 id="一-引文"><a href="#一-引文" class="headerlink" title="一. 引文"></a>一. 引文</h2><p>“我的服务器有32GB内存，12核CPU，怎样配置会最好？”很可惜，优化配置并非只看硬件情况，需要符合工作负载、数据以及应用需求等。</p><p>MySQL有很多可修改的参数，大部分都不需要修改默认值，精力应该更多放在<strong>优化schema、索引以及查询设计上</strong>。确保基本的配置，如InnoDB的Buffer Pool和日志文件缓存大小等设置为安全值即可。</p><p>最好从查询语句和响应时间来分析问题，而不是由配置项入手，大部分人都是使用默认配置，也间接证明了默认值经过了大量的测试。</p><h2 id="二-MySQL配置原理"><a href="#二-MySQL配置原理" class="headerlink" title="二. MySQL配置原理"></a>二. MySQL配置原理</h2><h3 id="2-1-配置项"><a href="#2-1-配置项" class="headerlink" title="2.1 配置项"></a>2.1 配置项</h3><p>MySQL获取配置信息的方式：</p><ul><li><strong>命令行参数</strong>：启动时输入。</li><li><strong>配置文件</strong>：默认路径为 <code>/etc/my.cnf</code> 或 <code>/etc/mysql/my.cnf</code> 。</li></ul><p>查看当前使用的配置文件路径：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">which</span> mysqld</span></span><br><span class="line">/usr/sbin/mysqld</span><br><span class="line"><span class="meta">$</span><span class="bash"> /usr/sbin/mysqld --verbose --<span class="built_in">help</span> | grep -A 1 <span class="string">&#x27;Default options&#x27;</span></span></span><br><span class="line">Default options are read from the following files in the given order: /etc/mysql/my.cnf ~/.my.cnf /usr/etc/my.cnf</span><br></pre></td></tr></table></figure><p>配置项可以由多个作用域，有些是服务器级（全局作用域），有些是连接级的（会话作用域），剩下则是对象级的。改变会话级变量，只影响当前连接，并且关闭后会失效。</p><ul><li>query_cache_size变量为全局。</li><li>sort_buffer_size变量默认为全局相同，但每个线程也可以设置。</li><li>join_buffer_size变量也有全局默认且每个线程可以设置，但若一个查询中关联多张表，可以为每个关联分配一个关联缓冲（join buffer），所以每个查询可能有多个关联缓冲。</li></ul><h3 id="2-2-动态设置变量"><a href="#2-2-动态设置变量" class="headerlink" title="2.2 动态设置变量"></a>2.2 动态设置变量</h3><p>动态设置变量：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span>           sort_buffer_size <span class="operator">=</span> <span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span>    sort_buffer_size <span class="operator">=</span> <span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>;</span><br><span class="line"><span class="keyword">SET</span>         @<span class="variable">@sort</span>_buffer_size <span class="operator">=</span> <span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@session</span>.sort_buffer_size <span class="operator">=</span> <span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>;</span><br><span class="line"><span class="keyword">SET</span>  @<span class="variable">@global</span>.sort_buffer_size <span class="operator">=</span> <span class="operator">&lt;</span><span class="keyword">value</span><span class="operator">&gt;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 检查配置</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES</span><br></pre></td></tr></table></figure><p>动态设置变量可能会导致意外的副作用，如从缓冲中刷新脏块，务必小心可以在线修改的设置，可能会导致数据库执行大量的工作。</p><ul><li>key_buffer_size：一次性为键缓冲区（key buffer / key cache）分配所有指定的空间。但操作系统不会真的立刻分配内存，而是使用时才分配。<ul><li>MySQL允许创建多个键缓存，若把非默认键缓存变量设置为0，MySQL会丢弃缓存在其上的索引转而使用默认键缓存，并在没有引用时删除该缓存。</li><li>为不存在的键设置变量，会创建新缓存。</li><li>对一个已存在键缓存设置非零值，会刷新其内容，但会阻塞所有操作直到刷新完毕。</li></ul></li><li>table_cache_size：不会立即生效，在线程打开表时检查此值，若大于缓存中表的数量，线程可以把新打开的表放入缓存，若小于则将缓存中不常用的删除。</li><li>thread_cache_size：不会立即生效，在下次有连接关闭时产生效果，检查缓存中是否还有空间来缓存线程，如果有则缓存改线程供后面重用；如果没有则销毁该线程。但缓存中线程数和使用的内存不会立即减少，只有在新连接删除缓存的一个现场并使用后才减少。<ul><li><strong>MySQL只在关闭连接时才在缓存中增加线程，只在创建新连接时才从缓存中删除线程</strong>。</li></ul></li><li>query_cache_size：MySQL在启动时一次性分配并且初始化这块内存。修改此变量会立即删除所有缓存的查询，重新分配这片缓存到指定大小，并且重新初始化内存。因为要逐个清理缓存的查询，可能会花费较长时间，在完成初始化前都无法提供服务。</li><li>read_buffer_size：只有在查询需要使用时才会为该缓存分配内存，并且一次性分配该参数指定大小的全部内存。</li><li>read_rnd_buffer_size：只会在有查询需要使用时才会为该缓存分配内存。只分配需要的内存大小、</li><li>sort_buffer_size：只会在有查询需要做排序操作时为该缓存分配内存，一旦排序立即分配指定大小的全部内存。</li><li>……</li></ul><p>对于一次性分配指定大小内存的配置项，很容易导致内存浪费，所以尽量不要使用，使用也尽量在查询需要时在连接级别单独调大。内存分配是一个极其昂贵的操作，包括了地址空间的分配。如果查询需要使用一个较大的排序缓存才能很好的执行，应该在查询前增加sort_buffer_size的值，执行后恢复为DEFAULT。</p><hr><p>参考：</p><p>🔗 《高性能MySQL》</p>]]></content>
    
    
    <summary type="html">《高性能MySQL》读书笔记，内容：等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>执行计划（更新中）</title>
    <link href="http://linyishui.top/2021101401.html"/>
    <id>http://linyishui.top/2021101401.html</id>
    <published>2021-10-14T11:09:02.000Z</published>
    <updated>2021-11-16T02:26:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="执行计划"><a href="#执行计划" class="headerlink" title="执行计划"></a>执行计划</h1><h2 id="一-Oracle"><a href="#一-Oracle" class="headerlink" title="一. Oracle"></a>一. Oracle</h2><h3 id="1-1-什么是执行计划？"><a href="#1-1-什么是执行计划？" class="headerlink" title="1.1 什么是执行计划？"></a>1.1 什么是执行计划？</h3><p>执行计划是一条查询语句在Oracle中的执行过程或访问路径的描述。</p><p>执行计划描述了SQL引擎为执行SQL语句进行的操作；分析SQL语句相关的性能问题或仅仅质疑查询优化器的决定时，必须知道执行计划；所以执行计划常用于sql调优。</p><p>相关概念：</p><ul><li><p><strong>Rowid</strong>：r伪列，不是用户定义，而是系统加的。 每个表都有一个rowid，可以像使用其它列那样使用它，但是不能删除改列，也不能对该列的值进行修改、插入。一旦一行数据插入数据库，则rowid在该行的生命周期内是唯一的，即即使该行产生行迁移，行的rowid也不会改变。</p></li><li><p><strong>Recursive SQL</strong>：有时为了执行用户发出的一个sql语句，Oracle必须执行一些额外的语句称之为’’recursive calls’’或’’recursive SQL statements’’。</p><p>如当一个DDL语句发出后，ORACLE总是隐含的发出一些recursive SQL语句，来修改数据字典信息，以便用户可以成功的执行该DDL语句。</p><p>当需要的数据字典信息没有在共享内存中时，经常会发生Recursive calls，这些Recursive calls会将数据字典信息从硬盘读入内存中。</p><p>用户不比关心这些recursive SQL语句的执行情况，在需要的时候，ORACLE会自动的在内部执行这些语句。DML语句与SELECT都可能引起recursive SQL，简单的说，我们可以将触发器视为recursive SQL。</p></li><li><p><strong>Row Source（行源）</strong>：在查询中，由上一操作返回的符合条件的行的集合，可以是表的全部行数据的集合，也可以是表的部分行数据的集合，也可以为对上2个row source进行连接操作（如join连接）后得到的行数据集合。</p></li><li><p><strong>Predicate（谓词）</strong>：一个查询中的WHERE限制条件。</p></li><li><p><strong>Driving Table（驱动表）</strong>：又称为外层表（OUTER TABLE）。用于嵌套与HASH连接中。</p><p>如果该row source返回较多的行数据，则对所有的后续操作有负面影响。</p><p>一般说来，是应用查询的限制条件后，返回较少行源的表作为驱动表，所以如果一个大表在WHERE条件有有限制条件（如等值限 制），则该大表作为驱动表也是合适的，正确说法应该为应用查询的限制条件后，返回较少行源的表作为驱动表。</p></li><li><p><strong>Probed Table（被探查表）</strong>：又称为内层表（INNER TABLE）。在我们从驱动表中得到具体一行的数据后，在该表中寻找符合连接条件的行。所以该表应当为大表（实际上应该为返回较大row source的表）且相应的列上应该有索引。</p></li><li><p><strong>组合索引（concatenated index）</strong>：由多个列构成的索引。</p><p>如create index idx_emp on emp(col1, col2, col3, ……)，则我们称idx_emp索引为组合索引。</p><p>在组合索引中有一个重要的概念：<strong>引导列</strong>（leading column），在上面的例子中，col1列为引导列。</p><p>当我们进行查询时可以使用“where col1 = ？ ”，也可以使用“where col1 = ？ and col2 = ？”，这样的限制条件都会使用索引，但是“where col2 = ？ ”查询就不会使用该索引。</p><p>所以限制条件中包含先导列时，该限制条件才会使用该组合索引。</p></li><li><p><strong>可选择性（selectivity）</strong>：比较一下列中唯一键的数量和表中的行数，就可以判断该列的可选择性。 如果该列的“唯一键的数量/表中的行数”的比值越接近1，则该列的可选择性越高，该列就越适合创建索引，同样索引的可选择性也越高。在可选择性高的列上进 行查询时，返回的数据就较少，比较适合使用索引查询。</p></li></ul><h3 id="1-2-如何查看执行计划？"><a href="#1-2-如何查看执行计划？" class="headerlink" title="1.2 如何查看执行计划？"></a>1.2 如何查看执行计划？</h3><p>oracle要使用执行计划一般在sqlplus执行sql：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> t</span><br></pre></td></tr></table></figure><p>不过如果是使用PLSQL的话，那就可以使用PLSQL提供的查询执行计划了,也就是按F5打开PLSQL工具  -&gt;  首选项  -&gt;  窗口类型  -&gt;  计划窗口  ，在这里加入执行计划需要的参数：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010110.png"></p><p>执行结果：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010111.png"></p><p>参数含义：</p><ul><li>基数(Rows)：Oracle估计的当前步骤的返回结果集行数</li><li>字节(Bytes)：执行SQL对应步骤返回的字节数</li><li>耗费(COST)：CPU耗费：Oracle估计的该步骤的执行耗费和CPU耗费</li><li>时间(Time)：Oracle估计的执行sql对于步骤需要的时间</li></ul><h3 id="1-3-查看真实的执行计划"><a href="#1-3-查看真实的执行计划" class="headerlink" title="1.3 查看真实的执行计划"></a>1.3 查看真实的执行计划</h3><p>sqlplus窗口执行：</p><ul><li>step1：set statistics_level</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> session <span class="keyword">set</span> statistics_level<span class="operator">=</span><span class="keyword">ALL</span>;</span><br></pre></td></tr></table></figure><ul><li>step2：执行业务sql</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+ monitor */</span> <span class="operator">*</span> <span class="keyword">from</span> ... <span class="keyword">where</span> ....;</span><br></pre></td></tr></table></figure><ul><li>step3：为了样式，设置linesize</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> linesize <span class="number">200</span> pagesize <span class="number">300</span>;</span><br></pre></td></tr></table></figure><ul><li>step4：查询真实执行计划</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>(dbms_xplan.display_cursor(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="string">&#x27;iostats last&#x27;</span>));</span><br></pre></td></tr></table></figure><p>sqlplus一般要数据库管理员才可以使用，如果你不是dba，只能使用plsql developer的话，只能用下面的方法。</p><p>使用存储过程，SQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  b1 <span class="type">date</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">execute</span> immediate <span class="string">&#x27;alter session set statistics_level=ALL&#x27;</span>;</span><br><span class="line">  b1 :<span class="operator">=</span> sysdate <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> test <span class="keyword">in</span> (</span><br><span class="line">               <span class="comment">/*业务SQL(sql后面不需要加&quot;;&quot;)*/</span></span><br><span class="line">               <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t) loop</span><br><span class="line">    <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">end</span> loop;</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> (<span class="keyword">select</span> p.plan_table_output</span><br><span class="line">              <span class="keyword">from</span> <span class="keyword">table</span>(dbms_xplan.display_cursor(<span class="keyword">null</span>,</span><br><span class="line">                                                   <span class="keyword">null</span>,</span><br><span class="line">                                                   <span class="string">&#x27;advanced -bytes -PROJECTION allstats last&#x27;</span>)) p) loop</span><br><span class="line">    dbms_output.put_line(x.plan_table_output);</span><br><span class="line">  <span class="keyword">end</span> loop;</span><br><span class="line">  <span class="keyword">rollback</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure><p>两种窗口：</p><ul><li>1、SQL窗口的，执行SQL后只能去output查看；</li><li>2、command window的，需要先设置<code>set serveroutput on size unlimited</code>，然后再执行存储过程</li></ul><p>output或者命令窗口查看的真实执行计划和统计信息：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010112.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SQL_ID  abk3ghv9u1tvb, child number <span class="number">0</span></span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ monitor */</span> <span class="operator">*</span> <span class="keyword">FROM</span> APPR_HANDLE_INFO</span><br><span class="line"> </span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">885170757</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation         <span class="operator">|</span> Name             <span class="operator">|</span> Starts <span class="operator">|</span> E<span class="operator">-</span><span class="keyword">Rows</span> <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> E<span class="operator">-</span><span class="type">Time</span>   <span class="operator">|</span> A<span class="operator">-</span><span class="keyword">Rows</span> <span class="operator">|</span>   A<span class="operator">-</span><span class="type">Time</span>   <span class="operator">|</span> Buffers <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT  <span class="operator">|</span>                  <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>        <span class="operator">|</span>   <span class="number">210</span> (<span class="number">100</span>)<span class="operator">|</span>          <span class="operator">|</span>  <span class="number">72059</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.06</span> <span class="operator">|</span>    <span class="number">2460</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span><span class="operator">|</span> APPR_HANDLE_INFO <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>  <span class="number">32752</span> <span class="operator">|</span>   <span class="number">210</span>   (<span class="number">1</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> <span class="operator">|</span>  <span class="number">72059</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.06</span> <span class="operator">|</span>    <span class="number">2460</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">Query Block Name <span class="operator">/</span> Object Alias (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> SEL$<span class="number">1</span> <span class="operator">/</span> APPR_HANDLE_INFO<span class="variable">@SEL</span>$<span class="number">1</span></span><br><span class="line"> </span><br><span class="line">Outline Data</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*+</span></span><br><span class="line"><span class="comment">      BEGIN_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">      IGNORE_OPTIM_EMBEDDED_HINTS</span></span><br><span class="line"><span class="comment">      OPTIMIZER_FEATURES_ENABLE(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">      DB_VERSION(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">      ALL_ROWS</span></span><br><span class="line"><span class="comment">      OUTLINE_LEAF(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      FULL(@&quot;SEL$1&quot; &quot;APPR_HANDLE_INFO&quot;@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      END_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure><p>关键信息解释：</p><ul><li>Starts：该SQL执行的次数</li><li>E-Rows：为执行计划预计的行数</li><li>A-Rows：实际返回的行数，E-Rows和A-Rows作比较，就可以看出具体那一步执行计划出问题了</li><li>A-Time：每一步实际执行的时间，可以看出耗时的SQL</li><li>Buffers：每一步实际执行的逻辑读或一致性读</li></ul><h3 id="1-4-分析执行计划"><a href="#1-4-分析执行计划" class="headerlink" title="1.4 分析执行计划"></a>1.4 分析执行计划</h3><h4 id="1-4-1-查看explain"><a href="#1-4-1-查看explain" class="headerlink" title="1.4.1 查看explain"></a>1.4.1 查看explain</h4><p>找一条比较复杂的SQL，执行：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010113.png"></p><p> set statistics_level=ALL方式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010114.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">SQL_ID  <span class="number">4</span>qfq3t2ukm0y1, child number <span class="number">0</span></span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ monitor*/</span> A.USER_CODE, A.FULL_NAME, A.USER_PWD, C.UNIT_CODE, </span><br><span class="line">C.UNIT_NAME <span class="keyword">FROM</span> BASE_USER A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> UR.USER_CODE, </span><br><span class="line">UR.UNIT_CODE <span class="keyword">FROM</span> APPR_USER_ROLE UR <span class="keyword">WHERE</span> UR.USER_ROLE <span class="operator">&lt;</span> <span class="number">10</span>) B <span class="keyword">ON</span> </span><br><span class="line">A.USER_CODE <span class="operator">=</span> B.USER_CODE <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> LZCITY_APPROVE_UNIT_INFO C <span class="keyword">ON</span> </span><br><span class="line">B.UNIT_CODE <span class="operator">=</span> C.UNIT_CODE <span class="keyword">WHERE</span> C.UNIT_CODE <span class="operator">=</span><span class="string">&#x27;15803&#x27;</span></span><br><span class="line"> </span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">3288287052</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation                      <span class="operator">|</span> Name                        <span class="operator">|</span> Starts <span class="operator">|</span> E<span class="operator">-</span><span class="keyword">Rows</span> <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> E<span class="operator">-</span><span class="type">Time</span>   <span class="operator">|</span> A<span class="operator">-</span><span class="keyword">Rows</span> <span class="operator">|</span>   A<span class="operator">-</span><span class="type">Time</span>   <span class="operator">|</span> Buffers <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT               <span class="operator">|</span>                             <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>        <span class="operator">|</span>     <span class="number">3</span> (<span class="number">100</span>)<span class="operator">|</span>          <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>      <span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>  NESTED LOOPS                  <span class="operator">|</span>                             <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">3</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>      <span class="number">38</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span>   NESTED LOOPS                 <span class="operator">|</span>                             <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">3</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>      <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span>    NESTED LOOPS                <span class="operator">|</span>                             <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">2</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>       <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span>     <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID<span class="operator">|</span> LZCITY_APPROVE_UNIT_INFO    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">5</span> <span class="operator">|</span>      INDEX <span class="keyword">UNIQUE</span> SCAN         <span class="operator">|</span> PK_LZCITY_APPROVE_UNIT_INFO <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">0</span>   (<span class="number">0</span>)<span class="operator">|</span>          <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">6</span> <span class="operator">|</span>     INDEX <span class="keyword">RANGE</span> SCAN           <span class="operator">|</span> PK_APPR_USER_ROLE           <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">7</span> <span class="operator">|</span>    INDEX <span class="keyword">UNIQUE</span> SCAN           <span class="operator">|</span> PK_BASE_USER                <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">0</span>   (<span class="number">0</span>)<span class="operator">|</span>          <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>      <span class="number">17</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span>   <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID  <span class="operator">|</span> BASE_USER                   <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span>     <span class="number">1</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span>     <span class="number">16</span> <span class="operator">|</span><span class="number">00</span>:<span class="number">00</span>:<span class="number">00.01</span> <span class="operator">|</span>      <span class="number">16</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">Query Block Name <span class="operator">/</span> Object Alias (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> SEL$E3445A69</span><br><span class="line">   <span class="number">4</span> <span class="operator">-</span> SEL$E3445A69 <span class="operator">/</span> C<span class="variable">@SEL</span>$<span class="number">4</span></span><br><span class="line">   <span class="number">5</span> <span class="operator">-</span> SEL$E3445A69 <span class="operator">/</span> C<span class="variable">@SEL</span>$<span class="number">4</span></span><br><span class="line">   <span class="number">6</span> <span class="operator">-</span> SEL$E3445A69 <span class="operator">/</span> UR<span class="variable">@SEL</span>$<span class="number">2</span></span><br><span class="line">   <span class="number">7</span> <span class="operator">-</span> SEL$E3445A69 <span class="operator">/</span> A<span class="variable">@SEL</span>$<span class="number">3</span></span><br><span class="line">   <span class="number">8</span> <span class="operator">-</span> SEL$E3445A69 <span class="operator">/</span> A<span class="variable">@SEL</span>$<span class="number">3</span></span><br><span class="line"> </span><br><span class="line">Outline Data</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*+</span></span><br><span class="line"><span class="comment">      BEGIN_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">      IGNORE_OPTIM_EMBEDDED_HINTS</span></span><br><span class="line"><span class="comment">      OPTIMIZER_FEATURES_ENABLE(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">      DB_VERSION(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">      ALL_ROWS</span></span><br><span class="line"><span class="comment">      OUTLINE_LEAF(@&quot;SEL$E3445A69&quot;)</span></span><br><span class="line"><span class="comment">      MERGE(@&quot;SEL$2&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$A2E96217&quot;)</span></span><br><span class="line"><span class="comment">      OUTER_JOIN_TO_INNER(@&quot;SEL$E9F4A6F9&quot; &quot;B&quot;@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      OUTER_JOIN_TO_INNER(@&quot;SEL$E9F4A6F9&quot; &quot;C&quot;@&quot;SEL$4&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$2&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$E9F4A6F9&quot;)</span></span><br><span class="line"><span class="comment">      MERGE(@&quot;SEL$80808B20&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$6&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$80808B20&quot;)</span></span><br><span class="line"><span class="comment">      MERGE(@&quot;SEL$4&quot;)</span></span><br><span class="line"><span class="comment">      MERGE(@&quot;SEL$F1D6E378&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$5&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$4&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$F1D6E378&quot;)</span></span><br><span class="line"><span class="comment">      MERGE(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$3&quot;)</span></span><br><span class="line"><span class="comment">      OUTLINE(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      INDEX_RS_ASC(@&quot;SEL$E3445A69&quot; &quot;C&quot;@&quot;SEL$4&quot; (&quot;LZCITY_APPROVE_UNIT_INFO&quot;.&quot;UNIT_CODE&quot;))</span></span><br><span class="line"><span class="comment">      INDEX(@&quot;SEL$E3445A69&quot; &quot;UR&quot;@&quot;SEL$2&quot; (&quot;APPR_USER_ROLE&quot;.&quot;UNIT_CODE&quot; &quot;APPR_USER_ROLE&quot;.&quot;USER_CODE&quot; &quot;APPR_USER_ROLE&quot;.&quot;AREA_SEQ&quot; </span></span><br><span class="line"><span class="comment">              &quot;APPR_USER_ROLE&quot;.&quot;USER_ROLE&quot;))</span></span><br><span class="line"><span class="comment">      INDEX(@&quot;SEL$E3445A69&quot; &quot;A&quot;@&quot;SEL$3&quot; (&quot;BASE_USER&quot;.&quot;USER_CODE&quot;))</span></span><br><span class="line"><span class="comment">      LEADING(@&quot;SEL$E3445A69&quot; &quot;C&quot;@&quot;SEL$4&quot; &quot;UR&quot;@&quot;SEL$2&quot; &quot;A&quot;@&quot;SEL$3&quot;)</span></span><br><span class="line"><span class="comment">      USE_NL(@&quot;SEL$E3445A69&quot; &quot;UR&quot;@&quot;SEL$2&quot;)</span></span><br><span class="line"><span class="comment">      USE_NL(@&quot;SEL$E3445A69&quot; &quot;A&quot;@&quot;SEL$3&quot;)</span></span><br><span class="line"><span class="comment">      NLJ_BATCHING(@&quot;SEL$E3445A69&quot; &quot;A&quot;@&quot;SEL$3&quot;)</span></span><br><span class="line"><span class="comment">      END_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> </span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">5</span> <span class="operator">-</span> access(&quot;C&quot;.&quot;UNIT_CODE&quot;<span class="operator">=</span><span class="string">&#x27;15803&#x27;</span>)</span><br><span class="line">   <span class="number">6</span> <span class="operator">-</span> access(&quot;UR&quot;.&quot;UNIT_CODE&quot;<span class="operator">=</span><span class="string">&#x27;15803&#x27;</span> <span class="keyword">AND</span> &quot;UR&quot;.&quot;USER_ROLE&quot;<span class="operator">&lt;</span><span class="number">10</span>)</span><br><span class="line">       <span class="keyword">filter</span>(&quot;UR&quot;.&quot;USER_ROLE&quot;<span class="operator">&lt;</span><span class="number">10</span>)</span><br><span class="line">   <span class="number">7</span> <span class="operator">-</span> access(&quot;A&quot;.&quot;USER_CODE&quot;<span class="operator">=</span>&quot;UR&quot;.&quot;USER_CODE&quot;)</span><br></pre></td></tr></table></figure><h4 id="1-4-2-explain执行顺序"><a href="#1-4-2-explain执行顺序" class="headerlink" title="1.4.2 explain执行顺序"></a>1.4.2 explain执行顺序</h4><p>不管是用F5方式还是set statistics_level=ALL方式，都有Operation参数，Operation表示sql执行过程，查看怎么执行的，有两个规则：</p><ul><li>根据Operation缩进判断，缩进最多的最先执行；</li><li>Operation缩进相同时，最上面的是最先执行的；</li></ul><p>如图执行计划，根据规则，可以得出<strong>执行顺序</strong>：INDEX UNIQUE SCAN-&gt;TABLE ACCESS BY INDEX ROWID-&gt;INDEX RANGE SCAN -&gt;NESTED LOOPS -&gt;INDEX UNIQUE SCAN-&gt;NESTED LOOPS   -&gt;TABLE ACCESS BY INDEX ROWID-&gt;NESTED LOOPS-&gt; SELECT STATEMENT 。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010115.png"></p><h4 id="1-4-3-访问数据方式"><a href="#1-4-3-访问数据方式" class="headerlink" title="1.4.3 访问数据方式"></a>1.4.3 访问数据方式</h4><p>Oracle访问表中数据的方法有两种：</p><ul><li><p>访问表数据：直接表中访问数据。</p></li><li><p>索引扫描：先访问索引，如果索引数据不符合目标SQL，就回表，符合就不回表，直接访问索引就可以。</p><p>先通过index查找到数据对应的rowid值（对于非唯一索引可能返回多个rowid值），然后根据rowid直接从表中得到具体的数据。该行对应的数据块是通过一次i/o得到的，在此情况下该次i/o只会读取一个数据库块。</p></li></ul><p>Oracle直接<strong>访问表中数据</strong>的方法又分为两种：</p><ul><li><strong>全表扫描（TABLE ACCESS FULL）</strong></li><li><strong>ROWID扫描（TABLE ACCESS BY ROWID）</strong></li></ul><p>访问索引的种类更多（TABLE ACCESS BY INDEX SCAN）：</p><ul><li><strong>索引唯一扫描（INDEX UNIQUE SCAN）</strong></li><li><strong>索引范围扫描（INDEX RANGE SCAN）</strong></li><li><strong>索引全扫描（INDEX FULL SCAN）</strong></li><li><strong>索引快速全扫描（INDEX FAST FULL SCAN）</strong></li><li><strong>索引跳跃式扫描（INDEX SKIP SCAN）</strong></li></ul><p>索引扫描可以由2步组成：</p><ol><li>扫描索引得到对应的rowid值。 </li><li> 通过找到的rowid从表中读出具体的数据。</li></ol><p>每步都是单独的一次I/O，但是对于索引，由于经常使用，绝大多数都已经CACHE到内存中，所以第1步的 I/O经常是逻辑I/O，即数据可以从内存中得到。</p><p>但是对于第2步来说，如果表比较大，则其数据不可能全在内存中，所以其I/O很有可能是物理I/O，这是一个机械操作，相对逻辑I/O来说，是极其费时间的。</p><p>所以如果多大表进行索引扫描，取出的数据如果大于总量的5% —— 10%，使用索引扫描会效率下降很多。如下列所示：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno， ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">10</span>；</span><br><span class="line">　　Query Plan</span><br><span class="line"></span><br><span class="line"><span class="comment">------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> ROWID EMP [ANALYZED]</span><br><span class="line">INDEX <span class="keyword">UNIQUE</span> SCAN EMP_I1</span><br></pre></td></tr></table></figure><p>如果查询的数据能全在索引中找到，就可以避免进行第2步操作，避免了不必要的I/O，此时即使通过索引扫描取出的数据比较多，效率还是很高的：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">10</span>;<span class="comment">-- 只查询empno列值</span></span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line">INDEX <span class="keyword">UNIQUE</span> SCAN EMP_I1</span><br></pre></td></tr></table></figure><p>如果sql语句中对索引列进行排序，因为索引已经预先排序好了，所以在执行计划中不需要再对索引列进行排序：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno, ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">&gt;</span> <span class="number">7876</span> <span class="keyword">order</span> <span class="keyword">by</span> empno;</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> ROWID EMP [ANALYZED]</span><br><span class="line">INDEX <span class="keyword">RANGE</span> SCAN EMP_I1 [ANALYZED]</span><br></pre></td></tr></table></figure><h5 id="（1）全表扫描（TABLE-ACCESS-FULL）"><a href="#（1）全表扫描（TABLE-ACCESS-FULL）" class="headerlink" title="（1）全表扫描（TABLE ACCESS FULL）"></a>（1）全表扫描（TABLE ACCESS FULL）</h5><ul><li>全表扫描时从第一个区(EXTENT)的第一个块(BLOCK)开始扫描，一直扫描的到表的高水位线(High Water Mark)，这个范围内的数据块都会扫描到。</li><li>全表扫描是采用多数据块一起扫的，并不是一个个数据库扫的，也不是只读取一个数据块，减少了I/O总次数，提高了系统的吞吐量。</li><li>全表扫描慢是针对数据量很多的情况，数据量少的话，全表扫描并不慢的，不过随着数据量越多，高水位线也就越高，也就是说需要扫描的数据库越多，自然扫描所需要的IO越多，时间也越多。</li></ul><p>注意：数据量越多，全表扫描所需要的时间就越多，然后直接删了表数据呢？查询速度会变快？其实并不会的，因为即使我们删了数据，高位水线并不会改变，也就是同样需要扫描那么多数据块。</p><p><strong>使用场景：</strong>在较大的表上不建议使用全表扫描，除非取出数据的比较多，超过总量的5%到10%，以及想使用并行查询功能时。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> explain plan <span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dual;</span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">-----------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> DUAL</span><br></pre></td></tr></table></figure><h5 id="（2）ROWID扫描（TABLE-ACCESS-BY-ROWID）"><a href="#（2）ROWID扫描（TABLE-ACCESS-BY-ROWID）" class="headerlink" title="（2）ROWID扫描（TABLE ACCESS BY ROWID）"></a>（2）ROWID扫描（TABLE ACCESS BY ROWID）</h5><p>ROWID也就是表数据行所在的物理存储地址，所谓的ROWID扫描是通过ROWID所在的数据行记录去定位。ROWID是一个伪列，数据库里并没有这个列，它是数据库查询过程中获取的一个物理地址，用于表示数据对应的行数。 <strong>Oracle存取单行数据的最快方法。</strong></p><p>这种存取方法不会用到多块读操作，一次I/O只能读取一个数据块。我们会经常在执行计划中看到该存取方法，如通过索引查询数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept <span class="keyword">where</span> rowid <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>AAAAyGAADAAAAATAAF<span class="string">&#x27;&#x27;</span>；</span><br><span class="line"> </span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> ROWID DEPT [ANALYZED]</span><br></pre></td></tr></table></figure><p>可以用sql查询rowid：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t.<span class="operator">*</span>,rowid <span class="keyword">from</span> 表格</span><br></pre></td></tr></table></figure><p>随意获取一个ROWID序列：AAAWSJAAFAAAWwUAAA</p><ul><li>前6位表示对象编号(Data Object number)</li><li>其后3位文件编号(Relative file number)</li><li>再后6位表示块编号(Block number)</li><li>最后3位表示行编号(Row number)</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010116.jpeg"></p><p><strong>ROWID编码方法是：A ~ Z表示0到25；a ~ z表示26到51；0~9表示52到61；+表示62；/表示63；刚好64个字符。</strong></p><p>随意找张表查一下文件编号、区编号、行编号，查询后会返回rowid的一系列物理地址和文件编号(rowid_relative_fno(rowid))、块编号(rowid_block_number(rowid))、行编号(rowid_row_number(rowid))：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t.seq,</span><br><span class="line">       rowid,</span><br><span class="line">       dbms_rowid.rowid_relative_fno(rowid),</span><br><span class="line">       dbms_rowid.rowid_block_number(rowid),</span><br><span class="line">       dbms_rowid.rowid_row_number(rowid)</span><br><span class="line">  <span class="keyword">from</span> t_info t</span><br></pre></td></tr></table></figure><p>SQL查询一下表格名称为TABLE的对象编码</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> owner,object_id,data_object_id,status <span class="keyword">from</span> dba_objects <span class="keyword">where</span> </span><br></pre></td></tr></table></figure><p><strong>相对文件id和绝对文件编码</strong>：相对文件id是指相对于表空间，在表空间唯一;绝对文件编码是指相当于全局数据库而言的，全局唯一。</p><p>查询一下相对文件id和绝对文件编码：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> file_name,file_id,relative_fno <span class="keyword">from</span> dba_data_files;</span><br></pre></td></tr></table></figure><h5 id="（3）索引唯一扫描（INDEX-UNIQUE-SCAN）"><a href="#（3）索引唯一扫描（INDEX-UNIQUE-SCAN）" class="headerlink" title="（3）索引唯一扫描（INDEX UNIQUE SCAN）"></a>（3）索引唯一扫描（INDEX UNIQUE SCAN）</h5><ul><li>索引唯一性扫描（INDEX UNIQUE SCAN）是针对唯一性索引（UNIQUE INDEX）来说的，也就是建立唯一性索引才能索引唯一性扫描。</li><li>唯一性扫描，其结果集只会返回一条记录。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno，ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">10</span>；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> ROWID EMP [ANALYZED]</span><br><span class="line">INDEX <span class="keyword">UNIQUE</span> SCAN EMP_I1</span><br></pre></td></tr></table></figure><h5 id="（4）索引范围扫描（INDEX-RANGE-SCAN）"><a href="#（4）索引范围扫描（INDEX-RANGE-SCAN）" class="headerlink" title="（4）索引范围扫描（INDEX RANGE SCAN）"></a>（4）索引范围扫描（INDEX RANGE SCAN）</h5><ul><li>当扫描的对象是非唯一性索引的情况，where谓词条件为Between、=、&lt;、&gt;等等的情况就是索引范围扫描，注意，可以是等值查询，也可以是范围查询。</li><li>适用于所有类型的B树索引，一般不包括唯一性索引，因为唯一性索引走索引唯一性扫描。</li></ul><p>使用index rang scan的3种情况：</p><ul><li>在唯一索引列上使用了range操作符（&gt; &lt; &lt;&gt; &gt;= &lt;= between）</li><li>在组合索引上，只使用部分列进行查询，导致查询出多行</li><li>对非唯一索引列上进行的任何查询</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno，ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">&gt;</span> <span class="number">7876</span> <span class="keyword">order</span> <span class="keyword">by</span> empno；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> ROWID EMP [ANALYZED]</span><br><span class="line">INDEX <span class="keyword">RANGE</span> SCAN EMP_I1 [ANALYZED]</span><br></pre></td></tr></table></figure><p><strong>如果where条件里有一个索引键值列没限定为非空的，那就可以走索引范围扫描，如果改索引列是非空的，那就走索引全扫描。</strong></p><p>前面说了，同样的SQL建的索引不同，就可能是走索引唯一性扫描，也有可能走索引范围扫描。在同等的条件下，索引范围扫描所需要的逻辑读和索引唯一性扫描对比，逻辑读如何？索引范围扫描可能返回多条记录，所以优化器为了确认，肯定会多扫描，<strong>所以在同等条件，索引范围扫描所需要的逻辑读至少会比相应的唯一性扫描的逻辑读多1。</strong></p><h5 id="（5）索引全扫描（INDEX-FULL-SCAN）"><a href="#（5）索引全扫描（INDEX-FULL-SCAN）" class="headerlink" title="（5）索引全扫描（INDEX FULL SCAN）"></a>（5）索引全扫描（INDEX FULL SCAN）</h5><ul><li>适用于所有类型的B树索引(包括唯一性索引和非唯一性索引)。</li><li>查询出的数据都必须从索引中可以直接得到。</li><li>索引全扫描是指扫描目标索引所有叶子块的索引行，但不意思着需要扫描所有的分支块，索引全扫描时只需要访问必要的分支块，然后定位到位于改索引最左边的叶子块的第一行索引行，就可以利用改索引叶子块之间的双向指针链表，从左往右依次顺序扫描所有的叶子块的索引行。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">An Index <span class="keyword">full</span> scan will <span class="keyword">not</span> perform single block i<span class="operator">/</span>o<span class="string">&#x27;&#x27;</span>s <span class="keyword">and</span> so it may prove <span class="keyword">to</span> be inefficient. </span><br><span class="line">e.g.</span><br><span class="line"></span><br><span class="line">Index BE_IX <span class="keyword">is</span> a concatenated index <span class="keyword">on</span> big_emp(empno, ename)</span><br><span class="line"></span><br><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno， ename <span class="keyword">from</span> big_emp <span class="keyword">order</span> <span class="keyword">by</span> empno，ename；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">26</span></span><br><span class="line">INDEX <span class="keyword">FULL</span> SCAN BE_IX [ANALYZED]</span><br></pre></td></tr></table></figure><h5 id="（6）索引快速全扫描（INDEX-FAST-FULL-SCAN）"><a href="#（6）索引快速全扫描（INDEX-FAST-FULL-SCAN）" class="headerlink" title="（6）索引快速全扫描（INDEX FAST FULL SCAN）"></a>（6）索引快速全扫描（INDEX FAST FULL SCAN）</h5><ul><li>索引快速全扫描和索引全扫描很类似，也适用于所有类型的B树索引(包括唯一性索引和非唯一性索引)。</li><li>和索引全扫描类似，也是扫描所有叶子块的索引行，这些都是索引快速全扫描和索引全扫描的相同点。</li><li>它不对查询出的数据进行排序，即数据不是以排序顺序被返回。</li><li>可以使用多块读功能，也可以使用并行读入，以便获得最大吞吐量与缩短执行时间。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># BE_IX索引是一个多列索引： big_emp(empno, ename)</span><br><span class="line"></span><br><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> empno，ename <span class="keyword">from</span> big_emp；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line">INDEX FAST <span class="keyword">FULL</span> SCAN BE_IX [ANALYZED]</span><br><span class="line"></span><br><span class="line"># 只选择多列索引的第<span class="number">2</span>列：</span><br><span class="line">explain plan <span class="keyword">for</span> <span class="keyword">select</span> ename <span class="keyword">from</span> big_emp；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">1</span></span><br><span class="line">INDEX FAST <span class="keyword">FULL</span> SCAN BE_IX [ANALYZED]</span><br></pre></td></tr></table></figure><p>索引快速全扫描和索引全扫描区别：</p><ul><li>索引快速全扫描只适应于CBO(基于成本的优化器)</li><li>索引快速全扫描可以使用多块读，也可以并行执行</li><li>索引全扫描会按照叶子块排序返回，而索引快速全扫描则是按照索引段内存储块顺序返回</li><li>索引快速全扫描的执行结果不一定是有序的，而索引全扫描的执行结果是有序的，因为索引快速全扫描是根据索引行在磁盘的物理存储顺序来扫描的，不是根据索引行的逻辑顺序来扫描的</li></ul><h5 id="（7）索引跳跃式扫描（INDEX-SKIP-SCAN）"><a href="#（7）索引跳跃式扫描（INDEX-SKIP-SCAN）" class="headerlink" title="（7）索引跳跃式扫描（INDEX SKIP SCAN）"></a>（7）索引跳跃式扫描（INDEX SKIP SCAN）</h5><p>索引跳跃式扫描(INDEX SKIP SCAN)适用于所有类型的<em><strong>复合B树索引</strong></em>(包括唯一性索引和非唯一性索引)，索引跳跃式扫描可以使那些在where条件中没有目标索引的前导列指定查询条件但是有索引的非前导列指定查询条件的目标SQL依然可以使用跳跃索引。</p><p>如图执行计划就有INDEX RANGE SCAN、 INDEX UNIQUE SCAN 等等：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010117.png"></p><h4 id="1-4-4-表连接方式"><a href="#1-4-4-表连接方式" class="headerlink" title="1.4.4 表连接方式"></a>1.4.4 表连接方式</h4><p>如图，执行计划中有如下NESTED LOOPS等，是Oracle中表连接的方法：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010118.png"></p><ul><li>Join是一种试图将两个表结合在一起的谓词，一次只能连接2个表，表连接也可以被称为表关联。</li><li>使用row source来代替表的描述更准确，将参与连接的2个row source分别称为row source1和row source 2。</li><li>Join过程的各个步骤经常是串行操作，即使相关的row source可以被并行访问，即可以并行的读取做join连接的两个row source的数据，但是在将表中符合限制条件的数据读入到内存形成row source后，join的其它步骤一般是串行的。</li></ul><p>row source之间的<strong>连接顺序对于查询的效率</strong>有非常大的影响。通过首先存取特定的表，即将该表作为驱动表，这样可以先应用某些限制条件，从而得到一个较小的row source，使连接的效率较高，这也就是我们常说的要先执行限制条件的原因。一般是在将表读入内存时，应用where子句中对该表的限制条件。</p><p>表连接方式：</p><ul><li><strong>排序合并连接（sort merge join）</strong> ：先将关联表的关联列各自做排序，然后从各自的排序表中抽取数据，到另一个排序表中做匹配。<ul><li> 对于非等值连接，这种连接方式的效率是比较高的。</li><li>如果在关联的列上都有索引，效果更好。</li><li>对于将2个较大的row source做连接，该连接方法比NL连接要好一些。</li><li>但是如果sort merge返回的row source过大，则又会导致使用过多的rowid在表中查询数据时，数据库性能下降，因为过多的I/O。</li></ul></li><li><strong>嵌套循环连接（Nested loop join）</strong>：Nested loops 工作方式是循环从一张表中读取数据(驱动表outer table)，然后访问另一张表（被查找表 inner table,通常有索引）。驱动表中的每一行与inner表中的相应记录JOIN。类似一个嵌套的循环。<strong>对于被连接的数据子集较小的情况，nested loop连接是个较好的选择</strong>。<ul><li>如果driving row source（外部表）比较小，并且在inner row source（内部表）上有唯一索引，或有高选择性非唯一索引时，使用这种方法可以得到较好的效率。</li><li>NESTED LOOPS有其它连接方法没有的的一个优点是：可以先返回已经连接的行，而不必等待所有的连接操作处理完才返回数据，这可以实现快速的响应时间。</li></ul></li><li><strong>哈希连接（Hash join）</strong>：散列连接是CBO 做<a href="https://cloud.tencent.com/solution/bigdata?from=10680">大数据</a>集连接时的常用方式，优化器使用两个表中较小的表（或数据源）利用连接键在内存中建立散列表，然后扫描较大的表并探测散列表，找出与散列表匹配的行。 <ul><li>这种方法是在oracle7后来引入的，使用了比较先进的连接理论，一般来说，其效率应该好于其它2种连接，但是这种连接只能用在CBO优化器中，而且需要设置合适的hash_area_size参数，才能取得较好的性能。</li><li>在2个较大的row source之间连接时会取得相对较好的效率，在一个row source较小时则能取得更好的效率。</li><li>只能用于等值连接中</li></ul></li><li><strong>笛卡尔连接（Cross join）</strong>：如果两个表做表连接而没有连接条件，而会产生笛卡尔积，在实际工作中应该尽可能避免笛卡尔积。</li></ul><h5 id="（1）排序合并连接（sort-merge-join）"><a href="#（1）排序合并连接（sort-merge-join）" class="headerlink" title="（1）排序合并连接（sort merge join）"></a>（1）排序合并连接（sort merge join）</h5><p>内部连接过程：</p><ol><li>首先生成row source1需要的数据，然后对这些数据按照连接操作关联列（如A.col3）进行排序。</li><li>随后生成row source2需要的数据，然后对这些数据按照与sort source1对应的连接操作关联列（如B.col4）进行排序。</li><li>最后两边已排序的行被放在一起执行合并操作，即将2个row source按照连接条件连接起来。</li></ol><p>如果row source已经在连接关联列上被排序，则该连接操作就不需要再进行sort操作，这样可以大大提高这种连接操作的连接速度，因为排序是个极其费资源的操作，特别是对于较大的表。</p><p>预先排序的row source包括已经被索引的列（如a.col3或b.col4上有索引）或row source已经在前面的步骤中被排序了。</p><p>尽管合并两个row source的过程是串行的，但是可以并行访问这两个row source（如并行读入数据，并行排序）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span></span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ ordered */</span> e.deptno， d.deptno</span><br><span class="line"><span class="keyword">from</span> emp e， dept d</span><br><span class="line"><span class="keyword">where</span> e.deptno <span class="operator">=</span> d.deptno</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> e.deptno， d.deptno；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">17</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">JOIN</span></span><br><span class="line">SORT <span class="keyword">JOIN</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> EMP [ANALYZED]</span><br><span class="line">SORT <span class="keyword">JOIN</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> DEPT [ANALYZED]</span><br></pre></td></tr></table></figure><p>排序是一个费时、费资源的操作，特别对于大表。基于这个原因，SMJ经常不是一个特别有效的连接方法，但是如果2个row source都已经预先排序，则这种连接方法的效率也是蛮高的。</p><h5 id="（2）嵌套循环连接（Nested-loop-join）"><a href="#（2）嵌套循环连接（Nested-loop-join）" class="headerlink" title="（2）嵌套循环连接（Nested loop join）"></a>（2）嵌套循环连接（Nested loop join）</h5><p>这个连接方法有驱动表（外部表）的概念。其实，该连接过程就是一个2层嵌套循环，所以外层循环的次数越少越好，这也就是我们为什么将小表或返回较小row source的表作为驱动表（用于外层循环）的理论依据。</p><p>但是这个理论只是一般指导原则，因为遵循这个理论并不能总保证使语句产生的I/O次数最少。有时不遵守这个理论依据，反而会获得更好的效率。如果使用这种方法，决定使用哪个表作为驱动表很重要。有时如果驱动表选择不正确，将会导致语句的性能很差。</p><p>内部连接过程：</p><ul><li>Row source1的Row 1 —— Probe -&gt;Row source 2</li><li>Row source1的Row 2 —— Probe -&gt;Row source 2</li><li>Row source1的Row 3 —— Probe -&gt;Row source 2</li><li>……</li><li>Row source1的Row n —— Probe -&gt;Row source 2</li></ul><p>从内部连接过程来看，需要用row source1中的每一行，去匹配row source2中的所有行，所以此时保持row source1尽可能的小与高效的访问row source2（一般通过索引实现）是影响这个连接效率的关键问题。</p><p>这只是理论指导原则，目的是使整个连接操作产生最少的物理I/O次数，而且如果遵守这个原则，一般也会使总的物理I/O数最少。但是如果不遵从这个指导原则，反而能用更少的物理I/O实现连接操作，那尽管违反指导原则吧！因为最少的物理 I/O次数才是我们应该遵从的真正的指导原则。</p><p>在NESTED LOOPS连接中，Oracle读取row source1中的每一行，然后在row sourc2中检查是否有匹配的行，所有被匹配的行都被放到结果集中，然后处理row source1中的下一行。这个过程一直继续，直到row source1中的所有行都被处理。这是从连接操作中可以得到第一个匹配行的最快的方法之一，这种类型的连接可以用在需要快速响应的语句中，以响应速度为主要目标。</p><p>如果driving row source（外部表）比较小，并且在inner row source（内部表）上有唯一索引，或有高选择性非唯一索引时，使用这种方法可以得到较好的效率。</p><p>NESTED LOOPS有其它连接方法没有的的一个优点是：可以先返回已经连接的行，而不必等待所有的连接操作处理完才返回数据，这可以实现快速的响应时间。</p><p>如果不使用并行操作，最好的驱动表是那些应用了where限制条件后，可以返回较少行数据的的表，所以大表也可能称为驱动表，关键看限制条件。</p><p>对于并行查询，我们经常选择大表作为驱动表，因为大表可以充分利用并行功能。当然，有时对查询使用并行操作并不一定会比查询不使用并行操作效率高，因为最后可能每个表只有很少的行符合限制条件，而且还要看你的硬件配置是否 可以支持并行（如是否有多个CPU，多个硬盘控制器），所以要具体问题具体对待。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span></span><br><span class="line"><span class="keyword">select</span> a.dname，b.sql</span><br><span class="line"><span class="keyword">from</span> dept a，emp b</span><br><span class="line"><span class="keyword">where</span> a.deptno <span class="operator">=</span> b.deptno；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">-------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">5</span></span><br><span class="line">NESTED LOOPS</span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> DEPT [ANALYZED]</span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> EMP [ANALYZED]</span><br></pre></td></tr></table></figure><h5 id="（3）哈希连接（Hash-join）"><a href="#（3）哈希连接（Hash-join）" class="headerlink" title="（3）哈希连接（Hash join）"></a>（3）哈希连接（Hash join）</h5><p>这种连接是在oracle 7.3以后引入的，从理论上来说比NL与SMJ更高效，而且只用在CBO优化器中。</p><p>较小的row source被用来构建hash table与bitmap，第2个row source被用来被hansed，并与第一个row source生成的hash table进行匹配，以便进行进一步的连接。</p><p>内部连接过程：</p><ul><li>取出 row source 1（驱动表，在HASH JOIN中又称为Build Table） 的数据集，然后将其构建成内存中的一个 Hash Table（Hash函数的Hash KEY就是连接操作关联列），创建Hash位图（bitmap）</li><li>取出 row source 2（匹配表）的数据集，对其中的每一条数据的连接操作关联列使用相同的Hash函数并找到对应的 a) 里的数据在 Hash Table 中的位置，在该位置上检查能否找到匹配的数据</li></ul><p>Bitmap被用来作为一种比较快的查找方法，来检查在hash table中是否有匹配的行。特别的，当hash table比较大而不能全部容纳在内存中时，这种查找方法更为有用。</p><p>这种连接方法也有NL连接中所谓的驱动表的概念，被构建为hash table与bitmap的表为驱动表，当被构建的hash table与bitmap能被容纳在内存中时，这种连接方式的效率极高。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span></span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ use_hash（emp） */</span> empno</span><br><span class="line"><span class="keyword">from</span> emp, dept</span><br><span class="line"><span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno；</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">----------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT[CHOOSE] Cost<span class="operator">=</span><span class="number">3</span></span><br><span class="line">HASH <span class="keyword">JOIN</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> DEPT</span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> EMP</span><br></pre></td></tr></table></figure><p>要使哈希连接有效，需要设置HASH_JOIN_ENABLED=TRUE，缺省情况下该参数为TRUE，另外，不要忘了还要设置 hash_area_size参数，以使哈希连接高效运行，因为哈希连接会在该参数指定大小的内存中运行，过小的参数会使哈希连接的性能比其他连接方式还要低。</p><h5 id="（4）笛卡尔连接（Cross-join）"><a href="#（4）笛卡尔连接（Cross-join）" class="headerlink" title="（4）笛卡尔连接（Cross join）"></a>（4）笛卡尔连接（Cross join）</h5><p>当两个row source做连接，但是它们之间没有关联条件时，就会在两个row source中做笛卡儿乘积，这通常由编写代码疏漏造成（即程序员忘了写关联条件）。</p><p>笛卡尔乘积是一个表的每一行依次与另一个表中的所有行匹配。在特殊情况下我们可以使用笛卡儿乘积，如在星形连接中，除此之外，我们要尽量不使用笛卡儿乘积。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain plan <span class="keyword">for</span></span><br><span class="line"><span class="keyword">select</span> emp.deptno，dept，deptno</span><br><span class="line"><span class="keyword">from</span> emp，dept</span><br><span class="line"></span><br><span class="line">Query Plan</span><br><span class="line"><span class="comment">------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> STATEMENT [CHOOSE] Cost<span class="operator">=</span><span class="number">5</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">JOIN</span> CARTESIAN</span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> DEPT</span><br><span class="line">SORT <span class="keyword">JOIN</span></span><br><span class="line"><span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> EMP</span><br></pre></td></tr></table></figure><p>CARTESIAN关键字指出了在2个表之间做笛卡尔乘积。假如表emp有n行，dept表有m行，笛卡尔乘积的结果就是得到n * m行结果。</p><h4 id="1-4-5-explain参数信息"><a href="#1-4-5-explain参数信息" class="headerlink" title="1.4.5 explain参数信息"></a>1.4.5 explain参数信息</h4><p>执行计划关键信息介绍：</p><ul><li>Starts：该SQL执行的次数</li><li>E-Rows：为执行计划预计的行数</li><li><a href="http://www.itpub.net/forum.php?mod=viewthread&tid=1264620&highlight=">Cost (%CPU)</a>：CPU cost在整个cost中占的百分比</li><li>A-Rows：实际返回的行数，E-Rows和A-Rows作比较，就可以看出具体那一步执行计划出问题了</li><li>A-Time：每一步实际执行的时间，可以看出耗时的SQL</li><li>Buffers：每一步实际执行的逻辑读或一致性读</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010119.png"></p><h2 id="二-MySQL"><a href="#二-MySQL" class="headerlink" title="二. MySQL"></a>二. MySQL</h2><h3 id="2-1-使用explain"><a href="#2-1-使用explain" class="headerlink" title="2.1 使用explain"></a>2.1 使用explain</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br></pre></td></tr></table></figure><p>explain有两个变种：</p><ul><li><strong>explain extended</strong>：额外提供一些查询优化的信息，并且紧随使用 <code>show warnings</code> 命令可以得到优化后的查询语句。filtered列表示估算出将要和explain中前一个表进行连接的行数、</li><li><strong>explain partitions</strong>：当查询基于分区表会显示查询将访问的分区。</li></ul><h3 id="2-2-返回列"><a href="#2-2-返回列" class="headerlink" title="2.2 返回列"></a>2.2 返回列</h3><h4 id="（1）id"><a href="#（1）id" class="headerlink" title="（1）id"></a>（1）id</h4><p>表示select的序列号，有几个select就有几个id，id顺序即select的出现顺序。</p><ul><li><p>简单查询。</p></li><li><p>复杂查询：</p><ul><li><p>简单子查询：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> actor limit <span class="number">1</span>) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">32</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> SUBQUERY    <span class="operator">|</span> actor <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">PRIMARY</span>  <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+ </span></span><br></pre></td></tr></table></figure></li><li><p>派生表（from语句中的子查询）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> id <span class="keyword">from</span> (<span class="keyword">select</span> id <span class="keyword">from</span> film) <span class="keyword">as</span> der;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>   <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">32</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p>union查询：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type  <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>      <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> <span class="keyword">UNION</span>        <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">UNION</span> <span class="keyword">RESULT</span> <span class="operator">|</span> <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br></pre></td></tr></table></figure><p>union结果总是放在一个匿名临时表中，临时表不在SQL总出现，因此它的id是NULL。</p></li></ul></li></ul><h4 id="（2）select-type"><a href="#（2）select-type" class="headerlink" title="（2）select_type"></a>（2）select_type</h4><p>表示对应行是是简单还是复杂的查询，如果是复杂的查询，又是上述三种复杂查询中的哪一种。</p><ul><li><p><strong>simple</strong>：简单查询，查询不包含子查询和union。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> const <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>primary</strong>：复杂查询中最外层的 select。</p></li><li><p><strong>subquery</strong>：包含在 select 中的子查询（不在 from 子句中）。</p></li><li><p><strong>derived</strong>：包含在 from 子句中的子查询。MySQL会将结果存放在一个临时表中，也称为派生表（derived的英文含义）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> actor <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) der;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived3<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">system</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> SUBQUERY    <span class="operator">|</span> actor      <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+-------------+ </span></span><br></pre></td></tr></table></figure></li><li><p><strong>union</strong>：在 union 中的第二个和随后的 select。</p></li><li><p><strong>union result</strong>：从 union 临时表检索结果的 select</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type  <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>      <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> <span class="keyword">UNION</span>        <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">No</span> tables used  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">UNION</span> <span class="keyword">RESULT</span> <span class="operator">|</span> <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------------+------------+------+---------------+------+---------+------+------+-----------------+</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（3）table"><a href="#（3）table" class="headerlink" title="（3）table"></a>（3）table</h4><p>表示 explain 的一行正在访问哪个表。</p><ul><li>当 from 子句中有子查询时，table列是 <code>&lt;derivenN&gt;</code> 格式，表示当前查询依赖 id=N 的查询，于是先执行 id=N 的查询。</li><li>当有 union 时，UNION RESULT 的 table 列的值为 <code>&lt;union1,2&gt;</code> ，1和2表示参与 union 的 select 行id。</li></ul><h4 id="（4）type"><a href="#（4）type" class="headerlink" title="（4）type"></a>（4）type</h4><p>这一列表示<strong>关联类型</strong>或<strong>访问类型</strong>，即MySQL决定如何查找表中的行。</p><p>从最优到最差分别为：system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</p><ul><li><p><strong>NULL</strong>：mysql能够在优化阶段分解查询语句，在执行阶段用不着再访问表或索引。例如：在索引列中选取最小值，可以单独查找索引来完成，不需要在执行时访问表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">Select</span> tables optimized away <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+------------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>const / system</strong>：mysql能对查询的某部分进行优化并将其转化成一个常量（可以看show warnings 的结果）。用于 primary key 或 unique key 的所有列与常数比较时，所以表最多有一个匹配行，读取1次，速度比较快。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain extended <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>) tmp;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span> <span class="operator">|</span> <span class="keyword">system</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> DERIVED     <span class="operator">|</span> film       <span class="operator">|</span> const  <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+---------+---------+-------+------+----------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> warnings;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Level <span class="operator">|</span> Code <span class="operator">|</span> Message                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Note  <span class="operator">|</span> <span class="number">1003</span> <span class="operator">|</span> <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">AS</span> `id`,<span class="string">&#x27;film1&#x27;</span> <span class="keyword">AS</span> `name` <span class="keyword">from</span> dual <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+---------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>eq_ref</strong>：primary key 或 unique key 索引的所有部分被连接使用 ，最多只会返回一条符合条件的记录。这可能是在 const 之外最好的联接类型了，简单的 select 查询不会出现这种 type。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film_actor <span class="keyword">left</span> <span class="keyword">join</span> film <span class="keyword">on</span> film_actor.film_id <span class="operator">=</span> film.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type   <span class="operator">|</span> possible_keys <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>                     <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> index  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">8</span>       <span class="operator">|</span> <span class="keyword">NULL</span>                    <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> eq_ref <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span>           <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film_actor.film_id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+--------+---------------+-------------------+---------+-------------------------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ref</strong>：相比 <code>eq_ref</code> ，不使用唯一索引，而是使用普通索引或者唯一性索引的部分前缀，索引要和某个值相比较，可能会找到多个符合条件的行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 简单 <span class="keyword">select</span> 查询，name是普通索引（非唯一索引）</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> name <span class="operator">=</span> &quot;film1&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>关联表查询，idx_film_actor_id是film_id和actor_id的联合索引，这里使用到了film_actor的左边前缀film_id部分。</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">left</span> <span class="keyword">join</span> film_actor <span class="keyword">on</span> film.id <span class="operator">=</span> film_actor.film_id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>          <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span> idx_name          <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film.id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ref_or_null</strong>：类似<code>ref</code>，但是可以搜索值为NULL的行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> name <span class="operator">=</span> &quot;film1&quot; <span class="keyword">or</span> name <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type        <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> ref_or_null <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+---------------+----------+---------+-------+------+--------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>index_merge</strong>：表示使用了索引合并的优化方法。 例如下表：id是主键，tenant_id是普通索引。or 的时候没有用 primary key，而是使用了 primary key(id) 和 tenant_id 索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> role <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">11011</span> <span class="keyword">or</span> tenant_id <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type        <span class="operator">|</span> possible_keys         <span class="operator">|</span> key                   <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> role  <span class="operator">|</span> index_merge <span class="operator">|</span> <span class="keyword">PRIMARY</span>,idx_tenant_id <span class="operator">|</span> <span class="keyword">PRIMARY</span>,idx_tenant_id <span class="operator">|</span> <span class="number">4</span>,<span class="number">4</span>     <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>  <span class="number">134</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">union</span>(<span class="keyword">PRIMARY</span>,idx_tenant_id); <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------------+-----------------------+-----------------------+---------+------+------+-------------------------------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>range</strong>：范围扫描通常出现在 in, between ,&gt; ,&lt;, &gt;= 等操作中。使用一个索引来检索给定范围的行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">range</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>index</strong>：和ALL一样，不同就是mysql只需扫描索引树，这通常比ALL快一些。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ALL</strong>：即全表扫描，意味着mysql需要从头到尾去查找所需要的行。通常情况下这需要增加索引来进行优化了。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（5）possible-keys"><a href="#（5）possible-keys" class="headerlink" title="（5）possible_keys"></a>（5）possible_keys</h4><p>这一列显示查询可能使用哪些索引来查找。 </p><ul><li>explain 时可能出现 possible_keys 有列，而 key 显示 NULL 的情况，这种情况是因为表中数据不多，mysql认为索引对此查询帮助不大，选择了全表查询。 </li><li>如果该列是NULL，则没有相关的索引。在这种情况下，可以通过检查 where 子句看是否可以创造一个适当的索引来提高查询性能，然后用 explain 查看效果。</li></ul><h4 id="（6）key"><a href="#（6）key" class="headerlink" title="（6）key"></a>（6）key</h4><p>这一列显示mysql实际采用哪个索引来优化对该表的访问。</p><ul><li>如果没有使用索引，则该列是 NULL。</li><li>如果想强制mysql使用或忽视possible_keys列中的索引，在查询中使用 force index、ignore index。</li></ul><h4 id="（7）key-len"><a href="#（7）key-len" class="headerlink" title="（7）key_len"></a>（7）key_len</h4><p>这一列显示了mysql在索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列。 </p><p>举例来说，film_actor的联合索引 idx_film_actor_id 由 film_id 和 actor_id 两个int列组成，并且每个int是4字节。通过结果中的key_len=4可推断出查询使用了第一个列：film_id列来执行索引查找。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film_actor <span class="keyword">where</span> film_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+</span></span><br></pre></td></tr></table></figure><p>key_len计算规则如下：</p><ul><li>字符串 <ul><li>char(n)：n字节长度</li><li>varchar(n)：2字节存储字符串长度，如果是utf-8，则长度 3n + 2</li></ul></li><li>数值类型 <ul><li>tinyint：1字节</li><li>smallint：2字节</li><li>int：4字节</li><li>bigint：8字节　　</li></ul></li><li>时间类型　 <ul><li>date：3字节</li><li>timestamp：4字节</li><li>datetime：8字节</li></ul></li><li>如果字段允许为 NULL，需要1字节记录是否为 NULL</li></ul><p>索引最大长度是768字节，当字符串过长时，mysql会做一个类似左前缀索引的处理，将前半部分的字符提取出来做索引。</p><h4 id="（8）ref"><a href="#（8）ref" class="headerlink" title="（8）ref"></a>（8）ref</h4><p>这一列显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），func，NULL，字段名（例：film.id）</p><h4 id="（9）rows"><a href="#（9）rows" class="headerlink" title="（9）rows"></a>（9）rows</h4><p>这一列是mysql估计要读取并检测的行数，注意这个不是结果集里的行数。</p><h4 id="（10）Extra"><a href="#（10）Extra" class="headerlink" title="（10）Extra"></a>（10）Extra</h4><p>这一列展示的是额外信息。常见的重要值如下： </p><ul><li><p><strong>distinct</strong>：一旦mysql找到了与行相联合匹配的行，就不再搜索了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> film <span class="keyword">left</span> <span class="keyword">join</span> film_actor <span class="keyword">on</span> film.id <span class="operator">=</span> film_actor.film_id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>      <span class="operator">|</span> type  <span class="operator">|</span> possible_keys     <span class="operator">|</span> key               <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>          <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film       <span class="operator">|</span> index <span class="operator">|</span> idx_name          <span class="operator">|</span> idx_name          <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film_actor <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> idx_film_actor_id <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> test.film.id <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Distinct</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+------------+-------+-------------------+-------------------+---------+--------------+------+------------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Using index</strong>：这发生在对表的请求列都是同一索引的部分的时候，返回的列数据只使用了索引中的信息，而没有再去访问表中的行记录。是性能高的表现。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> id <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">PRIMARY</span> <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+---------+---------+------+------+-------------+ </span></span><br></pre></td></tr></table></figure></li><li><p><strong>Using where</strong>：mysql服务器将在存储引擎检索行后再进行过滤。就是先读取整行数据，再按 where 条件进行检查，符合就留下，不符合就丢弃</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">PRIMARY</span>       <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+--------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Using temporary</strong>：mysql需要创建一张临时表来处理查询。出现这种情况一般是要进行优化的，首先是想到用索引来优化。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> actor.name没有索引，此时创建了张临时表来<span class="keyword">distinct</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> actor;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> temporary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+-----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> film.name建立了idx_name索引，此时查询时extra是<span class="keyword">using</span> index,没有用临时表</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> film;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> idx_name      <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Using filesort</strong>：mysql 会对结果使用一个外部索引排序，而不是按索引次序从表里读取行。此时mysql会根据联接类型浏览所有符合条件的记录，并保存排序关键字和行指针，然后排序关键字并按顺序检索行信息。这种情况下一般也是要考虑使用索引来优化的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> actor.name未创建索引，会浏览actor整个表，保存排序关键字name和对应的id，然后排序name并检索行记录</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> actor <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> actor <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> film.name建立了idx_name索引,此时查询时extra是<span class="keyword">using</span> index</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> film  <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_name <span class="operator">|</span> <span class="number">33</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+-------+---------------+----------+---------+------+------+-------------+</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Using index condition</strong>：表的读取是通过访问索引图元并首先测试它们来确定是否要读取全表的行。通过这种方式，索引信息被用来推迟(“push down”) 读取全表的行，除非有必要。</p><ul><li>详细参考： <a href="https://dev.mysql.com/doc/refman/8.0/en/index-condition-pushdown-optimization.html">Section 8.2.1.6, “Index Condition Pushdown Optimization” </a>。</li><li>存储引擎根据索引尽可能的过滤数据，然后在返回给服务器层根据where其他条件进行过滤。</li><li>假设有联合索引 <code>XXX_index(a, b, c) </code> ，查询的时候 <code>where a=&#39;xxx&#39; and c=1</code> ，没有按顺序与索引字段一直，就导致后面条件c无法命中索引。</li><li>type值为range、 ref、 eq_ref或者ref_or_null的时候 , 会使用到索引条件下推技术。</li></ul></li></ul><p>上述SQL使用到的表和数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `actor`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `actor` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">45</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `actor` (`id`, `name`, `update_time`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>), (<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>), (<span class="number">3</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;2017-12-22 15:27:18&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `film`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `film` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `film` (`id`, `name`) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">&#x27;film0&#x27;</span>),(<span class="number">1</span>,<span class="string">&#x27;film1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;film2&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `film_actor`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `film_actor` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `film_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `actor_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_film_actor_id` (`film_id`,`actor_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `film_actor` (`id`, `film_id`, `actor_id`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 《<a href="https://cloud.tencent.com/developer/article/1648496">Oracle调优之看懂SQL执行计划explain</a>》</p><p>🔗 《<a href="https://blog.csdn.net/p6620582/article/details/74181523">Oracle执行计划详细解读</a>》</p><p>🔗 《<a href="https://www.cnblogs.com/Dreamer-1/p/6076440.html">看懂Oracle执行计划</a>》</p><p>🔗 《<a href="https://blog.csdn.net/u014427391/article/details/89604262">Orace SQL调优系列之执行计划学习笔记</a>》</p><p>🔗 《<a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">MySQL :: MySQL 8.0 Reference Manual :: 8.8.2 EXPLAIN Output Format</a>》</p><p>🔗 《<a href="https://cloud.tencent.com/developer/article/1093229">mysql explain详解》</a></p><p>🔗 《<a href="https://blog.csdn.net/u014427391/article/details/94862797">《收获，不止SQL优化》读书笔记</a>》</p>]]></content>
    
    
    <summary type="html">整理Oracle和MySQL执行计划相关内容，包括：什么是执行计划，如何查看和分析执行计划，访问数据方式，表连接方式等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="updating" scheme="http://linyishui.top/tags/updating/"/>
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>Oracle锁 &lt;转&gt;</title>
    <link href="http://linyishui.top/2021101301.html"/>
    <id>http://linyishui.top/2021101301.html</id>
    <published>2021-10-13T06:16:34.000Z</published>
    <updated>2021-10-15T08:35:06.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Oracle锁"><a href="#Oracle锁" class="headerlink" title="Oracle锁"></a>Oracle锁</h1><h2 id="一-简述"><a href="#一-简述" class="headerlink" title="一. 简述"></a>一. 简述</h2><p>数据库是一个多用户使用的共享资源。当多个用户并发地存取数据时，在数据库中就会产生多个事务同时存取同一数据的情况。若对并发操作不加控制就可能会读取和存储不正确的数据，破坏数据库的一致性。Oracle 利用其锁机制来实现事务间的数据并发访问及数据一致性。</p><p>当事务在对某个数据对象进行操作前，先向系统发出请求，对其加锁。加锁后事务就对该数据对象有了一定的控制，在该事务释放锁之前，其他的事务不能对此数据对象进行更新操作。</p><p>Oracle的锁机制是一种轻量级的锁定机制，不是通过构建锁列表来进行数据的锁定管理，而是<strong>直接将锁作为数据块的属性，存储在数据块首部</strong>。在oracle数据库中，不存在真正意义上属于某个对象或数据的锁。oracle锁的信息是数据块的一个<strong>物理属性</strong>，而不是逻辑上属于某个表或某个行。</p><p>在 Oracle 数据库中，它并不是对某个表加上锁或者某几行加上锁， 锁是以数据块的一个属性存在的。 也就是说， 每个数据块本身就存储着自己数据块中数据的信息，这个地方叫 ITL（Interested Transaction List）， 凡是在这个数据块上有活动的事务，它的信息就会记录在这里面供后续的操作查询，以保证事务的一致性。</p><h2 id="二-锁类别"><a href="#二-锁类别" class="headerlink" title="二. 锁类别"></a>二. 锁类别</h2><h3 id="2-1-自动锁和显示锁"><a href="#2-1-自动锁和显示锁" class="headerlink" title="2.1 自动锁和显示锁"></a>2.1 自动锁和显示锁</h3><p>按用户和系统分可以分为自动锁和显示锁</p><ul><li><p>自动锁（ Automatic Locks）：当进行一项数据库操作时，缺省情况下，系统自动为此数据库操作获得所有有必要的锁。</p><p>分为三种：</p><ul><li>DML 锁</li><li>DDL 锁</li><li>systemlocks</li></ul></li><li><p>显示锁（ Manual Data Locks）：某些情况下，需要用户显示的锁定数据库操作要用到的数据，才能使数据库操作执行得更好，显示锁是用户为数据库对象设定的。</p></li></ul><h3 id="2-2-排它锁和共享锁"><a href="#2-2-排它锁和共享锁" class="headerlink" title="2.2 排它锁和共享锁"></a>2.2 排它锁和共享锁</h3><p>按锁级别分可以分为排它锁和共享锁：</p><ul><li><strong>排他锁（exclusive lock，即X锁）</strong>：事务设置排它锁后，该事务单独获得此资源，另一事务不能在此事务提交之前获得相同对象的共享锁或排它锁。</li><li><strong>共享锁（share lock，即S锁）</strong>：共享锁使一个事务对特定数据库资源进行共享访问——另一事务也可对此资源进行访问或获得相同共享锁。共享锁为事务提供高并发性，但如拙劣的事务设计+共享锁容易造成死锁或数据更新丢失。</li></ul><h3 id="2-3-DML锁、DLL锁和System-Locks"><a href="#2-3-DML锁、DLL锁和System-Locks" class="headerlink" title="2.3 DML锁、DLL锁和System Locks"></a>2.3 DML锁、DLL锁和System Locks</h3><p>按操作分可以分为DML锁、DLL锁和System Locks。</p><h4 id="（1）DML锁"><a href="#（1）DML锁" class="headerlink" title="（1）DML锁"></a>（1）DML锁</h4><p><strong>DML锁：</strong>用于控制并发事务中的数据操纵，保证数据的一致性和完整性，保护并发情况下的数据完整性。DML 语句能够自动地获得所需的表级锁（TM）与行级（事务）锁（TX）。</p><p>又分为：</p><ul><li>TM 锁（表级锁）</li><li>TX 锁（事务锁或行级锁）</li></ul><p>当 Oracle 执行 DML 语句时，系统自动在所要操作的表上申请 TM 类型的锁。当 TM 锁获得后，系统再自动申请 TX 类型的锁，并将实际锁定的数据行的锁标志位进行置位。</p><p>这样在事务加锁前检查 TX锁相容性时就不用再逐行检查锁标志，而只需检查 TM 锁模式的相容性即可，大大提高了系统的效率。</p><p>在数据行上只有 X 锁（排他锁）。</p><p>在 Oracle 数据库中，当一个事务首次发起一个 DML 语句时就获得一个 TX 锁，该锁保持到事务被提交或回滚。当两个或多个会话在表的同一条记录上执行 DML 语句时，第一个会话在该条记录上加锁，其他的会话处于等待状态。当第一个会话提交后， TX 锁被释放，其他会话才可以加锁。</p><p>当 Oracle 数据库发生 TX 锁等待时，如果不及时处理常常会引起 Oracle 数据库挂起，或导致死锁的发生，产生ORA-600 的错误。这些现象都会对实际应用产生极大的危害，如长时间未响应，大量事务失败等。</p><p>DML 锁有如下三种加锁方式：</p><ul><li>共享锁方式（ SHARE）</li><li>独占锁方式（ EXCLUSIVE）</li><li>共享更新锁（ SHARE UPDATE）  其中：  SHARE， EXCLUSIVE 用于 TM 锁（表级锁）  SHARE UPDATE 用于 TX 锁（ 行级锁）</li></ul><h5 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h5><p><strong>TM 锁（表级锁）：</strong>TM 锁用于确保在修改表的内容时，表的结构不会改变，例如防止在 DML 语句执行期间相关的表被移除。当用户对表执行 DDL 或 DML 操作时，将获取一个此表的表级锁。</p><p>当事务获得行锁后，此事务也将自动获得该行的表锁(共享锁),以防止其它事务进行 DDL 语句影响记录行的更新。</p><p>事务也可以在进行过程中获得共享锁或排它锁，只有当事务显示使用 LOCK TABLE 语句显示的定义一个排它锁时，事务才会获得表上的排它锁,也可使用 LOCK TABLE 显示的定义一个表级的共享锁。</p><p>TM 锁包括了 SS、 SX、 S、 X 等多种模式，在数据库中用 0－6 来表示。不同的 SQL 操作产生不同类型的 TM 锁.</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010101.png"></p><h5 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h5><p><strong>TX 锁（事务锁或行级锁）：</strong></p><p>当事务执行数据库插入、更新、删除操作时，该事务自动获得操作表中操作行的排它锁。</p><p>事务发起第一个修改时会得到TX 锁（事务锁），而且会一直持有这个锁，直至事务执行提交（COMMIT）或回滚（ROLLBACK）。</p><p>对用户的数据操纵， Oracle 可以自动为操纵的数据进行加锁，但如果有操纵授权，则为满足并发操纵的需要另外实施加锁。</p><p>DML 锁可由一个用户进程以显式的方式加锁，也可通过某些 SQL 语句隐含方式实现。 这部分属于 Manual Data Locks。</p><p>原理：一个事务要修改块中的数据，必须获得该块中的一个itl，通过 itl 和 undo  segment header 中的 transaction table，可以知道事务是否处于活动阶段。事务在修改块时（其实就是在修改行）会检查行中 row header 中的标志位，如果该标志位为0（该行没有被活动的事务锁住），就把该标志位修改为事务在该块获得的itl的序号，这样当前事务就获得了对记录的锁定，然后就可以修改行数据了，这也就是 oracle 行锁实现的原理。</p><h5 id="共享方式的表级锁（-Share）"><a href="#共享方式的表级锁（-Share）" class="headerlink" title="共享方式的表级锁（ Share）"></a><strong>共享方式的表级锁（ Share）</strong></h5><p>共享方式的表级锁是对表中的所有数据进行加锁，该锁用于保护查询数据的一致性，防止其它用户对已加锁的表进行更新。</p><p>其它用户只能对该表再施加共享方式的锁，而不能再对该表施加独占方式的锁，共享更新锁可以再施加，但不允许持有共享更新封锁的进程做更新。</p><p>共享该表的所有用户只能查询表中的数据，但不能更新。</p><p>共享方式的表级锁只能由用户用 SQL 语句来设置.</p><p>语句格式如下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLE &lt;表名&gt;[,&lt;表名&gt;]... IN SHARE MODE [NOWAIT]</span><br></pre></td></tr></table></figure><p>执行该语句，对一个或多个表施加共享方式的表封锁。</p><p>当指定了选择项NOWAIT，若该锁暂时不能施加成功，则返回并由用户决定是进行等待，还是先去执行别的语句。</p><p>持有共享锁的事务，在出现如下之一的条件时，便释放其共享锁：</p><ul><li>A、执行 COMMIT 或 ROLLBACK 语句。</li><li>B、退出数据库（ LOG OFF）。</li><li>C、程序停止运行。</li></ul><p>共享方式表级锁常用于一致性查询过程，即在查询数据期间表中的数据不发生改变。</p><h5 id="独占方式表级锁（-Exclusive）"><a href="#独占方式表级锁（-Exclusive）" class="headerlink" title="独占方式表级锁（ Exclusive）"></a><strong>独占方式表级锁（ Exclusive）</strong></h5><p>独占方式表级锁是用于加锁表中的所有数据，拥有该独占方式表封锁的用户，即可以查询该表，又可以更新该表，其它的用户不能再对该表施加任何加锁（包括共享、独占或共享更新封锁）。</p><p>其它用户虽然不能更新该表，但可以查询该表。</p><p>独占方式的表封锁可通过如下的 SQL 语句来显示地获得：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK <span class="keyword">TABLE</span> <span class="operator">&lt;</span>表名<span class="operator">&gt;</span>[,<span class="operator">&lt;</span>表名<span class="operator">&gt;</span>].... <span class="keyword">IN</span> EXCLUSIVE MODE [NOWAIT]</span><br></pre></td></tr></table></figure><p>独占方式的表级锁也可以在用户执行 DML 语句 INSERT、UPDATE、DELETE时隐含获得。</p><p>拥有独占方式表封锁的事务，在出现如下条件之一时，便释放该封锁：</p><ul><li>（ 1）执行 COMMIT 或 ROLLBACK 语句。</li><li>（ 2）退出数据库（ LOG OFF）</li><li>（ 3）程序停止运行。</li></ul><p>独占方式封锁通常用于更新数据，当某个更新事务涉及多个表时，可减少发生死锁.</p><h5 id="共享更新加锁方式（-Share-Update）"><a href="#共享更新加锁方式（-Share-Update）" class="headerlink" title="共享更新加锁方式（ Share Update）"></a><strong>共享更新加锁方式（ Share Update）</strong></h5><p>共享更新加锁是对一个表的一行或多行进行加锁，因而也称作行级加锁。表级加锁虽然保证了数据的一致性，但却减弱了操作数据的并行性。</p><p>行级加锁确保在用户取得被更新的行到该行进行更新这段时间内不被其它用户所修改。  因而行级锁即可保证数据的一致性又能提高数据操作的迸发性。</p><p>可通过如下的两种方式来获得行级封锁：  （ 1）、执行如下的 SQL 封锁语句，以显示的方式获得：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK <span class="keyword">TABLE</span> <span class="operator">&lt;</span> 表 名 <span class="operator">&gt;</span>[,<span class="operator">&lt;</span> 表 名 <span class="operator">&gt;</span>].... <span class="keyword">IN</span> SHARE UPDATE MODE[NOWAIT]</span><br></pre></td></tr></table></figure><p>（ 2）、用如下的 SELECT …FOR UPDATE 语句获得：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &lt;列名 &gt;[,&lt;列名 &gt;]...FROM &lt;表名 &gt; WHERE &lt;条件 &gt; FORUPDATE OF &lt;列名&gt;[,&lt;列名&gt;].....[NOWAIT]</span><br></pre></td></tr></table></figure><p>一旦用户对某个行施加了行级加锁，则该用户可以查询也可以更新被加锁的数据行，其它用户只能查询但不能更新被加锁的数据行．</p><p>如果其它用户想更新该表中的数据行，则也必须对该表施加行级锁．即使多个用户对一个表均使用了共享更新，但也不允许两个事务同时对一个表进行更新，真正对表进行更新时，是以独占方式锁表，一直到提交或复原该事务为止。</p><p>行锁永远是独占方式锁。</p><p>当出现如下之一的条件，便释放共享更新锁：</p><ul><li>（ 1）执行提交（ COMMIT）语句；</li><li>（ 2）退出数据库（ LOG OFF）</li><li>（ 3）程序停止运行。</li></ul><p>执行 ROLLBACK 操作不能释放行锁。</p><h4 id="（2）DLL锁（dictionary-locks）"><a href="#（2）DLL锁（dictionary-locks）" class="headerlink" title="（2）DLL锁（dictionary locks）"></a>（2）DLL锁（dictionary locks）</h4><p>DDL 锁用于保护数据库对象的结构，如表、索引等的结构定义。</p><p>DDL 锁又可以分为：</p><ul><li>排它 DDL 锁</li><li>共享 DDL 锁</li><li>分析锁</li></ul><h5 id="排它-DDL-锁"><a href="#排它-DDL-锁" class="headerlink" title="排它 DDL 锁"></a>排它 DDL 锁</h5><p>创建、修改、删除一个数据库对象的 DDL 语句获得操作对象的 排它锁。</p><p>如使用 alter table 语句时，为了维护数据的完成性、一致性、合法性，该事务获得一排它 DDL 锁。</p><h5 id="共享-DDL-锁"><a href="#共享-DDL-锁" class="headerlink" title="共享 DDL 锁"></a>共享 DDL 锁</h5><p>需在数据库对象之间建立相互依赖关系的 DDL 语句通常需共享获得 DDL锁。</p><p>如创建一个包，该包中的过程与函数引用了不同的数据库表，当编译此包时该事务就获得了引用表的共享 DDL 锁。</p><h5 id="分析锁"><a href="#分析锁" class="headerlink" title="分析锁"></a>分析锁</h5><p>ORACLE 使用共享池存储分析与优化过的 SQL 语句及 PL/SQL 程序，使运行相同语句的应用速度更快。</p><p>一个在共享池中缓存的对象获得它所引用数据库对象的分析锁。</p><p>分析锁是一种独特的 DDL 锁类型， ORACLE 使用它追踪共享池对象及它所引用数据库对象之间的依赖关系。</p><p>当一个事务修改或删除了共享池持有分析锁的数据库对象时， ORACLE 使共享池中的对象作废，下次在引用这条SQL/PLSQL 语 句时， ORACLE 重新分析编译此语句。</p><p>DDL 级加锁也是由 ORACLE RDBMS 来控制，它用于保护数据字典和数据定义改变时的一致性和完整性。 它是系统在对 SQL 定义语句作语法分析时自动地加锁，无需用户干予。</p><p>字典/语法分析加锁共分三类：</p><ul><li>（ 1）字典操作锁：  用于对字典操作时，锁住数据字典，此封锁是独占的，从而保护任何一个时刻仅能对一个字典操作。</li><li>（ 2） 字典定义锁：  用于防止在进行字典操作时又进行语法分析，这样可以避免在查询字典的同时改动某个表的结构。</li><li>（ 3）表定义锁：  用于一个 SQL 语句正当访问某个表时，防止字典中与该表有关的项目被修改。</li></ul><h5 id="悲观封锁"><a href="#悲观封锁" class="headerlink" title="悲观封锁"></a>悲观封锁</h5><p>锁在用户修改之前就发挥作用：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> .. <span class="keyword">for</span> update [nowait] <span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">from</span> tab1 <span class="keyword">for</span> update </span><br></pre></td></tr></table></figure><p>用户发出这条命令之后，oracle将会对返回集中的数据建立行级封锁，以防止其他用户的修改。</p><p>如果此时其他用户对上面返回结果集的数据进行dml或ddl操作都会返回一个错误信息或发生阻塞。</p><ul><li>1：对返回结果集进行update或delete操作会发生阻塞。 左下角的时间执行了很久。 </li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-3489346/a151h62mmr.gif" alt="img"></p><ul><li>2：对该表进行ddl操作将会报： Ora-00054:resource busy and acquire with nowait specified.</li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-3489346/iocr2chkp6.png?imageView2/2/w/1620" alt="img"></p><p>原因分析 ：  此时Oracle已经对返回的结果集上加了排它的行级锁，所有其他对这些数据进行的修改或删除操作都必须等待这个锁的释放，产生的外在现象就是其他的操作将发生阻塞，这个这个操作commit或rollback.</p><p>同样这个查询的事务将会对该表加表级锁，不允许对该表的任何ddl操作，否则将会报出ora-00054错误：:resource busy and acquire with nowait specified.</p><p>悲观的缺陷是，加锁的时间可能会很长，这样可能会长时间的限制其他用户的访问，也就是说悲观锁的并 发访问性不好.</p><p>会话A：</p><p>在这里新开一个plsql窗口模拟会话A</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--建表create table xgj (name varchar2(20));--新增数据insert into xgj values(&#x27;xiaogongjiang&#x27;);--提交数据commit ;--使用for update方式获取排他行级锁select * from xgj where name=&#x27;xiaogongjiang&#x27; for update ;</span></span><br></pre></td></tr></table></figure><p>会话B：</p><p>在这里是在plsql中另外新开了一个窗口模拟会话B，不能在同一个会话窗口，否则测试不出来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> xgj <span class="keyword">add</span>(salary  number(<span class="number">5</span>));</span><br></pre></td></tr></table></figure><p>注意看左下角的时间，会看到已经执行时间了很长时间，如果会话A不提交则会一直等待，A提交后，马上执行成功。 </p><p><img src="https://ask.qcloudimg.com/http-save/yehe-3489346/y3likjg8r8.gif" alt="img"></p><h5 id="乐观封锁"><a href="#乐观封锁" class="headerlink" title="乐观封锁"></a>乐观封锁</h5><p>乐观的认为数据在select出来到update数据并提交的这段时间数据不会被更改。乐观锁多个会话可以同时操作数据。这里面有一种潜在的危险就是由于被选出的结果集并没有被锁定，是存在一种可能被其他用户更改的可能。因此Oracle仍然建议是用悲观封锁，因为这样会更安全。</p><p>比较常见的方式使用版本列来，每次更新时都和旧版本的数据比较。</p><h4 id="（3）System-Locks"><a href="#（3）System-Locks" class="headerlink" title="（3）System Locks"></a>（3）System Locks</h4><p>oracle使用不同类型的系统锁来保护内部数据库和内存结构。</p><p>这些机制是用户无法访问的。</p><h2 id="三-死锁"><a href="#三-死锁" class="headerlink" title="三. 死锁"></a>三. 死锁</h2><p>当两个用户希望持有对方的资源时就会发生死锁。</p><p>即两个用户互相等待对方释放资源时，oracle认定为产生了死锁,在这种情况下,将以牺牲一个用户作为代价,另一个用户继续执行,牺牲的用户的事务将回滚。</p><h3 id="3-1-场景"><a href="#3-1-场景" class="headerlink" title="3.1 场景"></a>3.1 场景</h3><p>1：用户 1 对 A 表进行 Update，没有提交。  2：用户 2 对 B 表进行 Update，没有提交。</p><p>此时双反不存在资源共享的问题。</p><p>3：如果用户 2 此时对 A 表作 update,则会发生阻塞，需要等到用户一的事物结束。  4：如果此时用户 1 又对 B 表作 update，则产生死锁。此时 Oracle 会选择其中一个用户进行会滚，使另一个用户继续执行操作。</p><h3 id="3-2-起因分析"><a href="#3-2-起因分析" class="headerlink" title="3.2 起因分析"></a>3.2 起因分析</h3><p>Oracle 的死锁问题实际上很少见，如果发生，基本上都是不正确的程序设计造成的，经过调整后，基本上都会避免死锁的发生。</p><p>在 Oracle 系统中能自动发现死锁，并选择代价最小的，即完成工作量最少的事务予以撤消，释放该事务所拥有的全部锁，记其它的事务继续工作下去。</p><p>从系统性能上考虑，应该尽可能减少资源竞争，增大吞吐量，因此用户在给并发操作加锁时，应注意以下几点：</p><ul><li>1、 对于 UPDATE 和 DELETE 操作，应只锁要做改动的行，在完成修改后立即提交。</li><li>2、 当多个事务正利用共享更新的方式进行更新，则不要使用共享封锁，而应采用共享更新锁，这样其它用户就能使用行级锁，以增加并行性。</li><li>3、 尽可能将对一个表的操作的并发事务施加共享更新锁，从而可提高并行性。</li><li>4、 在应用负荷较高的期间，不宜对基础数据结构（表、索引、簇和视图）进行修改</li></ul><h3 id="3-3-死锁后的解决办法"><a href="#3-3-死锁后的解决办法" class="headerlink" title="3.3 死锁后的解决办法"></a>3.3 死锁后的解决办法</h3><p>死锁不能自动释放，需要手动杀死会话。</p><p>1.查看有无死锁对象。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;alter system kill session &#x27;&#x27;&#x27;</span> <span class="operator">||</span> sid <span class="operator">||</span> <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> serial# <span class="operator">||</span> <span class="string">&#x27;&#x27;&#x27;;&#x27;</span> &quot;Deadlock&quot;  <span class="keyword">FROM</span> v$session <span class="keyword">WHERE</span> sid <span class="keyword">IN</span> (<span class="keyword">SELECT</span> sid <span class="keyword">FROM</span> v$lock <span class="keyword">WHERE</span> block <span class="operator">=</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>2.手动杀死会话。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> kill session <span class="string">&#x27;646,3953&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010102.png"></p><p>查看导致死锁的 SQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s.sid, q.sql_textFROM v$sqltext q, v$session sWHERE q.address <span class="operator">=</span> s.sql_address <span class="keyword">AND</span> s.sid <span class="operator">=</span> <span class="operator">&amp;</span>sid</span><br></pre></td></tr></table></figure><p>执行后，输入对应的sid即可查看对应的sql。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010103.png"></p><p>如果上述找不到对应的sql，可以先执行查看谁锁了谁（2）的sql，查到另外一个sid，根据另外一个sid，会查到对应的sql：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s1.username<span class="operator">||</span> <span class="string">&#x27;@&#x27;</span><span class="operator">||</span> s1.machine<span class="operator">||</span> <span class="string">&#x27; ( SID=&#x27;</span><span class="operator">||</span> s1.sid<span class="operator">||</span> <span class="string">&#x27; ) is blocking &#x27;</span><span class="operator">||</span> s2.username<span class="operator">||</span> <span class="string">&#x27;@&#x27;</span><span class="operator">||</span> s2.machine<span class="operator">||</span> <span class="string">&#x27; ( SID=&#x27;</span><span class="operator">||</span> s2.sid<span class="operator">||</span> <span class="string">&#x27; ) &#x27;</span><span class="keyword">AS</span> blocking_statusFROM v$lock l1,v$session s1,v$lock l2,v$session s2WHERE s1.sid <span class="operator">=</span> l1.sidAND s2.sid <span class="operator">=</span> l2.sidAND l1.BLOCK <span class="operator">=</span> <span class="number">1</span><span class="keyword">AND</span> l2.request <span class="operator">&gt;</span> <span class="number">0</span><span class="keyword">AND</span> l1.id1 <span class="operator">=</span> l2.id1AND l2.id2 <span class="operator">=</span> l2.id2;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010104.png"></p><p>或者</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LPAD (<span class="string">&#x27; &#x27;</span>, DECODE (l.xidusn, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>))<span class="operator">||</span> l.oracle_usernameUser_name,o.owner,o.object_name,o.object_type,s.sid,s.serial#<span class="keyword">FROM</span> v$locked_object l, dba_objects o, v$session sWHERE l.object_id <span class="operator">=</span> o.object_id <span class="keyword">AND</span> l.session_id <span class="operator">=</span> s.sidORDER <span class="keyword">BY</span> o.object_id, xidusn <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010105.png"></p><h2 id="四-锁和阻塞"><a href="#四-锁和阻塞" class="headerlink" title="四. 锁和阻塞"></a>四. 锁和阻塞</h2><h3 id="4-1-概念"><a href="#4-1-概念" class="headerlink" title="4.1 概念"></a>4.1 概念</h3><p>通常来讲，系统如果平时运行正常，突然会停止不动，多半是被阻塞（Blocked）住了。 我们可以通过 v$lock 这张视图，看查看阻塞的信息。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> v$lockName Type   Nullable <span class="keyword">Default</span> Comments <span class="comment">------- ----------- -------- ------- -------- ADDR RAW(8) Y                        KADDR RAW(8) Y                        SID  NUMBER Y                        TYPE VARCHAR2(2) Y                        ID1  NUMBER Y                        ID2  NUMBER Y                        LMODE NUMBER Y                        REQUEST NUMBER Y                        CTIME NUMBER Y                        BLOCK NUMBER Y                        SQL&gt; </span></span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010106.png"></p><p>我们关注的比较多的是 request 和 block 字段。  如果某个 request 列是一个非 0 值，那么它就是在等待一个锁。 如果 block 列是1，这个 SID 就持有了一个锁，并且阻塞别人获得这个锁。</p><p>这个锁的类型由 TYPE字段定义。锁的模式有 LMODE 字段定义， ID1 和 ID2 字段定义了这个锁的相关信息。</p><p>ID1 相同，就代表指向同一个资源。 这样就有可能有加锁者和等待者。</p><p>LMODE 的 6 中模式参考上面的 TM 锁类型表。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010107.png"></p><p>可以结合 <code>v$lock</code> 和 <code>v$session</code> 视图来查询相关的信息：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sn.username,       m.SID,       sn.SERIAL#,       m.TYPE,       DECODE(m.lmode,              <span class="number">0</span>,              <span class="string">&#x27;None&#x27;</span>,              <span class="number">1</span>,              <span class="string">&#x27;Null&#x27;</span>,              <span class="number">2</span>,              <span class="string">&#x27;Row Share&#x27;</span>,              <span class="number">3</span>,              <span class="string">&#x27;Row Excl.&#x27;</span>,              <span class="number">4</span>,              <span class="string">&#x27;Share&#x27;</span>,              <span class="number">5</span>,              <span class="string">&#x27;S/Row Excl.&#x27;</span>,              <span class="number">6</span>,              <span class="string">&#x27;Exclusive&#x27;</span>,              lmode,              LTRIM(TO_CHAR(lmode, <span class="string">&#x27;990&#x27;</span>))) lmode,       DECODE(m.request,              <span class="number">0</span>,              <span class="string">&#x27;None&#x27;</span>,              <span class="number">1</span>,              <span class="string">&#x27;Null&#x27;</span>,              <span class="number">2</span>,              <span class="string">&#x27;Row Share&#x27;</span>,              <span class="number">3</span>,              <span class="string">&#x27;Row Excl.&#x27;</span>,              <span class="number">4</span>,              <span class="string">&#x27;Share&#x27;</span>,              <span class="number">5</span>,              <span class="string">&#x27;S/Row Excl.&#x27;</span>,              <span class="number">6</span>,              <span class="string">&#x27;Exclusive&#x27;</span>,              request,              LTRIM(TO_CHAR(m.request, <span class="string">&#x27;990&#x27;</span>))) request,       m.id1,       m.id2  <span class="keyword">FROM</span> v$session sn, v$lock m <span class="keyword">WHERE</span> (sn.SID <span class="operator">=</span> m.SID <span class="keyword">AND</span> m.request <span class="operator">!=</span> <span class="number">0</span>)      <span class="comment">--存在锁请求，即被阻塞    OR (sn.SID = m.SID       --不存在锁请求，但是锁定的对象被其他会话请求锁定       AND m.request = 0 AND lmode != 4 AND       (id1, id2) IN (SELECT s.id1, s.id2                         FROM v$lock s                        WHERE request != 0                          AND s.id1 = m.id1                          AND s.id2 = m.id2)) ORDER BY id1, id2, m.request;</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ rule */</span> s.username, DECODE(l.TYPE, <span class="string">&#x27;TM&#x27;</span>, <span class="string">&#x27;TABLE LOCK&#x27;</span>, <span class="string">&#x27;TX&#x27;</span>, <span class="string">&#x27;ROW LOCK&#x27;</span>, <span class="keyword">NULL</span>) lock_level, o.owner, o.object_name, o.object_type, s.sid, s.serial#, s.terminal, s.machine, s.program, s.osuser  <span class="keyword">FROM</span> v$session s, v$lock l, dba_objects o <span class="keyword">WHERE</span> l.sid <span class="operator">=</span> s.sid   <span class="keyword">AND</span> l.id1 <span class="operator">=</span> o.object_id(<span class="operator">+</span>)   <span class="keyword">AND</span> s.username <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure><h3 id="4-2-引起阻塞的几种常见情况"><a href="#4-2-引起阻塞的几种常见情况" class="headerlink" title="4.2 引起阻塞的几种常见情况"></a>4.2 引起阻塞的几种常见情况</h3><h4 id="4-2-1-DML-语句引起阻塞"><a href="#4-2-1-DML-语句引起阻塞" class="headerlink" title="4.2.1 DML 语句引起阻塞"></a>4.2.1 DML 语句引起阻塞</h4><p>当一个会话保持另一个会话正在请求的资源上的锁定时，就会发生阻塞。被阻塞的会话将一直挂起，直到持有锁的会话放弃锁定的资源为止。</p><p>4 个常见的 dml 语句会产生阻塞:</p><ul><li><p><strong>INSERT</strong>：唯一情况就是用户拥有一个建有主键约束的表。当 2 个会话同时试图向表中插入相同的数据时，其中的一个会话将被阻塞，直到另外一个会话提交或会滚。一个会话提交时，另一个会话将收到主键重复的错误。回滚时，被阻塞的会话将继续执行。</p></li><li><p><strong>UPDATE</strong>：当执行 Update 和 delete 操作的数据行已经被另外的会话锁定时，将会发生阻塞，直到另一个会话提交或会滚。</p></li><li><p><strong>DELETE</strong>：同UPDATE。</p></li><li><p><strong>SELECT … FOR UPDATE</strong>：</p><p>当一个用户执行 select..for update 对返回的结果集进行修改时，如  果结果集已经被另一个会话锁定，此时 Oracle 已经对返回的结果集上加了排它的行级锁， 所有其他对这些数据进行的修改或删除操作都必须等待这个锁的释放(操作 commit 或 rollback.)，产生的外在现象就是其他的操作将发生阻塞。</p><p>同样这个查询的事务将会对该表加表级锁，不允许对该表的任何 ddl 操作，否则将会报出 <code>Ora-00054:resource busy and acquire with nowait specified.</code> 。</p><p>可以通过发出 <code>select ... for update nowait</code> 的语句来避免发生阻塞，如果资源已经被另一个会话锁定，则会返回以下错误：<code>Ora-00054:resource busy and acquire with nowait specified.</code> 。</p></li></ul><h4 id="4-2-2-外键没有创建索引"><a href="#4-2-2-外键没有创建索引" class="headerlink" title="4.2.2 外键没有创建索引"></a>4.2.2 外键没有创建索引</h4><p>如果系统中有主，外键引用关系，并且满足一下三个条件中的任意一个，那么就应该考虑给外键字段创建索引，否则系统的性能可能会下降甚至阻塞。</p><ul><li>主表上有频繁的删除操作。</li><li>主键上有频繁的修改操作。</li><li>业务上经常会出现主表和从表做关联查询的情况。</li></ul><p>第一和第二个条件操作的时候，主表会在从表上创建一个锁定，以保证主表主键的修改不会导致从表的数据在引用上出现问题，这是一个数据引用完整性的要求。</p><p>如果主表上经常出现这样的删除或者是对主键列进行修改的操作，或者每次操作的记录数很多，都将会造成从表长时间被锁定，而影响其他用户的正常操作。</p><p>比如主表每次删除 1000 行数据，它就需要扫描从表 1000 次，以确定每一行记录的改变都不会造成从表数据在引用上的不完整。</p><p>特别是在 OLAP 系统中，从表经常会是非常巨大的表，在这种情况下，如果从表没有索引，那么查询几乎是不可想象的。</p><h2 id="五-Latch"><a href="#五-Latch" class="headerlink" title="五. Latch"></a>五. Latch</h2><h3 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h3><ul><li>Latch属于 System Lock, 用于保护 SGA区中共享数据结构的一种串行化锁定机制。</li><li>Latch 的实现是与操作系统相关的，尤其和一个进程是否需要等待一个latch、需要等待多长时间有关。</li><li>Latch 是 Oracle 提供的轻量级锁资源， 是一种能够极快地被获取和释放的锁，能快速，短时间的锁定资源。</li><li>Latch用于防止多个并发进程同时修改访问某个共享资源， 它只工作在 SGA 中， 通常用于保护描述 buffer cache 中 block 的数据结构。</li></ul><p>比如 SGA 中，各种数据被反复从磁盘读取到内存，又被重新写回到磁盘上，如果有并发的用户做相同的事情， Oracle 必须使用一种机制，来保证数据在读取的时候，只能由一个会话来完成，这种保护机制就是 Latch。</p><ul><li>并发（ concurrency）： 是说有超过两个以上的用户对同样的数据做修改（可能包括插入，删除和修改）。</li><li>并行（ parallel）： 是说将一件事情分成很多小部分，让每一部分同时执行，最后将执行结果汇总成最终结果。</li></ul><p>与每个 latch 相联系的还有一个清除过程，当持有 latch 的进程成为死进程时，该清除过程就会被调用。</p><p>Latch 还具有相关级别，用于防止死锁，一旦一个进程在某个级别上得到一个 latch，它就不可能再获得等同或低于该级别的 latch。</p><p>Latch 不会造成阻塞，只会导致等待。 阻塞是一种系统设计上的问题，等待是一种系统资源争用的问题。</p><h3 id="5-2-spin"><a href="#5-2-spin" class="headerlink" title="5.2 spin"></a>5.2 spin</h3><p>比如数据缓存中的某个块要被读取，我们会获得这个块的 latch， 这个过程叫做 spin，另外一个进程恰好要修改这个块，他也要 spin 这个块，此时他必须等待，当前一个进程释放 latch 后才能 spin 住，然后修改， 如果多个进程同时请求的话，他们之间将出现竞争，没有一个入队机制，一旦前面进程释放所定，后面的进程就蜂拥而上，没有先来后到的概念， 并且这一切都发生的非常快，因为Latch 的特点是快而短暂。</p><p>SPIN 与休眠（ sleep）  Oracle 选择了 spin，让进程继续占有 CPU，运行一些空指令，之后继续请求，继续 spin，直到达到_spin_count 值，这时会放弃 CPU，进行短暂的休眠，再继续刚才的动作。</p><p>进程休眠的时间也是存在算法的.休眠的阀值限制由隐含参数_max_exponential_sleep控制， 默认是 2 秒。</p><p>如果当前进程已经占用了别的 Latch，则他的休眠时间不会太长(过长会引起别的进程的 Latch 等待)，此时的休眠最大时间有隐含参数_max_sleep_holding_latch 决定， 默认是 4 厘秒。</p><p>总之，Latch 获取的流程： 请求-SPIN-休眠-请求-SPIN-休眠 … … 占用。</p><h3 id="5-3-Latch-和-Lock"><a href="#5-3-Latch-和-Lock" class="headerlink" title="5.3 Latch 和 Lock"></a>5.3 Latch 和 Lock</h3><p>从某种意义上说， Latch 是内存中的资源锁，数据库对象(表，索引等)的锁叫Lock。</p><p>Latch 和 Lock 的区别:</p><ul><li>Latch 是对内存数据结构提供互斥访问的一种机制，而 Lock 是以不同的模式来套取共享资源对象，各个模式间存在着兼容或排斥，从这点看出， Latch的访问，包括查询也是互斥的，任何时候，只能有一个进程能 spin 住内存的某一块，幸好这个过程是相当的短暂，否则系统性能将没的保障，从 9I 开始，允许多个进程同时查询相同的内存块。</li><li>Latch 只作用于内存中，他只能被当前实例访问，而 Lock 作用于数据库对象，在 RAC 体系中实例间允许 Lock 检测与访问</li><li>Latch 是瞬间的占用，释放， Lock 的释放需要等到事务正确的结束，他占用的时间长短由事务大小决定</li><li>Latch 是非入队的，而 Lock 是入队的</li><li>Latch 不存在死锁，而 Lock 中存在。</li></ul><h3 id="5-4-Latch-争用"><a href="#5-4-Latch-争用" class="headerlink" title="5.4 Latch 争用"></a>5.4 Latch 争用</h3><p>如果发现系统中经常由于 Lock 导致用户等待，这时需要考虑系统在逻辑设计上是否有问题，比如多用户对主键的删除或者修改，是否有用户使用 select … for update 这样的语法，外键是否创建索引的因素。 这些因素是需要结合系统的业务逻辑性来进行数据库对象设计的。</p><p>如果发现系统慢是因为很多的 Latch 争用，就要考虑系统及数据库自身设计上是否存在问题，比如是否使用绑定变量，是否存在热快，数据存储参数设计是否合理等因素。  导致 Latch 争用而等待的原因非常多，内存中很多资源都可能存在争用。</p><p>最常见的两类 latch 争用如下：</p><ol><li>共享池中的 Latch 争用。 </li><li>数据缓冲池中的 latch 争用。</li></ol><h4 id="（1）共享池中的-Latch-争用"><a href="#（1）共享池中的-Latch-争用" class="headerlink" title="（1）共享池中的 Latch 争用"></a>（1）共享池中的 Latch 争用</h4><p>共享池中如果存在大量的 SQL 被反复分析，就会造成很大的 Latch 争用和长时间的等待， 最常见的现象就是没有绑定变量。</p><p><strong>最常见的集中共享池里的 Latch 是 library cache。</strong></p><p>可以通过一下 SQL 来查询：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$latchname <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;library cache%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010108.png"></p><p>在分析系统性能时，如果看到有 library cache 这样的 Latch 争用，就可以断定是共享池中出现了问题，这种问题基本是由 SQL 语句导致的，比如没有绑定变量 或者一些存储过程被反复分析。</p><p><strong>资源的争用可以通过如下 SQL 来查看</strong>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> event,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> v$session_wait <span class="keyword">group</span> <span class="keyword">by</span> event;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010109.png"></p><h4 id="（2）数据缓冲池中的-latch-争用"><a href="#（2）数据缓冲池中的-latch-争用" class="headerlink" title="（2）数据缓冲池中的 latch 争用"></a>（2）数据缓冲池中的 latch 争用</h4><p>访问频率非常高的数据块被称为热快（ Hot Block），当很多用户一起去访问某几个数据块时，就会导致一些 Latch 争用。</p><p>最常见的 latch 争用有：</p><ul><li> buffer busy waits</li><li> cache buffer chain</li></ul><p>这两个 Latch 的争用分别发生在访问数据块的不同时刻。</p><p>产生这些 Latch 争用的直接原因是太多的会话去访问相同的数据块导致热快问题， 造成热快的原因可能是数据库设置导致或者重复执行的 SQL 频繁访问一些相同的数据块导致。</p><hr><p>参考：</p><p>🔗 《<a href="https://cloud.tencent.com/developer/article/1451003">Oracle数据库各种”锁”</a>》</p>]]></content>
    
    
    <summary type="html">内容包括：简述，锁类别（自动锁和显示锁、排他锁和共享锁、DML锁、DLL锁和System Locks），死锁，锁和阻塞，Latch。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="lock" scheme="http://linyishui.top/tags/lock/"/>
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>Spring AMQP</title>
    <link href="http://linyishui.top/2021092601.html"/>
    <id>http://linyishui.top/2021092601.html</id>
    <published>2021-09-26T06:22:55.000Z</published>
    <updated>2021-11-04T11:49:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-AMQP"><a href="#Spring-AMQP" class="headerlink" title="Spring AMQP"></a>Spring AMQP</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><h3 id="1-1-什么是Spring-AMQP"><a href="#1-1-什么是Spring-AMQP" class="headerlink" title="1.1 什么是Spring AMQP"></a>1.1 什么是Spring AMQP</h3><p>Advanced Message Queuing Protocol，即高级消息队列协议，旨在提供一种跨平台跨语言的消息服务，AMQP是一种应用层协议，不同于JMS(API接口)，使用 TCP 提供可靠投递的应用层协议。</p><p>Spring AMQP则是Spring方便开发RabbitMQ程序集成的一个第三方类库。</p><ul><li>提供“模板”作为用于发送和接收消息的高级抽象。</li><li>还为消息驱动的 POJO 提供支持。</li></ul><h3 id="1-2-简单使用"><a href="#1-2-简单使用" class="headerlink" title="1.2 简单使用"></a>1.2 简单使用</h3><h4 id="（1）Maven依赖"><a href="#（1）Maven依赖" class="headerlink" title="（1）Maven依赖"></a>（1）Maven依赖</h4><p>引入Maven依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此包同时包含：</p><ul><li>spring-context</li><li>spring-tx</li><li>spring-web</li><li>spring-messaging</li><li>spring-retry</li><li>spring-amqp</li><li>amqp-client</li></ul><h4 id="（2）快速上手"><a href="#（2）快速上手" class="headerlink" title="（2）快速上手"></a>（2）快速上手</h4><p>基于默认配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">AmqpAdmin admin = <span class="keyword">new</span> RabbitAdmin(connectionFactory);</span><br><span class="line">admin.declareQueue(<span class="keyword">new</span> Queue(<span class="string">&quot;myqueue&quot;</span>));</span><br><span class="line">AmqpTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</span><br><span class="line">template.convertAndSend(<span class="string">&quot;myqueue&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">String foo = (String) template.receiveAndConvert(<span class="string">&quot;myqueue&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="（3）XML配置"><a href="#（3）XML配置" class="headerlink" title="（3）XML配置"></a>（3）XML配置</h4><p>基于XML配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> GenericXmlApplicationContext(<span class="string">&quot;classpath:/rabbit-context.xml&quot;</span>);</span><br><span class="line">AmqpTemplate template = context.getBean(AmqpTemplate.class);</span><br><span class="line">template.convertAndSend(<span class="string">&quot;myqueue&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">String foo = (String) template.receiveAndConvert(<span class="string">&quot;myqueue&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/rabbit/spring-rabbit.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;amqpTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;myqueue&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="（4）Java配置"><a href="#（4）Java配置" class="headerlink" title="（4）Java配置"></a>（4）Java配置</h4><p>同样的示例使用 Java 中的外部配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(RabbitConfiguration.class);</span><br><span class="line">AmqpTemplate template = context.getBean(AmqpTemplate.class);</span><br><span class="line">template.convertAndSend(<span class="string">&quot;myqueue&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">String foo = (String) template.receiveAndConvert(<span class="string">&quot;myqueue&quot;</span>);</span><br><span class="line"></span><br><span class="line">........</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CachingConnectionFactory(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AmqpAdmin <span class="title">amqpAdmin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RabbitAdmin(connectionFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RabbitTemplate(connectionFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">myQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">&quot;myqueue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="二-使用"><a href="#二-使用" class="headerlink" title="二. 使用"></a>二. 使用</h2><h3 id="2-1-ConnectionFactory默认配置"><a href="#2-1-ConnectionFactory默认配置" class="headerlink" title="2.1 ConnectionFactory默认配置"></a>2.1 ConnectionFactory默认配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqProducerConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">amqpConnectionFactory</span><span class="params">(ConnectionListener connectionListener,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  RecoveryListener recoveryListener,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                  ChannelListener channelListener)</span> </span>&#123;</span><br><span class="line">        CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">        <span class="comment">// 配置rabbitmq的地址、端口，集群部署的情况下可填写多个，“,”分隔</span></span><br><span class="line">        connectionFactory.setAddresses(<span class="string">&quot;localhost:5672&quot;</span>);</span><br><span class="line">        <span class="comment">// 用户名</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"><span class="comment">// 密码</span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"><span class="comment">// 虚拟主机</span></span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置缓存模式，共有两种，CHANNEL和CONNECTION模式</span></span><br><span class="line">        connectionFactory.setCacheMode(CachingConnectionFactory.CacheMode.CHANNEL);</span><br><span class="line"><span class="comment">// 设置每个Connection中可以缓存的Channel的数量，非数量上限，获取Channel前会先尝试从缓存中找到一个闲置的，若无则会创建新的，当数量超过缓存数量时，多出来的会被关闭。该值修改只会影响后创建的Connection</span></span><br><span class="line">        connectionFactory.setChannelCacheSize(<span class="number">25</span>);</span><br><span class="line">        <span class="comment">// 设置Channel等待时间，大于0时setChannelCacheSize会同时变为数量上限，从缓存取不到可用的Channel时不会创建新的，而是等待该值指定的毫秒时间，若到点仍无可用的Channel会抛出AmqpTimeoutException异常；Connection模式下，该值也同样是Connection的获取超时时间</span></span><br><span class="line">        connectionFactory.setChannelCheckoutTimeout(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// Producer端消息确认机制开关，return机制</span></span><br><span class="line">        connectionFactory.setPublisherReturns(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// Producer端消息确认机制开关，confirm机制</span></span><br><span class="line">        connectionFactory.setPublisherConfirms(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 配置ConnectionListener</span></span><br><span class="line">        connectionFactory.addConnectionListener(connectionListener);</span><br><span class="line">        <span class="comment">// 配置ChannelListener</span></span><br><span class="line">        connectionFactory.addChannelListener(channelListener);</span><br><span class="line">        <span class="comment">// 配置RecoveryListener</span></span><br><span class="line">        connectionFactory.setRecoveryListener(recoveryListener);</span><br><span class="line">        <span class="comment">// 仅在Connection模式下使用，设置Connection的缓存数量</span></span><br><span class="line">        <span class="comment">//connectionFactory.setConnectionCacheSize(1);</span></span><br><span class="line">        <span class="comment">// 仅在Connection模式下使用，设置Connection的数量上限</span></span><br><span class="line">        <span class="comment">//connectionFactory.setConnectionLimit(Integer.MAX_VALUE);</span></span><br><span class="line">        <span class="keyword">return</span> connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>Channel模式：</strong>程序运行期间ConnectionFactory会维护一个Connection，所有的操作都使用此Connection，但一个Connection中可以有多个Channel，操作rabbitmq之前都必须先获取到一个Channel，否则就会阻塞（可以通过 <code>setChannelCheckoutTimeout()</code> 设置等待时间），这些Channel会被缓存（缓存的数量可以通过 <code>setChannelCacheSize()</code> 设置）；</li><li><strong>Connection模式：</strong>这个模式下允许创建多个Connection，会缓存一定数量的Connection，每个Connection中同样会缓存一些Channel，除了可以有多个Connection，其它都跟CHANNEL模式一样。</li></ul><h3 id="2-2-com-rabbitmq-client-ConnectionFactory自定义配置"><a href="#2-2-com-rabbitmq-client-ConnectionFactory自定义配置" class="headerlink" title="2.2 com.rabbitmq.client.ConnectionFactory自定义配置"></a>2.2 com.rabbitmq.client.ConnectionFactory自定义配置</h3><p>ConnectionFactory类连接MQ节点的Connection配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Default user name */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_USER = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default password */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PASS = <span class="string">&quot;guest&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default virtual host */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_VHOST = <span class="string">&quot;/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default maximum channel number;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*  zero for unlimited */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_CHANNEL_MAX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default maximum frame size;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*  zero means no limit */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_FRAME_MAX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default heart-beat interval;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*  60 seconds */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_HEARTBEAT = <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default host */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_HOST = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** &#x27;Use the default port&#x27; port */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    USE_DEFAULT_PORT = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default non-ssl port */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_AMQP_PORT = AMQP.PROTOCOL.PORT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default ssl port */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_AMQP_OVER_SSL_PORT = <span class="number">5671</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default TCP connection timeout: 60 seconds */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_CONNECTION_TIMEOUT = <span class="number">60000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* The default AMQP 0-9-1 connection handshake timeout. See DEFAULT_CONNECTION_TIMEOUT</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* for TCP (socket) connection timeout.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_HANDSHAKE_TIMEOUT = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default shutdown timeout;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*  zero means wait indefinitely */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_SHUTDOWN_TIMEOUT = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default continuation timeout for RPC calls in channels: 10 minutes */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>    DEFAULT_CHANNEL_RPC_TIMEOUT = (<span class="keyword">int</span>) MINUTES.toMillis(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default network recovery interval: 5000 millis */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span>  DEFAULT_NETWORK_RECOVERY_INTERVAL = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFERRED_TLS_PROTOCOL = <span class="string">&quot;TLSv1.2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FALLBACK_TLS_PROTOCOL = <span class="string">&quot;TLSv1&quot;</span>;</span><br></pre></td></tr></table></figure><p>修改默认连接配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">(com.rabbitmq.client.ConnectionFactory rabbitConnectionFactory)</span> </span>&#123;</span><br><span class="line">    CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory(rabbitConnectionFactory);</span><br><span class="line">    <span class="keyword">return</span> connectionFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> com.rabbitmq.client.<span class="function">ConnectionFactory <span class="title">rabbitConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    com.rabbitmq.client.ConnectionFactory connectionFactory = <span class="keyword">new</span> com.rabbitmq.client.ConnectionFactory();</span><br><span class="line">    connectionFactory.setAutomaticRecoveryEnabled(<span class="keyword">false</span>);</span><br><span class="line">    connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">    connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">    connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> connectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-AmqpTemplate配置"><a href="#2-3-AmqpTemplate配置" class="headerlink" title="2.3 AmqpTemplate配置"></a>2.3 AmqpTemplate配置</h3><p>若消费者端通过 <code>@RabbitListener</code> 注解的方式接收消息，则用不到此Bean。不建议直接使用ConnectionFactory获取Channel操作MQ，而是使用AmqpTemplate。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AmqpTemplate <span class="title">amqpTemplate</span><span class="params">(ConnectionFactory amqpConnectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                RabbitTemplate.ReturnCallback returnCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">                                RabbitTemplate.ConfirmCallback confirmCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">                                RetryTemplate retryTemplate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                MessageConverter messageConverter)</span></span>&#123;</span><br><span class="line">    RabbitTemplate rabbitTemplate = <span class="keyword">new</span> RabbitTemplate();</span><br><span class="line">    <span class="comment">// 设置spring-amqp的ConnectionFactory</span></span><br><span class="line">    rabbitTemplate.setConnectionFactory(amqpConnectionFactory);</span><br><span class="line">    <span class="comment">// 设置重试机制</span></span><br><span class="line">    rabbitTemplate.setRetryTemplate(retryTemplate);</span><br><span class="line">    <span class="comment">// 设置MessageConverter，用于java对象与Message对象（实际发送和接收的消息对象）之间的相互转换</span></span><br><span class="line">    rabbitTemplate.setMessageConverter(messageConverter);</span><br><span class="line">    <span class="comment">// 打开或关闭Channel的事务</span></span><br><span class="line">    rabbitTemplate.setChannelTransacted(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// return机制的回调接口</span></span><br><span class="line">    rabbitTemplate.setReturnCallback(returnCallback);</span><br><span class="line">    <span class="comment">// confirm机制的回调接口</span></span><br><span class="line">    rabbitTemplate.setConfirmCallback(confirmCallback);</span><br><span class="line">    <span class="comment">// 设为true使ReturnCallback生效</span></span><br><span class="line">    rabbitTemplate.setMandatory(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-RabbitListenerContainerFactory配置"><a href="#2-4-RabbitListenerContainerFactory配置" class="headerlink" title="2.4 RabbitListenerContainerFactory配置"></a>2.4 RabbitListenerContainerFactory配置</h3><p>这个bean仅在消费者端通过 <code>@RabbitListener</code> 注解的方式接收消息时使用，每一个 <code>@RabbitListener</code> 注解的方法都会由这个RabbitListenerContainerFactory创建一个MessageListenerContainer，负责接收消息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SimpleRabbitListenerContainerFactory <span class="title">rabbitListenerContainerFactory</span><span class="params">(CachingConnectionFactory cachingConnectionFactory, ErrorHandler errorHandler, MessageConverter messageConverter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      SimpleRabbitListenerContainerFactory factory = <span class="keyword">new</span> SimpleRabbitListenerContainerFactory();</span><br><span class="line"><span class="comment">// 设置spring-amqp的ConnectionFactory</span></span><br><span class="line">      factory.setConnectionFactory(cachingConnectionFactory);</span><br><span class="line"><span class="comment">// 对于消费者端，MessageConverter也可以在这里配置</span></span><br><span class="line">      factory.setMessageConverter(messageConverter);</span><br><span class="line"><span class="comment">// 设置消费者端的应答模式，共有三种：NONE、AUTO、MANUAL</span></span><br><span class="line">      factory.setAcknowledgeMode(AcknowledgeMode.AUTO);</span><br><span class="line"><span class="comment">// 设置每个MessageListenerContainer将会创建的Consumer的最小数量，默认是1个</span></span><br><span class="line">      factory.setConcurrentConsumers(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 设置每个MessageListenerContainer将会创建的Consumer的最大数量，默认等于最小数量</span></span><br><span class="line">      factory.setMaxConcurrentConsumers(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 设置每次请求发送给每个Consumer的消息数量</span></span><br><span class="line">      factory.setPrefetchCount(<span class="number">250</span>);</span><br><span class="line"><span class="comment">// 设置Channel的事务</span></span><br><span class="line">      factory.setChannelTransacted(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 设置事务当中可以处理的消息数量</span></span><br><span class="line">      factory.setTxSize(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 设置当rabbitmq收到nack/reject确认信息时的处理方式，设为true，扔回queue头部，设为false，丢弃</span></span><br><span class="line">      factory.setDefaultRequeueRejected(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 实现ErrorHandler接口设置进去，所有未catch的异常都会由ErrorHandler处理</span></span><br><span class="line">      factory.setErrorHandler(errorHandler);</span><br><span class="line">      <span class="keyword">return</span> factory;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>消费者端的应答模式：</p><ul><li><strong>NONE：</strong>无应答，这种模式下rabbitmq默认consumer能正确处理所有发出的消息，所以不管消息有没有被consumer收到，有没有正确处理都不会恢复。</li><li><strong>AUTO：</strong>由Container自动应答，正确处理发出ack信息，处理失败发出nack信息，rabbitmq发出消息后将会等待consumer端的应答，只有收到ack确认信息才会把消息清除掉，收到nack信息的处理办法由setDefaultRequeueRejected()方法设置，所以在这种模式下，发生错误的消息是可以恢复的。</li><li><strong>MANUAL：</strong>基本同AUTO模式，区别是需要人为调用方法给应答。</li></ul><h3 id="2-5-发送消息"><a href="#2-5-发送消息" class="headerlink" title="2.5 发送消息"></a>2.5 发送消息</h3><p>AmqpTamplate的发送消息接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String routingKey, Message message)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String exchange, String routingKey, Message message)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">convertAndSend</span><span class="params">(Object message)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">convertAndSend</span><span class="params">(String routingKey, Object message)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">convertAndSend</span><span class="params">(String exchange, String routingKey, Object message)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> AmqpException</span>;</span><br></pre></td></tr></table></figure><p>如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amqpTemplate.send(exchange, routingKey, <span class="keyword">new</span> Message(JSON.toJSONString(event).getBytes(), MessagePropertiesBuilder.newInstance().build()));</span><br></pre></td></tr></table></figure><h3 id="2-6-接收消息"><a href="#2-6-接收消息" class="headerlink" title="2.6 接收消息"></a>2.6 接收消息</h3><h4 id="（1）拉模式"><a href="#（1）拉模式" class="headerlink" title="（1）拉模式"></a>（1）拉模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 轮询调用方法一次获取一条</span></span><br><span class="line"><span class="function">Message <span class="title">receive</span><span class="params">()</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Message <span class="title">receive</span><span class="params">(String queueName)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Message <span class="title">receive</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果queue里面没有消息，会立刻返回null；传入timeoutMillis参数后可阻塞等待一段时间</span></span><br><span class="line"><span class="function">Message <span class="title">receive</span><span class="params">(String queueName, <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br></pre></td></tr></table></figure><p>直接转换为Java对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">receiveAndConvert</span><span class="params">()</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">receiveAndConvert</span><span class="params">(String queueName)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">receiveAndConvert</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">receiveAndConvert</span><span class="params">(String queueName, <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这四个方法需要配置org.springframework.amqp.support.converter.SmartMessageConverter，这是一个接口，Jackson2JsonMessageConverter已经实现了这个接口，所以只要将Jackson2JsonMessageConverter设置到RabbitTemplate中即可。</span></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">receiveAndConvert</span><span class="params">(ParameterizedTypeReference&lt;T&gt; type)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">receiveAndConvert</span><span class="params">(String queueName, ParameterizedTypeReference&lt;T&gt; type)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">receiveAndConvert</span><span class="params">(<span class="keyword">long</span> timeoutMillis, ParameterizedTypeReference&lt;T&gt; type)</span> <span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">receiveAndConvert</span><span class="params">(String queueName, <span class="keyword">long</span> timeoutMillis, ParameterizedTypeReference&lt;T&gt; type)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> AmqpException</span>;</span><br><span class="line"></span><br><span class="line">Foo&lt;Bar&lt;Baz, Qux&gt;&gt; foo = rabbitTemplate.receiveAndConvert(<span class="keyword">new</span> ParameterizedTypeReference&lt;Foo&lt;Bar&lt;Baz, Qux&gt;&gt;&gt;() &#123; &#125;);</span><br></pre></td></tr></table></figure><h4 id="（2）推模式"><a href="#（2）推模式" class="headerlink" title="（2）推模式"></a>（2）推模式</h4><p>通过方法 <code>channel.basicConsume()</code> 实现推模式，或者使用注解 <code>@RabbitListener</code> 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;queueName&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        JSON.parseObject(<span class="keyword">new</span> String(message.getBody()), typeReference);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果在@RabbitListener注解中指明binding信息，就能自动创建queue、exchange并建立binding关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// direct和topic类型的exchange需要routingKey</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = &quot;myQueue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;auto.exch&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;orderRoutingKey.#&quot;)</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// fanout类型的exchange</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = &quot;myQueue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;auto.exch&quot;, durable = &quot;true&quot;, type = ExchangeTypes.FANOUT))</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.0版本之后，可以指定多个routingKey：key = &#123; &quot;red&quot;, &quot;yellow&quot; &#125; </span></span><br><span class="line"><span class="comment">// 并且支持arguments属性，可用于headers类型的exchange</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = &quot;auto.headers&quot;, autoDelete = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">                        arguments = @Argument(name = &quot;x-message-ttl&quot;, value = &quot;10000&quot;,</span></span><br><span class="line"><span class="meta">                                                type = &quot;java.lang.Integer&quot;)),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;auto.headers&quot;, type = ExchangeTypes.HEADERS, autoDelete = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        arguments = &#123;</span></span><br><span class="line"><span class="meta">                @Argument(name = &quot;x-match&quot;, value = &quot;all&quot;),</span></span><br><span class="line"><span class="meta">                @Argument(name = &quot;foo&quot;, value = &quot;bar&quot;),</span></span><br><span class="line"><span class="meta">                @Argument(name = &quot;baz&quot;)</span></span><br><span class="line"><span class="meta">        &#125;)</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure><p>@Queue有两个参数：</p><ul><li><p>exclusive：排他队列，只对创建这个queue的Connection可见，Connection关闭则queue删除；</p></li><li><p>autoDelete：没有consumer对这个queue消费时删除。</p></li></ul><p>对于这两种队列，durable=true是不起作用的。另外，如果注解申明的queue和exchange及binding关系都已经存在，但与已存在的设置不同，比如，已存在的exchange的是direct类型，这里尝试改为fanout类型，结果是不会有任何影响，不论是修改或者新增参数都不会生效。</p><p>如果queue存在，exchange存在，但没有binding，那么程序启动后会自动建立起binding关系。</p><p>消费者消息处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手动ACK消息，后一个参数用于多条ACK，&lt;=deliveryTag同时ACK掉。</span></span><br><span class="line">channel.basicAck(deliveryTag, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不确认deliveryTag对应的消息</span></span><br><span class="line"><span class="comment">// 第二个参数是否应用于多消息</span></span><br><span class="line"><span class="comment">// 第三个参数是否重新放入队列requeue，与basic.reject区别就是同时支持多个消息，可以nack该消费者先前接收未ack的所有消息，nack后的消息也会被自己消费到。</span></span><br><span class="line">channel.basicNack(deliveryTag, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 抛弃此消息</span></span><br><span class="line">channel.basicNack(deliveryTag, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拒绝deliveryTag对应的消息</span></span><br><span class="line"><span class="comment">// 第二个参数是否requeue，true则重新入队列，否则丢弃或者进入死信队列。该方法reject后，该消费者还是会消费到该条被reject的消息。</span></span><br><span class="line">channel.basicReject(deliveryTag, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否恢复消息到队列，参数为是否requeue，true则重新入队列，并且尽可能的将之前recover的消息投递给其他消费者消费，而不是自己再次消费。false则消息会重新被投递给自己。</span></span><br><span class="line">channel.basicRecover(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h3 id="2-7-MessageConverter"><a href="#2-7-MessageConverter" class="headerlink" title="2.7 MessageConverter"></a>2.7 MessageConverter</h3><p>在发送和接收消息时自动完成Message和Java对象的转换。</p><p>MessageConverter 接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageConverter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">fromMessage</span><span class="params">(Message&lt;?&gt; message, Class&lt;?&gt; targetClass)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Message&lt;?&gt; toMessage(Object payload, <span class="meta">@Nullable</span> MessageHeaders headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即使不手动配置MessageConverter，也会有一个默认的SimpleMessageConverter，它会直接将java对象序列化。</p><p>官方文档不建议使用这个MessageConverter，因为SimpleMessageConverter是将java对象在producer端序列化，然后在consumer端反序列化，这会将producer和consumer紧密地耦合在一起，并且仅限于java平台。</p><p>推荐用JsonMessageConverter、Jackson2JsonMessageConverter，这两个是都将java对象转化为json再转为 <code>byte[]</code> 来构造Message对象，前一个用的是jackson json lib，后一个用的是jackson 2 json lib。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageConverter <span class="title">jsonMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplate</span><span class="params">(ConnectionFactory connectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    MessageConverter messageConverter)</span> </span>&#123;</span><br><span class="line">    RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</span><br><span class="line">    template.setMessageConverter(messageConverter);</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-8-异常处理"><a href="#2-8-异常处理" class="headerlink" title="2.8 异常处理"></a>2.8 异常处理</h3><p><code>spring-rabbit</code> 暴露了两个接口可供实现用来处理 <code>@RabbitListener</code> 注解方法抛出的异常：</p><ul><li>RabbitListenerErrorHandler</li><li>org.springframework.util.ErrorHandler</li></ul><p>RabbitListenerErrorHandler，设置在 <code>@RabbitListener</code> 注解上，只对当前注解的方法生效（当前方法抛异常时被调用）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RabbitListenerErrorHandler <span class="title">rabbitListenerErrorHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RabbitListenerErrorHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">handleError</span><span class="params">(Message amqpMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  org.springframework.messaging.Message&lt;?&gt; message,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  ListenerExecutionFailedException exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            System.out.println(message);</span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;test_queue_1&quot;, errorHandler = &quot;rabbitListenerErrorHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ErrorHandler，是 <code>spring-core</code> 包下面的 <code>ErrorHandler</code> ，可实现这个接口设置在 <code>RabbitListenerContainerFactory</code> 里面，示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RabbitListenerContainerFactory <span class="title">rabbitListenerContainerFactory</span><span class="params">(CachingConnectionFactory cachingConnectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                     MessageConverter messageConverter)</span></span>&#123;</span><br><span class="line">    SimpleRabbitListenerContainerFactory factory = <span class="keyword">new</span> SimpleRabbitListenerContainerFactory();</span><br><span class="line">    factory.setConnectionFactory(cachingConnectionFactory);</span><br><span class="line">    factory.setMessageConverter(messageConverter);</span><br><span class="line">    factory.setConcurrentConsumers(<span class="number">1</span>);</span><br><span class="line">    factory.setMaxConcurrentConsumers(<span class="number">1</span>);</span><br><span class="line">    factory.setPrefetchCount(<span class="number">1</span>);</span><br><span class="line">    factory.setErrorHandler(<span class="keyword">new</span> ErrorHandler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AmqpRejectAndDontRequeueException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    factory.setDefaultRequeueRejected(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个ErrorHandler对所有@RabbitListener注解方法生效。</p><p>二者对比：</p><ul><li><strong>作用范围：</strong>RabbitListenerErrorHandler只对当前 <code>@RabbitListener</code> 注解方法生效，ErrorHandler对所有 <code>@RabbitListener</code> 注解方法生效；</li><li>调用顺序：RabbitListenerErrorHandler先被调用，ErrorHandler后被调用；</li><li>处理粒度：RabbitListenerErrorHandler粒度比较细，可以获取到当前Message，以便做细致处理，ErrorHandler只能获取到Throwable参数；</li><li>默认配置：RabbitListenerErrorHandler没有默认配置，ErrorHandler有默认值ConditionalRejectingErrorHandler。</li></ul><p>ConditionalRejectingErrorHandler的作用：</p><ul><li>打印日志；</li><li>部分异常导致的失败不会requeue消息（默认处理失败的消息会requeue，AcknowledgeMode.NONE模式除外）。</li></ul><h3 id="2-9-事务"><a href="#2-9-事务" class="headerlink" title="2.9 事务"></a>2.9 事务</h3><p>amqp事务仅仅适用于publish和ack，rabbitmq增加了reject的事务。其它操作都不具备事务特性。</p><p>也就是说，rabbitmq本身的事务可以保证producer端发出的消息成功被broker收到（不能保证一定会进入queue），consumer端发出的确认信息成功被broker收到，其它诸如consumer端具体的消费逻辑之类如果想要获得事务功能，需要引入外部事务。</p><p>引入rabbitmq事务很简单，将RabbitTemplate或者RabbitListenerContainerFactory的channelTransacted属性设为true即可，示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AmqpTemplate <span class="title">amqpTemplate</span><span class="params">(ConnectionFactory amqpConnectionFactory)</span></span>&#123;</span><br><span class="line">    RabbitTemplate rabbitTemplate = <span class="keyword">new</span> RabbitTemplate();</span><br><span class="line">    rabbitTemplate.setConnectionFactory(amqpConnectionFactory);</span><br><span class="line">    rabbitTemplate.setChannelTransacted(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以直接操作Channel：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Channel channel = cachingConnectionFactory.createConnection().createChannel(<span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//channel.txSelect();上面createChannel已经设为true了，这句可以去掉</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;xxx&quot;</span>, <span class="string">&quot;xxx&quot;</span>, <span class="keyword">new</span> AMQP.BasicProperties(), JSON.toJSONString(event).getBytes());</span><br><span class="line">    channel.txCommit();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel.txRollback();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel.close()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是，直接通过Connection获取的Channel需要手动close。</p><p>对于producer端，同样的发送一条消息到一个不存在的exchange：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">amqpTemplate.convertAndSend(<span class="string">&quot;notExistExchange&quot;</span>, <span class="string">&quot;routingKey&quot;</span>, object);</span><br></pre></td></tr></table></figure><ul><li>如果关闭事务，CachingConnectionFactory会打出一条错误日志，但程序会正常运行。</li><li>如果打开事务，由于消息没有到达broker，这里会抛出异常。</li></ul><p>对于consumer端，当consumer正在处理一条消息时：</p><ul><li>如果broker挂掉，程序会不断尝试重连，当broker恢复时，会重新收到这条消息；</li><li>如果程序挂掉，broker发现还没有收到consumer的确认信息但consumer没了，会将这条消息恢复；</li><li>长时间没有收到consumer端的确认信息，也会将消息从unacked状态变成ready状态；</li><li>如果程序处理消息期间抛异常，broker会收到一个nack或者reject，也会将这条消息恢复。</li></ul><p>所以，rabbitmq是可以将没有成功消费的消息恢复的，consumer端使用rabbitmq事务的意义并不是很大，也许可以用于consumer端消息去重：</p><ul><li>consumer处理成功向rabbitmq发出了ack，consumer默认rabbitmq收到了这个ack所以consumer认为这条消息处理结束，但实际可能rabbitmq没有收到ack又将这条消息放回queue然后重新发给consumer导致消息重复处理。如果开启了事务，能保证rabbitmq一定能收到确认信息，否则事务提交失败。</li></ul><p>另外，需要注意的是，开启事务会大幅降低消息发送及接收效率，因为当已经有一个事务存在时，后面的消息是不能被发送或者接收（对同一个consumer而言）的，所以以上两种场景都不推荐使用事务来解决。</p><h3 id="2-10-Listeners"><a href="#2-10-Listeners" class="headerlink" title="2.10 Listeners"></a>2.10 Listeners</h3><p>ChannelListener接口，监听Channel的创建和异常关闭：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelListener <span class="title">channelListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ChannelListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Channel channel, <span class="keyword">boolean</span> transactional)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;channel number:&#123;&#125;, nextPublishSqlNo:&#123;&#125;&quot;</span>,</span><br><span class="line">                    channel.getChannelNumber(),</span><br><span class="line">                    channel.getNextPublishSeqNo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShutDown</span><span class="params">(ShutdownSignalException signal)</span> </span>&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;channel shutdown, reason:&#123;&#125;, errorLevel:&#123;&#125;&quot;</span>,</span><br><span class="line">                    signal.getReason().protocolMethodName(),</span><br><span class="line">                    signal.isHardError() ? <span class="string">&quot;connection&quot;</span> : <span class="string">&quot;channel&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BlockedListener监听Connection的block和unblock：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BlockedListener <span class="title">blockedListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BlockedListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleBlocked</span><span class="params">(String reason)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;connection blocked, reason:&#123;&#125;&quot;</span>, reason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleUnblocked</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;connection unblocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConnectionListener监听Connection的创建、关闭和异常终止：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionListener <span class="title">connectionListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConnectionListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;connection created.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;connection closed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShutDown</span><span class="params">(ShutdownSignalException signal)</span> </span>&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;connection shutdown, reason:&#123;&#125;, errorLevel:&#123;&#125;&quot;</span>,</span><br><span class="line">                    signal.getReason().protocolMethodName(),</span><br><span class="line">                    signal.isHardError() ? <span class="string">&quot;connection&quot;</span> : <span class="string">&quot;channel&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RecoveryListener监听开始自动恢复Connection、自动恢复连接完成：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RecoveryListener <span class="title">recoveryListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RecoveryListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRecovery</span><span class="params">(Recoverable recoverable)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;automatic recovery completed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRecoveryStarted</span><span class="params">(Recoverable recoverable)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;automatic recovery started&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ConnectionListener、ChannelListener、RecoveryListener设置到ConnectionFactory即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CachingConnectionFactory <span class="title">cachingConnectionFactory</span><span class="params">(ConnectionListener connectionListener,  ChannelListener channelListener, RecoveryListener recoveryListener)</span> </span>&#123;</span><br><span class="line">    CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">    connectionFactory.setAddresses(mqConfigBean.getAddresses());</span><br><span class="line">    connectionFactory.setUsername(mqConfigBean.getUsername());</span><br><span class="line">    connectionFactory.setPassword(mqConfigBean.getPassword());</span><br><span class="line">    connectionFactory.setVirtualHost(mqConfigBean.getVirtualHost());</span><br><span class="line">    connectionFactory.addConnectionListener(connectionListener);</span><br><span class="line">    connectionFactory.addChannelListener(channelListener);</span><br><span class="line">    connectionFactory.setRecoveryListener(recoveryListener);</span><br><span class="line">    connectionFactory.setChannelCacheSize(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> connectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过ConnectionListener和ChannelListener可以debug看出Connection和Channel都是有缓存的，因为 <code>onCreate()</code> 方法不会每次都调用。并且Connection和Channel的创建都是lazy的，程序启动时不会创建Connection和Channel，在第一次用到的时候才会创建。</p><h3 id="2-11-多个-RabbitListener消费一个queue"><a href="#2-11-多个-RabbitListener消费一个queue" class="headerlink" title="2.11 多个@RabbitListener消费一个queue"></a>2.11 多个@RabbitListener消费一个queue</h3><p>一个服务中可以有多个@RabbitListener注解的方法消费一个queue，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;queueName&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener1</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;queueName&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener2</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样写使用的仍是同一个Connection，一条消息也不会被两个方法都调用，如果RabbitListenerContainerFactory中设置concurrentConsumer为3，意味着每个方法产生3个consumer，一共会有6个consumer对这个queue进行消费。也可以分布在不同的应用程序中，那样会在不同的Connection中。</p><p>一个服务中有如上的两个方法消费同一个queue，另一个服务中有一个方法消费同一个queue，则会有两个消费者Connection，一个有3个Channel，一个有6个Channel。</p><h3 id="2-12-生产者消息确认机制confirm-and-return"><a href="#2-12-生产者消息确认机制confirm-and-return" class="headerlink" title="2.12 生产者消息确认机制confirm and return"></a>2.12 生产者消息确认机制confirm and return</h3><p>为了能让producer端知道消息是否成功进入了queue，并且避免使用事务大幅降低消息发送效率，可以用confirm和return机制来代替事务。</p><p>首先实现两个Callback，ReturnCallback和ConfirmCallback，需要哪个实现哪个，不一定都需要：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RabbitTemplate.<span class="function">ReturnCallback <span class="title">returnCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RabbitTemplate.ReturnCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;return call back&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> RabbitTemplate.<span class="function">ConfirmCallback <span class="title">confirmCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;confirm call back&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后将这两个Callback设置到RabbitTemplate中，将mandatory属性设为true（ReturnCallback需要，ConfirmCallback不需要）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.setReturnCallback(returnCallback);</span><br><span class="line">rabbitTemplate.setConfirmCallback(confirmCallback);</span><br><span class="line">rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>然后在ConnectionFactory中将这Confirm和Return机制打开：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connectionFactory.setPublisherReturns(<span class="keyword">true</span>);</span><br><span class="line">connectionFactory.setPublisherConfirms(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>调用条件：</p><ul><li><p>ConfirmCallback：每一条发出的消息都会调用ConfirmCallback；</p></li><li><p>ReturnCallback：只有在消息进入exchange但没有进入queue时才会调用。</p></li></ul><p>参数：</p><ul><li>correlationData：RabbitTemplate的send系列方法中有带这个参数的，如果传了这个参数，会在回调时拿到；</li><li>ack：消息进入exchange，为true，未能进入exchange，为false，由于Connection中断发出的消息进入exchange但没有收到confirm信息的情况，也会是false；</li><li>cause：消息发送失败时的失败原因信息。</li></ul><p>关于confirm和return官方文档上有下面这段信息，有必要了解一下：</p><blockquote><p> When a rabbit template send operation completes, the channel is closed; this would preclude the reception of confirms or returns in the case when the connection factory cache is full (when there is space in the cache, the channel is not physically closed and the returns/confirms will proceed as normal). When the cache is full, the framework defers the close for up to 5 seconds, in order to allow time for the confirms/returns to be received. When using confirms, the channel will be closed when the last confirm is received. When using only returns, the channel will remain open for the full 5 seconds. It is generally recommended to set the connection factory’s channelCacheSize to a large enough value so that the channel on which a message is published is returned to the cache instead of being closed. You can monitor channel usage using the RabbitMQ management plugin; if you see channels being opened/closed rapidly you should consider increasing the cache size to reduce overhead on the server.</p><p>当RabbitTemplate发送操作完成后，通道被关闭；这将排斥了在连接工厂缓存已满的情况下接收确认或返回（当缓存有空间时，通道不会被物理关闭，返回/确认将正常进行）。当缓存已满时，框架会将关闭时间推迟5秒，以便有时间接收确认/返回信息。</p><ul><li>当使用确认时，通道将在收到最后一个确认时被关闭。</li><li>当只使用返回时，通道将保持完整的5秒开放。</li></ul><p>通常建议将连接工厂的 channelCacheSize 设置为足够大的值，以便将发布消息的通道返回到缓存中而不是关闭。您可以使用 RabbitMQ 管理插件监控通道的使用情况；如果您看到通道被快速打开/关闭，您应该考虑增加缓存大小以减少服务器上的开销。</p></blockquote><p>异步的接收confirm和return时仍然需要走原来发送消息用到的那个Channel，如果那个Channel被关闭了，是收不到confirm/return信息的。好在根据以上说明，Channel会等到最后一个confirm接收到时才会close，所以应该也不用担心Channel被关闭而接收不到confirm的问题（异常会导致Channel提前关闭吗）。</p><h3 id="2-13-重试机制"><a href="#2-13-重试机制" class="headerlink" title="2.13 重试机制"></a>2.13 重试机制</h3><p>重试机制主要是解决网络不稳导致连接中断的问题。所以其实并不是重新发送消息，而是重新建立。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RetryTemplate <span class="title">retryTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RetryTemplate retryTemplate = <span class="keyword">new</span> RetryTemplate();</span><br><span class="line">    SimpleRetryPolicy simpleRetryPolicy = <span class="keyword">new</span> SimpleRetryPolicy(Integer.MAX_VALUE);</span><br><span class="line">    retryTemplate.setRetryPolicy(simpleRetryPolicy);</span><br><span class="line">    <span class="keyword">return</span> retryTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上，配置一个RetryTemplate，再设置到AmqpTemplate即可。</p><p>RetryTemplate与 <code>spring-amqp</code> 及rabbitmq都没有关系，这是 <code>spring-retry</code> 中的类。以上示例中使用了最简单的重试策略，不断重试，直到 <code>Integer.MAX_VALUE</code> 次为止。</p><p>对producer端而言，如果Connection正常，但发送消息失败是不会重试的，<strong>如指定的exchange不存在的情况</strong>：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">第<span class="number">1</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">1</span>条confirm，ack:<span class="keyword">false</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">26</span>:<span class="number">09.544</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第2条发送完毕</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">收到第2条<span class="title">confirm</span>，<span class="title">ack</span>:</span><span class="keyword">false</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">26</span>:<span class="number">10.552</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第3条发送完毕</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">收到第3条<span class="title">confirm</span>，<span class="title">ack</span>:</span><span class="keyword">false</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">26</span>:<span class="number">11.559</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span></span><br></pre></td></tr></table></figure><p><strong>由Connection中断导致的发送消息失败，会进行重试</strong>：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">第<span class="number">7</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">7</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">8</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">8</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">9</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">9</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">10</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">10</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">11</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">11</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">01</span>:<span class="number">44.000</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: connection error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">connection</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=320, reply-text=CONNECTION_FORCED - broker forced connection closure <span class="keyword">with</span> reason <span class="string">&#x27;shutdown&#x27;</span>, <span class="keyword">class</span>-id=0, <span class="keyword">method</span>-id=0)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">17:</span><span class="number">01</span>:<span class="number">44.005</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] WARN  [ForgivingExceptionHandler.java:<span class="number">115</span>] - An unexpected connection driver error occured (Exception message: Connection reset)</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">01</span>:<span class="number">44.602</span> [http-nio-<span class="number">8080</span>-exec-<span class="number">2</span>] INFO  [AbstractConnectionFactory.java:<span class="number">455</span>] - Attempting <span class="keyword">to</span> connect <span class="keyword">to</span>: [localhost:<span class="number">5672</span>]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">02</span>:<span class="number">23.076</span> [http-nio-<span class="number">8080</span>-exec-<span class="number">2</span>] INFO  [AbstractConnectionFactory.java:<span class="number">455</span>] - Attempting <span class="keyword">to</span> connect <span class="keyword">to</span>: [localhost:<span class="number">5672</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">02</span>:<span class="number">24.578</span> [http-nio-<span class="number">8080</span>-exec-<span class="number">2</span>] INFO  [AbstractConnectionFactory.java:<span class="number">471</span>] - Created <span class="keyword">new</span> connection: amqpConnectionFactory<span class="string">#3412</span>a3fd:<span class="number">20</span>/SimpleConnection@<span class="number">41298</span>ed [<span class="keyword">delegate</span>=amqp:<span class="comment">//guest@0:0:0:0:0:0:0:1:5672/test, localPort= 55092]</span></span><br><span class="line"></span><br><span class="line">第<span class="number">12</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">12</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">13</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">13</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">14</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">14</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br><span class="line"></span><br><span class="line">第<span class="number">15</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">15</span>条confirm，ack:<span class="keyword">true</span>, correlationData:null</span><br></pre></td></tr></table></figure><p><strong>没有配置重试，或到达了重试次数依然失败，会抛出异常</strong>：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">第<span class="number">15</span>条发送完毕</span><br><span class="line"></span><br><span class="line">收到第<span class="number">15</span>条confirm，ack:<span class="keyword">false</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">41</span>:<span class="number">13.571</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;paas_v3_vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第16条发送完毕</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">收到第16条<span class="title">confirm</span>，<span class="title">ack</span>:</span><span class="keyword">false</span>, correlationData:null</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">41</span>:<span class="number">14.583</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] ERROR [CachingConnectionFactory.java:<span class="number">1344</span>] - Channel shutdown: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - no exchange <span class="string">&#x27;xxx&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;paas_v3_vhost&#x27;</span>, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=40)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">17:</span><span class="number">41</span>:<span class="number">15.322</span> [AMQP Connection <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">5672</span>] WARN  [ForgivingExceptionHandler.java:<span class="number">115</span>] - An unexpected connection driver error occured (Exception message: Connection reset)</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">41</span>:<span class="number">15.579</span> [http-nio-<span class="number">8080</span>-exec-<span class="number">1</span>] INFO  [AbstractConnectionFactory.java:<span class="number">455</span>] - Attempting <span class="keyword">to</span> connect <span class="keyword">to</span>: [localhost:<span class="number">5672</span>]</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:<span class="number">41</span>:<span class="number">17.609</span> [http-nio-<span class="number">8080</span>-exec-<span class="number">1</span>] ERROR [ExceptionHandler.java:<span class="number">41</span>] - unknown error</span><br><span class="line"></span><br><span class="line">org.springframework.amqp.AmqpConnectException: java.net.ConnectException: Connection refused: connect</span><br><span class="line"></span><br><span class="line">at org.springframework.amqp.rabbit.support.RabbitExceptionTranslator.convertRabbitAccessException(RabbitExceptionTranslator.java:<span class="number">62</span>)</span><br><span class="line"></span><br><span class="line">at org.springframework.amqp.rabbit.connection.AbstractConnectionFactory.createBareConnection(AbstractConnectionFactory.java:<span class="number">484</span>)</span><br><span class="line"></span><br><span class="line">at org.springframework.amqp.rabbit.connection.CachingConnectionFactory.createConnection(CachingConnectionFactory.java:<span class="number">626</span>)</span><br><span class="line"></span><br><span class="line">at org.springframework.amqp.rabbit.connection.CachingConnectionFactory.createBareChannel(CachingConnectionFactory.java:<span class="number">576</span>)</span><br></pre></td></tr></table></figure><p>对Consumer端，如果采用的是 <code>@RabbitListener</code> 或其它类似异步接收消息的方式，则没必要配置重试。Consumer端有Ack机制，Connection中断导致RabbitMq收不到Ack信息，消息会重新入队（可能会导致同一条消息重复消费）。</p><p>对于直接调用RabbitTemplate的Receive系列方法获取消息的消费方式，则同消息发送端，没有Retry或Retry次数达到，则抛异常。</p><h3 id="2-14-发送端的消息丢失"><a href="#2-14-发送端的消息丢失" class="headerlink" title="2.14 发送端的消息丢失"></a>2.14 发送端的消息丢失</h3><p>讨论两种情况可能产生的消息丢失：</p><ol><li>RabbitMq没挂，只是短暂的网络异常，连接可以恢复，消息发送出去但没有到exchange。</li><li>RabbitMq挂了且长时间无法恢复，消息没有发出去；</li></ol><h4 id="（1）可恢复的Connection中断"><a href="#（1）可恢复的Connection中断" class="headerlink" title="（1）可恢复的Connection中断"></a>（1）可恢复的Connection中断</h4><p>配置开启Retry情况下，Connection中断会根据配置的retry策略尝试重连，但即使重新连上了，消息依然可能会丢失。</p><ul><li>本地测试，单线程间隔1毫秒循环发送1万条消息，模拟一个不断有消息发出的场景，在发送过程中手动关闭Rabbitmq服务再重新启动，模拟Connection短暂中断的场景。</li><li>因为每一条消息都带有唯一的messageId（实际上是“线程名-序号”的形式），所以能轻易地从消费端读出所有消息之后找到丢失的消息。</li><li>测试结果：发送1万条消息，实际收到9999条，丢失1条。</li></ul><p>发送端通过ConfirmCallback打印出所有ack=false的消息：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----------打印ack=false的消息----------</span><br><span class="line"></span><br><span class="line">size:4</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-5881</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-5882</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-5883</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-5884</span></span><br></pre></td></tr></table></figure><p>消费端读出所有消息后，找出丢失的消息：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">total:10000</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">contain</span> <span class="comment">size:</span> <span class="comment">9999</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">absent</span> <span class="comment">size:</span> <span class="comment">1</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">pool</span><span class="literal">-</span><span class="comment">5</span><span class="literal">-</span><span class="comment">thread</span><span class="literal">-</span><span class="comment">1</span><span class="literal">-</span><span class="comment">5883</span></span><br></pre></td></tr></table></figure><p>可以看到，ack=false的消息有4条，但实际上只丢了一条。因为消息的发送和Confirm是异步进行的，如果在消息发送出去之后，异步的confirm回来之前，Connection中断，那么ConfirmCallback会立即被调用，并且ack=false，原因是Channel被关闭了。</p><ul><li>单线程情况下应该最多只会丢失一条，也有可能不会丢。</li><li>多线程的情况下丢消息的现象就很严重了。本地测试5个线程发消息的情况，一共50000条消息，丢失了1500多条。但其实如果把这5个线程分到5个请求，一个请求只跑一个线程，情况会好很多，类似于上面单线程的情况。</li><li><strong>解决方案</strong>：首先可以想到的解决方案是事务，但事务一般不建议使用，为了rabbitmq的效率，退而求其次，采用confirm机制。</li></ul><p>从上面的测试可以看到，在ConfirmCallback中ack=false的消息未必真的没有到达exchange，但没有到达exchange的消息ack一定是false，所以只需要将ack=false的消息重新发送一遍即可（这种方案会导致消息重复发送，后面再解决这一问题）。</p><p><strong>ConfirmCallback的回调方法中没有Message对象</strong>，你可能会想从ConfirmCallback中拿到Message对象，当ack=false的时候将这个Message再重新发出去，但方法入参中没有Message对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReissueMessageConfirmCallback</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ReissueMessageConfirmCallback.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (correlationData <span class="keyword">instanceof</span> MessageCorrelationData) &#123;</span><br><span class="line">            MessageCorrelationData messageCorrelationData = (MessageCorrelationData) correlationData;</span><br><span class="line">            logger.info(<span class="string">&quot;------------messageId: &quot;</span> + messageCorrelationData.getMessage().getMessageProperties().getMessageId() +</span><br><span class="line">                    <span class="string">&quot;, ack: &quot;</span> + ack + <span class="string">&quot;, cause:&quot;</span> + cause + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!ack) &#123;</span><br><span class="line">                SendFailedMessageHolder.add(messageCorrelationData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到入参中有一个<strong>CorrelationData</strong>对象，同时在RabbitTemplate中有相应的send方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String exchange, <span class="keyword">final</span> String routingKey, <span class="keyword">final</span> Message message, <span class="keyword">final</span> CorrelationData correlationData)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法AmqpTemplate中是没有的，是RabbitTemplate扩展的。所以，虽然ConfirmCallback不能直接拿到Message，但可以拿到CorrelationData，于是问题就解决了。</p><p><strong>直接在ConfirmCallback中调用RabbitTemplate发送消息导致死锁</strong>，现在我们可以通过CorrelationData在ConfirmCallback中拿到Message对象了，我们也有办法拿到RabbitTemplate，为了避免bean的循环依赖，我是这样做的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">amqpTemplate</span><span class="params">(ConnectionFactory amqpConnectionFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  RetryTemplate retryTemplate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  MessageConverter messageConverter,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  //RabbitTemplate.ConfirmCallback confirmCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  RabbitTemplate.ReturnCallback returnCallback)</span></span>&#123;</span><br><span class="line">    RabbitTemplate rabbitTemplate = <span class="keyword">new</span> RabbitTemplate();</span><br><span class="line">    rabbitTemplate.setConnectionFactory(amqpConnectionFactory);</span><br><span class="line">    rabbitTemplate.setRetryTemplate(retryTemplate);</span><br><span class="line">    rabbitTemplate.setMessageConverter(messageConverter);</span><br><span class="line">    <span class="comment">//rabbitTemplate.setChannelTransacted(true);</span></span><br><span class="line">    rabbitTemplate.setReturnCallback(returnCallback);</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> ReissueMessageConfirmCallback(rabbitTemplate));</span><br><span class="line">    rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReissueMessageConfirmCallback是自己写的一个实现类，将RabbitTemplate bean自己设置进去。然后我们在ConfirmCallback中发送消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReissueMessageConfirmCallback</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ReissueMessageConfirmCallback.class);</span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReissueMessageConfirmCallback</span><span class="params">(RabbitTemplate rabbitTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate = rabbitTemplate;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (correlationData <span class="keyword">instanceof</span> MessageCorrelationData) &#123;</span><br><span class="line">            MessageCorrelationData messageCorrelationData = (MessageCorrelationData) correlationData;</span><br><span class="line">            String exchange = messageCorrelationData.getExchange();</span><br><span class="line">            String routingKey = messageCorrelationData.getRoutingKey();</span><br><span class="line">            Message message = messageCorrelationData.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (!ack) &#123;</span><br><span class="line">                rabbitTemplate.send(exchange, routingKey, message, messageCorrelationData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MessageCorrelationData是自己写的CorrelationData扩展类，增加了Message、exchange、routingKey属性。</p><p>在请求主线程发送1万条消息的过程中，将rabbitmq关闭，这时请求主线程和ConfirmCallback线程都在等待Connection恢复，然后重新启动rabbitmq，当程序重新建立Connection之后，这两个线程会死锁。</p><p><strong>可行的方案：定时任务重发</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReissueMessageSchedule</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        scheduledExecutorService.scheduleWithFixedDelay(<span class="keyword">new</span> ReissueTask(rabbitTemplate), <span class="number">10</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReissueTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ReissueTask.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReissueTask</span><span class="params">(RabbitTemplate rabbitTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplate = rabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;MessageCorrelationData&gt; messageCorrelationDataList = <span class="keyword">new</span> ArrayList&lt;&gt;(SendFailedMessageHolder.getAll());</span><br><span class="line">        logger.info(<span class="string">&quot;------------------获取到&quot;</span> + messageCorrelationDataList.size() + <span class="string">&quot;条ack=false的消息，准备重发------------------&quot;</span>);</span><br><span class="line">        SendFailedMessageHolder.clear();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (MessageCorrelationData messageCorrelationData : messageCorrelationDataList) &#123;</span><br><span class="line">            Message message = messageCorrelationData.getMessage();</span><br><span class="line">            String messageId = message.getMessageProperties().getMessageId();</span><br><span class="line">            logger.info(<span class="string">&quot;------------------重发第&quot;</span> + i + <span class="string">&quot;条消息，id: &quot;</span> + messageId + <span class="string">&quot;------------------&quot;</span>);</span><br><span class="line">            i++;</span><br><span class="line">            message.getMessageProperties().setMessageId(messageId + <span class="string">&quot;-重发&quot;</span>);</span><br><span class="line">            rabbitTemplate.send(messageCorrelationData.getExchange(), messageCorrelationData.getRoutingKey(),</span><br><span class="line">            messageCorrelationData.getMessage(), messageCorrelationData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;------------------重发完成------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重发的消息会在原消息id后面跟上“重发”二字。</p><p>本地测试打印出的相关信息，发送端：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">07</span>:<span class="number">36.063</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:29]</span> - ------------------获取到<span class="number">13</span>条发送失败的消息，准备重发------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">07</span>:<span class="number">36.063</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">1</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7439</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">07</span>:<span class="number">38.030</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  o<span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.r</span><span class="selector-class">.c</span><span class="selector-class">.CachingConnectionFactory</span> <span class="selector-attr">[AbstractConnectionFactory.java:455]</span> - Attempting to connect to: <span class="selector-attr">[localhost:5672]</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">07</span>:<span class="number">40.036</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  o<span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.r</span><span class="selector-class">.c</span><span class="selector-class">.CachingConnectionFactory</span> <span class="selector-attr">[AbstractConnectionFactory.java:455]</span> - Attempting to connect to: <span class="selector-attr">[localhost:5672]</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">14.188</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  o<span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.r</span><span class="selector-class">.c</span><span class="selector-class">.CachingConnectionFactory</span> <span class="selector-attr">[AbstractConnectionFactory.java:455]</span> - Attempting to connect to: <span class="selector-attr">[localhost:5672]</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.190</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  o<span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.r</span><span class="selector-class">.c</span><span class="selector-class">.CachingConnectionFactory</span> <span class="selector-attr">[AbstractConnectionFactory.java:455]</span> - Attempting to connect to: <span class="selector-attr">[localhost:5672]</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.710</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  o<span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.r</span><span class="selector-class">.c</span><span class="selector-class">.CachingConnectionFactory</span> <span class="selector-attr">[AbstractConnectionFactory.java:471]</span> - Created new connection: amqpConnectionFactory<span class="number">#2127e6</span>6e:<span class="number">25</span>/SimpleConnection@ee0d88b <span class="selector-attr">[delegate=amqp://guest@127.0.0.1:5672/test, localPort= 57212]</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.716</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">2</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7440</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.716</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.c</span><span class="selector-class">.RabbitmqController</span> <span class="selector-attr">[RabbitmqController.java:102]</span> - send message, id: reactor-http-nio-<span class="number">3</span>-<span class="number">7452</span></span><br><span class="line"></span><br><span class="line">send message: reactor-http-nio-<span class="number">3</span>-<span class="number">7452</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.717</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">3</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7441</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.718</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">4</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7442</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.718</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.c</span><span class="selector-class">.RabbitmqController</span> <span class="selector-attr">[RabbitmqController.java:102]</span> - send message, id: reactor-http-nio-<span class="number">3</span>-<span class="number">7453</span></span><br><span class="line"></span><br><span class="line">send message: reactor-http-nio-<span class="number">3</span>-<span class="number">7453</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.718</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">5</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7443</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.719</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">6</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7444</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.719</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">7</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7445</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.719</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">8</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7446</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.720</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.c</span><span class="selector-class">.RabbitmqController</span> <span class="selector-attr">[RabbitmqController.java:102]</span> - send message, id: reactor-http-nio-<span class="number">3</span>-<span class="number">7454</span></span><br><span class="line"></span><br><span class="line">send message: reactor-http-nio-<span class="number">3</span>-<span class="number">7454</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.720</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">9</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7447</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.720</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">10</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7448</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.720</span> <span class="selector-attr">[AMQP Connection 127.0.0.1:5672]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.r</span><span class="selector-class">.ReissueMessageConfirmCallback</span> <span class="selector-attr">[ReissueMessageConfirmCallback.java:21]</span> - ------------messageId: reactor-http-nio-<span class="number">3</span>-<span class="number">7451</span>, ack: true, cause:null--------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.721</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">11</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7449</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.721</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.c</span><span class="selector-class">.RabbitmqController</span> <span class="selector-attr">[RabbitmqController.java:102]</span> - send message, id: reactor-http-nio-<span class="number">3</span>-<span class="number">7455</span></span><br><span class="line"></span><br><span class="line">send message: reactor-http-nio-<span class="number">3</span>-<span class="number">7455</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.721</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">12</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7450</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.722</span> <span class="selector-attr">[reactor-http-nio-3]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.c</span><span class="selector-class">.RabbitmqController</span> <span class="selector-attr">[RabbitmqController.java:102]</span> - send message, id: reactor-http-nio-<span class="number">3</span>-<span class="number">7456</span></span><br><span class="line"></span><br><span class="line">send message: reactor-http-nio-<span class="number">3</span>-<span class="number">7456</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.723</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">13</span>条消息，id: reactor-http-nio-<span class="number">3</span>-<span class="number">7451</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">08</span>:<span class="number">16.723</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:41]</span> - ------------------重发完成------------------</span><br></pre></td></tr></table></figure><p>reactor-http-nio-3是请求主线程，pool-3-thread-1是执行重发消息定时任务的线程。</p><p>从以上日志信息可以看出，当rabbitmq关闭的时候，主线程与重发线程都在尝试重连，直到rabbitmq重启完成恢复Connection。重发的消息有13条：reactor-http-nio-3-7439 ~ reactor-http-nio-3-7451。</p><p>再看消费端整理并打印出来的接收到的所有消息：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--------should receive:10000---------</span><br><span class="line"></span><br><span class="line">----------actually receive: 10013----------</span><br><span class="line"></span><br><span class="line">----------absent messages:0---------</span><br><span class="line"></span><br><span class="line">----------resend messages: 13----------</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7439</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7440</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7441</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7442</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7443</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7444</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7446</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7447</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7445</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7449</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7448</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7450</span>-重发</span><br><span class="line"></span><br><span class="line">reactor-http-nio<span class="string">-3</span><span class="string">-7451</span>-重发</span><br></pre></td></tr></table></figure><p>可以看到，我们正确收到了上面那重发的13条消息。不过这次运气比较好，没有消息遗漏。同时，这里注意到一件事，消费端代码没有对重发的消息做排序，收到的重发消息的顺序与发送端重发消息的顺序是不匹配的，所以rabbitmq可能不保证先发出的消息一定先被接收。</p><p>下面是5个线程同时发送消息的测试结果，发送端：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">42</span>:<span class="number">40.602</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:29]</span> - ------------------获取到<span class="number">642</span>条发送失败的消息，准备重发------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">42</span>:<span class="number">40.602</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">1</span>条消息，id: pool-<span class="number">5</span>-thread-<span class="number">4</span>-<span class="number">6951</span>------------------</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">省略重连过程</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">43</span>:<span class="number">07.628</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">2</span>条消息，id: pool-<span class="number">5</span>-thread-<span class="number">5</span>-<span class="number">6605</span>------------------</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">省略中间<span class="number">600</span>多条消息的重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">43</span>:<span class="number">07.794</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">641</span>条消息，id: pool-<span class="number">5</span>-thread-<span class="number">1</span>-<span class="number">6704</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">43</span>:<span class="number">07.794</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:35]</span> - ------------------重发第<span class="number">642</span>条消息，id: pool-<span class="number">5</span>-thread-<span class="number">4</span>-<span class="number">7088</span>------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>:<span class="number">43</span>:<span class="number">07.794</span> <span class="selector-attr">[pool-3-thread-1]</span> INFO  c<span class="selector-class">.l</span><span class="selector-class">.l</span><span class="selector-class">.r</span><span class="selector-class">.p</span><span class="selector-class">.schedule</span><span class="selector-class">.task</span><span class="selector-class">.ReissueTask</span> <span class="selector-attr">[ReissueTask.java:41]</span> - ------------------重发完成------------------</span><br></pre></td></tr></table></figure><p>消费端：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">--------should receive:50000---------</span><br><span class="line"></span><br><span class="line">----------actually receive: 50014----------</span><br><span class="line"></span><br><span class="line">----------absent messages:628---------</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6583</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6584</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6705</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-2</span><span class="string">-6538</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-2</span><span class="string">-6653</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-3</span><span class="string">-6093</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-3</span><span class="string">-6218</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-4</span><span class="string">-6955</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-4</span><span class="string">-7087</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6605</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6733</span></span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6734</span></span><br><span class="line"></span><br><span class="line">----------resend messages: 642----------</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6580</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6581</span>-重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6705</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-1</span><span class="string">-6706</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-2</span><span class="string">-6537</span>-重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-2</span><span class="string">-6654</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-3</span><span class="string">-6093</span>-重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-3</span><span class="string">-6219</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-4</span><span class="string">-6951</span>-重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-4</span><span class="string">-7088</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6604</span>-重发</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6734</span>-重发</span><br><span class="line"></span><br><span class="line">pool<span class="string">-5</span>-thread<span class="string">-5</span><span class="string">-6735</span>-重发</span><br></pre></td></tr></table></figure><p>可以看到，丢失的消息被完美地包含在重发的消息里面了。</p><h4 id="（2）长时间无法恢复的Connection中断"><a href="#（2）长时间无法恢复的Connection中断" class="headerlink" title="（2）长时间无法恢复的Connection中断"></a>（2）长时间无法恢复的Connection中断</h4><p>上面讨论了retry之后可以恢复Connection的情况，也有可能长时间retry之后依然不能恢复Connection，如rabbitmq挂掉的情况，不能一直retry下去阻塞接口调用。</p><p>这种情况是没有confirm的，因为消息都没有发出去。所以处理就更简单了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    rabbitTemplate.send(messageCorrelationData.getExchange(), messageCorrelationData.getRoutingKey(), messageCorrelationData.getMessage(), messageCorrelationData);</span><br><span class="line">&#125; <span class="keyword">catch</span> (AmqpConnectException e) &#123;</span><br><span class="line">    SendFailedMessageHolder.add(messageCorrelationData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>retry失败或者没有retry机制都会抛出AmqpConnectException，catch之后将消息保存起来即可。</p><h3 id="2-15-消费端的消息去重"><a href="#2-15-消费端的消息去重" class="headerlink" title="2.15 消费端的消息去重"></a>2.15 消费端的消息去重</h3><p>如果发送端采用confirm机制来做丢失消息的重发，上面提到，可能会出现没有丢失的消息也被重发了，导致消息重复。</p><p>这个问题很容易解决，MessageProperties中是有messageId属性的，每条消息设置一个唯一的messageId即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Message message = messageConverter.toMessage(messageId, <span class="keyword">new</span> MessageProperties());</span><br><span class="line">message.getMessageProperties().setMessageId(messageId);</span><br></pre></td></tr></table></figure><h3 id="2-16-消息发送和接收使用不同的Connection"><a href="#2-16-消息发送和接收使用不同的Connection" class="headerlink" title="2.16 消息发送和接收使用不同的Connection"></a>2.16 消息发送和接收使用不同的Connection</h3><p>当一个服务同时作为消息发送端和接收端时，建议使用不同的Connection以避免一方出现故障影响到另一方。</p><p>并不需要做很多事情，只需RabbitTemplate配置中加一个属性设置即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.setUsePublisherConnection(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>RabbitTemplate在创建Connection时，会根据这个boolean参数选择使用ConnectionFactory本身或者ConnectionFactory中的publisherConnectionFactory（也是一个ConnectionFactory）来创建，相关源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a connection with this connection factory and/or its publisher factory.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> connectionFactory the connection factory.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> publisherConnectionIfPossible true to use the publisher factory, if present.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the connection.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">createConnection</span><span class="params">(<span class="keyword">final</span> ConnectionFactory connectionFactory, <span class="keyword">final</span> <span class="keyword">boolean</span> publisherConnectionIfPossible)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (publisherConnectionIfPossible) &#123;</span><br><span class="line">           ConnectionFactory publisherFactory = connectionFactory.getPublisherConnectionFactory();</span><br><span class="line">           <span class="keyword">if</span> (publisherFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> publisherFactory.createConnection();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> connectionFactory.createConnection();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="2-17-消息过期"><a href="#2-17-消息过期" class="headerlink" title="2.17 消息过期"></a>2.17 消息过期</h3><p>在发送端，可通过如下方式设置消息过期时间：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message.getMessageProperties().setExpiration(<span class="string">&quot;30000&quot;</span>);</span><br></pre></td></tr></table></figure><p>这样，这条消息的有效期是30秒，30秒没有被消费掉会被丢弃。</p><h3 id="2-18-Dead-letter-exchange"><a href="#2-18-Dead-letter-exchange" class="headerlink" title="2.18 Dead letter exchange"></a>2.18 Dead letter exchange</h3><p>这个与spring-amqp无关，是rabbitmq的设置。将一个queue设置了 <code>x-dead-letter-exchange</code> 及 <code>x-dead-letter-routing-key</code> 两个参数后，这个queue里丢弃的消息将会进入 <code>dead letter exchange</code> ，并route到相应的queue里去。</p><p>这里，被丢弃的消息包括：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The message <span class="keyword">is</span> rejected (basic.reject <span class="keyword">or</span> basic.nack) <span class="keyword">with</span> <span class="keyword">requeue</span>=<span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">The TTL <span class="keyword">for</span> the message expires; <span class="keyword">or</span></span><br><span class="line"></span><br><span class="line">The queue length limit <span class="keyword">is</span> exceeded.</span><br></pre></td></tr></table></figure><h2 id="三-原理"><a href="#三-原理" class="headerlink" title="三. 原理"></a>三. 原理</h2><h3 id="3-1-架构"><a href="#3-1-架构" class="headerlink" title="3.1 架构"></a>3.1 架构</h3><p>Spring AMQP的构成：</p><ul><li>spring-amqp：包含 <code>org.springframework.amqp.core</code>软件包，提供不依赖任何特定 AMQP 代理实现或 Client 端库的通用抽象。最终用户代码将只能在抽象层上开发，因此在各个供应商的实现中将更具可移植性。</li><li>spring-rabbit：RabbitMQ实现。</li></ul><h3 id="3-2-核心类"><a href="#3-2-核心类" class="headerlink" title="3.2 核心类"></a>3.2 核心类</h3><h4 id="（1）Message"><a href="#（1）Message" class="headerlink" title="（1）Message"></a>（1）Message</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProperties messageProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(<span class="keyword">byte</span>[] body, MessageProperties messageProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.body = body;</span><br><span class="line">        <span class="keyword">this</span>.messageProperties = messageProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getBody() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageProperties <span class="title">getMessageProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.messageProperties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MessageProperties</code> 接口定义了一些常用属性（如Header、exchange、routing key、消息创建时间timestamp等），也可以通过header扩展：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProperties</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1619000546531112290L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_BYTES = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_TEXT_PLAIN = <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_SERIALIZED_OBJECT = <span class="string">&quot;application/x-java-serialized-object&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_JSON = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_JSON_ALT = <span class="string">&quot;text/x-json&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_TYPE_XML = <span class="string">&quot;application/xml&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_BATCH_FORMAT = <span class="string">&quot;springBatchFormat&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BATCH_FORMAT_LENGTH_HEADER4 = <span class="string">&quot;lengthHeader4&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_AUTO_DECOMPRESS = <span class="string">&quot;springAutoDecompress&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String X_DELAY = <span class="string">&quot;x-delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTENT_TYPE = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MessageDeliveryMode DEFAULT_DELIVERY_MODE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_PRIORITY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; headers = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Date timestamp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String messageId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String clusterId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">byte</span>[] correlationId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String correlationIdString;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String replyTo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String contentType = <span class="string">&quot;application/octet-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String contentEncoding;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> contentLength;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> contentLengthSet;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> MessageDeliveryMode deliveryMode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String expiration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer priority;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Boolean redelivered;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String receivedExchange;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String receivedRoutingKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String receivedUserId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> deliveryTag;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> deliveryTagSet;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer messageCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String consumerTag;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String consumerQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Integer receivedDelay;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> MessageDeliveryMode receivedDeliveryMode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Type inferredArgumentType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Method targetMethod;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object targetBean;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 扩展属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeader</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.headers.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）Exchange"><a href="#（2）Exchange" class="headerlink" title="（2）Exchange"></a>（2）Exchange</h4><p><code>Exchange</code> 接口表示一个 AMQP 交换器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Exchange</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 名称</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 交换器类型</span></span><br><span class="line">    <span class="function">String <span class="title">getExchangeType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否持久化</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDurable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否自动删除</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAutoDelete</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他一些结构化参数</span></span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">getArguments</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Exchange：<code>Direct</code> ，<code>Topic</code> ，<code>Fanout</code> 和 <code>Headers</code> 。库中可以找到每种类型的<code>Exchange</code> 接口的实现。不同交换器类型可以参考：<a href="http://linyishui.top/2020091901.html">RabbitMQ（一）简介和入门</a>。</p><h4 id="（3）Queue"><a href="#（3）Queue" class="headerlink" title="（3）Queue"></a>（3）Queue</h4><p><code>Queue</code> 类表示消息队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否持久化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> durable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否排他，仅对首次声明它的连接可见，并在连接断开时自动删除，适用于一个客户端同时发送和读取消息的应用场景。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> exclusive;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否自动删除</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> autoDelete;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他一些参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, Object&gt; arguments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The queue is durable, non-exclusive and non auto-delete.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the queue.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Queue</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(name, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getters and Setters omitted for brevity</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造函数采用队列名称。取决于实现方式，Management 模板可以提供用于生成唯一命名的队列的方法。这样的队列可用作“答复”地址或其他“临时”情况。因此，自动生成的 Queue 的  exclusive 和 autoDelete 属性都将设置为 true 。</p><h4 id="（4）Binding"><a href="#（4）Binding" class="headerlink" title="（4）Binding"></a>（4）Binding</h4><p>生产者发送到 Exchange，而消费者从队列接收，将队列连接到 Exchange 的绑定至关重要。Spring AMQP 中定义了一个 <code>Binding</code> 类来表示这些连接。</p><p>可以使用固定的路由键将队列绑定到 DirectExchange。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Binding(someQueue, someDirectExchange, <span class="string">&quot;foo.bar&quot;</span>)</span><br></pre></td></tr></table></figure><p>可以使用路由模式将队列绑定到 TopicExchange。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Binding(someQueue, someTopicExchange, <span class="string">&quot;foo.*&quot;</span>)</span><br></pre></td></tr></table></figure><p>可以使用路由键将队列绑定到 FanoutExchange。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Binding(someQueue, someFanoutExchange)</span><br></pre></td></tr></table></figure><p>还提供 <code>BindingBuilder</code> 以促进“Fluent 的 API”样式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对bind()方法使用静态导入样式效果很好</span></span><br><span class="line">Binding b = BindingBuilder.bind(someQueue).to(someTopicExchange).with(<span class="string">&quot;foo.*&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>AmqpAdmin</code> 类可以使用绑定实例来实际触发代理上的绑定操作，可以在<code>@Configuration</code> 类中使用 Spring 的 <code>@Bean</code> -style 定义 Binding 实例。</p><h3 id="3-3-连接和资源Management"><a href="#3-3-连接和资源Management" class="headerlink" title="3.3 连接和资源Management"></a>3.3 连接和资源Management</h3><p>这一部分区别于核心类是基于具体实现的，RabbitMQ是目前唯一支持的实现。</p><h4 id="（1）ConnectionFactory-连接工厂类"><a href="#（1）ConnectionFactory-连接工厂类" class="headerlink" title="（1）ConnectionFactory-连接工厂类"></a>（1）ConnectionFactory-连接工厂类</h4><ul><li><code>ConnectionFactory</code> 接口是用于 Management 与 RabbitMQ 代理的连接的中央组件。 </li><li><code>ConnectionFactory</code> 的职责是提供<code>org.springframework.amqp.rabbit.connection.Connection</code> 的实例，该实例是 <code>com.rabbitmq.client.Connection</code> 的包装器。</li><li>提供的唯一具体实现是 <code>CachingConnectionFactory</code> ，默认情况下，它构建一个可以由应用程序共享的单个连接代理。</li><li>可以共享连接，因为与 AMQP 进行消息传递的“工作单元”实际上是一个“通道”(在某些方面，这类似于 JMS 中的 Connection 和 Session 之间的关系)。可以想象，连接实例提供了 <code>createChannel</code> 方法。 </li><li><code>CachingConnectionFactory</code> 实现支持这些通道的缓存，并且根据它们是否是事务性的，为通道维护单独的缓存。创建 <code>CachingConnectionFactory</code> 的实例时，可以通过构造函数提供hostname。还应该提供username和password属性。如果要配置通道缓存的大小(默认值为25)，则也可以在此处调用 <code>setChannelCacheSize()</code> 方法。</li><li>从1.3版本开始，可以将 <code>CachingConnectionFactory</code> 配置为缓存连接以及通道。在这种情况下，每次对 <code>createConnection()</code> 的调用都会创建一个新连接(或从缓存中检索一个空闲的连接)。关闭连接会将其返回到缓存(如果尚未达到缓存大小)。在此类连接上创建的通道也将被缓存。</li><li>在某些环境中，使用单独的连接可能很有用，例如从 HA 群集中使用负载，并与负载均衡器一起连接到不同的群集成员。将 <code>cacheMode</code> 设置为<code>CacheMode.CONNECTION</code> 。</li><li>从1.5.5版本开始，提供了一个新属性 <code>connectionLimit</code> 。设置此选项后，它将限制允许的连接总数。设置后，如果达到限制，则使用 <code>channelCheckoutTimeLimit</code> await 连接变为空闲。如果超过时间，则抛出 <code>AmqpTimeoutException</code> 。</li><li>当使用大量连接时，应考虑在 <code>CachingConnectionFactory</code> 上设置自定义<code>executor</code> 。然后，所有连接将使用同一执行程序，并且可以共享其线程。执行程序的线程池应该是无界的，或者应为预期的使用率进行适当设置(通常每个连接至少一个线程)。如果在每个连接上创建多个通道，则池大小将影响并发性，因此，变量(或简单缓存)线程池执行程序将是最合适的。</li><li>从1.6版本开始，默认的通道缓存大小已从1增加到25。在大容量，多线程的环境中，小的缓存意味着将以较高的速率创建和关闭通道。增加默认缓存大小将避免这种开销。您应该通过 RabbitMQ Admin UI 监视正在使用的通道，如果看到许多正在创建和关闭的通道，请考虑进一步增加缓存大小。缓存将仅按需增长(以适应应用程序的并发要求)，因此此更改不会影响现有的小批量应用程序。</li><li>从1.4.2版本开始，<code>CachingConnectionFactory</code> 具有属性<code>channelCheckoutTimeout</code> 。当此属性大于零时，<code>channelCacheSize</code> 成为可在连接上创建的通道数的限制。如果达到限制，则调用线程将阻塞，直到某个通道可用或达到此超时为止，在这种情况下将引发 <code>AmqpTimeoutException</code> 。</li><li>框架内使用的通道(例如<code>RabbitTemplate</code>)将可靠地返回到缓存。如果您在框架外部创建通道(例如，通过直接访问连接并调用 <code>createChannel()</code> )，则必须(通过关闭)可靠地返回它们(可能在 <code>finally</code> 块中)，以避免耗尽通道。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory(<span class="string">&quot;somehost&quot;</span>);</span><br><span class="line">connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">Connection connection = connectionFactory.createConnection();</span><br></pre></td></tr></table></figure><p> XML ：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.connection.CachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;somehost&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以使用 Rabbit 名称空间快速便捷地创建<code>ConnectionFactory</code>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>在大多数情况下，这是可取的，因为框架可以为您选择最佳的默认值。创建的实例将是 <code>CachingConnectionFactory</code> 。请记住，通道的默认缓存大小为 25。如果要缓存更多通道，请通过channelCacheSize属性设置一个较大的值。在 XML 中，它看起来像这样：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.connection.CachingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;somehost&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;guest&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;channelCacheSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;50&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="（2）ConnectionNameStrategy-连接命名"><a href="#（2）ConnectionNameStrategy-连接命名" class="headerlink" title="（2）ConnectionNameStrategy-连接命名"></a>（2）ConnectionNameStrategy-连接命名</h4><p>从1.7 版本开始，提供了 <code>ConnectionNameStrategy</code> 以便注入<code>AbstractionConnectionFactory</code> 。生成的名称用于目标 RabbitMQ 连接的特定于应用程序的标识。如果 RabbitMQ 服务器支持，则连接名称将显示在 ManagementUI 中。此值不必是唯一的，也不能用作连接标识符，例如在 HTTP API 请求中。该值应该是人类可读的，并且是<code>connection_name</code>键下<code>ClientProperties</code>的一部分。</p><p>可以使用一个简单的 Lambda：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connectionFactory.setConnectionNameStrategy(connectionFactory -&gt; &quot;MY_CONNECTION&quot;);</span><br></pre></td></tr></table></figure><p><code>ConnectionFactory</code> 参数可用于通过某些逻辑来区分目标连接名称。默认情况下，<code>AbstractConnectionFactory</code> 的 <code>beanName</code> ，代表对象的十六进制字符串和内部计数器用于生成 <code>connection_name</code> 。 <code>&lt;rabbit:connection-factory&gt; </code>名称空间组件也随 <code>connection-name-strategy</code> 属性一起提供。</p><p>提供了实现 <code>SimplePropertyValueConnectionNameStrategy</code> ，该实现将连接名称设置为应用程序属性。将其声明为 <code>@Bean</code> 并将其注入连接工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionNameStrategy <span class="title">cns</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimplePropertyValueConnectionNameStrategy(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">rabbitConnectionFactory</span><span class="params">(ConnectionNameStrategy cns)</span> </span>&#123;</span><br><span class="line">    CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">    ...</span><br><span class="line">    connectionFactory.setConnectionNameStrategy(cns);</span><br><span class="line">    <span class="keyword">return</span> connectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Spring Boot 及其自动配置的连接工厂时，仅需要声明 <code>ConnectionNameStrategy</code> 的 <code>@Bean</code>。引导程序将自动检测到该 bean，并将其连接到工厂。</p><h4 id="（3）阻止的连接和资源限制"><a href="#（3）阻止的连接和资源限制" class="headerlink" title="（3）阻止的连接和资源限制"></a>（3）阻止的连接和资源限制</h4><p>RabbitMQ内存警告（Memory Alarm）连接可能被阻止与 Broker 进行交互。从2.0开始，提供 <code>com.rabbitmq.client.BlockedListener</code> ，以通知连接被阻止和未被阻止的事件。此外，<code>AbstractConnectionFactory</code> 通过其内部<code>BlockedListener</code> 实现分别发出 <code>ConnectionBlockedEvent</code> 和 <code>ConnectionUnblockedEvent</code> 。这些使您能够提供应用程序逻辑，以对代理程序上的问题做出适当反应，并采取一些纠正措施。</p><p>当应用程序配置有单个 <code>CachingConnectionFactory</code> 时(默认情况下使用 Spring Boot 自动配置)，当代理阻止连接时，应用程序将停止工作。当它被 broker 阻止时，它的任何 Client 都会停止工作。如果我们在同一应用程序中具有生产者和消费者，那么当生产者阻塞连接时，由于代理上不再有资源，并且由于连接被阻塞，消费者也无法释放它们，我们可能最终陷入阻塞。</p><p>为了缓解该问题，建议再使用一个具有相同选项的单独的 <code>CachingConnectionFactory</code> 实例：一个用于生产者，一个用于消费者。对于在消费者线程上执行的事务生产者，不可能使用单独的 <code>CachingConnectionFactory</code> ，因为他们应该重用与消费者事务相关联的<code>Channel</code> 。</p><p>从版本2.0.2开始，<code>RabbitTemplate</code> 具有配置选项，以自动使用第二个连接工厂，除非正在使用事务。发布者连接的 <code>ConnectionNameStrategy</code> 与主要策略相同，在调用方法的结果后附加 <code>.publisher</code> 。</p><p>从1.7.7开始，提供了一个 <code>AmqpResourceNotAvailableException</code> ，例如当<code>SimpleConnection.createChannel()</code> 无法创建<code>Channel</code>时抛出该<code>AmqpResourceNotAvailableException</code> ，因为达到了 <code>channelMax</code> 的限制并且缓存中没有可用的通道。可以在 <code>RetryPolicy</code> 中使用此异常，以在某些回退之后恢复操作。</p><h4 id="（4）配置基础-Client-端连接工厂"><a href="#（4）配置基础-Client-端连接工厂" class="headerlink" title="（4）配置基础 Client 端连接工厂"></a>（4）配置基础 Client 端连接工厂</h4><p><code>CachingConnectionFactory</code> 使用 RabbitClient 端 <code>ConnectionFactory</code> 的实例；在 <code>CachingConnectionFactory</code> 上设置等效属性时，会传递许多配置属性(例如<code>host, port, userName, password, requestedHeartBeat, connectionTimeout</code>)。要设置其他属性(例如<code>clientProperties</code>)，请定义 Rabbit 工厂的实例，并使用<code>CachingConnectionFactory</code>的适当构造函数为其提供引用。如上所述使用命名空间时，请在<code>connection-factory</code>属性中提供对已配置工厂的引用。为方便起见，提供了工厂 bean 来帮助在 Spring 应用程序上下文中配置连接工厂，如下一节所述。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;rabbit:connection-factory</span><br><span class="line">      id=&quot;connectionFactory&quot; connection-factory=&quot;rabbitConnectionFactory&quot;/&gt;</span><br></pre></td></tr></table></figure><ul><li>4.0.x客户端默认启用了自动恢复功能；虽然与此功能兼容，但Spring AMQP有自己的恢复机制，一般不需要客户端的恢复功能。</li><li>建议禁用amqp-client自动恢复功能，以避免在代理可用但连接尚未恢复的情况下得到AutoRecoverConnectionNotCurrentlyOpenException。您可能会注意到这种异常，例如，当RabbitTemplate中配置了RetryTemplate时，甚至在故障转移到集群中的另一个代理时也是如此。</li><li>由于自动恢复连接是在一个计时器上恢复的，因此使用 Spring AMQP 的恢复机制可以更快地恢复连接。从 1.7.1 版开始，Spring AMQP 禁用它，除非您明确创建自己的 RabbitMQ 连接工厂并将其提供给 CachingConnectionFactory。由 RabbitConnectionFactoryBean 创建的 RabbitMQ ConnectionFactory 实例也将默认禁用该选项。</li></ul><h4 id="（5）RabbitConnectionFactoryBean-和配置-SSL"><a href="#（5）RabbitConnectionFactoryBean-和配置-SSL" class="headerlink" title="（5）RabbitConnectionFactoryBean 和配置 SSL"></a>（5）RabbitConnectionFactoryBean 和配置 SSL</h4><p>从1.4开始，提供了一个方便的<code>RabbitConnectionFactoryBean</code>，以使用依赖注入的方式在Client端连接工厂上配置 SSL 属性。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;rabbitConnectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">connection-factory</span>=<span class="string">&quot;clientConnectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">host</span>=<span class="string">&quot;$&#123;host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">port</span>=<span class="string">&quot;$&#123;port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;vhost&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">username</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span> <span class="attr">password</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clientConnectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.connection.RabbitConnectionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useSSL&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sslPropertiesLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;file:/secrets/rabbitSSL.properties&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>省略<code>keyStore</code>和<code>trustStore</code>配置以通过 SSL 进行连接而无需证书验证。密钥和信任库配置可以如下提供：</p><p><code>sslPropertiesLocation</code>属性是 Spring <code>Resource</code>，它指向包含以下键的属性文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keyStore=file:/secret/keycert.p12</span><br><span class="line">trustStore=file:/secret/trustStore</span><br><span class="line">keyStore.passPhrase=secret</span><br><span class="line">trustStore.passPhrase=secret</span><br></pre></td></tr></table></figure><p><code>keyStore</code>和<code>truststore</code>是指向 Store 的 Spring <code>Resources</code>。通常，此属性文件将由 os 保护，并且应用程序具有读取访问权限。</p><p>从 Spring AMQP 版本 1.5 开始，可以直接在工厂 bean 上设置这些属性。如果同时提供了离散属性和<code>sslPropertiesLocation</code>，则后者中的属性将覆盖离散值。</p><h4 id="（6）路由连接工厂"><a href="#（6）路由连接工厂" class="headerlink" title="（6）路由连接工厂"></a>（6）路由连接工厂</h4><p>从1.3开始，引入了<code>AbstractRoutingConnectionFactory</code>。这提供了一种机制，可在运行时为多个<code>ConnectionFactories</code>配置 Map 并由某个<code>lookupKey</code>确定目标<code>ConnectionFactory</code>。</p><p>Spring AMQP 提供了<code>SimpleRoutingConnectionFactory</code>，它从<code>SimpleResourceHolder</code>获取当前线程绑定的<code>lookupKey</code>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.connection.SimpleRoutingConnectionFactory&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetConnectionFactories&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;#&#123;connectionFactory1.virtualHost&#125;&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;connectionFactory1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;#&#123;connectionFactory2.virtualHost&#125;&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;connectionFactory2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;template&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(String vHost, String payload)</span> </span>&#123;</span><br><span class="line">        SimpleResourceHolder.bind(rabbitTemplate.getConnectionFactory(), vHost);</span><br><span class="line">        rabbitTemplate.convertAndSend(payload);</span><br><span class="line">        <span class="comment">// 使用后解除绑定资源很重要</span></span><br><span class="line">        SimpleResourceHolder.unbind(rabbitTemplate.getConnectionFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从版本 1.4 开始，<code>RabbitTemplate</code>支持 SpEL <code>sendConnectionFactorySelectorExpression</code> 和 <code>receiveConnectionFactorySelectorExpression</code> 属性，这些属性在每个 AMQP 协议交互操作(<code>send</code>，<code>sendAndReceive</code>，<code>receive</code>或<code>receiveAndReply</code>)上进行评估，对于提供的<code>AbstractRoutingConnectionFactory</code> 解析为 <code>lookupKey</code> 值。表达式中可以使用 Bean 引用，例如<code>&quot;@vHostResolver.getVHost(#root)&quot;</code>。对于<code>send</code>操作，要发送的消息是根评估对象。对于<code>receive</code>操作，queueName 是根评估对象。</p><p>路由算法为：</p><ul><li>如果 selectors 表达式为null，或者计算为null，或者提供的ConnectionFactory不是<code>AbstractRoutingConnectionFactory</code>的实例，则所有操作都像以前一样，取决于提供的ConnectionFactory实现。</li><li>如果评估结果不是null，但是没有针对该lookupKey的目标ConnectionFactory，并且<code>AbstractRoutingConnectionFactory</code>配置为<code>lenientFallback = true</code>，则会发生相同的情况。</li><li>当然，在<code>AbstractRoutingConnectionFactory</code>的情况下，它会回退到基于<code>determineCurrentLookupKey()</code>的<code>routing</code>实现。但是，如果<code>lenientFallback = false</code>，则抛出<code>IllegalStateException</code>。</li></ul><p>命名空间支持还在<code>&lt;rabbit:template&gt;</code>组件上提供了<code>send-connection-factory-selector-expression</code>和<code>receive-connection-factory-selector-expression</code>属性。</p><p>同样从1.4开始，可以在侦听器容器中配置路由连接工厂。在这种情况下，队列名称列表将用作查找关键字。例如，如果您使用<code>setQueueNames(&quot;foo&quot;, &quot;bar&quot;)</code>配置容器，则查找键将为<code>&quot;[foo,bar]&quot;</code>(无空格)。</p><p>从版本 1.6.9 开始，可以使用侦听器容器上的<code>setLookupKeyQualifier</code>向查找键添加限定符。</p><p>例如，这将允许侦听具有相同名称但在不同虚拟主机中的队列(每个虚拟主机中都有一个连接工厂)。</p><p>例如，在使用查找键限定符<code>foo</code>和侦听队列<code>bar</code>的容器的情况下，用于注册目标连接工厂的查找键将是<code>foo[bar]</code>。</p><h4 id="（7）队列相似性和LocalizedQueueConnectionFactory"><a href="#（7）队列相似性和LocalizedQueueConnectionFactory" class="headerlink" title="（7）队列相似性和LocalizedQueueConnectionFactory"></a>（7）队列相似性和LocalizedQueueConnectionFactory</h4><p>在集群中使用HA队列时，为了获得最佳性能，可能需要连接到主队列所在的物理代理。 <code>CachingConnectionFactory</code>可以配置多个代理地址；这是为了进行故障转移，Client 端将尝试按 Sequences 连接。 </p><p><code>LocalizedQueueConnectionFactory</code>使用 Management 插件提供的 REST API 来确定要控制队列的节点。然后，它创建(或从缓存中检索)<code>CachingConnectionFactory</code>，该<code>CachingConnectionFactory</code>将仅连接到该节点。如果连接失败，那么将确定新的主节点，并且使用者将连接到该主节点。</p><p> <code>LocalizedQueueConnectionFactory</code>配置有默认的连接工厂，以防无法确定队列的物理位置，在这种情况下，它将正常连接到群集。</p><p><code>LocalizedQueueConnectionFactory</code>是<code>RoutingConnectionFactory</code>，而<code>SimpleMessageListenerContainer</code>使用队列名称作为查找关键字。</p><p>注意</p><ul><li>由于使用队列名称进行查找这个原因，只有在将容器配置为侦听单个队列时，才能使用<code>LocalizedQueueConnectionFactory</code>。</li><li>必须在每个节点上启用 RabbitMQManagement 插件。</li><li>此连接工厂用于长期连接，例如<code>SimpleMessageListenerContainer</code>使用的连接。它不适用于短连接，例如用于<code>RabbitTemplate</code>，因为在构建连接之前调用 REST API 会产生开销。同样，对于发布操作，队列是未知的，并且无论如何该消息都会发布给所有集群成员，因此查找节点的逻辑几乎没有价值。</li></ul><p>这是一个示例配置，使用 Spring Boot 的 RabbitProperties 配置工厂：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitProperties props;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] adminUris = &#123; <span class="string">&quot;http://host1:15672&quot;</span>, <span class="string">&quot;http://host2:15672&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] nodes = &#123; <span class="string">&quot;[emailprotected]&quot;</span>, <span class="string">&quot;[emailprotected]&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">defaultConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CachingConnectionFactory cf = <span class="keyword">new</span> CachingConnectionFactory();</span><br><span class="line">    cf.setAddresses(<span class="keyword">this</span>.props.getAddresses());</span><br><span class="line">    cf.setUsername(<span class="keyword">this</span>.props.getUsername());</span><br><span class="line">    cf.setPassword(<span class="keyword">this</span>.props.getPassword());</span><br><span class="line">    cf.setVirtualHost(<span class="keyword">this</span>.props.getVirtualHost());</span><br><span class="line">    <span class="keyword">return</span> cf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">queueAffinityCF</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Qualifier(&quot;defaultConnectionFactory&quot;)</span> ConnectionFactory defaultCF)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocalizedQueueConnectionFactory(defaultCF,</span><br><span class="line">            StringUtils.commaDelimitedListToStringArray(<span class="keyword">this</span>.props.getAddresses()),</span><br><span class="line">            <span class="keyword">this</span>.adminUris, <span class="keyword">this</span>.nodes,</span><br><span class="line">            <span class="keyword">this</span>.props.getVirtualHost(), <span class="keyword">this</span>.props.getUsername(), <span class="keyword">this</span>.props.getPassword(),</span><br><span class="line">            <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请注意，前三个参数是<code>addresses</code>，<code>adminUris</code>和<code>nodes</code>的数组。这些是适当的，因为当容器尝试连接到队列时，它确定队列在哪个节点上被控制，并连接到同一阵列位置中的地址。</p><h4 id="（8）发布者确认并return"><a href="#（8）发布者确认并return" class="headerlink" title="（8）发布者确认并return"></a>（8）发布者确认并return</h4><p>通过将<code>CachingConnectionFactory</code>的<code>publisherConfirms</code>和<code>publisherReturns</code>属性分别设置为’true’，可以支持确认和返回的消息。</p><p>设置这些选项后，工厂创建的<code>Channel</code>将被包装在<code>PublisherCallbackChannel</code>中，方便回调。当获得这样的 Channels 时，Client 端可以向<code>Channel</code>注册<code>PublisherCallbackChannel.Listener</code>。 <code>PublisherCallbackChannel</code>实现包含将确认/返回路由到适当的侦听器的逻辑。</p><h4 id="（9）连接和-Channels-监听器"><a href="#（9）连接和-Channels-监听器" class="headerlink" title="（9）连接和 Channels 监听器"></a>（9）连接和 Channels 监听器</h4><p>连接工厂支持注册<code>ConnectionListener</code>和<code>ChannelListener</code>实现。这使您可以接收有关连接和通道相关事件的通知。 (构建连接时，<code>RabbitAdmin</code>使用<code>ConnectionListener</code>来执行声明。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConnectionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">onShutDown</span><span class="params">(ShutdownSignalException signal)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Channel channel, <span class="keyword">boolean</span> transactional)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">onShutDown</span><span class="params">(ShutdownSignalException signal)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（10）记录-Channels-关闭事件"><a href="#（10）记录-Channels-关闭事件" class="headerlink" title="（10）记录 Channels 关闭事件"></a>（10）记录 Channels 关闭事件</h4><p>在 1.5 版中引入了一种使用户能够控制日志记录级别的机制。</p><p><code>CachingConnectionFactory</code>使用默认策略记录通道关闭，如下所示：</p><ul><li>正常通道关闭(200 OK)不会被记录。</li><li>如果通道由于被动队列声明失败而关闭，那么它将在调试级别记录。</li><li>如果通道由于<code>basic.consume</code>由于特殊的使用者条件而被拒绝而关闭，则它将以 INFO 级别记录。</li><li>其他所有日志均以 ERROR 级别记录。</li></ul><p>若要修改此行为，请在其<code>closeExceptionLogger</code>属性中将自定义<code>ConditionalExceptionLogger</code>注入到<code>CachingConnectionFactory</code>中。</p><h4 id="（11）运行时缓存属性"><a href="#（11）运行时缓存属性" class="headerlink" title="（11）运行时缓存属性"></a>（11）运行时缓存属性</h4><p>从1.6开始，<code>CachingConnectionFactory</code> 通过<code>getCacheProperties()</code>方法提供了缓存统计信息。这些统计信息可用于调整缓存以在 Producing 对其进行优化。例如，高水位标记可用于确定是否应增加缓存大小。如果等于缓存大小，则可能要考虑进一步增加。</p><p><strong>表 3.1. CacheMode.CHANNEL 的缓存属性</strong></p><table><thead><tr><th>Property</th><th>Meaning</th></tr></thead><tbody><tr><td><code>connectionName</code></td><td><code>ConnectionNameStrategy</code>生成的连接的名称。</td></tr><tr><td><code>channelCacheSize</code></td><td>当前配置的允许空闲的最大通道数。</td></tr><tr><td><code>localPort</code></td><td>连接的本地端口(如果有)。这可用于与 RabbitMQ Admin UI 上的连接/通道关联。</td></tr><tr><td><code>idleChannelsTx</code></td><td>当前空闲(缓存)的事务通道的数量。</td></tr><tr><td><code>idleChannelsNotTx</code></td><td>当前空闲(缓存)的非事务通道的数量。</td></tr><tr><td><code>idleChannelsTxHighWater</code></td><td>已同时空闲(缓存)的最大事务通道数。</td></tr><tr><td><code>idleChannelsNotTxHighWater</code></td><td>非事务通道的最大数量已被同时空闲(缓存)。</td></tr></tbody></table><p><strong>表 3.2. CacheMode.CONNECTION</strong> 的缓存属性</p><table><thead><tr><th>Property</th><th>Meaning</th></tr></thead><tbody><tr><td><code>connectionName:&lt;localPort&gt;</code></td><td><code>ConnectionNameStrategy</code>生成的连接的名称。</td></tr><tr><td><code>openConnections</code></td><td>表示与代理的连接的连接对象的数量。</td></tr><tr><td><code>channelCacheSize</code></td><td>当前配置的允许空闲的最大通道数。</td></tr><tr><td><code>connectionCacheSize</code></td><td>当前配置的允许空闲的最大连接数。</td></tr><tr><td><code>idleConnections</code></td><td>当前空闲的连接数。</td></tr><tr><td><code>idleConnectionsHighWater</code></td><td>并发空闲的最大连接数。</td></tr><tr><td><code>idleChannelsTx:&lt;localPort&gt;</code></td><td>该连接当前空闲(缓存)的事务通道的数量。属性名称的 localPort 部分可用于与 RabbitMQ Admin UI 上的连接/通道关联。</td></tr><tr><td><code>idleChannelsNotTx:&lt;localPort&gt;</code></td><td>该连接当前空闲(缓存)的非事务通道的数量。属性名称的 localPort 部分可用于与 RabbitMQ Admin UI 上的连接/通道关联。</td></tr><tr><td>idleChannelsTxHighWater:</td><td></td></tr><tr><td>&lt;localPort&gt;</td><td>同时空闲(缓存)的最大事务通道数。属性名称的 localPort 部分可用于与 RabbitMQ Admin UI 上的连接/通道关联。</td></tr><tr><td>idleChannelsNotTxHighWater: &lt;localPort&gt;</td><td>已同时空闲(缓存)的非事务通道的最大数量。属性名称的 localPort 部分可用于与 RabbitMQ Admin UI 上的连接/通道关联。</td></tr></tbody></table><p><code>cacheMode</code>属性(还包括<code>CHANNEL</code>或<code>CONNECTION</code>)。</p><p><strong>图 3.1. JVisualVM 示例</strong></p><p><img src="https://www.docs4dev.com/images/spring-amqp/2.1.2.RELEASE/cacheStats.png" alt="cacheStats"></p><h4 id="（12）RabbitMQ-自动连接-拓扑恢复"><a href="#（12）RabbitMQ-自动连接-拓扑恢复" class="headerlink" title="（12）RabbitMQ 自动连接/拓扑恢复"></a>（12）RabbitMQ 自动连接/拓扑恢复</h4><p>从 Spring AMQP 的第一个版本开始，该框架在代理发生故障的情况下提供了自己的连接和通道恢复。另外，<code>RabbitAdmin</code> 将在重新构建连接时重新声明任何基础结构Bean(队列等)。因此，它不依赖<code>amqp-client</code>库现在提供的<a href="https://www.rabbitmq.com/api-guide.html#recovery">Auto Recovery</a>。 </p><p>Spring AMQP 现在使用<code>amqp-client</code>的<code>4.0.x</code>版本，默认情况下启用了自动恢复。如果愿意，Spring AMQP 仍可以使用其自己的恢复机制，在 Client 端中将其禁用(通过将基础<code>RabbitMQ connectionFactory</code>设置为<code>false</code>的<code>automaticRecoveryEnabled</code>属性)。</p><p>但是，该框架与启用的自动恢复完全兼容。这意味着您在代码中创建的所有使用者(可能通过<code>RabbitTemplate.execute()</code>)都可以自动恢复。</p><h3 id="3-4-添加自定义-Client-端连接属性"><a href="#3-4-添加自定义-Client-端连接属性" class="headerlink" title="3.4 添加自定义 Client 端连接属性"></a>3.4 添加自定义 Client 端连接属性</h3><p><code>CachingConnectionFactory</code> 允许访问基础连接工厂，以允许例如设置自定义 Client 端属性：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connectionFactory.getRabbitConnectionFactory().getClientProperties().put(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br></pre></td></tr></table></figure><p>查看连接时，这些属性会显示在 RabbitMQ Management  UI 中。</p><h3 id="3-5-AmqpTemplate"><a href="#3-5-AmqpTemplate" class="headerlink" title="3.5 AmqpTemplate"></a>3.5 AmqpTemplate</h3><p><code>AmqpTemplate</code>接口定义了用于发送和接收消息的所有基本操作。</p><p>未完待续。</p><h4 id="（1）添加重试功能"><a href="#（1）添加重试功能" class="headerlink" title="（1）添加重试功能"></a>（1）添加重试功能</h4><h4 id="（2）发布是异步的-如何检测成功和失败"><a href="#（2）发布是异步的-如何检测成功和失败" class="headerlink" title="（2）发布是异步的-如何检测成功和失败"></a>（2）发布是异步的-如何检测成功和失败</h4><h4 id="（3）发布者确认并return"><a href="#（3）发布者确认并return" class="headerlink" title="（3）发布者确认并return"></a>（3）发布者确认并return</h4><h4 id="（4）Scoped-Operations"><a href="#（4）Scoped-Operations" class="headerlink" title="（4）Scoped Operations"></a>（4）Scoped Operations</h4><h4 id="（5）Messaging-integration"><a href="#（5）Messaging-integration" class="headerlink" title="（5）Messaging integration"></a>（5）Messaging integration</h4><h4 id="（6）已验证的用户ID"><a href="#（6）已验证的用户ID" class="headerlink" title="（6）已验证的用户ID"></a>（6）已验证的用户ID</h4><h4 id="（7）使用单独的连接"><a href="#（7）使用单独的连接" class="headerlink" title="（7）使用单独的连接"></a>（7）使用单独的连接</h4><h3 id="3-6-发送消息"><a href="#3-6-发送消息" class="headerlink" title="3.6 发送消息"></a>3.6 发送消息</h3><h4 id="（1）Message-Builder"><a href="#（1）Message-Builder" class="headerlink" title="（1）Message Builder"></a>（1）Message Builder</h4><h4 id="（2）Publisher-Returns"><a href="#（2）Publisher-Returns" class="headerlink" title="（2）Publisher Returns"></a>（2）Publisher Returns</h4><h4 id="（3）Batching"><a href="#（3）Batching" class="headerlink" title="（3）Batching"></a>（3）Batching</h4><h3 id="3-7-接收消息"><a href="#3-7-接收消息" class="headerlink" title="3.7 接收消息"></a>3.7 接收消息</h3><h4 id="（1）Polling-Consumer"><a href="#（1）Polling-Consumer" class="headerlink" title="（1）Polling Consumer"></a>（1）Polling Consumer</h4><h4 id="（2）Asynchronous-Consumer"><a href="#（2）Asynchronous-Consumer" class="headerlink" title="（2）Asynchronous Consumer"></a>（2）Asynchronous Consumer</h4><h4 id="（3）Message-Listener"><a href="#（3）Message-Listener" class="headerlink" title="（3）Message Listener"></a>（3）Message Listener</h4><h4 id="（4）MessageListenerAdapter"><a href="#（4）MessageListenerAdapter" class="headerlink" title="（4）MessageListenerAdapter"></a>（4）MessageListenerAdapter</h4><h4 id="（5）Container"><a href="#（5）Container" class="headerlink" title="（5）Container"></a>（5）Container</h4><h4 id="（6）Consumer-Priority"><a href="#（6）Consumer-Priority" class="headerlink" title="（6）Consumer Priority"></a>（6）Consumer Priority</h4><h4 id="（7）auto-delete-Queues"><a href="#（7）auto-delete-Queues" class="headerlink" title="（7）auto-delete Queues"></a>（7）auto-delete Queues</h4><h4 id="（8）Batched-Messages"><a href="#（8）Batched-Messages" class="headerlink" title="（8）Batched Messages"></a>（8）Batched Messages</h4><h4 id="（9）Consumer-Events"><a href="#（9）Consumer-Events" class="headerlink" title="（9）Consumer Events"></a>（9）Consumer Events</h4><h4 id="（10）Consumer-Tags"><a href="#（10）Consumer-Tags" class="headerlink" title="（10）Consumer Tags"></a>（10）Consumer Tags</h4><h4 id="（11）注解驱动的监听器端点"><a href="#（11）注解驱动的监听器端点" class="headerlink" title="（11）注解驱动的监听器端点"></a>（11）注解驱动的监听器端点</h4><h2 id="四-源码剖析"><a href="#四-源码剖析" class="headerlink" title="四. 源码剖析"></a>四. 源码剖析</h2><h3 id="4-1-RabbitMQ消费流程"><a href="#4-1-RabbitMQ消费流程" class="headerlink" title="4.1 RabbitMQ消费流程"></a>4.1 RabbitMQ消费流程</h3><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010120.png"></p><h4 id="（1）启动流程"><a href="#（1）启动流程" class="headerlink" title="（1）启动流程"></a>（1）启动流程</h4><ol><li><p>通过<strong>BeanPostProcessor</strong>扫描所有的Bean中存在的 <code>@RabbitListener</code> 注解及相应的Method；</p></li><li><p>由<strong>RabbitListenerContainerFactory</strong>根据配置为每一个 <code>@RabbitListener</code> 注解创建一个<strong>MessageListenerContainer</strong>，持有 <code>@RabbitListener</code> 注解及Method信息；</p></li><li><p>初始化MessageListenerContainer，主要是循环依次创建Consumer（<strong>AsyncMessageProcessingConsumer</strong>），并启动Consumer；</p><p>创建Consumer，过程包括：</p><ul><li>创建<strong>AMQConnection</strong>，仅第一次创建。</li><li>创建<strong>AMQChannel</strong>，每个Consumer都会创建。</li><li>发送消费queue的请求（basic.consume），接收并处理消息。</li></ul></li><li><p>AMQConnection持有连接到Rabbitmq Server的Socket，创建完成后启动MainLoop循环从Socket流中读取Frame，此时流中没有消息，因为Channel还没创建完成；</p></li><li><p>创建AMQChannel（一个AMQConnection中持有多个AMQChannel），并将创建完成的Channel注册到AMQConnection持有的<strong>ConsumerWorkService</strong>，实际就是添加到<strong>WorkPool</strong>的Map里面去，此时Socket流中也没有消息，因为Channel还没有与Queue绑定；<br>创建完成的AMQChannel的代理返回给Consumer，Consumer通过Channel发送消费Queue的请求到Rabbitmq Server（绑定成功），此时还没开始处理消息，但Socket流中已经有消息，并且已经被Connection读取到内存（即 <code>BlockingQueue&lt;Runnable&gt;</code> ）中，并且已经开始向 <code>BlockingQueue&lt;Delivery&gt;</code> 分发；</p></li><li><p>Consumer启动循环，从 <code>BlockingQueue&lt;Delivery&gt;</code> 中取消息，利用MessageListenerContainer中持有的Method反射调用 <code>@RabbitListener</code> 注解方法处理消息。</p></li></ol><h4 id="（2）消费流程"><a href="#（2）消费流程" class="headerlink" title="（2）消费流程"></a>（2）消费流程</h4><ol><li>Rabbitmq Server往Socket流中写入字节。</li><li>AMQConnection启动一个main loop thread来跑MainLoop，不断从Socket流中读取字节转换成Frame对象，这是每个connection唯一的数据来源。</li><li>Consumer启动后，Connection读取到Frame。从basic.deliver开始是消息的内容，每条消息分成三个Frame：<ul><li>第一个是method，basic.deliver代表这是一个消息，后面一定会再跟着两个Frame；</li><li>第二个是message header；</li><li>第三个是message body，body读取之后将三个Frame整合到一起转换成一条完整的deliver命令。</li></ul></li><li>AMQConnection根据读取到的Frame中的type决定要怎么处理这个Frame（ <code>heartbeat(8) do nothing</code> )其它的根据channel编号交给相应的AMQChannel去处理，（编号为0的是特殊的channel，消息相关的用的都是编号非0的channel），消息都会拿着这个编号到<strong>ChannelManager</strong>找对应的ChannelN处理。</li><li>ChannelN经过一系列中间过程由Frame（消息是三个Frame）得到了Runnable，将 <code>&lt;ChannelN, Runnable&gt;</code> put 到 <strong>ConsumerWorkService</strong> 持有的 WorkPool 里面的一个 <code>Map&lt;Channel, BlockingQueue&lt;Runnable&gt;&gt;</code> 里面去。这样这个Runnable就进入了与ChannelN对应的 <code>BlockingQueue&lt;Runnable&gt;</code>（写死的size=1000）里面了。</li><li>execute一个<strong>WorkPoolRunnable</strong>，执行的任务是：<ul><li>从WorkPool中找出一个<strong>ready</strong>状态的ChannelN，把这个ChannelN设为<strong>inProgress</strong>状态；</li><li>从对应的 <code>BlockingQueue&lt;Runnable&gt;</code> 中取最多16个Runnable（写死）在WorkPoolRunnable的线程里依次执行（注意：此处不再另开线程，所以可能会堵塞当前线程，导致这个ChannelN长时间处于inProgress状态），执行完后将当前ChannelN状态改为ready，并在当前线程execute另一个WorkPoolRunnable。</li></ul></li><li><code>BlockingQueue&lt;Runnable&gt;</code> 里面的Runnable执行的逻辑是：构造一个Delivery并put到与ChannelN对应的<strong>AsyncMessageProcessingConsumer</strong>持有的 <code>BlockingQueue&lt;Delivery&gt;</code>（size=prefetchCount可配置）里面去（如果消息处理速度太慢，<code>BlockingQueue&lt;Delivery&gt;</code> 已满，此处会堵塞）。</li><li>每个AsyncMessageProcessingConsumer都有一个独立的线程在循环从 <code>BlockingQueue&lt;Delivery&gt;</code> 一次读取一个Delivery转换成Message反射调用 <code>@RabbitListener</code> 注解方法来处理。</li></ol><p>Frame对象结构如下：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20211001/202110010121.png"></p><ul><li><strong>type</strong>：指定当前Frame的类型，如 <code>method(1)</code> 、<code>message header(2)</code> 、<code>message body(3)</code> 、<code>heartbeat(8)</code> 等；</li><li><strong>channel</strong>：channel的编号，从0~n排列，指定当前Frame需要交给哪个channel处理。channel-0为一类，channel-n为一类。<ul><li>channel-0是一个匿名类，用来处理特殊Frame，如connection.start。</li><li>channel-n都是ChannelN类，由ChannelManager类统一管理。</li></ul></li><li><strong>payload</strong>：当前Frame的具体内容。</li></ul><h4 id="（3）ack消费模式"><a href="#（3）ack消费模式" class="headerlink" title="（3）ack消费模式"></a>（3）ack消费模式</h4><p>根据以上对消费过程的分析，将无ack模式与ack模式进行对比。</p><ul><li><p><strong>无ack模式（AcknowledgeMode.NONE）</strong></p><ul><li>Server端行为：<ul><li>Rabbitmq Server默认推送的所有消息都已经消费成功，会不断地向消费端推送消息。</li><li>因为Rabbitmq Server认为推送的消息已被成功消费，所以推送出去的消息不会暂存在server端。</li></ul></li><li>消息丢失的风险：<ul><li>当 <code>BlockingQueue&lt;Runnable&gt;</code> 堆满时（ <code>BlockingQueue&lt;Delivery&gt;</code> 一定会先满），server端推送消息会失败，然后断开Connection。消费端从Socket读取Frame将会抛出SocketException，触发异常处理，shutdown掉Connection和所有的Channel，Channel shutdown后WorkPool中的Channel信息（包括Channel inProgress、channel ready以及Map）全部清空，所以 <code>BlockingQueue&lt;Runnable&gt;</code> 中的数据会全部丢失。</li><li>此外，服务重启时也需对内存中未处理完的消息做必要的处理，以免丢失。而在Rabbitmq Server，Connection断掉后就没有消费者去消费这个queue，因此在server端会看到消息堆积的现象。</li></ul></li></ul></li><li><p><strong>有ack模式（AcknowledgeMode.AUTO，AcknowledgeMode.MANUAL）</strong>：AcknowledgeMode.MANUAL模式需要人为地获取到Channel之后调用方法向Server发送ack（或消费失败时的nack）信息。AcknowledgeMode.AUTO模式下，由spring-rabbit依据消息处理逻辑是否抛出异常自动发送ack（无异常）或nack（异常）到server端。</p><ul><li>server端行为：<ul><li>Rabbitmq Server推送给每个Channel的消息数量有限制，会保证每个Channel没有收到ack的消息数量不会超过prefetchCount。</li><li>Server端会暂存没有收到ack的消息，等消费端ack后才会丢掉；</li><li>如果收到消费端的nack（消费失败的标识）或Connection断开没收到反馈，会将消息放回到原队列头部。</li></ul></li><li>性能：这种模式不会丢消息，但效率较低，因为server端需要等收到消费端的答复之后才会继续推送消息，当然，推送消息和等待答复是异步的，可适当增大prefetchCount提高效率。</li></ul></li></ul><p>注意，有ack的模式下，需要考虑 <code>setDefaultRequeueRejected(false)</code> ，否则当消费消息抛出异常没有catch住时，这条消息会被rabbitmq放回到queue头部，再被推送过来，然后再抛异常再放回…死循环了。设置false的作用是抛异常时不放回，而是直接丢弃，所以可能需要对这条消息做处理，以免丢失。</p><p>对比：</p><ul><li>无ack模式：效率高，存在丢失大量消息的风险。</li><li>有ack模式：效率低，不会丢消息。</li></ul><h3 id="4-2-RabbitTemplate"><a href="#4-2-RabbitTemplate" class="headerlink" title="4.2 RabbitTemplate"></a>4.2 RabbitTemplate</h3><h4 id="（1）接收消息"><a href="#（1）接收消息" class="headerlink" title="（1）接收消息"></a>（1）接收消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">receive</span><span class="params">(String queueName)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// receiveTimeOut参数为0，直接获取消息，不等待，获取不到返回null；否则会等待一段时间。</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.receiveTimeout == <span class="number">0L</span> ? <span class="keyword">this</span>.doReceiveNoWait(queueName) : <span class="keyword">this</span>.receive(queueName, <span class="keyword">this</span>.receiveTimeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">receive</span><span class="params">(<span class="keyword">final</span> String queueName, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 通过execute传入Lambda表达式执行</span></span><br><span class="line">Message message = execute(channel -&gt; &#123;</span><br><span class="line">           <span class="comment">// 初始化Delivery</span></span><br><span class="line">Delivery delivery = consumeDelivery(channel, queueName, timeoutMillis);</span><br><span class="line"><span class="keyword">if</span> (delivery == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (isChannelLocallyTransacted(channel)) &#123;</span><br><span class="line">channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">channel.txCommit();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (isChannelTransacted()) &#123;</span><br><span class="line">ConnectionFactoryUtils.registerDeliveryTag(getConnectionFactory(), channel,</span><br><span class="line">delivery.getEnvelope().getDeliveryTag());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">channel.basicAck(delivery.getEnvelope().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> buildMessageFromDelivery(delivery);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">logReceived(message);</span><br><span class="line"><span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Message是通过调用execute方法得到的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(ChannelCallback&lt;T&gt; action)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> execute(action, getConnectionFactory());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ChannelCallback&lt;T&gt; action, <span class="keyword">final</span> ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 若启用RetryTemplate重试机制</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.retryTemplate != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.retryTemplate.execute(</span><br><span class="line">(RetryCallback&lt;T, Exception&gt;) context -&gt; doExecute(action, connectionFactory),</span><br><span class="line">(RecoveryCallback&lt;T&gt;) <span class="keyword">this</span>.recoveryCallback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line"><span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">throw</span> RabbitExceptionTranslator.convertRabbitAccessException(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">       <span class="comment">// 否则执行doExecute</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> doExecute(action, connectionFactory);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建了Connection和Channel，执行action.doInRabbit()方法得到Message，关闭Channel和Connection。当然，这里Connection和Channel的创建和关闭都不一定是真的创建和关闭，与具体的实现有关，比如CachingConnectionFactory，它的实现就是有缓存的</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">doExecute</span><span class="params">(ChannelCallback&lt;T&gt; action, ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 初始化channel和connection</span></span><br><span class="line"><span class="keyword">if</span> (isChannelTransacted()) &#123;</span><br><span class="line">resourceHolder = ConnectionFactoryUtils.</span><br><span class="line">getTransactionalResourceHolder(connectionFactory, <span class="keyword">true</span>, <span class="keyword">this</span>.usePublisherConnection);</span><br><span class="line">channel = resourceHolder.getChannel();</span><br><span class="line"><span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">ConnectionFactoryUtils.releaseResources(resourceHolder);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Resource holder returned a null channel&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">connection = ConnectionFactoryUtils.createConnection(connectionFactory,</span><br><span class="line"><span class="keyword">this</span>.usePublisherConnection); <span class="comment">// NOSONAR - RabbitUtils closes</span></span><br><span class="line"><span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Connection factory returned a null connection&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">channel = connection.createChannel(<span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Connection returned a null channel&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">RabbitUtils.closeConnection(connection);</span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">           <span class="comment">// action.doInRabbit()方法的实现逻辑就要再回到上面的receive方法，这里的action就是在那个receive方法传入的一个ChannelCallback的匿名内部实现类。</span></span><br><span class="line"><span class="keyword">return</span> action.doInRabbit(channel);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!invokeScope) &#123;</span><br><span class="line"><span class="keyword">if</span> (resourceHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">ConnectionFactoryUtils.releaseResources(resourceHolder);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">RabbitUtils.closeChannel(channel);</span><br><span class="line">RabbitUtils.closeConnection(connection);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>可以看到最后返回的消息是从Delivery中得到的，那么看下Delivery是怎么来的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Delivery <span class="title">consumeDelivery</span><span class="params">(Channel channel, String queueName, <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Delivery delivery = <span class="keyword">null</span>;</span><br><span class="line">RuntimeException exception = <span class="keyword">null</span>;</span><br><span class="line">       <span class="comment">// 异步执行</span></span><br><span class="line">CompletableFuture&lt;Delivery&gt; future = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">DefaultConsumer consumer = createConsumer(queueName, channel, future,</span><br><span class="line">timeoutMillis &lt; <span class="number">0</span> ? DEFAULT_CONSUME_TIMEOUT : timeoutMillis);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 阻塞式的等待返回结果，receive方法中传入的receiveTimeout参数也正是在这里用到的</span></span><br><span class="line"><span class="keyword">if</span> (timeoutMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">delivery = future.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">delivery = future.get(timeoutMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">Throwable cause = e.getCause();</span><br><span class="line"><span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer failed to receive message: &quot;</span> + consumer, cause);</span><br><span class="line">exception = RabbitExceptionTranslator.convertRabbitAccessException(cause);</span><br><span class="line"><span class="keyword">throw</span> exception;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line"><span class="comment">// no result in time</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (exception == <span class="keyword">null</span> || !(exception <span class="keyword">instanceof</span> ConsumerCancelledException)) &#123;</span><br><span class="line">cancelConsumerQuietly(channel, consumer);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> delivery;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步注册消费者</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> DefaultConsumer <span class="title">createConsumer</span><span class="params">(<span class="keyword">final</span> String queueName, Channel channel,</span></span></span><br><span class="line"><span class="params"><span class="function">CompletableFuture&lt;Delivery&gt; future, <span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">// 之前初始化的channel，控制流量为1</span></span><br><span class="line">channel.basicQos(<span class="number">1</span>);</span><br><span class="line">       <span class="comment">// 等待其它线程完成</span></span><br><span class="line"><span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">       <span class="comment">// 初始化消费者</span></span><br><span class="line">DefaultConsumer consumer = <span class="keyword">new</span> TemplateConsumer(channel) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCancel</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">future.completeExceptionally(<span class="keyword">new</span> ConsumerCancelledException());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 执行完basicConsume，消费者注册成功会回调该函数</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleConsumeOk</span><span class="params">(String consumerTag)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.handleConsumeOk(consumerTag);</span><br><span class="line">               <span class="comment">// latch-1</span></span><br><span class="line">latch.countDown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">future.complete(<span class="keyword">new</span> Delivery(consumerTag, envelope, properties, body));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">       <span class="comment">// 推模式消费消息</span></span><br><span class="line">channel.basicConsume(queueName, consumer);</span><br><span class="line">       <span class="comment">// 如果消费者注册超时</span></span><br><span class="line"><span class="keyword">if</span> (!latch.await(timeoutMillis, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">           <span class="comment">// Cache模式关闭代理信道</span></span><br><span class="line"><span class="keyword">if</span> (channel <span class="keyword">instanceof</span> ChannelProxy) &#123;</span><br><span class="line">((ChannelProxy) channel).getTargetChannel().close();</span><br><span class="line">&#125;</span><br><span class="line">           <span class="comment">// 将过程中的异常抛出</span></span><br><span class="line">future.completeExceptionally(</span><br><span class="line"><span class="keyword">new</span> ConsumeOkNotReceivedException(<span class="string">&quot;Blocking receive, consumer failed to consume: &quot;</span> + consumer));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> consumer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-3-RabbitListener注解"><a href="#4-3-RabbitListener注解" class="headerlink" title="4.3 @RabbitListener注解"></a>4.3 @RabbitListener注解</h3><p>通过注解的方式方便地接收消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;test_queue_delay&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入@RabbitListener注解源码，有一段注释说明了这个注解是怎么被处理的，通过注册一个RabbitListenerAnnotationBeanPostProcessor：</p><blockquote><p>Processing of {@code @RabbitListener} annotations is performed by registering a<br>{@link RabbitListenerAnnotationBeanPostProcessor}. This can be done manually or, more<br>conveniently, through the {@code rabbit:annotation-driven/} element or<br>{@link EnableRabbit} annotation.</p></blockquote><p>找到RabbitListenerAnnotationBeanPostProcessor：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(<span class="keyword">final</span> Object bean, <span class="keyword">final</span> String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">Class&lt;?&gt; targetClass = AopUtils.getTargetClass(bean);</span><br><span class="line"><span class="keyword">final</span> TypeMetadata metadata = <span class="keyword">this</span>.typeCache.computeIfAbsent(targetClass, <span class="keyword">this</span>::buildMetadata);</span><br><span class="line">       <span class="comment">// 当bean初始化完成后，在这里会获取到这个bean的类用户自己定义的所有添加了@RabbitListener注解的方法</span></span><br><span class="line"><span class="keyword">for</span> (ListenerMethod lm : metadata.listenerMethods) &#123;</span><br><span class="line"><span class="keyword">for</span> (RabbitListener rabbitListener : lm.annotations) &#123;</span><br><span class="line">               <span class="comment">// 然后调用processAmqpListener()方法对这些方法进行处理，实际上是对方法上的@RabbitListener进行处理，一个方法上可以有多个@RabbitListener，会处理多次</span></span><br><span class="line">processAmqpListener(rabbitListener, lm.method, bean, beanName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">       <span class="comment">// 类级别注释处理</span></span><br><span class="line"><span class="keyword">if</span> (metadata.handlerMethods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">processMultiMethodListeners(metadata.classAnnotations, metadata.handlerMethods, bean, beanName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取 <code>@RabbitListener</code> 注解方法的具体过程看 <code>buildMetadata()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//在这个方法里面，找出了所有加了@RabbitListener注解的方法</span></span><br><span class="line"><span class="comment">//可以在类上加@RabbitListener注解，然后在方法上加@RabbitHandler注解，如果采用这种方式会processMultiMethodListeners()方法来处理这些方法。</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> TypeMetadata <span class="title">buildMetadata</span><span class="params">(Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 先找到类级别注释</span></span><br><span class="line">Collection&lt;RabbitListener&gt; classLevelListeners = findListenerAnnotations(targetClass);</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> hasClassLevelListeners = classLevelListeners.size() &gt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">final</span> List&lt;ListenerMethod&gt; methods = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">final</span> List&lt;Method&gt; multiMethods = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">ReflectionUtils.doWithMethods(targetClass, method -&gt; &#123;</span><br><span class="line">           <span class="comment">// 找到方法级别注释，记录对应方法</span></span><br><span class="line">Collection&lt;RabbitListener&gt; listenerAnnotations = findListenerAnnotations(method);</span><br><span class="line"><span class="keyword">if</span> (listenerAnnotations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">methods.add(<span class="keyword">new</span> ListenerMethod(method,</span><br><span class="line">listenerAnnotations.toArray(<span class="keyword">new</span> RabbitListener[listenerAnnotations.size()])));</span><br><span class="line">&#125;</span><br><span class="line">           <span class="comment">// 类级别注释找到对应方法</span></span><br><span class="line"><span class="keyword">if</span> (hasClassLevelListeners) &#123;</span><br><span class="line">RabbitHandler rabbitHandler = AnnotationUtils.findAnnotation(method, RabbitHandler.class);</span><br><span class="line"><span class="keyword">if</span> (rabbitHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">multiMethods.add(method);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;, ReflectionUtils.USER_DECLARED_METHODS);</span><br><span class="line"><span class="keyword">if</span> (methods.isEmpty() &amp;&amp; multiMethods.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">return</span> TypeMetadata.EMPTY;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> TypeMetadata(</span><br><span class="line">methods.toArray(<span class="keyword">new</span> ListenerMethod[methods.size()]),</span><br><span class="line">multiMethods.toArray(<span class="keyword">new</span> Method[multiMethods.size()]),</span><br><span class="line">classLevelListeners.toArray(<span class="keyword">new</span> RabbitListener[classLevelListeners.size()]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们只看processAmqpListener()方法，看它是怎么处理上面找到的这些方法的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAmqpListener</span><span class="params">(RabbitListener rabbitListener, Method method, Object bean, String beanName)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 将每一个加@RabbitListener注解的方法构造一个MethodRabbitListenerEndpoint，然后调用processListener()</span></span><br><span class="line">      Method methodToUse = checkProxy(method, bean);</span><br><span class="line">      MethodRabbitListenerEndpoint endpoint = <span class="keyword">new</span> MethodRabbitListenerEndpoint();</span><br><span class="line">      endpoint.setMethod(methodToUse);</span><br><span class="line">      processListener(endpoint, rabbitListener, bean, methodToUse, beanName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processListener</span><span class="params">(MethodRabbitListenerEndpoint endpoint, RabbitListener rabbitListener, Object bean,</span></span></span><br><span class="line"><span class="params"><span class="function">    Object adminTarget, String beanName)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 省略的部分是读取@RabbitListener注解中的值，设置到endpoint中去</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">       <span class="comment">// endpoint的属性都设置完了之后，获取我们配置的RabbitListenerContainerFactory bean，然后调用RabbitListenerEndpointRegistrar类的registerEndpoint()方法</span></span><br><span class="line">RabbitListenerContainerFactory&lt;?&gt; factory = <span class="keyword">null</span>;</span><br><span class="line">String containerFactoryBeanName = resolve(rabbitListener.containerFactory());</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasText(containerFactoryBeanName)) &#123;</span><br><span class="line">Assert.state(<span class="keyword">this</span>.beanFactory != <span class="keyword">null</span>, <span class="string">&quot;BeanFactory must be set to obtain container factory by bean name&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">factory = <span class="keyword">this</span>.beanFactory.getBean(containerFactoryBeanName, RabbitListenerContainerFactory.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> BeanInitializationException(<span class="string">&quot;Could not register rabbit listener endpoint on [&quot;</span> +</span><br><span class="line">adminTarget + <span class="string">&quot;] for bean &quot;</span> + beanName + <span class="string">&quot;, no &quot;</span> + RabbitListenerContainerFactory.class.getSimpleName() + <span class="string">&quot; with id &#x27;&quot;</span> +</span><br><span class="line">containerFactoryBeanName + <span class="string">&quot;&#x27; was found in the application context&quot;</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.registrar.registerEndpoint(endpoint, factory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerEndpoint</span><span class="params">(RabbitListenerEndpoint endpoint, RabbitListenerContainerFactory&lt;?&gt; factory)</span> </span>&#123;</span><br><span class="line">Assert.notNull(endpoint, <span class="string">&quot;Endpoint must be set&quot;</span>);</span><br><span class="line">Assert.hasText(endpoint.getId(), <span class="string">&quot;Endpoint id must be set&quot;</span>);</span><br><span class="line"><span class="comment">// Factory may be null, we defer the resolution right before actually creating the container</span></span><br><span class="line">AmqpListenerEndpointDescriptor descriptor = <span class="keyword">new</span> AmqpListenerEndpointDescriptor(endpoint, factory);</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.endpointDescriptors) &#123;</span><br><span class="line">           <span class="comment">// 根据startImmediately看是否需要立刻注册endpoint，或者先将其添加到一个List，稍后统一注册</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.startImmediately) &#123; <span class="comment">// Register and start immediately</span></span><br><span class="line"><span class="keyword">this</span>.endpointRegistry.registerListenerContainer(descriptor.endpoint,</span><br><span class="line">resolveContainerFactory(descriptor), <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.endpointDescriptors.add(descriptor);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于统一注册的实现，RabbitListenerAnnotationBeanPostProcessor类除了实现BeanPostProcessor以外，还实现了SmartInitializingSingleton接口，所以当RabbitListenerAnnotationBeanPostProcessor这个bean实例化完成之后会调用它的 <code>afterSingletonsInstantiated()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actually register all listeners</span></span><br><span class="line">       <span class="comment">// 因为之前已经将所有的endpoint添加到了RabbitListenerEndpointRegistrar类中的一个List中了，所以这里调用RabbitListenerEndpointRegistrar类的afterPropertiesSet()方法进行统一注册</span></span><br><span class="line"><span class="keyword">this</span>.registrar.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 不管是单独注册endpoint还是统一注册，调用的是同样的方法registerAllEndpoints()</span></span><br><span class="line">registerAllEndpoints();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerAllEndpoints</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.endpointDescriptors) &#123;</span><br><span class="line">           <span class="comment">// for循环，一个一个注册</span></span><br><span class="line"><span class="keyword">for</span> (AmqpListenerEndpointDescriptor descriptor : <span class="keyword">this</span>.endpointDescriptors) &#123;</span><br><span class="line"><span class="keyword">this</span>.endpointRegistry.registerListenerContainer(</span><br><span class="line">descriptor.endpoint, resolveContainerFactory(descriptor));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.startImmediately = <span class="keyword">true</span>;  <span class="comment">// trigger immediate startup</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>跟踪 <code>registerListenerContainer()</code> 方法查看具体是怎么注册的，直到进入下面这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListenerContainer</span><span class="params">(RabbitListenerEndpoint endpoint, RabbitListenerContainerFactory&lt;?&gt; factory,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="keyword">boolean</span> startImmediately)</span> </span>&#123;</span><br><span class="line">Assert.notNull(endpoint, <span class="string">&quot;Endpoint must not be null&quot;</span>);</span><br><span class="line">Assert.notNull(factory, <span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">String id = endpoint.getId();</span><br><span class="line">Assert.hasText(id, <span class="string">&quot;Endpoint id must not be empty&quot;</span>);</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.listenerContainers) &#123;</span><br><span class="line">Assert.state(!<span class="keyword">this</span>.listenerContainers.containsKey(id),</span><br><span class="line"><span class="string">&quot;Another endpoint is already registered with id &#x27;&quot;</span> + id + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">MessageListenerContainer container = createListenerContainer(endpoint, factory);</span><br><span class="line"><span class="keyword">this</span>.listenerContainers.put(id, container);</span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasText(endpoint.getGroup()) &amp;&amp; <span class="keyword">this</span>.applicationContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">List&lt;MessageListenerContainer&gt; containerGroup;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.applicationContext.containsBean(endpoint.getGroup())) &#123;</span><br><span class="line">containerGroup = <span class="keyword">this</span>.applicationContext.getBean(endpoint.getGroup(), List.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">containerGroup = <span class="keyword">new</span> ArrayList&lt;MessageListenerContainer&gt;();</span><br><span class="line"><span class="keyword">this</span>.applicationContext.getBeanFactory().registerSingleton(endpoint.getGroup(), containerGroup);</span><br><span class="line">&#125;</span><br><span class="line">containerGroup.add(container);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (startImmediately) &#123;</span><br><span class="line">startIfNecessary(container);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见，注册endpoint，实际上就是RabbitListenerContainerFactory将每一个endpoint都创建成MessageListenerContainer（具体创建过程，由RabbitListenerContainerFactory类自己去完成），然后根据startImmediately参数判断是否调用startIfNecessary()方法立即启动MessageListenerContainer。</p><p>实际接收消息是由这个MessageListenerContainer来做的，而MessageListenerContainer接口中有一个接口方法来设置MessageListener：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Setup the message listener to use. Throws an &#123;<span class="doctag">@link</span> IllegalArgumentException&#125;</span></span><br><span class="line"><span class="comment"> * if that message listener type is not supported.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messageListener the &#123;<span class="doctag">@code</span> object&#125; to wrapped to the &#123;<span class="doctag">@code</span> MessageListener&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupMessageListener</span><span class="params">(Object messageListener)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>MessageListener将会调用我们加了@RabbitListener注解的方法处理消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Listener interface to receive asynchronous delivery of Amqp Messages.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark Pollack</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gary Russell</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或者是ChannelAwareMessageListener接口类来调用我们的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A message listener that is aware of the Channel on which the message was received.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mark Pollack</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Gary Russell</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelAwareMessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Callback for processing a received Rabbit message.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Implementors are supposed to process the given Message,</span></span><br><span class="line"><span class="comment"> * typically sending reply messages through the given Session.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message the received AMQP message (never &lt;code&gt;null&lt;/code&gt;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel the underlying Rabbit Channel (never &lt;code&gt;null&lt;/code&gt;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception Any.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样接收并处理消息的所有工作就完成了。</p><p>如果不立即启动MessageListenerContainer，RabbitListenerEndpointRegistry也实现了SmartLifecycle接口，所以在spring context refresh的最后一步会去调用start()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (MessageListenerContainer listenerContainer : getListenerContainers()) &#123;</span><br><span class="line">startIfNecessary(listenerContainer);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到在这里统一启动了所有的MessageListenerContainer：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startIfNecessary</span><span class="params">(MessageListenerContainer listenerContainer)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.contextRefreshed || listenerContainer.isAutoStartup()) &#123;</span><br><span class="line">listenerContainer.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所谓启动MessageListenerContainer其实就是调用MessageListenerContainer的start()方法。这也是SmartLifecycle的一个接口方法，它的实现必须保证调用了这个start()方法之后MessageListenerContainer将能够接受到消息。</p><p>所以对@RabbitListener注解的整个处理流程就是这样。</p><p>总结一下整个实现流程：</p><ul><li>@RabbitListener注解的方法所在的类首先是一个bean，因此，实现BeanPostProcessor接口对每一个初始化完成的bean进行处理。</li><li>遍历bean中由用户自己定义的所有的方法，找出其中添加了@RabbitListener注解的方法（也可以是@RabbitHandler注解，上面已经讲了，不再赘述）。</li><li>读取上面找出的所有方法上@RabbitListener注解中的值，并为每一个方法创建一个RabbitListenerEndpoint，保存在RabbitListenerEndpointRegistrar类中。</li><li>在所有的bean都初始化完成，即所有@RabbitListener注解的方法都创建了endpoint之后，由我们配置的RabbitListenerContainerFactory将每个endpoint创建MessageListenerContainer。</li><li>最后启动上面创建的MessageListenerContainer。</li><li>至此，全部完成，MessageListenerContainer启动后将能够接受到消息，再将消息交给它的MessageListener处理消息。</li></ul><p>下面还剩下几件事情才能真正实现上面的步骤：</p><ul><li>RabbitListenerContainerFactory只是个接口，它不会自己创建</li><li>MessageListenerContainer，所以需要一个RabbitListenerContainerFactory实现类，它必须能创建MessageListenerContainer。<br>MessageListenerContainer也只是一个接口，它不会自己接收消息，所以需要一个MessageListenerContainer实现类，它必须做到在启动后能够接收消息，同时它必须能设置MessageListener，用以处理消息。</li><li>MessageListener（或ChannelAwareMessageListener）也只是一个接口，所以还需要一个MessageListener实现类，它必须能调用我们加了@RabbitListener注解的方法。</li></ul><h3 id="4-5-SimpleMessageListenerContainer"><a href="#4-5-SimpleMessageListenerContainer" class="headerlink" title="4.5 SimpleMessageListenerContainer"></a>4.5 SimpleMessageListenerContainer</h3><h4 id="（1）概述"><a href="#（1）概述" class="headerlink" title="（1）概述"></a>（1）概述</h4><p><code>SimpleMessageListenerContainer</code>是<code>spring</code>在<code>rabbitmq</code>原生<code>api</code>基础上封装实现的一个消费工具类，该类非常强大，可以实现：</p><ul><li>监听单个或多个队列</li><li>自动启动</li><li>自动声明</li><li>还支持动态配置，如动态添加监听队列、动态调整并发数等等。</li></ul><p>基本上对<code>RabbitMQ</code>消费场景这个类都能满足。如<code>@RabbitListener</code>、cloud-stream中<code>StreamListener</code>中底层实现都是基于该类，所以理解<code>SimpleMessageListenerContainer</code>原理对理解<code>spring rabbitmq</code>中消费模型非常关键。</p><h4 id="（2）基本使用"><a href="#（2）基本使用" class="headerlink" title="（2）基本使用"></a>（2）基本使用</h4><p>运行时添加/移除监听队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串集合动态添加到queueNames中</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addQueueNames</span><span class="params">(String... queueName)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.addQueueNames(queueName);</span><br><span class="line">       <span class="keyword">this</span>.queuesChanged();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeQueueNames</span><span class="params">(String... queueName)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">super</span>.removeQueueNames(queueName)) &#123;</span><br><span class="line">           <span class="keyword">this</span>.queuesChanged();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object consumersMonitor = <span class="keyword">new</span> Object();</span><br><span class="line">   <span class="keyword">private</span> Set&lt;BlockingQueueConsumer&gt; consumers;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queuesChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 获取对象锁</span></span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.consumers != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">               <span class="comment">// 遍历消费者集合，依次取消订阅并移出集合</span></span><br><span class="line">               <span class="keyword">for</span>(Iterator consumerIterator = <span class="keyword">this</span>.consumers.iterator(); consumerIterator.hasNext(); ++count) &#123;</span><br><span class="line">                   BlockingQueueConsumer consumer = (BlockingQueueConsumer)consumerIterator.next();</span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                       <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Queues changed; stopping consumer: &quot;</span> + consumer);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// 取消订阅</span></span><br><span class="line">                   consumer.basicCancel(<span class="keyword">true</span>);</span><br><span class="line">                   consumerIterator.remove();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 再重新创建消费者</span></span><br><span class="line">               <span class="keyword">this</span>.addAndStartConsumers(count);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addAndStartConsumers</span><span class="params">(<span class="keyword">int</span> delta)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 获取对象锁</span></span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.consumers != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// 创建指定数目的消费者</span></span><br><span class="line">               <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; delta &amp;&amp; (<span class="keyword">this</span>.maxConcurrentConsumers == <span class="keyword">null</span> || <span class="keyword">this</span>.consumers.size() &lt; <span class="keyword">this</span>.maxConcurrentConsumers); ++i) &#123;</span><br><span class="line">                   <span class="comment">// 使用该类默认值/创建模板时指定的参数来构建消费者</span></span><br><span class="line">                   BlockingQueueConsumer consumer = <span class="keyword">this</span>.createBlockingQueueConsumer();</span><br><span class="line">                   <span class="comment">// 加回集合</span></span><br><span class="line">                   <span class="keyword">this</span>.consumers.add(consumer);</span><br><span class="line">                   <span class="comment">// 异步启动消费者</span></span><br><span class="line">                   SimpleMessageListenerContainer.AsyncMessageProcessingConsumer processor = <span class="keyword">new</span> SimpleMessageListenerContainer.AsyncMessageProcessingConsumer(consumer);</span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                       <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Starting a new consumer: &quot;</span> + consumer);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">this</span>.getTaskExecutor().execute(processor);</span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="comment">// 发布事件</span></span><br><span class="line">                       <span class="keyword">this</span>.getApplicationEventPublisher().publishEvent(<span class="keyword">new</span> AsyncConsumerStartedEvent(<span class="keyword">this</span>, consumer));</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="comment">// 若启动流程有异常（getStartupException阻塞等待结果），则从集合移出消费者，并终止消费者</span></span><br><span class="line">                       FatalListenerStartupException startupException = processor.getStartupException();</span><br><span class="line">                       <span class="keyword">if</span> (startupException != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           <span class="comment">// 多余的一行？</span></span><br><span class="line">                           <span class="keyword">this</span>.consumers.remove(consumer);</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> AmqpIllegalStateException(<span class="string">&quot;Fatal exception on listener startup&quot;</span>, startupException);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException var8) &#123;</span><br><span class="line">                       Thread.currentThread().interrupt();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception var9) &#123;</span><br><span class="line">                       consumer.stop();</span><br><span class="line">                       <span class="keyword">this</span>.logger.error(<span class="string">&quot;Error starting new consumer&quot;</span>, var9);</span><br><span class="line">                       <span class="keyword">this</span>.cancellationLock.release(consumer);</span><br><span class="line">                       <span class="keyword">this</span>.consumers.remove(consumer);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>后置处理器 <code>setAfterReceivePostProcessors()</code> ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 后置处理器，接收到的消息都添加了Header请求头</span></span><br><span class="line">container.setAfterReceivePostProcessors(message -&gt; &#123;</span><br><span class="line">       message.getMessageProperties().getHeaders().put(<span class="string">&quot;desc&quot;</span>, <span class="number">10</span>); </span><br><span class="line">       <span class="keyword">return</span> message;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">container.setMessageListener((MessageListener) message -&gt; &#123; </span><br><span class="line">       System.out.println(<span class="string">&quot;====接收到消息=====&quot;</span>);</span><br><span class="line">       System.out.println(message.getMessageProperties()); </span><br><span class="line">       System.out.println(<span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure><p>设置消费者的tag和Arguments：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置消费者的Consumer tag</span></span><br><span class="line">container.setConsumerTagStrategy(queue -&gt; <span class="string">&quot;order_queue_&quot;</span>+(++count));</span><br><span class="line"><span class="comment">// 设置消费者的Arguments</span></span><br><span class="line">Map args = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;module&quot;</span>,<span class="string">&quot;订单模块&quot;</span>);</span><br><span class="line">args.put(<span class="string">&quot;fun&quot;</span>,<span class="string">&quot;发送消息&quot;</span>);</span><br><span class="line">container.setConsumerArguments(args);</span><br></pre></td></tr></table></figure><p><img src="https://res-static.hc-cdn.cn/fms/img/e30c505f6dfcc7704eb104d6169c202c1612517532882" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析1"></p><p>设置并发消费者：</p><ul><li>setConcurrentConsumers设置多个并发消费者一起消费，并支持运行时动态修改。</li><li>setMaxConcurrentConsumers设置最多的并发消费者。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> SimpleMessageListenerContainer <span class="title">messageListenerContainer</span><span class="params">(ConnectionFactory connectionFactory)</span></span>&#123; </span><br><span class="line">       SimpleMessageListenerContainer container = <span class="keyword">new</span> SimpleMessageListenerContainer();</span><br><span class="line">       container.setConnectionFactory(connectionFactory);</span><br><span class="line">       container.setQueueNames(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">       container.setConcurrentConsumers(<span class="number">5</span>); </span><br><span class="line">       container.setMaxConcurrentConsumers(<span class="number">10</span>);</span><br><span class="line">       container.setMessageListener((MessageListener) message -&gt; &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;====接收到消息=====&quot;</span>);</span><br><span class="line">           System.out.println(message.getMessageProperties()); </span><br><span class="line">           System.out.println(<span class="keyword">new</span> String(message.getBody())); </span><br><span class="line">       &#125;); </span><br><span class="line">       <span class="keyword">return</span> container; </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="（3）核心原理"><a href="#（3）核心原理" class="headerlink" title="（3）核心原理"></a>（3）核心原理</h4><p>API结构：</p><p><code>SimpleMessageListenerContainer</code>类结构如下：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/7f0590fab310e55f8ae8dc0d28d7fd161612517532882" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析2"></p><p>方法入口：</p><p><code>SimpleMessageListenerContainer</code> 类启动的入口是 <code>start()</code> 方法，该方法位于父类 <code>AbstractMessageListenerContainer</code> 中：</p><h5 id="AbstractMessageListenerContainer-start"><a href="#AbstractMessageListenerContainer-start" class="headerlink" title="AbstractMessageListenerContainer#start"></a>AbstractMessageListenerContainer#start</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 已启动，则直接退出</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isRunning()) &#123;</span><br><span class="line">        <span class="comment">// initialized未执行初始化，则执行afterPropertiesSet()方法进行初始化，执行完成后initialized设置成true</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.lifecycleMonitor) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.afterPropertiesSet();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Starting Rabbit listener container.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证RabbitAdmin，mismatchedQueuesFatal=true时，spring context中RabbitAdmin数量不能大于1</span></span><br><span class="line">            <span class="keyword">this</span>.configureAdminIfNeeded();</span><br><span class="line">            <span class="comment">// 执行RabbitAdmin#initialize方法，spring context中注入的exchanges, queues and bindings执行声明式创建</span></span><br><span class="line">            <span class="keyword">this</span>.checkMismatchedQueues();</span><br><span class="line">            <span class="comment">// 启动核心</span></span><br><span class="line">            <span class="keyword">this</span>.doStart();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">this</span>.convertRabbitAccessException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="SimpleMessageListenerContainer-doStart"><a href="#SimpleMessageListenerContainer-doStart" class="headerlink" title="SimpleMessageListenerContainer#doStart"></a>SimpleMessageListenerContainer#doStart</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>.lifecycleMonitor) &#123;</span><br><span class="line">           <span class="keyword">this</span>.active = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">this</span>.running = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">this</span>.lifecycleMonitor.notifyAll();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">// 如果MessageListener是ListenerContainerAware，则进行expectedQueueNames校验</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageListener() <span class="keyword">instanceof</span> ListenerContainerAware) &#123;</span><br><span class="line">           Collection&lt;String&gt; expectedQueueNames = ((ListenerContainerAware)<span class="keyword">this</span>.getMessageListener()).expectedQueueNames();</span><br><span class="line">           <span class="keyword">if</span> (expectedQueueNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">               String[] queueNames = <span class="keyword">this</span>.getQueueNames();</span><br><span class="line">               Assert.state(expectedQueueNames.size() == queueNames.length, <span class="string">&quot;Listener expects us to be listening on &#x27;&quot;</span> + expectedQueueNames + <span class="string">&quot;&#x27;; our queues: &quot;</span> + Arrays.asList(queueNames));</span><br><span class="line">               <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">               String[] var4 = queueNames;</span><br><span class="line">               <span class="keyword">int</span> var5 = queueNames.length;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var5; ++var6) &#123;</span><br><span class="line">                   String queueName = var4[var6];</span><br><span class="line">                   <span class="keyword">if</span> (!expectedQueueNames.contains(queueName)) &#123;</span><br><span class="line">                       found = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   found = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               Assert.state(found, () -&gt; &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="string">&quot;Listener expects us to be listening on &#x27;&quot;</span> + expectedQueueNames + <span class="string">&quot;&#x27;; our queues: &quot;</span> + Arrays.asList(queueNames);</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 调用父类doStart()方法，主要是active和running都设置成true</span></span><br><span class="line">       <span class="keyword">super</span>.doStart();</span><br><span class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.consumers != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;A stopped container should not have consumers&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 创建BlockingQueueConsumer类型consumer，每个concurrentConsumers并发对应创建一个对象，并存储到Set consumers集合中，返回值就是创建consumer对象个数</span></span><br><span class="line">               <span class="comment">// 具体创建逻辑见：SimpleMessageListenerContainer#createBlockingQueueConsumer</span></span><br><span class="line">               <span class="comment">// 主要注意下prefetchCount计算： int actualPrefetchCount = getPrefetchCount() &gt; this.batchSize ? getPrefetchCount() : this.batchSize;</span></span><br><span class="line">               <span class="comment">// 即如果prefetchCount大于batchSize，则其就是实际值，否则prefetchCount等于batchSize值</span></span><br><span class="line">               <span class="keyword">int</span> newConsumers = <span class="keyword">this</span>.initializeConsumers();</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">this</span>.consumers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">this</span>.logger.info(<span class="string">&quot;Consumers were initialized and then cleared (presumably the container was stopped concurrently)&quot;</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newConsumers &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</span><br><span class="line">                       <span class="keyword">this</span>.logger.info(<span class="string">&quot;Consumers are already running&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   Set&lt;SimpleMessageListenerContainer.AsyncMessageProcessingConsumer&gt; processors = <span class="keyword">new</span> HashSet();</span><br><span class="line">                   Iterator var12 = <span class="keyword">this</span>.consumers.iterator();</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">while</span>(var12.hasNext()) &#123;</span><br><span class="line">     <span class="comment">// 将BlockingQueueConsumer对象封装成AsyncMessageProcessingConsumer进行异步执行 </span></span><br><span class="line">                       BlockingQueueConsumer consumer = (BlockingQueueConsumer)var12.next();</span><br><span class="line">                       SimpleMessageListenerContainer.AsyncMessageProcessingConsumer processor = <span class="keyword">new</span> SimpleMessageListenerContainer.AsyncMessageProcessingConsumer(consumer);</span><br><span class="line">                       <span class="comment">// 存储到processors集合中 </span></span><br><span class="line">                       processors.add(processor);</span><br><span class="line">                       <span class="comment">// 将AsyncMessageProcessingConsumer丢到线程池中执行</span></span><br><span class="line">                       <span class="keyword">this</span>.getTaskExecutor().execute(processor);</span><br><span class="line">                       <span class="comment">// 事件发送</span></span><br><span class="line">                       <span class="keyword">if</span> (<span class="keyword">this</span>.getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           <span class="keyword">this</span>.getApplicationEventPublisher().publishEvent(<span class="keyword">new</span> AsyncConsumerStartedEvent(<span class="keyword">this</span>, consumer));</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   var12 = processors.iterator();</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// 判断启动过程中是否存在异常</span></span><br><span class="line">                   FatalListenerStartupException startupException;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (!var12.hasNext()) &#123;</span><br><span class="line">                           <span class="keyword">return</span>;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       SimpleMessageListenerContainer.AsyncMessageProcessingConsumer processor = (SimpleMessageListenerContainer.AsyncMessageProcessingConsumer)var12.next();</span><br><span class="line">                       startupException = processor.getStartupException();</span><br><span class="line">                   &#125; <span class="keyword">while</span>(startupException == <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> AmqpIllegalStateException(<span class="string">&quot;Fatal exception on listener startup&quot;</span>, startupException);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>上面代码大致逻辑：<code>BlockingQueueConsumer</code> 对象可以看成 <code>consumer</code> ，然后将其包装成 <code>AsyncMessageProcessingConsumer</code> 异步任务丢入到线程池中运行。</p><p>异步任务：主要接口为AsyncMessageProcessingConsumer#run。</p><h5 id="AsyncMessageProcessingConsumer-run"><a href="#AsyncMessageProcessingConsumer-run" class="headerlink" title="AsyncMessageProcessingConsumer#run"></a>AsyncMessageProcessingConsumer#run</h5><ol><li>若当前consumer没有设置任何监听队列，则没必要启动</li><li>初始化：<ul><li>通过AmqpAdmin重新声明创建交换器、队列、绑定。</li><li></li></ul></li><li>死循环</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 必须处于活跃状态</span></span><br><span class="line">         <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isActive()) &#123;</span><br><span class="line">             <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</span><br><span class="line">             <span class="keyword">int</span> consecutiveIdles = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">int</span> consecutiveMessages = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">this</span>.consumer.setLocallyTransacted(SimpleMessageListenerContainer.<span class="keyword">this</span>.isChannelLocallyTransacted());</span><br><span class="line">             String routingLookupKey = SimpleMessageListenerContainer.<span class="keyword">this</span>.getRoutingLookupKey();</span><br><span class="line">             <span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 SimpleResourceHolder.bind(SimpleMessageListenerContainer.<span class="keyword">this</span>.getRoutingConnectionFactory(), routingLookupKey);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表示当前consumer没有设置任何监听队列，则没必要启动</span></span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">this</span>.consumer.getQueueCount() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Consumer stopping; no queues for &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">                 &#125;</span><br><span class="line">                 SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">                 <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.getApplicationEventPublisher().publishEvent(<span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">this</span>.start.countDown();</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 1.初始化</span></span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                         <span class="comment">// 通过AmqpAdmin重新声明创建交换器、队列、绑定</span></span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.redeclareElementsIfNecessary();</span><br><span class="line">                         <span class="keyword">this</span>.consumer.start();</span><br><span class="line">                         <span class="keyword">this</span>.start.countDown();</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (QueuesNotAvailableException var34) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isMissingQueuesFatal()) &#123;</span><br><span class="line">                             <span class="keyword">throw</span> var34;</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line">                         <span class="keyword">this</span>.start.countDown();</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.handleStartupFailure(<span class="keyword">this</span>.consumer.getBackOffExecution());</span><br><span class="line">                         <span class="keyword">throw</span> var34;</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (FatalListenerStartupException var35) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isPossibleAuthenticationFailureFatal()) &#123;</span><br><span class="line">                             <span class="keyword">throw</span> var35;</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line">                         Throwable possibleAuthException = var35.getCause().getCause();</span><br><span class="line">                         <span class="keyword">if</span> (possibleAuthException != <span class="keyword">null</span> &amp;&amp; possibleAuthException <span class="keyword">instanceof</span> PossibleAuthenticationFailureException) &#123;</span><br><span class="line">                             <span class="keyword">this</span>.start.countDown();</span><br><span class="line">                             SimpleMessageListenerContainer.<span class="keyword">this</span>.handleStartupFailure(<span class="keyword">this</span>.consumer.getBackOffExecution());</span><br><span class="line">                             <span class="keyword">throw</span> possibleAuthException;</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line">                         <span class="keyword">throw</span> var35;</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (Throwable var36) &#123;</span><br><span class="line">                         <span class="keyword">this</span>.start.countDown();</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.handleStartupFailure(<span class="keyword">this</span>.consumer.getBackOffExecution());</span><br><span class="line">                         <span class="keyword">throw</span> var36;</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.getTransactionManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         ConsumerChannelRegistry.registerConsumerChannel(<span class="keyword">this</span>.consumer.getChannel(), SimpleMessageListenerContainer.<span class="keyword">this</span>.getConnectionFactory());</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 死循环</span></span><br><span class="line">                     <span class="keyword">while</span>(SimpleMessageListenerContainer.<span class="keyword">this</span>.isActive(<span class="keyword">this</span>.consumer) || <span class="keyword">this</span>.consumer.hasDelivery() || !<span class="keyword">this</span>.consumer.cancelled()) &#123;</span><br><span class="line">                         <span class="keyword">try</span> &#123;</span><br><span class="line">                             <span class="keyword">boolean</span> receivedOk = SimpleMessageListenerContainer.<span class="keyword">this</span>.receiveAndExecute(<span class="keyword">this</span>.consumer);</span><br><span class="line">                             <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.maxConcurrentConsumers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                 <span class="keyword">if</span> (receivedOk) &#123;</span><br><span class="line">                                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isActive(<span class="keyword">this</span>.consumer)) &#123;</span><br><span class="line">                                         consecutiveIdles = <span class="number">0</span>;</span><br><span class="line">                                         <span class="keyword">if</span> (consecutiveMessages++ &gt; SimpleMessageListenerContainer.<span class="keyword">this</span>.consecutiveActiveTrigger) &#123;</span><br><span class="line">                                             SimpleMessageListenerContainer.<span class="keyword">this</span>.considerAddingAConsumer();</span><br><span class="line">                                             consecutiveMessages = <span class="number">0</span>;</span><br><span class="line">                                         &#125;</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                     consecutiveMessages = <span class="number">0</span>;</span><br><span class="line">                                     <span class="keyword">if</span> (consecutiveIdles++ &gt; SimpleMessageListenerContainer.<span class="keyword">this</span>.consecutiveIdleTrigger) &#123;</span><br><span class="line">                                         SimpleMessageListenerContainer.<span class="keyword">this</span>.considerStoppingAConsumer(<span class="keyword">this</span>.consumer);</span><br><span class="line">                                         consecutiveIdles = <span class="number">0</span>;</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line"></span><br><span class="line">                             <span class="keyword">long</span> idleEventInterval = SimpleMessageListenerContainer.<span class="keyword">this</span>.getIdleEventInterval();</span><br><span class="line">                             <span class="keyword">if</span> (idleEventInterval &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                                 <span class="keyword">if</span> (receivedOk) &#123;</span><br><span class="line">                                     SimpleMessageListenerContainer.<span class="keyword">this</span>.updateLastReceive();</span><br><span class="line">                                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                     <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">                                     <span class="keyword">long</span> lastAlertAt = SimpleMessageListenerContainer.<span class="keyword">this</span>.lastNoMessageAlert.get();</span><br><span class="line">                                     <span class="keyword">long</span> lastReceive = SimpleMessageListenerContainer.<span class="keyword">this</span>.getLastReceive();</span><br><span class="line">                                     <span class="keyword">if</span> (now &gt; lastReceive + idleEventInterval &amp;&amp; now &gt; lastAlertAt + idleEventInterval &amp;&amp; SimpleMessageListenerContainer.<span class="keyword">this</span>.lastNoMessageAlert.compareAndSet(lastAlertAt, now)) &#123;</span><br><span class="line">                                         SimpleMessageListenerContainer.<span class="keyword">this</span>.publishIdleContainerEvent(now - lastReceive);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125; <span class="keyword">catch</span> (ListenerExecutionFailedException var37) &#123;</span><br><span class="line">                             <span class="keyword">if</span> (var37.getCause() <span class="keyword">instanceof</span> NoSuchMethodException) &#123;</span><br><span class="line">                                 <span class="keyword">throw</span> <span class="keyword">new</span> FatalListenerExecutionException(<span class="string">&quot;Invalid listener&quot;</span>, var37);</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125; <span class="keyword">catch</span> (AmqpRejectAndDontRequeueException var38) &#123;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (InterruptedException var39) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Consumer thread interrupted, processing stopped.&quot;</span>);</span><br><span class="line">                     Thread.currentThread().interrupt();</span><br><span class="line">                     aborted = <span class="keyword">true</span>;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer thread interrupted, processing stopped&quot;</span>, <span class="keyword">true</span>, var39);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (QueuesNotAvailableException var40) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer received fatal=&quot;</span> + SimpleMessageListenerContainer.<span class="keyword">this</span>.isMismatchedQueuesFatal() + <span class="string">&quot; exception on startup&quot;</span>, var40);</span><br><span class="line">                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isMissingQueuesFatal()) &#123;</span><br><span class="line">                         <span class="keyword">this</span>.startupException = var40;</span><br><span class="line">                         aborted = <span class="keyword">true</span>;</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer queue(s) not available&quot;</span>, aborted, var40);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (FatalListenerStartupException var41) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, var41);</span><br><span class="line">                     <span class="keyword">this</span>.startupException = var41;</span><br><span class="line">                     aborted = <span class="keyword">true</span>;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, <span class="keyword">true</span>, var41);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (FatalListenerExecutionException var42) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, var42);</span><br><span class="line">                     aborted = <span class="keyword">true</span>;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, <span class="keyword">true</span>, var42);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (PossibleAuthenticationFailureException var43) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer received fatal=&quot;</span> + SimpleMessageListenerContainer.<span class="keyword">this</span>.isPossibleAuthenticationFailureFatal() + <span class="string">&quot; exception during processing&quot;</span>, var43);</span><br><span class="line">                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isPossibleAuthenticationFailureFatal()) &#123;</span><br><span class="line">                         <span class="keyword">this</span>.startupException = <span class="keyword">new</span> FatalListenerStartupException(<span class="string">&quot;Authentication failure&quot;</span>, <span class="keyword">new</span> AmqpAuthenticationException(var43));</span><br><span class="line">                         aborted = <span class="keyword">true</span>;</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer received PossibleAuthenticationFailure during startup&quot;</span>, aborted, var43);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (ShutdownSignalException var44) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (RabbitUtils.isNormalShutdown(var44)) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                             SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Consumer received Shutdown Signal, processing stopped: &quot;</span> + var44.getMessage());</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="keyword">this</span>.logConsumerException(var44);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (AmqpIOException var45) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (var45.getCause() <span class="keyword">instanceof</span> IOException &amp;&amp; var45.getCause().getCause() <span class="keyword">instanceof</span> ShutdownSignalException &amp;&amp; var45.getCause().getCause().getMessage().contains(<span class="string">&quot;in exclusive use&quot;</span>)) &#123;</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.getExclusiveConsumerExceptionLogger().log(SimpleMessageListenerContainer.<span class="keyword">this</span>.logger, <span class="string">&quot;Exclusive consumer failure&quot;</span>, var45.getCause().getCause());</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer raised exception, attempting restart&quot;</span>, <span class="keyword">false</span>, var45);</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="keyword">this</span>.logConsumerException(var45);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Error var46) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer thread error, thread abort.&quot;</span>, var46);</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(<span class="string">&quot;Consumer threw an Error&quot;</span>, <span class="keyword">true</span>, var46);</span><br><span class="line">                     aborted = <span class="keyword">true</span>;</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Throwable var47) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isActive()) &#123;</span><br><span class="line">                         <span class="keyword">this</span>.logConsumerException(var47);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                     <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.getTransactionManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         ConsumerChannelRegistry.unRegisterConsumerChannel();</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">this</span>.start.countDown();</span><br><span class="line">                 <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.isActive(<span class="keyword">this</span>.consumer) &amp;&amp; !aborted) &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.info(<span class="string">&quot;Restarting &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.restart(<span class="keyword">this</span>.consumer);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Cancelling &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line"></span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                         <span class="keyword">this</span>.consumer.stop();</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">                         <span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                             SimpleMessageListenerContainer.<span class="keyword">this</span>.getApplicationEventPublisher().publishEvent(<span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (AmqpException var33) &#123;</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.info(<span class="string">&quot;Could not cancel message consumer&quot;</span>, var33);</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                     <span class="keyword">if</span> (aborted &amp;&amp; SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort.compareAndSet((Object)<span class="keyword">null</span>, Thread.currentThread())) &#123;</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.logger.error(<span class="string">&quot;Stopping container from aborted consumer&quot;</span>);</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.stop();</span><br><span class="line">                         SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort.set((Object)<span class="keyword">null</span>);</span><br><span class="line">                         ListenerContainerConsumerFailedEvent event = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                         <span class="keyword">do</span> &#123;</span><br><span class="line">                             <span class="keyword">try</span> &#123;</span><br><span class="line">                                 event = (ListenerContainerConsumerFailedEvent)SimpleMessageListenerContainer.<span class="keyword">this</span>.abortEvents.poll(<span class="number">5L</span>, TimeUnit.SECONDS);</span><br><span class="line">                                 <span class="keyword">if</span> (event != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                     SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(event.getReason(), event.isFatal(), event.getThrowable());</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125; <span class="keyword">catch</span> (InterruptedException var32) &#123;</span><br><span class="line">                                 Thread.currentThread().interrupt();</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125; <span class="keyword">while</span>(event != <span class="keyword">null</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     SimpleResourceHolder.unbind(SimpleMessageListenerContainer.<span class="keyword">this</span>.getRoutingConnectionFactory());</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><h5 id="BlockingQueueConsumer-start"><a href="#BlockingQueueConsumer-start" class="headerlink" title="BlockingQueueConsumer#start"></a>BlockingQueueConsumer#start</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主要完成与`Rabbit Broker`指令交互</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">           logger.debug(<span class="string">&quot;Starting consumer &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.thread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.resourceHolder = ConnectionFactoryUtils.getTransactionalResourceHolder(<span class="keyword">this</span>.connectionFactory, <span class="keyword">this</span>.transactional);</span><br><span class="line">           <span class="keyword">this</span>.channel = <span class="keyword">this</span>.resourceHolder.getChannel();</span><br><span class="line">           ClosingRecoveryListener.addRecoveryListenerIfNecessary(<span class="keyword">this</span>.channel);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (AmqpAuthenticationException var8) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> FatalListenerStartupException(<span class="string">&quot;Authentication failure&quot;</span>, var8);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.deliveryTags.clear();</span><br><span class="line">       <span class="keyword">this</span>.activeObjectCounter.add(<span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">int</span> passiveDeclareRetries = <span class="keyword">this</span>.declarationRetries;</span><br><span class="line">       <span class="keyword">this</span>.declaring = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span>(!<span class="keyword">this</span>.cancelled()) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 校验监听队列是否存在</span></span><br><span class="line"><span class="comment">// `channel.queueDeclarePassive(queueName)`，最终会向`Rabbit Broker`发送`queue.declare`指令，并设置`passive=true`</span></span><br><span class="line">               <span class="keyword">this</span>.attemptPassiveDeclarations();</span><br><span class="line">               <span class="keyword">if</span> (passiveDeclareRetries &lt; <span class="keyword">this</span>.declarationRetries &amp;&amp; logger.isInfoEnabled()) &#123;</span><br><span class="line">                   logger.info(<span class="string">&quot;Queue declaration succeeded after retrying&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               passiveDeclareRetries = <span class="number">0</span>;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (BlockingQueueConsumer.DeclarationException var10) &#123;</span><br><span class="line">               <span class="keyword">if</span> (passiveDeclareRetries &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.channel.isOpen()) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                       logger.warn(<span class="string">&quot;Queue declaration failed; retries left=&quot;</span> + passiveDeclareRetries, var10);</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           Thread.sleep(<span class="keyword">this</span>.failedDeclarationRetryInterval);</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException var7) &#123;</span><br><span class="line">                           <span class="keyword">this</span>.declaring = <span class="keyword">false</span>;</span><br><span class="line">                           Thread.currentThread().interrupt();</span><br><span class="line">                           <span class="keyword">this</span>.activeObjectCounter.release(<span class="keyword">this</span>);</span><br><span class="line">                           <span class="keyword">throw</span> RabbitExceptionTranslator.convertRabbitAccessException(var7);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (var10.getFailedQueues().size() &gt;= <span class="keyword">this</span>.queues.length) &#123;</span><br><span class="line">                       <span class="keyword">this</span>.declaring = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">this</span>.activeObjectCounter.release(<span class="keyword">this</span>);</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> QueuesNotAvailableException(<span class="string">&quot;Cannot prepare queue for listener. Either the queue doesn&#x27;t exist or the broker will not allow us to use it.&quot;</span>, var10);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                       logger.warn(<span class="string">&quot;Not all queues are available; only listening on those that are - configured: &quot;</span> + Arrays.asList(<span class="keyword">this</span>.queues) + <span class="string">&quot;; not available: &quot;</span> + var10.getFailedQueues());</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">this</span>.missingQueues.addAll(var10.getFailedQueues());</span><br><span class="line">                   <span class="keyword">this</span>.lastRetryDeclaration = System.currentTimeMillis();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (passiveDeclareRetries-- &lt;= <span class="number">0</span> || <span class="keyword">this</span>.cancelled()) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.declaring = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">this</span>.acknowledgeMode.isAutoAck() &amp;&amp; !<span class="keyword">this</span>.cancelled()) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 最终会向`Rabbit Broker`发送`basic.qos`指令，并将`prefetch-size`、`prefetch-count`和`global`参数设置过去</span></span><br><span class="line">               <span class="keyword">this</span>.channel.basicQos(<span class="keyword">this</span>.prefetchCount);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">               <span class="keyword">this</span>.activeObjectCounter.release(<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> AmqpIOException(var6);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!<span class="keyword">this</span>.cancelled()) &#123;</span><br><span class="line">               String[] var2 = <span class="keyword">this</span>.queues;</span><br><span class="line">               <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">                   String queueName = var2[var4];</span><br><span class="line">                   <span class="keyword">if</span> (!<span class="keyword">this</span>.missingQueues.contains(queueName)) &#123;</span><br><span class="line"><span class="comment">// 会使用`channel.basicConsume`方法订阅消息，最终会向`Rabbit Broker`发送`basic.consume`指令，并指定订阅消息的`queue`名称等参数消息</span></span><br><span class="line"><span class="comment">// 注意：`SimpleMessageListenerContainer`可能设置多个监听队列，则`BlockingQueueConsumer`这里会给每个监听队列都向Broker发送一个`basic.consume`订阅指令，并且是使用同一个`channel`：</span></span><br><span class="line">                       <span class="keyword">this</span>.consumeFromQueue(queueName);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">           <span class="keyword">throw</span> RabbitExceptionTranslator.convertRabbitAccessException(var9);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>响应处理：</p><p>上面分析</p><ul><li><p><code>initialize()</code>初始化操作，客户端向<code>Broker</code>发送<code>basic.qos</code>和<code>basic.consume</code>指令就相当于告诉了服务器：我都准备好了，如果监听队列有消息你就把它推送给我，下面就来分析下<code>Broker</code>消息推送流程。</p></li><li><p>死循环：<code>Rabbit Broker</code>接收到<code>Basic.consume</code>指令后，会向客户端反馈<code>Basic.consume-ok</code>指令，表示服务端一切就绪准备给客户端推送消息，然后就通过<code>Basic.Deliver</code>指令类型将消息推送给客户端，一条消息对应一个<code>Deliver</code>反馈，客户端接收到服务端返回过来的指令类型后，在<code>ChannelN#processAsync</code>方法进行判断处理，它是<code>amqp-client</code>依赖包中类：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/1cea2b3e1b552149cc102993db8107b01612517532884" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析7"></p></li></ul><p>如果是Deliver类型指令，则调用 <code>processDelivery()</code> 方法进行处理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">void</span> <span class="function"><span class="title">processDelivery</span>(<span class="params">Command command, Basic.Deliver method</span>)</span> &#123; Basic.Deliver m = method; <span class="comment">//根据Deliver的consumerTag获取到InternalConsumer对象，因为一个Channel上可能存在多个consumer，需要找到Broker是针对哪个consumer进行的响应 Consumer callback = _consumers.get(m.getConsumerTag()); if (callback == null) &#123; if (defaultConsumer == null) &#123; // No handler set. We should blow up as this message // needs acking, just dropping it is not enough. See bug // 22587 for discussion. throw new IllegalStateException(&quot;Unsolicited delivery -&quot; + &quot; see Channel.setDefaultConsumer to handle this&quot; + &quot; case.&quot;); &#125; else &#123; callback = defaultConsumer; &#125; &#125; Envelope envelope = new Envelope(m.getDeliveryTag(), m.getRedelivered(), m.getExchange(), m.getRoutingKey()); try &#123; // call metricsCollector before the dispatching (which is async anyway) // this way, the message is inside the stats before it is handled // in case a manual ack in the callback, the stats will be able to record the ack metricsCollector.consumedMessage(this, m.getDeliveryTag(), m.getConsumerTag()); this.dispatcher.handleDelivery(callback, m.getConsumerTag(), envelope, (BasicProperties) command.getContentHeader(), command.getContentBody()); &#125; catch (WorkPoolFullException e) &#123; // couldn&#x27;t enqueue in work pool, propagating throw e; &#125; catch (Throwable ex) &#123; getConnection().getExceptionHandler().handleConsumerException(this, ex, callback, m.getConsumerTag(), &quot;handleDelivery&quot;); &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>processDelivery()</code>处理<code>Broker</code>返回的<code>Deliver</code>消息大致流程：</p><ul><li><p><code>Consumer callback = _consumers.get(m.getConsumerTag())</code>：根据<code>Deliver</code>的<code>consumerTag</code>获取到<code>InternalConsumer</code>对象，因为一个<code>Channel</code>上可能存在多个<code>consumer</code>，需要找到<code>Broker</code>是针对哪个<code>consumer</code>进行的响应</p></li><li><p>封装<code>Deliver</code>成<code>Envelope</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Envelope envelope = <span class="keyword">new</span> Envelope(m.getDeliveryTag(), m.getRedelivered(), m.getExchange(), m.getRoutingKey());</span><br></pre></td></tr></table></figure></li><li><p><code>metricsCollector.consumedMessage(this, m.getDeliveryTag(), m.getConsumerTag())</code>:统计数据处理</p></li><li><p>调用<code>ConsumerDispatcher#handleDelivery</code>，其会创建任务丢到线程池中执行，任务：将数据交由具体的<code>consumer</code>处理，即调用<code>InternalConsumer#handleDelivery</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.dispatcher.handleDelivery(callback, m.getConsumerTag(), envelope, (BasicProperties) command.getContentHeader(), command.getContentBody());</span><br></pre></td></tr></table></figure></li><li><p><code>InternalConsumer#handleDelivery()</code>方法：将<code>Broker</code>返回的<code>Deliver</code>数据放入到<code>BlockingQueueConsumer.queue</code>中：</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BlockingQueueConsumer.this.queue.put(<span class="keyword">new</span> Delivery(consumerTag, envelope, properties, body, <span class="built_in">this</span>.queueName));</span><br></pre></td></tr></table></figure><p>所以，如果<code>ListenerContainer</code>监听多个队列，则<code>BlockingQueueConsumer</code>中则对应多个<code>InternalConsumer</code>，每个<code>InternalConsumer</code>映射<code>Broker</code>上的一个，<code>BlockingQueueConsumer</code>下所有<code>InternalConsumer</code>共享同一个<code>queue</code>。</p><p>业务处理：</p><p>上面分析了消息订阅以及Broker推送过来的消息数据会被缓存到<code>BlockingQueueConsumer</code>对象的<code>queue</code>队列中，下面就来分析下从<code>queue</code>中提取消息到传递给用户业务逻辑这个流程。这就需要分析<code>AsyncMessageProcessingConsumer#run</code>方法中另一个非常重要操作：无限循环<code>mainLoop</code>操作，它主要就是完成从<code>queue</code>中提取消息数据然后经过一系列操作最终传递给用户逻辑<code>MessageListener</code>中。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">void</span> mainLoop() throws Exception &#123; <span class="comment">// NOSONAR Exception</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">  boolean receivedOk = receiveAndExecute(<span class="built_in">this</span>.consumer); <span class="comment">// At least one message received</span></span><br><span class="line">  <span class="keyword">if</span> (SimpleMessageListenerContainer.this.maxConcurrentConsumers != <span class="literal">null</span>) &#123; checkAdjust(receivedOk);</span><br><span class="line">  &#125;</span><br><span class="line">  long idleEventInterval = getIdleEventInterval();</span><br><span class="line">  <span class="keyword">if</span> (idleEventInterval &gt; <span class="number">0</span>) &#123; <span class="keyword">if</span> (receivedOk) &#123; updateLastReceive(); &#125; <span class="keyword">else</span> &#123; long now = System.currentTimeMillis(); long lastAlertAt = SimpleMessageListenerContainer.this.lastNoMessageAlert.get(); long lastReceive = getLastReceive(); <span class="keyword">if</span> (now &gt; lastReceive + idleEventInterval &amp;&amp; now &gt; lastAlertAt + idleEventInterval &amp;&amp; SimpleMessageListenerContainer.this.lastNoMessageAlert .compareAndSet(lastAlertAt, now)) &#123; publishIdleContainerEvent(now - lastReceive); &#125; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (ListenerExecutionFailedException ex) &#123;</span><br><span class="line">  <span class="comment">// Continue to process, otherwise re-throw</span></span><br><span class="line">  <span class="keyword">if</span> (ex.getCause() <span class="keyword">instanceof</span> NoSuchMethodException) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> FatalListenerExecutionException(<span class="string">&quot;Invalid listener&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span> (AmqpRejectAndDontRequeueException rejectEx) &#123;</span><br><span class="line">  <span class="comment">/* *  These will normally be wrapped by an LEFE if thrown by the *  listener, but we will also honor it if thrown by an</span></span><br><span class="line"><span class="comment">  *  error handler.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟踪下<code>doReceiveAndExecute()</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private boolean doReceiveAndExecute(BlockingQueueConsumer consumer) throws Exception &#123; <span class="comment">//NOSONAR</span></span><br><span class="line"></span><br><span class="line"> Channel channel = consumer.getChannel();</span><br><span class="line"></span><br><span class="line"> List messages = <span class="literal">null</span>;</span><br><span class="line"> long deliveryTag = <span class="number">0</span>; <span class="comment">//batchSize默认是1，用于指定一次从queue中提取消息数量</span></span><br><span class="line"> <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.batchsize; i++) &#123;&gt; afterReceivePostProcessors = getAfterReceivePostProcessors(); <span class="keyword">if</span> (afterReceivePostProcessors != <span class="literal">null</span>) &#123; Message original = message; deliveryTag = message.getMessageProperties().getDeliveryTag(); <span class="keyword">for</span> (MessagePostProcessor processor : getAfterReceivePostProcessors()) &#123; message = processor.postProcessMessage(message); <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123; channel.basicAck(deliveryTag, <span class="literal">false</span>); <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123; <span class="built_in">this</span>.logger.debug( <span class="string">&quot;Message Post Processor returned &#x27;null&#x27;, discarding message &quot;</span> + original); &#125; <span class="keyword">break</span>; &#125; &#125; &#125; <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123; <span class="keyword">if</span> (messages == <span class="literal">null</span>) &#123; messages = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="built_in">this</span>.batchSize); &#125; <span class="keyword">if</span> (isDeBatchingEnabled() &amp;&amp; getBatchingStrategy().canDebatch(message.getMessageProperties())) &#123; final List messageList = messages; getBatchingStrategy().deBatch(message, fragment -&gt; messageList.add(fragment)); &#125; <span class="keyword">else</span> &#123; messages.add(message); &#125; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123; messages = debatch(message); <span class="keyword">if</span> (messages != <span class="literal">null</span>) &#123; <span class="keyword">break</span>; &#125; <span class="keyword">try</span> &#123; <span class="comment">//执行MessageListener executeListener(channel, message); &#125; catch (ImmediateAcknowledgeAmqpException e) &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug(&quot;User requested ack for failed delivery &#x27;&quot; + e.getMessage() + &quot;&#x27;: &quot; + message.getMessageProperties().getDeliveryTag()); &#125; break; &#125; catch (Exception ex) &#123; if (causeChainHasImmediateAcknowledgeAmqpException(ex)) &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug(&quot;User requested ack for failed delivery: &quot; + message.getMessageProperties().getDeliveryTag()); &#125; break; &#125; if (getTransactionManager() != null) &#123; if (getTransactionAttribute().rollbackOn(ex)) &#123; RabbitResourceHolder resourceHolder = (RabbitResourceHolder) TransactionSynchronizationManager .getResource(getConnectionFactory()); if (resourceHolder != null) &#123; consumer.clearDeliveryTags(); &#125; else &#123; /* * If we don&#x27;t actually have a transaction, we have to roll back * manually. See prepareHolderForRollback(). */ consumer.rollbackOnExceptionIfNecessary(ex); &#125; throw ex; // encompassing transaction will handle the rollback. &#125; else &#123; if (this.logger.isDebugEnabled()) &#123; this.logger.debug(&quot;No rollback for &quot; + ex); &#125; break; &#125; &#125; else &#123; consumer.rollbackOnExceptionIfNecessary(ex); throw ex; &#125; &#125; &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (messages != <span class="literal">null</span>) &#123; executeWithList(channel, messages, deliveryTag, consumer);</span><br><span class="line">  &#125; <span class="keyword">return</span> consumer.commitIfNecessary(isChannelLocallyTransacted());</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>总结：</p><p>上面对<code>SimpleMessageListenerContainer</code>核心源码进行分析，比较枯燥不太直观，总结下其最核心就是位于<code>AsyncMessageProcessingConsumer#run</code>方法中两个操作：<code>initialize()</code>和无限循环<code>mainLoop()</code>。</p><p><code>initialize()</code>方法主要完成：通过指令方式将需要监听队列信息告诉<code>Rabbit Broker</code>，<code>Broker</code>在监听队列中有消息数据时通过<code>Deliver</code>指令将消息推送给客户端，客户端接收的<code>Deliver</code>指令后，根据<code>consumerTag</code>分发(<code>dispatcher</code>)给具体<code>consumer</code>，然后<code>consumer</code>将其放入到其所属<code>BlockingQueueConsumer</code>对象的队列<code>queue</code>中，其逻辑可见下图：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/58afc4c9952d12a7f18af4c48a0530d61612517532884" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析8"></p><p><code>BlockingQueueConsumer</code>、<code>AsyncMessageProcessingConsumer</code>、监听队列等关系：</p><p>1、<code>BlockingQueueConsumer</code>相当于一个逻辑消费者，通过封装成<code>AsyncMessageProcessingConsumer</code>异步任务，然后丢到线程池中运行，线程池可以通过<code>SimpleMessageListenerContainer#setTaskExecutor</code>进行自定义配置，所以，<code>BlockingQueueConsumer</code>可以看成单独线程运行，且对应一个<code>Channel</code>；</p><p>2、<code>SimpleMessageListenerContainer</code>可以监听多个队列消息，每个队列又会创建一个<code>InternalConsumer</code>对象，用于映射<code>Broker</code>上的<code>consumer</code>概念，它们是共用同一个<code>channel</code>，即<code>channel</code>下存在多个<code>consumer</code>，它们之间通过<code>consumerTag</code>区分，另外，<code>Broker</code>推送消息也是根据<code>consumerTag</code>识别具体推送给哪个<code>consumer</code>进行处理；</p><p>案例，比如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">container.setQueueNames(<span class="string">&quot;test01&quot;</span>, <span class="string">&quot;test02&quot;</span>);</span><br><span class="line">container.setConcurrentConsumers(<span class="number">3</span>);</span><br><span class="line">container.setConsumerTagStrategy(queue -&gt; <span class="string">&quot;consumer idx:&quot;</span>+consumerIdx.getAndIncrement());</span><br></pre></td></tr></table></figure><p>a、根据并发数<code>concurrentConsumers</code>创建对应数量的<code>BlockingQueueConsumer</code>，然后封装成<code>AsyncMessageProcessingConsumer</code>，再分配一个线程进行执行，这里设置成3，所以会有3个线程运行<code>AsyncMessageProcessingConsumer</code>，每个<code>AsyncMessageProcessingConsumer</code>对应一个channel，所以会创建3个channel，在Web UI上可以看到对应channel：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/13fe637438a9c721adc6711b97ec6e821612517532885" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析9"></p><p>b、每个监听队列创建一个<code>InternalConsumer</code>和Broker的consumer进行映射，这里有两个监听队列，所以每个channel下会存在2个consumer：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/900030467c62c0b1f34878b69da926141612517532885" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析10"></p><p><code>AsyncMessageProcessingConsumer</code>如何订阅：</p><p>a、首先发送<code>Basic.Qos</code>指令约定消息推送速率问题；</p><p>b、然后发送<code>Basic.Consume</code>指令告诉<code>Broker</code>客户端要开始订阅什么队列上的消息，以及把<code>consumerTag</code>带上，因为可能存在多个监听队列，则同一个<code>channel</code>上可能会发送多次<code>Basic.Consume</code>指令，<code>Broker</code>向<code>channel</code>推送消息时需要根据<code>consumerTag</code>找到对应<code>consumer</code>处理；</p><p>c、Broker通过Deliver指令类型方式向客户端推送消息，客户端接收到消息后，根据consumerTag找到对应consumer交由其进行处理，即分发dispatcher；</p><p>d、这里的consumer对应的是<code>InternalConsumer</code>，它处理逻辑就是放入到它所在的<code>BlockingQueueConsumer</code>对象中消息队列<code>queue</code>中；</p><p>mainLoop</p><hr><p>Broker推送过来的消息放入到了BlockingQueueConsumer对象的消息队列queue中，后续就是从queue中提取消息进行业务处理，逻辑见下图：</p><p><img src="https://res-static.hc-cdn.cn/fms/img/22d4831ca9b00a68417829fadee786621612517532886" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析11"></p><p>a、<code>AsyncMessageProcessingConsumer</code>被丢入到线程池中执行，则其对应一个线程；</p><p>b、这个线程会一直循环执行<code>mainLoop()</code>方法；</p><p>c、<code>mainLoop()</code>方法中就会从<code>queue中</code>提取消息，根据<code>batchSize</code>确定每次提取消息数量，最后回调<code>MessageListener</code>，实现将消息传递到业务逻辑进行处理；</p><p>d、注意：所有的<code>AsyncMessageProcessingConsumer</code>共用同一个<code>MessageListener</code>对象，对象状态要注意线程安全问题；</p><p>总体流程</p><hr><p><img src="https://res-static.hc-cdn.cn/fms/img/57ad7c2ab6ba47794d532f6fca2a51201612517532886" alt="【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析12"></p><p><a href="https://www.huaweicloud.com/articles/11961055.html">【RabbitMQ分析】01 SimpleMessageListenerContainer原理分析 - 华为云 (huaweicloud.com)</a></p><h4 id="MessageListenerContainer的创建"><a href="#MessageListenerContainer的创建" class="headerlink" title="MessageListenerContainer的创建"></a>MessageListenerContainer的创建</h4><p>首先看AbstractRabbitListenerContainerFactory抽象类的下面这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> C <span class="title">createListenerContainer</span><span class="params">(RabbitListenerEndpoint endpoint)</span> </span>&#123;</span><br><span class="line">C instance = createContainerInstance();</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">endpoint.setupListenerContainer(instance);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">initializeContainer(instance, endpoint);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意里面两个方法，后面这个方法里面SimpleRabbitListenerContainerFactory会做一些它独有的属性设置，前一个方法执行结束，MessageListener就设置到MessageListenerContainer里面去了，可以跟踪这个方法，一直到AbstractRabbitListenerEndpoint类的下面这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupMessageListener</span><span class="params">(MessageListenerContainer container)</span> </span>&#123;</span><br><span class="line">MessageListener messageListener = createMessageListener(container);</span><br><span class="line">Assert.state(messageListener != <span class="keyword">null</span>, () -&gt; <span class="string">&quot;Endpoint [&quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;] must provide a non null message listener&quot;</span>);</span><br><span class="line">container.setupMessageListener(messageListener);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到在这个方法里创建了MessageListener，并将其设置到MessageListenerContainer里面去。</p><p>createMessageListener()方法有两个实现，实际调用的是MethodRabbitListenerEndpoint类里面的实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> MessagingMessageListenerAdapter <span class="title">createMessageListener</span><span class="params">(MessageListenerContainer container)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">MessagingMessageListenerAdapter messageListener = createMessageListenerInstance();</span><br><span class="line">messageListener.setHandlerMethod(configureListenerAdapter(messageListener));</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> messageListener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看到setHandlerMethod(configureListenerAdapter(messageListener))这一行，这里创建并设置了一个HandlerAdapter，这个HandlerAdapter能够调用我们加了@RabbitListener注解的方法。</p><h4 id="SimpleMessageListenerContainer接收消息的实现"><a href="#SimpleMessageListenerContainer接收消息的实现" class="headerlink" title="SimpleMessageListenerContainer接收消息的实现"></a>SimpleMessageListenerContainer接收消息的实现</h4><p>SimpleRabbitListenerContainerFactory创建的MessageListenerContainer是SimpleMessageListenerContainer类，下面看它是怎么在启动后就能接收消息的。</p><p>上面讲过RabbitListenerEndpointRegistry类通过调用MessageListenerContainer的start()方法类启动这个MessageListenerContainer。</p><p>SimpleMessageListenerContainer类本身并没有实现start()方法，在它继承的抽象父类里面。进入AbstractMessageListenerContainer抽象类找到start()方法的实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (isRunning()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.lifecycleMonitor) &#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">afterPropertiesSet();</span><br><span class="line"><span class="keyword">this</span>.initialized = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Starting Rabbit listener container.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">configureAdminIfNeeded();</span><br><span class="line">checkMismatchedQueues();</span><br><span class="line">doStart();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> convertRabbitAccessException(ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>真正的启动方法是doStart()，所以去SimpleMessageListenerContainer类中找这个类的doStart()实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       </span><br><span class="line">           <span class="keyword">int</span> newConsumers = initializeConsumers();</span><br><span class="line">       </span><br><span class="line">           ...</span><br><span class="line">       </span><br><span class="line">           <span class="keyword">for</span> (BlockingQueueConsumer consumer : <span class="keyword">this</span>.consumers) &#123;</span><br><span class="line">AsyncMessageProcessingConsumer processor = <span class="keyword">new</span> AsyncMessageProcessingConsumer(consumer);</span><br><span class="line">processors.add(processor);</span><br><span class="line">getTaskExecutor().execute(processor);</span><br><span class="line"><span class="keyword">if</span> (getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">getApplicationEventPublisher().publishEvent(<span class="keyword">new</span> AsyncConsumerStartedEvent(<span class="keyword">this</span>, consumer));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个方法很长，细节就不去深究了，这里注意两个方法，一个是initializeConsumers()：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">initializeConsumers</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.consumers == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">this</span>.cancellationLock.reset();</span><br><span class="line"><span class="keyword">this</span>.consumers = <span class="keyword">new</span> HashSet&lt;BlockingQueueConsumer&gt;(<span class="keyword">this</span>.concurrentConsumers);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.concurrentConsumers; i++) &#123;</span><br><span class="line">BlockingQueueConsumer consumer = createBlockingQueueConsumer();</span><br><span class="line"><span class="keyword">this</span>.consumers.add(consumer);</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个方法创建了BlockingQueueConsumer，数量等于concurrentConsumers参数的配置。</p><p>另一个方法是getTaskExecutor().execute(processor)，前面用BlockingQueueConsumer创建了AsyncMessageProcessingConsumer（实现了Runnable接口），这里获取到Executor来执行，每一个MessageListenerContainer都有各自的Executor。</p><p>在AsyncMessageProcessingConsumer类的run()方法里面可以找到下面这段代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">while</span> (isActive(<span class="keyword">this</span>.consumer) || <span class="keyword">this</span>.consumer.hasDelivery() || !<span class="keyword">this</span>.consumer.cancelled()) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">boolean</span> receivedOk = receiveAndExecute(<span class="keyword">this</span>.consumer); <span class="comment">// At least one message received</span></span><br><span class="line"><span class="keyword">if</span> (SimpleMessageListenerContainer.<span class="keyword">this</span>.maxConcurrentConsumers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (receivedOk) &#123;</span><br><span class="line"><span class="keyword">if</span> (isActive(<span class="keyword">this</span>.consumer)) &#123;</span><br><span class="line">consecutiveIdles = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (consecutiveMessages++ &gt; SimpleMessageListenerContainer.<span class="keyword">this</span>.consecutiveActiveTrigger) &#123;</span><br><span class="line">considerAddingAConsumer();</span><br><span class="line">consecutiveMessages = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里有两个地方需要注意。</p><p>一个是<code>this.consumer.hasDelivery()</code> ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasDelivery</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> !<span class="keyword">this</span>.queue.isEmpty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Delivery&gt; queue;</span><br></pre></td></tr></table></figure><p>另一个要注意的是<code>receiveAndExecute()</code>方法，跟踪进去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doReceiveAndExecute</span><span class="params">(BlockingQueueConsumer consumer)</span> <span class="keyword">throws</span> Throwable </span>&#123; <span class="comment">//NOSONAR</span></span><br><span class="line"></span><br><span class="line">Channel channel = consumer.getChannel();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.txSize; i++) &#123;</span><br><span class="line"></span><br><span class="line">logger.trace(<span class="string">&quot;Waiting for message from consumer.&quot;</span>);</span><br><span class="line">Message message = consumer.nextMessage(<span class="keyword">this</span>.receiveTimeout);</span><br><span class="line"><span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">executeListener(channel, message);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>consumer.nextMessage(this.receiveTimeout);会从上面那个BlockingQueue里面拿一条消息出来。</p><p>所以SimpleMessageListenerContainer接收消息的实现方案是：用一个BlockingQueue保存rabbitmq发过来还未来得及处理的消息，然后向Executor提交执行Runnable，Runnable中循环从BlockingQueue里面取消息。</p><p>至于这个BlockingQueue里面的消息是怎么从rabbitmq获取到的，此处暂不讨论。</p><h4 id="MessageListener调用-RabbitListener注解方法处理消息的实现"><a href="#MessageListener调用-RabbitListener注解方法处理消息的实现" class="headerlink" title="MessageListener调用@RabbitListener注解方法处理消息的实现"></a>MessageListener调用@RabbitListener注解方法处理消息的实现</h4><p>上面的receiveAndExecute()方法接收消息的同时也将其处理了，继续跟踪，直到进入下面这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeListener</span><span class="params">(Channel channel, Message messageIn)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    invokeListener(channel, message);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这个方法里面可以看到invokeListener()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeListener</span><span class="params">(Channel channel, Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.proxy.invokeListener(channel, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有个proxy，这个proxy是由下面这个方法创建的匿名类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">actualInvokeListener</span><span class="params">(Channel channel, Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Object listener = getMessageListener();</span><br><span class="line"><span class="keyword">if</span> (listener <span class="keyword">instanceof</span> ChannelAwareMessageListener) &#123;</span><br><span class="line">doInvokeListener((ChannelAwareMessageListener) listener, channel, message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> MessageListener) &#123;</span><br><span class="line"><span class="keyword">boolean</span> bindChannel = isExposeListenerChannel() &amp;&amp; isChannelLocallyTransacted();</span><br><span class="line"><span class="keyword">if</span> (bindChannel) &#123;</span><br><span class="line">RabbitResourceHolder resourceHolder = <span class="keyword">new</span> RabbitResourceHolder(channel, <span class="keyword">false</span>);</span><br><span class="line">resourceHolder.setSynchronizedWithTransaction(<span class="keyword">true</span>);</span><br><span class="line">TransactionSynchronizationManager.bindResource(<span class="keyword">this</span>.getConnectionFactory(),</span><br><span class="line">resourceHolder);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">doInvokeListener((MessageListener) listener, message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (bindChannel) &#123;</span><br><span class="line"><span class="comment">// unbind if we bound</span></span><br><span class="line">TransactionSynchronizationManager.unbindResource(<span class="keyword">this</span>.getConnectionFactory());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> FatalListenerExecutionException(<span class="string">&quot;Only MessageListener and SessionAwareMessageListener supported: &quot;</span></span><br><span class="line">+ listener);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> FatalListenerExecutionException(<span class="string">&quot;No message listener specified - see property &#x27;messageListener&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个方法里可以看到doInvokeListener()方法，已经差不多接近我们的@RabbitListener注解的方法了，继续跟踪：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInvokeListener</span><span class="params">(ChannelAwareMessageListener listener, Channel channel, Message message)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">listener.onMessage(message, channelToUse);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> wrapToListenerExecutionFailedExceptionIfNeeded(e, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>跟踪listener.onMessage()方法，直到进入MessagingMessageListenerAdapter类的onMessage()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(org.springframework.amqp.core.Message amqpMessage, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Message&lt;?&gt; message = toMessagingMessage(amqpMessage);</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">&quot;Processing [&quot;</span> + message + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Object result = invokeHandler(amqpMessage, channel, message);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">handleResult(result, amqpMessage, channel, message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">logger.trace(<span class="string">&quot;No result object given - no result to handle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (ListenerExecutionFailedException e) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.errorHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Object result = <span class="keyword">this</span>.errorHandler.handleError(amqpMessage, message, e);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">handleResult(result, amqpMessage, channel, message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">logger.trace(<span class="string">&quot;Error handler returned no result&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">returnOrThrow(amqpMessage, channel, message, ex, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">returnOrThrow(amqpMessage, channel, message, e.getCause(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里通过invokHandler()方法消费获取到的message，然后在catch里面处理异常，进入invokeHandler()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">invokeHandler</span><span class="params">(org.springframework.amqp.core.Message amqpMessage, Channel channel,</span></span></span><br><span class="line"><span class="params"><span class="function">Message&lt;?&gt; message)</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.handlerMethod.invoke(message, amqpMessage, channel);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (MessagingException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ListenerExecutionFailedException(createMessagingErrorMessage(<span class="string">&quot;Listener method could not &quot;</span> +</span><br><span class="line"><span class="string">&quot;be invoked with the incoming message&quot;</span>, message.getPayload()), ex, amqpMessage);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ListenerExecutionFailedException(<span class="string">&quot;Listener method &#x27;&quot;</span> +</span><br><span class="line"><span class="keyword">this</span>.handlerMethod.getMethodAsString(message.getPayload()) + <span class="string">&quot;&#x27; threw exception&quot;</span>, ex, amqpMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这里可以看到catch了所有的异常，也就是说只要是我们消费消息的方法里面抛出来的异常全都会被包装成ListenerExecutionFailedException，并且这个Exception里面把消息也放进去了。</p><p>这里的this.handlerMethod其实就是上面提到的HandlerAdapter，跟踪它的invoke()方法，看它是怎么调用我们@RabbitListener注解的方法的。</p><p>最后我们跟踪到InvocableHandlerMethod类的下面这个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doInvoke</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">ReflectionUtils.makeAccessible(getBridgedMethod());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getBridgedMethod().invoke(getBean(), args);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里通过getBridgedMethod()方法拿到的就是@RabbitListener注解的方法了，这是在刚开始处理@RabbitListener注解时就已经保存下来的，然后就可以利用反射来调用这个方法，这样就完成了接收并处理消息的整个流程。</p><h3 id="4-2-CachingConnectionFactory"><a href="#4-2-CachingConnectionFactory" class="headerlink" title="4.2 CachingConnectionFactory"></a>4.2 CachingConnectionFactory</h3><p>因为上一个项目中使用了RabbitMQ，但是当时没有考虑过性能的问题，今天觉得好像不对劲，大量的重复建立连接，造成了很大的性能浪费，于是我就找呀找，发现Spring提供了一种RabbitMQ连接池，所以今天我们来看一下它是如何设计的。</p><ul><li><p>CachingConnectionFactory</p><p>CachingConnectionFactory为我们提供了两种缓存的模式：</p><ul><li>CHANNEL模式：这也是CachingConnectionFactory的默认模式，在这种模式下，所有的createConnection（）方法实际上返回的都是同一个Connection，同样的Connection.close()方法是没用的，因为就一个，默认情况下，Connection中只缓存了一个Channel，在并发量不大的时候这种模式是完全够用的，当并发量较高的时候，我们可以setChannelCacheSize（）来增加Connection中缓存的Channel的数量。</li><li>CONNECTION模式：在CONNECTION模式下，每一次调用createConnection（）方法都会新建一个或者从缓存中获取，根据你设置的ConnectionCacheSize的大小，当小于的时候会采用新建的策略，当大于等于的时候会采用从缓存中获取的策略，与CHANNEL模式不同的是，CONNECTION模式对Connection和Channel都进行了缓存，最新版本的client中已经将Channel的缓存数量从1增加到了25，但是在并发量不是特别大的情况下，作用并不是特别明显。<br> <strong>使用CachingConnectionFactory需要注意的一点是：所有你获取的Channel对象必须要显式的关闭，所以finally中一定不要忘记释放资源，如果忘记释放，则可能造成连接池中没有资源可用</strong>。<br> 好了，我们来看一下创建Connection源码的实现：</li></ul></li><li><p>createConnection()</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    synchronized (<span class="keyword">this</span>.connectionMonitor) &#123;</span><br><span class="line"><span class="comment">// CHANNEL模式下，这里的connection是ChannelCachingConnectionProxy 代理对象</span></span><br><span class="line"><span class="comment">//这样做的目的是为Channel提供临时的存储空间（也就是缓存Channel），以便其他客户端调用 </span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.cacheMode == CacheMode.CHANNEL) &#123;</span><br><span class="line"><span class="comment">//确保Connection对象不为null，target是真实的连接</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.connection.target == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//第一次调用 createConnection 方法时 connection.target 值为 null，因此会调用 createBareConnection 方法创建出 SimpleConnection 赋值给 connection.target</span></span><br><span class="line"><span class="comment">//SimpleConnection 中delegate属性是真正的RabbitMQ 连接（AMQConnection）</span></span><br><span class="line">                    <span class="keyword">this</span>.connection.target = <span class="keyword">super</span>.createBareConnection();</span><br><span class="line">                    <span class="comment">// invoke the listener *after* this.connection is assigned</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.checkoutPermits.containsKey(<span class="keyword">this</span>.connection)) &#123;</span><br><span class="line"><span class="comment">// Map&lt;Connection, Semaphore&gt; checkoutPermits 中存放了信道的许可数量，也就是默认的25，通过信号量来同步资源</span></span><br><span class="line">                        <span class="keyword">this</span>.checkoutPermits.put(<span class="keyword">this</span>.connection, new Semaphore(<span class="keyword">this</span>.channelCacheSize));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.connection.closeNotified.<span class="keyword">set</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//向所有 ConnectionListener 发布 onCreate 事件</span></span><br><span class="line">                    getConnectionListener().onCreate(<span class="keyword">this</span>.connection);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.connection;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.cacheMode == CacheMode.CONNECTION) &#123;</span><br><span class="line"><span class="comment">//直接从缓存中获取</span></span><br><span class="line">                <span class="keyword">return</span> connectionFromCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>创建Channel的源码实现：</p><ul><li>createChannel（）</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">        Semaphore permits = null;</span><br><span class="line">//大于0的情况下才会通过 Semaphore 限制当前连接下可用的信道数量</span><br><span class="line">        if (this.channelCheckoutTimeout &gt; 0) &#123;</span><br><span class="line">//获取许可</span><br><span class="line">            permits = obtainPermits(connection);</span><br><span class="line">        &#125;</span><br><span class="line">//获取当前Connection的Channel代理集合</span><br><span class="line">        LinkedList&lt;ChannelProxy&gt; channelList = determineChannelList(connection, transactional);</span><br><span class="line">        ChannelProxy channel = null;</span><br><span class="line">        if (connection.isOpen()) &#123;</span><br><span class="line">//这里主要是从缓存中获取，在同步块中，先判断 channelList 是否为空，若不为空，则返回队列头部缓存的 ChannelProxy（要从队列中移除）。</span><br><span class="line">//如果没有可用的缓存信道，则通过 getCachedChannelProxy 方法创建新的 ChannelProxy。</span><br><span class="line">            channel = findOpenChannel(channelList, channel);</span><br><span class="line">            if (channel != null) &#123;</span><br><span class="line">                if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                    logger.trace(&quot;Found cached Rabbit Channel: &quot; + channel.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (channel == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">//创建新Channel 的过程</span><br><span class="line">                channel = getCachedChannelProxy(connection, channelList, transactional);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (RuntimeException e) &#123;</span><br><span class="line">                if (permits != null) &#123;</span><br><span class="line">                    permits.release();</span><br><span class="line">                    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(&quot;Could not get channel; released permit for &quot; + connection + &quot;, remaining:&quot;</span><br><span class="line">                                + permits.availablePermits());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return channel;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> ChannelProxy <span class="title">getCachedChannelProxy</span><span class="params">(ChannelCachingConnectionProxy connection,</span></span></span><br><span class="line"><span class="params"><span class="function">            LinkedList&lt;ChannelProxy&gt; channelList, <span class="keyword">boolean</span> transactional)</span> </span>&#123; <span class="comment">//NOSONAR LinkedList for addLast()</span></span><br><span class="line"><span class="comment">//通过Connection中delegate创建Channel对象</span></span><br><span class="line">        Channel targetChannel = createBareChannel(connection, transactional);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Creating cached Rabbit Channel from &quot;</span> + targetChannel);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//向所有 ChannelListener 发布 onCreate 事件</span></span><br><span class="line">        getChannelListener().onCreate(targetChannel, transactional);</span><br><span class="line">        Class&lt;?&gt;[] interfaces;</span><br><span class="line"><span class="comment">//通过 Proxy.newProxyInstance创建一个实现了ChannelProxy接口的动态代理对象。</span></span><br><span class="line"><span class="comment">//所有对该实例的方法调用都会转交给CachedChannelInvocationHandler 的 invoke 方法处理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.publisherConfirms || <span class="keyword">this</span>.publisherReturns) &#123;</span><br><span class="line">            interfaces = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; ChannelProxy.class, PublisherCallbackChannel.class &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            interfaces = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; ChannelProxy.class &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (ChannelProxy) Proxy.newProxyInstance(ChannelProxy.class.getClassLoader(),</span><br><span class="line">                interfaces, <span class="keyword">new</span> CachedChannelInvocationHandler(connection, targetChannel, channelList,</span><br><span class="line">                        transactional));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="五-案例"><a href="#五-案例" class="headerlink" title="五. 案例"></a>五. 案例</h2><h3 id="5-1-自动重连"><a href="#5-1-自动重连" class="headerlink" title="5.1 自动重连"></a>5.1 自动重连</h3><p>Spring AMQP提供了一些高级特性来解决协议错误或者代理失败发生时的恢复与自动重连：</p><ul><li>主要通过CachingConnectionFactory来实现；</li><li>使用RabbitAdmin进行自动声明也很有用处；</li><li>如果你比较在乎发送的质量，以也许会使用RabbitTemplate和SimpleMessageListenerContainer的channelTransacted属性，还有 SimpleMessageListenerContainer的Acknowledge.AUTO属性。</li></ul><p>自动声明交换器、队列和绑定：</p><ul><li>RabbitAdmin在启动的时候会声明exchange，queues和binding。它是延迟完成的，是在ConnectionListener中，所以如果在应用启动的时候消息代理不可用也没关系。</li><li>Connection被第一次使用的时候，监听器会被触发，admin这一特色会被应用。</li><li>监听器中的自动声明的另外一个好处是如果连接由于某种原因断了(代理挂掉，或者网络失灵)，下次连接时候它又会被启用。</li><li>注意：以这种方式启动队列必须要有固定的名称。要么显示声明，要么通过框架为AnonymousQueues自动生成。 AnonymousQueues不可以持久化，专属的，自动删除。</li><li>重点：自动声明只能在CachingConnectionFactory缓存模式是CHANNEL时候启用。这个限制的存在是因为专属的或者自动删除的队列和连接绑定。</li></ul><p>同步操作失败和重试选项：</p><ul><li>如果在使用RabbitTemplate同步操作的过程中丢失了到代理的连接，Spring AMQP会抛出AmqpException(通常是AmqpIOException)。</li><li>所以我们不会隐藏这一问题，所以你必须能够捕获并且响应这一异常。最简单处理方式是你认为连接断开，不是你这面的问题，重试这些操作。你可以手动的做这些，或者你可以使用Spring Retry来完成这些。</li><li>Spring Retry提供了一些AOP拦截器，重试的许多参数来简化重试。</li><li>Spring AMQP也提供了一些工厂来方便Spring Retry的创建。给你提供了强类型回调接口来实现定制的恢复逻辑。参看StatefulRetryOperationsInterceptor和StatelessRetryOperationsInterceptor获得更详细的说明。</li><li>如果没有事务或者事务在重试回调中，无状态重试就可以。</li><li>对于存在正在进行的事务或者要进行回滚，无状态重试并不适合。</li><li>在事务之间断开连接和事务回滚有着同样的效果，在这种情况下，有状态重试是最佳选择。</li></ul><p>从1.3版本开始，一个创建器API提供来用于装配拦截器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StatefulRetryOperationsInterceptor <span class="title">interceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RetryInterceptorBuilder.stateful()</span><br><span class="line">        .maxAttempts(<span class="number">5</span>)</span><br><span class="line">        .backOffOptions(<span class="number">1000</span>, <span class="number">2.0</span>, <span class="number">10000</span>) <span class="comment">// initialInterval, multiplier, maxInterval</span></span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只有重试的一部分功能可以通过这种方式来配置，如果需要更为高级的功能，你可以通过RetryTemplate来完成。</p><p>报文监听器和异步场景：</p><ul><li>如果MessageListener由于业务而失败而抛出异常，那么这个异常将会被消息监听器容器处理，接着它会处理另外一条消息。</li><li>如果这个错误是因为连接断开导致，那么接收消息的消费者必须必须取消并且重新启动。SimpleMessageListenerContainer无缝的处理了这些，并且记录了监听器被重新启动的日志。事实上，它会进行无限的反复尝试来启动这个消费者，如果消费者行为很糟糕否则它不会放弃。一个副作用是如果代理挂掉，它会不断尝试直到连接重新建立。</li><li>业务异常的处理和协议错误，连接断开的处理不一样，需要更多的考虑或者配置，尤其是在事务或者容器应答被启用的时候。在RabbitMQ2.8.x版本以前，对于dead letter没有明确的定义，所以因为业务处理异常而导致的拒绝或者回滚将导致消息被无限的发送下去。为了限制客户端重新发送的数目，以种选择是在监听器上使用 StatefulRetryOperationsInterceptor拦截器增强。这个监听器有一个恢复回调，这个回调中实现dead letter的行为。</li><li>另外一种处理方式，是设置rejectRqueued属性为false，这将导致所有的错误消息被丢弃。当RabbitMQ的版本是2.8.x或者是更高,这将使得消息转发到Dead Letter Exchange。</li><li>或者你可以抛出AmqpRejectAndDontRequeueException，这样阻止消息被重新塞入队列，不管defaultRequeueRejected是否设置。</li></ul><p>通常，两种技术可以结合使用。在增强链中使用StatefulRetryOperationsInterceptor，它的MessageRecover会抛出AmqpRejectAndDontRequeueException异常。如果尝试已经耗尽 MessageRecover将会被调用。默认的 MessageRecover简单的消费错误的消息，并且释放出警告信息。在这种情况下，消息得到了应答，但是不会被发送到Dead Letter Exchange。</p><p>从1.3版本开始，RepublishMessageRecoverer被提供在重试耗尽的情况下，来重新发布消息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">RetryOperationsInterceptor <span class="title">interceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RetryInterceptorBuilder.stateless()</span><br><span class="line">        .withMaxAttempts(<span class="number">5</span>)</span><br><span class="line">        .setRecoverer(newRepublishMessageRecoverer(amqpTemplate(), <span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重试异常分类： </p><ul><li>Spring Retry拥有很大的灵活性来决定什么样的异常可以出发重试。默认的情况下，所有的异常都会出发重试。在用户异常被包装在ListenerExecutionFailedException里面的情况下，我们需要分类器检测到异常起因。默认情况下，分类器只查看顶级异常。</li><li>自从Spring1.0.3开始，分类器BinaryExceptionClassifier有一个traverseCauses属性。当设置为true时，它将横向查找匹配的异常源。</li><li>为了使用这个分类器进行重试，使用SimpleRetryPolicy，它的构造函数中有最大尝试次数，异常Map，还有 traverseCauses选项。你需要将这个策略注入到RetryTemplate中。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerRabbitConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;consumerConnectionFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomCachingConnectionFactory <span class="title">consumerConnectionFactory</span><span class="params">(<span class="meta">@Value(&quot;$&#123;spring.rabbitmq.consumer.addresses&#125;&quot;)</span> String addresses,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                       <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.consumer.username&#125;&quot;)</span> String username,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                       <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.consumer.password&#125;&quot;)</span> String password,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                       <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.consumer.virtual-host&#125;&quot;)</span> String virtualHost)</span> </span>&#123;</span><br><span class="line">        CustomCachingConnectionFactory connectionFactory = <span class="keyword">new</span> CustomCachingConnectionFactory();</span><br><span class="line">        connectionFactory.setAddresses(addresses);</span><br><span class="line">        connectionFactory.setUsername(username);</span><br><span class="line">        connectionFactory.setPassword(password);</span><br><span class="line">        connectionFactory.setVirtualHost(virtualHost);</span><br><span class="line">        connectionFactory.setPublisherConfirms(<span class="keyword">true</span>);</span><br><span class="line">        connectionFactory.setConnectionListeners(Arrays.asList(<span class="keyword">new</span> ConnectionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;**********************创建rabbitmq链接:&#123;&#125;&quot;</span>, connectionFactory.getReBindings().size());</span><br><span class="line">                    Channel channel = connectionFactory.createConnection().createChannel(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">for</span> (CustomCachingConnectionFactory.ReBindingHandler reBinding : connectionFactory.getReBindings()) &#123;</span><br><span class="line">                        reBinding.reBinding(channel);</span><br><span class="line">                    &#125;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">&quot;----------------rabbitmq链接断开&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomCachingConnectionFactory</span> <span class="keyword">extends</span> <span class="title">CachingConnectionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;ReBindingHandler&gt; reBindings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ReBindingHandler&gt; <span class="title">getReBindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reBindings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomCachingConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addReBindingHandler</span><span class="params">(ReBindingHandler reBindingHandler)</span></span>&#123;</span><br><span class="line">        reBindings.add(reBindingHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReBindingHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 重新绑定队列，路由键绑定关系</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">reBinding</span><span class="params">(Channel channel)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue1ConsumerConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费者最小个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.minnum.task.consumers&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> minNumConsumers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费者最大个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.rabbitmq.maxnum.task.consumers&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxNumConsumers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换器名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE = <span class="string">&quot;exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE = <span class="string">&quot;queue1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 队列路由键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">&quot;routing1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;queue1ConsumerRabbitTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">queue1ConsumerRabbitTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Qualifier(&quot;consumerConnectionFactory&quot;)</span> CustomCachingConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        RabbitTemplate clientRabbitTemplate = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Channel channel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clientRabbitTemplate.setExchange(FUND_TASK_EXCHANGE);</span><br><span class="line">            connection = clientRabbitTemplate.getConnectionFactory().createConnection();</span><br><span class="line">            channel = connection.createChannel(<span class="keyword">false</span>);</span><br><span class="line">            beding(channel);</span><br><span class="line">            connectionFactory.addReBindingHandler((newchannel) -&gt; beding(newchannel));</span><br><span class="line">            logger.info(<span class="string">&quot;RabbitMQ连接成功(queue1)： exchange:&#123;&#125; queue:&#123;&#125; routing:&#123;&#125;&quot;</span>, EXCHANGE, ROUTING_KEY, ROUTING_KEY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AmqpException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;RabbitMQ连接异常(queue1)&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | TimeoutException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;RabbitMQ关闭异常(queue1)&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clientRabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beding</span><span class="params">(Channel channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE, <span class="string">&quot;topic&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            channel.queueDeclare(QUEUE, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            channel.queueBind(QUEUE, EXCHANGE, ROUTING_KEY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;RabbitMQ操作错误(queue1)&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;queue1ConsumerListenerContainerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleRabbitListenerContainerFactory <span class="title">queue1ConsumerListenerContainerFactory</span><span class="params">(SimpleRabbitListenerContainerFactoryConfigurer configurer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                                        <span class="meta">@Qualifier(&quot;consumerConnectionFactory&quot;)</span> ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        SimpleRabbitListenerContainerFactory factory = <span class="keyword">new</span> SimpleRabbitListenerContainerFactory();</span><br><span class="line">        factory.setConcurrentConsumers(minNumConsumers);</span><br><span class="line">        factory.setMaxConcurrentConsumers(maxNumConsumers);</span><br><span class="line">        configurer.configure(factory, connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue1Consumer <span class="title">queue1Consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue1Consumer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-解决消息幂等性问题"><a href="#5-2-解决消息幂等性问题" class="headerlink" title="5.2 解决消息幂等性问题"></a>5.2 解决消息幂等性问题</h3><p>MQ消费者的幂等性问题，在于MQ的重试机制，因为网络原因或客户端延迟消费导致重复消费。</p><h4 id="5-2-1-RabbitMQ自动重试机制"><a href="#5-2-1-RabbitMQ自动重试机制" class="headerlink" title="5.2.1 RabbitMQ自动重试机制"></a>5.2.1 RabbitMQ自动重试机制</h4><p>消费者在消费消息的时候，如果消费者业务逻辑出现程序异常，这个时候我们如何处理？</p><ul><li>使用重试机制，RabbitMQ默认开启重试机制。</li></ul><p>实现原理：</p><ul><li><code>@RabbitHandler</code> 注解底层使用Aop拦截，如果程序（消费者）没有抛出异常，自动提交事务。</li><li>如果Aop使用异常通知拦截获取到异常后，自动实现补偿机制，消息缓存在RabbitMQ服务器端。</li></ul><p>注意：</p><ul><li>默认会一直重试到消费者不抛异常为止，这样显然不好。我们需要修改重试机制策略，如间隔3s重试一次)</li></ul><p>配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="comment"># 连接地址</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="comment"># 端口号</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="comment"># 账号</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="comment"># 地址(类似于数据库的概念)</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/admin_vhost</span></span><br><span class="line">    <span class="comment"># 消费者监听相关配置</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="comment"># 开启消费者(程序出现异常)重试机制，默认开启并一直重试</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">          <span class="comment"># 重试间隔时间(毫秒)</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><h4 id="5-2-2-如何合理选择重试机制？"><a href="#5-2-2-如何合理选择重试机制？" class="headerlink" title="5.2.2 如何合理选择重试机制？"></a>5.2.2 如何合理选择重试机制？</h4><ul><li>情况1：消费者获取到消息后，调用第三方接口，但接口暂时无法访问，是否需要重试？<ul><li>需要重试，可能是因为网络原因短暂不能访问。</li></ul></li><li>情况2：消费者获取到消息后，抛出数据转换异常，是否需要重试？<ul><li>不需要重试，因为属于程序bug，需要重新发布版本。</li></ul></li></ul><p>对于情况2，如果消费者代码抛出异常是需要发布新版本才能解决的问题，那么不需要重试，重试也无济于事。应该采用<strong>日志记录 + 定时任务job进行健康检查 + 人工进行补偿</strong>。</p><h4 id="5-2-3-调用第三方接口自动实现补偿机制"><a href="#5-2-3-调用第三方接口自动实现补偿机制" class="headerlink" title="5.2.3 调用第三方接口自动实现补偿机制"></a>5.2.3 调用第三方接口自动实现补偿机制</h4><p>我们知道RabbitMQ在消费者消费发生异常时，会自动进行补偿机制，所以我们（消费者）在调用第三方接口时，可以根据返回结果判断是否成功：</p><ul><li>成功：正常消费</li><li>失败：手动抛处一个异常，这时RabbitMQ自动给我们做重试 (补偿)。</li></ul><h4 id="5-2-4-如何解决消费者幂等性问题，防止重复消费"><a href="#5-2-4-如何解决消费者幂等性问题，防止重复消费" class="headerlink" title="5.2.4 如何解决消费者幂等性问题，防止重复消费"></a>5.2.4 如何解决消费者幂等性问题，防止重复消费</h4><ul><li>产生原因：网络延迟传输中，消费者出现异常或者消费者延迟消费，会造成进行MQ重试补偿，在重试过程中，可能会造成重复消费。</li><li>解决方案：<ol><li>使用全局MessageID判断消费者是否消费过，解决幂等性。</li><li>通过业务逻辑保证唯一，如订单编号。</li></ol></li></ul><p>生产者核心代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutProducer</span> </span>&#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String queueName)</span> </span>&#123;</span><br><span class="line">String msg = <span class="string">&quot;my_fanout_msg:&quot;</span> + System.currentTimeMillis();</span><br><span class="line"><span class="comment">//请求头设置消息id（messageId）</span></span><br><span class="line">Message message = MessageBuilder.withBody(msg.getBytes()).setContentType(MessageProperties.CONTENT_TYPE_JSON)</span><br><span class="line">.setContentEncoding(<span class="string">&quot;utf-8&quot;</span>).setMessageId(UUID.randomUUID() + <span class="string">&quot;&quot;</span>).build();</span><br><span class="line">System.out.println(msg + <span class="string">&quot;:&quot;</span> + msg);</span><br><span class="line">amqpTemplate.convertAndSend(queueName, message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>消费者核心代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout_email_queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">// 获取消息Id</span></span><br><span class="line">String messageId = message.getMessageProperties().getMessageId();</span><br><span class="line">String msg = <span class="keyword">new</span> String(message.getBody(), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"><span class="comment">//② 判断唯一Id是否被消费，消息消费成功后将id和状态保存在日志表中，我们从（①步骤）表中获取并判断messageId的状态即可</span></span><br><span class="line"><span class="comment">//从redis中获取messageId的value</span></span><br><span class="line">String value = redisUtils.get(messageId)+<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(value.equals(<span class="string">&quot;1&quot;</span>) )&#123; <span class="comment">//表示已经消费</span></span><br><span class="line"><span class="keyword">return</span>; <span class="comment">//结束</span></span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;邮件消费者获取生产者消息&quot;</span> + <span class="string">&quot;messageId:&quot;</span> + messageId + <span class="string">&quot;,消息内容:&quot;</span> + msg);</span><br><span class="line">JSONObject jsonObject = JSONObject.parseObject(msg);</span><br><span class="line"><span class="comment">// 获取email参数</span></span><br><span class="line">String email = jsonObject.getString(<span class="string">&quot;email&quot;</span>);</span><br><span class="line"><span class="comment">// 请求地址</span></span><br><span class="line">String emailUrl = <span class="string">&quot;http://127.0.0.1:8083/sendEmail?email=&quot;</span> + email;</span><br><span class="line">JSONObject result = HttpClientUtils.httpGet(emailUrl);</span><br><span class="line"><span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// 因为网络原因,造成无法访问,继续重试</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;调用接口失败!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;执行结束....&quot;</span>);</span><br><span class="line"><span class="comment">//① 执行到这里已经消费成功，我们可以修改messageId的状态，并存入日志表(可以存到redis中，key为消息Id、value为状态)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2-5-SpringBoot整合RabbitMQ应答模式-ACK"><a href="#5-2-5-SpringBoot整合RabbitMQ应答模式-ACK" class="headerlink" title="5.2.5 SpringBoot整合RabbitMQ应答模式(ACK)"></a>5.2.5 SpringBoot整合RabbitMQ应答模式(ACK)</h4><p>修改配置simple下添加 <code>acknowledge-mode: manual</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="comment"># 连接地址</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="comment"># 端口号</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="comment"># 账号</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="comment"># 地址(类似于数据库的概念)</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/admin_vhost</span></span><br><span class="line">    <span class="comment"># 消费者监听相关配置</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="comment"># 开启消费者(程序出现异常)重试机制，默认开启并一直重试</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">          <span class="comment"># 重试间隔时间(毫秒)</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="number">3000</span></span><br><span class="line">        <span class="comment"># 开启手动ack</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><p>消费者增加代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Long deliveryTag = (Long) headers.get(AmqpHeaders.DELIVERY_TAG); <span class="comment">// 手动ack</span></span><br><span class="line">channel.basicAck(deliveryTag, <span class="keyword">false</span>); <span class="comment">//手动签收</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//邮件队列</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutEamilConsumer</span> </span>&#123;</span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout_email_queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message, <span class="meta">@Headers</span> Map&lt;String, Object&gt; headers, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">System.out</span><br><span class="line">.println(Thread.currentThread().getName() + <span class="string">&quot;,邮件消费者获取生产者消息msg:&quot;</span> + <span class="keyword">new</span> String(message.getBody(), <span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line">+ <span class="string">&quot;,messageId:&quot;</span> + message.getMessageProperties().getMessageId());</span><br><span class="line"><span class="comment">// 手动ack</span></span><br><span class="line">Long deliveryTag = (Long) headers.get(AmqpHeaders.DELIVERY_TAG);</span><br><span class="line"><span class="comment">// 手动签收</span></span><br><span class="line">channel.basicAck(deliveryTag, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-限流"><a href="#5-3-限流" class="headerlink" title="5.3 限流"></a>5.3 限流</h3><p><strong>应用场景</strong>：如电商系统的抢购，瞬间有巨大流量生成，通过消息队列先进先出的特性，对请求进行削峰，控制消费的速度（限流）避免系统被挤爆。</p><h4 id="（1）通过配置文件实现"><a href="#（1）通过配置文件实现" class="headerlink" title="（1）通过配置文件实现"></a>（1）通过配置文件实现</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">concurrency:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">max-concurrency:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h4 id="（2）-RabbitListener"><a href="#（2）-RabbitListener" class="headerlink" title="（2）@RabbitListener"></a>（2）@RabbitListener</h4><p>利用 <code>@RabbitListener</code> 中的 <code>concurrency</code> 属性进行指定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootMsqConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;spring-boot-direct-queue&quot;,concurrency = &quot;5-10&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;receive message:&quot;</span> + <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最小5个，最大10个消费者。</p><p>单个消费者如果收到消息过多也可能存在风险，可以通过设置预取 <code>prefetch count</code> 来控制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootMsqConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;spring-boot-direct-queue&quot;,concurrency = &quot;5-10&quot;,containerFactory = &quot;mqConsumerlistenerContainer&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;receive message:&quot;</span> + <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CachingConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mqConsumerlistenerContainer&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleRabbitListenerContainerFactory <span class="title">mqConsumerlistenerContainer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleRabbitListenerContainerFactory factory = <span class="keyword">new</span> SimpleRabbitListenerContainerFactory();</span><br><span class="line">        factory.setConnectionFactory(connectionFactory);</span><br><span class="line">        factory.setPrefetchCount(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置成功后，<code>consumer</code> 单位时间内接收到消息就是50条。</p><hr><p>参考：</p><p>🔗 《<a href="https://www.docs4dev.com/docs/zh/spring-amqp/2.1.2.RELEASE/reference/_reference.html">Spring AMQP 中文文档</a>》</p><p>🔗 《<a href="https://blog.csdn.net/weixin_38380858/article/details/84258507">Spring整合rabbitmq实践（一）：基础使用配置</a>》</p><p>🔗 《<a href="https://blog.csdn.net/weixin_38380858/article/details/84258658">Spring整合rabbitmq实践（二）：扩展功能</a>》</p><p>🔗 《<a href="https://blog.csdn.net/qq_38252039/article/details/91409955">RabbitMQ解决消息幂等性问题</a>》</p><p>🔗 《<a href="https://blog.csdn.net/weixin_38380858/article/details/84963944">spring-rabbit消费过程解析及AcknowledgeMode选择</a>》</p><p>🔗 《<a href="https://www.jianshu.com/p/2e90f9070995">RabbitMQ连接池——CachingConnectionFactory</a>》</p>]]></content>
    
    
    <summary type="html">整理Spring AMQP相关文档。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="spring" scheme="http://linyishui.top/tags/spring/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="mom" scheme="http://linyishui.top/tags/mom/"/>
    
    <category term="rabbitmq" scheme="http://linyishui.top/tags/rabbitmq/"/>
    
    <category term="amqp" scheme="http://linyishui.top/tags/amqp/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ（十）扩展-消息追踪和负载均衡</title>
    <link href="http://linyishui.top/2021092501.html"/>
    <id>http://linyishui.top/2021092501.html</id>
    <published>2021-09-25T06:16:34.000Z</published>
    <updated>2021-11-04T10:54:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ（十）扩展"><a href="#RabbitMQ（十）扩展" class="headerlink" title="RabbitMQ（十）扩展"></a>RabbitMQ（十）扩展</h1><h2 id="一-消息追踪"><a href="#一-消息追踪" class="headerlink" title="一. 消息追踪"></a>一. 消息追踪</h2><p>使用消息中间件过程难免会遇到消息丢失的情况：</p><ul><li>可能是生产者与Broker断开了连接并且也没有任何重试机制；</li><li>可能是消费者在处理消息时发生了异常，但提前进行了ack；</li><li>可能是交换器没有与任何队列进行绑定，生产者感知不到或未采取相应的措施；</li><li>可能是RabbitMQ本身的集群策略导致消息的丢失。</li></ul><p>需要有一个好的机制来跟踪记录消息的投递过程，方便开发和运维人员快速定位问题。</p><h3 id="1-1-Firehose"><a href="#1-1-Firehose" class="headerlink" title="1.1 Firehose"></a>1.1 Firehose</h3><p>Firehose可以记录每一次发送或消费消息的记录。原理是将生产者投递给MQ的消息或MQ投递给消费者的消息按指定的格式发送到默认交换器 <code>amq.rabbitmq.trace</code> 上（topic类型）。路由键为 <code>publish.&#123;exchangename&#125;</code> 和 <code>deliver.&#123;queuename&#125;</code> 。前者对应生产者投递到交换器的消息，后者对应消费者从队列获取的消息。</p><p>开启/关闭Firehose：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl trace_on [-p vhost]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl trace_off [-p vhost]</span></span><br></pre></td></tr></table></figure><p>Firehose（多少会影响一点性能）默认关闭，且重启MQ后重置为默认。</p><p>创建7个队列，2个交换器与其中两个队列绑定，最后将交换器 <code>amq.rabbitmq.trace</code> 与其余5个队列绑定：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010120.png"></p><p>分别用客户端向exchange和exchange.another发送一条消息”trace test payload”，然后再用客户端消费队列queue和queue.another的消息。</p><p>此时queue1中有2条消息，queue2中有2条消息，queue3中有4条消息，而queue4和queue5中只有一条消息。</p><ul><li>在向exchange发送一条消息后，<code>amq.rabbitmq.trace</code> 分别向queue1、queue3和queue4发送一条内部封装消息。</li><li>在向exchange.another发送一条消息后，queue1和queue3多出一条消息。</li><li>消费queue的时候，queue2、queue3和queue5多出一条消息。</li><li>消费queue.another时，queue2和queue3多出一条消息。</li></ul><p>综述：</p><ul><li><code>publish.#</code> 匹配发送到所有交换器的消息。</li><li><code>deliver.#</code> 匹配消费所有队列的消息。</li><li><code>#</code> 则包含前两者。</li></ul><p>当有客户端发送或消费消息时，Firehose会自动封装相应的消息体，并添加详细的headers属性：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010121.png"></p><p>消费queue时，消息会封装为：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010122.png"></p><p>headers：</p><ul><li>exchange_name：发送消息的交换器。</li><li>routing_keys：对应路由键列表。</li><li>properties：消息本身的属性，如delivery_mode为2表示消息需要持久化处理。</li></ul><h3 id="1-2-rabbitmq-tracing插件"><a href="#1-2-rabbitmq-tracing插件" class="headerlink" title="1.2 rabbitmq_tracing插件"></a>1.2 rabbitmq_tracing插件</h3><p>rabbitmq_tracing插件相当于Firehose的GUI版本，同样能跟踪MQ中的消息流入流出，同样对消息进行封装并存入trace文件之中。</p><p>开启/关闭：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_tracing</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">disable</span> rabbitmq_tracing</span></span><br></pre></td></tr></table></figure><p>Web管理界面Admin会多出一栏Tracing：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010123.png"></p><p>添加Trace：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010124.png"></p><ul><li>Name：trace任务名称。</li><li>Format：输出的消息日志格式，有Text和JSON。</li><li>Max payload bytes：每条消息的最大限制，单位为B，达到上限会被截断。</li><li>Pattern：设置匹配的模式，<code>#</code> 匹配所有消息流入流出，<code>publish.#</code> 匹配所有消息流入，<code>deliver.#</code> 匹配所有消息流出。</li></ul><p>TEXT格式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010129.png"></p><p>JSON格式：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010130.png"></p><p>添加完毕后，根据匹配的规则将相应的消息日志输出到对应日志文件中，默认路径为 <code>/var/tmp/rabbitmq-tracing</code> ，也可以在页面直接点击Trace log files直接查看对应文件。</p><p>添加两个trace任务：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010125.png"></p><p>对应文件：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010126.png"></p><p>会多出两个队列：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010127.png"></p><p>查看第一个队列，绑定的交换器就是 <code>amq.rabbitmq.trace</code> ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010128.png"></p><p>可以看出 rabbitmq_tracing插件和Firehose如出一辙，只是多了层GUI方便使用和管理。</p><h4 id="（1）开启Tracing日志"><a href="#（1）开启Tracing日志" class="headerlink" title="（1）开启Tracing日志"></a>（1）开启Tracing日志</h4><ol><li><p>使用comp用户连接linux服务器</p></li><li><p>输入指令 <code>rabbitmqctl status</code> 确认MQ状态</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010101.png" alt="image-20210331171126692"></p><p><code>command not found</code>：不能识别命令，需要添加配置信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim .bash_profile</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/home/comp/rabbitmq/rabbitmq_server-3.7.5/sbin</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置信息，后使其生效</span></span><br><span class="line">source .bash_profile</span><br></pre></td></tr></table></figure></li><li><p>通过指令 <code>rabbitmq-plugins list</code> 查看MQ安装的插件，<code>E*</code> 表示已启用。对应文件路径：<code>/home/comp/rabbitmq/rabbitmq_server-3.7.5/sbin</code> </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010102.png" alt="image-20210331171303814"></p></li><li><p>找到 <code>rabbitmq_tracing</code> 确认是否启用，若未启用，则通过指令 <code>rabbitmq-plugins enable rabbitmq_tracing</code> 开启。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010103.png" alt="image-20210331171436966"></p></li><li><p>通过指令 <code>rabbitmqctl trace_on</code> 开启trace。</p></li><li><p>虚拟主机 server 开启trace：<code>rabbitmqctl trace_on -p server</code> ，添加完成后会多一个交换器：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010104.png" alt="image-20210331171813344"></p></li><li><p>RabbitMQ管理平台新建一个Trace，添加trace追踪文件信息：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010105.png" alt="image-20210331172359303"></p></li><li><p>创建的Trace文件：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010106.png" alt="image-20210331172219234"></p><p>若该步骤出错，如：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010107.png" alt="image-20210907173131624"></p><p>MQ的tracing插件默认使用guest用户，给它开下server权限应该就行了</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010108.png" alt="image-20210907183235365"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010109.png" alt="image-20210907183453592"></p><p>MQ日志路径：<code>/home/comp/rabbitmq/log</code> 。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 日志表示账号密码有问题</span></span><br><span class="line">2021-09-07 17:55:17.143 [info] &lt;0.2303.0&gt; Enabling tracing for vhost &#x27;server&#x27;</span><br><span class="line">2021-09-07 17:55:17.173 [error] &lt;0.3847.0&gt; Supervisor &#123;&lt;0.3847.0&gt;,rabbit_tracing_consumer_sup&#125; had child consumer started with rabbit_tracing_consumer:start_link([&#123;vhost,&lt;&lt;&quot;server&quot;&gt;&gt;&#125;,&#123;name,&lt;&lt;&quot;server-trace-log&quot;&gt;&gt;&#125;,&#123;format,&lt;&lt;&quot;text&quot;&gt;&gt;&#125;,&#123;pattern,&lt;&lt;&quot;#&quot;&gt;&gt;&#125;,&#123;&lt;&lt;&quot;for...&quot;&gt;&gt;,...&#125;,...]) at undefined exit with reason no match of right hand value &#123;error,&#123;auth_failure,&quot;Refused&quot;&#125;&#125; in rabbit_tracing_consumer:init/1 line 58 in context start_error</span><br><span class="line">2021-09-07 17:55:17.173 [error] &lt;0.3848.0&gt; CRASH REPORT Process &lt;0.3848.0&gt; with 0 neighbours exited with reason: no match of right hand value &#123;error,&#123;auth_failure,&quot;Refused&quot;&#125;&#125; in rabbit_tracing_consumer:init/1 line 58 in gen_server:init_it/6 line 352</span><br></pre></td></tr></table></figure></li><li><p>重新核算，触发消息发送。</p></li><li><p>查看步骤8的Trace文件，确认消息是否发送。</p></li></ol><p>如果给guest增加权限server仍不能创建Trac，直接重建guest用户：</p><ol><li><p>删除用户guest</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010110.png" alt="image-20210907194009362"></p></li><li><p>再创建用户guest，用户名密码相同。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/%E5%BE%85%E4%B8%8A%E4%BC%A0/202109010111.png" alt="image-20210907194048653"></p><p><img src="C:\Users\hspcadmin\AppData\Roaming\Typora\typora-user-images\image-20210907194122446.png" alt="image-20210907194122446"></p></li><li><p>增加权限：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010112.png" alt="image-20210907194148405"></p></li><li><p>重新创建Tracing：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010113.png" alt="image-20210907194213958"></p><p>创建成功：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010114.png" alt="image-20210907194229913"></p></li></ol><h4 id="（2）测试队列"><a href="#（2）测试队列" class="headerlink" title="（2）测试队列"></a>（2）测试队列</h4><p>除了开启Tracing排查消息是否投递到MQ，还可以新加一个测试Queue，绑定相同的交换器和路由键。因为无消费者，所以消息都堆积在队列中，通过GetMessage(n) + nack来获取所有消息，也可以ack或purge清空消息。</p><h3 id="1-3-案例：可靠性检测"><a href="#1-3-案例：可靠性检测" class="headerlink" title="1.3 案例：可靠性检测"></a>1.3 案例：可靠性检测</h3><p>生产者将消息发送到交换器时，实际上是由生产者所连接的信道将消息上的路由键同交换器的绑定列表比较，之后再路由消息到相应的队列进程中。    </p><p>那么在信道对比完绑定列表后，将消息路由到队列并保存的过程，是否会因为MQ的内部缺陷而引起偶发性的消息丢失？我们可以使用消息追踪机制来验证这一疑问，一个交换器通过同一个路由键绑定多个队列，生产者客户端采用同一个路由键发送消息到交换器，检测绑定的队列是否有消息丢失。</p><h4 id="（1）前期准备"><a href="#（1）前期准备" class="headerlink" title="（1）前期准备"></a>（1）前期准备</h4><ol><li>开启tracing插件。</li><li>创建一个交换器exchange和三个队列，都由同一个路由键rk绑定。</li><li>创建三个trace分别采用 <code>#.queue1</code> ，<code>#.queue2</code> ，<code>#.queue3</code> 的Pattern追踪各个队列。</li><li>创建一个trace：trace_publish采用 <code>publish.exchange</code> 追踪流入交换器的消息。</li></ol><h4 id="（2）验证过程"><a href="#（2）验证过程" class="headerlink" title="（2）验证过程"></a>（2）验证过程</h4><p>开启一个生产者现场，持续发消息到交换器，消息格式为当前时间戳+自增计数，从而在数据丢失时可以快速在trace日志中定位到。注意设置mandatory参数，防止消息路由不到对应队列而造成对消息丢失的误判。</p><p>消息发送前以[msg, QUEUE_NUM]的形式存入一个全局msgMap中，用来在消费端做数据验证，为3表示创建了三个队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, Integer&gt; msgMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;String&gt; log2disk = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProducerThread</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">            channel.addReturnListener((replyCode, replyText, exchange, routingKey, basicProperties, body) -&gt; &#123;</span><br><span class="line">                String errorInfo = <span class="string">&quot;Basic.Return: &quot;</span> + <span class="keyword">new</span> String(body) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log2disk.put(errorInfo);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(errorInfo);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                String message = System.currentTimeMillis() + <span class="string">&quot;-&quot;</span> + count++;</span><br><span class="line">                <span class="comment">// 存储消息一定要在发消息之前，否则消息被消费时msgMap中不一定会有相应的消息</span></span><br><span class="line">                <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                    msgMap.put(message, QUEUE_NUM);</span><br><span class="line">                &#125;</span><br><span class="line">                channel.basicPublish(exchange, routingKey, <span class="keyword">true</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// QPS=10，可以自适应调节，不宜过高防止队列堆积严重</span></span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，开启三个消费者线程分别消费是三个队列的消息，从存储的msgMap中寻找是否有相应消息，若有则计数减一并删除；若无，则报错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="keyword">private</span> String queue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerThread</span><span class="params">(Connection connection, String queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">            channel.basicQos(<span class="number">64</span>);</span><br><span class="line">            channel.basicConsume(<span class="keyword">this</span>.queue, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                    <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (msgMap.containsKey(msg)) &#123;</span><br><span class="line">                            <span class="keyword">int</span> count = msgMap.get(msg);</span><br><span class="line">                            count--;</span><br><span class="line">                            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                msgMap.put(msg, count);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                msgMap.remove(msg);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            String errorInfo = <span class="string">&quot;unknown msg : &quot;</span> + msg + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                log2disk.put(errorInfo);</span><br><span class="line">                                System.out.println(errorInfo);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                                ex.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，开启一个检测进程，每隔10分钟检测一下msgMap中的数据。对比消息中的时间戳和当前时间，如果差值超过10分钟，则说明可能有消息丢失。（该结论的前提是队列没有消息堆积，且消费消息的速度不低于生产消息的速度）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DetectThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MINUTES.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">synchronized</span> (msgMap) &#123;</span><br><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : msgMap.entrySet()) &#123;</span><br><span class="line">                    String msg = entry.getKey();</span><br><span class="line">                    <span class="keyword">if</span> (now - parseTime(msg) &gt;= <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">                        String findLossInfo = <span class="string">&quot;We find loss msg: &quot;</span> +</span><br><span class="line">                                msg + <span class="string">&quot; , now the time is: &quot;</span> + </span><br><span class="line">                                now + <span class="string">&quot;, and this msg still has &quot;</span> +</span><br><span class="line">                                entry.getValue() + <span class="string">&quot; missed\n&quot;</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            log2disk.put(findLossInfo);</span><br><span class="line">                            System.out.println(findLossInfo);</span><br><span class="line">                            msgMap.remove(msg);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                            ex.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">parseTime</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index = msg.indexOf(<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">    String timeStr = msg.substring(<span class="number">0</span>, index);</span><br><span class="line">    <span class="keyword">return</span> Long.parseLong(timeStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果检测到msgMap有超过10分钟的未处理消息，还不能说明有消息丢失，使用trace，如果看到[msg, count]这条数据有如下情况：</p><ul><li><strong>考虑count=3的情况。</strong>需要检索trace文件trace_publish.log来进一步验证，如果其中没搜到相应的消息说明消息未发送到交换器；如果搜索到消息，则要进一步检索trace1.log、trace2.log和trace3.log。如果3个文件不是全部都有此消息，则说明消息丢失。</li><li><strong>考虑0&lt;count&lt;3的情况。</strong>检索trace1.log、trace2.log和trace3.log。如果3个文件不是全部都有此消息，则说明消息丢失。</li><li><strong>考虑count=0的情况。</strong>说明检查程序异常，可以忽略。</li></ul><p>主线程部分代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Connection connection = connectionFactory.newConnection();</span><br><span class="line"><span class="comment">// 用来读取log2disk这个BlockingQueue中存储的异常日志，然后进行存盘处理，可以用log4j等代替</span></span><br><span class="line">PrintLogThread printLogThread = <span class="keyword">new</span> PrintLogThread(logFileAddr);</span><br><span class="line">ProducerThread producerThread = <span class="keyword">new</span> ProducerThread(connection);</span><br><span class="line">ConsumerThread consumerThread1 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue1&quot;</span>);</span><br><span class="line">ConsumerThread consumerThread2 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue2&quot;</span>);</span><br><span class="line">ConsumerThread consumerThread3 = <span class="keyword">new</span> ConsumerThread(connection, <span class="string">&quot;queue3&quot;</span>);</span><br><span class="line">DetectThread detectThread = <span class="keyword">new</span> DetectThread();</span><br><span class="line">System.out.println(<span class="string">&quot;starting check msg loss...&quot;</span>);</span><br><span class="line">ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">executorService.submit(printLogThread);</span><br><span class="line">executorService.submit(producerThread);</span><br><span class="line">executorService.submit(consumerThread1);</span><br><span class="line">executorService.submit(consumerThread2);</span><br><span class="line">executorService.submit(consumerThread3);</span><br><span class="line">executorService.submit(detectThread);</span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></table></figure><h2 id="二-负载均衡"><a href="#二-负载均衡" class="headerlink" title="二. 负载均衡"></a>二. 负载均衡</h2><p>大量业务访问、高并发请求的场景，需要用高性能的服务器来提升MQ的负载能力。假设一个集群中有3个节点，所有客户端都与node1建立TCP连接，则node1的网络负载会大大增加，其他节点又由于没有那么多负载而造成资源浪费。</p><p>对于RabbitMQ，客户端只会和集群中一个节点建立连接而不是整个集群。引入负载均衡后，各个客户端的连接会分摊到各个节点：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010131.png"></p><blockquote><p>负载均衡（Load Balance）是一种计算机网络技术，用于在多个计算机（集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最佳资源使用、最大化吞吐率、最小响应时间及避免过载的目的。</p><p>使用带有负载均衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。</p><p>负载均衡分为：</p><ul><li><strong>软件负载均衡：</strong>在一个或多个交互的网络系统中的多台服务器上安装一个或多个相应的负载均衡软件来实现的一种均衡负载技术。软件安装比较方便，技术配置简单，操作方便，成本很低。</li><li><strong>硬件负载均衡：</strong>多台服务器间安装相应的负载均衡设备，即负载均衡器。相比软件会有更好的负载均衡效果，但成本较高，适用于流量较大的大型网站系统。</li></ul></blockquote><h3 id="2-1-客户端内部实现负载均衡"><a href="#2-1-客户端内部实现负载均衡" class="headerlink" title="2.1 客户端内部实现负载均衡"></a>2.1 客户端内部实现负载均衡</h3><p>客户端连接可以任选一种负载均衡算法实现。</p><h4 id="（1）轮询法"><a href="#（1）轮询法" class="headerlink" title="（1）轮询法"></a>（1）轮询法</h4><p>将请求按顺序轮流分配到后端服务器上，不关心每台服务器实际的连接数和当前系统负载，调用 <code>RoundRobin.getConnectionAddress()</code> 获取连接地址。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 轮询法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ip = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            ip = list.get(pos);</span><br><span class="line">            <span class="keyword">if</span> (++pos &gt;= list.size()) &#123;</span><br><span class="line">                pos = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）加权轮询法"><a href="#（2）加权轮询法" class="headerlink" title="（2）加权轮询法"></a>（2）加权轮询法</h4><p>不同服务器的配置可能和当前系统的负载不同，抗压能力也不相同。所以应该给配置高、负载低的机器配置更高的权重，让其处理更多请求；</p><h4 id="（3）随机法"><a href="#（3）随机法" class="headerlink" title="（3）随机法"></a>（3）随机法</h4><p>通过随机算法，根据服务器列表大小值来任选一台服务器访问。由概率理论可知，随着调用服务端次数增多，实际效果会越来越接近轮询法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 随机法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomAccess</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> pos = random.nextInt(list.size());</span><br><span class="line">        <span class="keyword">return</span> list.get(pos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（4）加权随机法"><a href="#（4）加权随机法" class="headerlink" title="（4）加权随机法"></a>（4）加权随机法</h4><p>与加权轮询法相同，根据机器配置和负载分配不同权重，区别是其按照权重随机分配而非顺序。</p><h4 id="（5）源地址哈希法"><a href="#（5）源地址哈希法" class="headerlink" title="（5）源地址哈希法"></a>（5）源地址哈希法</h4><p>根据获取的客户端IP地址，通过哈希函数计算得到的一个数值，用此数值对服务器列表的大小进行取模运算，得到的结果便是客户端要访问服务器的序号。</p><p>采用该方法，同一IP地址的客户端在服务器列表不变的情况下，每次都会分配给同一台服务器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 源地址哈希法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpHash</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;()&#123;&#123;</span><br><span class="line">        add(<span class="string">&quot;192.168.0.2&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.3&quot;</span>);</span><br><span class="line">        add(<span class="string">&quot;192.168.0.4&quot;</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getConnectionAddress</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ipHashCode = InetAddress.getLocalHost().getHostAddress().hashCode();</span><br><span class="line">        <span class="keyword">int</span> pos = ipHashCode &amp; list.size();</span><br><span class="line">        <span class="keyword">return</span> list.get(pos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（6）最小连接数法"><a href="#（6）最小连接数法" class="headerlink" title="（6）最小连接数法"></a>（6）最小连接数法</h4><p>由于服务器配置不尽相同，对于请求的处理有快有慢，根据服务器当前连接情况，动态的选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能的提高对服务器的利用效率。</p><h3 id="2-2-使用HAProxy实现负载均衡"><a href="#2-2-使用HAProxy实现负载均衡" class="headerlink" title="2.2 使用HAProxy实现负载均衡"></a>2.2 使用HAProxy实现负载均衡</h3><p>HAProxy提供了高可用性、负载均衡及基于TCP和HTTP应用的代理，支持虚拟主机，是一种免费、快速且可靠的解决方案。实现了一种事件驱动、单一进程模型，支持较大的并发连接数。</p><h4 id="（1）安装"><a href="#（1）安装" class="headerlink" title="（1）安装"></a>（1）安装</h4><p><a href="http://www.haproxy.org/#down">官网下载</a>，<a href="http://www.haproxy.org/#doc1.7">官方文档</a>。</p><p>将下载的压缩包复制到 <code>/opt</code> 目录下，与RabbitMQ同一个目录，并解压：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tar zxvf haproxy-1.7.8.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> haproxy-1.7.8</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make指令将其编译为可执行程序，TARGET选择目标平台</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make TARGET=generic</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译后目录下有名为haproxy的可执行文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改系统配置</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/profile</span></span><br><span class="line">export PATH=$PATH:/opt/haproxy-1.7.8/haproxy</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br></pre></td></tr></table></figure><h4 id="（2）配置"><a href="#（2）配置" class="headerlink" title="（2）配置"></a>（2）配置</h4><p>HAProxy使用单一配置文件来定义所有属性：</p><ul><li>HAProxy主机：192.168.0.9:5671</li><li>RabbitMQ1：192.168.0.2:5672</li><li>RabbitMQ2：192.168.0.3:5672</li><li>RabbitMQ3：192.168.0.4:5672</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global</span></span><br><span class="line"><span class="comment"># 日志输出配置，所有日志都记录在本机，通过local0输出</span></span><br><span class="line"><span class="attr">log</span> <span class="string">127.0.0.1 local0 info</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="attr">maxconn</span> <span class="string">4096</span></span><br><span class="line"><span class="comment"># 改变当前的工作目录</span></span><br><span class="line"><span class="attr">chroot</span> <span class="string">/opt/haproxy-1.7.8</span></span><br><span class="line"><span class="comment"># 以指定的UID运行</span></span><br><span class="line"><span class="attr">uid</span> <span class="string">99</span></span><br><span class="line"><span class="comment"># 以指定的GID运行</span></span><br><span class="line"><span class="attr">gid</span> <span class="string">99</span></span><br><span class="line"><span class="comment"># 以守护进程方式运行 #debug #quiet</span></span><br><span class="line"><span class="attr">daemon</span></span><br><span class="line"><span class="comment">#debug</span></span><br><span class="line"><span class="comment"># 当前进程pid文件</span></span><br><span class="line"><span class="attr">pidfile</span> <span class="string">/opt/haproxy-1.7.8/haproxy.pid</span></span><br><span class="line"><span class="comment"># 默认配置</span></span><br><span class="line"><span class="attr">defaults</span></span><br><span class="line"><span class="comment"># 应用全局的日志配置</span></span><br><span class="line"><span class="attr">log</span> <span class="string">global</span></span><br><span class="line"><span class="comment"># 默认的模式mode&#123;tcp|http|health&#125;</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">tcp</span></span><br><span class="line"><span class="comment"># 日志类别tcplog</span></span><br><span class="line"><span class="attr">option</span> <span class="string">tcplog</span></span><br><span class="line"><span class="comment"># 不记录健康检查日志信息</span></span><br><span class="line"><span class="attr">option</span> <span class="string">dontlognull</span></span><br><span class="line"><span class="comment"># 3次失败则认为服务不可用</span></span><br><span class="line"><span class="meta">retries</span> <span class="string">3</span></span><br><span class="line"><span class="comment"># 每个进程可用的最大连接数</span></span><br><span class="line"><span class="attr">maxconn</span> <span class="string">2000</span></span><br><span class="line"><span class="comment"># 连接超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">connect 5s</span></span><br><span class="line"><span class="comment"># 客户端超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">client 120s</span></span><br><span class="line"><span class="comment"># 服务端超时</span></span><br><span class="line"><span class="attr">timeout</span> <span class="string">server 120s</span></span><br><span class="line"><span class="comment"># 绑定配置</span></span><br><span class="line"><span class="meta">listen</span> <span class="string">rabbitmq_cluster :5671</span></span><br><span class="line"><span class="comment"># 配置TCP模式</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">tcp</span></span><br><span class="line"><span class="comment"># 简单的轮询</span></span><br><span class="line"><span class="attr">balance</span> <span class="string">roundrobin</span></span><br><span class="line"><span class="comment"># RabbitMQ集群节点配置</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node1 192.168.0.2:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node2 192.168.0.3:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="meta">server</span> <span class="string">rmq_node3 192.168.0.4:5672 check inter 5000 rise 2 fall 3 weight 1</span></span><br><span class="line"><span class="comment">#haproxy监控页面地址</span></span><br><span class="line"><span class="meta">listen</span> <span class="string">monitor :8100</span></span><br><span class="line"><span class="attr">mode</span> <span class="string">http</span></span><br><span class="line"><span class="attr">option</span> <span class="string">httplog</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">enabnle</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">uri /stats</span></span><br><span class="line"><span class="meta">stats</span> <span class="string">refresh 5s</span></span><br></pre></td></tr></table></figure><p><code>server rmq_node1 192.168.0.2:5672 check inter 5000 rise 2 fall 3 weight 1</code> ：</p><ul><li><code>server &lt;name&gt;</code> ：定义RabbitMQ服务的内部标识，此处rmq_node1指有含义的字符串名称，而非节点名称。</li><li><code>&lt;ip&gt;:&lt;port&gt;</code> ：定义RabbitMQ服务连接的IP地址和端口号。</li><li><code>check inter &lt;value&gt;</code> ：定义每隔多少毫秒检查RabbitMQ服务是否可用。</li><li><code>rise &lt;value&gt;</code> ：定义RabbitMQ服务在发生故障后，需要多少次健康检查才能被再次确认可用。</li><li><code>fall &lt;value&gt;</code> ：定义需要经历多少次失败的健康检查后，HAProxy才会停止使用此RabbitMQ服务。</li><li><code>weight &lt;value&gt;</code>  ：定义当前RabbitMQ服务的权重。</li></ul><p>调用 <code>haproxy -f haproxy.cfg</code> 命令运行服务后，可以查看相关界面 <code>http://192.168.0.9:8100/stats</code> 。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010132.png"></p><h3 id="2-3-使用Keepalived实现高可靠负载均衡"><a href="#2-3-使用Keepalived实现高可靠负载均衡" class="headerlink" title="2.3 使用Keepalived实现高可靠负载均衡"></a>2.3 使用Keepalived实现高可靠负载均衡</h3><p>如果HAProxy主机突然宕机或网卡失效，MQ集群没有故障，但所有外界客户端的连接都会断开（单点问题），HAProxy无法保证负载均衡服务的可靠性。</p><p>通过Keepalived能够通过自身健康检查、资源接管功能做高可用（双机热备），实现故障转移。</p><p>Keepalived采用VRRP（Vistual Router Redundancy Protocol，虚拟路由冗余协议），以软件的形式实现服务的热备功能。通常将两台Linux服务器组出一个热备组（Master和Backup），同一时间内热备组只有一个Master提供服务，Master会虚拟出一个公用的虚拟IP地址（VIP），只存在于Master上并对外提供服务。当Keepalived检测到Master宕机或服务故障，备份服务器自动接管VIP并成为Master，原Master从热备组中被移除待恢复后再自动加入到热备组，默认再抢占成Master起到故障转移的功能。</p><p>Keepalived工作在OSI的：</p><ul><li>第三层：定期向热备组中的服务器发送一个ICMP数据包来判断某台服务器是否故障，如果故障则从热备组移除。</li><li>第四层：以TCP端口的状态判断服务器是否故障，比如检查MQ端口5672，如果故障则从热备组中移除。</li><li>第七层：根据用户设定的策略（通常是一个自定义的检测脚本）判断服务器上的程序是否正常运行，如果故障则从热备组中移除。</li></ul><h4 id="（1）安装-1"><a href="#（1）安装-1" class="headerlink" title="（1）安装"></a>（1）安装</h4><p><a href="http://keepalived.org/download.html">官网下载</a>。</p><p>解压并安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tar zxvf keepalived-1.3.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> keepalived-1.3.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据系统选择对应的启动方式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/opt/keepalived --with-init=SYSV</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将安装后的keepalived加入系统服务（注意千万不要输错命令）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/sysconfig/keepalived /etc/sysconfig</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/sbin/keepalived /usr/sbin/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x /etc/init.d/keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chkconfig --add keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chkconfig keepalived on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keepalived会默认读取/etc/keepalived/keepalived.conf 配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir /etc/keepalived</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/keepalived/etc/keepalived/keepalived.conf /etc/keepalived</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 之后就可以重启、启动、关闭和查看keepalived状态</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived restart</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived start</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived stop</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service keepalived status</span></span><br></pre></td></tr></table></figure><h4 id="（2）配置-1"><a href="#（2）配置-1" class="headerlink" title="（2）配置"></a>（2）配置</h4><p>安装流程已创建了 <code>/etc/keepalived</code> 目录，并将 <code>keepalived.conf </code> 文件复制到此供keepalived读取。更改此文件使keepalived与HAProxy结合。</p><p>两台keepalived服务器通过VRRP交互，对外虚拟出VIP，keepalived与HAProxy部署在同一台机器上，一一配对，从而通过keepalived来实现HAProxy的双机热备。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010133.png"></p><p>调用链路：</p><ul><li>客户端通过VIP创建通信链路；</li><li>通信链路通过keepalived的Master节点路由到对应的HAProxy上；</li><li>HAProxy通过负载均衡算法将负载分发到集群中各个节点上。</li></ul><p>修改配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># keepalived配置文件</span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id NodeA # 路由ID、主/备的ID不能相同</span><br><span class="line">&#125;</span><br><span class="line"># 自定义监控脚本</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">script &quot;/etc/keepalived/check_haproxy.sh&quot;</span><br><span class="line">interval 5</span><br><span class="line">weight 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER # keepalived的角色</span><br><span class="line">interface eth0 # 指定监测网卡</span><br><span class="line">virtual_router_id 1</span><br><span class="line">priority 100 # 优先级，BACKUP机器上优先级要小于此值</span><br><span class="line">advert_int 1 # 设置主备之间的检测时间，单位为s</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass root123</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; # VIP地址，可以设置多个</span><br><span class="line">192.168.0.10</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>BACKUP机器大致相同，需要修改 <code>global_defs</code> 的 router_id 为如NodeB；修改 <code>vrrp_script chk_haproxy</code> 的state为BACKUP；最后将priority设置为小于100的值。注意virtual_router_id要保持一致。</p><p>为了防止HAProxy挂掉后，keepalived还在正常工作而未切换到Backup，需要补充一个脚本来检测HAProxy的状态。当服务挂掉，脚本自动重启服务，若不成功则关闭keepalived服务，从而可以切换到Backup。该脚本对应 <code>vrrp_script chk_haproxy</code> 中的 script ：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0];<span class="keyword">then</span></span><br><span class="line">   haproxy -f /opt/haproxy-1.7.8/haproxy.cfg</span><br><span class="line"><span class="keyword">fi</span> </span><br><span class="line">sleep 2</span><br><span class="line"><span class="keyword">if</span> [ $(ps -C haproxy --no-header | wc -l) -eq 0];<span class="keyword">then</span></span><br><span class="line">       service keepalived stop</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>如此配置后，使用 <code>service keepalived start</code> 启动两台服务。客户端通过VIP地址 <code>192.168.0.10</code> 来连接MQ服务。</p><h4 id="（3）查看运行情况"><a href="#（3）查看运行情况" class="headerlink" title="（3）查看运行情况"></a>（3）查看运行情况</h4><p>查看Keepalived日志输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tail -f /var/<span class="built_in">log</span>/messages -n 200</span></span><br></pre></td></tr></table></figure><p>查看添加的VIP：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ip add show</span></span><br></pre></td></tr></table></figure><p>一般情况下，双机热备已足够满足应用需求。</p><h3 id="2-4-使用Keepalived-LVS实现负载均衡"><a href="#2-4-使用Keepalived-LVS实现负载均衡" class="headerlink" title="2.4 使用Keepalived+LVS实现负载均衡"></a>2.4 使用Keepalived+LVS实现负载均衡</h3><p>LVS，Linux Virtual Server，即Linux虚拟服务器。LVS是4层负载均衡，建立在OSI模型的传输层之上。LVS支持TCP/UDP的负载均衡，相对于如DNS域名流转解析、应用层负载的调度、客户端的调度等更高效。</p><p>通过LVS可以实现高可伸缩的、高可用的网络服务。LVS主要由3部分组成：</p><ul><li><strong>负载调度器（Load Balancer/Director）：</strong>负责将客户请求发送到一组服务器上执行，客户则认为服务来自一个IP地址。</li><li><strong>服务器池（Server Pool / RealServer）：</strong>一组真正执行客户端请求的服务器。</li><li><strong>共享存储（Shared Storage）：</strong>为服务器池提供一个共享的存储区，方便其拥有相同内容，提供相同服务。</li></ul><p>LVS的负载均衡方式：</p><ul><li><strong>VS/NAT：</strong>Virtual Server via Network Address Translation 的简称，最简单的方式，<strong>所有RealServer只需将自己的网关指向Director</strong>。客户端可以是任意的OS，但该方式下一个Director只能带动有限的RealServer。</li><li><strong>VS/TUN：</strong>Virtual Server via Direct Routing 的简称，IP隧道（IP Tunneling）是将一个IP报文封装在另一个IP报文的技术，<strong>使目标为一个IP地址的数据报文能够封装和转发到另一个IP地址</strong>。IP隧道技术又叫IP封装技术（IP encapsulation）。</li><li><strong>VS/DR：</strong>Virtual Server via Direct Routing 的简称，通过改写报文中的MAC地址部分来实现。Director和RealServer必须在物理上有一个网卡通过不间断的局域网相连。RealServer上绑定的VIP配置在各自Non-ARP网络设备上，Director的VIP地址对外可见；而RealServer则不可见，其地址既可以是内部地址，也可以是真实地址。</li></ul><p>LVS可以代替HAProxy，不需要额外的配置文件，直接集成在Keepalived的配置中，修改 <code>/etc/keepalived/keepalived.conf</code> ：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># keepalived配置文件（Master）</span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id NodeA # 路由ID、主/备的ID不能相同</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER # keepalived的角色</span><br><span class="line">interface eth0 # 指定监测网卡</span><br><span class="line">virtual_router_id 1</span><br><span class="line">priority 100 # 优先级，BACKUP机器上优先级要小于此值</span><br><span class="line">advert_int 1 # 设置主备之间的检测时间，单位为s</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass root123</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; # VIP地址，可以设置多个</span><br><span class="line">192.168.0.10</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">virtual_server 192.168.0.10 5672 &#123; # 设置虚拟服务器</span><br><span class="line">delay_loop 6 # 设置运行情况检查时间，单位为秒</span><br><span class="line"># 设置负载调度算法，有rr、wrr、lc、wlc、lblc、lblcr、dh、sh共8种</span><br><span class="line">lb_algo wrr # 加权轮询</span><br><span class="line">lb_kind DR # 设置LVS实现的负载均衡机制为VS/DR</span><br><span class="line"># 指定在一定的时间内来自统一IP的连接将会被转发到同一RealServer中</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocal TCP # 指定转发协议类型，包括TCP/UDP两种</span><br><span class="line"># LVS三大部分之一，此处特指RabbitMQ服务</span><br><span class="line">real_server 192.168.0.2 5672 &#123; # 配置服务节点</span><br><span class="line">weight 1 # 权重</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.3 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.4 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 5672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 为RabbitMQ Management插件设置负载均衡</span><br><span class="line">virtual_server 192.168.0.10 15672 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo wrr</span><br><span class="line">lb_kind DR</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocal TCP</span><br><span class="line">real_server 192.168.0.2 5672 &#123;</span><br><span class="line">weight 1</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.3 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.0.4 5672 &#123; </span><br><span class="line">weight 1 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 15672</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Backup配置参考上一节。</p><ul><li>LVS主要工作是提供调度算法，把客户端请求按需求调度在RealServer中，</li><li>Keepalived主要工作是提供LVS控制器的一个冗余，并对RealServer进行健康检查，发现不健康的从集群剔除。</li><li>RealServer只负载提供服务。</li></ul><p>VS/DR模式下需要在RealServer上配置VIP，因为LVS把客户端的包转发给RealServer时，因为包的目的IP地址是VIP，在RealServer收到包后发现目的地址不是自己系统的IP会认为其不是发给自己的，就会丢弃此包，需要把这个IP地址绑定到网卡下。当发送应答包给客户端，RealServer就会把包的源和目的地址调换，直接恢复给客户端。</p><p>为所有RealServer的lo:0网卡创建启动脚本（vim /opt/realserver.sh）绑定VIP地址：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">VIP=192.168.0.10</span><br><span class="line">/etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">   /sbin/ipconfig lo:0 <span class="variable">$VIP</span> netmask 255.255.255.255 broadcast <span class="variable">$VIP</span></span><br><span class="line">   /sbin/route add -host <span class="variable">$VIP</span> dev lo:0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">   sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;RealServer Start Ok&quot;</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">   /sbin/ipconfig lo:0 down</span><br><span class="line">   /sbin/route del -host <span class="variable">$VIP</span> dev lo:0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;0&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">;;</span><br><span class="line">status)</span><br><span class="line">   islothere=`/sbin/ipconfig lo:0 | grep <span class="variable">$VIP</span> | wc -l`</span><br><span class="line">   isrothere=`netstat -rn | grep <span class="string">&quot;lo:0&quot;</span> | grep <span class="variable">$VIP</span> | wc -l`</span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$islothere</span> -eq 0]</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isrothere</span> -eq 0]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Stoped.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Running.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;LVS of RealServer Running.&quot;</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage:<span class="variable">$0</span>&#123;start|stop&#125;&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p>掩码为 <code>255.255.255.255 </code> 表示广播地址是自身，不会将ARP发送到实际自己该属于的广播域，防止与LVS的VIP冲突而导致IP地址冲突。</p><p>为 <code>/opt/realserver.sh</code> 文件添加可执行权限后，运行 <code>/opt/realserver.sh start</code> 命令后可以通过 <code>ip add show</code> 命令查看网卡lo:0的状态，注意与Keepalived节点的网卡状态进行区分。</p><hr><p>参考：</p><p>🔗 《RabbitMQ实战指南》</p>]]></content>
    
    
    <summary type="html">学习RabbitMQ，第十章《扩展》，内容来自于《RabbitMQ实战指南》，内容：消息追踪，负载均衡等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="mom" scheme="http://linyishui.top/tags/mom/"/>
    
    <category term="rabbitmq" scheme="http://linyishui.top/tags/rabbitmq/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ（九）网络分区</title>
    <link href="http://linyishui.top/2021092201.html"/>
    <id>http://linyishui.top/2021092201.html</id>
    <published>2021-09-22T11:34:01.000Z</published>
    <updated>2021-09-26T06:14:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RabbitMQ（九）网络分区"><a href="#RabbitMQ（九）网络分区" class="headerlink" title="RabbitMQ（九）网络分区"></a>RabbitMQ（九）网络分区</h1><h2 id="一-MQ与网络分区"><a href="#一-MQ与网络分区" class="headerlink" title="一. MQ与网络分区"></a>一. MQ与网络分区</h2><h3 id="1-1-网络分区对RabbitMQ的影响"><a href="#1-1-网络分区对RabbitMQ的影响" class="headerlink" title="1.1 网络分区对RabbitMQ的影响"></a>1.1 网络分区对RabbitMQ的影响</h3><p>网络分区可能会引起消息丢失或服务不可用，可以通过重启或配置自动化处理来解决。</p><p>RabbitMQ一般使用Federation或Shovel来解决广域网中的问题，对于网络分区的容错性不高。局域网环境下也可能会出现网络分区（如中继设备或网卡出现故障）。</p><p>不同分区中的节点会认为不属于自身所在分区的节点都已经挂了，对于队列、交换器、绑定的操作仅对当前分区有效。RabbitMQ 3.1版本后会自动探测网络分区，并提供了相应配置来解决该问题。</p><p>若原集群中配置了镜像队列，其又牵扯到两个或更多网络分区的节点时，每个网络分区都会出现一个master节点，导致每个分区的该队列都相互独立。即使网络恢复，该问题也不能解决。</p><h3 id="1-2-为什么要引入网络分区？"><a href="#1-2-为什么要引入网络分区？" class="headerlink" title="1.2 为什么要引入网络分区？"></a>1.2 为什么要引入网络分区？</h3><p>镜像队列是一种环形的逻辑结构，如下图某队列有4个镜像，假设需要ack一条消息，会先在master节点上执行确认命令，之后转向B节点，再然后是C和D节点，D节点将执行操作返回给A节点，从而真正完成一条消息的确认。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010115.png"></p><p>这种数据一致性复制原理于ZK的Quorum（用于保证数据冗余和最终一致性的投票算法）不同，可以保证更强的一致性，在此模型下出现网络波动或网络故障会使数据链的性能大大降低。比如C节点网络异常，则整个数据链会被阻塞，继而相关服务也会被阻塞，所以需要<strong>引入网络分区来将异常节点剥离出整个分区，以确保RabbitMQ的可用性及可靠性</strong>。等待网络恢复后，再将异常节点加入集群。</p><p>通常网络分区都是由单个节点网络故障导致，所以会形成一个大分区和一个单节点的分区，若之前还配置了镜像，就可以在不影响服务可用性、不丢失消息的情况下从网络分区的情形下恢复。</p><h2 id="二-网络分区的判定"><a href="#二-网络分区的判定" class="headerlink" title="二. 网络分区的判定"></a>二. 网络分区的判定</h2><h3 id="2-1-RabbitMQ内部如何判定出现分区"><a href="#2-1-RabbitMQ内部如何判定出现分区" class="headerlink" title="2.1 RabbitMQ内部如何判定出现分区"></a>2.1 RabbitMQ内部如何判定出现分区</h3><p>RabbitMQ集群节点内部通信端口默认为25672，两两节点间都会进行信息交互。当某个节点出现网络故障、端口不通，导致与此节点的交互中断，此处会有一个<strong>超时判定机制来判定是否网络分区</strong>。</p><ul><li>net_ticktime，默认为60秒。当发生超时会有 <code>net_tick_timeout</code> 的信息报出。<strong>集群内部每个节点间会每隔四分之一个net_ticktime记一次应答</strong>。若有任何数据被写入节点中就认为已应答；<strong>连续4次都未应答的节点认为已处于down状态，其余节点可以将其剥离出当前分区</strong>。</li><li>heartbeat_time指客户端与RabbitMQ服务间通信的心跳时间，注意和net_ticktime的区别。</li></ul><p>连续4次应答的总时间T的取值范围：<code>0.75*net_ticktime &lt; T &lt; 1.25*net_ticktime</code></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010116.png"></p><p>默认情况下，可以再45s &lt; T &lt; 75s间判定出  <code>net_tick_timeout</code> 。</p><h3 id="2-2-判定出现网络分区的方法"><a href="#2-2-判定出现网络分区的方法" class="headerlink" title="2.2 判定出现网络分区的方法"></a>2.2 判定出现网络分区的方法</h3><h4 id="（1）查看RabbitMQ服务日志"><a href="#（1）查看RabbitMQ服务日志" class="headerlink" title="（1）查看RabbitMQ服务日志"></a>（1）查看RabbitMQ服务日志</h4><p>当Mnesia认定发生了网络分区后，会记录到RabbitMQ的服务日志中：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:18</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">Mnesia(&#x27;rabbit@node1&#x27;)<span class="symbol">:</span> ** ERROR ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, &#x27;rabbit@node2&#x27;&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）使用rabbitmqctl工具"><a href="#（2）使用rabbitmqctl工具" class="headerlink" title="（2）使用rabbitmqctl工具"></a>（2）使用rabbitmqctl工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl cluster_status</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 未发生网络分区：集群有三个节点</span></span><br><span class="line">[</span><br><span class="line">&#123;nodes,[&#123;disc, [rabbit@node1,rabbit@node2,rabbit@node3]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit@node2,rabbit@node3,rabbit@node1]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;&quot;rabbit@node1&quot;&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[]&#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发生网络分区：partitions内有相关内容，以下表示节点1和3分别与2发生了分区</span></span><br><span class="line">[</span><br><span class="line">&#123;nodes,[&#123;disc, [rabbit@node1,rabbit@node2,rabbit@node3]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes, [rabbit@node3,rabbit@node1]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;&quot;rabbit@node1&quot;&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[&#123;rabbit@node3,[rabbit@node2]&#125;,&#123;rabbit@node1,[rabbit@node2]&#125;]&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="（3）通过Web管理界面"><a href="#（3）通过Web管理界面" class="headerlink" title="（3）通过Web管理界面"></a>（3）通过Web管理界面</h4><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010117.png"></p><h4 id="（4）通过HTTP-API来获取节点信息"><a href="#（4）通过HTTP-API来获取节点信息" class="headerlink" title="（4）通过HTTP API来获取节点信息"></a>（4）通过HTTP API来获取节点信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -i -u root:root123 -H <span class="string">&quot;content-type:application/json&quot;</span> -X GET http://localhost:15672/api/nodes</span></span><br></pre></td></tr></table></figure><ul><li>localhost：RabbitMQ服务器地址</li><li>/api/nodes：返回一个JSON字符串，其中有partitions相关项，若其中有内容则表示发生了网络分区。</li></ul><h2 id="三-模拟网络分区"><a href="#三-模拟网络分区" class="headerlink" title="三. 模拟网络分区"></a>三. 模拟网络分区</h2><p>通常很难观察到网络分区的发生，所以需要模拟出网络分区，方案有三类：</p><ul><li>iptables封禁/解封IP地址或端口号。</li><li>关闭/开启网卡。</li><li>挂起/恢复操作系统。</li></ul><h3 id="3-1-iptables方式"><a href="#3-1-iptables方式" class="headerlink" title="3.1 iptables方式"></a>3.1 iptables方式</h3><p>RabbitMQ集群内部节点通信端口默认为25672，封禁该端口来模拟出 <code>net_tick_timeout</code> ，再开启此端口让集群判定网络分区的发生。</p><p>假设集群有三个节点，我们在node2上执行如下命令来封禁25672端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> iptables -A INPUT -p tcp --dport 25672 -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -A OUTPUT -p tcp --dport 25672 -j DROP</span></span><br></pre></td></tr></table></figure><p>并同时监测各个节点的服务日志，当出现类似信息时表示已判定出 <code>net_tick_timeout</code> 。</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">10</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:11</span><span class="symbol">:53</span><span class="symbol">:03</span> ===</span><br><span class="line">rabbit on node rabbit@node2 down</span><br><span class="line"></span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">10</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:11</span><span class="symbol">:53</span><span class="symbol">:03</span> ===</span><br><span class="line">rabbit@node2 do<span class="symbol">wn:</span> net_tick_timeout</span><br></pre></td></tr></table></figure><p>或者可以等待75秒之后确保发生了 <code>net_tick_timeout</code> ，此时还需要等待node2网络恢复之后才会判定出现网络分区。</p><p>解封命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D OUTPUT 1</span></span><br></pre></td></tr></table></figure><p>node2节点已恢复与其它节点的通信，此时查看集群状态就可以发现出现了两个独立的分区。</p><p>上述是封禁端口来模拟，也可以封禁IP地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在node2上执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.2 -j DROP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.4 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D OUTPUT 1</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以分别在node1或3上执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.3 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br></pre></td></tr></table></figure><p>如果集群的节点部署跨网段，也可以采用封禁整个网络段的方式来模拟：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> node1 102.168.0.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node2 102.168.1.3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node3 102.168.0.4</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -I INPUT -s 192.168.0.0/24 -j DROP</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解封</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> iptables -D INPUT 1</span></span><br></pre></td></tr></table></figure><h3 id="3-2-封禁-解封网卡的方式"><a href="#3-2-封禁-解封网卡的方式" class="headerlink" title="3.2 封禁/解封网卡的方式"></a>3.2 封禁/解封网卡的方式</h3><p>与方式一同为模拟网络故障：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 先用ifconfig来查询当前网卡编号</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifconfig</span></span><br><span class="line">eth0 ...</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在node2上关闭网卡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifdown eth0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待出net_tick_timeout后，再开启网卡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ifup eth0</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以通过以下命令来模拟</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service network stop</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service network start</span></span><br></pre></td></tr></table></figure><h3 id="3-3-挂起-恢复操作系统的方式"><a href="#3-3-挂起-恢复操作系统的方式" class="headerlink" title="3.3 挂起/恢复操作系统的方式"></a>3.3 挂起/恢复操作系统的方式</h3><p>发生挂起的节点不会认为自己已经失败或停止工作，但其它节点会这样认为，比如集群中某个节点运行在一台笔记本上，当笔记本合上此节点就挂起。等待T时间后，出现 <code>net_tick_timeout</code> 后，再恢复挂起的节点即可复现网络分区。</p><h2 id="四-网络分区的影响"><a href="#四-网络分区的影响" class="headerlink" title="四. 网络分区的影响"></a>四. 网络分区的影响</h2><h3 id="4-1-未配置镜像"><a href="#4-1-未配置镜像" class="headerlink" title="4.1 未配置镜像"></a>4.1 未配置镜像</h3><h4 id="（1）对发送端的影响"><a href="#（1）对发送端的影响" class="headerlink" title="（1）对发送端的影响"></a>（1）对发送端的影响</h4><p>假设有三个节点，与交换器绑定关系如下：</p><table><thead><tr><th>节点名称</th><th>交换器</th><th>绑定</th><th>队列</th></tr></thead><tbody><tr><td>node1</td><td>exchange</td><td>rk1</td><td>queue1</td></tr><tr><td>node2</td><td>exchange</td><td>rk2</td><td>queue2</td></tr><tr><td>node3</td><td>exchange</td><td>rk3</td><td>queue3</td></tr></tbody></table><p>网络分区发生前，客户端1和2分别连接node1和node2并向对应队列发送消息，消息存入队列：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;exchange&quot;</span>, <span class="string">&quot;rk1&quot;</span>, <span class="keyword">true</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br></pre></td></tr></table></figure><p>使用iptables模拟网络分区后（关闭网卡会关闭客户端连接），使node1和node2处于不同分区中，对于客户端来说没有影响。</p><p>如果客户端1连接node1，并向queue2发送消息。模拟分区后，如果客户端在发送消息时将mandatory设置为true，网络分区之后可以通过抓包工具看到有Basic.Return将发送的消息返回，表示<strong>发生网络分区后，client1不能正确的将消息发送到queue2中</strong>。</p><p><strong>保证消息可靠性的方案：客户端若设置了ReturnListener来监听Basic.Return的信息，并附带有消息重传机制，则整个网络分区前后过程可以保证发送端消息不丢失。</strong></p><p>在网络分区发生前，queue1进程存在于node1节点，queue2则于node2节点，网络分区发生后，node1不会创建新的node2，所以client1将消息发送到exchange后并不能路由到queue2。若没有采用上述方案，就会发生消息丢失。不过此时仍可以通过指令看到队列：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl list_queues name</span></span><br><span class="line">...</span><br><span class="line">queue2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="（2）对消费端的影响"><a href="#（2）对消费端的影响" class="headerlink" title="（2）对消费端的影响"></a>（2）对消费端的影响</h4><p>假设网络分区发生前，客户端3和4分别连接node1和2，但分别消费queue2和queue1（不交换的情况和发送端一样无影响）。在网络分区发生后，客户端虽然不会报错，也可以消费到内容。但会有如已消费消息的ack失效等现象发生，网络分区恢复后，数据不会丢失。</p><p>如果分区之后，重启client3或有个新的客户端连接node1来消费queue2，会有报错：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.rabbitmq.client.ShutdownSignalException: channel error; protocol <span class="function"><span class="keyword">method</span>:</span> #<span class="function"><span class="keyword">method</span>&lt;<span class="title">channel</span>.<span class="title">close</span>&gt;<span class="params">(reply-code=404, reply-text=NOT_FOUND - home node <span class="string">&#x27;rabbit@node2&#x27;</span> <span class="keyword">of</span> durable queue <span class="string">&#x27;queue2&#x27;</span> <span class="keyword">in</span> vhost <span class="string">&#x27;/&#x27;</span> <span class="keyword">is</span> down <span class="keyword">or</span> inaccessible, <span class="keyword">class</span>-id=60, <span class="keyword">method</span>-id=20)</span></span></span><br></pre></td></tr></table></figure><p>node1的服务日志中也有相关记录：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">12</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:14</span><span class="symbol">:48</span> ===</span><br><span class="line">Channel error on connection &lt;<span class="number">0.9538</span>.<span class="number">9</span>&gt; (<span class="number">192.168</span>.<span class="number">0.9</span><span class="symbol">:61294</span> -&gt; <span class="number">192.168</span>.<span class="number">0.2</span><span class="symbol">:5672</span>, vho<span class="symbol">st:</span> &#x27;/&#x27;, us<span class="symbol">er:</span> &#x27;root&#x27;), channel <span class="symbol">1:</span></span><br><span class="line">&#123;amqp_error,not_found,<span class="string">&quot;home node &#x27;rabbit@ndoe2&#x27; of durable queue &#x27;queue2&#x27; in vhost &#x27;/&#x27; is down or inaccessible&quot;</span>, &#x27;basic.consume&#x27;&#125;</span><br></pre></td></tr></table></figure><p>未配置镜像的集群，在网络分区发生后，队列也会随着节点而分散在各自的分区中。</p><ul><li>对于消息发送方，可以成功发送消息，但会有路由失败的现象，需要配合mandatory等机制保证消息的可靠性。</li><li>对于消息消费方，可能会有诡异、不可预知的现象发生，如已消费消息的ack失效。</li><li>如果网络分区发生后，客户端与某分区重新建立通信链路，其分区若没有对应得队列进程，则会由异常抛出。</li><li>如果从网络分区中恢复后，数据不会丢失，但客户端会重复消费。</li></ul><h3 id="4-2-已配置镜像"><a href="#4-2-已配置镜像" class="headerlink" title="4.2 已配置镜像"></a>4.2 已配置镜像</h3><p>已配置镜像队列的情况要比未配置复杂得多。假设集群有三个节点，采用iptables方式将集群模拟分裂为两个网络分区[node1, node3]和[node2]。</p><p>镜像队列：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ha-mode</span>:<span class="string">exactly</span></span><br><span class="line"><span class="meta">ha-param</span>:<span class="string">2</span></span><br><span class="line"><span class="meta">ha-sync-mode</span>:<span class="string">automatic</span></span><br></pre></td></tr></table></figure><p>分区之前：</p><table><thead><tr><th>队列</th><th>master</th><th>slave</th></tr></thead><tbody><tr><td>queue1</td><td>node1</td><td>node3</td></tr><tr><td>queue2</td><td>node2</td><td>node3</td></tr><tr><td>queue3</td><td>node3</td><td>node2</td></tr></tbody></table><p>分区之后，[node1, node3]分区中的队列有了新的部署，queue1未发生变化，queue2因为原宿主节点node2被剥离，所以node3提升为master，同时选择node1作为slave。queue3则重新选择node1为新的slave：</p><table border="1" style="margin-top:10">    <tr>        <td rowspan="2" align="center">队列</td>         <td colspan="2" align="center">[node1, node3]分区</td>         <td colspan="2" align="center">[node2]分区</td>    </tr>    <tr>        <td align="center">master</td>            <td align="center">slave</td>            <td align="center">master</td>            <td align="center">slave</td>        </tr>    <tr>        <td align="center">queue1</td>           <td align="center">node1</td>         <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node3</td>     </tr>    <tr>        <td align="center">queue2</td>           <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node2</td>         <td align="center">[]</td>     </tr>    <tr>        <td align="center">queue3</td>           <td align="center">node3</td>         <td align="center">node1</td>         <td align="center">node2</td>         <td align="center">[]</td>     </tr></table><p>对于queue1，网络分区前后不会对生产和消费造成影响。</p><p>对于queue2和queue3则会和未配置镜像一样，恢复后有可能会有数据丢失。</p><p>当有新的slave出现时，会自动同步master的数据，在同步的过程中，集群的整个服务都不可用，客户端连接会被阻塞。如果master中有大量的消息堆积，必然会造成slave的同步时间增长，进一步影响了集群服务的可用性。若配置了 <code>ha-sync-mode=manual</code> 在新的slave创建时不会同步master上旧的数据，若master节点发生了异常，则此部分数据会丢失。</p><h3 id="4-3-网络分区造成的消息丢失如何解决？"><a href="#4-3-网络分区造成的消息丢失如何解决？" class="headerlink" title="4.3 网络分区造成的消息丢失如何解决？"></a>4.3 网络分区造成的消息丢失如何解决？</h3><ul><li>首先，消息发送端要有处理 <code>Basic.Return</code> 的能力。</li><li>其次，检测到网络分区发生后，要迅速的挂起所有生产者进程。</li><li>之后，连接每个节点消费分区中的所有队列数据。在消费完之后再处理网络分区。</li><li>最后，再从网络分区中恢复生产者的进程。</li><li>需要注意整个过程会伴有大量的消息重复，消费者客户端要做好相应的幂等性处理。</li></ul><p>还有方案：<strong>集群迁移</strong>，将所有旧集群资源迁移到新集群来解决问题。</p><h2 id="五-如何处理网络分区"><a href="#五-如何处理网络分区" class="headerlink" title="五. 如何处理网络分区"></a>五. 如何处理网络分区</h2><h3 id="5-1-手动处理网络分区"><a href="#5-1-手动处理网络分区" class="headerlink" title="5.1 手动处理网络分区"></a>5.1 手动处理网络分区</h3><p>从网络分区中恢复，首先要挑选一个信任分区，该分区有决定Mnesia内容的权限，发生在其余分区的改变不会记录在Mnesia而直接丢弃。然后重启非信任分区中的节点，若此时还有网络分区的告警，则紧接着重启信任分区中的节点。</p><h4 id="（1）如何挑选信任分区？"><a href="#（1）如何挑选信任分区？" class="headerlink" title="（1）如何挑选信任分区？"></a>（1）如何挑选信任分区？</h4><p>挑选信任分区的优先级由高至低：</p><ul><li>分区中要有disc节点；</li><li>分区中节点数最多；</li><li>分区中队列数最多；</li><li>分区中客户端连接最多。</li></ul><p>（若有多个分区这些条件都相等，则随机挑选）</p><h4 id="（2）如何重启节点？"><a href="#（2）如何重启节点？" class="headerlink" title="（2）如何重启节点？"></a>（2）如何重启节点？</h4><p>重启RabbitMQ的方式：</p><ol><li><code>rabbitmqctl stop</code> 关闭，<code>rabbitmq-server -detached</code> 启动（同时重启Erlang虚拟机和RabbitMQ）；</li><li><code>rabbitmqctl stop_app</code> 关闭，<code>rabbitmqctl start_app</code> 启动（只重启RabbitMQ，从网络分区恢复推荐该种）。</li></ol><h4 id="（3）重启的顺序如何确定？"><a href="#（3）重启的顺序如何确定？" class="headerlink" title="（3）重启的顺序如何确定？"></a>（3）重启的顺序如何确定？</h4><p>配置镜像队列出现的漂移现象：依次关闭节点，导致master最终都漂移到一个节点上，之后重启节点只会增加slave的个数，而不会改变master的分布。对于RabbitMQ来说，除了发布消息其余操作都在master上完成，因此压力都集中到了单个节点，不能很好的负载均衡。</p><p>重启顺序的两种方式：</p><ol><li>停止其它非信任分区中的所有节点，然后再启动每一个节点，如果此时还有网络分区的告警，则再重启信任分区中的节点以清除告警。</li><li>关闭整个集群的节点，然后再启动每一个节点，需要确保第一个节点在信任分区。</li></ol><p>如果采用挨个节点重启的方式，会有Mnesia内容权限归属问题，也有可能引起二次网络分区。</p><p>解决镜像队列漂移问题，可以在重启前先删除镜像队列的配置（需要在每个队列上都删除镜像队列）：</p><ul><li><p>通过命令删除：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rabbitmqctl clear_policy [-p vhost] &#123;mirror_queue_name&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>通过HTTP API或WEB界面删除：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -s -u &#123;username:password&#125; -X DELETE http://localhost:15672/api/policies/default/&#123;mirror_queue_name&#125;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（4）如何判断已从网络分区恢复？"><a href="#（4）如何判断已从网络分区恢复？" class="headerlink" title="（4）如何判断已从网络分区恢复？"></a>（4）如何判断已从网络分区恢复？</h4><p>可以参考第二节的内容，如使用 <code>rabbitmqctl cluster_status</code> 命令检测输出的partitions是否有节点信息。也可以通过Web界面或HTTP API的方式。</p><h4 id="（5）总结步骤"><a href="#（5）总结步骤" class="headerlink" title="（5）总结步骤"></a>（5）总结步骤</h4><ol><li>挂起生产者和消费者进程，从而减少消息不必要的丢失，如果进程数过多且情况紧急，可以跳过该步骤。</li><li>删除镜像队列的配置。</li><li>挑选信任分区。</li><li>关闭非信任分区的节点，采用 <code>rabbitmqctl stop_app</code> 关闭。</li><li>启动非信任分区的节点，采用 <code>rabbitmqctl start_app</code> 启动。</li><li>检查网络分区是否恢复，如果已恢复则跳至步骤8，若还有网络分区报警则进行步骤7。</li><li>重启信任分区中的节点。</li><li>添加镜像队列的配置。</li><li>恢复生产者和消费者进程。</li></ol><h3 id="5-2-自动处理网络分区"><a href="#5-2-自动处理网络分区" class="headerlink" title="5.2 自动处理网络分区"></a>5.2 自动处理网络分区</h3><p>RabbitMQ提供了三种自动处理网络分区的方法：</p><ul><li>pause-minority模式</li><li>pause-if-all-down模式</li><li>autoheal模式</li><li>默认为ignore模式，即不自动处理。</li></ul><p>在配置文件 <code>rabbitmq.config</code> 中配置 <code>cluster_partition_handling</code> 参数：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, igbore&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="（1）pause-minority模式"><a href="#（1）pause-minority模式" class="headerlink" title="（1）pause-minority模式"></a>（1）pause-minority模式</h4><p>该模式下，发生网络分区时，集群中的节点观察到某些节点down掉时会自动检测自身是否处于少数派（分区中的节点小于或等于集群中一半的节点数），RabbitMQ会自动关闭这些节点的运作。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, pause-minority&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>根据CAP原理，此处保证了分区耐受性P，确保在发生网络分区的情况下大多数同个分区的节点可以继续运行。少数派的节点在分区开始时关闭，分区结束后启动（只关闭RabbitMQ，不关闭Erlang）。处于关闭的节点每秒检测依次是否可连通到剩余集群，可以时启动自己。</p><p>当集群中只有两个节点时不适合采用该模式，因为任何一个节点失败发生网络分区时，两个节点都会关闭，在网络恢复时两个节点自动恢复网络分区，也有可能保持关闭状态。对于2V2和3V3等对等分裂的情况，在跨机器部署时很有可能发生，会关闭这些分区内所有节点。</p><h4 id="（2）pause-if-all-down模式"><a href="#（2）pause-if-all-down模式" class="headerlink" title="（2）pause-if-all-down模式"></a>（2）pause-if-all-down模式</h4><p>该模式下，集群中的节点在和所配置列表中任何节点不能交互时才会关闭，配置如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, </span><br><span class="line">             &#123;pause_if_all_down, [&#x27;rabbit@node1&#x27;], ignore&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>如果一个节点与node1无法通信，则会关闭自身的RabbitMQ。</li><li>如果是node1本身发生了故障造成网络不可用，其它节点都是正常，则所有节点都要关闭RabbitMQ，等待node1恢复后，各个节点再启动MQ从网络分区中恢复。</li></ul><p>该模式下有ignore和autoheal两种配置，如果出现上一个所述的对等分裂，两台机器部署4个节点，机器间通信异常，但机器上两个节点保持通信，假设又配置了两个机器各一个节点，则这四个节点都不会自行关闭。此时把配置中的ignore改为autoheal可以处理这种情况。</p><h4 id="（3）autoheal模式"><a href="#（3）autoheal模式" class="headerlink" title="（3）autoheal模式"></a>（3）autoheal模式</h4><p>该模式下发生网络分区时，RabbitMQ会自动决定一个获胜的分区，然后重启不在这个分区中的节点来恢复网络分区。</p><p>获胜分区的选择优先级从高到低：</p><ul><li>客户端连接数最多；</li><li>节点数最多；</li><li>节点名称的字典序。</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        rabbit, [</span><br><span class="line">        &#123;cluster_partition_handling, autoheal&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>对于pause-minority模式，关闭节点的状态是网络故障时（判断出net_tick_timout）会关闭少数派分区中的节点，等待网络恢复之后（即出现网络分区后）启动关闭的节点来从网络分区中恢复。</li><li>auto模式再判定出net_tick_timout时不做动作，要等到网络恢复后才重启非获胜分区的节点。</li></ul><h4 id="（4）挑选哪种模式"><a href="#（4）挑选哪种模式" class="headerlink" title="（4）挑选哪种模式"></a>（4）挑选哪种模式</h4><p>允许MQ自动处理网络分区并不一定会又正面的效果，如果MQ处于一个不可靠的网络环境下，需要使用Federation或Shovel，就算恢复后也要谨防二次网络分区。</p><ul><li>ignore：发生网络分区时不做任何动作，需要人工介入。</li><li>pause-minority：对于对等分区的处理不够优雅，可能会关闭所有的节点。可以应用于非跨机架、奇数节点数的集群中。</li><li>pause-if-all-down：对于受信节点的选择尤为考究，尤其是集群中所有节点配置相同的情况下，可以处理对等分区的情况。</li><li>autoheal：可以处理各种情况下的网络分区，但如果集群中有节点处于非运行状态，该模式会失效。</li></ul><h2 id="六-多分区的案例"><a href="#六-多分区的案例" class="headerlink" title="六. 多分区的案例"></a>六. 多分区的案例</h2><p>当集群中物理机是多网卡，当某个节点网卡发生故障可能会发生多个分区的情况。</p><p>假设集群有6个节点，每个节点的物理机都是4网卡（eth0到eth3），并采用bind0的绑定模式。当node6的eth0发生故障后，整个集群演变为6个分区，每个节点都是一个独立的分区。</p><p>网络分区前：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010118.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210901/202109010119.png"></p><p>当node6网被关闭，对于bind0模式，交换机无法感知eth0网卡的故障，但node6节点能够感知本地eth0的故障。对于node3节点，其与node6的eth0网卡建立的长连接没有关闭，node3会向node6重试发送数据，但node6无法回应，除非主动关闭或等待长连接超时（默认7200s，即2小时）链路才会关闭。</p><p>node6网卡关闭后，node1、node3和node6发生变化：</p><ol><li><p>与node6的eth0链路不通，node3等待net_ticktime的超时。node3相关日志：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbit on <span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down</span><br><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down: net_tick_timeout</span><br></pre></td></tr></table></figure></li><li><p>待超时后，主动关闭连接。node3相关日志：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; down: connection_closed</span><br></pre></td></tr></table></figure><p>同时Erlang虚拟机尝试让node3与node6重新连接，因为node6其它网卡正常，所以连接可以正确建立。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">&#x27;rabbit</span>@node6&#x27; up</span><br></pre></td></tr></table></figure></li><li><p>判定node3和node6之间产生了网络分区。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mnesia(<span class="string">&#x27;rabbit@node3&#x27;</span>): ** <span class="builtin-name">ERROR</span> ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, <span class="string">&#x27;rabbit@node6&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></li><li><p>此时node3和node1还处于连通状态，同样node6和node1也处于连通状态，node3日志：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Partial <span class="keyword">partition</span> detected:</span><br><span class="line"><span class="operator">*</span> We saw DOWN <span class="keyword">from</span> rabbit<span class="variable">@node6</span></span><br><span class="line"><span class="operator">*</span> We can still see rabbit<span class="variable">@node1</span> which can see rabbit<span class="variable">@node6</span></span><br><span class="line">We will therefore intentionally <span class="keyword">disconnect</span> <span class="keyword">from</span> rabbit<span class="variable">@node1</span></span><br></pre></td></tr></table></figure><p>表示node3和node6发生了网络分区，但node3发现node1和node6内部通信还未断，此时认为node1和node6处于同一个分区，node3准备主动关闭与node1的通信，所以node1和node3也发生了分区。</p></li><li><p>同时，对于node6来说，node1和node3还处于同一分区，所以node6也要讲node1置于node6本身分区之外，所以三个节点都将处于不同分区。</p><p>node1日志：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:54</span> ===</span><br><span class="line">Partial partition detect<span class="symbol">ed:</span></span><br><span class="line">* We saw DOWN from rabbit@node3</span><br><span class="line">* We can still see rabbit@node4 which can see rabbit@node3</span><br><span class="line">We will therefore intentionally disconnect from rabbit@node4</span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">node &#x27;rabbit@node4&#x27; do<span class="symbol">wn:</span> disconnect</span><br><span class="line">=<span class="built_in">INFO</span> REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">node &#x27;rabbit@node4&#x27; up</span><br><span class="line">=ERROR REPORT==== <span class="number">16</span>-Oct-<span class="symbol">2017:</span><span class="symbol">:14</span><span class="symbol">:20</span><span class="symbol">:55</span> ===</span><br><span class="line">Mnesia(&#x27;rabbit@node1&#x27;)<span class="symbol">:</span> ** ERROR ** mnesia_event got &#123;inconsistent_database, running_partitioned_network, &#x27;rabbit@node4&#x27;&#125;</span><br></pre></td></tr></table></figure><p>此时node1察觉node4与node3还有内部通信交换，主动将node4剥离出自身分区。</p></li><li><p>以此下去直到每个节点都分离出自己的分区。</p></li></ol><p>对于这种情况采用自动模式的效果：</p><ul><li>pause_if_all_down：挑选一个节点作为受信节点，重启剩余5个节点恢复。</li><li>autoheal：同样，查看日志可以发现，会等网络分区判定之后罗列出所有分区信息，再重启非获胜分区节点（同样是5个）。</li><li>pause_minority：最优雅，当有节点检测到net_tick_timeout后自行重启当前节点，阻止了网络分区进一步演变，处理效率最高。</li></ul><hr><p>参考：</p><p>🔗 《RabbitMQ实战指南》</p>]]></content>
    
    
    <summary type="html">学习RabbitMQ，第九章《网络分区》，内容来自于《RabbitMQ实战指南》，内容：MQ与网络分区、如何判定网络分区、模拟网络分区、网络分区的影响、如何处理网络分区等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="mom" scheme="http://linyishui.top/tags/mom/"/>
    
    <category term="rabbitmq" scheme="http://linyishui.top/tags/rabbitmq/"/>
    
  </entry>
  
  <entry>
    <title>Java诊断工具-Arthas</title>
    <link href="http://linyishui.top/2021091601.html"/>
    <id>http://linyishui.top/2021091601.html</id>
    <published>2021-09-16T12:51:44.000Z</published>
    <updated>2021-09-22T11:21:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java诊断工具-Arthas"><a href="#Java诊断工具-Arthas" class="headerlink" title="Java诊断工具-Arthas"></a>Java诊断工具-Arthas</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><ul><li>官网：<a href="https://arthas.aliyun.com/zh-cn/">Arthas 应用诊断利器</a></li><li>Alibaba开源的Java诊断工具；在线排查问题，无需重启；动态跟踪Java代码；实时监控JVM状态。</li><li>支持JDK6+；支持Linux/Mac/Windows;命令行式交互模式。</li></ul><p>解决如下问题：</p><ol><li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li><li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li><li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li><li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li><li>是否有一个全局视角来查看系统的运行状况？</li><li>有什么办法可以监控到JVM的实时运行状态？</li><li>怎么快速定位应用的热点，生成火焰图？</li><li>怎样直接从JVM内查找某个类的实例？</li></ol><h2 id="二-教程"><a href="#二-教程" class="headerlink" title="二. 教程"></a>二. 教程</h2><p>内容全部来源自官网。</p><h3 id="2-1-入门"><a href="#2-1-入门" class="headerlink" title="2.1 入门"></a>2.1 入门</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载一个Jar包，并启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://arthas.aliyun.com/math-game.jar</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar math-game.jar</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新窗口下载Arthas的启动Jar包，并启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://arthas.aliyun.com/arthas-boot.jar</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动后列出所有Java进程，输入对应</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dashboard 命令可以查看当前系统的实时数据面板</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dashboard</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入 Q 或者 Ctrl+C 可以退出dashboard命令。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> thread 1 命令会打印线程ID 1的栈。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> thread 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Arthas支持管道，可以用 thread 1 | grep <span class="string">&#x27;main(&#x27;</span> 查找到main class。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到main class是demo.MathGame：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> thread 1 | grep <span class="string">&#x27;main(&#x27;</span></span></span><br><span class="line">    at demo.MathGame.main(MathGame.java:17)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过 sc 命令来查找JVM里已加载的类：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sc -d *MathGame</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过 jad 命令来反编译代码：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> jad demo.MathGame</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过watch命令可以查看函数的参数/返回值/异常信息。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> watch demo.MathGame primeFactors returnObj</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入 Q 或者 Ctrl+C 退出watch命令。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过vmtool命令，可以搜索内存对象。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vmtool --action getInstances --className java.lang.String --<span class="built_in">limit</span> 10</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用 <span class="built_in">exit</span> 或者 quit 命令可以退出Arthas。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出Arthas之后，还可以再次用 java -jar arthas-boot.jar 来连接。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exit</span>/quit命令只是退出当前session，arthas server还在目标进程中运行。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 想完全退出Arthas，可以执行 stop 命令。</span></span><br></pre></td></tr></table></figure><p>安装：<a href="https://arthas.aliyun.com/doc/install-detail.html">Arthas Install — Arthas 3.5.4 文档 (aliyun.com)</a></p><h3 id="2-2-进阶"><a href="#2-2-进阶" class="headerlink" title="2.2 进阶"></a>2.2 进阶</h3><h4 id="2-2-1-查看JVM信息"><a href="#2-2-1-查看JVM信息" class="headerlink" title="2.2.1 查看JVM信息"></a>2.2.1 查看JVM信息</h4><ul><li><p>sysprop：</p><p>可以打印所有的System Properties信息。</p><p>也可以指定单个key： <code>sysprop java.version</code></p><p>也可以通过<code>grep</code>来过滤： <code>sysprop | grep user</code></p><p>可以设置新的value： <code>sysprop testKey testValue</code></p></li><li><p>sysenv：<code>sysenv</code> 命令可以获取到环境变量。和<code>sysprop</code>命令类似。</p></li><li><p>jvm：<code>jvm</code> 命令会打印出<code>JVM</code>的各种详细信息。</p></li><li><p>dashboard：<code>dashboard</code> 命令可以查看当前系统的实时数据面板。输入 <code>Q</code> 或者 <code>Ctrl+C</code> 可以退出dashboard命令。</p></li></ul><h4 id="2-2-2-Tips"><a href="#2-2-2-Tips" class="headerlink" title="2.2.2 Tips"></a>2.2.2 Tips</h4><ul><li><p>help：Arthas里每一个命令都有详细的帮助信息。可以用<code>-h</code>来查看。帮助信息里有<code>EXAMPLES</code>和<code>WIKI</code>链接。比如：<code>sysprop -h</code></p></li><li><p>自动补全：Arthas支持丰富的自动补全功能，在使用有疑惑时，可以输入<code>Tab</code>来获取更多信息。</p><p>比如输入 <code>sysprop java.</code> 之后，再输入<code>Tab</code>，会补全出对应的key：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysprop java.</span></span><br><span class="line">java.runtime.name             java.protocol.handler.pkgs    java.vm.version</span><br><span class="line">java.vm.vendor                java.vendor.url               java.vm.name</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p>readline的快捷键支持：</p><p>Arthas支持常见的命令行快捷键，比如<code>Ctrl + A</code>跳转行首，<code>Ctrl + E</code>跳转行尾。</p><p>更多的快捷键可以用 <code>keymap</code> 命令查看。</p></li><li><p>历史命令的补全：</p><p>如果想再执行之前的命令，可以在输入一半时，按<code>Up/↑</code> 或者 <code>Ddown/↓</code>，来匹配到之前的命令。</p><p>比如之前执行过<code>sysprop java.version</code>，那么在输入<code>sysprop ja</code>之后，可以输入<code>Up/↑</code>，就会自动补全为<code>sysprop java.version</code>。</p><p>如果想查看所有的历史命令，也可以通过 <code>history</code> 命令查看到。</p></li><li><p>pipeline：</p><p>Arthas支持在pipeline之后，执行一些简单的命令，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sysprop | grep java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sysprop | wc -l</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2-3-sc-sm-查看已加载的类"><a href="#2-2-3-sc-sm-查看已加载的类" class="headerlink" title="2.2.3 sc/sm 查看已加载的类"></a>2.2.3 sc/sm 查看已加载的类</h4><ul><li><p>sc：</p><p><code>sc</code> 命令可以查找到所有JVM已经加载到的类。</p><p>如果搜索的是接口，还会搜索所有的实现类。比如查看所有的<code>Filter</code>实现类：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc javax.servlet.Filter</span></span><br></pre></td></tr></table></figure><p>通过<code>-d</code>参数，可以打印出类加载的具体信息，很方便查找类加载问题。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d javax.servlet.Filter</span></span><br></pre></td></tr></table></figure><p><code>sc</code>支持通配，比如搜索所有的<code>StringUtils</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc *StringUtils</span></span><br></pre></td></tr></table></figure></li><li><p>sm：</p><p><code>sm</code>命令则是查找类的具体函数。比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm java.math.RoundingMode</span></span><br></pre></td></tr></table></figure><p>通过<code>-d</code>参数可以打印函数的具体属性：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm -d java.math.RoundingMode</span></span><br></pre></td></tr></table></figure><p>也可以查找特定的函数，比如查找构造函数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sm java.math.RoundingMode &lt;init&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-2-4-Jad反编译代码"><a href="#2-2-4-Jad反编译代码" class="headerlink" title="2.2.4 Jad反编译代码"></a>2.2.4 Jad反编译代码</h4><p>可以通过 <code>jad</code> 命令来反编译代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad com.example.demo.arthas.user.UserController</span></span><br></pre></td></tr></table></figure><p>通过<code>--source-only</code>参数可以只打印出在反编译的源代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad --source-only com.example.demo.arthas.user.UserController</span></span><br></pre></td></tr></table></figure><h4 id="2-2-5-Ognl动态执行代码"><a href="#2-2-5-Ognl动态执行代码" class="headerlink" title="2.2.5 Ognl动态执行代码"></a>2.2.5 Ognl动态执行代码</h4><p>在Arthas里，有一个单独的<code>ognl</code>命令，可以动态执行代码。</p><h5 id="调用static函数"><a href="#调用static函数" class="headerlink" title="调用static函数"></a>调用static函数</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl <span class="string">&#x27;@java.lang.System@out.println(&quot;hello ognl&quot;)&#x27;</span></span></span><br></pre></td></tr></table></figure><p>可以检查<code>Terminal 1</code>（不是arthas的Terminal 2）里的进程输出，可以发现打印出了<code>hello ognl</code>。</p><h5 id="查找UserController的ClassLoader"><a href="#查找UserController的ClassLoader" class="headerlink" title="查找UserController的ClassLoader"></a>查找UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><p>注意hashcode是变化的，需要先查看当前的ClassLoader信息，提取对应ClassLoader的hashcode。</p><p>如果你使用<code>-c</code>，你需要手动输入hashcode：<code>-c &lt;hashcode&gt;</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ognl -c 1be6f5c3 @com.example.demo.arthas.user.UserController@logger</span><br></pre></td></tr></table></figure><p>对于只有唯一实例的ClassLoader可以通过<code>--classLoaderClass</code>指定class name，使用起来更加方便：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader  @org.springframework.boot.SpringApplication@logger</span><br><span class="line">@Slf4jLocationAwareLog[</span><br><span class="line">    FQCN=@String[org.apache.commons.logging.LogAdapter<span class="variable">$Slf4jLocationAwareLog</span>],</span><br><span class="line">    name=@String[org.springframework.boot.SpringApplication],</span><br><span class="line">    logger=@Logger[Logger[org.springframework.boot.SpringApplication]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>--classLoaderClass</code> 的值是ClassLoader的类名，只有匹配到唯一的ClassLoader实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p><h5 id="获取静态类的静态字段"><a href="#获取静态类的静态字段" class="headerlink" title="获取静态类的静态字段"></a>获取静态类的静态字段</h5><p>获取<code>UserController</code>类里的<code>logger</code>字段：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader @com.example.demo.arthas.user.UserController@logger</span></span><br></pre></td></tr></table></figure><p>还可以通过<code>-x</code>参数控制返回值的展开层数。比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -x 2 @com.example.demo.arthas.user.UserController@logger</span></span><br></pre></td></tr></table></figure><h5 id="执行多行表达式，赋值给临时变量，返回一个List"><a href="#执行多行表达式，赋值给临时变量，返回一个List" class="headerlink" title="执行多行表达式，赋值给临时变量，返回一个List"></a>执行多行表达式，赋值给临时变量，返回一个List</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span></span><br><span class="line">@ArrayList[</span><br><span class="line">    @String[/Library/Java/JavaVirtualMachines/jdk1.8.0_162.jdk/Contents/Home/jre],</span><br><span class="line">    @String[Java(TM) SE Runtime Environment],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h5><p>在Arthas里<code>ognl</code>表达式是很重要的功能，在很多命令里都可以使用<code>ognl</code>表达式。</p><p>一些更复杂的用法，可以参考：</p><ul><li>OGNL特殊用法请参考：<a href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71</a></li><li>OGNL表达式官方指南：<a href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li></ul><h3 id="2-3-案例"><a href="#2-3-案例" class="headerlink" title="2.3 案例"></a>2.3 案例</h3><h4 id="2-3-1-案例-排查函数调用异常"><a href="#2-3-1-案例-排查函数调用异常" class="headerlink" title="2.3.1 案例: 排查函数调用异常"></a>2.3.1 案例: 排查函数调用异常</h4><h5 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h5><p>目前，访问 <a href="http://localhost/user/0">http://localhost/user/0</a> ，会返回500异常：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost/user/0</span></span><br><span class="line">&#123;&quot;timestamp&quot;:1550223186170,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;exception&quot;:&quot;java.lang.IllegalArgumentException&quot;,&quot;message&quot;:&quot;id &lt; 1&quot;,&quot;path&quot;:&quot;/user/0&quot;&#125;</span><br></pre></td></tr></table></figure><p>但请求的具体参数，异常栈是什么呢？</p><h5 id="查看UserController的-参数-异常"><a href="#查看UserController的-参数-异常" class="headerlink" title="查看UserController的 参数/异常"></a>查看UserController的 参数/异常</h5><p>在Arthas里执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><ol><li>第一个参数是类名，支持通配</li><li>第二个参数是函数名，支持通配</li></ol><p>访问 <code>curl http://localhost/user/0</code> ,<code>watch</code>命令会打印调用的参数和异常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost <span class="keyword">in</span> 53 ms.</span><br><span class="line">ts=2019-02-15 01:35:25; [cost=0.996655ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>可以看到实际抛出的异常是<code>IllegalArgumentException</code>。</p><p>可以输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出watch命令。</p><p>如果想把获取到的结果展开，可以用<code>-x</code>参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2</span></span><br></pre></td></tr></table></figure><h5 id="返回值表达式"><a href="#返回值表达式" class="headerlink" title="返回值表达式"></a>返回值表达式</h5><p>在上面的例子里，第三个参数是<code>返回值表达式</code>，它实际上是一个<code>ognl</code>表达式，它支持一些内置对象：</p><ul><li>loader</li><li>clazz</li><li>method</li><li>target</li><li>params</li><li>returnObj</li><li>throwExp</li><li>isBefore</li><li>isThrow</li><li>isReturn</li></ul><p>你可以利用这些内置对象来组成不同的表达式。比如返回一个数组：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params[0], target, returnObj&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p>更多参考： <a href="https://arthas.aliyun.com/doc/advice-class.html">https://arthas.aliyun.com/doc/advice-class.html</a></p><h5 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h5><p><code>watch</code>命令支持在第4个参数里写条件表达式，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * returnObj <span class="string">&#x27;params[0] &gt; 100&#x27;</span></span></span><br></pre></td></tr></table></figure><p>当访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/1">https://2886795326-80-host12nc.environments.katacoda.com/user/1</a> 时，<code>watch</code>命令没有输出</p><p>当访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/101">https://2886795326-80-host12nc.environments.katacoda.com/user/101</a> 时，<code>watch</code>会打印出结果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch com.example.demo.arthas.user.UserController * returnObj <span class="string">&#x27;params[0] &gt; 100&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:2) cost <span class="keyword">in</span> 47 ms.</span><br><span class="line">ts=2019-02-13 19:42:12; [cost=0.821443ms] result=@User[</span><br><span class="line">    id=@Integer[101],</span><br><span class="line">    name=@String[name101],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="当异常时捕获"><a href="#当异常时捕获" class="headerlink" title="当异常时捕获"></a>当异常时捕获</h5><p><code>watch</code>命令支持<code>-e</code>选项，表示只捕获抛出异常时的请求：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&quot;&#123;params[0],throwExp&#125;&quot;</span> -e</span></span><br></pre></td></tr></table></figure><h5 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h5><p>watch命令支持按请求耗时进行过滤，比如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, returnObj&#125;&#x27;</span> <span class="string">&#x27;#cost&gt;200&#x27;</span></span></span><br></pre></td></tr></table></figure><h4 id="2-3-2-案例-热更新代码"><a href="#2-3-2-案例-热更新代码" class="headerlink" title="2.3.2 案例: 热更新代码"></a>2.3.2 案例: 热更新代码</h4><p>下面介绍通过<code>jad</code>/<code>mc</code>/<code>redefine</code> 命令实现动态更新代码的功能。</p><p>目前，访问 <a href="http://localhost/user/0">http://localhost/user/0</a> ，会返回500异常：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost/user/0</span></span><br><span class="line">&#123;&quot;timestamp&quot;:1550223186170,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;exception&quot;:&quot;java.lang.IllegalArgumentException&quot;,&quot;message&quot;:&quot;id &lt; 1&quot;,&quot;path&quot;:&quot;/user/0&quot;&#125;</span><br></pre></td></tr></table></figure><p>下面通过热更新代码，修改这个逻辑。</p><h5 id="jad反编译UserController"><a href="#jad反编译UserController" class="headerlink" title="jad反编译UserController"></a>jad反编译UserController</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span></span><br></pre></td></tr></table></figure><p>jad反编译的结果保存在 <code>/tmp/UserController.java</code>文件里了。</p><p>再打开一个<code>Terminal 3</code>，然后用vim来编辑<code>/tmp/UserController.java</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /tmp/UserController.java</span><br></pre></td></tr></table></figure><p>比如当 user id 小于1时，也正常返回，不抛出异常：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;id: &#123;&#125;&quot;</span>, (Object)id);</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(id, <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">        <span class="comment">// throw new IllegalArgumentException(&quot;id &lt; 1&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(id.intValue(), <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="sc查找加载UserController的ClassLoader"><a href="#sc查找加载UserController的ClassLoader" class="headerlink" title="sc查找加载UserController的ClassLoader"></a>sc查找加载UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d *UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><p>可以发现是 spring boot <code>LaunchedURLClassLoader@1be6f5c3</code> 加载的。</p><p>请记下你的classLoaderHash，后面需要使用它。在这里，它是 <code>1be6f5c3</code>。</p><h5 id="mc"><a href="#mc" class="headerlink" title="mc"></a>mc</h5><p>保存好<code>/tmp/UserController.java</code>之后，使用<code>mc</code>(Memory Compiler)命令来编译，并且通过<code>-c</code>或者<code>--classLoaderClass</code>参数指定ClassLoader：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span></span><br><span class="line">Memory compiler output:</span><br><span class="line">/tmp/com/example/demo/arthas/user/UserController.class</span><br><span class="line">Affect(row-cnt:1) cost in 346 ms</span><br></pre></td></tr></table></figure><p>也可以通过<code>mc -c &lt;classLoaderHash&gt; /tmp/UserController.java -d /tmp</code>，使用<code>-c</code>参数指定ClassLoaderHash:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mc -c 1be6f5c3 /tmp/UserController.java -d /tmp</span><br></pre></td></tr></table></figure><h5 id="redefine"><a href="#redefine" class="headerlink" title="redefine"></a>redefine</h5><p>再使用<code>redefine</code>命令重新加载新编译好的<code>UserController.class</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redefine /tmp/com/example/demo/arthas/user/UserController.class</span></span><br><span class="line">redefine success, size: 1</span><br></pre></td></tr></table></figure><h5 id="热修改代码结果"><a href="#热修改代码结果" class="headerlink" title="热修改代码结果"></a>热修改代码结果</h5><p><code>redefine</code>成功之后，再次访问 <a href="https://2886795326-80-host12nc.environments.katacoda.com/user/0">https://2886795326-80-host12nc.environments.katacoda.com/user/0</a> ，结果是：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-3-案例-动态更新应用Logger-Level"><a href="#2-3-3-案例-动态更新应用Logger-Level" class="headerlink" title="2.3.3 案例: 动态更新应用Logger Level"></a>2.3.3 案例: 动态更新应用Logger Level</h4><p>在这个案例里，动态修改应用的Logger Level。</p><h5 id="查找UserController的ClassLoader-1"><a href="#查找UserController的ClassLoader-1" class="headerlink" title="查找UserController的ClassLoader"></a>查找UserController的ClassLoader</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span></span><br><span class="line"> classLoaderHash   1be6f5c3</span><br></pre></td></tr></table></figure><h5 id="用ognl获取logger"><a href="#用ognl获取logger" class="headerlink" title="用ognl获取logger"></a>用ognl获取logger</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>可以知道<code>UserController@logger</code>实际使用的是logback。可以看到<code>level=null</code>，则说明实际最终的level是从<code>root</code> logger里来的。</p><h5 id="单独设置UserController的logger-level"><a href="#单独设置UserController的logger-level" class="headerlink" title="单独设置UserController的logger level"></a>单独设置UserController的logger level</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger.setLevel(@ch.qos.logback.classic.Level@DEBUG)&#x27;</span></span></span><br></pre></td></tr></table></figure><p>再次获取<code>UserController@logger</code>，可以发现已经是<code>DEBUG</code>了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt=@Integer[10000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="修改logback的全局logger-level"><a href="#修改logback的全局logger-level" class="headerlink" title="修改logback的全局logger level"></a>修改logback的全局logger level</h5><p>通过获取<code>root</code> logger，可以修改全局的logger level：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).setLevel(@ch.qos.logback.classic.Level@DEBUG)&#x27;</span></span></span><br></pre></td></tr></table></figure><h4 id="2-3-4-案例-排查logger冲突问题"><a href="#2-3-4-案例-排查logger冲突问题" class="headerlink" title="2.3.4 案例: 排查logger冲突问题"></a>2.3.4 案例: 排查logger冲突问题</h4><p>在这个案例里，展示排查logger冲突的方法。</p><h5 id="确认应用使用的logger系统"><a href="#确认应用使用的logger系统" class="headerlink" title="确认应用使用的logger系统"></a>确认应用使用的logger系统</h5><p>以<code>UserController</code>为例，它使用的是slf4j api，但实际使用到的logger系统是logback。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;@com.example.demo.arthas.user.UserController@logger&#x27;</span></span></span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[true],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h5 id="获取logback实际加载的配置文件"><a href="#获取logback实际加载的配置文件" class="headerlink" title="获取logback实际加载的配置文件"></a>获取logback实际加载的配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader <span class="string">&#x27;#map1=@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).loggerContext.objectMap, #map1.get(&quot;CONFIGURATION_WATCH_LIST&quot;)&#x27;</span></span></span><br></pre></td></tr></table></figure><h5 id="使用classloader命令查找可能存在的logger配置文件"><a href="#使用classloader命令查找可能存在的logger配置文件" class="headerlink" title="使用classloader命令查找可能存在的logger配置文件"></a>使用classloader命令查找可能存在的logger配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span></span><br><span class="line"> jar:file:/Users/hengyunabc/code/java/spring-boot-inside/demo-arthas-spring-boot/target/demo-arthas-spring-boot-0.0.1-SNAPSHOT.jar!/BOOT-INF/classes!/logback-spring.xml</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 13 ms.</span><br></pre></td></tr></table></figure><p>可以知道加载的配置的具体来源。</p><p>可以尝试加载容易冲突的文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback.xml</span><br><span class="line"></span><br><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r log4j.properties</span><br></pre></td></tr></table></figure><h4 id="2-3-5-案例-获取Spring-Context"><a href="#2-3-5-案例-获取Spring-Context" class="headerlink" title="2.3.5 案例: 获取Spring Context"></a>2.3.5 案例: 获取Spring Context</h4><p>在这个案例里，展示获取spring context，再获取bean，然后调用函数。</p><h5 id="使用tt命令获取到spring-context"><a href="#使用tt命令获取到spring-context" class="headerlink" title="使用tt命令获取到spring context"></a>使用tt命令获取到spring context</h5><p><code>tt</code>即 TimeTunnel，它可以记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测。</p><ul><li><a href="https://arthas.aliyun.com/doc/tt.html">https://arthas.aliyun.com/doc/tt.html</a></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span></span><br></pre></td></tr></table></figure><p>访问：<a href="https://2886795326-80-host12nc.environments.katacoda.com/user/1">https://2886795326-80-host12nc.environments.katacoda.com/user/1</a></p><p>可以看到<code>tt</code>命令捕获到了一个请求：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdaptePress Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 252 ms.</span><br><span class="line"> INDE  TIMESTAMP    COST(  IS-R  IS-  OBJECT     CLASS               METHOD</span><br><span class="line"> X                  ms)    ET    EXP</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line"> 1000  2019-02-15   4.583  <span class="literal">true</span>  fal  0xc93cf1a  RequestMappingHand  invokeHandlerMethod</span><br><span class="line">       15:38:32     923          se              lerAdapter</span><br></pre></td></tr></table></figure><h5 id="使用tt命令从调用记录里获取到spring-context"><a href="#使用tt命令从调用记录里获取到spring-context" class="headerlink" title="使用tt命令从调用记录里获取到spring context"></a>使用tt命令从调用记录里获取到spring context</h5><p>输入 <code>Q</code> 或者 <code>Ctrl + C</code> 退出上面的 <code>tt -t</code>命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tt -i 1000 -w <span class="string">&#x27;target.getApplicationContext()&#x27;</span></span></span><br><span class="line">@AnnotationConfigEmbeddedWebApplicationContext[</span><br><span class="line">    reader=@AnnotatedBeanDefinitionReader[org.springframework.context.annotation.AnnotatedBeanDefinitionReader@2e457641],</span><br><span class="line">    scanner=@ClassPathBeanDefinitionScanner[org.springframework.context.annotation.ClassPathBeanDefinitionScanner@6eb38026],</span><br><span class="line">    annotatedClasses=null,</span><br><span class="line">    basePackages=null,</span><br><span class="line">]</span><br><span class="line">Affect(row-cnt:1) cost in 439 ms.</span><br></pre></td></tr></table></figure><h5 id="获取spring-bean，并调用函数"><a href="#获取spring-bean，并调用函数" class="headerlink" title="获取spring bean，并调用函数"></a>获取spring bean，并调用函数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1000 -w <span class="string">&#x27;target.getApplicationContext().getBean(&quot;helloWorldService&quot;).getHelloMessage()&#x27;</span></span><br><span class="line">@String[Hello World]</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 52 ms.</span><br></pre></td></tr></table></figure><h4 id="2-3-6-案例-排查HTTP请求返回401"><a href="#2-3-6-案例-排查HTTP请求返回401" class="headerlink" title="2.3.6 案例: 排查HTTP请求返回401"></a>2.3.6 案例: 排查HTTP请求返回401</h4><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><p>结果是：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Something</span> went wrong: <span class="number">401</span> Unauthorized</span><br></pre></td></tr></table></figure><p>我们知道<code>401</code>通常是被权限管理的<code>Filter</code>拦截了，那么到底是哪个<code>Filter</code>处理了这个请求，返回了401？</p><h5 id="跟踪所有的Filter函数"><a href="#跟踪所有的Filter函数" class="headerlink" title="跟踪所有的Filter函数"></a>跟踪所有的Filter函数</h5><p>开始trace：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax<span class="selector-class">.servlet</span><span class="selector-class">.Filter</span> *</span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><p>可以在调用树的最深层，找到<code>AdminFilterConfig$AdminFilter</code>返回了<code>401</code>：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+---<span class="literal">[<span class="number">3.806273</span><span class="identifier">ms</span>]</span> javax.servlet.FilterChain:<span class="keyword">do</span><span class="constructor">Filter()</span></span><br><span class="line"><span class="pattern-match">|   `---[3.447472ms] com.example.demo.arthas.<span class="constructor">AdminFilterConfig$AdminFilter</span>:<span class="keyword">do</span><span class="constructor">Filter()</span></span></span><br><span class="line"><span class="pattern-match">|       `---[0.17259ms] javax.servlet.http.<span class="constructor">HttpServletResponse</span>:send<span class="constructor">Error()</span></span></span><br></pre></td></tr></table></figure><h5 id="通过stack获取调用栈"><a href="#通过stack获取调用栈" class="headerlink" title="通过stack获取调用栈"></a>通过stack获取调用栈</h5><p>上面是通过<code>trace</code>命令来获取信息，从结果里，我们可以知道通过<code>stack</code>跟踪<code>HttpServletResponse:sendError()</code>，同样可以知道是哪个<code>Filter</code>返回了<code>401</code></p><p>执行：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack javax<span class="selector-class">.servlet</span><span class="selector-class">.http</span><span class="selector-class">.HttpServletResponse</span> sendError <span class="string">&#x27;params[0]==401&#x27;</span></span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/admin">https://2886795326-80-host12nc.environments.katacoda.com/admin</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ stack javax.servlet.http.HttpServletResponse sendError <span class="string">&#x27;params[0]==401&#x27;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:2 , method-cnt:4) cost <span class="keyword">in</span> 87 ms.</span><br><span class="line">ts=2019-02-15 16:44:06;thread_name=http-nio-8080-exec-6;id=16;is_daemon=<span class="literal">true</span>;priority=5;TCCL=org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader@8546cd5</span><br><span class="line">    @org.apache.catalina.connector.ResponseFacade.sendError()</span><br><span class="line">        at com.example.demo.arthas.AdminFilterConfig<span class="variable">$AdminFilter</span>.doFilter(AdminFilterConfig.java:38)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br></pre></td></tr></table></figure><h4 id="2-3-7-案例-排查HTTP请求返回404"><a href="#2-3-7-案例-排查HTTP请求返回404" class="headerlink" title="2.3.7 案例: 排查HTTP请求返回404"></a>2.3.7 案例: 排查HTTP请求返回404</h4><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/a.txt">https://2886795326-80-host12nc.environments.katacoda.com/a.txt</a></p><p>结果是：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Something</span> went wrong: <span class="number">404</span> Not Found</span><br></pre></td></tr></table></figure><p>那么到底是哪个Servlet处理了这个请求，返回了404？</p><h5 id="跟踪所有的Servlet函数"><a href="#跟踪所有的Servlet函数" class="headerlink" title="跟踪所有的Servlet函数"></a>跟踪所有的Servlet函数</h5><p>开始trace：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax.servlet.Servlet * &gt; <span class="regexp">/tmp/</span>servlet.txt</span><br></pre></td></tr></table></figure><p>访问： <a href="https://2886795326-80-host12nc.environments.katacoda.com/a.txt">https://2886795326-80-host12nc.environments.katacoda.com/a.txt</a></p><p>在<code>Terminal 3</code>里，查看<code>/tmp/servlet.txt</code>的内容：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">less <span class="regexp">/tmp/</span>servlet.txt</span><br></pre></td></tr></table></figure><p><code>/tmp/servlet.txt</code>里的内容会比较多，需要耐心找到调用树里最长的地方。</p><p>可以发现请求最终是被<code>freemarker</code>处理的：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="operator">---</span>[<span class="number">13</span>.974188ms] org.springframework.web.servlet.<span class="type">ViewResolver</span>:resolveViewName()    <span class="operator">+---</span>[<span class="number">0</span>.045561ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="operator">&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>()    <span class="operator">+---</span>[min<span class="operator">=</span><span class="number">0</span>.045545ms,max<span class="operator">=</span><span class="number">0</span>.074342ms,total<span class="operator">=</span><span class="number">0</span>.119887ms,count<span class="operator">=</span><span class="number">2</span>] org.springframework.web.servlet.view.freemarker.<span class="type">FreeMarkerView</span><span class="variable">$GenericServletAdapter</span>:<span class="operator">&lt;</span><span class="keyword">init</span><span class="operator">&gt;</span>()    <span class="operator">+---</span>[<span class="number">0</span>.170895ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    <span class="operator">|</span>   `<span class="operator">---</span>[<span class="number">0</span>.068578ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    <span class="operator">|</span>       `<span class="operator">---</span>[<span class="number">0</span>.021793ms] javax.servlet.<span class="type">GenericServlet</span>:<span class="function"><span class="keyword">init</span>()</span>    `<span class="operator">---</span>[<span class="number">0</span>.164035ms] javax.servlet.<span class="type">GenericServlet</span>:getServletContext()</span><br></pre></td></tr></table></figure><h4 id="2-3-8-案例-理解Spring-Boot应用的ClassLoader结构"><a href="#2-3-8-案例-理解Spring-Boot应用的ClassLoader结构" class="headerlink" title="2.3.8 案例: 理解Spring Boot应用的ClassLoader结构"></a>2.3.8 案例: 理解Spring Boot应用的ClassLoader结构</h4><p>下面介绍<code>classloader</code>命令的功能。</p><p>先访问一个jsp网页，触发jsp的加载： <a href="https://2886795326-80-host12nc.environments.katacoda.com/hello">https://2886795326-80-host12nc.environments.katacoda.com/hello</a></p><h5 id="列出所有ClassLoader"><a href="#列出所有ClassLoader" class="headerlink" title="列出所有ClassLoader"></a>列出所有ClassLoader</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ classloader -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             <span class="number">2724</span>         null      null</span><br><span class="line"> com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">411</span>ce1ab               <span class="number">2009</span>         <span class="number">411</span>ce1ab  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">22</span>ae1234               <span class="number">1253</span>         <span class="number">22</span>ae1234  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a                  <span class="number">1</span>            <span class="number">65361</span>d9a  TomcatEmbeddedWebappClassLoader</span><br><span class="line">                                                                                           context: ROOT</span><br><span class="line">                                                                                           delegate: true</span><br><span class="line">                                                                                         ----------&gt; Parent Classloader:</span><br><span class="line">                                                                                         org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line"> TomcatEmbeddedWebappClassLoader                                  <span class="number">0</span>            <span class="number">8546</span>cd5   org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line">   context: ROOT</span><br><span class="line">   delegate: true</span><br><span class="line"> ----------&gt; Parent Classloader:</span><br><span class="line"> org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line"> org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3  <span class="number">5416</span>         <span class="number">1</span>be6f5c3  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">3</span>d4eac69</span><br><span class="line"> sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">3</span>d4eac69                        <span class="number">45</span>           <span class="number">3</span>d4eac69  sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528</span><br><span class="line"> sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">7494</span>e528                        <span class="number">4</span>            <span class="number">7494</span>e528  null</span><br></pre></td></tr></table></figure><ul><li>TomcatEmbeddedWebappClassLoader 加载的class数量是0，所以在spring boot embedded tomcat里，它只是一个空壳，所有的类加载都是<code>LaunchedURLClassLoader</code>完成的</li></ul><h5 id="列出ClassLoader里加载的所有类"><a href="#列出ClassLoader里加载的所有类" class="headerlink" title="列出ClassLoader里加载的所有类"></a>列出ClassLoader里加载的所有类</h5><p>列出上面的<code>org.apache.jasper.servlet.JasperLoader</code>加载的类：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">classloader -<span class="selector-tag">a</span> --classLoaderClass org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span><span class="selector-class">.JasperLoader</span></span><br><span class="line">$ classloader -<span class="selector-tag">a</span> --classLoaderClass apache<span class="selector-class">.jasper</span><span class="selector-class">.servlet</span><span class="selector-class">.JasperLoader</span></span><br><span class="line"> hash:<span class="number">1698045338</span>, org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a</span><br><span class="line"> org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span>.hello_jsp</span><br></pre></td></tr></table></figure><ul><li>注：同ognl, 也可用<code>-c &lt;hashcode&gt;</code>而不用<code>--classLoaderClass</code>指定</li></ul><h5 id="反编译jsp的代码"><a href="#反编译jsp的代码" class="headerlink" title="反编译jsp的代码"></a>反编译jsp的代码</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jad org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span><span class="selector-class">.hello_jsp</span></span><br><span class="line">$ jad org<span class="selector-class">.apache</span><span class="selector-class">.jsp</span><span class="selector-class">.jsp</span><span class="selector-class">.hello_jsp</span></span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">65361</span>d9a</span><br><span class="line">  +-TomcatEmbeddedWebappClassLoader</span><br><span class="line">      context: ROOT</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="查看ClassLoader树"><a href="#查看ClassLoader树" class="headerlink" title="查看ClassLoader树"></a>查看ClassLoader树</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">classloader -t</span><br><span class="line">$ classloader -t</span><br><span class="line">+-BootstrapClassLoader</span><br><span class="line">+-sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$ExtClassLoader</span>@<span class="number">28</span>cbbddd</span><br><span class="line">  +-com<span class="selector-class">.taobao</span><span class="selector-class">.arthas</span><span class="selector-class">.agent</span>.ArthasClassloader@<span class="number">8</span>c25e55</span><br><span class="line">  +-sun<span class="selector-class">.misc</span>.Launcher<span class="variable">$AppClassLoader</span>@<span class="number">55</span>f96302</span><br><span class="line">    +-org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line">      +-TomcatEmbeddedWebappClassLoader</span><br><span class="line">          context: ROOT</span><br><span class="line">          delegate: true</span><br><span class="line">        ----------&gt; Parent Classloader:</span><br><span class="line">        org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span>.LaunchedURLClassLoader@<span class="number">1</span>be6f5c3</span><br><span class="line"></span><br><span class="line">        +-org<span class="selector-class">.apache</span><span class="selector-class">.jasper</span><span class="selector-class">.servlet</span>.JasperLoader@<span class="number">21</span>ae0fe2</span><br></pre></td></tr></table></figure><p>注意：请使用你的classLoaderHash值覆盖 <code>&lt;classLoaderHash&gt;</code> ，然后手动执行下面相关命令：</p><h5 id="列出ClassLoader的urls"><a href="#列出ClassLoader的urls" class="headerlink" title="列出ClassLoader的urls"></a>列出ClassLoader的urls</h5><p>比如上面查看到的spring LaunchedURLClassLoader的 hashcode是<code>1be6f5c3</code>，可以通过<code>-c</code>或者<code>--classLoaderClass</code>参数来列出它的所有urls：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line">$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line">jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>classes!/</span><br><span class="line">jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>lib/spring-boot-starter-aop-<span class="number">1.5</span></span><br><span class="line">.<span class="number">13</span>.RELEASE.jar!/</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="加载指定ClassLoader里的资源文件"><a href="#加载指定ClassLoader里的资源文件" class="headerlink" title="加载指定ClassLoader里的资源文件"></a>加载指定ClassLoader里的资源文件</h5><p>查找指定的资源文件： <code>classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</code></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br><span class="line"> jar:<span class="keyword">file</span>:<span class="regexp">/home/</span>scrapbook<span class="regexp">/tutorial/</span>demo-arthas-spring-boot.jar!<span class="regexp">/BOOT-INF/</span>classes!/logback-spring.xml</span><br></pre></td></tr></table></figure><h5 id="尝试加载指定的类"><a href="#尝试加载指定的类" class="headerlink" title="尝试加载指定的类"></a>尝试加载指定的类</h5><p>比如用上面的spring LaunchedURLClassLoader 尝试加载 <code>java.lang.String</code> ：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span><span class="selector-class">.LaunchedURLClassLoader</span> --load java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line">$ classloader --classLoaderClass org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.loader</span><span class="selector-class">.LaunchedURLClassLoader</span> --load java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line">load class success.</span><br><span class="line"> class-info        java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line"> code-source</span><br><span class="line"> name              java<span class="selector-class">.lang</span><span class="selector-class">.String</span></span><br><span class="line"> isInterface       false</span><br><span class="line"> isAnnotation      false</span><br><span class="line"> isEnum            false</span><br><span class="line"> isAnonymousClass  false</span><br><span class="line"> isArray           false</span><br><span class="line"> isLocalClass      false</span><br><span class="line"> isMemberClass     false</span><br><span class="line"> isPrimitive       false</span><br><span class="line"> isSynthetic       false</span><br><span class="line"> simple-name       String</span><br><span class="line"> modifier          final,public</span><br><span class="line"> annotation</span><br><span class="line"> interfaces        java<span class="selector-class">.io</span><span class="selector-class">.Serializable</span>,java<span class="selector-class">.lang</span><span class="selector-class">.Comparable</span>,java<span class="selector-class">.lang</span><span class="selector-class">.CharSequence</span></span><br><span class="line"> super-class       +-java<span class="selector-class">.lang</span><span class="selector-class">.Object</span></span><br><span class="line"> class-loader</span><br><span class="line"> classLoaderHash   null</span><br></pre></td></tr></table></figure><h4 id="2-3-9-案例：查找Top-N线程"><a href="#2-3-9-案例：查找Top-N线程" class="headerlink" title="2.3.9 案例：查找Top N线程"></a>2.3.9 案例：查找Top N线程</h4><h5 id="查看所有线程信息"><a href="#查看所有线程信息" class="headerlink" title="查看所有线程信息"></a>查看所有线程信息</h5><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span></span><br></pre></td></tr></table></figure><h5 id="查看具体线程的栈"><a href="#查看具体线程的栈" class="headerlink" title="查看具体线程的栈"></a>查看具体线程的栈</h5><p>查看线程ID 16的栈：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> <span class="number">16</span></span><br></pre></td></tr></table></figure><h5 id="查看CPU使用率top-n线程的栈"><a href="#查看CPU使用率top-n线程的栈" class="headerlink" title="查看CPU使用率top n线程的栈"></a>查看CPU使用率top n线程的栈</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> -n <span class="number">3</span></span><br></pre></td></tr></table></figure><h5 id="查看5秒内的CPU使用率top-n线程栈"><a href="#查看5秒内的CPU使用率top-n线程栈" class="headerlink" title="查看5秒内的CPU使用率top n线程栈"></a>查看5秒内的CPU使用率top n线程栈</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">thread</span> -n <span class="number">3</span> -i <span class="number">5000</span></span><br></pre></td></tr></table></figure><h5 id="查找线程是否有阻塞"><a href="#查找线程是否有阻塞" class="headerlink" title="查找线程是否有阻塞"></a>查找线程是否有阻塞</h5><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">thread</span> -b</span><br></pre></td></tr></table></figure><h3 id="2-4-Web-Console"><a href="#2-4-Web-Console" class="headerlink" title="2.4 Web Console"></a>2.4 Web Console</h3><p>Arthas支持通过Web Socket来连接。</p><h4 id="教程里的Web-Console"><a href="#教程里的Web-Console" class="headerlink" title="教程里的Web Console"></a>教程里的Web Console</h4><p><a href="http://2886795326-8563-host12nc.environments.katacoda.com/?ip=2886795326-8563-host12nc.environments.katacoda.com&amp;port=80">http://2886795326-8563-host12nc.environments.katacoda.com/?ip=2886795326-8563-host12nc.environments.katacoda.com&amp;port=80</a></p><blockquote><p>注意：教程里访问的是80端口，因为做了端口转发。在本地体验时，需要访问8563端口。</p></blockquote><h4 id="本地体验"><a href="#本地体验" class="headerlink" title="本地体验"></a>本地体验</h4><p>当在本地启动时，可以访问 <a href="http://127.0.0.1:8563/">http://127.0.0.1:8563/</a> ，通过浏览器来使用Arthas。</p><p><img src="https://katacoda.com/arthas/scenarios/common-resources/assets/web-console.png" alt="Arthas WebConsole"></p><p>推荐通过“快速入门”来体验： <a href="https://arthas.aliyun.com/doc/quick-start.html">https://arthas.aliyun.com/doc/quick-start.html</a></p><h3 id="2-5-Exit-Stop"><a href="#2-5-Exit-Stop" class="headerlink" title="2.5 Exit/Stop"></a>2.5 Exit/Stop</h3><ul><li><p>reset：Arthas在 watch/trace 等命令时，实际上是修改了应用的字节码，插入增强的代码。显式执行 <code>reset</code> 命令，可以清除掉这些增强代码。</p></li><li><p>退出Arthas：</p><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出Arthas。</p><p>退出Arthas之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p></li><li><p>彻底退出Arthas：</p><p><code>exit/quit</code>命令只是退出当前session，arthas server还在目标进程中运行。</p><p>想完全退出Arthas，可以执行 <code>stop</code> 命令。</p></li></ul><h3 id="2-6-arthas-boot支持的参数"><a href="#2-6-arthas-boot支持的参数" class="headerlink" title="2.6 arthas-boot支持的参数"></a>2.6 arthas-boot支持的参数</h3><p><code>arthas-boot.jar</code> 支持很多参数，可以执行 <code>java -jar arthas-boot.jar -h</code> 来查看。</p><ul><li><p>允许外部访问：</p><p>默认情况下， arthas server侦听的是 <code>127.0.0.1</code> 这个IP，如果希望远程可以访问，可以使用<code>--target-ip</code>的参数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --target-ip</span></span><br></pre></td></tr></table></figure></li><li><p>列出所有的版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --versions</span></span><br></pre></td></tr></table></figure><p>使用指定版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --use-version 3.1.0</span></span><br></pre></td></tr></table></figure></li><li><p>只侦听Telnet端口，不侦听HTTP端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar --telnet-port 9999 --http-port -1</span></span><br></pre></td></tr></table></figure></li><li><p>打印运行的详情：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar arthas-boot.jar -v</span></span><br></pre></td></tr></table></figure></li></ul><hr><p>参考：</p><p>🔗 <a href="https://arthas.aliyun.com/">Arthas官网</a></p><p>🔗 <a href="https://arthas.aliyun.com/doc/index.html">Arthas 用户文档 — Arthas 3.5.4 文档 (aliyun.com)</a></p>]]></content>
    
    
    <summary type="html">内容包括：简介，教程（入门、进阶、案例）等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="jvm" scheme="http://linyishui.top/tags/jvm/"/>
    
    <category term="Arthas" scheme="http://linyishui.top/tags/Arthas/"/>
    
  </entry>
  
  <entry>
    <title>Oracle优化器hint</title>
    <link href="http://linyishui.top/2021090601.html"/>
    <id>http://linyishui.top/2021090601.html</id>
    <published>2021-09-06T12:51:44.000Z</published>
    <updated>2021-09-14T01:29:18.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Oracle优化器hint"><a href="#Oracle优化器hint" class="headerlink" title="Oracle优化器hint"></a>Oracle优化器hint</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><p>优化器hint可以与SQL语句一起使用来改变执行计划。在SQL中使用hint来提高性能。hints（除了RULE-hint）会使Oracle使用基于成本的优化器，语法格式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 其中HINT被hint文本所取代，当hint文本的语法不正确时，hint文本被忽略，不会被使用。</span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ HINT */</span> name</span><br><span class="line"><span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">where</span> id <span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>hint可以让你做一些通常由优化器做出的决定。作为开发者，你可能知道一些优化器不知道的数据信息。hint提供了一种机制，指示优化器根据特定的标准选择某种查询执行计划。</p><p>例如，你可能知道某个索引对某些查询更有选择性。基于这些信息，你可能会选择一个比优化器更有效的执行计划。在这种情况下，可以使用hint来指示优化器使用最佳执行计划。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 优化器选择employees.department_id列上的一个索引，来查找其部门ID 超过<span class="number">50</span>的雇员中的前<span class="number">25</span>行。优化器使用从索引中检索到的rowid，从雇员表中检索相应记录，并将其返回给客户端。第一条记录的检索通常几乎是在瞬间即可完成的。</span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FIRST_ROWS(25) */</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> hr.employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&gt;</span> <span class="number">50</span>;</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> Operation <span class="operator">|</span> Name <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT <span class="operator">|</span> <span class="operator">|</span> <span class="number">26</span> <span class="operator">|</span> <span class="number">182</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID <span class="operator">|</span> EMPLOYEES <span class="operator">|</span> <span class="number">26</span> <span class="operator">|</span> <span class="number">182</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">2</span> <span class="operator">|</span> INDEX <span class="keyword">RANGE</span> SCAN <span class="operator">|</span> EMP_DEPARTMENT_IX <span class="operator">|</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"># 无提示<span class="keyword">SELECT</span>语句的执行计划</span><br><span class="line"><span class="keyword">SELECT</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> hr.employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">&gt;</span> <span class="number">50</span>;</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> Operation <span class="operator">|</span> Name <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes <span class="operator">|</span> Cos</span><br><span class="line"><span class="comment">------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT <span class="operator">|</span> <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">1</span> <span class="operator">|</span> <span class="keyword">VIEW</span> <span class="operator">|</span> index$_join$_001 <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">2</span> <span class="operator">|</span> HASH <span class="keyword">JOIN</span> <span class="operator">|</span> <span class="operator">|</span> <span class="operator">|</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span> <span class="number">3</span> <span class="operator">|</span> INDEX <span class="keyword">RANGE</span> SCAN <span class="operator">|</span> EMP_DEPARTMENT_IX <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> INDEX FAST <span class="keyword">FULL</span> SCAN<span class="operator">|</span> EMP_EMP_ID_PK <span class="operator">|</span> <span class="number">50</span> <span class="operator">|</span> <span class="number">350</span> <span class="operator">|</span></span><br><span class="line"></span><br><span class="line">将两个索引联接以尽可能快的返回请求的记录。优化器并不像上述hint那样多次在表和索引间倒腾，而是在EMP_DEPARTMENT_IX索引上使用范围扫描，找出所有部门ID超过<span class="number">50</span>的行，并将这些行放在一个哈希表中。然后优化器读取EMP_EMP_ID_PK索引。对该索引中的每一行，它探测一次该哈希表，以查找相应的部门id。</span><br><span class="line"></span><br><span class="line">在这种情况下，数据库不能在完成对EMP_DEPARTMENT_IX索引的范围扫描之前向客户端返回第一行。因此，此生成的计划将需要更长的时间返回第一条记录。与示例中按索引rowid访问表的计划不同，计划使用多数据块 I<span class="operator">/</span>O，导致大量读取操作。这种读取使得整个结果集的最后一行会更快地返回。</span><br></pre></td></tr></table></figure><h2 id="二-Hint种类"><a href="#二-Hint种类" class="headerlink" title="二. Hint种类"></a>二. Hint种类</h2><h3 id="2-1-几种hint类别"><a href="#2-1-几种hint类别" class="headerlink" title="2.1 几种hint类别"></a>2.1 几种hint类别</h3><ul><li><p>Single-table：</p><p>单表hint是在一个表或视图上指定的，如：<code>INDEX</code> ，<code>USE_NL</code>。</p></li><li><p>Multi-table</p><p>多表hint与单表hint一样，只是hint可以指定一个或多个表或视图。如： <code>LEADING</code> ，<code>USE_NL(table1 table2)</code> ，<code>USE_NL(table1)</code> ，<code>USE_NL(table2)</code> 。</p></li><li><p>Query block</p><p>查询块hint对单个查询块进行操作，如：<code>STAR_TRANSFORMATION</code> ，<code>UNNEST</code> 。</p></li><li><p>Statement</p><p>语句hint适用于整个SQL语句，如 <code>ALL_ROWS</code> 。</p></li></ul><h3 id="2-2-常见hint"><a href="#2-2-常见hint" class="headerlink" title="2.2 常见hint"></a>2.2 常见hint</h3><p>优化器的hint分为以下几类:</p><ul><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDFIAJD">Hints for Optimization Approaches and Goals</a>：优化方法和目标的hint<ul><li><code>ALL_ROWS</code>：明确地选择了基于成本的方法来优化语句块，目标是最佳吞吐量（即最小的总资源消耗）。</li><li><code>FIRST_ROWS(n)</code>：明确地选择了基于成本的方法来优化语句块，目标是最佳响应时间（返回第一行的最小资源占用）。在较新的Oracle版本中，你应该给这个提示一个参数：<code>FIRST_ROWS(n)</code> 意味着优化器将确定一个执行计划，为返回前n行提供快速响应。</li><li><code>CHOOSE</code>：使优化器在基于规则的方法和基于成本的方法之间选择一个SQL语句，基于该语句所访问的表的统计信息的存在。</li><li><code>RULE</code>：为一个语句块明确地选择了基于规则的优化。这个提示也导致优化器忽略了为语句块指定的任何其他提示。RULE提示在Oracle 10g中不再起作用。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDJDIAH">Hints for Access Paths</a>：访问路径的hint<ul><li><code>FULL</code>：明确地选择了对指定表进行全表扫描。FULL提示的语法是FULL(table)，其中table指定了要进行全表扫描的表的别名（如果别名不存在，则是表名）。</li><li><code>ROWID</code>：明确地选择了对指定表进行ROWID扫描。ROWID提示的语法是 <code>ROWID(table)</code> ，其中table指定了要进行ROWID表访问的表的名称或别名。(这个提示在Oracle 10g中被废弃)</li><li><code>CLUSTER</code>：明确地选择了集群扫描来访问指定的表。CLUSTER提示的语法是 <code>CLUSTER(table)</code> ，其中table指定了要被集群扫描访问的表的名称或别名。</li><li><code>HASH</code>：明确地选择了一个散列扫描来访问指定的表。HASH提示的语法是 <code>HASH(table)</code> ，其中table指定要通过散列扫描访问的表的名称或别名。</li><li><code>HASH_AJ</code>：将一个NOT IN子查询转换为一个哈希反连接，以访问指定的表。HASH_AJ提示的语法是 <code>HASH_AJ(table)</code> ，其中table指定了要访问的表的名称或别名（在Oracle 10g中被废弃）。</li><li><code>INDEX</code>：明确地选择了对指定表的索引扫描。INDEX提示的语法是 <code>INDEX(table index)</code> ，其中:table指定与要扫描的索引相关的表的名称或别名，index指定要进行索引扫描的索引。这个提示可以选择性地指定一个或多个索引。</li><li><code>NO_INDEX</code>：明确地禁止为指定的表建立一组索引。NO_INDEX提示的语法是NO_INDEX(表索引)</li><li><code>INDEX_ASC</code>：明确地选择了对指定表的索引扫描。如果语句使用索引范围扫描，Oracle会按照索引值的升序扫描索引条目。</li><li><code>INDEX_COMBINE</code>：如果没有索引作为INDEX_COMBINE提示的参数，优化器将在表上使用位图索引的任何布尔组合，具有最佳成本估计。如果给出了某些索引作为参数，优化器将尝试使用这些特定位图索引的一些布尔组合。INDEX_COMBINE的语法是INDEX_COMBINE(表索引)。</li><li><code>INDEX_JOIN</code>：明确指示优化器使用一个索引连接作为访问路径。为了使提示产生积极的效果，必须存在足够少的索引，包含解决查询所需的所有列。</li><li><code>INDEX_DESC</code>：明确地选择了对指定表的索引扫描。如果语句使用索引范围扫描，Oracle会按照索引值的降序扫描索引条目。</li><li><code>INDEX_FFS</code>：这个提示导致执行快速的全索引扫描，而不是全表扫描。</li><li><code>NO_INDEX_FFS</code>：不要使用快速全索引扫描（来自Oracle 10g）。</li><li><code>INDEX_SS</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>INDEX_SS_ASC</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>INDEX_SS_DESC</code>：从查询计划中排除范围扫描（来自Oracle 10g）。</li><li><code>NO_INDEX_SS</code>：导致优化器排除对指定表的指定索引进行跳过扫描（来自Oracle 10g）。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDEHFHG">Hints for Query Transformations</a>：查询转换的hint<ul><li><code>NO_QUERY_TRANSFORMATION</code>：防止优化器进行查询转换（来自Oracle 10g）。</li><li><code>USE_CONCAT</code>：强制将查询的WHERE子句中的组合OR条件转化为使用UNION ALL集合操作符的复合查询。通常情况下，只有当使用连接条件的查询成本比不使用连接条件的查询成本低时，才会发生这种转换。</li><li><code>NO_EXPAND</code>：阻止优化器对WHERE子句中具有OR条件或IN列表的查询考虑OR扩展。通常情况下，优化器会考虑使用OR扩展，如果它认为成本比不使用它低，就会使用这种方法。</li><li><code>REWRITE</code>：强制优化器在可能的情况下以物化视图的方式重写查询，而不考虑成本。无论是否有视图列表，都可以使用REWRITE提示。如果你使用REWRITE和一个视图列表，并且该列表包含一个合格的物化视图，那么Oracle会使用该视图，而不考虑其成本。</li><li><code>NOREWRITE / NO_REWRITE</code>：在Oracle 10g中改名为NO_REWRITE。NOREWRITE/NO_REWRITE提示禁用了查询块的查询重写，覆盖了参数 <code>QUERY_REWRITE_ENABLED</code> 的设置。</li><li><code>MERGE</code>：可以让你在一个查询中合并视图。</li><li><code>NO_MERGE</code>：使Oracle不合并可合并的视图。这个提示最常被用来减少查询的可能排列组合的数量，使优化更快。</li><li><code>FACT</code>：表示该表应该被认为是一个事实表。这是在星形转换的背景下使用的。</li><li><code>NO_FACT</code>：在星形转换的上下文中使用，向转换表明提示的表不应该被视为事实表。</li><li><code>STAR_TRANSFORMATION</code>：使优化器使用已使用转换的最佳计划。如果没有这个提示，优化器可以做出查询优化的决定，使用没有转换的最佳计划，而不是转换后的查询的最佳计划。</li><li><code>NO_STAR_TRANSFORMATION</code>：不使用星形转换（来自Oracle 10g）。</li><li><code>UNNEST</code>：指定子查询的不嵌套。</li><li><code>NO_UNNEST</code>：可以关闭特定子查询块的不嵌套。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDGGCHC">Hints for Join Orders</a>：联接顺序的hint<ul><li><code>LEADING</code>：给出这个hint以指示连接中的主导表，将只表示1个表。可以使用ORDERED指定整个表的顺序。语法：<code>LEADING(table)</code> 。</li><li><code>ORDERED</code>：使Oracle按照表在FROM子句中出现的顺序连接表。如果你在执行连接的SQL语句中省略了ORDERED提示，优化器会选择连接表的顺序。如果你知道一些优化器不知道的从每个表中选择的行数，你可能想使用ORDERED提示来指定一个连接顺序。这些信息可以让你比优化器更好地选择内表和外表。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDBAFID">Hints for Join Operations</a>：连接操作的hint<ul><li><code>USE_NL</code>：使Oracle以嵌套循环连接的方式将每个指定的表与另一个记录源连接起来，并以指定的表作为内表。USE_NL提示的语法是 <code>USE_NL(table table)</code> ，其中table是一个表的名称或别名，将被用作嵌套循环连接的内表。</li><li><code>NO_USE_NL</code>：不要使用嵌套循环（来自Oracle 10g）。</li><li><code>USE_NL_WITH_INDEX</code>：指定一个嵌套的循环连接（来自Oracle 10g）。</li><li><code>USE_MERGE</code>：会使Oracle以排序合并连接的方式将每个指定的表与另一个行源连接起来。USE_MERGE提示的语法是 <code>USE_MERGE(table)</code> ，其中table是一个要连接到行源的表，这个行源是用排序合并连接的方式连接前面的表而得到的。</li><li><code>NO_USE_MERGE</code>：不要使用合并（来自Oracle 10g）。</li><li><code>USE_HASH</code>：使Oracle以散列连接的方式将每个指定的表与另一个行源连接。USE_HASH提示的语法是 <code>USE_HASH(table table)</code> ，其中table是一个要连接到行源的表，这个行源是用散列连接的方式连接前面的表而得到的。</li><li><code>NO_USE_HASH</code>：不要使用哈希（来自Oracle 10g）。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDJIGDG">Hints for Parallel Execution</a>：并行执行的hint<ul><li><code>PARALLEL</code>：允许你指定可用于查询的并发查询服务器的数量。语法是PARALLEL(表号数)。如果在查询中指定了别名，PARALLEL提示必须使用表的别名。然后，PARALLEL提示可以取两个值，在表名后面用逗号分隔。第一个值指定给定表的并行程度，第二个值指定该表如何在并行服务器的实例中被分割。指定DEFAULT或没有值表示查询协调器应该检查初始化参数的设置（在后面的章节中描述）以确定默认的并行程度。</li><li><code>NOPARALLEL / NO_PARALLEL</code>：允许你禁用一个表的并行扫描，即使该表是用PARALLEL子句创建的。在Oracle 10g中，这个提示被重新命名为NO_PARALLEL。</li><li><code>PQ_DISTRIBUTE</code>：提高了并行连接操作的性能。通过指定连接表的行应该如何在生产者和消费者查询服务器之间分配来做到这一点。使用这个提示会覆盖优化器通常会做出的决定。</li><li><code>NO_PARALLEL_INDEX</code>：覆盖了一个索引上的PARALLEL属性设置，以避免平行索引扫描操作。</li></ul></li><li><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#CHDIDIDI">Additional Hints</a>：其他hint<ul><li><code>APPEND</code>：当APPEND提示与INSERT语句一起使用时，数据被追加到表中。区块中现有的自由空间不被使用。如果一个表或索引被指定为nologging，这个提示与一个插入语句一起使用会产生一个直接的路径插入，从而减少重做的产生。</li><li><code>NOAPPEND</code>：覆盖附加模式。</li><li><code>CACHE</code>：指定当进行全表扫描时，为提示中的表检索的块被放置在缓冲区缓存的LRU列表中最近使用的一端。这个选项对于小的查询表很有用。在下面的例子中，CACHE提示覆盖了表的默认缓存规范。</li><li><code>NOCACHE</code>：当执行全表扫描时，为该表检索的块被放在缓冲区缓存中LRU列表的最近使用的一端。这是缓冲区缓存中块的正常行为。</li><li><code>PUSH_PRED</code>：强制将连接谓词推入视图。</li><li><code>NO_PUSH_PRED</code>：防止将连接谓词推入视图。</li><li><code>PUSH_SUBQ</code>：使非合并子查询在执行计划中尽可能早地被评估。</li><li><code>NO_PUSH_SUBQ</code>：导致非合并子查询作为执行计划的最后一步被评估。</li><li><code>QB_NAME</code>：为一个查询块指定一个名称（来自Oracle 10g）。</li><li><code>CURSOR_SHARING_EXACT</code>：如果安全的话，Oracle可以用绑定变量替换SQL语句中的字面意思。这是由CURSOR_SHARING启动参数控制的。CURSOR_SHARING_EXACT提示使这种行为被关闭。换句话说，Oracle在执行SQL语句时，不会试图用绑定变量替换字面意义。</li><li><code>DRIVING_SITE</code>：强制在与Oracle选择的站点不同的站点上对表执行查询。</li><li><code>DYNAMIC_SAMPLING</code>：可以让你控制动态采样，通过确定表和索引的更精确的谓词选择性和统计数据来提高服务器性能。你可以将DYNAMIC_SAMPLING的值设置为0到10的数值。级别越高，编译器在动态采样方面投入的精力越多，应用也越广泛。除非你指定一个表，否则采样的默认值是游标级。</li><li><code>SPREAD_MIN_ANALYSIS</code>：这个提示省略了一些规则的编译时间优化，主要是详细的依赖图分析，在电子表格上。一些优化，如创建过滤器以有选择地填充电子表格访问结构和有限的规则修剪仍然被使用（来自Oracle 10g）。</li></ul></li><li>Hints with unknown status：hint<ul><li><code>MERGE_AJ</code>：将一个NOT IN子查询转换为一个合并反连接，以访问指定的表。MERGE_AJ提示的语法是 <code>MERGE_AJ(table)</code> ，其中table指定要访问的表的名称或别名。</li><li><code>AND_EQUAL</code>：明确地选择了一个执行计划，该计划使用一个访问路径，合并了几个单列索引的扫描。AND_EQUAL提示的语法是 <code>AND_EQUAL(table index index)</code> ，其中table指定了与要合并的索引相关的表的名称或别名，index指定了一个要进行索引扫描的索引。你必须至少指定两个索引。你不能指定超过五个。(在Oracle 10g中被废弃)</li><li><code>STAR</code>：迫使大表使用索引上的嵌套循环连接最后被连接。优化器将考虑小表的不同排列组合。(在Oracle 10g中被废弃)</li><li><code>BITMAP</code>：<code>BITMAP(table_name index_name)</code> 使用一个位图索引来访问表。(depricated ?)</li><li><code>HASH_SJ</code>：使用 <code>Hash Anti-Join</code> 来评估一个NOT IN子查询。在子查询中使用这个提示，而不是在主查询中。当你的大量NOT IN子查询使用FILTER或NESTED LOOPS连接时，使用这个提示。如果HASH_AJ拒绝工作，请尝试MERGE_AJ。（在Oracle 10g中被废弃）</li><li><code>NL_SJ</code>：在一个子查询中使用嵌套循环。(在Oracle 10g中被废弃)</li><li><code>NL_AJ</code>：在一个子查询中使用反连接。(在Oracle 10g中被废弃)</li><li><code>ORDERED_PREDICATES</code>：(在Oracle 10g中被废弃)</li><li><code>EXPAND_GSET_TO_UNION</code>：(在Oracle 10g中被废弃)</li></ul></li></ul><h2 id="三-hint语句归纳"><a href="#三-hint语句归纳" class="headerlink" title="三. hint语句归纳"></a>三. hint语句归纳</h2><h3 id="3-1-使用列表"><a href="#3-1-使用列表" class="headerlink" title="3.1 使用列表"></a>3.1 使用列表</h3><ol><li> <code>/*+ ALL_ROWS*/</code>：表明对语句块选择基于开销的优化方法，并获得最佳吞吐量，使资源消耗最小化。</li></ol>   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ALL_ROWS*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure><ol start="2"><li><p><code>/*+ FIRST_ROWS*/</code>：表明对语句块选择基于开销的优化方法，并获得最佳响应时间，使资源消耗最小化。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FIRST_ROWS*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ CHOOSE*/</code>：表明如果数据字典中有访问表的统计信息，将基于开销的优化方法，并获得最佳的吞吐量;表明如果数据字典中没有访问表的统计信息，将基于规则开销的优化方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ CHOOSE*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ RULE*/</code>：表明对语句块选择基于规则的优化方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ RULE*/</span> EMP_NO,EMP_NAM,DAT_IN <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ FULL(TABLE)*/</code>：表明对表选择全局扫描的方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(A)*/</span> EMP_NO,EMP_NAM <span class="keyword">FROM</span> BSEMPMS A <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ROWID(TABLE)*/</code>：提示明确表明对指定表根据ROWID进行访问。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ROWID(BSEMPMS)*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> ROWID<span class="operator">&gt;=</span>’AAAAAAAAAAAAAA’ <span class="keyword">AND</span> EMP_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ CLUSTER(TABLE)*/</code>：提示明确表明对指定表选择簇扫描的访问方法，它只对簇对象有效。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ CLUSTER*/</span> BSEMPMS.EMP_NO,DPT_NO <span class="keyword">FROM</span> BSEMPMS,BSDPTMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span>’TEC304′ <span class="keyword">AND</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX(TABLE INDEX_NAME)*/</code>：表明对表选择索引的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX(BSEMPMS SEX_INDEX) USE SEX_INDEX BECAUSE THERE ARE FEWMALE BSEMPMS */</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SEX<span class="operator">=</span>’M<span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_ASC(TABLE INDEX_NAME)*/</code>：表明对表选择索引升序的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_ASC(BSEMPMS PK_BSEMPMS) */</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span>’SCOTT’;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_COMBINE*/</code>：为指定表选择位图访问路经，如果INDEX_COMBINE中没有提供作为参数的索引，将选择出位图索引的布尔组合方式。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_COMBINE(BSEMPMS SAL_BMI HIREDATE_BMI)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SAL<span class="operator">&lt;</span><span class="number">5000000</span> <span class="keyword">AND</span> HIREDATE</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_JOIN(TABLE INDEX_NAME)*/</code>：提示明确命令优化器使用索引作为访问路径。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_JOIN(BSEMPMS SAL_HMI HIREDATE_BMI)*/</span> SAL,HIREDATE <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> SAL<span class="operator">&lt;</span><span class="number">60000</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_DESC(TABLE INDEX_NAME)*/</code>：表明对表选择索引降序的扫描方法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_DESC(BSEMPMS PK_BSEMPMS)*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;SCOTT&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ INDEX_FFS(TABLE INDEX_NAME)*/</code>：对指定的表执行快速全索引扫描,而不是全表扫描的办法。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ INDEX_FFS(BSEMPMS IN_EMPNAM)*/</span>  <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TEC305&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ADD_EQUAL TABLE INDEX_NAM1,INDEX_NAM2,...*/</code>：提示明确进行执行规划的选择，将几个单列索引的扫描合起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ADD_EQUAL(BSEMPMS IN_DPTNO,IN_EMPNO,IN_SEX)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> EMP_NO<span class="operator">=</span><span class="string">&#x27;SCOTT&#x27;</span> <span class="keyword">AND</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC306&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_CONCAT*/</code>：对查询中的WHERE后面的OR条件进行转换为UNION ALL的组合查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ USE_CONCAT*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC506&#x27;</span> <span class="keyword">AND</span> SEX<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NO_EXPAND*/</code>：对于WHERE后面的OR 或者IN-LIST的查询语句，NO_EXPAND将阻止其基于优化器对其进行扩展。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ NO_EXPAND*/</span> <span class="keyword">FROM</span> BSEMPMS <span class="keyword">WHERE</span> DPT_NO<span class="operator">=</span><span class="string">&#x27;TDC506&#x27;</span> <span class="keyword">AND</span> SEX<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOWRITE*/</code>：禁止对查询块的查询重写操作。</p></li><li><p><code>/*+ REWRITE*/</code>：可以将视图作为参数。</p></li><li><p><code>/*+ MERGE(TABLE)*/</code>：能够对视图的各个查询进行相应的合并。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ MERGE(V) */</span> A.EMP_NO,A.EMP_NAM,B.DPT_NO </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS A, (SELET DPT_NO,<span class="built_in">AVG</span>(SAL) <span class="keyword">AS</span> AVG_SAL </span><br><span class="line">                 <span class="keyword">FROM</span> BSEMPMS B </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> DPT_NO) V </span><br><span class="line"><span class="keyword">WHERE</span> A.DPT_NO<span class="operator">=</span>V.DPT_NO </span><br><span class="line">  <span class="keyword">AND</span> A.SAL<span class="operator">&gt;</span>V.AVG_SAL;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NO_MERGE(TABLE)*/</code>：对于有可合并的视图不再合并。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ NO_MERGE(V)*/</span> A.EMP_NO,A.EMP_NAM,B.DPT_NO </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS A, (<span class="keyword">SELECT</span> DPT_NO,<span class="built_in">AVG</span>(SAL) <span class="keyword">AS</span> AVG_SAL </span><br><span class="line">                 <span class="keyword">FROM</span> BSEMPMS B </span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> DPT_NO) V </span><br><span class="line"><span class="keyword">WHERE</span> A.DPT_NO<span class="operator">=</span>V.DPT_NO </span><br><span class="line">  <span class="keyword">AND</span> A.SAL<span class="operator">&gt;</span>V.AVG_SAL;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ ORDERED*/</code>：根据表出现在FROM中的顺序，ORDERED使ORACLE依此顺序对其连接。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ ORDERED*/</span> A.COL1,B.COL2,C.COL3 </span><br><span class="line"><span class="keyword">FROM</span> TABLE1 A,TABLE2 B,TABLE3 C </span><br><span class="line"><span class="keyword">WHERE</span> A.COL1<span class="operator">=</span>B.COL1 <span class="keyword">AND</span> B.COL1<span class="operator">=</span>C.COL1;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_NL(TABLE)*/</code>：将指定表与嵌套的连接的行源进行连接，并把指定表作为内部表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ORDERED USE_NL(BSEMPMS)*/</span> BSDPTMS.DPT_NO,BSEMPMS.EMP_NO,BSEMPMS.EMP_NAM </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_MERGE(TABLE)*/</code>：将指定的表与其他行源通过合并排序连接方式连接起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+USE_MERGE(BSEMPMS,BSDPTMS)*/</span> </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ USE_HASH(TABLE)*/</code>：将指定的表与其他行源通过哈希连接方式连接起来。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+USE_HASH(BSEMPMS,BSDPTMS)*/</span> </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,BSDPTMS </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>BSDPTMS.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ DRIVING_SITE(TABLE)*/</code>：强制与ORACLE所选择的位置不同的表进行查询执行。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+DRIVING_SITE(DEPT)*/</span>  </span><br><span class="line"><span class="keyword">FROM</span> BSEMPMS,DEPT<span class="variable">@BSDPTMS</span> </span><br><span class="line"><span class="keyword">WHERE</span> BSEMPMS.DPT_NO<span class="operator">=</span>DEPT.DPT_NO;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ LEADING(TABLE)*/</code>：将指定的表作为连接次序中的首表。</p></li><li><p><code>/*+ CACHE(TABLE)*/</code>：当进行全表扫描时，CACHE提示能够将表的检索块放置在缓冲区缓存中最近最少列表LRU的最近使用端。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(BSEMPMS) CAHE(BSEMPMS) */</span> EMP_NAM <span class="keyword">FROM</span> BSEMPMS;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOCACHE(TABLE)*/</code>：当进行全表扫描时，CACHE提示能够将表的检索块放置在缓冲区缓存中最近最少列表LRU的最近使用端。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(BSEMPMS) NOCAHE(BSEMPMS) */</span> EMP_NAM <span class="keyword">FROM</span> BSEMPMS;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ APPEND*/</code>：直接插入到表的最后，可以提高速度。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="comment">/*+ append*/</span> <span class="keyword">into</span> test1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test4;</span><br></pre></td></tr></table></figure></li><li><p><code>/*+ NOAPPEND*/</code>：通过在插入语句生存期内停止并行模式来启动常规插入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="comment">/*+ noappend*/</span> <span class="keyword">into</span> test1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test4;</span><br></pre></td></tr></table></figure></li></ol><table><thead><tr><th align="center"><strong>Optimization Approaches</strong></th><th align="center"><strong>Access Methods</strong></th></tr></thead><tbody><tr><td align="center">ALL_ROWS</td><td align="center">AND_EQUAL</td></tr><tr><td align="center">CHOOSE</td><td align="center">CLUSTER</td></tr><tr><td align="center">FIRST RULES</td><td align="center">FULL</td></tr><tr><td align="center">RULE</td><td align="center">HASH</td></tr><tr><td align="center">Parallel Execution</td><td align="center">HASH_AJ</td></tr><tr><td align="center">APPEND*ORDERED</td><td align="center">HASH_SJ ***</td></tr><tr><td align="center">STAR**</td><td align="center">INDEX</td></tr><tr><td align="center">STAR_TRANSFORMATION*</td><td align="center">INDEX_ASC</td></tr><tr><td align="center">Join Operations</td><td align="center">INDEX_COMBINE*</td></tr><tr><td align="center">DRIVING_SITE*</td><td align="center">INDEX_DESC</td></tr><tr><td align="center">USE_HASH**</td><td align="center">INDEX_FFS*</td></tr><tr><td align="center">USE_MERGE</td><td align="center">MERGE_AJ**</td></tr><tr><td align="center">USE_NL</td><td align="center">MERGE_SJ***</td></tr><tr><td align="center"><strong>Additional Hints</strong></td><td align="center">ROW_ID</td></tr><tr><td align="center">CACHE</td><td align="center">USE_CONCAT</td></tr><tr><td align="center">NOCACHE</td><td align="center">NO_EXPAND***</td></tr><tr><td align="center">PUSH_SUBQ</td><td align="center">REWRITE***</td></tr><tr><td align="center">MERGE***</td><td align="center">NOREWRITE***</td></tr><tr><td align="center">NO_MERGE*</td><td align="center">Join Orders</td></tr><tr><td align="center">PUSH_JOIN_PRED***</td><td align="center"></td></tr><tr><td align="center">NO_PUSH_JOIN_PRED***</td><td align="center">NOAPPEND*</td></tr><tr><td align="center">ORDERED PREDICATES***</td><td align="center">NOPARALLEL</td></tr><tr><td align="center"></td><td align="center">PARALLEL</td></tr><tr><td align="center"></td><td align="center">PARALLEL_INDEX*</td></tr><tr><td align="center"></td><td align="center">NO_PARALLEL_INDEX***</td></tr></tbody></table><h3 id="3-2-使用注意"><a href="#3-2-使用注意" class="headerlink" title="3.2 使用注意"></a>3.2 使用注意</h3><p>使用提示需要遵循的原则：</p><ol><li>仔细检查提示语法。尽量使用完整注释语法 <code>/*+ hint */</code> 。</li><li>使用表别名。如果在查询中指定了表别名，那么提示必须也使用表别名。例如：<code>select /*+ index(e,dept_idx) */ from emp e;</code> 。</li><li>不要在提示中使用模式名称：如果在提示中指定了模式的所有者，那么提示将被忽略。例如：<code>select /*+ index(scott.emp,dept_idx) */ from emp;</code> 。</li><li>检验提示。如果提示指定了不可用的访问路径，那么这个提示将被忽略。</li></ol><p>导致提示无效的条件：</p><table><thead><tr><th>提示</th><th>被忽略的条件</th></tr></thead><tbody><tr><td>cluster</td><td>与非簇表一同使用</td></tr><tr><td>hash</td><td>与非簇表一同使用</td></tr><tr><td>hash_aj</td><td>不存在子查询</td></tr><tr><td>index</td><td>指定的索引不存在</td></tr><tr><td>index_combine</td><td>不存在位图索引</td></tr><tr><td>merge_aj</td><td>不存在子查询</td></tr><tr><td>parallel</td><td>调用的不是TABLE ACCESS FULL计划</td></tr><tr><td>push_subq</td><td>不存在子查询</td></tr><tr><td>star</td><td>事实表中存在不恰当的索引</td></tr><tr><td>use_concat</td><td>在where子句中不存在多个or条件</td></tr><tr><td>use_nl</td><td>表中不存在索引</td></tr></tbody></table><p>几种主要的优化模式：</p><ol><li>all_rows：all_rows是基于成本的优化方法，目的是提供整体最佳的吞吐量和最小的资源消耗。all_rows提示倾向使用全表扫描，而且不适用于OLTP数据库。使用all_rows提示应该保障查询中涉及的表和索引拥有使用analyze命令分析得到的统计资料。</li><li>rule：rule提示使Oracle为查询提供基于规则的优化模式。在怀疑CBO生成了非优化的执行计划时，通常首先尝试使用rule提示。Rule提示忽略表和索引的统计资料，并且使用基本的试探法生成执行计划。</li><li>first_rows：这个提示是基于成本的优化方法，目的是提供最快的反应时间。使用first_rows提示应该保障查询中涉及的表和索引拥有使用analyze命令分析得到的统计资料。</li><li>表的连接提示<ul><li>use_hash提示：use_hash 提示对指定的表进行散列连接。散列连接是Oracle用以驱动表（最小的表）向RAM区中装载记录的方法，RAM区由HASH_AREA_SIZE定义。散列连接适合中间结果比较大的情况。使用散列连接时,HASH_AREA_SIZE对速度影响非常大，如果驱动表不能一次装入内存，那么需要使用TEMP表空间，这种情况下速度比较慢。这个参数可以在session级别动态修改，需要进行散列连接时可以临时增大，速度可能显着增加。</li><li>use_merge 提示：use_merge 提示强制执行一个排序合并操作。排序合并操作通常与并行查询结合使用，因为排序合并操作倾向于全表扫描。该提示适合于生成大型结果集的查询。</li><li>use_nl：use_nl提示将强制对目标表执行嵌套循环连接。use_nl提示很少用于SQL调整，因为CBO和RBO更倾向于使用循环嵌套连接。</li><li>star提示：star 提示强制使用星型查询计划。前提是查询中至少三个表，而且在事实表中存在恰当的索引</li></ul></li><li>表反连接提示：SQL反连接是指在语句中包含NOT IN 或者NOT EXISTS子句时执行的操作。<ul><li>merge_aj：在使用全表访问比索引访问更好的情况下，可以在NOT IN子查询中使用merge_aj提示以便执行反连接。</li><li>hash_aj：hash_aj 提示放在NOT IN 子查询中用来希望执行散列连接时，执行散列反连接。hash_aj和merge_aj要求子查询列非空。</li></ul></li><li>INDEX提示：<ul><li>INDEX提示简介：INDEX提示被用于显示指定表名或表名与索引。如果只指定了表名，那么优化器将使用表中的”最优”索引。在永久优化SQL语句中，建议指定表和索引。</li><li>index_join 提示：index_join 提示明确要求优化器使用索引连接来作为访问路径。</li><li>and_equal 提示：and_equal 提示可以使多个非唯一的索引合并索引，并且使这些索引操作时就象单个连续索引一样。该提示如果被应用，在查询计划中显示的是AND-EQUAL</li><li>index_asc 提示：index_asc 提示使用升序索引。这是默认的优化器行为</li><li>no_index 提示：该提示忽略索引存在，类似full</li><li>index_combine提示：index_combine 提示用来强制使用位图索引作为表的访问路径。</li><li>index_ffs提示：索引快速完全扫描可以在不访问任何记录的情况下完成查询。</li><li>use_concat提示：use_concat提示要求为所有的OR条件使用UNION ALL执行计划，并将这个查询重新书写为多个查询。如果在WHERE子句中存在大量OR条件，可以考虑使用use_concat提示。</li></ul></li></ol><p>总结：</p><ol><li>因为提示放在注释中，所以如果提示通现存的执行计划不兼容，或者提示不正确，有可能被忽略。</li><li>在使用RBO时，可以通过提示将指定的查询更改为CBO。切记要对查询中涉及的所有表和索引进行分析</li><li>在使用CBO的时候，可以通过添加RULE提示或者FIRST_ROWS提示来开始调整一个可以的SQL语句</li><li>提示可以在子查询中使用，但是外部查询的提示不会带入子查询。</li><li>如果在查询计划中发现卡笛尔积（CARTESIAN），则要尽量解决。</li></ol><h2 id="四-深入剖析"><a href="#四-深入剖析" class="headerlink" title="四. 深入剖析"></a>四. 深入剖析</h2><h3 id="4-1-表连接hint"><a href="#4-1-表连接hint" class="headerlink" title="4.1 表连接hint"></a>4.1 表连接hint</h3><p>Oracle提供了各种类型的表连接：</p><ul><li><p>嵌套循环连接（nested loops join）：可以看作两层嵌套的for循环</p><ul><li><strong>访问次数：</strong>驱动表返回几条，被驱动表访问多少次。</li><li><strong>驱动表是否有顺序：</strong>有。</li><li><strong>是否要排序：</strong>否。</li><li><strong>应用场景：</strong><ol><li>关联中有一个表比较小；</li><li>被关联表的关联字段上有索引；</li><li>索引的键值不应该重复率很高</li></ol></li></ul></li><li><p>排序合并连接（sort merge join）</p><ul><li><p><strong>访问次数：</strong>两张表都只会访问0次或1次。</p></li><li><p><strong>驱动表是否有顺序：</strong>无。</p></li><li><p><strong>是否要排序：</strong>是。</p></li><li><p><strong>应用场景：</strong>当结果集已经排过序。</p></li><li><p>如果A表的数据为（2,1,4,5,2）,B表的数据为(2,2,1,3,1) ,首先将A表和B表全扫描后排序，如下：</p><pre><code>          A    B                1     1                2     1                2     2                4     2                5     3</code></pre><p>因为没有驱动表，所以oracle会随机选择一张表驱动，如果选择了A扫描到1，然后扫描B，当扫描=1的时候则管理，当扫描到B=2时，再以B=2为驱动扫描A表，不是从1开始扫，而是从2开始扫描，交替的进行扫描、关联。</p></li></ul></li><li><p>哈希连接（hash join）：先把驱动表的关联字段hash到PGA中（rowid也在PGA中），然后扫描被驱动表，取第一条数据，将关联的字段hash一下探测PGA中的小表，如果匹配则关联，再取第二条…。</p><ul><li><strong>访问次数：</strong>驱动表和被驱动表都只会访问0次或1次。</li><li><strong>驱动表是否有顺序：</strong>有。</li><li><strong>是否要排序：</strong>否。</li><li><strong>应用场景：</strong> <ol><li>一个大表，一个小表的关联；</li><li>表上没有索引；</li><li>返回结果集比较大。</li></ol></li></ul></li><li><p>星形连接（star join）等。</p></li></ul><p>因为表连接是所有Oracle SQL执行步骤中最耗时的，Oracle对表连接的hint经常被用来测试各种连接技术的执行速度。</p><h4 id="（1）use-hash"><a href="#（1）use-hash" class="headerlink" title="（1）use_hash"></a>（1）use_hash</h4><p>use_hash提示要求对指定的表进行散列连接。从本质上讲，散列连接是一种Oracle将驱动表（最小的表，在where子句之后的第一个表）中的行加载到由hash_area_size初始化参数定义的RAM区域的技术。</p><p>Oracle使用散列技术来定位较大的第二个表中的记录。在两个表都非常大的情况下，散列连接经常与并行查询相结合。</p><p>下面的查询是一个被提示强制使用散列连接和并行查询的例子：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+ use_hash(e,b) parallel(e, 4) parallel(b, 4) */</span></span><br><span class="line">   e.ename, hiredate, b.comm</span><br><span class="line"><span class="keyword">from</span> emp e, bonus b</span><br><span class="line"><span class="keyword">where</span> e.ename <span class="operator">=</span> b.ename;</span><br><span class="line"># 下面是哈希连接的执行计划。注意这个连接中的两个表都使用并行查询来获得它们的记录。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">3</span></span><br><span class="line">  HASH <span class="keyword">JOIN</span>                                                          <span class="number">1</span></span><br><span class="line">PARALLEL_TO_SERIAL</span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>           EMP                                  <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>           BONUS                                <span class="number">2</span></span><br></pre></td></tr></table></figure><p>哈希连接通常比嵌套的循环连接更快，特别是在查询的where子句中，驱动表被过滤成少数行的情况下。</p><p>use_hash提示是非常微妙的，有许多条件必须得到满足。发现use_hash提示被忽略的情况并不少见，下面是造成这个问题的一些常见原因：</p><ul><li><strong>检查初始化参数</strong>：确保你对 <code>optimizer_index_cost_adj</code> 、<code>hash_multiblock_io_count</code> 、<code>optimizer_max_permutations</code> 和 <code>hash_area_size</code> 有进行适当的设置。</li><li><strong>验证驱动表</strong>：确保较小的表是驱动表（从句中的第一个表）。这是因为哈希连接使用驱动表建立内存阵列。</li><li><strong>分析CBO统计数据</strong>：检查表的和/或连接的关联表的列是否得到了适当的分析。</li><li><strong>检查偏斜的列（skewed columns ）</strong>：Histograms只建议用于非均匀的列分布。如果有必要，你可以使用 <code>ordered</code> 提示覆盖基于成本的优化器选择的连接顺序。</li><li><strong>检查RAM区域：</strong>确保 <code>hash_area_size</code> 足够大，以便在内存中容纳较小的表。否则，Oracle必须写到TEMP表空间，减慢散列连接的速度。</li></ul><h4 id="（2）use-merge"><a href="#（2）use-merge" class="headerlink" title="（2）use_merge"></a>（2）use_merge</h4><p>use_merge提示强制进行分类合并操作。排序合并操作经常与并行查询一起使用，因为排序合并连接总是对表进行全表扫描。排序合并连接通常最适合于产生非常大的结果集的查询，例如每日报告或表的细节汇总查询，或者在连接键上不具有索引的表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 通过对两个表的并行查询来执行分类合并的</span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+ use_merge(e,b) parallel(e, 4) parallel(b, 4) */</span></span><br><span class="line">   e.ename, hiredate, b.comm</span><br><span class="line"><span class="keyword">from</span> emp e, bonus b</span><br><span class="line"><span class="keyword">where</span> e.ename <span class="operator">=</span> b.ename;</span><br><span class="line"># 注意全表扫描和排序合并操作。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">5</span></span><br><span class="line">  <span class="keyword">MERGE</span> <span class="keyword">JOIN</span>                                                         <span class="number">1</span></span><br><span class="line">PARALLEL_TO_SERIAL</span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        <span class="number">1</span></span><br><span class="line">PARALLEL_COMBINED_WITH_PARENT</span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>         EMP                                  <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        <span class="number">2</span></span><br><span class="line">PARALLEL_COMBINED_WITH_PARENT</span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>         BONUS                                <span class="number">1</span></span><br><span class="line">PARALLEL_TO_PARALLEL</span><br></pre></td></tr></table></figure><p>值得注意的是，排序合并连接并不使用索引来连接表。在大多数情况下，索引访问更快，但是排序合并连接可能适合于没有where子句的大型表连接，或者没有可用索引连接表的查询。</p><h3 id="4-2-表反连接hint（Anti-Join）"><a href="#4-2-表反连接hint（Anti-Join）" class="headerlink" title="4.2 表反连接hint（Anti-Join）"></a>4.2 表反连接hint（Anti-Join）</h3><p>SQL的反连接是一种操作，一般在SQL语句中指定 <code>NOT IN</code> 或 <code>NOT EXISTS</code> 子句时使用。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">   customer_name</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">   customer</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">   customer_number <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">       customer_number</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">       bad_credit_history</span><br><span class="line">   )</span><br><span class="line">;</span><br></pre></td></tr></table></figure><p>一般不建议使用NOT IN（调用子查询），而是使用NOT EXISTS（调用相关的子查询），因为如果子查询返回的任何记录包含空值，则查询不返回任何记录。</p><h4 id="（1）merge-aj"><a href="#（1）merge-aj" class="headerlink" title="（1）merge_aj"></a>（1）merge_aj</h4><p>merge_aj用于NOT IN子查询中，来执行反连接，表示全表访问优先于索引访问。</p><p>一个NOT IN案例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 查询所有没有销售员的部门的名称。</span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 当子查询中的数据列允许为空值时，这种类型的查询的性能会非常差。子查询对于外部查询块中的每一条记录都要重新执行一次<span class="operator">!</span> 下面是执行计划：</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">1</span></span><br><span class="line">  <span class="keyword">FILTER</span>                                                             <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>             DEPT                               <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID   EMP                                <span class="number">2</span></span><br><span class="line">      INDEX <span class="keyword">RANGE</span> SCAN            JOB_IDX                            <span class="number">1</span></span><br></pre></td></tr></table></figure><p>NOT IN子查询有替代方法，它不会为外层查询块中的每条记录重新生成一次子查询；当外层查询块产生大量的记录时，应该考虑这种方法。</p><p>这个方法只能在子查询列上存在NOT NULL谓词并且你在子查询块中有一个hint时使用。根据所需的连接类型，反连接可以通过hash_aj或merge_aj的hint来执行。</p><p>注意：<strong>反连接提示merge_aj和hash_aj只有在not in子句中要求的列有NOT NULL约束时才会起作用。</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 优化后：</span><br><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> <span class="comment">/*+ merge_aj */</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 查询的执行计划发生了变化，合并反连接被调用，代替了过滤操作。</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">5</span></span><br><span class="line">  <span class="keyword">MERGE</span> <span class="keyword">JOIN</span> ANTI                                                    <span class="number">1</span></span><br><span class="line">    SORT <span class="keyword">JOIN</span>                                                        </span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>                  DEPT                        <span class="number">1</span></span><br><span class="line">    SORT <span class="keyword">UNIQUE</span>                                                      <span class="number">2</span></span><br><span class="line">      <span class="keyword">VIEW</span>                               VW_NSO_1                    <span class="number">1</span></span><br><span class="line">        <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID      EMP                         <span class="number">1</span></span><br><span class="line">          INDEX <span class="keyword">RANGE</span> SCAN               JOB_IDX                     <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="（2）hash-aj"><a href="#（2）hash-aj" class="headerlink" title="（2）hash_aj"></a>（2）hash_aj</h4><p>hash_aj提示被放置在一个not in子查询中，以便在需要散列连接的情况下执行散列反连接。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname</span><br><span class="line"><span class="keyword">from</span> dept</span><br><span class="line"><span class="keyword">where</span> deptno <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">   (<span class="keyword">select</span> <span class="comment">/*+ hash_aj */</span> deptno</span><br><span class="line">    <span class="keyword">from</span> emp</span><br><span class="line">    <span class="keyword">where</span> job <span class="operator">=</span> <span class="string">&#x27;SALESMAN&#x27;</span>);</span><br><span class="line"># 执行计划指定了一个散列连接，并对部门表进行全表扫描：</span><br><span class="line">OPERATION</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line">OPTIONS                        OBJECT_NAME                    POSITION</span><br><span class="line"><span class="comment">------------------------------ ---------------------------- ----------</span></span><br><span class="line"> <span class="keyword">SELECT</span> STATEMENT                                                    <span class="number">3</span></span><br><span class="line">  HASH <span class="keyword">JOIN</span> ANTI                                                     <span class="number">1</span></span><br><span class="line">    <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>               DEPT                             <span class="number">1</span></span><br><span class="line">    <span class="keyword">VIEW</span>                            VW_NSO_1                         <span class="number">2</span></span><br><span class="line">      <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID   EMP                              <span class="number">1</span></span><br><span class="line">        INDEX <span class="keyword">RANGE</span> SCAN            JOB_IDX                          <span class="number">1</span></span><br></pre></td></tr></table></figure><p>总之，merge_aj和hash_aj提示可以极大地提高NOT IN子查询的性能，前提是子查询的列是NOT NULL。</p><h2 id="五-案例"><a href="#五-案例" class="headerlink" title="五. 案例"></a>五. 案例</h2><h3 id="5-1-NOT-EXISTS优化"><a href="#5-1-NOT-EXISTS优化" class="headerlink" title="5.1 NOT EXISTS优化"></a>5.1 NOT EXISTS优化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_d, e.col_e, e.col_f, e.col_g,e.col_h</span><br><span class="line"><span class="keyword">from</span> Table_A e </span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_c <span class="keyword">in</span> (<span class="keyword">select</span> a.col_c</span><br><span class="line">      <span class="keyword">from</span> Table_A a</span><br><span class="line">                      <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a </span><br><span class="line">    <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                        <span class="keyword">and</span> a.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                        <span class="keyword">and</span> a.col_d <span class="keyword">in</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">                            <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> Table_B b </span><br><span class="line">                            <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                              <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">                              <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b </span><br><span class="line">                              <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"># 修改为：</span><br><span class="line">                  </span><br><span class="line"><span class="keyword">select</span> <span class="comment">/*+LEADING(D) NO_MERGE(D)*/</span></span><br><span class="line">   e.col_a, e.col_b, e.col_c,e.col_d, e.col_e, e.col_f, e.col_g, e.col_h</span><br><span class="line"><span class="keyword">from</span> Table_A e, (<span class="keyword">select</span> <span class="keyword">DISTINCT</span> a.col_c</span><br><span class="line"> <span class="keyword">from</span> Table_A a</span><br><span class="line"> <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a</span><br><span class="line">   <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">   <span class="keyword">and</span> a.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                   <span class="keyword">and</span> a.col_d <span class="keyword">in</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">                   <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="comment">/*+ HASH_AJ*/</span><span class="number">1</span></span><br><span class="line">               <span class="keyword">from</span> Table_B b</span><br><span class="line">                                   <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                                     <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c</span><br><span class="line">                                     <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">                                     <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))) D</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">AND</span> e.col_c <span class="operator">=</span> D.col_c;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c.col_a,c.col_b,c.col_c,c.col_e,c.col_g,c.col_f,c.col_i,</span><br><span class="line">c.col_d,c.col_j,c.col_k,c.col_l</span><br><span class="line"><span class="keyword">from</span> Table_A c</span><br><span class="line"><span class="keyword">where</span> c.col_a <span class="operator">=</span> :col_a </span><br><span class="line">  <span class="keyword">and</span> c.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>) </span><br><span class="line">  <span class="keyword">and</span> c.col_b <span class="operator">&lt;=</span> :trade_date </span><br><span class="line">  <span class="keyword">and</span> c.col_c <span class="keyword">in</span> (<span class="keyword">select</span> col_c </span><br><span class="line">                  <span class="keyword">from</span> Table_A a</span><br><span class="line">  <span class="keyword">where</span> a.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                    <span class="keyword">and</span> a.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                    <span class="keyword">and</span> a.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                    <span class="keyword">and</span> a.col_j <span class="operator">=</span> <span class="number">38</span></span><br><span class="line">                    <span class="keyword">and</span> a.col_d <span class="operator">=</span> <span class="string">&#x27;64&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.col_h <span class="keyword">in</span> (<span class="string">&#x27;15&#x27;</span>,<span class="string">&#x27;16&#x27;</span>)</span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> Table_B b </span><br><span class="line">                            <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">                              <span class="keyword">and</span> a.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">                              <span class="keyword">and</span> a.col_b <span class="operator">=</span> b.col_b </span><br><span class="line">                              <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">                    )</span><br><span class="line">                 )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改为：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+LEADING(D) NO_MERGE(D)*/</span> </span><br><span class="line">       C.col_a,</span><br><span class="line">       C.col_b,</span><br><span class="line">       C.col_c,</span><br><span class="line">       C.col_e,</span><br><span class="line">       C.col_g,</span><br><span class="line">       C.col_f,</span><br><span class="line">       C.col_i,</span><br><span class="line">       C.col_d,</span><br><span class="line">       C.col_j,</span><br><span class="line">       C.col_k,</span><br><span class="line">       C.col_l</span><br><span class="line"><span class="keyword">FROM</span> Table_A C,(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> col_c</span><br><span class="line">                <span class="keyword">FROM</span> Table_A A</span><br><span class="line">                <span class="keyword">WHERE</span> A.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                  <span class="keyword">AND</span> A.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">                <span class="keyword">AND</span> A.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">                <span class="keyword">AND</span> A.col_j <span class="operator">=</span> <span class="number">38</span></span><br><span class="line">                <span class="keyword">AND</span> A.col_d <span class="operator">=</span> <span class="string">&#x27;64&#x27;</span></span><br><span class="line">                <span class="keyword">AND</span> A.col_h <span class="keyword">IN</span> (<span class="string">&#x27;15&#x27;</span>, <span class="string">&#x27;16&#x27;</span>)</span><br><span class="line">                <span class="keyword">AND</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">                    <span class="keyword">SELECT</span> <span class="comment">/*+ HASH_AJ*/</span><span class="number">1</span></span><br><span class="line">                    <span class="keyword">FROM</span> Table_B B</span><br><span class="line">                    <span class="keyword">WHERE</span> B.col_a <span class="operator">=</span> :col_a</span><br><span class="line">                      <span class="keyword">AND</span> A.col_c <span class="operator">=</span> B.col_c</span><br><span class="line">                      <span class="keyword">AND</span> A.col_b <span class="operator">=</span> B.col_b</span><br><span class="line">                      <span class="keyword">AND</span> B.TRADE_TYPE <span class="keyword">IN</span> (<span class="number">6</span>,<span class="number">7</span>))) D</span><br><span class="line"><span class="keyword">WHERE</span> C.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">AND</span> C.col_b <span class="operator">&gt;=</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">AND</span> C.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">AND</span> C.col_c <span class="operator">=</span> D.col_c</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_e, e.col_g, e.col_f, e.col_i,e.col_n, e.col_o, e.col_d, e.col_p, e.col_q, e.col_r, e.col_s, e.col_t, e.col_u, e.col_j, e.col_v, e.col_w, e.col_k, e.col_x</span><br><span class="line"><span class="keyword">from</span> Table_A e</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_j <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">37</span>)</span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">      <span class="keyword">select</span> <span class="number">1</span> </span><br><span class="line">      <span class="keyword">from</span> Table_B b </span><br><span class="line">      <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a </span><br><span class="line">        <span class="keyword">and</span> e.col_c <span class="operator">=</span> b.col_c </span><br><span class="line">        <span class="keyword">and</span> e.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">        <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_y</span><br><span class="line"></span><br><span class="line"># 修改为： </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_e,e.col_g, e.col_f, e.col_i,e.col_n, e.col_o, e.col_d, e.col_p,e.col_q, e.col_r, e.col_s, e.col_t,e.col_u, e.col_j, e.col_v, e.col_w, e.col_k, e.col_x</span><br><span class="line"><span class="keyword">from</span> Table_A e</span><br><span class="line"><span class="keyword">where</span> e.col_a <span class="operator">=</span> :col_a</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&lt;=</span> :trade_date</span><br><span class="line">  <span class="keyword">and</span> e.col_b <span class="operator">&gt;</span> (:trade_date <span class="operator">-</span> <span class="number">31</span>)</span><br><span class="line">  <span class="keyword">and</span> e.col_j <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">18</span>,<span class="number">37</span>)</span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span> ( </span><br><span class="line">      <span class="keyword">select</span> <span class="comment">/*+ HASH_AJ*/</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">from</span> Table_B b</span><br><span class="line">      <span class="keyword">where</span> b.col_a <span class="operator">=</span> :col_a</span><br><span class="line">        <span class="keyword">and</span> e.col_c <span class="operator">=</span> b.col_c</span><br><span class="line">        <span class="keyword">and</span> e.col_b <span class="operator">=</span> b.col_b</span><br><span class="line">        <span class="keyword">and</span> b.trade_type <span class="keyword">in</span> (<span class="number">6</span>,<span class="number">7</span>))</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> e.col_a, e.col_b, e.col_c, e.col_m, e.col_y</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#i17496">Using Optimizer Hints</a></p><p>🔗 <a href="https://www.oradev.com/hints.jsp">Hints for Oracle sql performance</a></p><p>🔗 <a href="https://www.cnblogs.com/sopost/archive/2010/10/11/2190076.html">ORACLE常用SQL优化hint语句</a></p><p>🔗 <a href="https://www.cnblogs.com/emilyyoucan/p/7844795.html">oracle中hint 详解</a></p><p>🔗 <a href="http://www.remote-dba.net/t_op_sql_join_hints.htm">Table Join Hints</a></p><p>🔗 <a href="http://www.remote-dba.net/t_op_sql_anti_join_hints.htm">Table Anti-Join Hints</a></p><p>🔗 <a href="https://blog.csdn.net/stevendbaguo/article/details/13775915">嵌套循环连接(nested loops join)原理</a></p>]]></content>
    
    
    <summary type="html">内容包括：等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="oracle" scheme="http://linyishui.top/tags/oracle/"/>
    
  </entry>
  
  <entry>
    <title>MySql临时表</title>
    <link href="http://linyishui.top/2021082701.html"/>
    <id>http://linyishui.top/2021082701.html</id>
    <published>2021-08-27T03:19:24.000Z</published>
    <updated>2021-08-31T01:14:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="临时表"><a href="#临时表" class="headerlink" title="临时表"></a>临时表</h1><h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><p>非压缩的，用户创建的临时表和磁盘内部临时表共享一个存储空间，通过 <code>innodb_temp_data_file_path</code> 变量定义临时表空间数据文件的相对路径、名称、大小和属性。默认为 <code>innodb_data_home_dir</code> 目录下创建一个名为ibtmp1的自动扩展的数据文件，该文件略大于12MB。</p><p><strong>临时表空间会在正常关机或初始化中止时被移除，并在每次服务器启动时被重新创建。如果服务器意外停止，临时表空间不会被删除。在这种情况下，数据库管理员可以手动删除临时表空间，或者重新启动服务器，服务器会自动删除并重新创建临时表空间。</strong></p><p><em>（5.6版本，非压缩的临时表是在临时文件目录中的每个文件的表空间中创建的，在MySQL 5.7中引入的共享临时表空间消除了与为每个临时表创建和删除逐个文件表空间有关的性能成本）</em></p><p>在 MySQL 5.7 之前， SQL 运行中产生的临时表是 MYISAM，而且只能是 MYISAM。MySQL 从 5.7 开始提供了参数 <code>Internal_tmp_mem_storage_engine</code> 来定义内部的临时表引擎，可选值为 MYISAM 和 INNODB 。内部的临时表默认保存在临时表空间 ibtmp1 (可以用参数 <code>innodb_temp_data_file_path</code> 设置大小等)。需要注意控制 ibtmp1 的大小，防止把磁盘撑爆。</p><p>但是MySQL 5.7 之前都没有解决如下问题：</p><ul><li>VARCHAR的变长存储。如果临时表的字段定义是 <code>VARCHAR(200)</code> ，映射到内存里处理的字段变为<code>CHAR(200)</code> ，假设 <code>VARCHAR(200)</code> 只存一个字符会造成浪费。</li><li>大对象的默认磁盘存储，比如 TEXT，BLOB， JSON等，不管里面存放了什么，直接转化为磁盘存储。</li></ul><p>MySQL 8.0 开始，专门实现了一个临时表的引擎 TempTable , 解决了 VARCHAR 字段的边长存储以及大对象的内存存储。由变量 <code>interal_tmp_mem_storage_engine</code> 来控制，可选值为 <code>TempTable</code>（默认）和 <code>Memory</code> ；新引擎的大小由参数 <code>temp_table_max_ram</code> 来控制，默认为1G。超过了则存储在磁盘上（ibtmp1）。并且计数器由性能字典的表 <code>memory_summary_global_by_event_name</code> 来存储。</p><h2 id="二-查看当前临时表信息"><a href="#二-查看当前临时表信息" class="headerlink" title="二. 查看当前临时表信息"></a>二. 查看当前临时表信息</h2><p><code>INFORMATION_SCHEMA.FILES</code> 提供关于InnoDB临时表空间的元数据，这些临时表目前在InnoDB实例中是活跃的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES <span class="keyword">WHERE</span> TABLESPACE_NAME<span class="operator">=</span><span class="string">&#x27;innodb_temporary&#x27;</span>;</span><br></pre></td></tr></table></figure><p>那么这两种临时表的计数器通常用 <code>show global status like &#39;%tmp_%tables%&#39;</code>  来查看。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;%tmp_%tables%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%tmp_%tables%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Created_tmp_disk_tables <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Created_tmp_tables      <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>以上结果分别代表，只创建磁盘上的临时表计数以及临时表的总计数。这两个计数器由参数 <code>tmp_table_size</code> 和 <code>max_heap_table_size</code> 两个取最小值来控制。</p><p><code>memory/ temptable/physical_disk</code> 代表放入磁盘上的临时表计数情况，<code>memory/temptable/physical_ram</code>  代表放入内存的临时表计数情况。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema. memory_summary_global_by_event_name <span class="keyword">WHERE</span> event_name <span class="keyword">like</span> <span class="string">&#x27;%temptable%&#x27;</span>G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>                  EVENT_NAME: <span class="operator">*</span><span class="operator">*</span>memory<span class="operator">/</span>temptable<span class="operator">/</span>physical_disk<span class="operator">*</span><span class="operator">*</span>                 </span><br><span class="line">COUNT_ALLOC: <span class="number">0</span>                  </span><br><span class="line">COUNT_FREE: <span class="number">0</span>   </span><br><span class="line">SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">0</span>    </span><br><span class="line">SUM_NUMBER_OF_BYTES_FREE: <span class="number">0</span>              </span><br><span class="line">LOW_COUNT_USED: <span class="number">0</span>          </span><br><span class="line">CURRENT_COUNT_USED: <span class="number">0</span>             </span><br><span class="line">HIGH_COUNT_USED: <span class="number">0</span>    </span><br><span class="line">LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">0</span>   </span><br><span class="line">HIGH_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>                  EVENT_NAME: <span class="operator">*</span><span class="operator">*</span>memory<span class="operator">/</span>temptable<span class="operator">/</span>physical_ram<span class="operator">*</span><span class="operator">*</span>                 </span><br><span class="line">COUNT_ALLOC: <span class="number">1</span>                  </span><br><span class="line">COUNT_FREE: <span class="number">0</span>   </span><br><span class="line">SUM_NUMBER_OF_BYTES_ALLOC: <span class="number">1048576</span>    </span><br><span class="line">SUM_NUMBER_OF_BYTES_FREE: <span class="number">0</span>              </span><br><span class="line">LOW_COUNT_USED: <span class="number">0</span>          </span><br><span class="line">CURRENT_COUNT_USED: <span class="number">1</span>             </span><br><span class="line">HIGH_COUNT_USED: <span class="number">1</span>    </span><br><span class="line">LOW_NUMBER_OF_BYTES_USED: <span class="number">0</span></span><br><span class="line">CURRENT_NUMBER_OF_BYTES_USED: <span class="number">1048576</span>   </span><br><span class="line">HIGH_NUMBER_OF_BYTES_USED: <span class="number">1048576</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure><h2 id="三-临时表空间大小"><a href="#三-临时表空间大小" class="headerlink" title="三. 临时表空间大小"></a>三. 临时表空间大小</h2><p>默认情况下，临时表空间数据文件是自动扩展的，并根据需要增加大小以适应磁盘上的临时表。例如，如果一个操作创建了一个大小为20MB的临时表，临时表空间数据文件在创建时默认为12MB大小，它的大小会扩展以适应它。当临时表被丢弃时，释放的空间可以重新用于新的临时表，但是<strong>数据文件仍然是扩展的大小</strong>。</p><p>在使用大型临时表或广泛使用临时表的环境中，<strong>自动扩展的临时表空间数据文件可能变得很大</strong>。一个大的数据文件也可能来自使用临时表的长期运行的查询。</p><p>通过检查 <code>innodb_temp_data_file_path</code> 设置确认一个临时表空间数据文件是否是自动扩展的：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> @<span class="variable">@innodb</span>_temp_data_file_path;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb</span>_temp_data_file_path <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> ibtmp1:<span class="number">12</span>M:autoextend        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br></pre></td></tr></table></figure><p>检查临时表空间数据文件的大小：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> FILE_NAME, TABLESPACE_NAME, ENGINE, INITIAL_SIZE, TOTAL_EXTENTS<span class="operator">*</span>EXTENT_SIZE</span><br><span class="line">       <span class="keyword">AS</span> TotalSizeBytes, DATA_FREE, MAXIMUM_SIZE <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES</span><br><span class="line">       <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;innodb_temporary&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      FILE_NAME: .<span class="operator">/</span>ibtmp1</span><br><span class="line">TABLESPACE_NAME: innodb_temporary</span><br><span class="line">         ENGINE: InnoDB</span><br><span class="line">   INITIAL_SIZE: <span class="number">12582912</span></span><br><span class="line"> TotalSizeBytes: <span class="number">12582912</span></span><br><span class="line">      DATA_FREE: <span class="number">6291456</span></span><br><span class="line">   MAXIMUM_SIZE: <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure><p><code>TotalSizeBytes</code> 表示临时表空间数据文件的当前大小。</p><p>临时表相关配置：</p><ul><li><code>tmp_table_size</code> ：指定系统创建的内存临时表最大大小； </li><li><code>max_heap_table_size</code> : 指定用户创建的内存表的最大大小；</li></ul><p>注意：最终的系统创建的内存临时表大小是取上述两个配置值的最小值。</p><h2 id="四-MySQL创建临时表的场景"><a href="#四-MySQL创建临时表的场景" class="headerlink" title="四. MySQL创建临时表的场景"></a>四. MySQL创建临时表的场景</h2><p>MySQL临时表分为<strong>内存临时表</strong>和<strong>磁盘临时表</strong>，其中内存临时表使用MySQL的MEMORY存储引擎，磁盘临时表使用MySQL的MyISAM存储引擎；</p><p>一般情况下，MySQL会先创建内存临时表，但内存临时表超过配置指定的值后，MySQL会将内存临时表导出到磁盘临时表；Linux平台上缺省是/tmp目录，/tmp目录小的系统需要注意。</p><h3 id="4-1-内存临时表"><a href="#4-1-内存临时表" class="headerlink" title="4.1 内存临时表"></a>4.1 内存临时表</h3><p><strong>MySQL在以下几种情况会创建临时表：</strong></p><ol><li>UNION查询；</li><li>用到TEMPTABLE算法或者是UNION查询中的视图；</li><li>ORDER BY和GROUP BY的子句不一样时， 例如：<code>ORDERY BY price GROUP BY name</code> ；</li><li>表连接中，ORDER BY的列不是驱动表中的。在JOIN查询中，ORDER BY或者GROUP BY使用了不是第一个表的列，例如：<code>SELECT * from TableA, TableB ORDER BY TableA.price GROUP by TableB.name</code> ；</li><li>ORDER BY中使用了DISTINCT关键字 <code>ORDERY BY DISTINCT(price)</code> ；</li><li>SQL中用到SQL_SMALL_RESULT选项时，SELECT语句中指定了SQL_SMALL_RESULT关键字，意思就是告诉MySQL结果会很小，请直接使用内存临时表，不需要使用索引排序 SQL_SMALL_RESULT必须和GROUP BY、DISTINCT或DISTINCTROW一起使用 一般情况下，我们没有必要使用这个选项，让MySQL服务器选择即可。</li><li>FROM中的子查询；</li><li>子查询或者semi-join时创建的表；</li></ol><p>EXPLAIN 查看执行计划结果的 Extra 列中，如果包含 <a href="http://imysql.com/2015/06/14/mysql-faq-what-important-information-in-explain.shtml">Using Temporary</a> 就表示会用到临时表。</p><p>当然了，如果临时表中需要存储的数据量超过了上限（ <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_tmp_table_size">tmp-table-size</a> 或 <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_max_heap_table_size">max-heap-table-size</a> 中取其大者），这时候就需要生成基于磁盘的临时表了。</p><h3 id="4-2-磁盘临时表"><a href="#4-2-磁盘临时表" class="headerlink" title="4.2 磁盘临时表"></a>4.2 磁盘临时表</h3><p><strong>在以下几种情况下，会创建磁盘临时表：</strong></p><ol><li>数据表中包含BLOB/TEXT列；</li><li>在 <code>GROUP BY</code> 或者 <code>DISTINCT</code> 的列中有超过512字符的字符类型列（或者超过 512字节的二进制类型列，在5.6.15之前只管是否超过512字节）；</li><li>在 <code>SELECT</code> 、<code>UNION</code> 、<code>UNION ALL</code> 查询中，SELECT子句存在最大长度超过512的列（对于字符串类型是512个字符，对于二进制类型则是512字节）；</li><li>执行 <code>SHOW COLUMNS</code> / <code>FIELDS</code> 、<code>DESCRIBE</code> 等SQL命令，因为它们的执行结果用到了BLOB列类型。</li></ol><p>从5.7.5开始，新增一个系统选项 <a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine">internal_tmp_disk_storage_engine</a> 可定义磁盘临时表的引擎类型为 InnoDB，而在这以前，只能使用MyISAM。而在5.6.3以后新增的系统选项 <a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_default_tmp_storage_engine">default_tmp_storage_engine</a> 是控制 <code>CREATE TEMPORARY TABLE</code> 创建的临时表的引擎类型，在以前默认是MEMORY，不要把这二者混淆了。</p><p>见下例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;InnoDB&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:22 #sql4b0e_10_0.frm -- InnoDB引擎的临时表</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql 98304 Jul  7 15:22 #sql4b0e_10_0.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:25 #sql4b0e_10_2.frm</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;MyISAM&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql     0 Jul  7 15:25 #sql4b0e_10_2.MYD -- MyISAM引擎的临时表</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  1024 Jul  7 15:25 #sql4b0e_10_2.MYI</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> default_tmp_storage_engine <span class="operator">=</span> &quot;MEMORY&quot;;</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----   1 mysql mysql  8558 Jul  7 15:26 #sql4b0e_10_3.frm -- MEMORY引擎的临时表</span></span><br></pre></td></tr></table></figure><p>用户自定义的临时表，比如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> temporary <span class="keyword">table</span> (id <span class="type">int</span>, str1 <span class="type">varchar</span>(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p>SQL执行过程中产生的内部临时表，比如：<code>UNION</code>  , 聚合类 <code>ORDER BY</code> ，派生表，大对象字段的查询，子查询或者半连接的固化等场景。</p><h2 id="五-临时表优化"><a href="#五-临时表优化" class="headerlink" title="五. 临时表优化"></a>五. 临时表优化</h2><p><strong>表的设计原则：</strong>使用临时表一般都意味着性能比较低，特别是使用磁盘临时表，性能更慢，因此我们在实际应用中应该尽量避免临时表的使用。 常见的避免临时表的方法有：</p><ol><li>创建索引：在ORDER BY或者GROUP BY的列上创建索引；</li><li>分拆很长的列：一般情况下，TEXT、BLOB，大于512字节的字符串，基本上都是为了显示信息，而不会用于查询条件， 因此表设计的时候，应该将这些列独立到另外一张表。</li></ol><p><strong>SQL优化：</strong>如果表的设计已经确定，修改比较困难，那么也可以通过优化SQL语句来减少临时表的大小，以提升SQL执行效率。</p><p><strong>常见的优化SQL语句方法如下：</strong></p><ol><li>拆分SQL语句：临时表主要是用于排序和分组，很多业务都是要求排序后再取出详细的分页数据，这种情况下可以将排序和取出详细数据拆分成不同的SQL，以降低排序或分组时临时表的大小，提升排序和分组的效率，我们的案例就是采用这种方法。</li><li>优化业务，去掉排序分组等操作：有时候业务其实并不需要排序或分组，仅仅是为了好看或者阅读方便而进行了排序，例如数据导出、数据查询等操作，这种情况下去掉排序和分组对业务也没有多大影响。</li></ol><p>如何判断使用了临时表？使用 <code>explain</code> 查看执行计划，Extra列看到 <code>Using temporary</code> 就意味着使用了临时表。</p><p>案例：</p><ol><li><p>【问题描述】：定位到一个慢查询，查询时服务器IO飙升，IO占用率达到100%， 执行时间长达7s左右。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.<span class="operator">*</span>, cp.name <span class="keyword">AS</span> cp_name, c.name <span class="keyword">AS</span> category_name, t.name <span class="keyword">AS</span> type_name </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp </span><br><span class="line"><span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c </span><br><span class="line"><span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t </span><br><span class="line"><span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure></li><li><p>【问题分析】：使用explain查看执行计划，结果：<code>Using temporary</code> 和 <code>Using filesort</code> 。这条sql语句的问题其实还是比较明显的：查询了大量数据(包括数据条数、以及g.* )，然后使用临时表order by，但最终又只返回了20条数据。观察到的IO高，是因为sql语句生成了一个巨大的临时表，内存放不下，于是全部拷贝到磁盘，导致IO飙升。</p></li><li><p>【优化方案】：优化的总体思路是拆分sql，将排序操作和查询所有信息的操作分开。</p><ol><li><p>第一条语句：查询符合条件的数据，只需要查询g.id即可：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.id </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp <span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c <span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t <span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> LIMIT <span class="number">20</span> ;</span><br></pre></td></tr></table></figure></li><li><p>第二条语句：查询符合条件的详细数据，将第一条sql的结果使用in操作拼接到第二条的sql：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> g.<span class="operator">*</span>, cp.name <span class="keyword">AS</span> cp_name,c.name <span class="keyword">AS</span> category_name,t.name <span class="keyword">AS</span> type_name </span><br><span class="line"><span class="keyword">FROM</span> gm_game g </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_cp cp <span class="keyword">ON</span> cp.id <span class="operator">=</span> g.cp_id <span class="keyword">AND</span> cp.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_category c <span class="keyword">ON</span> c.id <span class="operator">=</span> g.category_id <span class="keyword">AND</span> c.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> gm_type t <span class="keyword">ON</span> t.id <span class="operator">=</span> g.type_id <span class="keyword">AND</span> t.deleted <span class="operator">=</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">WHERE</span> g.deleted <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> g.id <span class="keyword">in</span>(…………………) </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> g.modify_time <span class="keyword">DESC</span> ;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>【实测效果】：在SATA机器上测试，优化前大约需要50s，优化后第一条0.3s，第二条0.1s，优化后执行速度是原来的100倍以上，IO从100%降到不到1%；在SSD机器上测试，优化前大约需要7s，优化后第一条0.3s，第二条0.1s，优化后执行速度是原来的10倍以上，IO从100%降到不到1%。可以看出，优化前磁盘io是性能瓶颈，SSD的速度要比SATA明显要快，优化后磁盘不再是瓶颈，SSD和SATA性能没有差别。</p></li><li><p>【理论分析】：MySQL在执行SQL查询时可能会用到临时表，一般情况下，用到临时表就意味着性能较低。</p></li></ol><h2 id="六-扩展"><a href="#六-扩展" class="headerlink" title="六. 扩展"></a>六. 扩展</h2><h3 id="6-1-INFORMATION-SCHEMA-FILES-介绍"><a href="#6-1-INFORMATION-SCHEMA-FILES-介绍" class="headerlink" title="6.1 INFORMATION_SCHEMA.FILES 介绍"></a>6.1 INFORMATION_SCHEMA.FILES 介绍</h3><p>表结构:</p><ul><li><p><code>FILE_ID</code> ：</p><ul><li>For <code>InnoDB</code> ：表空间ID，也被称为 <code>space_id</code> 或 <code>fil_space_t::id</code> 。</li><li>For <code>NDB</code> ：一个文件标识符。<code>FILE_ID</code> 列的值是自动生成的。</li></ul></li><li><p><code>FILE_NAME</code> ：</p><ul><li>For <code>InnoDB</code> ：数据文件的名称。<ul><li>表空间包含单个InnoDB表的数据和索引（File-per-table）和一般表空间的文件名扩展名为 <code>.ibd</code> 。</li><li>Undo 表空间的前缀是 <code>undo</code> 。 </li><li>系统表空间的前缀是 <code>ibdata</code> 。 </li><li>临时表空间的前缀是 <code>ibtmp</code> 。 </li><li>文件名包括文件路径，可以是相对于MySQL数据目录 （the value of the <code>datadir</code> system variable）。</li></ul></li><li>For <code>NDB</code> ：由 <code>CREATE LOGFILE GROUP</code> 或 <code>ALTER LOGFILE GROUP</code> 创建的 <code>UNDO</code> 日志文件名； 或由 <code>CREATE TABLESPACE</code> 或 <code>ALTER TABLESPACE</code> 创建的数据文件名。</li></ul></li><li><p><code>FILE_TYPE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：表空间文件的类型。<code>InnoDB</code> 文件有三种可能的文件类型：</p><ul><li><p><code>TABLESPACE</code> 是任何系统的、一般的、或 <code>file-per-table</code> 文件的表空间文件的文件类型，它持有表、索引、或其他形式的用户数据。</p></li><li><p><code>TEMPORARY</code> 是临时表空间的文件类型。</p></li><li><p><code>UNDO LOG</code> 是UNDO表空间的文件类型，用于保存撤销记录。</p></li></ul></li><li><p>For <code>NDB</code> ： <code>UNDO LOG</code> 、<code>DATAFILE</code> 或 <code>TABLESPACE</code> 中的一个。</p></li></ul></li><li><p><code>TABLESPACE_NAME</code> ：与该文件相关的表空间的名称。</p></li><li><p><code>TABLE_CATALOG</code> ：这个值总是空的。</p></li><li><p><code>TABLE_SCHEMA</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>TABLE_NAME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LOGFILE_GROUP_NAME</code> ：</p><ul><li>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</li><li>For <code>NDB</code> ：日志文件或数据文件所属的日志文件组的名称。</li></ul></li><li><p><code>LOGFILE_GROUP_NUMBER</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：对于磁盘数据UNDO日志文件，自动生成的日志文件组的ID号码，该日志文件属于该组。这与 <code>ndbinfo.dict_obj_info</code>表中的 <code>id</code> 列以及 <code>ndbinfo.logspaces</code> 和 <code>ndbinfo.logspaces</code> 表中的 <code>log_id</code> 列所显示的该UNDO日志文件的值相同。</p></li></ul></li><li><p><code>ENGINE</code> ：</p><ul><li>For <code>InnoDB</code> ：这个值总是 <code>InnoDB</code> 。</li><li>For <code>NDB</code> ：这个值总是 <code>ndbcluster</code> 。</li></ul></li><li><p><code>FULLTEXT_KEYS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DELETED_ROWS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>UPDATE_COUNT</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>FREE_EXTENTS</code> ：</p><ul><li>For <code>InnoDB</code> ：当前数据文件中完全空闲的扩展数。</li><li>For <code>NDB</code> ：文件尚未使用的extents的数量。</li></ul></li><li><p><code>TOTAL_EXTENTS</code> ：</p><ul><li>For <code>InnoDB</code> ：在当前数据文件中使用的完整扩展的数量。文件末尾的任何部分范围都不计算在内。</li><li>For <code>NDB</code> ：分配给文件的总扩展数。</li></ul></li><li><p><code>EXTENT_SIZE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：</p><ul><li>对于页面大小为4KB、8KB或16KB的文件，其Extent大小为1048576（1MB）。</li><li>对于页面大小为32KB的文件，Extent大小为2097152字节（2MB）。</li><li>对于页面大小为64KB的文件，Extent大小为4194304字节（4MB）。</li></ul><p><code>FILES</code> 不包括 <code>InnoDB</code> 的页面大小。页面大小是由 <code>innodb_page_size</code> 系统变量统计。也可以从 <code>INNODB_SYS_TABLESPACES</code> 表中检索Extent的大小信息，其中 <code>FILES.FILE_ID = INNODB_SYS_TABLESPACES.SPACE</code> 。</p></li><li><p>For <code>NDB</code> ：文件的范围大小，以字节为单位。</p></li></ul></li><li><p><code>INITIAL_SIZE</code> ：</p><ul><li>For <code>InnoDB</code> ：文件的初始大小，以字节为单位。</li><li>For <code>NDB</code> ：文件的大小，单位是字节。用于创建文件的 <code>CREATE LOGFILE GROUP</code> 、<code>ALTER LOGFILE GROUP</code> 、<code>CREATE TABLESPACE</code> 或 <code>ALTER TABLESPACE</code> 语句的 <code>INITIAL_SIZE</code> 子句中使用的值相同。</li></ul></li><li><p><code>MAXIMUM_SIZE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：文件中允许的最大字节数。除了预定义的系统表空间数据文件，所有数据文件的值都是<code>NULL</code> 。</p><ul><li>最大的系统表空间文件大小是由 <code>innodb_data_file_path</code> 定义的。</li><li>最大的临时表空间文件大小是由 <code>innodb_temp_data_file_path</code> 定义的。</li><li>一个预定义的系统表空间数据文件的 <code>NULL</code> 值表示没有明确定义文件的大小限制。</li></ul></li><li><p>For <code>NDB</code> ：这个值总是与 <code>INITIAL_SIZE</code> 值相同。</p></li></ul></li><li><p><code>AUTOEXTEND_SIZE</code> ：表空间的自动扩展大小。对于<code>NDB</code>，<code>AUTOEXTEND_SIZE</code> 总是 <code>NULL</code> 。</p></li><li><p><code>CREATION_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LAST_UPDATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>LAST_ACCESS_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>RECOVER_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>TRANSACTION_COUNTER</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>VERSION</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：文件的版本号。</p></li></ul></li><li><p><code>ROW_FORMAT</code></p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code> ：<code>FIXED</code> 或 <code>DYNAMIC</code> 其中一个。</p></li></ul></li><li><p><code>TABLE_ROWS</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>AVG_ROW_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DATA_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>MAX_DATA_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>INDEX_LENGTH</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>DATA_FREE</code> ：</p><ul><li><p>For <code>InnoDB</code> ：整个表空间的空闲空间总量（以字节为单位）。预定义的系统表空间，包括系统表空间和临时表空间，可以有一个或多个数据文件。</p></li><li><p>For <code>NDB</code> ：这个值总是 <code>NULL</code> 。</p></li></ul></li><li><p><code>CREATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>UPDATE_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>CHECK_TIME</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>CHECKSUM</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p><code>STATUS</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值默认为 <code>NORMAL</code> 。<code>InnoDB</code> 的 <code>file-per-table</code> 表空间可能为 <code>IMPORTING</code> ，这表明表空间尚未可用。</p></li><li><p>For <code>NDB</code> ：这个值总是 <code>NORMAL</code> 。</p></li></ul></li><li><p><code>EXTRA</code> ：</p><ul><li><p>For <code>InnoDB</code> ：这个值总是 <code>NULL</code> 。</p></li><li><p>For <code>NDB</code>：这一列显示了数据文件或 undo 日志文件属于哪个数据节点（每个数据节点都有每个文件的副本）； 对于 undo 日志文件，它还显示了撤销日志缓冲区的大小。假设你在一个有四个数据节点的NDB集群上使用这个语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> LOGFILE <span class="keyword">GROUP</span> mygroup</span><br><span class="line">    <span class="keyword">ADD</span> UNDOFILE <span class="string">&#x27;new_undo.dat&#x27;</span></span><br><span class="line">    INITIAL_SIZE <span class="number">2</span>G</span><br><span class="line">    ENGINE NDB;</span><br></pre></td></tr></table></figure><p>在成功运行 <code>CREATE LOGFILE GROUP</code> 语句后，你应该看到一个类似于，这里显示为针对 <code>FILES</code> 表的查询结果：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> LOGFILE_GROUP_NAME, FILE_TYPE, EXTRA</span><br><span class="line">         <span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES</span><br><span class="line">         <span class="keyword">WHERE</span> FILE_NAME <span class="operator">=</span> <span class="string">&#x27;new_undo.dat&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> LOGFILE_GROUP_NAME <span class="operator">|</span> FILE_TYPE <span class="operator">|</span> EXTRA                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">5</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">6</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">7</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mygroup            <span class="operator">|</span> UNDO LOG  <span class="operator">|</span> CLUSTER_NODE<span class="operator">=</span><span class="number">8</span>;UNDO_BUFFER_SIZE<span class="operator">=</span><span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-----------+-----------------------------------------+</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><code>FILES</code> 是一个非标准的 <code>INFORMATION_SCHEMA</code> 表。</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>适用于 <code>InnoDB</code> 数据文件的注意事项：</p><ul><li><p><code>FILES</code> 报告的数据来自于 <code>InnoDB</code> 的内存缓存中的开放文件。相比之下， <code>INNODB_SYS_DATAFILES</code> 报告的数据来自 <code>InnoDB</code> <code>SYS_DATAFILES</code> 内部数据字典表。</p></li><li><p><code>FILES</code>报告的数据包括临时表空间数据。这些数据在 <code>InnoDB</code> 的 <code>SYS_DATAFILES</code> 内部数据字典表中是不可用的，因此  <code>INNODB_SYS_DATAFILES</code> 不会报告。</p></li><li><p>Undo 的表空间数据由 <code>FILES</code> 报告。</p></li><li><p>下面的查询返回所有与 <code>InnoDB</code> 表空间有关的数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  FILE_ID, FILE_NAME, FILE_TYPE, TABLESPACE_NAME, FREE_EXTENTS,</span><br><span class="line">  TOTAL_EXTENTS, EXTENT_SIZE, INITIAL_SIZE, MAXIMUM_SIZE,</span><br><span class="line">  AUTOEXTEND_SIZE, DATA_FREE, STATUS</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.FILES <span class="keyword">WHERE</span> ENGINE<span class="operator">=</span><span class="string">&#x27;InnoDB&#x27;</span>\G</span><br></pre></td></tr></table></figure></li></ul><hr><p>参考：</p><p>🔗 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-temporary-tablespace.html">MySQL :: MySQL 5.7 Reference Manual :: 14.6.3.5 The Temporary Tablespace</a></p><p>🔗 <a href="https://dev.mysql.com/doc/refman/5.7/en/information-schema-files-table.html">MySQL :: MySQL 5.7 Reference Manual :: 24.3.9 The INFORMATION_SCHEMA FILES Table</a></p><p>🔗 <a href="https://programmer.help/blogs/from-mysql-s-ibtmp1-file-is-too-big.html">From MYSQL’s ibtmp1 file is too big (programmer.help)</a></p><p>🔗 <a href="https://blog.csdn.net/yunhua_lee/article/details/12064477">优化临时表使用</a></p>]]></content>
    
    
    <summary type="html">内容包括：临时表简介，查看数据库临时表信息，临时表空间大小，创建临时表的场景，临时表优化，扩展等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="mysql" scheme="http://linyishui.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Bean验证——Hibernate Validator</title>
    <link href="http://linyishui.top/2021072201.html"/>
    <id>http://linyishui.top/2021072201.html</id>
    <published>2021-07-22T08:11:09.000Z</published>
    <updated>2021-07-28T10:42:48.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Hibernate-Validator"><a href="#Hibernate-Validator" class="headerlink" title="Hibernate Validator"></a>Hibernate Validator</h1><h2 id="一-Bean验证"><a href="#一-Bean验证" class="headerlink" title="一. Bean验证"></a>一. Bean验证</h2><h3 id="1-1-什么是Bean验证"><a href="#1-1-什么是Bean验证" class="headerlink" title="1.1 什么是Bean验证"></a>1.1 什么是Bean验证</h3><p>常见的业务校验场景：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (employee.getFirstName() == <span class="keyword">null</span> || employee.getFirstName().trim().length() == <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">&quot;validate.employee.firstName&quot;</span>);</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>当业务规则复杂时，类似的条件判断需要很多才能实现。</p><p>Bean验证是一个Java EE的API，用来自动验证在Java bean上声明的业务逻辑。其包含一个元数据模型（一个注解的集合），其中为指定的类声明了业务规则和一个使用验证工具的API。</p><p>通过为字段、方法等添加注解的方式，指定如何在被标注的目标上使用特定的约束。</p><h3 id="1-2-为什么选用Hibernate-Validator"><a href="#1-2-为什么选用Hibernate-Validator" class="headerlink" title="1.2 为什么选用Hibernate Validator"></a>1.2 为什么选用Hibernate Validator</h3><p>Hibernate Validator 5.0 是 JSR 349的参考实现，它兼容于此规范，是Bean验证实现中应用最广泛的。</p><p>Spring Framework自动为使用 Java Bean 验证的、由Spring管理的bean创建代理。它将拦截对添加了注解的方法的调用并进行适当的验证，检查使用者是否提供了有效的参数或该实现的返回值是否有效（常用注解 <code>@javax.validation.Valid</code> ）。</p><h2 id="二-在Spring-Framework容器中配置验证"><a href="#二-在Spring-Framework容器中配置验证" class="headerlink" title="二. 在Spring Framework容器中配置验证"></a>二. 在Spring Framework容器中配置验证</h2><p>手动验证：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ValidatorFactory factory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">Validator validator = factory.getValidator();</span><br><span class="line">Set&lt;ConstraintViolation&lt;Employee&gt; violations = validator.validate(employee);</span><br><span class="line"><span class="keyword">if</span> (violations.size() &gt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(violations);</span><br></pre></td></tr></table></figure><p>配置Spring Framework开启自动验证，使用依赖注入和代理支持，完成4个配置：</p><ul><li>验证器</li><li>验证器消息的本地化</li><li>方法验证处理器</li><li>Spring MVC表单验证</li></ul><p>Spring Framework在Bean Validation出现之前就提供了 <code>org.springframework.validation.Validator</code> 接口支持对象自动验证，通过注解约束指定验证对象的工具。</p><p>验证错误会使用 <code>org.springframework.validation.Errors</code> 接口，而不是返回一个 <code>Set&lt;javax.validation.ObjectError&gt;</code> 。该接口提供了对一个或多个 <code>ObjectError</code> 和 <code>FieldError</code> 的访问。</p><p>配置Spring Framework的验证时，需要同时实现Validator和Spring Validator，即继承了 <code>org.springframework.validation.beanvalidation.SpringValidatorAdapter</code> 的类，可选：</p><ul><li><code>javax.validation.beanvalidation.CustomValidatorBean</code> </li><li><code>javax.validation.beanvalidation.LocalValidatorFactoryBean</code> ：支持获取底层的Validator，且支持使用应用程序的其他代码用于国际化的相同MessageSource和资源包文件。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LocalValidatorFactoryBean将自动检测到类路径上的Bean Validation实现，使用ValidatorFactory作为支持工厂，如果有多个实现类则会随机挑选。</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 最简单的返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    <span class="comment">// 动态加载的写法</span></span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setProvider(Class.forName(<span class="string">&quot;org.hibernate.validator.HibernateValidator&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过LocalValidatorFactoryBean设置有效的MessageSource，自动提供一个由MessageSource作为支持的插值器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定错误代码和错误消息</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageSource <span class="title">messageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReloadableResourceBundleMessageSource messageSource = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">    messageSource.setCacheSeconds(-<span class="number">1</span>);</span><br><span class="line">    messageSource.setDefaultEncoding(StandardCharsets.UTF_8.name());</span><br><span class="line">    messageSource.setBasenames(<span class="string">&quot;/WEB-INF/il8n/titles&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/messages&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/errors&quot;</span>, <span class="string">&quot;/WEB-INF/il8n/validation&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> messageSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalValidatorFactoryBean validator = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">    validator.setValidationMessageSource(<span class="keyword">this</span>.messageSource());</span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用方法验证Bean后处理器，可以在容器完成启动过程之前配置、自定义和替换配置中的bean。</p><h2 id="三-为bean添加约束验证注解"><a href="#三-为bean添加约束验证注解" class="headerlink" title="三. 为bean添加约束验证注解"></a>三. 为bean添加约束验证注解</h2><h2 id="四-为方法验证配置Spring-bean"><a href="#四-为方法验证配置Spring-bean" class="headerlink" title="四. 为方法验证配置Spring bean"></a>四. 为方法验证配置Spring bean</h2><h2 id="五-编写自定义验证约束"><a href="#五-编写自定义验证约束" class="headerlink" title="五. 编写自定义验证约束"></a>五. 编写自定义验证约束</h2><h2 id="六-在客户支持应用程序中集成验证"><a href="#六-在客户支持应用程序中集成验证" class="headerlink" title="六. 在客户支持应用程序中集成验证"></a>六. 在客户支持应用程序中集成验证</h2><h2 id="七-使用"><a href="#七-使用" class="headerlink" title="七. 使用"></a>七. 使用</h2><h3 id="7-1-使用Hibernate-Validate"><a href="#7-1-使用Hibernate-Validate" class="headerlink" title="7.1 使用Hibernate Validate"></a>7.1 使用Hibernate Validate</h3><p><strong>引入依赖</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>常用注解说明</strong>：</p><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Length(min=,max=)</td><td>检查所属的字段的长度是否在min和max之间，只能用于字符串</td></tr><tr><td>@Range(min=,max=,message=)</td><td>被注释的元素必须在合适的范围内</td></tr><tr><td>@Max</td><td>该字段的值只能小于或等于该值</td></tr><tr><td>@Min</td><td>该字段的值只能大于或等于该值</td></tr><tr><td>@NotNull</td><td>不能为null</td></tr><tr><td>@NotBlank</td><td>不能为空，检查时会将空格忽略</td></tr><tr><td>@NotEmpty</td><td>不能为空，这里的空是指空字符串</td></tr><tr><td>@Pattern(regex=,flag=)</td><td>被注释的元素必须符合指定的正则表达式</td></tr></tbody></table><p><strong>使用</strong>：</p><p>需要搭配在Controller中搭配@Validated或@Valid注解一起使用，@Validated和@Valid注解区别不是很大，一般情况下任选一个即可，区别如下：</p><table><thead><tr><th>注解</th><th>@Validated</th><th>@Valid</th></tr></thead><tbody><tr><td>所属的包</td><td>属于org.springframework.validation.annotation包下的,是spring提供的</td><td>属于javax.validation包下,是jdk给提供的</td></tr><tr><td>是否支持分组和排序</td><td>是</td><td>否</td></tr></tbody></table><p>虽然@Validated比@Valid更加强大，在@Valid之上提供了分组功能和验证排序功能。Hibernate-validate框架中的注解是需要加在实体中一起使用的：</p><ul><li>定义一个实体：message字段为不符合校验规则时抛出的异常信息</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSetSaveVO</span> </span>&#123;</span><br><span class="line">    <span class="comment">//唯一标识符为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;user uuid is empty&quot;)</span></span><br><span class="line">    <span class="comment">//用户名称只能是字母和数字</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[a-z0-9]+$&quot;, message = &quot;user names can only be alphabetic and numeric&quot;)</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;user uuid length over 48 byte&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userUuid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据集名称只能是字母和数字</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[A-Za-z0-9]+$&quot;, message = &quot;data set names can only be letters and Numbers&quot;)</span></span><br><span class="line">    <span class="comment">//文件名称过长</span></span><br><span class="line">    <span class="meta">@Length(max = 48, message = &quot;file name too long&quot;)</span></span><br><span class="line">    <span class="comment">//文件名称为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;file name is empty&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据集描述最多为256字节</span></span><br><span class="line">    <span class="meta">@Length(max = 256, message = &quot;data set description length over 256 byte&quot;)</span></span><br><span class="line">    <span class="comment">//数据集描述为空</span></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;data set description is null&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Controller层中的方法：在校验的实体DataSetSaveVO旁边添加@Valid或@Validated注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseVO <span class="title">createDataSet</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> DataSetSaveVO dataSetVO)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.success(dataSetService.saveDataSet(dataSetVO));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-使用commons-lang3"><a href="#7-2-使用commons-lang3" class="headerlink" title="7.2 使用commons-lang3"></a>7.2 使用commons-lang3</h3><p><strong>引入依赖</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>常用方法说明</strong>：</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>CollectionUtils.isEmpty</td><td>判断集合是否为空，为null或者size==0，返回true</td></tr><tr><td>CollectionUtils.isNotEmpty</td><td>判断集合是否为非空</td></tr><tr><td>StringUtils.isEmpty</td><td>判断字符串是否为空</td></tr><tr><td>StringUtils.isNotEmpty</td><td>判断字符串是否非空</td></tr><tr><td>StringUtils.isBlank</td><td>判断字符串是否为空，为null或者size==0或者只存在空白字符(如” “)，则返回true</td></tr><tr><td>StringUtils.isNotBlank</td><td>判断字符串是否为非空</td></tr></tbody></table><p>测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//StringUtils.isEmpty</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isEmpty(<span class="string">&quot;  &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"><span class="comment">//StringUtils.isNotEmpty</span></span><br><span class="line">System.out.println(StringUtils.isNotEmpty(<span class="string">&quot;&quot;</span>));  <span class="comment">//false</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">//StringUtils.isBlank</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot;&quot;</span>));  <span class="comment">//true</span></span><br><span class="line">System.out.println(StringUtils.isBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//true</span></span><br><span class="line"><span class="comment">//StringUtils.isNotBlank</span></span><br><span class="line">System.out.println(StringUtils.isNotBlank(<span class="string">&quot; &quot;</span>));  <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; emptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Integer&gt; nullList = <span class="keyword">null</span>;</span><br><span class="line">List&lt;Integer&gt; notEmptyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">notEmptyList.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(emptyList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(nullList));   <span class="comment">//true</span></span><br><span class="line">System.out.println(CollectionUtils.isEmpty(notEmptyList));   <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//CollectionUtils.isNotEmpty</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(emptyList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(nullList));   <span class="comment">//false</span></span><br><span class="line">System.out.println(CollectionUtils.isNotEmpty(notEmptyList));   <span class="comment">//true</span></span><br></pre></td></tr></table></figure><h3 id="7-3-自定义注解"><a href="#7-3-自定义注解" class="headerlink" title="7.3 自定义注解"></a>7.3 自定义注解</h3><p>当上面的方面都无法满足校验的需求以后，可以考虑使用自定义注解</p><hr><p>参考：</p><p>🔗《Java Web高级编程—涵盖WebSockets、Spring Framework、JPA Hibernate、Spring Security》</p><p>🔗 <a href="https://juejin.cn/post/6913735652806754311">Springboot中如何优雅进行字段校验 </a></p>]]></content>
    
    
    <summary type="html">内容来自于《Java Web高级编程—涵盖WebSockets、Spring Framework、JPA Hibernate、Spring Security》。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="Spring" scheme="http://linyishui.top/tags/Spring/"/>
    
    <category term="Hibernate" scheme="http://linyishui.top/tags/Hibernate/"/>
    
    <category term="Spring Framework" scheme="http://linyishui.top/tags/Spring-Framework/"/>
    
  </entry>
  
  <entry>
    <title>Hexo搭建个人博客 (四) 升级与功能配置（持续更新）</title>
    <link href="http://linyishui.top/2021070101.html"/>
    <id>http://linyishui.top/2021070101.html</id>
    <published>2021-07-01T02:19:15.000Z</published>
    <updated>2021-07-10T09:59:14.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" id=6851165123 server="netease" type="playlist" ></meting-js><h1 id="升级与功能配置"><a href="#升级与功能配置" class="headerlink" title="升级与功能配置"></a>升级与功能配置</h1><h2 id="一-Hexo升级"><a href="#一-Hexo升级" class="headerlink" title="一. Hexo升级"></a>一. Hexo升级</h2><p>从2018年后一直未更新Hexo和Next主题版本，中间跨了好几个大版本，所以尝试直接升级至最新版本。</p><p>当前最新Next主题：<a href="https://github.com/next-theme/hexo-theme-next">hexo-theme-next</a></p><h3 id="1-1-Hexo升级"><a href="#1-1-Hexo升级" class="headerlink" title="1.1 Hexo升级"></a>1.1 Hexo升级</h3><p>执行 <code>npm outdated</code> 查看所有可以升级的插件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-check     //安装npm-check</span><br><span class="line">npm-check                    //查看系统插件是否需要升级</span><br><span class="line">npm install -g npm-upgrade   //安装npm-upgrade</span><br><span class="line">npm-upgrade        //更新package.json</span><br><span class="line">//在执行npm-upgrade命令后会要求输入yes或者no，直接输入Yes或Y即可</span><br><span class="line">npm update -g      //更新全局插件</span><br><span class="line">npm update --save  //更新系统插件</span><br></pre></td></tr></table></figure><h3 id="1-2-主题更新"><a href="#1-2-主题更新" class="headerlink" title="1.2 主题更新"></a>1.2 主题更新</h3><p>在<strong>主题的根目录</strong>（注意不是博客根目录），打开命令行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git pull</span></span><br></pre></td></tr></table></figure><p>Next主题从5.X版本升级，因为差异较大，需要参考官方文档：<a href="https://github.com/theme-next/hexo-theme-next/blob/master/docs/zh-CN/UPDATE-FROM-5.1.X.md">从 NexT v5.1.x 更新</a>。</p><h3 id="1-3-npm更新"><a href="#1-3-npm更新" class="headerlink" title="1.3 npm更新"></a>1.3 npm更新</h3><p>npm更新全局安装的包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm update -g</span><br></pre></td></tr></table></figure><p>npm 更新站点文件夹根目录下安装的依赖包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm update</span></span><br></pre></td></tr></table></figure><p>更新 npm：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install npm -g</span><br></pre></td></tr></table></figure><p>更新 Node.js 到最新版（Linux）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前node版本</span></span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br><span class="line"></span><br><span class="line">npm install -g n</span><br><span class="line"></span><br><span class="line">n latest</span><br></pre></td></tr></table></figure><p>更新 Node.js 到最新版Win10：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看原nodejs安装目录</span></span><br><span class="line">where node </span><br><span class="line">npm config list | findstr location</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载最新nodejs安装包放在原安装目录下</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 官网: https://nodejs.org/en/download/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 淘宝镜像: https://npm.taobao.org/mirrors/node/v14.15.2/</span></span><br></pre></td></tr></table></figure><h3 id="1-4-问题记录"><a href="#1-4-问题记录" class="headerlink" title="1.4 问题记录"></a>1.4 问题记录</h3><p>问题 <code>  err: Error: Cannot find module &#39;hexo-util&#39;</code> 缺少 <a href="https://www.npmjs.com/package/hexo-util">hexo-util</a> ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装hexo-util</span></span><br><span class="line">npm install hexo-util --save</span><br></pre></td></tr></table></figure><p>执行 <code>hexo generator</code> 命令后，<code>themes/next/scripts/events/lib/vendors.js</code> 代码里面解析 <code>local</code> 的 <code>call</code> 一直出现以下错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INFO  Start processing</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: TypeError: Cannot read property &#x27;call&#x27; of undefined</span><br><span class="line">      at module.exports (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/lib/vendors.js:27:25)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/themes/next/scripts/events/index.js:9:27)</span><br><span class="line">      at Hexo.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Hexo.&lt;anonymous&gt; (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/method.js:15:34)</span><br><span class="line">      at /home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/hexo/lib/extend/filter.js:67:52</span><br><span class="line">      at tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Object.gotValue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:166:18)</span><br><span class="line">      at Object.gotAccum (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/reduce.js:155:25)</span><br><span class="line">      at Object.tryCatcher (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at Promise._settlePromiseFromHandler (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:547:31)</span><br><span class="line">      at Promise._settlePromise (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:604:18)</span><br><span class="line">      at Promise._settlePromiseCtx (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/promise.js:641:10)</span><br><span class="line">      at _drainQueueStep (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:97:12)</span><br><span class="line">      at _drainQueue (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:86:9)</span><br><span class="line">      at Async._drainQueues (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:102:5)</span><br><span class="line">      at Immediate.Async.drainQueues [as _onImmediate] (/home/rqh656418510/HDDD/Workspaces_MarkDown/hexo-develop/node_modules/bluebird/js/release/async.js:15:14)</span><br><span class="line">      at processImmediate (internal/timers.js:461:21)</span><br></pre></td></tr></table></figure><p>这个报错是没找到 <code>hexo-util</code> 的 <code>url_for</code> ，可能是 <code>hexo-util</code> 模块更新失败，最终导致代码不兼容。首先检查 <code>hexo-util</code> 模块的版本，然后可以尝试执行以下命令，强制更新 NPM 模块：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入博客的主题目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /boot-root/</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 强制更新</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm update --save --force</span></span><br></pre></td></tr></table></figure><h2 id="二-功能配置-整体"><a href="#二-功能配置-整体" class="headerlink" title="二. 功能配置-整体"></a>二. 功能配置-整体</h2><p>有些旧版的设置，新版因为觉得没必要、或未找到修改方案在菜单中标记了（旧版本）。</p><h3 id="2-1-修改主题风格"><a href="#2-1-修改主题风格" class="headerlink" title="2.1 修改主题风格"></a>2.1 修改主题风格</h3><p>nexT默认 <code>Scheme: Muse</code> ，修改主题配置文件 <code>\themes\next\_config.yml</code> 中的scheme：</p><ul><li><p>Muse - 默认 Scheme，这是 NexT 最初的版本，黑白主调，大量留白</p></li><li><p>Mist - Muse 的紧凑版本，整洁有序的单栏外观</p></li><li><p>Pisces - 双栏 Scheme，小家碧玉似的清新</p></li><li><p>Gemini - 不太清楚，有想法可以试用一下</p></li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280204.png"></p><h3 id="2-2-添加头像"><a href="#2-2-添加头像" class="headerlink" title="2.2 添加头像"></a>2.2 添加头像</h3><p>新建 <code>source/images/</code> 目录，复制进去一些图片（可以是动图Gif），在站点配置文件 <code>\_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 头像</span></span><br><span class="line"><span class="attr">avatar:</span> <span class="string">/images/riho_yoshioka1.jpg</span></span><br></pre></td></tr></table></figure><p>主题配置文件 <code>\themes\next\_config.yml</code> 若设置了，会优先于前者：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">XXX</span></span><br></pre></td></tr></table></figure><p>也可以采用第二种方法：</p><ol><li><p>首先在网上找或者自己PS一张心仪的图片，取名 <code>background.jpg</code> ，把它放在 <code>Hexo\source\image</code> 路径下（或者直接使用图床的图片地址）。</p></li><li><p>进入 <code>Hexo\themes\hexo-theme-next\source\css\_common\components\header</code> 目录，找到 <code>header.styl</code> 文件，双击打开。将第一行默认的 <code>.header &#123; background: $head-bg; &#125;</code> 修改为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的url()里不一定非要填相对路径，填一个能访问的url即可</span></span><br><span class="line">.header &#123; <span class="attr">background</span>: url(<span class="string">&#x27;../image/background.jpg&#x27;</span>); &#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="2-3-设置头像旋转"><a href="#2-3-设置头像旋转" class="headerlink" title="2.3 设置头像旋转"></a>2.3 设置头像旋转</h3><p>旧版，打开 <code>\themes\next\source\css\_common\components\sidebar\sidebar-author.styl</code> ，在里面添加如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.site-author-image</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding</span>: $site-author-image-padding;</span><br><span class="line">  <span class="attribute">max-width</span>: $site-author-image-width;</span><br><span class="line">  <span class="attribute">height</span>: $site-author-image-height;</span><br><span class="line">  <span class="attribute">border</span>: $site-author-image-border-width solid $site-author-image-border-color;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 头像圆形 */</span></span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  -moz-<span class="attribute">border-radius</span>: <span class="number">80px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: inset <span class="number">0</span> -<span class="number">1px</span> <span class="number">0</span> <span class="number">#333</span>sf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 设置循环动画 [animation: (play)动画名称 (2s)动画播放时长单位秒或微秒 (ase-out)动画播放的速度曲线为以低速结束 </span></span><br><span class="line"><span class="comment">    (1s)等待1秒然后开始动画 (1)动画播放次数(infinite为循环播放) ]*/</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 鼠标经过头像旋转360度 */</span></span><br><span class="line">  -webkit-<span class="attribute">transition</span>: -webkit-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  -moz-<span class="attribute">transition</span>: -moz-transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">  <span class="attribute">transition</span>: transform <span class="number">1.0s</span> ease-out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="comment">/* 鼠标经过停止头像旋转 </span></span><br><span class="line"><span class="comment">  -webkit-animation-play-state:paused;</span></span><br><span class="line"><span class="comment">  animation-play-state:paused;*/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 鼠标经过头像旋转360度 */</span></span><br><span class="line">  -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">360deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Z 轴旋转动画 */</span></span><br><span class="line"><span class="keyword">@-webkit-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -webkit-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@-moz-keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    -moz-<span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> play &#123;</span><br><span class="line">  <span class="number">0%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(<span class="number">0deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">100%</span> &#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">rotateZ</span>(-<span class="number">360deg</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版可以直接修改主题配置文件 <code>\themes\next\_config.yml</code> ，设置 rotated 属性：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Sidebar Avatar</span></span><br><span class="line"><span class="attr">avatar:</span></span><br><span class="line">  <span class="comment"># Replace the default image and set the url here.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be dispalyed in circle.</span></span><br><span class="line">  <span class="attr">rounded:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, the avatar will be rotated with the cursor.</span></span><br><span class="line">  <span class="attr">rotated:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-4-设置侧栏位置"><a href="#2-4-设置侧栏位置" class="headerlink" title="2.4 设置侧栏位置"></a>2.4 设置侧栏位置</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中的sidebar：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280206.png"></p><p>默认是左边，display设置侧栏在什么情况下显示。</p><h3 id="2-5-设置菜单"><a href="#2-5-设置菜单" class="headerlink" title="2.5 设置菜单"></a>2.5 设置菜单</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> 菜单映射：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280207.png"></p><p>界面所显示的映射value是去 <code>languages/&#123;yourlanguage&#125;.yml</code> 查询的，想要修改时只需去修改 <code>&#123;yourlanguage&#125;.yml</code> 即可，不过要先在主题配置文件中开启这个标签。</p><p>设置菜单的图标: </p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280208.png"></p><h4 id="（1）添加标签页面"><a href="#（1）添加标签页面" class="headerlink" title="（1）添加标签页面"></a>（1）添加标签页面</h4><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中的menu选项，可以在主页面的菜单栏添加标签选项，但是此时点击标签，跳转的页面会显示page not found。</p><p>添加标签页面的具体方法是:</p><ul><li><p>新建页面，输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page tags</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在 <code>myBlog/source</code> 下会新生成一个新的文件夹tags，在该文件夹下会有一个 <code>index.md</code> 文件。</p></li><li><p>设置页面类型，在上步新生成的 <code>myBlog/source/tags/index.md</code> 中添加 <code>type: &quot;tags&quot;</code> ，<code>index.md</code> 文件内容如下:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2016-11-15 19:10:05</span><br><span class="line"><span class="section">type: &quot;tags&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>设置具体文章的tags，当要为某一篇文章添加标签，只需在 <code>myBlog/source/_post</code> 目录下的具体文章的tags中添加标签即可，如:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 基于Hexo和Github搭建博客</span><br><span class="line">date: 2016-11-09</span><br><span class="line">tags: [npm, hexo, github]</span><br><span class="line"><span class="section">categories: 搭建博客</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（2）添加分类页面"><a href="#（2）添加分类页面" class="headerlink" title="（2）添加分类页面"></a>（2）添加分类页面</h4><p>步骤与添加标签页面类似，具体如下：</p><ul><li><p>新建页面，输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page categories</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在myBlog/source下会新生成一个新的文件夹categories，在该文件夹下会有一个index.md文件。</p></li><li><p>设置页面类型，在上步新生成的 <code>myBlog/source/categories/index.md</code> 中添加 <code>type: &quot;categories&quot;</code> ， <code>index.md</code> 文件内容如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2016-11-15 19:11:13</span><br><span class="line"><span class="section">type: &quot;categories&quot;</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li><li><p>设置具体文章的categories，当要为某一篇文章添加分类，只需在 <code>myBlog/source/_post</code> 目录下的具体文章的categories中添加分类即可，如：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 基于Hexo和Github搭建博客</span><br><span class="line">date: XXXX-XX-XX</span><br><span class="line">tags: [hexo, github]</span><br><span class="line"><span class="section">categories: 搭建博客</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="（3）添加关于我页面"><a href="#（3）添加关于我页面" class="headerlink" title="（3）添加关于我页面"></a>（3）添加关于我页面</h4><p>步骤与添加标签页面类似，具体如下:</p><ul><li><p>新建页面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> myBlog</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo new page about</span></span><br></pre></td></tr></table></figure></li><li><p>输入命令后，在 <code>myBlog/source</code> 下会新生成一个新的文件夹about，在该文件夹下会有一个 <code>index.md</code> 文件。修改 <code>about/index.md</code> ，本站点 <code>index.md</code> 如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: about</span><br><span class="line"><span class="section">date: 2016-11-15 19:08:50</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"><span class="section">## 关于我</span></span><br><span class="line"></span><br><span class="line">XXXX,XXXXXXXXX。</span><br><span class="line"></span><br><span class="line">From XXX</span><br><span class="line"></span><br><span class="line">QQ: XXXXXXX</span><br><span class="line">Email: XXXXXX@XX.com</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-6-设置社交链接"><a href="#2-6-设置社交链接" class="headerlink" title="2.6 设置社交链接"></a>2.6 设置社交链接</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280209.png"></p><p>可以在<a href="https://fontawesome.com/icons?from=io">图标库</a>中搜索图标 ：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280210.png"></p><p><strong>将链接设置为居中显示：</strong></p><p>打开文件 <code>themes\next\source\css\_common\components\sidebar\sidebar-author-links.styl</code> ，添加如下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-of-author-item</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-添加友链"><a href="#2-7-添加友链" class="headerlink" title="2.7 添加友链"></a>2.7 添加友链</h3><h4 id="（1）简单方案"><a href="#（1）简单方案" class="headerlink" title="（1）简单方案"></a>（1）简单方案</h4><p>在source目录下新建一个xx.html文件，然后配置menu映射即可。</p><blockquote><p>xx: /xx.html</p><p>xx: /xx</p></blockquote><p>添加如友情链接的方法:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blogrolls </span></span><br><span class="line"><span class="attr">links_title:</span> <span class="string">友情链接</span> </span><br><span class="line"><span class="comment"># links_layout: block </span></span><br><span class="line"><span class="comment">#links_layout: inline </span></span><br><span class="line"><span class="attr">links:</span> <span class="string">Java学习天地:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="attr">ruulai.com:</span> <span class="string">https://wangli0.github.com</span> </span><br><span class="line"><span class="string">视听中国:</span> <span class="string">https://wangli0.github.com</span></span><br></pre></td></tr></table></figure><h4 id="（2）Next侧边栏添加"><a href="#（2）Next侧边栏添加" class="headerlink" title="（2）Next侧边栏添加"></a>（2）Next侧边栏添加</h4><p>参考官方文档：<a href="https://theme-next.js.org/docs/theme-settings/sidebar">Sidebar Setting</a></p><p>会在社交下增加任意个超链接，缺点是地方有限，无法放置过多链接；以及没有图标。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blog rolls</span></span><br><span class="line"><span class="attr">links_settings:</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">far</span> <span class="string">fa-smile-wink</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">个人</span></span><br><span class="line">  <span class="comment"># Available values: block | inline</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="string">block</span></span><br><span class="line"></span><br><span class="line"><span class="attr">links:</span></span><br><span class="line">  <span class="string">网易云音乐:</span> <span class="string">https://music.163.com/#/XXX</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Table of Contents in the Sidebar</span></span><br><span class="line"><span class="comment"># Front-matter variable (unsupport wrap expand_all).</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If true, all words will placed on next lines if header width longer then sidebar width.</span></span><br><span class="line">  <span class="attr">wrap:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># If true, all level of TOC in a post will be displayed, rather than the activated part of it.</span></span><br><span class="line">  <span class="attr">expand_all:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Maximum heading</span></span><br></pre></td></tr></table></figure><h4 id="（3）自定义界面"><a href="#（3）自定义界面" class="headerlink" title="（3）自定义界面"></a>（3）自定义界面</h4><p>参考：<a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/">Hexo NexT 添加友链页面</a></p><p>涉及到的文件：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config<span class="selector-class">.next</span><span class="selector-class">.yml</span></span><br><span class="line">└── source</span><br><span class="line">    ├── _data</span><br><span class="line">    │   └── <span class="selector-tag">body</span>-end<span class="selector-class">.njk</span></span><br><span class="line">    ├── css</span><br><span class="line">    │   └── link<span class="selector-class">.css</span>（也可以放置到主题中相同子路径）</span><br><span class="line">    ├── js</span><br><span class="line">    │   └── link<span class="selector-class">.js</span>（也可以放置到主题中相同子路径）</span><br><span class="line">    └── links</span><br><span class="line">        ├── index<span class="selector-class">.md</span></span><br><span class="line">        └── linklist<span class="selector-class">.json</span></span><br></pre></td></tr></table></figure><h5 id="1-建立页面"><a href="#1-建立页面" class="headerlink" title="1. 建立页面"></a>1. 建立页面</h5><p>执行命令，这会创建 <code>source/links/index.md</code> 文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page links</span><br></pre></td></tr></table></figure><p>文件示例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 友情链接</span><br><span class="line">type: links</span><br><span class="line">toc:</span><br><span class="line"><span class="section">  enable: false</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/css/link.css&quot;</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#123;% note info %&#125;</span><br><span class="line"></span><br><span class="line">排名不分先后，每次刷新会随机排列。</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;div class=&quot;link-navigation&quot; id=&quot;links1&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="code">  &lt;/div&gt;</span></span><br><span class="line"><span class="code">&lt;/div&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;&quot;</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate1&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  留言互换友链 o ((&gt;ω&lt;)) o</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;animate2&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-heart&quot;</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="section">  </span></span><br><span class="line"><span class="section">------</span></span><br><span class="line"></span><br><span class="line">&#123;% note success %&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## 友链格式</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 名称：如鱼饮水，冷暖自知</span><br><span class="line"><span class="bullet">-</span> 网址：[<span class="string">https://wangjiezhe.com</span>](<span class="link">https://wangjiezhe.com</span>)</span><br><span class="line"><span class="bullet">-</span> 头像：[<span class="string">https://gravatar.loli.net/avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>](<span class="link">https://gravatar.loli.net//avatar/e09cf54e933e5a690716e68961ff3b1c?s=512</span>)</span><br><span class="line"></span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure><p>注意在 Front-Matter 里一定要有 <code>type: links</code> ，这里我还关闭了侧边栏的目录。</p><h5 id="2-存储数据"><a href="#2-存储数据" class="headerlink" title="2. 存储数据"></a>2. 存储数据</h5><p>所有友链的数据都放在 <code>source/links/linklist.json</code> 里，其格式为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;site&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>其中 <code>name</code> 为网站的名字，<code>site</code> 为网址，<code>avatar</code> 为头像。头像可以使用 Gravatar，这样可以保证始终可用的。</p><h5 id="3-渲染页面"><a href="#3-渲染页面" class="headerlink" title="3. 渲染页面"></a>3. 渲染页面</h5><p>在 <code>source/_data/body-end.njk</code> 中，引入 <code>link.js</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> page.type === <span class="string">&#x27;links&#x27;</span> %&#125;</span><br><span class="line">  &#123;&#123;- next_js(<span class="string">&#x27;link.js&#x27;</span>, <span class="literal">true</span>) &#125;&#125;</span><br><span class="line">&#123;% endif %</span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中开启自定义配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="comment">#head: source/_data/head.njk</span></span><br><span class="line">  <span class="comment">#header: source/_data/header.njk</span></span><br><span class="line">  <span class="comment">#sidebar: source/_data/sidebar.njk</span></span><br><span class="line">  <span class="comment">#postMeta: source/_data/post-meta.njk</span></span><br><span class="line">  <span class="comment">#postBodyEnd: source/_data/post-body-end.njk</span></span><br><span class="line">  <span class="comment">#footer: source/_data/footer.njk</span></span><br><span class="line">  <span class="attr">bodyEnd:</span> <span class="string">source/_data/body-end.njk</span></span><br><span class="line">  <span class="comment">#variable: source/_data/variables.styl</span></span><br><span class="line">  <span class="comment">#mixin: source/_data/mixins.styl</span></span><br><span class="line">  <span class="comment">#style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><p>其中 <code>source/js/link.js</code> 的内容为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 随机排列</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shuffle</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = arr.length;</span><br><span class="line">  <span class="keyword">while</span> (i) &#123;</span><br><span class="line">    <span class="keyword">let</span> j = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * i--);</span><br><span class="line">    [arr[j], arr[i]] = [arr[i], arr[j]];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderlink</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name, avatar, site, li = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  shuffle(data);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">    name = data[i].name;</span><br><span class="line">    avatar = data[i].avatar;</span><br><span class="line">    site = data[i].site;</span><br><span class="line">    li += <span class="string">&#x27;&lt;div class=&quot;card&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;thumb&quot; style=&quot;background: url( &#x27;</span> + avatar + <span class="string">&#x27;);&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/a&gt;&#x27;</span> + <span class="string">&#x27;&lt;div class=&quot;card-header&quot;&gt;&#x27;</span> + <span class="string">&#x27;&lt;div&gt;&lt;a href=&quot;&#x27;</span> + site + <span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;&#x27;</span> + name + <span class="string">&#x27;&lt;/a&gt;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">&quot;.link-navigation&quot;</span>).innerHTML = li;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 json 文件</span></span><br><span class="line">fetch(<span class="string">&#x27;/links/linklist.json&#x27;</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> renderlink(res));</span><br></pre></td></tr></table></figure><h5 id="4-创建样式"><a href="#4-创建样式" class="headerlink" title="4. 创建样式"></a>4. 创建样式</h5><p>创建 <code>source/css/link.css</code>，其内容为（这个文件完全来自于网络）：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.links-content</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1rem</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.link-navigation</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot; &quot;</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">clear</span>: both</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">130px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">  <span class="attribute">transition-duration</span>: .<span class="number">15s</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>);</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f5f5f5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(max-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">16px</span>)/<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">2</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:567px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">32px</span>)/<span class="number">3</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">3</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:768px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">48px</span>)/<span class="number">4</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">4</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span>(min-width:1200px) &#123;</span><br><span class="line">  <span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="built_in">calc</span>((<span class="number">100%</span> - <span class="number">64px</span>)/<span class="number">5</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.card</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:nth-child</span>(<span class="number">5</span>n+<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">16px</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">12</span>),<span class="number">0</span> <span class="number">0</span> <span class="number">6px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,.<span class="number">04</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.thumb</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding-bottom</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span><span class="meta">!important</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.posts-expand</span> <span class="selector-class">.post-body</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1rem</span> .<span class="number">25rem</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  <span class="attribute">white-space</span>: normal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">font-style</span>: normal;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#2bbc8a</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.card</span> <span class="selector-class">.card-header</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#d480aa</span>;</span><br><span class="line">  <span class="attribute">text-decoration</span>: none;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-添加侧栏"><a href="#5-添加侧栏" class="headerlink" title="5. 添加侧栏"></a>5. 添加侧栏</h5><p>在主题配置文件 <code>\themes\next\_config.yml</code> 中，添加</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: / || fa fa-home</span><br><span class="line">  tags: /tags/ || fa fa-tags</span><br><span class="line">  categories: /categories/ || fa fa-th</span><br><span class="line">  archives: /archives/ || fa fa-archive</span><br><span class="line"><span class="addition">+  links: /links/ || fa fa-link</span></span><br></pre></td></tr></table></figure><h5 id="6-问题排查"><a href="#6-问题排查" class="headerlink" title="6. 问题排查"></a>6. 问题排查</h5><p>步骤：</p><ol><li>浏览器 F12 查看页面源码，是否有一个 class 是 <code>.link-navigation</code> 的网页元素。</li><li>查看 <code>link.js</code> 是否正常加载了，json 文件是否正常加载了。</li></ol><p>按上述配置后， <code>link.js</code> 加载报错 <code>Unexpected token &#39;&lt;&#39;</code> ，发现是因为启用了音乐播放器APlayer，默认会为文件添加一行标签配置，导致JS和读取Json时报错。</p><p>官方文档：<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">hexo-tag-aplayer</a></p><p>站点配置文件 <code>\_config.yml</code> 中将asset_inject属性设置为false，即可解决问题（可能需要重新编译）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 音乐播放器</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="2-8-设置站点图标"><a href="#2-8-设置站点图标" class="headerlink" title="2.8 设置站点图标"></a>2.8 设置站点图标</h3><p>下载一个32*32的ico图标，修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Put your favicon.ico into `hexo-site/source/` directory.</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br></pre></td></tr></table></figure><h3 id="2-9-修改字体"><a href="#2-9-修改字体" class="headerlink" title="2.9 修改字体"></a>2.9 修改字体</h3><p>在 <a href="https://www.google.com/fonts">Google Fonts</a> 上找到心仪的字体，然后在主题配置文件 <code>\themes\next\_config.yml</code> 中为不同的应用场景配置字体：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Font Settings</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Find fonts on Google Fonts (https://fonts.google.com)</span></span><br><span class="line"><span class="comment"># All fonts set here will have the following styles:</span></span><br><span class="line"><span class="comment">#   light | light italic | normal | normal italic | bold | bold italic</span></span><br><span class="line"><span class="comment"># Be aware that setting too much fonts will cause site running slowly</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Web Safe fonts are recommended for `global` (and `title`):</span></span><br><span class="line"><span class="comment"># Arial | Tahoma | Helvetica | Times New Roman | Courier New | Verdana | Georgia | Palatino | Garamond | Comic Sans MS | Trebuchet MS</span></span><br><span class="line"><span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uri of fonts host, e.g. https://fonts.googleapis.com (Default).</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font options:</span></span><br><span class="line">  <span class="comment"># `external: true` will load this font family from `host` above.</span></span><br><span class="line">  <span class="comment"># `family: Times New Roman`. Without any quotes.</span></span><br><span class="line">  <span class="comment"># `size: x.x`. Use `em` as unit. Default: 1 (16px)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Global font settings used for all elements inside &lt;body&gt;.</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Monda</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for site title (.site-title).</span></span><br><span class="line">  <span class="attr">title:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for headlines (&lt;h1&gt; to &lt;h6&gt;).</span></span><br><span class="line">  <span class="attr">headings:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span> <span class="string">Roboto</span> <span class="string">Slab</span></span><br><span class="line">    <span class="attr">size:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for posts (.post-body).</span></span><br><span class="line">  <span class="attr">posts:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Font settings for &lt;code&gt; and code blocks.</span></span><br><span class="line">  <span class="attr">codes:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">family:</span></span><br></pre></td></tr></table></figure><h3 id="2-10-设置首页只显示部分内容"><a href="#2-10-设置首页只显示部分内容" class="headerlink" title="2.10 设置首页只显示部分内容"></a>2.10 设置首页只显示部分内容</h3><p>这个只要在文章中加上 &lt;&#33;–more–&gt; 标记 ，该标记以后部分就不在显示了，只有展开全部才显示，这是hexo定义的。但这样手动配置感觉会很麻烦，所以修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically Excerpt. Not recommand.</span></span><br><span class="line"><span class="comment"># Please use &lt;!-- more --&gt; in the post to control excerpt accurately.</span></span><br><span class="line"><span class="attr">auto_excerpt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">length:</span> <span class="number">150</span></span><br></pre></td></tr></table></figure><p>把enable改为对应的false改为true。</p><p>新版本：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically excerpt description in homepage as preamble text.</span></span><br><span class="line"><span class="attr">excerpt_description:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read more button</span></span><br><span class="line"><span class="comment"># If true, the read more button will be displayed in excerpt section.</span></span><br><span class="line"><span class="attr">read_more_btn:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-11-设置博客背景"><a href="#2-11-设置博客背景" class="headerlink" title="2.11 设置博客背景"></a>2.11 设置博客背景</h3><p>旧版本，打开文件 <code>blog\themes\next\source\css\_custom\custom.styl</code> ：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>:<span class="number">1200px</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>);      //这一行的括号里填背景图片的路径，将图片重命名为<span class="attribute">background</span><span class="selector-class">.jpg</span>放在\themes\next\source\images下，也可填图片的链接。</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed;</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-id">#footer</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>:<span class="number">#eee</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版本，<code>source/_data/styles.styl</code> 文件，添加：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">/images/background.jpg</span>); // 可以是路径也可以是链接</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat; // 不重复</span><br><span class="line">    <span class="attribute">background-attachment</span>:fixed; // 固定住背景图片</span><br><span class="line">    <span class="attribute">background-position</span>:<span class="number">50%</span> <span class="number">50%</span>; // 图片位置：居中</span><br><span class="line">    <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>; // 图片长宽扩充为<span class="number">100%</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主题配置文件 <code>blog/themes/next/_config.yml</code> ：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Define custom file paths.</span><br><span class="line"># Create your custom files in site directory `source/_data` and uncomment needed files below.</span><br><span class="line">custom_file_path:</span><br><span class="line">  #head: source/_data/head.njk</span><br><span class="line">  #header: source/_data/header.njk</span><br><span class="line">  #sidebar: source/_data/sidebar.njk</span><br><span class="line">  #postMeta: source/_data/post-meta.njk</span><br><span class="line">  #postBodyEnd: source/_data/post-body-end.njk</span><br><span class="line">  #footer: source/_data/footer.njk</span><br><span class="line">  bodyEnd: source/_data/body-end.njk</span><br><span class="line">  #variable: source/_data/variables.styl</span><br><span class="line">  #mixin: source/_data/mixins.styl</span><br><span class="line"><span class="deletion">-  #style: source/_data/styles.styl</span></span><br><span class="line"><span class="addition">+  style: source/_data/styles.styl</span></span><br></pre></td></tr></table></figure><h3 id="2-12-添加腾讯公益404页面"><a href="#2-12-添加腾讯公益404页面" class="headerlink" title="2.12 添加腾讯公益404页面"></a>2.12 添加腾讯公益404页面</h3><p>在 <code>blog\themes\next\source\</code> 路径下新建 <code>404.html</code> 文件，添加如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;content-type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge,chrome=1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;all&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;robots&quot;</span> <span class="attr">content</span>=<span class="string">&quot;index,follow&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/style/404style.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/plain&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://www.qq.com/404/search_children.js&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> <span class="attr">homePageUrl</span>=<span class="string">&quot;/&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">homePageName</span>=<span class="string">&quot;回到我的主页&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/data.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://qzone.qq.com/gy/404/page.js&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，开启 <code>commonweal</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">archive</span></span><br><span class="line">  <span class="comment"># schedule: /schedule/ || calendar</span></span><br><span class="line">  <span class="attr">sitemap:</span> <span class="string">/sitemap.xml</span> <span class="string">||</span> <span class="string">sitemap</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">/404/</span> <span class="string">||</span> <span class="string">heartbeat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable/Disable menu icons.</span></span><br><span class="line"><span class="attr">menu_icons:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Icon Mapping</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">home</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">about</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">th</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">tags</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">archive</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">heartbeat</span></span><br></pre></td></tr></table></figure><h3 id="2-13-添加版权声明"><a href="#2-13-添加版权声明" class="headerlink" title="2.13 添加版权声明"></a>2.13 添加版权声明</h3><p>旧版本，修改主题配置文件 <code>\themes\next\_config.xml</code> ，找到 <code>post_copyright</code> 开启 <code>enable</code> ：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Declare license on posts</span></span><br><span class="line"><span class="attr">post_copyright:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">CC</span> <span class="string">BY-NC-SA</span> <span class="number">3.0</span></span><br><span class="line">  <span class="attr">license_url:</span> <span class="string">https://creativecommons.org/licenses/by-nc-sa/3.0/</span></span><br></pre></td></tr></table></figure><p>修改根目录配置文件：确认 <code>url</code> 属性有配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">http://linyishui.top</span></span><br></pre></td></tr></table></figure><p>新版本，修改主题配置文件 <code>\themes\next\_config.xml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Creative Commons 4.0 International License.</span></span><br><span class="line"><span class="comment"># See: https://creativecommons.org/about/cclicenses/</span></span><br><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="comment"># Available values: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | cc-zero</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="comment"># Available values: big | small</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">small</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># You can set a language value if you prefer a translated version of CC license, e.g. deed.zh</span></span><br><span class="line">  <span class="comment"># CC licenses are available in 39 languages, you can find the specific and correct abbreviation you need on https://creativecommons.org</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">deed.zh</span></span><br></pre></td></tr></table></figure><h3 id="2-14-页脚增加建站时间"><a href="#2-14-页脚增加建站时间" class="headerlink" title="2.14 页脚增加建站时间"></a>2.14 页脚增加建站时间</h3><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，找到since：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">since:</span> <span class="number">2018</span></span><br></pre></td></tr></table></figure><h3 id="2-15-侧栏增加已运行时间（旧版本）"><a href="#2-15-侧栏增加已运行时间（旧版本）" class="headerlink" title="2.15 侧栏增加已运行时间（旧版本）"></a>2.15 侧栏增加已运行时间（旧版本）</h3><p>打开文件 <code>blog/themes/next/layout/_custom/sidebar.swig</code> ，增加如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;days&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">show_date_time</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.setTimeout(<span class="string">&quot;show_date_time()&quot;</span>, <span class="number">1000</span>);</span></span><br><span class="line"><span class="javascript">    BirthDay=<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">&quot;07/26/2018 00:00:00&quot;</span>);</span></span><br><span class="line"><span class="javascript">    today=<span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line"><span class="javascript">    timeold=(today.getTime()-BirthDay.getTime());</span></span><br><span class="line"><span class="javascript">    sectimeold=timeold/<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    secondsold=<span class="built_in">Math</span>.floor(sectimeold);</span></span><br><span class="line"><span class="javascript">    msPerDay=<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span></span></span><br><span class="line"><span class="javascript">    e_daysold=timeold/msPerDay</span></span><br><span class="line"><span class="javascript">    daysold=<span class="built_in">Math</span>.floor(e_daysold);</span></span><br><span class="line"><span class="javascript">    e_hrsold=(e_daysold-daysold)*<span class="number">24</span>;</span></span><br><span class="line"><span class="javascript">    hrsold=setzero(<span class="built_in">Math</span>.floor(e_hrsold));</span></span><br><span class="line"><span class="javascript">    e_minsold=(e_hrsold-hrsold)*<span class="number">60</span>;</span></span><br><span class="line"><span class="javascript">    minsold=setzero(<span class="built_in">Math</span>.floor((e_hrsold-hrsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    seconds=setzero(<span class="built_in">Math</span>.floor((e_minsold-minsold)*<span class="number">60</span>));</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;days&#x27;</span>).innerHTML=<span class="string">&quot;已运行 &quot;</span>+daysold+<span class="string">&quot; 天 &quot;</span>+hrsold+<span class="string">&quot; 小时 &quot;</span>+minsold+<span class="string">&quot; 分 &quot;</span>+seconds+<span class="string">&quot; 秒&quot;</span>;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">setzero</span>(<span class="params">i</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (i&lt;<span class="number">10</span>) &#123;</span></span><br><span class="line"><span class="javascript">        i=<span class="string">&quot;0&quot;</span> + i</span></span><br><span class="line"><span class="javascript">    &#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> i;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript">show_date_time();</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后打开文件 <code>blog/themes/next/layout/_macro/sidebar.swig</code>（修改位置，可不修改）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  &#123;# Blogroll #&#125;</span><br><span class="line">  &#123;% if theme.links %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll motion-element &#123;&#123; &quot;</span><span class="attr">links-of-blogroll-</span>&quot; + <span class="attr">theme.links_layout</span> | <span class="attr">default</span>(&#x27;<span class="attr">inline</span>&#x27;) &#125;&#125;&quot;&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-title&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        &#123;&#123; theme.links_title &#125;&#125;<span class="symbol">&amp;nbsp;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa  fa-fw fa-&#123;&#123; theme.links_icon | default(&#x27;globe&#x27;) | lower &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-list&quot;</span>&gt;</span></span><br><span class="line">        &#123;% for name, link in theme.links %&#125;</span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;links-of-blogroll-item&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; link &#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123; name &#125;&#125;&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>&#123;&#123; name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">   &#123;% include &#x27;../_custom/sidebar.swig&#x27; %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以通过文件 <code>blog/themes/next/source/css/_custom/custom.styl</code> ，修改时间栏样式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 自定义的侧栏时间样式 */</span></span><br><span class="line"><span class="selector-id">#days</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">7</span>, <span class="number">179</span>, <span class="number">155</span>);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-16-侧栏头像点击返回首页（旧版本）"><a href="#2-16-侧栏头像点击返回首页（旧版本）" class="headerlink" title="2.16 侧栏头像点击返回首页（旧版本）"></a>2.16 侧栏头像点击返回首页（旧版本）</h3><p>修改文件 <code>blog/themes/next/layout/_macro/sidebar.swig</code> ：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;site-author-image&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;image&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for( theme.avatar | default(theme.images + &#x27;/avatar.gif&#x27;) ) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">alt</span>=<span class="string">&quot;&#123;&#123; theme.author &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-17-页脚增加会跳动的心（旧版本）"><a href="#2-17-页脚增加会跳动的心（旧版本）" class="headerlink" title="2.17 页脚增加会跳动的心（旧版本）"></a>2.17 页脚增加会跳动的心（旧版本）</h3><p>首先修改主题配置文件 <code>blog\themes\next\_config.yml</code> ，找到icon：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">footer:</span></span><br><span class="line">  <span class="comment"># Icon between year and copyright info.</span></span><br><span class="line">  <span class="attr">icon:</span> <span class="string">heart</span></span><br></pre></td></tr></table></figure><p>然后修改文件 <code>blog/themes/next/layout/_partials/footer.swig</code> ，找到 <code>with-love</code> ，增加id：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;with-love&quot;</span> <span class="attr">id</span>=<span class="string">&quot;heart&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-&#123;&#123; theme.footer.icon &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最后修改文件 <code>blog/themes/next/source/css/_custom/custom.styl</code> ，增加以下内容：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 自定义页脚跳动的心样式 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> heartAnimate &#123;</span><br><span class="line">    <span class="number">0%</span>,<span class="number">100%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1</span>);&#125;</span><br><span class="line">    <span class="number">10%</span>,<span class="number">30%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">0.9</span>);&#125;</span><br><span class="line">    <span class="number">20%</span>,<span class="number">40%</span>,<span class="number">60%</span>,<span class="number">80%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">    <span class="number">50%</span>,<span class="number">70%</span>&#123;<span class="attribute">transform</span>:<span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#heart</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">    <span class="attribute">animation</span>: heartAnimate <span class="number">1.33s</span> ease-in-out infinite;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-18-隐藏网页底部powered-By（旧版本）"><a href="#2-18-隐藏网页底部powered-By（旧版本）" class="headerlink" title="2.18 隐藏网页底部powered By（旧版本）"></a>2.18 隐藏网页底部powered By（旧版本）</h3><p>打开 <code>themes/next/layout/_partials/footer.swig</code> ，使用 “&lt;&#33;–&gt;” 隐藏之间的代码即可，或者直接删除，位置如图:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280213.png"></p><h3 id="2-19-自定义鼠标样式（旧版本）"><a href="#2-19-自定义鼠标样式（旧版本）" class="headerlink" title="2.19 自定义鼠标样式（旧版本）"></a>2.19 自定义鼠标样式（旧版本）</h3><p>打开 <code>themes/next/source/css/_custom/custom.styl</code> ，在里面写下如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 鼠标样式</span><br><span class="line">  * &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword2.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-pseudo">:active</span> &#123;</span><br><span class="line">      <span class="attribute">cursor</span>: <span class="built_in">url</span>(<span class="string">&quot;http://om8u46rmb.bkt.clouddn.com/sword1.ico&quot;</span>),auto<span class="meta">!important</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>其中 url 里面必须是 ico 图片，替换后发现实际点触和鼠标图标是有偏差的，所以我取消了鼠标的样式。</p><h3 id="2-20-博文压缩（旧版本）"><a href="#2-20-博文压缩（旧版本）" class="headerlink" title="2.20 博文压缩（旧版本）"></a>2.20 博文压缩（旧版本）</h3><p>在站点的根目录下执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp -g</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install gulp-minify-css gulp-uglify gulp-htmlmin gulp-htmlclean gulp --save</span></span><br></pre></td></tr></table></figure><p>根目录下新建 <code>gulpfile.js</code> ，并填入以下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">&#x27;gulp&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">&#x27;gulp-minify-css&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">&#x27;gulp-uglify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlmin = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlmin&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> htmlclean = <span class="built_in">require</span>(<span class="string">&#x27;gulp-htmlclean&#x27;</span>);</span><br><span class="line"><span class="comment">// 压缩 public 目录 css</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-css&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.css&#x27;</span>)</span><br><span class="line">        .pipe(minifycss())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩 public 目录 html</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-html&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.html&#x27;</span>)</span><br><span class="line">    .pipe(htmlclean())</span><br><span class="line">    .pipe(htmlmin(&#123;</span><br><span class="line">         <span class="attr">removeComments</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyJS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyCSS</span>: <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">minifyURLs</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;))</span><br><span class="line">    .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩 public/js 目录 js</span></span><br><span class="line">gulp.task(<span class="string">&#x27;minify-js&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">&#x27;./public/**/*.js&#x27;</span>)</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">&#x27;./public&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 执行 gulp 命令时执行的任务</span></span><br><span class="line">gulp.task(<span class="string">&#x27;default&#x27;</span>, [</span><br><span class="line">    <span class="string">&#x27;minify-html&#x27;</span>,<span class="string">&#x27;minify-css&#x27;</span>,<span class="string">&#x27;minify-js&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>生成博文是执行 <code>hexo g &amp;&amp; gulp</code> 就会根据 <code>gulpfile.js</code> 中的配置，对 public 目录中的静态资源文件进行压缩。</p><h3 id="2-21-添加主页文章阴影效果（旧版本）"><a href="#2-21-添加主页文章阴影效果（旧版本）" class="headerlink" title="2.21 添加主页文章阴影效果（旧版本）"></a>2.21 添加主页文章阴影效果（旧版本）</h3><p>打开 <code>\themes\next\source\css\_custom\custom.styl</code> ，向里面加入：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 主页文章添加阴影效果</span><br><span class="line"> <span class="selector-class">.post</span> &#123;</span><br><span class="line">   <span class="attribute">margin-top</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">margin-bottom</span>: <span class="number">60px</span>;</span><br><span class="line">   <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">   -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">203</span>, .<span class="number">5</span>);</span><br><span class="line">   -moz-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, .<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="2-22-添加动态背景（旧版本）"><a href="#2-22-添加动态背景（旧版本）" class="headerlink" title="2.22 添加动态背景（旧版本）"></a>2.22 添加动态背景（旧版本）</h3><p>如果next主题在5.1.1以上的话，直接在主题配置文件 <code>\themes\next\_config.yml</code> 中找到 <code>canvas_nest: false</code> ，把它改为 <code>canvas_nest: true</code> 就行了（注意分号后面要加一个空格）。</p><h2 id="三-功能配置-博文"><a href="#三-功能配置-博文" class="headerlink" title="三. 功能配置-博文"></a>三. 功能配置-博文</h2><h3 id="3-1-开启图片灯箱"><a href="#3-1-开启图片灯箱" class="headerlink" title="3.1 开启图片灯箱"></a>3.1 开启图片灯箱</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class="line"><span class="comment"># For more information: https://fancyapps.com/fancybox/</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-2-修改标签图标"><a href="#3-2-修改标签图标" class="headerlink" title="3.2 修改标签图标"></a>3.2 修改标签图标</h3><p>默认情况下标签前缀是 <code>#</code> 字符，旧版本中用户可以通过修改主题源码将标签的字符前缀改为图标前缀，在 <code>themes\next\layout\_macro\post.swig  </code> 文章布局模板中找到文末标签相关代码段，将 <code>#</code> 换成 <code>&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt;</code> 即可：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer class=&quot;post-footer&quot;&gt;</span><br><span class="line">    &#123;% if post.tags and post.tags.length and not is_index %&#125;</span><br><span class="line">      &lt;div class=&quot;post-tags&quot;&gt;</span><br><span class="line">        &#123;% for tag in post.tags %&#125;</span><br><span class="line"><span class="deletion">-          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;# &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line"><span class="addition">+          &lt;a href=&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot; rel=&quot;tag&quot;&gt;&lt;i class=&quot;fa fa-tags&quot;&gt;&lt;/i&gt; &#123;&#123; tag.name &#125;&#125;&lt;/a&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/footer&gt;</span><br></pre></td></tr></table></figure><p>Next 中使用 <a href="https://fontawesome.com/v4.7.0/icons/">FontAwesome</a> 作为图标库，用户可以在 FontAwesome 上找到心仪的图标来替换标签的字符前缀。</p><p>新版直接修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use icon instead of the symbol # to indicate the tag at the bottom of the post</span></span><br><span class="line"><span class="attr">tag_icon:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-3-开启相关文章推荐"><a href="#3-3-开启相关文章推荐" class="headerlink" title="3.3 开启相关文章推荐"></a>3.3 开启相关文章推荐</h3><p>该功能由 <a href="https://github.com/tea3/hexo-related-popular-posts">hexo-related-popular-posts</a> 插件提供，在站点根目录中执行以下命令安装依赖：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-related-popular-posts --save</span></span><br></pre></td></tr></table></figure><p>在主题配置文件中 <code>\themes\next\_config.yml</code> 开启相关文章推荐功能：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Related popular posts</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/tea3/hexo-related-popular-posts</span></span><br><span class="line"><span class="attr">related_posts:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">title:</span> <span class="comment"># Custom header, leave empty to use the default one</span></span><br><span class="line">  <span class="attr">display_in_home:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">maxCount:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment">#PPMixingRate: 0.0</span></span><br><span class="line">    <span class="comment">#isDate: false</span></span><br><span class="line">    <span class="comment">#isImage: false</span></span><br><span class="line">    <span class="comment">#isExcerpt: false</span></span><br></pre></td></tr></table></figure><p>会在每篇文章结尾根据标签相关性和内容相关性来推荐相关文章。事实上并非每篇文章都需要开启该功能，可在文章 Front-Matter 中设置 <code>related_posts</code> 字段来控制是否在文末显示相关文章，然后修改文章布局模板中相关的判定条件 <code>themes/next/layout/_macro/post.njk</code> ：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) %&#125;</span></span><br><span class="line"><span class="addition">+     &#123;%- if theme.related_posts.enable and (theme.related_posts.display_in_home or not is_index) and post.related_posts %&#125;</span></span><br><span class="line">      &#123;&#123; partial(&#x27;_partials/post/post-related.njk&#x27;) &#125;&#125;</span><br></pre></td></tr></table></figure><p>为了方便可在草稿模板 <code>\scaffolds\draft.md</code> 中统一添加 <code>related_posts</code> 字段默认值：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="addition">+ related_posts: true</span></span><br></pre></td></tr></table></figure><h3 id="3-4-修改代码块自定义样式"><a href="#3-4-修改代码块自定义样式" class="headerlink" title="3.4 修改代码块自定义样式"></a>3.4 修改代码块自定义样式</h3><p>旧版本，打开 <code>\themes\next\source\css\_custom\custom.styl</code> ，向里面加入：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// Custom styles.</span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ff7600</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fbf7f8</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br><span class="line">// 大代码块的自定义样式</span><br><span class="line"><span class="selector-class">.highlight</span>, pre &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.highlight</span>, <span class="selector-tag">code</span>, pre &#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d6d6d6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新版本，主题配置文件中 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line">  <span class="comment"># Code Highlight theme</span></span><br><span class="line">  <span class="comment"># All available themes: https://theme-next.js.org/highlight/</span></span><br><span class="line">  <span class="attr">theme:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">tomorrow-night</span></span><br><span class="line">  <span class="attr">prism:</span></span><br><span class="line">    <span class="attr">light:</span> <span class="string">prism</span></span><br><span class="line">    <span class="attr">dark:</span> <span class="string">prism-dark</span></span><br><span class="line">  <span class="comment"># Add copy button on codeblock</span></span><br><span class="line">  <span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">mac</span></span><br></pre></td></tr></table></figure><h3 id="3-5-添加顶部加载条"><a href="#3-5-添加顶部加载条" class="headerlink" title="3.5 添加顶部加载条"></a>3.5 添加顶部加载条</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 将 <code>pace: false</code> 改为 <code>pace: true</code> ，还可以换不同样式的加载条，如下图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280212.png"></p><p>查看不同主题效果：<a href="https://codebyzach.github.io/pace/">Pace-Themes</a></p><p>V8版本之后好像废弃了Pace，代替为nprogress，但没有样式可以选，而且似乎会和阅读进度条冲突：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Progress bar in the top during page loading.</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rstacruz/nprogress</span></span><br><span class="line"><span class="attr">nprogress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">spinner:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-6-开启顶部阅读进度"><a href="#3-6-开启顶部阅读进度" class="headerlink" title="3.6 开启顶部阅读进度"></a>3.6 开启顶部阅读进度</h3><p>主题配置文件中 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Reading progress bar</span></span><br><span class="line"><span class="attr">reading_progress:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Available values: left | right</span></span><br><span class="line">  <span class="attr">start_at:</span> <span class="string">left</span></span><br><span class="line">  <span class="comment"># Available values: top | bottom</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">top</span></span><br><span class="line">  <span class="attr">reversed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#37acc6&quot;</span></span><br><span class="line">  <span class="attr">height:</span> <span class="string">3px</span></span><br></pre></td></tr></table></figure><h3 id="3-7-右上角添加bookmark记录阅读进度"><a href="#3-7-右上角添加bookmark记录阅读进度" class="headerlink" title="3.7 右上角添加bookmark记录阅读进度"></a>3.7 右上角添加bookmark记录阅读进度</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bookmark Support</span></span><br><span class="line"><span class="attr">bookmark:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Customize the color of the bookmark.</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">&quot;#222&quot;</span></span><br><span class="line">  <span class="comment"># If auto, save the reading progress when closing the page or clicking the bookmark-icon.</span></span><br><span class="line">  <span class="comment"># If manual, only save it by clicking the bookmark-icon.</span></span><br><span class="line">  <span class="attr">save:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure><h3 id="3-8-右上角添加-Follow-Me-On-GitHub"><a href="#3-8-右上角添加-Follow-Me-On-GitHub" class="headerlink" title="3.8 右上角添加 Follow Me On GitHub"></a>3.8 右上角添加 Follow Me On GitHub</h3><p>修改主题配置文件中 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `Follow me on GitHub` banner in the top-right corner.</span></span><br><span class="line"><span class="attr">github_banner:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">permalink:</span> <span class="string">https://github.com/LAILAIWA</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">Follow</span> <span class="string">me</span> <span class="string">on</span> <span class="string">GitHub</span></span><br></pre></td></tr></table></figure><h3 id="3-9-返回顶部按钮添加百分比"><a href="#3-9-返回顶部按钮添加百分比" class="headerlink" title="3.9 返回顶部按钮添加百分比"></a>3.9 返回顶部按钮添加百分比</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3-10-取消目录生成的自动序号"><a href="#3-10-取消目录生成的自动序号" class="headerlink" title="3.10 取消目录生成的自动序号"></a>3.10 取消目录生成的自动序号</h3><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中number属性为false即可。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Table Of Contents in the Sidebar</span></span><br><span class="line"><span class="attr">toc:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Automatically add list number to toc.</span></span><br><span class="line">  <span class="attr">number:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="3-11-添加底部访问量（旧版本）"><a href="#3-11-添加底部访问量（旧版本）" class="headerlink" title="3.11 添加底部访问量（旧版本）"></a>3.11 添加底部访问量（旧版本）</h3><p>打开 <code>\themes\next\layout\_partials\footer.swig</code> 文件，在copyright前加上这句话：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span> <span class="attr">src</span>=<span class="string">&quot;https://dn-</span></span></span><br><span class="line"><span class="string"><span class="tag">lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>2019/07/16更新：<a href="http://busuanzi.ibruce.info/" title="Title">不蒜子官网</a>提示原地址已失效，请把dn-lbstatics.qbox.me 域名更换为 busuanzi.ibruce.info</p></blockquote><p>然后在合适的位置添加显示统计的代码:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280215.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;powered-by&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-user-md&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  本站访客数:<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这里有两中不同计算方式的统计代码：</p><ul><li><p>pv的方式，单个用户连续点击n篇文章，记录n次访问量：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span></span><br><span class="line">    本站总访问量<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_pv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>次</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>uv的方式，单个用户连续点击n篇文章，只记录1次访客数：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_container_site_uv&quot;</span>&gt;</span></span><br><span class="line">  本站总访问量<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;busuanzi_value_site_uv&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>次</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>添加之后再执行 <code>hexo d -g</code> ，然后再刷新页面就能看到效果。</p><h3 id="3-12-添加博文末尾标记（旧版本）"><a href="#3-12-添加博文末尾标记（旧版本）" class="headerlink" title="3.12 添加博文末尾标记（旧版本）"></a>3.12 添加博文末尾标记（旧版本）</h3><p>在 <code>\themes\next\layout\_macro</code> 中新建 <code>passage-end-tag.swig</code> 文件，并添加以下内容:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% if not is_index %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;color: #ccc;font-size:14px;&quot;</span>&gt;</span>-------------本文结束<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-paw&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>感谢您的阅读-------------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接着打开 <code>\themes\next\layout\_macro\post.swig</code> 文件，在post-body 之后， post-footer 之前添加如下画红色部分代码（post-footer之前两个DIV）:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280211.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">    &#123;% include &#x27;passage-end-tag.swig&#x27; %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后打开主题配置文件 <code>\themes\next\_config.yml</code> ，在末尾添加:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文章末尾添加“本文结束”标记</span></span><br><span class="line"><span class="attr">passage_end_tag:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>完成以上设置之后，在每篇文章之后都会添加如上效果图的样子。</p><h3 id="3-13-MarkDown常用"><a href="#3-13-MarkDown常用" class="headerlink" title="3.13 MarkDown常用"></a>3.13 MarkDown常用</h3><p>代码新增删除变色：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">​<span class="code">```diff</span></span><br><span class="line"><span class="code">+</span></span><br><span class="line"><span class="code">-</span></span><br><span class="line"><span class="code">​```</span></span><br></pre></td></tr></table></figure><h2 id="四-新增插件"><a href="#四-新增插件" class="headerlink" title="四. 新增插件"></a>四. 新增插件</h2><h3 id="4-1-统计功能"><a href="#4-1-统计功能" class="headerlink" title="4.1 统计功能"></a>4.1 统计功能</h3><p>实现统计功能，首先在根目录下安装 <code>hexo-wordcount</code> ，运行:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-wordcount --save</span></span><br></pre></td></tr></table></figure><p>然后在主题配置文件 <code>\themes\next\_config.yml</code> 中，配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/willin/hexo-wordcount</span></span><br><span class="line"><span class="attr">post_wordcount:</span></span><br><span class="line">  <span class="attr">item_text:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">wordcount:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">min2read:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>新版本，在根目录下安装 <code>hexo-word-counter</code> ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-word-counter</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br></pre></td></tr></table></figure><p>根目录配置文件 <code>\_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字数统计</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># 开启当前页面字数统计</span></span><br><span class="line">  <span class="attr">symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 开启当前页面估计阅读时间</span></span><br><span class="line">  <span class="attr">time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 页脚添加全站字数统计</span></span><br><span class="line">  <span class="attr">total_symbols:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 页脚添加全站估计阅读时间</span></span><br><span class="line">  <span class="attr">total_time:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 平均字长</span></span><br><span class="line">  <span class="attr">awl:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># 每分钟的平均字数</span></span><br><span class="line">  <span class="attr">wpm:</span> <span class="number">275</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>\themes\next\_config.yml</code> 中：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Post wordcount display settings</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/next-theme/hexo-word-counter</span></span><br><span class="line"><span class="attr">symbols_count_time:</span></span><br><span class="line">  <span class="comment"># 是否在同一行</span></span><br><span class="line">  <span class="attr">separated_meta:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 是否在页脚显式</span></span><br><span class="line">  <span class="attr">item_text_total:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="4-2-增加搜索功能"><a href="#4-2-增加搜索功能" class="headerlink" title="4.2 增加搜索功能"></a>4.2 增加搜索功能</h3><p>安装 <code>hexo-generator-searchdb</code> ，在站点的根目录下执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-generator-searchdb --save</span></span><br></pre></td></tr></table></figure><p>修改主题配置文件 <code>blog/themes/next/_config.yml</code> ，找到 <code>local_search</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Local search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/flashlab/hexo-generator-search</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># if auto, trigger search by changing input</span></span><br><span class="line">  <span class="comment"># if manual, trigger search by pressing enter key or search button</span></span><br><span class="line">  <span class="attr">trigger:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment"># show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="attr">top_n_per_article:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="4-3-夜晚模式"><a href="#4-3-夜晚模式" class="headerlink" title="4.3 夜晚模式"></a>4.3 夜晚模式</h3><p>安装 <code>hexo-next-darkmode</code> 插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-next-darkmode --save</span></span><br></pre></td></tr></table></figure><p>在主题配置文件 <code>\themes\next\_config.yml</code> 里添加以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Darkmode JS</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/rqh656418510/hexo-next-darkmode, https://github.com/sandoche/Darkmode.js</span></span><br><span class="line"><span class="attr">darkmode_js:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bottom:</span> <span class="string">&#x27;64px&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">right:</span> <span class="string">&#x27;unset&#x27;</span> <span class="comment"># default: &#x27;32px&#x27;</span></span><br><span class="line">  <span class="attr">left:</span> <span class="string">&#x27;32px&#x27;</span> <span class="comment"># default: &#x27;unset&#x27;</span></span><br><span class="line">  <span class="attr">time:</span> <span class="string">&#x27;0.5s&#x27;</span> <span class="comment"># default: &#x27;0.3s&#x27;</span></span><br><span class="line">  <span class="attr">mixColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">backgroundColor:</span> <span class="string">&#x27;transparent&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorDark:</span> <span class="string">&#x27;#100f2c&#x27;</span> <span class="comment"># default: &#x27;#100f2c&#x27;</span></span><br><span class="line">  <span class="attr">buttonColorLight:</span> <span class="string">&#x27;#fff&#x27;</span> <span class="comment"># default: &#x27;#fff&#x27;</span></span><br><span class="line">  <span class="attr">isActivated:</span> <span class="literal">false</span> <span class="comment"># default false</span></span><br><span class="line">  <span class="attr">saveInCookies:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">&#x27;🌓&#x27;</span> <span class="comment"># default: &#x27;&#x27;</span></span><br><span class="line">  <span class="attr">autoMatchOsTheme:</span> <span class="literal">true</span> <span class="comment"># default: true</span></span><br><span class="line">  <span class="attr">libUrl:</span> <span class="comment"># Set custom library cdn url for Darkmode.js</span></span><br></pre></td></tr></table></figure><ul><li><code>isActivated: true</code>：默认激活暗黑 / 夜间模式，请始终与 <code>saveInCookies: false</code>、<code>autoMatchOsTheme: false</code> 一起使用</li></ul><p>确保 Next 原生的 <code>darkmode</code> 选项设置为 <code>false</code>，在主题配置文件 <code>\themes\next\_config.yml</code> 中更改以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">darkmode:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>夜晚模式激活后，<code>hexo-next-darkmode</code> 插件会将 <code>darkmode--activated</code> CSS 类添加到 <code>body</code> 标签，可以利用它覆盖插件默认自带的 CSS 样式（如下所示）；这样就可以实现暗黑模式 CSS 样式的高度自定义，包括代码块颜色自定义切换等。更多配置内容介绍可以参考<a href="https://github.com/rqh656418510/hexo-next-darkmode/blob/main/README_CN.md">官方文档</a>，实现原理分析可以看<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90">这里</a>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.darkmode--activated</span> &#123;</span><br><span class="line">  --<span class="selector-tag">body</span>-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="attribute">content</span>-bg-<span class="attribute">color</span>: <span class="number">#333</span>;</span><br><span class="line">  --card-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --text-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --<span class="selector-tag">blockquote</span>-<span class="attribute">color</span>: <span class="number">#bbb</span>;</span><br><span class="line">  --link-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --link-hover-<span class="attribute">color</span>: <span class="number">#eee</span>;</span><br><span class="line">  --brand-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --brand-hover-<span class="attribute">color</span>: <span class="number">#ddd</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-odd-bg-<span class="attribute">color</span>: <span class="number">#282828</span>;</span><br><span class="line">  --<span class="selector-tag">table</span>-row-hover-bg-<span class="attribute">color</span>: <span class="number">#363636</span>;</span><br><span class="line">  --<span class="selector-tag">menu</span>-item-bg-<span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-bg: <span class="number">#222</span>;</span><br><span class="line">  --btn-default-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-<span class="attribute">border-color</span>: <span class="number">#555</span>;</span><br><span class="line">  --btn-default-hover-bg: <span class="number">#666</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">color</span>: <span class="number">#ccc</span>;</span><br><span class="line">  --btn-default-hover-<span class="attribute">border-color</span>: <span class="number">#666</span>;</span><br><span class="line">  --highlight-<span class="attribute">background</span>: <span class="number">#282b2e</span>;</span><br><span class="line">  --highlight-foreground: <span class="number">#a9b7c6</span>;</span><br><span class="line">  --highlight-gutter-<span class="attribute">background</span>: <span class="number">#34393d</span>;</span><br><span class="line">  --highlight-gutter-foreground: <span class="number">#9ca9b6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.75</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">img</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.darkmode--activated</span> <span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#69dbdc</span>;</span><br><span class="line">  <span class="attribute">background</span>: transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hexo 重新构建生成静态文件后，点击页面上的按钮即可切换暗黑模式，最终演示效果可以看<a href="https://www.techgrow.cn/posts/abf4aee1.html#%E6%9C%80%E7%BB%88%E6%BC%94%E7%A4%BA%E6%95%88%E6%9E%9C">这里</a>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo clean</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo g -d</span></span><br></pre></td></tr></table></figure><h3 id="4-4-豆瓣阅读-电影-游戏"><a href="#4-4-豆瓣阅读-电影-游戏" class="headerlink" title="4.4 豆瓣阅读 / 电影 / 游戏"></a>4.4 豆瓣阅读 / 电影 / 游戏</h3><p>为站点添加豆瓣阅读 / 电影 / 游戏页面，在根目录下执行以下命令安装相关依赖：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install hexo-douban --save</span></span><br></pre></td></tr></table></figure><p>在站点配置文件 <code>/_config.yml</code> 中添加以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">douban:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="comment"># 个人豆瓣ID</span></span><br><span class="line">  <span class="attr">builtin:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">book:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my book title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my book quote&quot;</span></span><br><span class="line">  <span class="attr">movie:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my movie title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my movie quote&quot;</span></span><br><span class="line">  <span class="attr">game:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">&quot;This is my game title&quot;</span></span><br><span class="line">    <span class="attr">quote:</span> <span class="string">&quot;This is my game quote&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure><ul><li>user: 填写豆瓣 ID。登陆豆瓣后点击<strong>个人主页</strong>，此时 url 中最后一段即是用户 ID，一般情况下会是一段数字，如果设置了个人域名的话，则个人域名即为 ID。</li><li>builtin: 是否将生成页面的功能嵌入 <code>hexo s</code> 和 <code>hexo g</code> 中。</li><li>timeout: 爬取数据的超时时间。</li></ul><p>如果只想生成某一个页面（比如只生成读书页面），把其他的配置项注释掉即可。</p><p>在主题配置文件 <code>\themes\next\_config.yml</code> 中新增菜单入口：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: / || home</span><br><span class="line">    tags: /tags/ || tags</span><br><span class="line">    categories: /categories/ || th</span><br><span class="line">    archives: /archives/ || tasks</span><br><span class="line"><span class="addition">+   books: /books/ || book</span></span><br><span class="line"><span class="addition">+   movies: /movies/ || video-camera</span></span><br><span class="line"><span class="addition">+   games: /games/ || gamepad</span></span><br></pre></td></tr></table></figure><p>在语言包 <code>themes\next\language\zh_CN.yml</code> 中新增菜单中文：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: 首页</span><br><span class="line">    archives: 归档</span><br><span class="line">    categories: 分类</span><br><span class="line">    tags: 标签</span><br><span class="line"><span class="addition">+   movies: 电影</span></span><br><span class="line"><span class="addition">+   books: 读书</span></span><br><span class="line"><span class="addition">+   games: 游戏</span></span><br></pre></td></tr></table></figure><p>然后在根目录下执行以下命令生成豆瓣阅读 / 电影 / 游戏页面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo douban</span></span><br></pre></td></tr></table></figure><p>可选参数:</p><ul><li>-b | –books: 只生成豆瓣读书页面</li><li>-m | –movies: 只生成豆瓣电影页面</li><li>-g | –games: 只生成豆瓣游戏页面</li></ul><p>执行命令后，插件会根据用户提供的 ID 爬取豆瓣中的数据信息并在 <code>public</code> 目录下生成对应的页面，当服务器启动或部署后会将页面显示在对应的菜单路由下。</p><p>如果在站点配置中设置了 <code>douban.builtin: false</code>，则每次豆瓣数据变动后需要手动执行一次 <code>hexo douban</code> 来刷新页面数据。如果设置了 <code>douban.builtin: true</code>，则每次执行 <code>hexo s</code> 和 <code>hexo g</code> 的时候将会自动同时执行 <code>hexo douban</code> 命令，但这样可能会增加打包编译的时间。建议如果豆瓣数据变动不频繁的情况下该项设为 <code>false</code> 即可。</p><p>普遍会用 <code>hexo d</code> 来作为 <code>hexo deploy</code> 命令的简化，但是当安装了 <code>hexo douban</code> 之后， <code>hexo d</code> 就会有歧义而无法执行，因为 <code>hexo douban</code> 跟 <code>hexo deploy</code> 的 Alias 都是 <code>hexo d</code>。</p><p>以下问题需要重装Node到12.18.x的版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  0 books have been loaded in 1223 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 movies have been loaded in 1743 ms, because you are offline or your network is bad</span><br><span class="line">INFO  0 games have been loaded in 1133 ms, because you are offline or your network is bad</span><br></pre></td></tr></table></figure><h3 id="4-5-留言板"><a href="#4-5-留言板" class="headerlink" title="4.5 留言板"></a>4.5 留言板</h3><p>Next 支持多款评论系统：</p><ul><li><a href="https://disqus.com/">Disqus</a>：欧美 UI 风格，支持 Tweet、Facebook 等国外社交软件的三方登陆和一键分享； <a href="https://blog.disqus.com/disqus-welcomes-the-spruce">Demo</a>；</li><li><a href="https://github.com/imsun/gitment">gitment</a>：必须用 github 账号登陆才能评论，支持 Markdown 语法，与 github issues 页面风格一致；<a href="https://imsun.github.io/gitment/">Demo</a>；</li><li><a href="https://valine.js.org/">Valine</a>：支持匿名评论，支持 Markdown 语法，界面简洁美观；</li><li><a href="http://changyan.kuaizhan.com/">畅言</a>：国产评论系统，可区分热评和最新评论，论坛贴吧风；</li><li><a href="https://www.livere.com/">来必力</a>：支持插入图片和 GIF，支持国内外多种社交媒体的三方登陆 <a href="https://www.livere.com/city-demo">Demo</a>；</li></ul><h4 id="（1）utterances"><a href="#（1）utterances" class="headerlink" title="（1）utterances"></a>（1）utterances</h4><blockquote><p>为什么选用utterances？</p><ol><li>没有广告</li><li>不会追踪用户隐私</li><li>搭建于GitHub，不需要再注册账号才能使用</li></ol></blockquote><p><a href="https://github.com/apps/utterances" title="title">安装utterances</a>-&gt;【Install】-&gt;【Only Select Repositories】选择博客所在repo-&gt;【填写owner/repo】-&gt;【设置issue标题如何开】-&gt;【填写Issue Label】-&gt;【选择主题样式】-&gt;【复制生成的代码】。</p><p>首先在博客对应的Repository中增加要使用的label：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010186.png"></p><p>如图所示，新增了一个💬Comments：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010187.png"></p><p>修改 <code>blog\themes\next\layout\_third-party\comments\utterances.swig</code> (请注意此处有漏掉label的配置，后续才发现，可以参考下文中正确内容)：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>修改 <code>blog\themes\next\layout\_partials\comments.swig</code> ：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% elseif theme.valine.appid and theme.valine.appkey %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% elseif theme.utterances.enable %&#125;</span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comments&quot;</span> <span class="attr">id</span>=<span class="string">&quot;comments&quot;</span>&gt;</span></span><br><span class="line">     &#123;% include &#x27;../_third-party/comments/utterances.swig&#x27; %&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>然后在主题的配置文件中，增加如下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加留言板功能</span></span><br><span class="line"><span class="comment"># Demo: https://utteranc.es/  http://trumandu.github.io/about/</span></span><br><span class="line">  <span class="comment"># pathname, url, title, og:title [ISSUE NUMBER] or [SPECIFIC TERM]</span></span><br><span class="line">  <span class="comment"># theme: github-light,github-dark,github-dark-orange</span></span><br><span class="line">  <span class="comment"># The label must exist in your repo</span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">LAILAIWA/LAILAIWA.github.io</span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">💬Comments</span> </span><br></pre></td></tr></table></figure><p>更新博客，并任意打开一篇文章：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010188.png"></p><p>需要授权GitHub账户信息才能正常使用：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010189.png"></p><p>尝试评论一次，测试功能是否正常：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010190.png"></p><p>回到GitHub-issues，可以发现多了刚刚添加的回复，但很明显没有使用我们创建的label：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010191.png"></p><p>检查以上步骤，发现 <code>utterances.swig</code> 粘贴copy的代码时，当时页面未填写label，补充完整：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.utterances.enable %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://utteranc.es/client.js&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">repo</span>=<span class="string">&quot;LAILAIWA/LAILAIWA.github.io&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">issue-term</span>=<span class="string">&quot;pathname&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">label</span>=<span class="string">&quot;💬Comments&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">theme</span>=<span class="string">&quot;github-light&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>更新博客，并再次评论，然后确认是否使用正确的label，结果如下，修改成功：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200201/202002010192.png"></p><p>2019年8月1日更新的NexT 7.3.0 版本集成了utterances评论</p><p>使用命令安装：<code>npm install theme-next/hexo-next-utteranc</code></p><p>配置部分和之前类似，<a href="http://chaih.com/2021/02/04/utterances-comment-for-Hexo-theme-nexT/">使用Hexo theme nexT并加入utterances comment</a>。</p><h4 id="（2）gitalk"><a href="#（2）gitalk" class="headerlink" title="（2）gitalk"></a>（2）gitalk</h4><p><a href="https://www.cnblogs.com/qisi007/p/13731562.html">hexo博客添加gitalk评论系统</a></p><h3 id="4-6-文章评分"><a href="#4-6-文章评分" class="headerlink" title="4.6 文章评分"></a>4.6 文章评分</h3><p><a href="https://widgetpack.com/">widgetpack</a> 是一款轻量级的插件，提供四项具体的功能：</p><ul><li>Comments: 评论系统，类似于留言板</li><li>Reviews: 评价系统，类似于商品评价</li><li>Rating: 星级评分系统</li><li>Google Reviews: 关联展示 Google Rating</li></ul><p>Next 主题中已经集成了 widgetpack 的星级评分系统，用户无须再安装或引入插件脚本，只需在 widgetpack 中注册账号并修改主题配置即可，应用效果如下：</p><p><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rating.png" alt="文章评分组件"></p><p>在 <a href="https://widgetpack.com/">widgetpack</a> 中注册账号，根据引导填写应用名称和域名创建应用，创建后可在页面左上角看到应用 id。</p><p>在主题配置文件 <code>themes\next_config.yml</code> 中开启评分功能，填写应用 id，并设置评分颜色：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Star rating support to each article.</span></span><br><span class="line"><span class="comment"># To get your ID visit https://widgetpack.com</span></span><br><span class="line"><span class="attr">rating:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">id:</span> <span class="comment">#&lt;app_id&gt;</span></span><br><span class="line">  <span class="attr">color:</span> <span class="string">fadb14</span></span><br></pre></td></tr></table></figure><p>此时刷新浏览器即可在文章末尾看到空的评分栏了。点击评分发现需要以社交账号登陆，而这些社交账号基本都是 facebook、twitter 等墙外的社交软件，限制了评分系统可用性，我们可以在 widgetpack 控制台中修改评分认证机制。</p><p>在控制台中点击左上角展开菜单，在 <strong>Rating</strong> -&gt; <strong>Setting</strong> 中将 Vote via 选项改为 Device(cookie) 以开启匿名评分，该选项将基于设备认证访问者身份：</p><p><a href="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png"><img src="http://yearito-1256884783.image.myqcloud.com/hexo-advanced-settings/rate-vote-via.png" alt="开启匿名评分"></a></p><p>用户还可以在该页面设定 star 数量和大小。修改后记得勾选右下角的 SAVE SETTING 才会生效。</p><p>在实际使用过程中，并非每篇文章都需要开启评分。此时可在 Front-Matter 中设定变量 rating 用于控制是否开启评分。修改文章布局模板中相关代码，使得只有当主题配置文件 <code>themes\next\layout_macro\post.swig</code> 中 <code>rating.enable</code> 字段和 <code>page.rating</code> 字段同时为 <code>true</code> 才会插入评分组件：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  &#123;% if not is_index %&#125;</span><br><span class="line">-  &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">+  &#123;% if (theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> and post<span class="selector-class">.rating</span>) or (theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.vkontakte_api</span><span class="selector-class">.like</span>) or (theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.facebook_sdk</span><span class="selector-class">.like_button</span>) or (theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.enable</span> and theme<span class="selector-class">.needmoreshare2</span><span class="selector-class">.postbottom</span><span class="selector-class">.enable</span>) or (theme<span class="selector-class">.baidushare</span> and theme<span class="selector-class">.baidushare</span><span class="selector-class">.type</span> === &quot;<span class="selector-tag">button</span>&quot; )%&#125;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;post-widgets&quot;&gt;</span><br><span class="line">    &#123;% if theme<span class="selector-class">.rating</span><span class="selector-class">.enable</span> %&#125;</span><br><span class="line">      &lt;<span class="selector-tag">div</span> class=&quot;wp_rating&quot;&gt;</span><br><span class="line">        &lt;<span class="selector-tag">div</span> id=&quot;wpac-rating&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">      &lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>为了批量为每篇新文章设定该变量并赋默认值，可以修改草稿模板内容 <code>scaffolds\draft.md</code> ，这样以来每篇草稿发布后都会默认开启评分：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  title: &#123;&#123; title &#125;&#125;</span><br><span class="line">  tags:</span><br><span class="line">  categories:</span><br><span class="line"><span class="bullet">+</span> rating: true</span><br></pre></td></tr></table></figure><p>站点上线后，可以在控制台菜单的 <strong>Site</strong> -&gt; <strong>Setting</strong> 中勾选 Private，使得组件只对应用内指定的域名上生效，这样以来即时别人错填了你的 id 也不会将评分数据误提交到你的应用中了。</p><p>widgetpack 与前文提到的 hotjar 在评价反馈功能上的侧重点不一样，widgetpack 更侧重于对文章的评分，而 hotjar 侧重于对整个页面的评分，并提供了文字和截图反馈的渠道。</p><h3 id="4-7-博文加密"><a href="#4-7-博文加密" class="headerlink" title="4.7 博文加密"></a>4.7 博文加密</h3><p>首先安装插件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-blog-encrypt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span> </span><br><span class="line">yarn add hexo-blog-encrypt</span><br></pre></td></tr></table></figure><p>MD文件信息头中添加password：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password: &lt;密码&gt; # 为空表示无密码</span><br></pre></td></tr></table></figure><p>标准内容如下：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line">tags:</span><br><span class="line"><span class="bullet">-</span> 作为日记加密</span><br><span class="line">date: 2016-03-30 21:12:21</span><br><span class="line">password: mikemessi</span><br><span class="line">abstract: 有东西被加密了, 请输入密码查看.</span><br><span class="line">message: 您好, 这里需要密码.</span><br><span class="line">wrong<span class="emphasis">_pass_</span>message: 抱歉, 这个密码看着不太对, 请再试试.</span><br><span class="line"><span class="section">wrong<span class="emphasis">_hash_</span>message: 抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><p>可以直接在配置文件中统一设置 <code>blog/_config.yml</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Security</span></span><br><span class="line"><span class="attr">encrypt:</span> <span class="comment"># hexo-blog-encrypt</span></span><br><span class="line">  <span class="attr">abstract:</span> <span class="string">这篇文章被加密了,</span> <span class="string">请输入密码查看.</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">您好,</span> <span class="string">这里需要密码.</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">密码A</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tagName</span>, <span class="attr">password:</span> <span class="string">密码B</span>&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;div</span> <span class="string">id=&quot;hexo-blog-encrypt&quot;</span> <span class="string">data-wpm=&quot;&#123;&#123;hbeWrongPassMessage&#125;&#125;&quot;</span> <span class="string">data-whm=&quot;&#123;&#123;hbeWrongHashMessage&#125;&#125;&quot;&gt;&lt;div</span> <span class="string">class=&quot;hbe-input-container&quot;&gt;&lt;input</span> <span class="string">type=&quot;password&quot;</span> <span class="string">id=&quot;hbePass&quot;</span> <span class="string">placeholder=&quot;&#123;&#123;hbeMessage&#125;&#125;&quot;</span> <span class="string">/&gt;&lt;label&gt;&#123;&#123;hbeMessage&#125;&#125;&lt;/label&gt;&lt;div</span> <span class="string">class=&quot;bottom-line&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;script</span> <span class="string">id=&quot;hbeData&quot;</span> <span class="string">type=&quot;hbeData&quot;</span> <span class="string">data-hmacdigest=&quot;&#123;&#123;hbeHmacDigest&#125;&#125;&quot;&gt;&#123;&#123;hbeEncryptedData&#125;&#125;&lt;/script&gt;&lt;/div&gt;</span></span><br><span class="line">  <span class="attr">wrong_pass_message:</span> <span class="string">抱歉,</span> <span class="string">这个密码看着不太对,</span> <span class="string">请再试试.</span></span><br><span class="line">  <span class="attr">wrong_hash_message:</span> <span class="string">抱歉,</span> <span class="string">这个文章不能被校验,</span> <span class="string">不过您还是能看看解密后的内容.</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">default_abstract:</span> <span class="string">此文章已被加密，需要输入密码访问。</span>  <span class="string">//首页文章列表中加密文章的默认描述文案</span></span><br><span class="line">  <span class="attr">default_message:</span> <span class="string">请输入密码以阅读这篇私密文章。</span>  <span class="string">//文章详情页的密码输入框上的默认描述文案</span></span><br></pre></td></tr></table></figure><p>然后在文章 Front-Matter 中添加 <code>password</code> 字段用于设置文章访问密码。重启服务器，这个时候可能需要经历较长一段时间的加密过程，请耐心等待，加密完成后刷新页面将会显示密码输入框，输入密码后才能继续访问文章内容。</p><p>该功能只会加密文章正文，其他内容如打赏、版权信息、标签等则不会被加密隐藏，这样看起来有点奇怪，所以建议加密文章隐藏掉打赏和版权信息内容。</p><p>密码输入错误时将会显示浏览器默认告警弹窗，可以使用 <a href="https://sweetalert.js.org/">sweetalert</a> 来美化错误提示。在主题自定义布局文件 <code>themes\next\layout_custom\custom.swig</code> 中添加如下代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/sweetalert/dist/sweetalert.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果 <code>custom.swig</code> 文件不存在，需要手动新建并在布局页面 <code>themes\next\layout_layout.swig</code> 中 body 末尾引入：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      ...</span><br><span class="line">      &#123;% include &#x27;_third-party/exturl.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/bookmark.swig&#x27; %&#125;</span><br><span class="line">      &#123;% include &#x27;_third-party/copy-code.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+     &#123;% include &#x27;_custom/custom.swig&#x27; %&#125;</span></span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在 <code>node_modules</code> 依赖库 <code>node_modules\hexo-blog-encrypt\lib\blog.encrypt.js</code> 中修改 <code>hexo-blog-encrypt</code> 源码：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line"><span class="deletion">-   alert(decryptionError);</span></span><br><span class="line"><span class="addition">+   swal(&#123;</span></span><br><span class="line"><span class="addition">+     text: &quot;密码错误!&quot;,</span></span><br><span class="line"><span class="addition">+     icon: &quot;error&quot;,</span></span><br><span class="line"><span class="addition">+     className: &quot;password-error&quot;,</span></span><br><span class="line"><span class="addition">+     timer: 1000,</span></span><br><span class="line"><span class="addition">+     button: false</span></span><br><span class="line"><span class="addition">+   &#125;);</span></span><br><span class="line">    console.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>在自定义样式文件 <code>themes/next/source/css/_custom/custom.styl</code> 中添加如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//密码错误sweetalert弹框样式修改</span><br><span class="line"><span class="selector-class">.swal-overlay</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.password-error</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">4px</span> <span class="number">12px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.15</span>);</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于是在 <code>node_module</code> 中修改的依赖文件，一旦更新或者重装依赖都会覆盖修改，需要重新修改一遍</p><h3 id="4-8-添加-Google-Analytics-监控-GitHub-Pages-访问流量"><a href="#4-8-添加-Google-Analytics-监控-GitHub-Pages-访问流量" class="headerlink" title="4.8 添加 Google Analytics 监控 GitHub Pages 访问流量"></a>4.8 添加 Google Analytics 监控 GitHub Pages 访问流量</h3><p>在谷歌的<a href="https://analytics.google.com/">Google Analytics</a>中注册个人账户，配置网站信息获得衡量ID（或者使用百度统计）：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20201201/202012280109.png"></p><p>在博客目录主题下的 <code>_config.yml</code> 中配置（注意非根目录）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google Analytics</span></span><br><span class="line"><span class="attr">google_analytics:</span></span><br><span class="line">  <span class="attr">tracking_id:</span> <span class="string">XXX</span></span><br><span class="line">  <span class="attr">localhost_ignored:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">baidu_analytics:</span> <span class="string">XXX（&quot;https://hm.baidu.com/hm.js?____________________&quot;）</span></span><br></pre></td></tr></table></figure><p>修改 <code>\themes\next\layout\_third-party\analytics\google-analytics.swig</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> theme.google_analytics.tracking_id %&#125;</span><br><span class="line">  &lt;script <span class="keyword">async</span> src=<span class="string">&quot;https://www.googletagmanager.com/gtag/js?id=&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">var</span> host = <span class="built_in">window</span>.location.hostname;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="keyword">if</span> (host !== <span class="string">&quot;localhost&quot;</span> || !&#123;&#123;theme.google_analytics.localhost_ignored&#125;&#125;) &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="built_in">window</span>.dataLayer = <span class="built_in">window</span>.dataLayer || [];</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      <span class="function"><span class="keyword">function</span> <span class="title">gtag</span>(<span class="params"></span>)</span>&#123;dataLayer.push(<span class="built_in">arguments</span>);&#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;js&#x27;</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span></span></span><br><span class="line"><span class="javascript"><span class="xml">      gtag(<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;&#123;&#123; theme.google_analytics.tracking_id &#125;&#125;&#x27;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h3 id="4-9-音乐播放器"><a href="#4-9-音乐播放器" class="headerlink" title="4.9 音乐播放器"></a>4.9 音乐播放器</h3><p>音乐播放器使用：<a href="https://github.com/grzhan/hexo-tag-aplayer">hexo-tag-aplayer</a></p><p>内容来自官方文档：<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md">MetingJS</a></p><h4 id="（1）APlayer"><a href="#（1）APlayer" class="headerlink" title="（1）APlayer"></a>（1）APlayer</h4><p>安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-tag-aplayer</span><br></pre></td></tr></table></figure><p>依赖版本：</p><ul><li>APlayer.js &gt; 1.8.0</li><li>Meting.js &gt; 1.1.1</li></ul><p>Markdown文档中使用：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer title author url [picture<span class="emphasis">_url, narrow, autoplay, width:xxx, lrc:xxx] %&#125;</span></span><br></pre></td></tr></table></figure><p>参数：</p><ul><li><code>title</code> : 曲目标题</li><li><code>author</code>: 曲目作者</li><li><code>url</code>: 音乐文件 URL 地址</li><li><code>picture_url</code>: (可选) 音乐对应的图片地址</li><li><code>narrow</code>: （可选）播放器袖珍风格</li><li><code>autoplay</code>: (可选) 自动播放，移动端浏览器暂时不支持此功能</li><li><code>width:xxx</code>: (可选) 播放器宽度 (默认: 100%)</li><li><code>lrc:xxx</code>: （可选）歌词文件 URL 地址</li></ul><p>当开启 Hexo 的 <a href="https://hexo.io/zh-cn/docs/asset-folders.html#%E6%96%87%E7%AB%A0%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%A4%B9">文章资源文件夹</a> 功能时，可以将图片、音乐文件、歌词文件放入与文章对应的资源文件夹中，然后直接引用：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer &quot;Caffeine&quot; &quot;Jeff Williams&quot; &quot;caffeine.mp3&quot; &quot;picture.jpg&quot; &quot;lrc:caffeine.txt&quot; %&#125;</span><br></pre></td></tr></table></figure><p>除了使用标签 <code>lrc</code> 选项来设定歌词，你也可以直接使用 <code>aplayerlrc</code> 标签来直接插入歌词文本在博客中：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlrc &quot;title&quot; &quot;author&quot; &quot;url&quot; &quot;autoplay&quot; %&#125;</span><br><span class="line">[00:00.00]lrc here</span><br><span class="line">&#123;% endaplayerlrc %&#125;</span><br></pre></td></tr></table></figure><p>播放列表：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlist %&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;narrow&quot;</span>: <span class="literal">false</span>,                          <span class="comment">// （可选）播放器袖珍风格</span></span><br><span class="line">    <span class="attr">&quot;autoplay&quot;</span>: <span class="literal">true</span>,                         <span class="comment">// （可选) 自动播放，移动端浏览器暂时不支持此功能</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span>: <span class="string">&quot;random&quot;</span>,                         <span class="comment">// （可选）曲目循环类型，有 &#x27;random&#x27;（随机播放）, &#x27;single&#x27; (单曲播放), &#x27;circulation&#x27; (循环播放), &#x27;order&#x27; (列表播放)， 默认：&#x27;circulation&#x27; </span></span><br><span class="line">    <span class="attr">&quot;showlrc&quot;</span>: <span class="number">3</span>,                             <span class="comment">// （可选）歌词显示配置项，可选项有：1,2,3</span></span><br><span class="line">    <span class="attr">&quot;mutex&quot;</span>: <span class="literal">true</span>,                            <span class="comment">// （可选）该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停</span></span><br><span class="line">    <span class="attr">&quot;theme&quot;</span>: <span class="string">&quot;#e6d0b2&quot;</span>,                      <span class="comment">// （可选）播放器风格色彩设置，默认：#b7daff</span></span><br><span class="line">    <span class="attr">&quot;preload&quot;</span>: <span class="string">&quot;metadata&quot;</span>,                    <span class="comment">// （可选）音乐文件预载入模式，可选项： &#x27;none&#x27; &#x27;metadata&#x27; &#x27;auto&#x27;, 默认: &#x27;auto&#x27;</span></span><br><span class="line">    <span class="attr">&quot;listmaxheight&quot;</span>: <span class="string">&quot;513px&quot;</span>,                 <span class="comment">// (可选) 该播放列表的最大长度</span></span><br><span class="line">    <span class="attr">&quot;music&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;CoCo&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Jeff Williams&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;caffeine.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;caffeine.jpeg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;lrc&quot;</span>: <span class="string">&quot;caffeine.txt&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;アイロニ&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;鹿乃&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;irony.mp3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pic&quot;</span>: <span class="string">&quot;irony.jpg&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endaplayerlist %&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）MeingJS-支持-3-0-新功能"><a href="#（2）MeingJS-支持-3-0-新功能" class="headerlink" title="（2）MeingJS 支持 (3.0 新功能)"></a>（2）MeingJS 支持 (3.0 新功能)</h4><p><a href="https://github.com/metowolf/MetingJS">MetingJS</a> 是基于<a href="https://github.com/metowolf/Meting">Meting API</a> 的 APlayer 衍生播放器，引入 MetingJS 后，播放器将支持对于 QQ音乐、网易云音乐、虾米、酷狗、百度等平台的音乐播放。</p><p>如果想在本插件中使用 MetingJS，请在 Hexo 配置文件 <code>_config.yml</code> 中设置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>接着就可以通过 <code>&#123;% meting ...%&#125;</code> 在文章中使用 MetingJS 播放器了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 简单示例 (id, server, type)  --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- 进阶示例 --&gt;</span><br><span class="line">&#123;% meting &quot;<span class="number">60198</span>&quot; &quot;netease&quot; &quot;playlist&quot; &quot;autoplay&quot; &quot;mutex:false<span class="string">&quot; &quot;</span>listmaxheight:<span class="number">340px</span><span class="string">&quot; &quot;</span>preload:none<span class="string">&quot; &quot;</span>theme:<span class="number">#ad7a86</span><span class="string">&quot;%&#125;</span></span><br></pre></td></tr></table></figure><p>有关 <code>&#123;% meting %&#125;</code> 的选项列表如下：</p><table><thead><tr><th>选项</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td><strong>必须值</strong></td><td>歌曲 id / 播放列表 id / 相册 id / 搜索关键字</td></tr><tr><td>server</td><td><strong>必须值</strong></td><td>音乐平台: <code>netease</code>, <code>tencent</code>, <code>kugou</code>, <code>xiami</code>, <code>baidu</code></td></tr><tr><td>type</td><td><strong>必须值</strong></td><td><code>song</code>, <code>playlist</code>, <code>album</code>, <code>search</code>, <code>artist</code></td></tr><tr><td>fixed</td><td><code>false</code></td><td>开启固定模式</td></tr><tr><td>mini</td><td><code>false</code></td><td>开启迷你模式</td></tr><tr><td>loop</td><td><code>all</code></td><td>列表循环模式：<code>all</code>, <code>one</code>,<code>none</code></td></tr><tr><td>order</td><td><code>list</code></td><td>列表播放模式： <code>list</code>, <code>random</code></td></tr><tr><td>volume</td><td>0.7</td><td>播放器音量</td></tr><tr><td>lrctype</td><td>0</td><td>歌词格式类型</td></tr><tr><td>listfolded</td><td><code>false</code></td><td>指定音乐播放列表是否折叠</td></tr><tr><td>storagename</td><td><code>metingjs</code></td><td>LocalStorage 中存储播放器设定的键名</td></tr><tr><td>autoplay</td><td><code>true</code></td><td>自动播放，移动端浏览器暂时不支持此功能</td></tr><tr><td>mutex</td><td><code>true</code></td><td>该选项开启时，如果同页面有其他 aplayer 播放，该播放器会暂停</td></tr><tr><td>listmaxheight</td><td><code>340px</code></td><td>播放列表的最大长度</td></tr><tr><td>preload</td><td><code>auto</code></td><td>音乐文件预载入模式，可选项： <code>none</code>, <code>metadata</code>, <code>auto</code></td></tr><tr><td>theme</td><td><code>#ad7a86</code></td><td>播放器风格色彩设置</td></tr></tbody></table><p>关于如何设置自建的 Meting API 服务器地址，以及其他 MetingJS 配置，请参考章节<a href="https://github.com/MoePlayer/hexo-tag-aplayer/blob/master/docs/README-zh_cn.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE30-%E6%96%B0%E5%8A%9F%E8%83%BD">自定义配置</a>。</p><p>若在 Hexo 中使用了 PJAX，可能需要自己手动清理 APlayer 全局实例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).on(<span class="string">&#x27;pjax:start&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.aplayers) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">window</span>.aplayers.length; i++) &#123;</span><br><span class="line">            <span class="built_in">window</span>.aplayers[i].destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">window</span>.aplayers = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="（3）自定义配置（3-0-新功能）"><a href="#（3）自定义配置（3-0-新功能）" class="headerlink" title="（3）自定义配置（3.0 新功能）"></a>（3）自定义配置（3.0 新功能）</h4><p>现在你可以在 Hexo 配置文件 <code>_config.yml</code> 中配置本插件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">script_dir:</span> <span class="string">some/place</span>                        <span class="comment"># Public 目录下脚本目录路径，默认: &#x27;assets/js&#x27;</span></span><br><span class="line">  <span class="attr">style_dir:</span> <span class="string">some/place</span>                         <span class="comment"># Public 目录下样式目录路径，默认: &#x27;assets/css&#x27;</span></span><br><span class="line">  <span class="attr">cdn:</span> <span class="string">http://xxx/aplayer.min.js</span>                <span class="comment"># 引用 APlayer.js 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">style_cdn:</span> <span class="string">http://xxx/aplayer.min.css</span>         <span class="comment"># 引用 APlayer.css 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span>                                  <span class="comment"># MetingJS 支持</span></span><br><span class="line">  <span class="attr">meting_api:</span> <span class="string">http://xxx/api.php</span>                <span class="comment"># 自定义 Meting API 地址</span></span><br><span class="line">  <span class="attr">meting_cdn:</span> <span class="string">http://xxx/Meing.min.js</span>           <span class="comment"># 引用 Meting.js 外部 CDN 地址 (默认不开启)</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">true</span>                            <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">externalLink:</span> <span class="string">http://xxx/aplayer.min.js</span>       <span class="comment"># 老版本参数，功能与参数 cdn 相同</span></span><br></pre></td></tr></table></figure><h4 id="（4）故障排除"><a href="#（4）故障排除" class="headerlink" title="（4）故障排除"></a>（4）故障排除</h4><h5 id="1-标签参数空格问题"><a href="#1-标签参数空格问题" class="headerlink" title="1. 标签参数空格问题"></a>1. 标签参数空格问题</h5><p>在 Hexo 标签中，用户可能无法直接在标签参数中<a href="https://github.com/hexojs/hexo/issues/1455">加入空格</a></p><p>如果遇到这类问题，请直接将参数用双引号括起来使用，如下所示：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="meta">%</span> aplayer <span class="string">&quot;Caffeine&quot;</span> <span class="string">&quot;Jeff Williams&quot;</span> <span class="string">&quot;caffeine.mp3&quot;</span> <span class="string">&quot;autoplay&quot;</span> <span class="string">&quot;width:70%&quot;</span> <span class="string">&quot;lrc:caffeine.txt&quot;</span> <span class="meta">%</span>&#125;</span><br></pre></td></tr></table></figure><h5 id="2-重复载入-Aplayer-js-资源脚本问题"><a href="#2-重复载入-Aplayer-js-资源脚本问题" class="headerlink" title="2. 重复载入 Aplayer.js 资源脚本问题"></a>2. 重复载入 Aplayer.js 资源脚本问题</h5><p>本插件通过 <code>after_render:html</code>过滤器 , 将 <code>APlayer.js</code> 和 <code>Meting.js</code> 插入到使用了本插件标签 的 HTML 文件中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/aplayer.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/meting.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是 <code>after_render:html</code> 在一些情形下可能无法被正常触发：</p><ul><li><a href="https://github.com/hexojs/hexo-inject/issues/1">Does not work with hexo-renderer-jade</a></li><li><code>after_render:html</code> 似乎在 Hexo 服务器模式默认配置中无法被调用 (<code>hexo server</code>), 遇到这种情况用户可能需要使用 <code>hexo-server</code> 的静态文件解析模式 ( <code>hexo server -s</code>) .</li></ul><p>如果在博客生成过程中，插件发现 <code>after_render:html</code> 没有被调用，那么插件将会通过 <code>after_post_render</code> 过滤器来植入脚本。但是使用 <code>after_post_render</code> 会有重复载入 <code>APlayer.js</code> 的情况（例如当一个页面中存在多篇博客时），以及一些非文章页面将无法使用本插件。</p><p>如果想完全解决这个问题，用户可能需要自己在主题文件中手动加入 <code>Aplayer.js</code> 与 <code>Meting.js</code>，同时关闭插件的自动脚本插入功能：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 音乐播放器</span></span><br><span class="line"><span class="attr">aplayer:</span></span><br><span class="line">  <span class="attr">meting:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 自动插入 Aplayer.js 与 Meting.js 资源脚本, 默认开启</span></span><br><span class="line">  <span class="attr">asset_inject:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="4-10-视频播放器"><a href="#4-10-视频播放器" class="headerlink" title="4.10 视频播放器"></a>4.10 视频播放器</h3><p><a href="https://github.com/NextMoe/hexo-tag-dplayer">hexo-tag-dplayer</a></p><h3 id="4-11-hexo-tag-mmedia"><a href="#4-11-hexo-tag-mmedia" class="headerlink" title="4.11 hexo-tag-mmedia"></a>4.11 hexo-tag-mmedia</h3><p>因APlayer自动引入JS依赖会导致一些全局文件出错，配置关闭后单个页面开启又很麻烦，所以寻找替代工具。</p><p><code>hexo-tag-mmedia</code> 集成了多种音视频播放器，可以参考 <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmedia文档</a> ，目前支持：</p><ul><li><input checked="" disabled="" type="checkbox"> Audio</li><li><input checked="" disabled="" type="checkbox"> Video</li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/APlayer">Aplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/metowolf/MetingJS">MetingJS</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/DIYgod/DPlayer">Dplayer</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.bilibili.com/">哔哩哔哩</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.ixigua.com/">西瓜视频</a></li><li><input disabled="" type="checkbox"> <a href="https://www.npmjs.com/package/hexo-tag-mmedia">YouTube</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://github.com/zhw2590582/ArtPlayer">ArtPlayer</a></li></ul><p>效果参考：<a href="http://demo.hexo-tag-mmedia.u2sb.com/">DEMO</a></p><p>安装插件：</p><ol><li><p>删除已安装的几个插件，以防冲突。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall hexo-tag-aplayer</span><br><span class="line">npm uninstall hexo-tag-dplayer</span><br><span class="line">npm uninstall hexo-tag-bilibili</span><br></pre></td></tr></table></figure></li><li><p>安装 <code>hexo-tag-mmedia</code> 。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-mmedia@1 --save</span><br></pre></td></tr></table></figure></li></ol><p>根目录配置文件 <code>/_config.yml</code> 添加：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># default 为默认配置，在 _config.yml 中填写就不需要在每个标签全部写入了，所有允许在 mmedia 标签上写入的配置项，均可在 default 下配置。default 下 contents 项，用于设置 JSON 类型的默认配置，注意要使用 yaml 格式写默认配置。</span></span><br><span class="line"><span class="attr">mmedia:</span></span><br><span class="line">  <span class="attr">audio:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">video:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">aplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js</span></span><br><span class="line">    <span class="attr">css:</span> <span class="string">https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">meting:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js</span></span><br><span class="line">    <span class="attr">api:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">  <span class="attr">dplayer:</span></span><br><span class="line">    <span class="attr">js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dplayer@1/dist/DPlayer.min.js</span></span><br><span class="line">    <span class="attr">hls_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js</span></span><br><span class="line">    <span class="attr">dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js</span></span><br><span class="line">    <span class="attr">shaka_dash_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.compiled.js</span></span><br><span class="line">    <span class="attr">flv_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js</span></span><br><span class="line">    <span class="attr">webtorrent_js:</span> <span class="string">https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">contents:</span></span><br><span class="line">  <span class="attr">bilibili:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">page:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">danmaku:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br><span class="line">  <span class="attr">xigua:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">autoplay:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">startTime:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">allowfullscreen:</span> <span class="string">allowfullscreen</span></span><br><span class="line">      <span class="attr">sandbox:</span> <span class="string">allow-top-navigation</span> <span class="string">allow-same-origin</span> <span class="string">allow-forms</span> <span class="string">allow-scripts</span> <span class="string">allow-popups</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">      <span class="attr">max_width:</span> <span class="string">850px</span></span><br><span class="line">      <span class="attr">margin:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure><h4 id="（1）MarkDown引入"><a href="#（1）MarkDown引入" class="headerlink" title="（1）MarkDown引入"></a>（1）MarkDown引入</h4><p>MarkDown 内可以使用两种标签作为插件，分别是 <code>mmedia</code> 和 <code>mmedias</code> ，使用方式为：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">或</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedias</span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><p>只使用 <code>args</code> 作为传参方式时，两种标签均可使用，当需要使用 <code>contents</code> 传参时，只能使用 <code>mmedias</code> 。后面第一个参数用于标记标签，可选（以详细文档为主，持续更新中）：<code>audio</code> <code>video</code> <code>meting</code> <code>aplayer</code> <code>dplayer</code> <code>bilibili</code> <code>xigua</code> 再后面的参数将直接作为 <code>args</code> 参数直接传入插件。</p><h4 id="（2）参数"><a href="#（2）参数" class="headerlink" title="（2）参数"></a>（2）参数</h4><p>传入标签的参数可以写入到三个位置，分别为： <code>_config.yml</code> ， <code>args</code> ， <code>contents</code> ，其中只有部分插件可使用 <code>contents</code> 配置，具体看详细文档，如有冲突项，覆盖规则为（后面的会被前面发覆盖）：<code>contents</code> -&gt; <code>args</code> -&gt; <code>_config.yml</code> -&gt; <code>插件默认</code></p><p>写入到 <code>args</code> 上的参数，有两种写法，分别是使用 <code>:</code> 和 <code>=</code> 分割，两种写法是等效的，在遇到第一个 <code>:</code> 或 <code>=</code> 时会自动分割，例如：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1hb4y1R7xf&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid=BV1hb4y1R7xf&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>两种写法是等效的。</p><p>如果遇到布尔类型的参数，可以简写：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;audio&quot; &quot;src:a.mp3&quot; &quot;autoplay:true&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>两种写法等效，但需要注意， <code>:</code> 或 <code>=</code> 一定不能省略。</p><h4 id="（3）JSON-传参"><a href="#（3）JSON-传参" class="headerlink" title="（3）JSON 传参"></a>（3）JSON 传参</h4><p>支持 JSON 方式传参，其中 JSON 为 <a href="https://json5.org/">JSON5</a> 规范。示例：</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedias</span> &quot;aplayer&quot; &quot;autoplay:false&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">&#123;</span></span><br><span class="line"><span class="xml">  &quot;volume&quot;: 0.8,</span></span><br><span class="line"><span class="xml">  &quot;audio&quot;:</span></span><br><span class="line"><span class="xml">  [</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist1&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url1.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover1.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc1.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#ebd0c2&quot;</span></span><br><span class="line"><span class="xml">    &#125;,</span></span><br><span class="line"><span class="xml">    &#123;</span></span><br><span class="line"><span class="xml">      &quot;name&quot;: &quot;name2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;artist&quot;: &quot;artist2&quot;,</span></span><br><span class="line"><span class="xml">      &quot;url&quot;: &quot;url2.mp3&quot;,</span></span><br><span class="line"><span class="xml">      &quot;cover&quot;: &quot;cover2.jpg&quot;,</span></span><br><span class="line"><span class="xml">      &quot;lrc&quot;: &quot;lrc2.lrc&quot;,</span></span><br><span class="line"><span class="xml">      &quot;theme&quot;: &quot;#46718b&quot;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  ]</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">endmmedias</span> %&#125;</span></span><br></pre></td></tr></table></figure><h4 id="（4）MetingJS"><a href="#（4）MetingJS" class="headerlink" title="（4）MetingJS"></a>（4）MetingJS</h4><p>规则：</p><ul><li>使用 <code>:</code> 或 <code>=</code> 分割。</li><li>所有 <code>&lt;meting-js&gt;</code> 标签的参数均可添加，只要能写进去就可以。</li></ul><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;auto=https://y.qq.com/n/yqq/song/001RGrEX3ija5X.html&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;meting&quot; &quot;server=netease&quot;&quot;type=playlist&quot;&quot;id=60198&quot; %&#125;</span></span><br></pre></td></tr></table></figure><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js metin="meting" server="netease" type="song" id=603259 ></meting-js><h4 id="（5）BiliBili"><a href="#（5）BiliBili" class="headerlink" title="（5）BiliBili"></a>（5）BiliBili</h4><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">mmedia</span> &quot;bilibili&quot; &quot;bvid:BV1br4y1P7ND&quot; &quot;danmaku:false&quot; %&#125;</span></span><br></pre></td></tr></table></figure><p>使用 <code>:</code> 或 <code>=</code> 分割，详细参数表：</p><table><thead><tr><th align="left">参数</th><th align="left">默认</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">aid</td><td align="left">-</td><td align="left">aid</td></tr><tr><td align="left">bvid</td><td align="left">-</td><td align="left">bvid，与 aid 同时出现时以 bvid 为准</td></tr><tr><td align="left">page</td><td align="left">1</td><td align="left">page</td></tr><tr><td align="left">danmaku</td><td align="left">true</td><td align="left">是否有弹幕 ture or false</td></tr><tr><td align="left">allowfullscreen</td><td align="left">allowfullscreen</td><td align="left">允许全屏， allowfullscreen 或 true 允许，其他选项不允许</td></tr><tr><td align="left">sandbox</td><td align="left">见 <a href="https://www.u2sb.com/pages/19d343/#%E9%85%8D%E7%BD%AE">配置</a></td><td align="left">iframe sandbox</td></tr><tr><td align="left">width</td><td align="left">100%</td><td align="left">css 属性</td></tr><tr><td align="left">max_width</td><td align="left">850px</td><td align="left">css 属性</td></tr><tr><td align="left">margin</td><td align="left">auto</td><td align="left">css 属性</td></tr></tbody></table><style>.bbplayer{width: 100%; max-width: 850px; margin: auto}</style><div class="bbplayer"><iframe class="bbplayer" id="mmedia-IEGPDWdEaqZBOLSG" src="https://player.bilibili.com/player.html?bvid=BV1AE411a7Nw&page=1&high_quality=1&danmaku=false" allowfullscreen="allowfullscreen" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"></iframe></div><script> document.getElementById("mmedia-IEGPDWdEaqZBOLSG").style.height=document.getElementById("mmedia-IEGPDWdEaqZBOLSG").scrollWidth*0.76+"px";    window.onresize = function(){      document.getElementById("mmedia-IEGPDWdEaqZBOLSG").style.height=document.getElementById("mmedia-IEGPDWdEaqZBOLSG").scrollWidth*0.76+"px";    }; </script><h3 id="4-12-添加看板娘（旧版本）"><a href="#4-12-添加看板娘（旧版本）" class="headerlink" title="4.12 添加看板娘（旧版本）"></a>4.12 添加看板娘（旧版本）</h3><ul><li>效果预览： <a href="https://huaji8.top/post/live2d-plugin-2.0/">https://huaji8.top/post/live2d-plugin-2.0/</a></li><li>源代码地址： <a href="https://github.com/EYHN/hexo-helper-live2d">https://github.com/EYHN/hexo-helper-live2d</a></li></ul><p>首先根目录打开命令工具，输入如下代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -save hexo-helper-live2d</span><br></pre></td></tr></table></figure><p>然后打开 <code>Hexo/blog/themes/next/layout</code> 的 <code>_layout.swig</code> ，将下面代码放到 <code>&lt;/body&gt;</code> 之前：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">live2d</span>() &#125;&#125;</span></span><br></pre></td></tr></table></figure><p>然后在根目录配置文件 <code>\_config.yml</code> 中添加参数：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态妹子</span></span><br><span class="line"><span class="attr">live2d:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scriptFrom:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">tagMode:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">model:</span></span><br><span class="line">    <span class="attr">use:</span> <span class="string">live2d-widget-model-shizuku</span></span><br><span class="line">  <span class="attr">display:</span></span><br><span class="line">    <span class="attr">position:</span> <span class="string">right</span></span><br><span class="line">    <span class="attr">width:</span> <span class="number">150</span></span><br><span class="line">    <span class="attr">height:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">mobile:</span></span><br><span class="line">    <span class="attr">show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果出现下面这个问题:</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20180728/201807280214.png"></p><p>首先删除hexo 下面的 <code>.deploy_git</code> 文件夹，然后执行下列代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></table></figure><p>新版本，有点卡卡的，而且没地方放了，不加了：<a href="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a></p><p>Edit <code>source/_data/head.njk</code> in site root directory and add the following content：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Then uncomment <code>head</code> under the <code>custom_file_path</code> section in theme config file.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">head:</span> <span class="string">source/_data/head.njk</span></span><br></pre></td></tr></table></figure><h2 id="五-异常记录"><a href="#五-异常记录" class="headerlink" title="五. 异常记录"></a>五. 异常记录</h2><h3 id="（1）unknown-block-tag-endif"><a href="#（1）unknown-block-tag-endif" class="headerlink" title="（1）unknown block tag: endif"></a>（1）unknown block tag: endif</h3><p>一次更新博客（hexo g）时，出现以下异常：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20200401/202004010101.png"></p><p>google了一下，看到有类似问题的是因为在’{‘和’%’之间多写了空格这种语法错误，所以花了一些时间去找项目中的swig文件，因为刚好这次更新也有增加一些博客功能，怀疑是不是修改swig文件时也写错了。(<a href="https://52heartz.top/articles/hexo-template-render-error/" title="title">Hexo 的 Template render error 错误</a> 和 <a href="https://github.com/hexojs/hexo/issues/3346" title="title">hexo 在markdown文档中出现<code>&#123;-% %-&#125;</code>语法会报错，提示“Template render error: (unknown path) </a>)</p><p>但很快便发现没有找到异常，所以思考了一下，既然代码文件中的endif没有问题，会不会是其他地方也写了endif，突然想到这次提交也更新了MD文件，记录我这次更新，其中也直接记录了 <code>\&#123;\% endif \%\&#125;</code>，所以就修改了相关描述。</p><p>重试了一下，问题解决。</p><hr><p>参考：</p><p>🔗 <a href="http://www.wuxubj.cn/2016/08/Hexo-nexT-build-personal-blog/" title="title">Hexo+nexT主题搭建个人博客</a></p><p>🔗 <a href="https://www.jianshu.com/p/5d5931289c09" title="title">nexT主题配置</a></p><p>🔗 <a href="http://theme-next.iissnan.com/theme-settings.html" title="title">nexT官方文档</a></p><p>🔗 <a href="https://segmentfault.com/a/1190000009544924" title="title">自定义配置nexT</a></p><p>🔗 <a href="https://fontawesome.com/icons?from=io" title="title">图标库</a></p><p>🔗 <a href="https://www.techgrow.cn/posts/d1f06120.html" title="title">Hexo 与 Next 版本升级教程</a></p><p>🔗 <a href="https://wangjiezhe.com/posts/2021-03-30-add-link-page/" title="title">Hexo NexT 添加友链页面</a></p><p>🔗 <a href="http://yearito.cn/posts/hexo-advanced-settings.html" title="title">Hexo 搭建个人博客系列：进阶设置篇</a></p><p>🔗 <a href="https://www.techgrow.cn/posts/abf4aee1.html" title="title">Hexo Next 8.x 主题添加可切换的暗黑模式</a></p><p>🔗 <a href="https://www.gaficat.com/posts/353df0b0.html" title="title">给你的hexo插入音乐视频</a></p><p>🔗 <a href="https://www.u2sb.com/pages/748f02/" title="title">hexo-tag-mmedia文档</a></p>]]></content>
    
    
    <summary type="html">Hexo升级版本和功能配置，持续更新中。</summary>
    
    
    
    <category term="搭建博客" scheme="http://linyishui.top/categories/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/"/>
    
    
    <category term="hexo" scheme="http://linyishui.top/tags/hexo/"/>
    
    <category term="updating" scheme="http://linyishui.top/tags/updating/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-请求处理和数据存储（未完成）</title>
    <link href="http://linyishui.top/2021062001.html"/>
    <id>http://linyishui.top/2021062001.html</id>
    <published>2021-06-20T14:33:08.000Z</published>
    <updated>2021-07-20T14:55:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="八-请求处理"><a href="#八-请求处理" class="headerlink" title="八. 请求处理"></a>八. 请求处理</h2><h3 id="8-1-会话创建请求"><a href="#8-1-会话创建请求" class="headerlink" title="8.1 会话创建请求"></a>8.1 会话创建请求</h3><p>ZooKeeper服务器对于会话创建的处理，大体分为6大环节：</p><ul><li>请求接收</li><li>会话创建</li><li>预处理</li><li>事务处理</li><li>事务应用</li><li>会话响应</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010153.png"></p><p>其中事务处理部分流程：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010154.png"></p><ul><li><strong>请求接收：</strong><ol><li>I/O层接收来自客户端的请求。</li><li>判断是否是客户端会话创建请求。</li><li>反序列化ConnectRequest请求。</li><li>判断是否是ReadOnly客户端。</li><li>检查客户端ZXID。</li><li>协商sessionTimeout。</li><li>判断是否需要重新创建会话。</li></ol></li><li><strong>会话创建：</strong><ol start="8"><li>为客户端生成sessionID。</li><li>注册会话。</li><li>激活会话。</li><li>生成会话密码。</li></ol></li><li><strong>预处理：</strong><ol start="12"><li>将请求交给ZK的PrepRequestProcessor处理器进行处理。</li><li>创建请求事务头。</li><li>创建请求事务体。</li><li>注册与激活会话。</li></ol></li><li><strong>事务处理：</strong><ol start="16"><li>将请求交给ProposalRequestProcessor处理器。</li></ol></li></ul><h3 id="8-2-SetData请求"><a href="#8-2-SetData请求" class="headerlink" title="8.2 SetData请求"></a>8.2 SetData请求</h3><h3 id="8-3-事务请求转发"><a href="#8-3-事务请求转发" class="headerlink" title="8.3 事务请求转发"></a>8.3 事务请求转发</h3><h3 id="8-4-GetData请求"><a href="#8-4-GetData请求" class="headerlink" title="8.4 GetData请求"></a>8.4 GetData请求</h3><h2 id="九-数据与存储"><a href="#九-数据与存储" class="headerlink" title="九. 数据与存储"></a>九. 数据与存储</h2><h3 id="9-1-内存数据"><a href="#9-1-内存数据" class="headerlink" title="9.1 内存数据"></a>9.1 内存数据</h3><h3 id="9-2-事务日志"><a href="#9-2-事务日志" class="headerlink" title="9.2 事务日志"></a>9.2 事务日志</h3><h3 id="9-3-snapshot—数据快照"><a href="#9-3-snapshot—数据快照" class="headerlink" title="9.3 snapshot—数据快照"></a>9.3 snapshot—数据快照</h3><h3 id="9-4-初始化"><a href="#9-4-初始化" class="headerlink" title="9.4 初始化"></a>9.4 初始化</h3><h3 id="9-5-数据同步"><a href="#9-5-数据同步" class="headerlink" title="9.5 数据同步"></a>9.5 数据同步</h3><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：会话创建、SetData、GetData请求，事务请求转发，内存数据，事务日志，snapshot，初始化，数据同步等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="unfinished" scheme="http://linyishui.top/tags/unfinished/"/>
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>《社会心理学》读书笔记（一）导论</title>
    <link href="http://linyishui.top/2021061501.html"/>
    <id>http://linyishui.top/2021061501.html</id>
    <published>2021-06-15T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:32.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="导论"><a href="#导论" class="headerlink" title="导论"></a>导论</h1><h2 id="一-什么是社会心理学"><a href="#一-什么是社会心理学" class="headerlink" title="一. 什么是社会心理学"></a>一. 什么是社会心理学</h2><blockquote><p>人类是情境中的生物，情境塑造了我们，决定我们未来的诸多可能性，我们便不可独立于它而存在。</p></blockquote><p>社会心理学是一门<strong>研究我们周围情境力量</strong>的科学，尤其是我们<strong>如何看待他人、如何影响他人、又如何互相关联</strong>。、</p><p>我们的社会行为不仅取决于<strong>客观情境</strong>，还取决于我们如何对其进行<strong>主观建构</strong>。</p><h3 id="研究的问题"><a href="#研究的问题" class="headerlink" title="研究的问题"></a>研究的问题</h3><p>社会心理学研究三类问题：</p><ul><li><strong>社会思维：</strong><ul><li>我们如何知觉自我和他人</li><li>我们的信念是什么</li><li>我们所做的判断</li><li>我们的态度</li></ul></li><li><strong>社会影响：</strong><ul><li>文化与生物从众的压力</li><li>说服</li><li>团体</li></ul></li><li><strong>社会关系：</strong><ul><li>偏见</li><li>攻击</li><li>吸引力和亲密关系</li><li>助人</li></ul></li></ul><p>我们的社交生活在多大程度上存在于我们的头脑之中？如果被要求听命行事，你会用残忍的方式行动吗？选择助人还是助己？</p><h3 id="社会心理学的观点"><a href="#社会心理学的观点" class="headerlink" title="社会心理学的观点"></a>社会心理学的观点</h3><ul><li>社会思维：<ol><li><strong>我们构建起社会现实。</strong>人类的通性是想要解释行为，使其归因变得次序井然，具有可预见性，能够被掌握。我们会习惯解释他人的行为，将其“人格”归类。看待自己是乐观或悲观，习惯高人一等还是低人一等？</li><li><strong>我们的社会直觉的力量是强大的，但有时是危险的。</strong>我们的直觉影响我们某些时刻的选择，人的心灵或许是无意识的，一个由直觉所操控的。思维、记忆和态度都是同时在两个水平上运行的，一个有意识和意图，一个无意识和自动，即<strong>双重加工</strong>。我们自己的直觉时常会出错，太过于相信自己的记忆力，错误的解读自己的心理，错误估计自己的未来。大部分场景中，快捷省力的速食型判断方式足以满足需求，但一些需要<strong>准确性</strong>的特殊场景下，我们最好使用<strong>批判性思维</strong>来抑制直觉冲动。</li><li><strong>态度塑造行为。</strong>我们对某些事情的态度会左右相关的行为，态度也同样依附于行为。</li></ol></li><li>社会影响：<ol start="4"><li><strong>社会影响塑造行为。</strong>我们是社会动物，会对周围环境做出反应。有时，某些社会情境具有的影响力会引发我们做出背离自己态度的举动。比如伊拉克战争爆发时，美国和以色列的群众会更倾向于战争，而世界其他国家的群众则反对战争。我们对女性美的定义取决于我们所在的文化环境等等。<strong>环境无时无刻不在影响个人。</strong></li><li><strong>性格倾向塑造行为。</strong>面对同样的情境，不同性格的人会做出不同的选择。<strong>作为社会个体，我们不仅仅是社会的产物，也同样是社会的创造者。</strong>（相互影响）</li></ol></li><li>社会关系：<ol start="6"><li><strong>社会行为同样也是生物性行为。</strong>人类是先天与后天共同作用的生物，遗传得到的天性是我们做出有利于繁衍的行为，我们遗传了这些使得血脉得以延续的基因。进化心理学研究的是自然选择如何影响我们的一些行为与反应。大脑、心灵和行为是如何共同作用成为一个相互协调的工作系统，这是社会认知神经科学关注的问题。</li><li><strong>对他人的感受和做出的行为有时是积极，有时则是消极的。</strong></li></ol></li></ul><h2 id="二-社会心理学与相关学科"><a href="#二-社会心理学与相关学科" class="headerlink" title="二. 社会心理学与相关学科"></a>二. 社会心理学与相关学科</h2><ul><li><p><strong>社会学：</strong>社会学家研究<strong>团体</strong>—从小团体到大团体（社会与其发展趋势）；社会心理学家研究<strong>个体</strong>—个体在某个特定时间对他人的看法，个体之间的相互影响及关系。比如亲密关系的研究中，社会学关系婚姻关系、离婚以及同居比例，社会心理学则关心个体如何被另一个个体吸引。</p></li><li><p><strong>人格心理学：</strong>二者都关注个体，社会心理学更多关注社会因素，人格心理学则关注个体内部功能以及个体间的差异。社会心理学关注个体间的相同点，人格心理学关注个体间的差异点。</p></li></ul><h2 id="三-价值观与事后聪明"><a href="#三-价值观与事后聪明" class="headerlink" title="三. 价值观与事后聪明"></a>三. 价值观与事后聪明</h2><blockquote><p>心理学无法解释人类存在的目的，也无法解释人类生活的意义，以及人类的最终命运。社会心理学只是我们看待自我，了解自我的其中一个视角。</p></blockquote><p>如果大脑没有预先设定你将知觉到某个物体，它便会将其阻隔在你的一视之外。我们对现实的知觉会为我们的预期所左右。<strong>客观现实的确存在，但我们总是透过信念与价值观的眼镜观察它们。</strong></p><p>每个人都难以脱离个人主观的影响，因此社会心理学的概念也会被隐含的价值观渗入。我们生活中也会有这种问题，当别人赞美国家和人民时我们称其为民族主义，当我们这样做时就叫爱国主义。一个卷入婚外情的人是追求婚姻解放还是通奸，取决于我们个人价值观。雄心勃勃的男人与盛气凌人的女人，小心谨慎的男孩子与怯生生的女孩子等。</p><p>社会心理学不是旨在事后分析，而是能够预测。当得知结果后就会觉得显而易见，比如股市震荡或大选落定，大部分评论对此并不感到意外。绝大多数的心理学实验得到结论看起来都像常识，这是因为我们提前知道了结果（事后聪明）。</p><blockquote><p>将一群人分为两组，一组告知其无论交友还是坠入爱河，性格与我们不同的人更有吸引力，俗话说异性相吸；另一组则告知其性格相似的人最有吸引力，俗话说物以类聚、人以群分。</p><p>无论哪种说法，甚至是相反的论点都会让我们觉得很有道理，比如“堕落的人不能帮助另一个堕落的人”与“堕落的人能够帮助另一个堕落的人”这种双重格言。</p></blockquote><h2 id="四-研究方法"><a href="#四-研究方法" class="headerlink" title="四. 研究方法"></a>四. 研究方法</h2><hr><p>参考：</p><p>🔗 《社会心理学》</p>]]></content>
    
    
    <summary type="html">内容来自《社会心理学》。</summary>
    
    
    
    <category term="编程之外" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="心理学" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>《社会心理学》读书笔记</title>
    <link href="http://linyishui.top/2021061401.html"/>
    <id>http://linyishui.top/2021061401.html</id>
    <published>2021-06-14T07:03:45.000Z</published>
    <updated>2021-07-09T09:56:28.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="社会心理学"><a href="#社会心理学" class="headerlink" title="社会心理学"></a>社会心理学</h1><h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一. 前言"></a>一. 前言</h2><p><a href="../2021061501.html" title="Title">《社会心理学》读书笔记（一）导论</a></p><h2 id="二-社会思维"><a href="#二-社会思维" class="headerlink" title="二. 社会思维"></a>二. 社会思维</h2><h2 id="三-社会影响"><a href="#三-社会影响" class="headerlink" title="三. 社会影响"></a>三. 社会影响</h2><h2 id="四-社会关系"><a href="#四-社会关系" class="headerlink" title="四. 社会关系"></a>四. 社会关系</h2><h2 id="五-实际应用"><a href="#五-实际应用" class="headerlink" title="五. 实际应用"></a>五. 实际应用</h2><hr><p>参考：</p><p>🔗 《社会心理学》</p>]]></content>
    
    
    <summary type="html">内容来自《社会心理学》。</summary>
    
    
    
    <category term="编程之外" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/"/>
    
    <category term="心理学" scheme="http://linyishui.top/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%A4%96/%E5%BF%83%E7%90%86%E5%AD%A6/"/>
    
    
    <category term="psychology" scheme="http://linyishui.top/tags/psychology/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-服务器启动流程和Leader选举</title>
    <link href="http://linyishui.top/2021061301.html"/>
    <id>http://linyishui.top/2021061301.html</id>
    <published>2021-06-13T15:29:15.000Z</published>
    <updated>2021-07-20T14:30:24.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="五-服务器启动"><a href="#五-服务器启动" class="headerlink" title="五. 服务器启动"></a>五. 服务器启动</h2><p>ZooKeeper服务端架构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010134.png"></p><h3 id="5-1-单机版服务器启动"><a href="#5-1-单机版服务器启动" class="headerlink" title="5.1 单机版服务器启动"></a>5.1 单机版服务器启动</h3><p>ZK服务器启动步骤：</p><ol><li>配置文件解析。</li><li>初始化数据管理器。</li><li>初始化网络I/O管理器。</li><li>数据恢复和对外服务。</li></ol><p>单机模式下ZK服务器的启动流程图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010135.png"></p><h4 id="（1）预启动"><a href="#（1）预启动" class="headerlink" title="（1）预启动"></a>（1）预启动</h4><ol><li><p>统一由QuorumPeerMain作为启动类。</p><p>单机/集群模式，在 <code>zkServer.cmd</code> 和 <code>zkServer.sh</code> 两个脚本中都配置了 <code>org.apache.zookeeper.server.quorum.QuorumPeerMain</code> 作为启动入口类。</p></li><li><p>解析配置文件 <code>zoo.cfg</code> 。</p><p>该文件配置了ZK运行时的基本参数，包括tickTime、dataDir和clientPort等参数。</p></li><li><p>创建并启动历史文件清理器 DatadirCleanupManager 。</p><p>ZK从3.4.0版本后增加了自动清理历史数据文件的机制，包括对事务日志和快照数据文件进行定时清理。</p></li><li><p>判断当前是集群模式还是单机模式的启动。</p><p>ZooKeeper根据步骤2解析出的集群服务器地址列表判断当前是单机还是集群模式。单机模式委托给ZooKeeperServerMain进行启动处理。</p></li><li><p>再次进行配置文件 <code>zoo.cfg</code> 的解析。</p></li><li><p>创建服务器实例 ZooKeeperServer 。</p><p><code>org.apache.zookeeper.server.ZooKeeperServer</code> 是单机版服务端最核心的实体类。ZK服务器会首先进行服务器实例的创建，然后对实例进行初始化，包括连接器、内存数据库和请求处理器等组件的初始化。</p></li></ol><h4 id="（2）初始化"><a href="#（2）初始化" class="headerlink" title="（2）初始化"></a>（2）初始化</h4><ol><li><p>创建服务器统计器 ServerStats 。</p><p>ServerStats 是ZK服务器运行时的统计器：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010136.png"></p></li><li><p>创建ZooKeeper数据管理器 FileTxnSnapLog 。</p><p>FileTxnSnapLog 是ZK上层服务器和底层数据存储之间的对接层，提供了一系列操作数据文件的接口，包括事务日志文件和快照数据文件。ZK根据 zoo.cfg 文件中解析出的快照数据目录 dataDir 和事务日志目录 dataLogDir 来创建 FileTxnSnapLog 。</p></li><li><p>设置服务器tickTime和会话超时时间限制。</p></li><li><p>创建ServerCnxnFactory。</p><p>3.4.0版本引入Netty代替自实现的NIO框架，通过配置系统属性 <code>zookeeper.serverCnxnFactory</code> 来选择所使用的服务端网络连接工厂。</p></li><li><p>初始化ServerCnxnFactory。</p><p>首先初始化一个Thread来作为ServerCnxnFactory的主线程，然后再初始化NIO服务器。</p></li><li><p>启动ServerCnxnFactory主线程。</p><p>启动步骤5已经初始化的主线程ServerCnxnFactory的run方法，虽然此时NIO服务器已对外开放端口，客户端能够访问2181，但服务器实际无法处理客户端请求。</p></li><li><p>恢复本地数据。</p><p>每次在ZK启动的时候，都需要从本地快照数据文件和事务日志文件中进行数据恢复。</p></li><li><p>创建并启动会话管理器。</p><p>会话管理器 SessionTracker 负责服务端的会话管理，创建SessionTracker的时候，会初始化 expirationInterval、nextExpirationTime 和 sessionWithTimeout（用于保存每个会话的超时时间），同时还会计算出一个初始化的 sessionID 。</p><p>SessionTracker初始化完毕，ZK就会立即开始会话管理器的会话超时检查。</p></li><li><p>初始化ZooKeeper的请求处理链。</p><p>ZK的请求处理方式是典型的责任链模式的实现，在服务器上会有多个请求处理器一次来处理一个客户端请求。服务器启动时将这些请求处理器串联起来形成一个请求处理链。单机版包括 PrepRequestProcessor、SyncRequestProcessor 和 FinalRequestProcessor 三个请求处理器</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010137.png"></p></li><li><p>注册JMX服务。</p><p>ZK将服务器运行时的一些信息以JMX的方式暴露给外部。</p></li><li><p>注册ZooKeeper服务器实例。</p><p>此前端口开放但不能处理客户端请求，因为网络层尚未能访问ZK实例。经过后续步骤后，ZK服务器已初始化完毕，只需注册给ServerCnxnFactory就可以对外提供正常的服务。</p></li></ol><h3 id="5-2-集群版服务器启动"><a href="#5-2-集群版服务器启动" class="headerlink" title="5.2 集群版服务器启动"></a>5.2 集群版服务器启动</h3><p>集群模式下ZK服务器的启动流程图：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010138.png"></p><h4 id="（1）预启动-1"><a href="#（1）预启动-1" class="headerlink" title="（1）预启动"></a>（1）预启动</h4><ol><li><p>统一由QuorumPeerMain作为启动类。</p></li><li><p>解析配置文件 <code>zoo.cfg</code> 。</p></li><li><p>创建并启动历史文件清理器 DatadirCleanupManager 。</p></li><li><p>判断当前是集群模式还是单机模式的启动。</p><p>ZooKeeper根据步骤2解析出的集群服务器地址列表判断当前是单机还是集群模式。</p></li></ol><h4 id="（2）初始化-1"><a href="#（2）初始化-1" class="headerlink" title="（2）初始化"></a>（2）初始化</h4><ol><li><p>创建ServerCnxnFactory。</p></li><li><p>初始化ServerCnxnFactory。</p></li><li><p>创建ZooKeeper数据管理器 FileTxnSnapLog 。</p></li><li><p>创建QuorumPeer实例。</p><p>QuorumPeer是集群模式特有的对象，是ZK服务器实例的托管者，从集群层面看，QuorumPeer代表了ZK集群中一台机器。运行期间，QuorumPeer 会不断检测当前服务器实例的运行状态，同时根据情况发起Leader选举。</p></li><li><p>创建内存数据库ZKDatabase。</p><p>负责管理ZooKeeper的所有会话记录以及DataTree和事务日志的存储。</p></li><li><p>初始化QuorumPeer。</p><p>一些核心组件注册到QuorumPeer中去，包括FileTxnSnapLog、ServerCnxnFactory 和 ZKDatabase 。同时ZK还会对QuorumPeer配置一些参数，包括服务器地址列表、Leader 选举算法和会话超时时间限制。</p></li><li><p>恢复本地数据。</p></li><li><p>启动ServerCnxnFactory主线程。</p></li></ol><h4 id="（3）Leader选举"><a href="#（3）Leader选举" class="headerlink" title="（3）Leader选举"></a>（3）Leader选举</h4><p>步骤：</p><ol><li><p><strong>初始化Leader选举。</strong></p><p>ZK根据自身的SID（服务器ID）、lastLoggedZxid（最新ZXID）和当前服务器epoch（currentEpoch）来生成一个初始化的投票，每个服务器都投自己。</p><p>然后ZK根据 <code>zoo.cfg</code> 的配置，创建对应的Leader选举算法实现。默认可选三种实现，使用 <code>electionAlg</code> 属性0~3指定：</p><ul><li><strong>LeaderElection：</strong>3.4.0版本废弃。</li><li><strong>AuthFastLeaderElection：</strong>3.4.0版本废弃。</li><li><strong>FastLeaderElection：</strong>当前唯一选择。</li></ul><p>初始化阶段，ZK首先创建Leader选举所需的网络I/O层QuorumCnxManager，同时启动对Leader选举端口的监听，等待集群中其他服务器创建连接。</p></li><li><p><strong>注册JMX服务。</strong></p></li><li><p><strong>检测当前服务器状态。</strong></p><p>QuorumPeer是ZK服务器实例的托管者，其核心不断的检查当前服务器的状态并做出处理。正常情况下，ZK服务器状态在 LOOKING、LEADING和FOLLOWING/OBSERVING 之间切换。<strong>启动阶段，QuorumPeer的初始状态为LOOKING，此时进行Leader选举。</strong></p></li><li><p><strong>Leader选举。</strong></p><p>一个集群中所有的机器相互之间进行一系列投票，选举最合适的机器成为Leader，其余则是Follower或Observer。<strong>集群中哪个机器处理的数据最新（根据服务器处理过的最大ZXID来比较新旧）就越有可能成为Leader</strong>。当所有服务器处理的ZXID一致，SID最大的会成为Leader。</p></li></ol><h4 id="（4）Leader和Follow启动期交互过程"><a href="#（4）Leader和Follow启动期交互过程" class="headerlink" title="（4）Leader和Follow启动期交互过程"></a>（4）Leader和Follow启动期交互过程</h4><p>Leader和Follower启动期交互过程步骤：</p><ol><li><p><strong>创建Leader服务器和Follower服务器。</strong></p><p>完成Leader选举后，每个服务器都会根据自己的角色创建对应的服务器实例，开始自己的主流程。</p></li><li><p><strong>Leader服务器启动Follower接收器LearnerCnxAcceptor。</strong></p><p>ZK集群运行期间，Leader服务器需要和其余服务器（Learner服务器）保持连接来确定其存活情况。LearnerCnxAcceptor负责接收所有非Leader服务器的连接请求。</p></li><li><p><strong>Learner服务器开始和Leader建立连接。</strong></p><p>所有Learner服务器启动完毕后，从投票结果得到Leader服务器信息，并与其建立连接。</p></li><li><p><strong>Leader服务器创建LearnerHandler。</strong></p><p>Leader接收到连接创建请求后，创建一个对应的LearnerHandler实例表示二者间的连接，并负责所有的消息通信和数据同步。</p></li><li><p><strong>向Leader注册。</strong></p><p>建立好连接后，Learner向Leader注册，发送自己的LearnerInfo，包括服务器SID和处理的最新ZXID。</p></li><li><p><strong>Leader解析Learner信息，计算新的epoch。</strong></p><p>Leader根据解析出的SID和ZXID，获取对应的 <code>epoch_of_learner</code> ，与当前服务器的 <code>epoch_of_leader</code> 进行比较，如果Learner更大的话就更新Leader的epoch：<code>epoch_of_leader = epoch_of_learner + 1</code> 。</p><p>然后LearnerHandler会进行等待，等到过半的Learner已经向Leader进行了注册，同时更新了 <code>epoch_of_leader</code> 之后，Leader就可以确定当前集群的epoch了。</p></li><li><p><strong>发送Leader状态。</strong></p><p>计算出新的epoch后，Leader会将其以一个LEADERINFO消息的形式发送给Learner，同时等待其响应。</p></li><li><p><strong>Learner发送ACK信息。</strong></p><p>Follower收到LEADERINFO消息后，解析出epoch和ZXID，并向Leader反馈一个ACKEPOCH响应。</p></li><li><p><strong>数据同步。</strong></p><p>Leader服务器接收到ACK后，开始与其进行数据同步。</p></li><li><p><strong>启动Leader和Learner服务器。</strong></p><p>当过半的Learner已经完成了数据同步，Leader和Learner服务器的实例可以开始启动了。</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010139.png"></p><p>Leader和Follower启动的步骤：</p><ol><li>创建并启动会话管理器。</li><li>初始化ZK的请求处理链。</li><li>注册JMX服务。</li></ol><h2 id="六-Leader选举"><a href="#六-Leader选举" class="headerlink" title="六. Leader选举"></a>六. Leader选举</h2><h3 id="6-1-概述"><a href="#6-1-概述" class="headerlink" title="6.1 概述"></a>6.1 概述</h3><p>Leader选举是保证分布式数据一致性的关键所在。</p><h4 id="（1）服务器启动时期的Leader选举"><a href="#（1）服务器启动时期的Leader选举" class="headerlink" title="（1）服务器启动时期的Leader选举"></a>（1）服务器启动时期的Leader选举</h4><p>假设集群有三台机器，集群初始化阶段只有一台机器启动时还不能进行Leader选举，只有当第二台机器启动并能互相通信时，才能进入选举流程：</p><ol><li><p><strong>每个Server会发出一个投票。</strong></p><p>每台机器都投自己，每次投票包含最基本元素：所推举的服务器的myid和ZXID。</p><p>所以结果是两个投票(1, 0)和(2, 0)分别发送给集群的其他机器。</p></li><li><p><strong>接收来自各个服务器的投票。</strong></p><p>每个服务器收到投票后，先判断投票的有效性，包括检查是否为本轮投票、是否来自LOOKING状态的服务器。</p></li><li><p><strong>处理投票。</strong></p><p>每一个投票，服务器都要将其与自己的投票进行PK，规则：</p><ul><li>优先检查ZXID，较大的服务器优先作为Leader。</li><li>ZXID相同时比较myid，较大的服务器优先作为Leader。</li></ul><p>所以步骤1的两个投票中后者myid较大，服务器1将自己的投票更新为(2, 0)，服务器2则重复再发一次投票信息。</p></li><li><p><strong>统计投票。</strong></p><p>每次投票后，服务器都会统计所有投票，判断是否已有过半的机器收到相同的投票信息。</p></li><li><p><strong>改变服务器状态。</strong></p><p>一旦确定了Leader，每个服务器都会更新自己的状态，Follower更新为FOLLOWING，Leader更新为LEADING。</p></li></ol><h4 id="（2）服务器运行期间的Leader选举"><a href="#（2）服务器运行期间的Leader选举" class="headerlink" title="（2）服务器运行期间的Leader选举"></a>（2）服务器运行期间的Leader选举</h4><p>当Leader所在服务器挂掉，会进入新一轮的Leader选举：</p><ol><li><p><strong>变更状态。</strong></p><p>Leader挂了，所有非Observer服务器将自己状态更新为LOOKING。</p></li><li><p><strong>每个Server会发出一个投票。</strong></p><p>生成投票信息(myid, ZXID)，此时服务器1和3产生投票(1, 123)和(3, 122)，发送给各个机器。</p></li><li><p><strong>接收来自各个服务器的投票。</strong></p></li><li><p><strong>处理投票。</strong></p><p>和启动阶段规则一致，服务器1会被选为Leader。</p></li><li><p><strong>统计投票。</strong></p></li><li><p><strong>改变服务器状态。</strong></p></li></ol><h3 id="6-2-算法分析"><a href="#6-2-算法分析" class="headerlink" title="6.2 算法分析"></a>6.2 算法分析</h3><p>ZK提供了三种选举算法，在 <code>zoo.cfg</code> 的配置中使用 <code>electionAlg</code> 属性指定：</p><ul><li><strong>LeaderElection：</strong>数字0，纯UDP实现。</li><li><strong>AuthFastLeaderElection：</strong>数字2，UDP版本，授权模式。</li><li><strong>FastLeaderElection：</strong>数字1表示UDP版本，非授权模式；数字3表示，TCP版本，当前唯一选择。</li></ul><h4 id="（1）术语"><a href="#（1）术语" class="headerlink" title="（1）术语"></a>（1）术语</h4><ul><li><strong>SID（服务器ID）：</strong>唯一标识一台机器，与myid的值一致。</li><li><strong>ZXID（事务ID）：</strong>唯一标识一次服务器状态的变更，集群中每台机器的不一定一致。</li><li><strong>Vote（投票）：</strong>当机器发现自己无法检测到Leader时，就会尝试开始Leader选举。</li><li><strong>Quorum（过半机器数）：</strong>集群中机器数为n，则 <code>quorum = (n / 2 + 1)</code> 。</li></ul><h4 id="（2）何时进入Leader选举"><a href="#（2）何时进入Leader选举" class="headerlink" title="（2）何时进入Leader选举"></a>（2）何时进入Leader选举</h4><p>当某台机器出现任一情况：</p><ul><li>服务器初始化启动。</li><li>服务器运行期间无法和Leader保持连接。</li></ul><p>当一台机器进入选举流程时，集群可能处于两种状态之一：</p><ul><li><p>集群本身存在一个Leader。</p><p>可能因为某台机器启动较晚，此时选举流程已结束，所以当其尝试选举Leader时会被告知当前Leader服务器的信息。机器仅需和Leader建立连接并同步状态即可。</p></li><li><p>集群确实已不存在Leader。</p></li></ul><h4 id="（3）开始第一次投票"><a href="#（3）开始第一次投票" class="headerlink" title="（3）开始第一次投票"></a>（3）开始第一次投票</h4><p>导致集群中不存在Leader：</p><ul><li>服务器刚初始化启动，尚未产生一台Leader服务器。</li><li>运行期间Leader服务器挂掉。</li></ul><p>此时集群所有机器都处于LOOKING状态，尝试寻找Leader。当一台机器处于此状态，会向集群其它机器发送投票消息(SID, ZXID)。</p><p>首次投票所有机器都会选举自己。</p><h4 id="（4）变更投票"><a href="#（4）变更投票" class="headerlink" title="（4）变更投票"></a>（4）变更投票</h4><p>每台机器发送完自己的投票，也会接收到其它机器的投票。根据投票规则判断是否需要变更自己的投票。</p><p>术语：</p><ul><li><strong>vote_sid：</strong>接收到的投票中的服务器SID。</li><li><strong>vote_zxid：</strong>接收到的投票中的服务器ZXID。</li><li><strong>self_sid：</strong>服务器自己的SID。</li><li><strong>self_zxid：</strong>服务器自己的ZXID。</li></ul><p>规则：</p><ol><li>如果vote_zxid大于self_zxid，认可当前收到的投票，再次将其发送出去代表自己新一轮的投票。</li><li>如果vote_zxid小于self_zxid，坚持自己的投票，不做任何变更。</li><li>如果vote_zxid等于self_zxid，对比二者的SID，如果vote_sid大于self_sid，认可当前收到的投票，再次将其发送出去代表自己新一轮的投票。</li><li>如果vote_zxid等于self_zxid，且vote_sid小于self_sid，坚持自己的投票，不做任何变更。</li></ol><p>假设集群有5台机器，SID为(1,2,3,4,5)，ZXID为(9,9,9,8,8)，此时SID为2的机器为Leader，且1和2同时挂掉，由此开始Leader选举：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010140.png"></p><h4 id="（5）确定Leader"><a href="#（5）确定Leader" class="headerlink" title="（5）确定Leader"></a>（5）确定Leader</h4><p>经过第二次投票后，集群中每台机器都会再次收到其他机器的投票，并进行统计，当一台机器收到了超过半数相同的投票，其就称为新的Leader。</p><p>上述案例中quorum为3，只要收到3个即可。</p><h3 id="6-3-实现细节"><a href="#6-3-实现细节" class="headerlink" title="6.3 实现细节"></a>6.3 实现细节</h3><p>上述FastLeaderElection选举算法并不复杂，但实际实现有很多问题需要解决。</p><h4 id="（1）服务器状态"><a href="#（1）服务器状态" class="headerlink" title="（1）服务器状态"></a>（1）服务器状态</h4><p><code>org.apache.zookeeper.server.quorum.QuorumPeer.ServerState</code> 类中列举了4种服务器状态：</p><ul><li><strong>LOOKING：</strong>寻找Leader状态，服务器在此状态时会认为集群没有Leader，需要进入Leader选举流程。</li><li><strong>FOLLOWING：</strong>跟随者状态，表示当前机器为Follower。</li><li><strong>LEADING：</strong>领导者状态，表示当前机器为Leader。</li><li><strong>OBSERVING：</strong>观察者状态，表示当前机器为Observer。</li></ul><h4 id="（2）投票的数据结构"><a href="#（2）投票的数据结构" class="headerlink" title="（2）投票的数据结构"></a>（2）投票的数据结构</h4><p><code>org.apache.zookeeper.server.quorum.Vote</code> 类的数据结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010141.png"></p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010142.png"></p><h4 id="（3）QuorumCnxManager-网络I-O管理者"><a href="#（3）QuorumCnxManager-网络I-O管理者" class="headerlink" title="（3）QuorumCnxManager-网络I/O管理者"></a>（3）QuorumCnxManager-网络I/O管理者</h4><p>ClientCnxn是ZK客户端中用于处理网络I/O的管理器，Leader选举中类似角色就是QuorumCnxManager，负责各台服务器之间的底层Leader选举过程中的网络通信。</p><p>其内部维护了一系列的队列，用来保存接收到的、待发送的消息，以及消息的发送器。每个队列都按SID分组形成队列集合，保证每台服务器之间互不干扰。</p><ul><li><strong>recvQueue：</strong>消息接收队列，存放从其他服务器接收到的消息。</li><li><strong>queueSendMap：</strong>消息发送队列，存放待发送的消息。该Map按SID进行分组，为集群中每台机器分配一个单独的队列，保证机器之间的消息互不影响。</li><li><strong>senderWorkerMap：</strong>发送器集合，每个SendWorker消息发送器，都对应一台远程ZooKeeper服务器，负责消息的发送。也按SID进行了分组。</li><li><strong>lastMessageSent：</strong>最近发送过的消息，为每个SID保留最近发送过的一个消息。</li></ul><p>ZK中所有机器都要两两创建网络连接，所以QuorumCnxManager启动时会创建一个<strong>ServerSocket</strong>监听Leader选举的通信端口（默认3888），服务器会不断接收到其它服务器的创建连接请求。这类TCP连接请求会<strong>交由receiveConnection方法进行处理</strong>。</p><p>为了避免两条机器重复创建TCP连接，ZK设计了规则：<strong>只允许SID大的服务器主动和其他服务器建立连接，否则断开连接</strong>。所以receiveConnection方法中会比对自己和远程服务器的SID值，当自己更大时断开连接并主动发送连接请求，否则接受连接请求。</p><p>一旦连接建立，就会根据远程服务器的SID创建对应的消息发送器SendWorker和接收器RecvWorker并启动。</p><ul><li><strong>消息接收：</strong>RecvWorker从对应TCP连接收到消息，将其放到recvQueue中。</li><li><strong>消息发送：</strong>SendWorker不断从queueSendMap对应消息队列取出一个消息发送，同时将其放入lastMessageSent记录。（注意：<strong>当消息发送队列为空时，会从lastMessageSent取出一个最近发送的消息再次发送，主要为了解决分布式问题：接收方在消息接收前或接收到消息后挂掉，导致消息还未被正确处理。当然ZK也保证了接收方对重复消息进行了正确的处理</strong>）</li></ul><h4 id="（4）FastLeaderElection核心"><a href="#（4）FastLeaderElection核心" class="headerlink" title="（4）FastLeaderElection核心"></a>（4）FastLeaderElection核心</h4><p>术语：</p><ul><li><strong>外部投票：</strong>其他服务器发来的投票。</li><li><strong>内部投票：</strong>服务器自身当前的投票。</li><li><strong>选举轮次：</strong>Leader选举的轮次，即logicalClock。</li><li><strong>PK：</strong>指对内部和外部投票进行对比，来确认是否需要变更内部投票。</li></ul><p>选票管理：</p><ul><li><strong>sendqueue：</strong>选票发送队列，保存待发送的选票。</li><li><strong>recvqueue：</strong>选票接收队列，保存接收到的外部投票。</li><li><strong>WorkerReceiver：</strong>选票接收器，不断从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换为一个选票，并保存到recvqueue。<ul><li>在选票接收过程中，如果发现其选举轮次小于当前服务器就直接忽略，并立即发送内部投票。</li><li>当前服务器不是LOOKING状态，表示已选出Leader，同样直接忽略，并立即发送内部投票。</li><li>接收到的消息来自于Observer，同样直接忽略，并立即发送内部投票。</li></ul></li><li><strong>WorkerSender：</strong>选票发送器，不断从sendqueue获取选票并将其传递给底层QuorumCnxManager。</li></ul><p>选票管理与QuorumCnxManager在Leader选举中的关系：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010143.png"></p><p>Leader选举算法整体流程：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010144.png"></p><p>上述其实是 lookForLeader方法的内部逻辑：</p><ol><li><p><strong>自增选举轮次。</strong></p><p>FastLeaderElection的实现中有一个属性logicalclock，用于标识当前Leader的选举轮次，开始新一轮投票时会先将其自增。</p></li><li><p><strong>初始化选票。</strong></p><p>开始新一轮投票前，每台服务器要先初始化自己的选票，也就是初始化Vote的各个属性。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010145.png"></p></li><li><p><strong>发送初始化选票。</strong></p><p>完成选票的初始化后，就会发起第一次投票。选票被放入sendqueue中，由WorkerSender负责发送出去。</p></li><li><p><strong>接收外部投票。</strong></p><p>每台服务器会不断从recvqueue中获取外部投票，当服务器发现自己无法获取任何外部投票，会立刻确认自己是否和集群其它服务器保持连接。若没有就立即建立连接，如已有则再次发送自己的内部投票。</p></li><li><p><strong>判断选举轮次。</strong></p><p>发送完初始化选票，就要处理外部投票。需要根据选举轮次的不同进行不同的处理：</p><ul><li><strong>外部投票的轮次大于内部投票：</strong>立即更新自己的选举轮次，并清空所有已经收到的投票，然后使用初始化投票进行PK来确定是否变更内部投票，最终再将投票发送出去。</li><li><strong>外部投票的轮次小于内部投票：</strong>直接忽略该投票，返回步骤4。</li><li><strong>外部投票的轮次等于内部投票：</strong>进行选票PK。</li></ul></li><li><p><strong>选票PK。</strong></p><p>即 <code>FastLeaderElection.totalOrderPredicate</code> 方法的核心逻辑。主要从选举轮次、ZXID和SID三个因素考虑：</p><ul><li>如果外部投票中被推举的Leader服务器的选举轮次大于内部投票，需要进行投票变更。</li><li>选举轮次一致，则对比ZXID，如果外部投票较大就需要进行投票变更。</li><li>ZXID一致，则对比SID，如果外部投票较大就需要进行投票变更。</li></ul></li><li><p><strong>变更投票。</strong></p><p>选票PK后确定如果需要进行投票变更，要将外部投票的选票信息覆盖内部投票。变更完成后再将其发送出去。</p></li><li><p><strong>选票归档。</strong></p><p>无论是否进行了投票变更，都要将收到的外部投票放入recvset中进行归档。其用于记录当前服务器在本轮次收到的所有外部投票，并会按SID进行区分，如 <code>&#123;(1, vote1),(2, vote2),...&#125;</code> 。</p></li><li><p><strong>统计投票。</strong></p><p>完成选票归档后，可以开始投票的统计。一旦统计出有过半服务器认可了当前内部投票，就终止投票，否则返回步骤4。</p></li><li><p><strong>更新服务器状态。</strong></p><p>当统计投票确定可以终止投票，开始更新服务器状态。如果判断过半服务器认可，就会更新为LEADING。否则根据具体情况更新为FOLLOWING或OBSERVING。步骤9到步骤10可能会有一段时间延迟来确认是否有新的更优的投票（默认200毫秒）。</p></li></ol><h2 id="七-各服务器角色介绍"><a href="#七-各服务器角色介绍" class="headerlink" title="七. 各服务器角色介绍"></a>七. 各服务器角色介绍</h2><h3 id="7-1-Leader"><a href="#7-1-Leader" class="headerlink" title="7.1 Leader"></a>7.1 Leader</h3><p>Leader的主要工作：</p><ul><li>事务请求的唯一调度和处理者，保证集群事务处理的顺序性。</li><li>集群内部各服务器的调度者。</li></ul><p>ZK使用<strong>责任链模式</strong>处理每个客户端请求，请求处理链：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010146.png"></p><blockquote><p>事务请求：指会改变服务器状态的一系列请求，如创建节点、更新数据、删除节点以及创建会话等。</p></blockquote><ul><li><p><strong>PrepRequestProcessor：</strong>请求预处理器，是第一个请求处理器。其能识别出当前客户端请求是否为事务请求。如果是则进行一系列预处理，如创建请求事务头、事务体、会话检查、ACL检查和版本检查等。</p></li><li><p><strong>ProposalRequestProcessor：</strong>事务投票处理器，Leader服务器事务处理流程的发起者。</p><ul><li>其会将非事务请求流转到CommitProcessor，不再做其他处理；</li><li>事务请求除了交给CommitProcessor外，还会根据请求类型创建对应的Proposal提议，并发送给所有的Follower服务器从而发起一次集群内事务投票。</li><li>同时还会将事务请求交付给SyncRequestProcessor进行事务日志的记录。</li></ul></li><li><p><strong>SyncRequestProcessor：</strong>事务日志记录处理器，主要用来将事务请求记录到事务日志文件中，同时触发ZK进行数据快照。</p></li><li><p><strong>AckRequestProcessor：</strong>负责在SyncRequestProcessor处理器完成事务日志记录后，向Proposal的投票收集器发送ACK反馈，以通知投票收集器当前服务器已经完成了对该Proposal的事务日志记录。</p></li><li><p><strong>CommitProcessor：</strong> 事务提交处理器，使服务器都可以控制对事务请求的顺序处理。</p><ul><li>非事务请求，该处理器会直接将其交付给下一级处理器；</li><li>事务请求，其会等待集群内针对Proposal的投票直到其可被提交。</li></ul></li><li><p><strong>ToBeCommitProcessor：</strong>特殊的处理器，有一个toBeApplied队列，专门用来存储已被CommitProcessor处理过的可被提交的Proposal。</p><p>将这些请求逐个交付给FinalRequestProcessor进行处理，待其处理完毕后再从toBeApplied中移除。</p></li><li><p><strong>FinalRequestProcessor：</strong>最后一个请求处理器，主要用来进行客户端请求返回之前的收尾工作，包括创建客户端请求的响应；针对事务请求，该处理器还会负责将事务应用到内存数据库中。</p></li></ul><p>Leader服务器会与所有其他服务器创建一个TCP长连接，同时为每个服务器创建一个名为LearnerHandler的实体，是ZK集群中Learner服务器的管理器，负责Learner服务器与Leader服务器之间的一系列网络通信，包括数据同步、请求转发和Proposal提议的投票等。</p><h3 id="7-2-Follower"><a href="#7-2-Follower" class="headerlink" title="7.2 Follower"></a>7.2 Follower</h3><p>主要工作：</p><ul><li>处理客户端非事务请求，转发事务请求给Leader服务器。</li><li>参与事务请求Proposal的投票。</li><li>参与Leader选举投票。</li></ul><p>Follower也采用责任链模式组装的请求处理链来处理每一个客户端请求，但不需要负责事务请求的投票处理。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010147.png"></p><p>与Leader服务器有差异的两个处理器：</p><ul><li><strong>FollowerRequestProcessor：</strong>第一个请求处理器，主要工作是识别当前请求是否是事务请求。事务请求会将其转发给Leader服务器。</li><li><strong>SendAckRequestProcessor：</strong>同样负责事务日志记录反馈的角色，完成日志记录后，会向Leader服务器发送ACK消息表示自己完成了事务日志的记录工作。与AckRequestProcessor的唯一区别是，后者与Leader服务器在同台服务器，因此其ACK反馈仅仅是一个本地操作；前者位于Follower服务器上，通过ACK消息的形式来向Leader服务器进行反馈。</li></ul><h3 id="7-3-Observer"><a href="#7-3-Observer" class="headerlink" title="7.3 Observer"></a>7.3 Observer</h3><p>主要工作：</p><ul><li>观察ZK集群的最新状态变化并将状态变更同步过来。</li><li>与Follower一样，处理非事务请求，事务请求则转交给Leader服务器。但Observer不参与任何投票，包括事务请求Proposal的投票和Leader选举投票。</li><li>只提供非事务服务，通常用于不影响集群事务处理能力的前提下提升集群的非事务处理能力。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010148.png"></p><p>虽然组装了SyncRequestProcessor处理器，但Leader服务器不会将事务请求的投票转发给Observer。</p><h3 id="7-4-集群间消息通信"><a href="#7-4-集群间消息通信" class="headerlink" title="7.4 集群间消息通信"></a>7.4 集群间消息通信</h3><p>ZK的消息类型可以分为四类：</p><ul><li>数据同步型</li><li>服务器初始化型</li><li>请求处理型</li><li>会话管理型</li></ul><h4 id="（1）数据同步型"><a href="#（1）数据同步型" class="headerlink" title="（1）数据同步型"></a>（1）数据同步型</h4><p>数据同步型消息是指在Learner和Leader服务器进行数据同步时，网络通信所用到的消息。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010149.png"></p><h4 id="（2）服务器初始化型"><a href="#（2）服务器初始化型" class="headerlink" title="（2）服务器初始化型"></a>（2）服务器初始化型</h4><p>服务器初始化型消息是指整个集群或是某些新机器初始化的时候，Learner和Leader服务器之间相互通信所使用的消息类型。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010150.png"></p><h4 id="（3）请求处理型"><a href="#（3）请求处理型" class="headerlink" title="（3）请求处理型"></a>（3）请求处理型</h4><p>请求处理型消息是在请求处理的过程中，Learner和Leader服务器之间相互通信所使用的消息类型。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010151.png"></p><h4 id="（4）会话管理型"><a href="#（4）会话管理型" class="headerlink" title="（4）会话管理型"></a>（4）会话管理型</h4><p>会话管理型消息是ZK进行会话管理过程中，与Learner服务器之间进行通信使用的消息。</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010152.png"></p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：单机版和集群版服务器的启动流程，Leader选举算法分析和具体实现细节，Leader、Follower、Observer等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-会话</title>
    <link href="http://linyishui.top/2021061201.html"/>
    <id>http://linyishui.top/2021061201.html</id>
    <published>2021-06-12T10:24:16.000Z</published>
    <updated>2021-07-18T15:35:46.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="四-会话"><a href="#四-会话" class="headerlink" title="四. 会话"></a>四. 会话</h2><p>临时节点的生命周期、客户端请求顺序执行以及Watcher通知机制等都和会话息息相关。</p><h3 id="4-1-会话状态"><a href="#4-1-会话状态" class="headerlink" title="4.1 会话状态"></a>4.1 会话状态</h3><p>客户端与服务端完成连接的创建后，就建立了一个会话。会话的生命周期中会有多种状态：</p><ul><li><strong>CONNECTING：</strong>客户端开始创建ZK对象时进入此状态，同时从服务器地址列表逐个选取IP地址来尝试进行网络连接。</li><li><strong>CONNECTED：</strong>当成功连接上服务器时更新为此状态。</li><li>RECONNECTING/CONNECTING：网络问题等会使连接断开，ZK客户端会自动进行重连操作。</li><li>RECONNECTED/CONNECTED：运行期间，客户端状态总是会介于CONNECTING与CONNECTED之间。</li><li><strong>CLOSE：</strong>会话超时、权限检查失败或客户端主动退出。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010130.png"></p><h3 id="4-2-会话创建"><a href="#4-2-会话创建" class="headerlink" title="4.2 会话创建"></a>4.2 会话创建</h3><p>Session基本属性：</p><ul><li><strong>sessionID：</strong>会话ID，全局唯一标识一个会话。</li><li><strong>TimeOut</strong>：会话超时时间，客户端向服务端发送此超时时间，服务器根据自己超时时间限制最终确定会话的超时时间。</li><li><strong>TickTime：</strong>下次会话超时时间点，便于ZK对会话进行“分桶策略”管理，也为了高效低耗的实现会话的超时检查和清理。13位的long型数据，接近于当时间加上TimeOut。</li><li><strong>isClosing：</strong>标记会话是否已经关闭，确保服务端不再处理来自该会话的请求。</li></ul><p>生成SessionID，高8位确定了所在机器，后56位为当前时间来进行随机：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">initializeNextSession</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> nextSid = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">// 获取当前毫秒格式时间，左移24位，低24位用0补齐，再右移8位，高8位用0补齐</span></span><br><span class="line">       <span class="comment">// 左移24位将高位的1移出避免了负数出现（特殊的时间节点如2022年0408日仍会得到负数），所以3.4.6版本修复为 &gt;&gt;&gt; 8</span></span><br><span class="line">       nextSid = (System.currentTimeMillis() &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">       <span class="comment">// 再添加机器标识，当前ZK服务器的SID值，左移56位</span></span><br><span class="line">       <span class="comment">// 将两者|操作得到一个单机唯一的序列号</span></span><br><span class="line">       nextSid = nextSid | (id &lt;&lt; <span class="number">56</span>);</span><br><span class="line">       <span class="keyword">return</span> nextSid;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>SessionTracker是会话的管理器，负责会话创建、管理和清理等工作，每个会话在其中都保留3份：</p><ul><li><strong>sessionsById</strong>：根据sessionID来管理session实体，<code>HashMap&lt;Long, SessionImpl&gt;</code> 数据结构。</li><li><strong>sessionsWithTimeout</strong>：根据sessionID来管理session超时时间，<code>HashMap&lt;Long, Integer&gt;</code> 数据结构。其与ZK内存数据库相连，会被定期持久化到快照文件。</li><li><strong>sessionSets</strong>：根据下次会话超时时间来管理归档session，<code>HashMap&lt;Long, SessionSet&gt;</code> 数据结构。便于进行会话管理和超时检查。</li></ul><p>创建会话连接：</p><ul><li><strong>处理ConnectRequest请求：</strong>由NIOServerCnxn负责接收客户端的会话创建请求，反序列化出ConnectRequest请求，根据ZK服务端的配置完成会话超时时间的协商。</li><li><strong>会话创建</strong>：SessionTracker为会话分配一个SessionID，将其注册到sessionsById和sessionsWithTimeout，同时进行会话的激活。会话请求还会在ZK服务端各请求处理器直接进行顺序流转。</li><li><strong>处理器链路处理</strong></li><li><strong>会话响应</strong></li></ul><h3 id="4-3-会话管理"><a href="#4-3-会话管理" class="headerlink" title="4.3 会话管理"></a>4.3 会话管理</h3><h4 id="（1）分桶策略"><a href="#（1）分桶策略" class="headerlink" title="（1）分桶策略"></a>（1）分桶策略</h4><p>分桶策略指将类似的会话放在同一区块中进行管理，以便于ZK对会话进行不同区块的隔离处理以及同一区块的统一处理：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010131.png"></p><p>分配的原则是每个会话的下次超时时间点（ExpirationTime）最近一次可能超时的时间点，计算方式：<code>ExpirationTime = CurrentTime + SessionTimeout</code> ，当前时间+超时时间。</p><p>ZK的Leader服务器在运行期间会定时进行会话超时检查，间隔是ExpirationInterval，默认值为TickTime（2000毫秒），完整的公式：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExpirationTime_ = CurrentTime + SessionTimeout</span><br><span class="line">ExpirationTime = (ExpirationTime_ / ExpirationInterval + 1) * ExpirationInterval</span><br><span class="line">// 假设当前时间为1370907000000毫秒，客户端设置超时时间为15000毫秒，服务器TickTime为2000毫秒</span><br><span class="line">ExpirationTime_ = 1370907000000 + 15000 = 1370907015000</span><br><span class="line">ExpirationTime = (1370907015000 / 2000 + 1) = 1370907016000</span><br></pre></td></tr></table></figure><h4 id="（2）会话激活"><a href="#（2）会话激活" class="headerlink" title="（2）会话激活"></a>（2）会话激活</h4><p>客户端在会话运行期间向服务端发送PING请求来保持会话有效，服务端要不断接收这类心跳检测，并重新激活对应客户端会话，即TouchSession，一次心跳检测对应一次会话激活：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010132.png"></p><ol><li>检验会话是否已关闭。</li><li>计算改会话新的超时时间。</li><li>定位改会话当前的区块。根据会话老的超时时间定位其所在区块。</li><li>迁移会话。放入新的超时时间对应区块。</li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010133.png"></p><p>发生会话激活的两种情况：</p><ul><li>客户端发送请求，包括读写，触发一次会话激活。</li><li>客户端发现在sessionTimeout/3时间内未和服务器进行通信，主动发起一次PING请求，服务端收到后触发一次会话激活。</li></ul><h4 id="（3）会话超时检查"><a href="#（3）会话超时检查" class="headerlink" title="（3）会话超时检查"></a>（3）会话超时检查</h4><p>SessionTracker中有一个单独的线程专门进行会话超时检查，其工作机制的核心思路非常简单，逐个依次对会话桶中剩下的会话进行清理。</p><p>会话分桶策略中将ExpirationInterval的倍数作为时间点来分布会话，超时检查线程只要在这些指定的时间点进行检查即可，这样可以批量清理有很好的性能。</p><h3 id="4-4-会话清理"><a href="#4-4-会话清理" class="headerlink" title="4.4 会话清理"></a>4.4 会话清理</h3><p>SessionTracker的超时检查出已经过期的会话后，开始进行会话清理：</p><ol><li><p><strong>标记会话状态为“已关闭”</strong>。</p><p>清理过程需要一段时间，首先要将会话的isClosing设置为true，在此期间不再处理该客户端的请求。</p></li><li><p><strong>发起“会话关闭”请求</strong>。</p><p>提交此请求使会话关闭在整个服务器集群中生效，立即交付给PrepRequestProcessor处理器。</p></li><li><p><strong>收集需要清理的临时节点</strong>。</p><p>会话失效后，相关的临时节点都要一并清除掉，所以要先整理出和会话相关的临时节点。</p><p>ZK内存数据库中每个会话都单独保存了一份由该会话维护的临时节点集合，只需根据sessionID取到这份列表即可。</p><p>实际应用中，ZK处理会话关闭请求前可能有两类请求到达了服务端并正在处理：</p><ul><li>节点删除请求，删除的目标节点正好是集合中的一个。</li><li>临时节点创建请求，创建的的目标节点正好是集合中的一个。</li></ul><p>共同点是事务尚未完成，还未应用到内存数据库，所以获取临时节点列表时可能会有不一致的情况。前者需要从获取的列表中也移除，后者要将所有请求对应的路径节点加到集合中，以删除这些将要创建的节点。</p></li><li><p><strong>添加“节点删除”事务变更</strong>。</p><p>完成临时节点收集后，ZK逐个将临时节点转换为节点删除请求，并放入事务变更队列outstandingChanges中去。</p></li><li><p><strong>删除临时节点</strong>。</p><p>FinalRequestProcessor处理器会触发内存数据库，删除该会话对应的所有临时节点。</p></li><li><p><strong>移除会话</strong>。</p><p>完成节点删除后，要将会话从SessionTracker中移除。主要是从三个数据结构sessionsById、sessionsWithTimeout和sessionSets中移除。</p></li><li><p><strong>关闭NIOServerCnxn</strong>。</p><p>从NIOServerCnxnFactory中找到并关闭NIOServerCnxn。</p></li></ol><h3 id="4-5-会话重连"><a href="#4-5-会话重连" class="headerlink" title="4.5 会话重连"></a>4.5 会话重连</h3><p>客户端与服务端网络连接断开时，ZK客户端会自动进行反复的重连，直到最终成功连接到一台服务器，再次连上的客户端可能处于两个状态之一：</p><ul><li><strong>CONNECTED：</strong>会话超时时间内重新连接上，就是重连成功。</li><li><strong>EXPIRED：</strong>超时时间以外则服务端已进行了会话清理操作，此时连上的会话是非法会话。</li></ul><p>当客户端与服务端连接断开后，客户端可能会看到两类异常：</p><ul><li><strong>CONNECTION_LOSS</strong>（连接断开）：立即收到事件None-Disconnected通知，同时抛出异常 ConnectionLossException 。ZK客户端自动从地址列表重新逐个选取新的地址并尝试重新连接。重连后收到事件None-SyncConnected通知，此时可以重试出错的操作。</li><li><strong>SESSION_EXPIRED</strong>（会话过期）：重连时间过长，超过了会话超时时间，服务器认定这个会话已经结束并执行会话清理，但客户端并不知道会话已经失效，其客户端状态还是DISCONNECTED。之后客户端可能会重新连上服务器，并被告知会话已失效，用户要重新实例化一个ZK对象，并决定是否和如何恢复临时数据。</li></ul><p><strong>SESSION_MOVED</strong>（会话转移）：客户端与服务器1断开连接后，与服务器2连接上并延续了有效会话。3.2.0版本之前没有此概念，会有异常情况，向前一个服务器发送的请求被处理后覆盖了向后一个服务器的相同请求。3.2.0版本后提出了会话转移的概念，并封装了SessionMovedException异常。之后处理客户端请求使，首先检查会话的所有者是否是当前服务器，不是就抛出此异常，但因为客户端已和服务器断开了连接，所以无法收到这个异常的响应。只有多个客户端使用相同的sessionId/sessionPasswd创建会话时才会收到，一旦一个客户端会话创建成功，服务器就认为该sessionId对应的会话已发生转移，于是等到第二个客户端连上此服务器后就被认为是会话转移的情况。</p><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：会话状态、会话创建、会话管理（分桶策略、会话激活、会话超时检查）、会话清理、会话重连等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>ZooKeeper（五）技术内幕-客户端</title>
    <link href="http://linyishui.top/2021061101.html"/>
    <id>http://linyishui.top/2021061101.html</id>
    <published>2021-06-11T03:45:26.000Z</published>
    <updated>2021-07-18T15:35:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZooKeeper（五）技术内幕"><a href="#ZooKeeper（五）技术内幕" class="headerlink" title="ZooKeeper（五）技术内幕"></a>ZooKeeper（五）技术内幕</h1><h2 id="三-客户端"><a href="#三-客户端" class="headerlink" title="三. 客户端"></a>三. 客户端</h2><p>客户端核心组件：</p><ul><li><strong>ZooKeeper实例：</strong>客户端入口。</li><li><strong>ClientWatchManager：</strong>客户端Watcher管理器。</li><li><strong>HostProvider：</strong>客户端地址列表管理器。</li><li><strong>ClientCnxn：</strong>客户端核心线程，内部包含两个线程 SendThread 和EventThread ，前者是I/O线程负责客户端和服务端间的I/O通信，后者是事件线程负责对服务端事件进行处理。</li></ul><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010123.png"></p><p>构造函数API：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd);</span><br><span class="line">ZooKeeper(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher);</span><br></pre></td></tr></table></figure><p>客户端初始化和启动步骤：</p><ol><li>设置默认Watcher。</li><li>设置ZooKeeper服务器地址列表、</li><li>创建ClientCnxn。</li></ol><h3 id="3-1-一次会话的创建过程"><a href="#3-1-一次会话的创建过程" class="headerlink" title="3.1 一次会话的创建过程"></a>3.1 一次会话的创建过程</h3><p><strong>初始化阶段：</strong></p><ol><li><p><strong>初始化ZK对象。</strong></p><p>通过调用ZK的构造函数实例化一个ZK对象，初始化过程创建一个客户端的Watcher管理器：ClientWatcherManager。</p></li><li><p><strong>设置默认会话Watcher。</strong></p><p>如果在构造方法中传入了一个Watcher对象，客户端将其作为默认Watcher保存在ClientWatcherManager中。</p></li><li><p><strong>构造ZK服务器地址列表管理器：HostProvider。</strong></p><p>客户端将构造函数传入的服务器地址存放到服务器地址列表管理器HostProvider中。</p></li><li><p><strong>创建并初始化客户端网络连接器：ClientCnxn。</strong></p><p>首先创建一个网络连接器ClientCnxn，用来管理客户端和服务器的网络交互。同时还会初始化客户端的两个核心队列 outgoingQueue 和 pendingQueue ，分别作为客户端的请求发送队列和服务端响应的等待队列。</p><p>同时还会创建ClientCnxn的底层I/O处理器ClientCnxnSocket。</p></li><li><p><strong>初始化SendThread和EventThread。</strong></p><p>前者是I/O线程负责客户端和服务端间的I/O通信，后者是事件线程负责对服务端事件进行处理。</p><p>同时将ClientCnxnSocket分配给SendThread作为底层网络I/O处理器，并初始化EventThread的待处理事件队列waitingEvents，用于存放所有等待被客户端处理的事件。</p></li></ol><p><strong>会话创建阶段：</strong></p><ol start="6"><li><p><strong>启动SendThread和EventThread。</strong></p><p>SendThread首先判断当前客户端状态，进行一系列请理性工作，为客户端发送“会话创建”做准备。</p></li><li><p><strong>获取一个服务器地址。</strong></p><p>创建TCP连接前，SendThread首先需要获取一个ZK服务器的目标地址，通常从HostProvider随机取一个，委托给ClientCnxnSocket创建TCP连接。</p></li><li><p><strong>创建TCP连接。</strong></p><p>ClientCnxnSocket负责和服务器创建一个TCP长连接。</p></li><li><p><strong>构造ConnectRequest请求。</strong></p><p>TCP连接创建后，只是从网络TCP层面完成了客户端和服务端间的Socket连接，但还未完成会话创建。</p><p>SendThread根据当前客户端的实际设置，构造出一个ConnectRequest请求，代表了客户端试图与服务器创建一个会话。</p><p>同时ZK客户端进一步将请求包装成网络I/O层的Packet对象，放入请求发送队列 outgoingQueue 中去。</p></li><li><p><strong>发送请求。</strong></p><p>客户端请求准备完毕，开始向服务端发送请求。ClientCnxnSocket从outgoingQueue中取出一个待发送的Packet对象，将其序列化成ByteBuffer后，向服务端进行发送。</p></li></ol><p><strong>响应处理阶段：</strong></p><ol start="11"><li><p><strong>接收服务端响应。</strong></p><p>ClientCnxnSocket接收到服务端响应，首先判断当前客户端状态是否为“已初始化”，若尚未初始化完，认定该响应是会话创建请求的响应，直接交由 readConnectResult 方法来处理。</p></li><li><p><strong>处理Response。</strong></p><p>ClientCnxnSocket对接收到的服务端响应进行反序列化，得到ConnectResponse对象，从中获取到ZK服务器分配的SessionId。</p></li><li><p><strong>连接成功。</strong></p><p>连接成功，一方面通知SendThread线程，进一步对客户端进行会话参数设置，包括readTimeout和connectTimeout等，并更新客户端状态；</p><p>另一方面，通知地址管理器HostProvider当前成功连接的服务器地址。</p></li><li><p><strong>生成事件SyncConnected-None。</strong></p><p>SendThread生成事件SyncConnected-None让上层应用感知到会话成功创建，将其传递给EventThread线程。</p></li><li><p><strong>查询Watcher。</strong></p><p>EventThread收到事件后，从ClientWatcherManager中查询出对应的Watcher，针对SyncConnected-None事件直接找出步骤2存储的默认Watcher，将其放到EventThread的waitingEvents队列。</p></li><li><p><strong>处理事件。</strong></p><p>EventThread不断从waitingEvents队列中取出待处理的Watcher对象，直接调用此对象的process接口方法，以达到触发Watcher的目的。</p></li></ol><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010124.png"></p><h3 id="3-2-服务器地址列表"><a href="#3-2-服务器地址列表" class="headerlink" title="3.2 服务器地址列表"></a>3.2 服务器地址列表</h3><p>ZK构造函数中的服务器地址列表参数<strong>connectString</strong>，通常是一个使用英文逗号分隔的多个IP和端口组成的字符串：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span></span><br></pre></td></tr></table></figure><p>ZK客户端收到服务器地址列表后，首先将其放入ConnectStringParser对象封装起来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectStringParser</span> </span>&#123;</span><br><span class="line">    String chrootPath;</span><br><span class="line">    ArrayList&lt;InetSocketAddress&gt; serverAddresses = <span class="keyword">new</span> ArrayList&lt;InetSocketAddress&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（1）客户端隔离命名空间—Chroot"><a href="#（1）客户端隔离命名空间—Chroot" class="headerlink" title="（1）客户端隔离命名空间—Chroot"></a>（1）客户端隔离命名空间—Chroot</h4><p>ZooKeeper 3.2.0版本引入Chroot特性，允许每个客户端为自己设置一个命名空间（Namespace），<strong>设置了Chroot的客户端对服务器的任何操作都会被限制在命名空间下</strong>。</p><p>例如，我们要为应用X分配 <code>/apps/X</code> 下的所有子节点，应用可以将其所有ZK客户端的Chroot设置为 <code>/apps/X</code> 。对于客户端来说，节点路径都是以 <code>/apps/X</code> 为根节点，它和ZK发起的节点路径都是以这个根节点构建的相对路径。这种设计对于实现不同应用间的相互隔离很有帮助。</p><p>可以在connectString后添加后缀来设置Chroot，可以解析出Chroot保存在chrootPath属性：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">2181</span>,<span class="number">192.168.0.2:2181</span>,<span class="number">192.168.0.3:2181</span>/apps/X</span><br></pre></td></tr></table></figure><h4 id="（2）地址列表管理器—HostProvider"><a href="#（2）地址列表管理器—HostProvider" class="headerlink" title="（2）地址列表管理器—HostProvider"></a>（2）地址列表管理器—HostProvider</h4><p>ConnectStringParser会对服务器地址做简单处理，封装成InetSocketAddress对象，最后经过处理的地址列表会进一步的封装到<strong>StaticHostProvider</strong>中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HostProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> InetSocketAddress <span class="title">next</span><span class="params">(<span class="keyword">long</span> spinDelay)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnected</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010125.png"></p><p>HostProvider三要素：</p><ul><li><p><strong>next()方法必须要有合法的返回值。</strong></p><p>凡是对该方法的调用，必须要返回一个合法的InetSocketAddress对象，不能为null或不合法对象。</p></li><li><p><strong>next()方法必须返回已解析的InetSocketAddress对象。</strong></p><p>服务器地址列表保存在 <code>ConnectStringParser.serverAddresses</code> 中是没有被解析的InetSocketAddress，传递到HostProvider后才会被解析，不一定是在next()中解析，但next()返回的必须是已解析的InetSocketAddress对象。</p></li><li><p><strong>size()方法不能返回0。</strong></p><p>HostProvider必须至少有一个服务器地址。</p></li></ul><h4 id="（3）StaticHostProvider"><a href="#（3）StaticHostProvider" class="headerlink" title="（3）StaticHostProvider"></a>（3）StaticHostProvider</h4><p>StaticHostProvider是HostProvider接口的默认实现，数据结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010126.png"></p><ul><li><p><strong>解析服务器地址：</strong>对 <code>ConnectStringParser.serverAddresses</code> 中没有被解析的服务器地址逐个进行解析，再放到 serverAddresses 集合中。同时使用Collections工具类的shuffle方法来将其随机打散。</p></li><li><p><strong>获取可用的服务器地址：</strong>调用 next() 方法获取一个可用的服务器地址，其并非是简单的从集合中一次获取地址，而是将打散的地址列表先拼装成一个环形循环队列：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010127.png"></p><p>服务器地址列表可能会较少，所以当两个游标值相同时，会进行spinDelay毫秒时间的等待。</p></li></ul><h4 id="自定义HostProvider"><a href="#自定义HostProvider" class="headerlink" title="自定义HostProvider"></a>自定义HostProvider</h4><ul><li><strong>配置文件方式：</strong>ZK默认实现中是传入服务器地址列表到构造函数，可以自定义实现一个HostProvider在应用启动时加载配置文件来实现地址列表的获取。</li><li><strong>动态变更的地址列表管理器：</strong>ZK集群的整体迁移或个别机器变更，会导致大批客户端应用也要一起变更，因为我们将IP地址写死在程序中。可以实现一个HostProvider能定时从DNS或配置管理中心上解析出ZK服务器地址列表，当地址列表变更时，同步更新到serverAddresses集合。</li><li><strong>实现同机房优先策略：</strong>项目规模扩大到一定程度，可能出现多机房或异地机房，如何解决不同机房之间的延时（通常可能会达到几十毫秒）？引入同机房优先策略，服务的消费者优先消费同一个机房的服务，实现一个HostProvider能优先和同机房的ZK服务器创建会话。</li></ul><h3 id="3-3-ClientCnxn-网络I-O"><a href="#3-3-ClientCnxn-网络I-O" class="headerlink" title="3.3 ClientCnxn-网络I/O"></a>3.3 ClientCnxn-网络I/O</h3><p>ClientCnxn负责客户端与服务端之间的网络连接并进行一系列网络通信。</p><h4 id="（1）Packet"><a href="#（1）Packet" class="headerlink" title="（1）Packet"></a>（1）Packet</h4><p>Packet是对协议层的封装，作为请求和响应的载体，ClientCnxn的静态内部类，结构：</p><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010128.png"></p><p>Packet的createBB()方法负责对Packet对象进行序列化，最终生成用于网络传输的ByteBuffer对象。这个过程<strong>只会将 requestHeader、request和readOnly三个属性序列化</strong>，其余都保存在客户端的上下文中不会参与网络传输。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Packet</span> </span>&#123;</span><br><span class="line">    RequestHeader requestHeader;</span><br><span class="line">    ReplyHeader replyHeader;</span><br><span class="line">    Record request;</span><br><span class="line">    Record response;</span><br><span class="line">    ByteBuffer bb;</span><br><span class="line">    String clientPath;</span><br><span class="line">    String serverPath;</span><br><span class="line">    <span class="keyword">boolean</span> finished;</span><br><span class="line">    AsyncCallback cb;</span><br><span class="line">    Object ctx;</span><br><span class="line">    WatchRegistration watchRegistration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> readOnly;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">            boa.writeInt(-<span class="number">1</span>, <span class="string">&quot;len&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.requestHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// requestHeader被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.requestHeader.serialize(boa, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.request <span class="keyword">instanceof</span> ConnectRequest) &#123;</span><br><span class="line">                <span class="comment">// request和readOnly被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">                boa.writeBool(<span class="keyword">this</span>.readOnly, <span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// request被序列化</span></span><br><span class="line">                <span class="keyword">this</span>.request.serialize(boa, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="keyword">this</span>.bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line">            <span class="keyword">this</span>.bb.putInt(<span class="keyword">this</span>.bb.capacity() - <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.bb.rewind();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Ignoring unexpected exception&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（2）outgoingQueue和pendingQueue"><a href="#（2）outgoingQueue和pendingQueue" class="headerlink" title="（2）outgoingQueue和pendingQueue"></a>（2）outgoingQueue和pendingQueue</h4><ul><li>outgoingQueue：客户端请求发送队列，存储那些需要发送到服务端的Packet集合。</li><li>pendingQueue：服务端响应等待队列，存储已经从客户端发送到服务端，但需要等待响应的Packet集合。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressFBWarnings(&#123;&quot;EI_EXPOSE_REP&quot;, &quot;EI_EXPOSE_REP2&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxn.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SET_WATCHES_MAX_LENGTH = <span class="number">131072</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> disableAutoWatchReset = Boolean.getBoolean(<span class="string">&quot;zookeeper.disableAutoWatchReset&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;ClientCnxn.AuthData&gt; authInfo;</span><br><span class="line">    <span class="comment">// 链表结构</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; pendingQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ClientCnxn.Packet&gt; outgoingQueue;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><h4 id="（3）底层Socket通信层—ClientCnxnSocket"><a href="#（3）底层Socket通信层—ClientCnxnSocket" class="headerlink" title="（3）底层Socket通信层—ClientCnxnSocket"></a>（3）底层Socket通信层—ClientCnxnSocket</h4><p>3.4.0版本后，从ClientCnxn中抽离出ClientCnxnSocket（抽象类），使客户端代码结构更清晰的同时也便于对底层Socket通信层进行扩展（如使用Netty实现）。</p><p>可以通过在 <code>zookeeper.clientCnxnSocket</code> 这个系统变量中配置 ClientCnxnSocket 实现类的全类名，来指定自定义实现：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZK默认实现即ClientCnxnSocketNIO，使用Java原生的NIO接口，核心是doIO逻辑，负责对请求的发生和响应接收过程</span></span><br><span class="line"><span class="meta">-Dzookeeper.clientCnxnSocket</span>=<span class="string">org.apache.zookeeper.ClientCnxnSocketNIO</span></span><br></pre></td></tr></table></figure><ul><li><p><strong>请求发送：</strong></p><ul><li>从outgoingQueue队列提取出一个可发送的Packet对象，同时生成一个客户端请求序号XID并将其设置到Packet请求头中，再将其序列化后发送。</li><li>可发送是指，检测到客户端与服务端之间正在处理SASL权限时，不包含请求头（requestHeader）的Packet（如会话创建请求）可以被发送，其余都无法发送。</li><li>发送完毕，会立即将Packet保存到pendingQueue队列。</li></ul></li><li><p><strong>响应接收：</strong>客户端收到服务端的完整响应数据后，不同的客户端请求类型会进行不同的处理</p><ul><li>如果检测到<strong>当前客户端尚未进行初始化</strong>，说明当前客户端与服务端之间正在进行会话创建，直接将接收到的ByteBuffer（incomingBuffer）序列化为ConnectResponse对象。</li><li>如果当前客户端已经处于正常的会话周期，且<strong>接收到的服务端响应是一个事件</strong>，将接收到的ByteBuffer（incomingBuffer）序列化为WatcherEvent对象，并将其放入待处理队列中。</li><li>如果是一个<strong>常规的请求响应</strong>（Create、GetData和Exist等操作请求），会从pendingQueue队列中取出一个Packet来进行相应的处理。客户端首先通过检验服务端响应中包含的XID值来确保请求处理的顺序性，然后再将接收到的ByteBuffer（incomingBuffer）序列化为相应的Response对象。</li></ul><p>最终会在 ClientCnxn.finishPacket 方法中处理 Watcher 注册等逻辑。</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(ClientCnxn.Packet p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 错误码不为0则将Watcher添加到clientPath为key的数组</span></span><br><span class="line">        p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有回调函数，更新Packet为终止，唤醒等待的线程</span></span><br><span class="line">        <span class="keyword">synchronized</span>(p) &#123;</span><br><span class="line">            p.finished = <span class="keyword">true</span>;</span><br><span class="line">            p.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 有回调函数，更新Packet为终止，增加到事件队列</span></span><br><span class="line">        p.finished = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.eventThread.queuePacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210601/202106010129.png"></p><p>抽象类ClientCnxnSocket定义了一些抽象方法，和readConnectResult的默认实现等：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocket.class);</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ByteBuffer lenBuffer = ByteBuffer.allocateDirect(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">protected</span> ByteBuffer incomingBuffer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sentCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> recvCount;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastHeard;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> lastSend;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> now;</span><br><span class="line">    <span class="keyword">protected</span> SendThread sendThread;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sessionId;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocket() &#123;</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">        <span class="keyword">this</span>.sentCount = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">this</span>.recvCount = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">introduce</span><span class="params">(SendThread sendThread, <span class="keyword">long</span> sessionId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sendThread = sendThread;</span><br><span class="line">        <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.now = Time.currentElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleRecv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastHeard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getIdleSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(<span class="keyword">this</span>.now - <span class="keyword">this</span>.lastSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getSentCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getRecvCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.recvCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateLastSendAndHeard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastSend = <span class="keyword">this</span>.now;</span><br><span class="line">        <span class="keyword">this</span>.lastHeard = <span class="keyword">this</span>.now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="keyword">this</span>.incomingBuffer.getInt();</span><br><span class="line">        <span class="keyword">if</span> (len &gt;= <span class="number">0</span> &amp;&amp; len &lt; ClientCnxn.packetLen) &#123;</span><br><span class="line">            <span class="keyword">this</span>.incomingBuffer = ByteBuffer.allocate(len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Packet len&quot;</span> + len + <span class="string">&quot; is out of range!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readConnectResult</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;0x[&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] var2 = <span class="keyword">this</span>.incomingBuffer.array();</span><br><span class="line">            <span class="keyword">int</span> var3 = var2.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">                <span class="keyword">byte</span> b = var2[var4];</span><br><span class="line">                buf.append(Integer.toHexString(b) + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buf.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            LOG.trace(<span class="string">&quot;readConnectResult &quot;</span> + <span class="keyword">this</span>.incomingBuffer.remaining() + <span class="string">&quot; &quot;</span> + buf.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ConnectResponse conRsp = <span class="keyword">new</span> ConnectResponse();</span><br><span class="line">        conRsp.deserialize(bbia, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isRO = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isRO = bbia.readBool(<span class="string">&quot;readOnly&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Connected to an old server; r-o mode will be unavailable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sessionId = conRsp.getSessionId();</span><br><span class="line">        <span class="keyword">this</span>.sendThread.onConnected(conRsp.getTimeOut(), <span class="keyword">this</span>.sessionId, conRsp.getPasswd(), isRO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> var1, List&lt;Packet&gt; var2, LinkedList&lt;Packet&gt; var3, ClientCnxn var4)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet var1)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认实现ClientCnxnSocketNIO：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientCnxnSocketNIO</span> <span class="keyword">extends</span> <span class="title">ClientCnxnSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(ClientCnxnSocketNIO.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector = Selector.open();</span><br><span class="line">    <span class="keyword">private</span> SelectionKey sockKey;</span><br><span class="line"></span><br><span class="line">    ClientCnxnSocketNIO() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sockKey != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doIO</span><span class="params">(List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">int</span> rc = sock.read(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException(<span class="string">&quot;Unable to read additional data from server sessionid 0x&quot;</span> + Long.toHexString(<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, likely server has closed socket&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.incomingBuffer.hasRemaining()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.incomingBuffer.flip();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.incomingBuffer == <span class="keyword">this</span>.lenBuffer) &#123;</span><br><span class="line">                        ++<span class="keyword">this</span>.recvCount;</span><br><span class="line">                        <span class="keyword">this</span>.readLength();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.readConnectResult();</span><br><span class="line">                        <span class="keyword">this</span>.enableRead();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                        <span class="keyword">this</span>.initialized = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendThread.readResponse(<span class="keyword">this</span>.incomingBuffer);</span><br><span class="line">                        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">                        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastHeard();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey.isWritable()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                    Packet p = <span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress());</span><br><span class="line">                    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.updateLastSend();</span><br><span class="line">                        <span class="keyword">if</span> (p.bb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                p.requestHeader.setXid(cnxn.getXid());</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            p.createBB();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        sock.write(p.bb);</span><br><span class="line">                        <span class="keyword">if</span> (!p.bb.hasRemaining()) &#123;</span><br><span class="line">                            ++<span class="keyword">this</span>.sentCount;</span><br><span class="line">                            outgoingQueue.removeFirstOccurrence(p);</span><br><span class="line">                            <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span> &amp;&amp; p.requestHeader.getType() != <span class="number">11</span> &amp;&amp; p.requestHeader.getType() != <span class="number">100</span>) &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span>(pendingQueue) &#123;</span><br><span class="line">                                    pendingQueue.add(p);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !p.bb.hasRemaining()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.disableWrite();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Packet <span class="title">findSendablePacket</span><span class="params">(LinkedList&lt;Packet&gt; outgoingQueue, <span class="keyword">boolean</span> clientTunneledAuthenticationInProgress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((Packet)outgoingQueue.getFirst()).bb == <span class="keyword">null</span> &amp;&amp; clientTunneledAuthenticationInProgress) &#123;</span><br><span class="line">                ListIterator iter = outgoingQueue.listIterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">                    Packet p = (Packet)iter.next();</span><br><span class="line">                    <span class="keyword">if</span> (p.requestHeader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        iter.remove();</span><br><span class="line">                        outgoingQueue.add(<span class="number">0</span>, p);</span><br><span class="line">                        <span class="keyword">return</span> p;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        LOG.debug(<span class="string">&quot;deferring non-priming packet: &quot;</span> + p + <span class="string">&quot;until SASL authentication completes.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (Packet)outgoingQueue.getFirst();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sockKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">            <span class="keyword">this</span>.sockKey.cancel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownInput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown input&quot;</span>, var7);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().shutdownOutput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during shutdown output&quot;</span>, var6);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.socket().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during socket close&quot;</span>, var5);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sock.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.debug(<span class="string">&quot;Ignoring exception during channel close&quot;</span>, var4);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var3) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;SendThread interrupted during sleep, ignoring&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.sockKey = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Doing client selector close&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.selector.close();</span><br><span class="line">            <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                LOG.trace(<span class="string">&quot;Closed client selector&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Ignoring exception during selector close&quot;</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketChannel <span class="title">createSock</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = SocketChannel.open();</span><br><span class="line">        sock.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        sock.socket().setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">        sock.socket().setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> sock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerAndConnect</span><span class="params">(SocketChannel sock, InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey = sock.register(<span class="keyword">this</span>.selector, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">boolean</span> immediateConnect = sock.connect(addr);</span><br><span class="line">        <span class="keyword">if</span> (immediateConnect) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = <span class="keyword">this</span>.createSock();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.registerAndConnect(sock, addr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Unable to open socket to &quot;</span> + addr);</span><br><span class="line">            sock.close();</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initialized = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.lenBuffer.clear();</span><br><span class="line">        <span class="keyword">this</span>.incomingBuffer = <span class="keyword">this</span>.lenBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getRemoteSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getRemoteSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">SocketAddress <span class="title">getLocalSocketAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().getLocalSocketAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">wakeupCnxn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.wakeup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTransport</span><span class="params">(<span class="keyword">int</span> waitTimeOut, List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.select((<span class="keyword">long</span>)waitTimeOut);</span><br><span class="line">        Set selected;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">            selected = <span class="keyword">this</span>.selector.selectedKeys();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.updateNow();</span><br><span class="line">        Iterator var6 = selected.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">            SelectionKey k = (SelectionKey)var6.next();</span><br><span class="line">            SocketChannel sc = (SocketChannel)k.channel();</span><br><span class="line">            <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">8</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sc.finishConnect()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateLastSendAndHeard();</span><br><span class="line">                    <span class="keyword">this</span>.sendThread.primeConnection();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; <span class="number">5</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.doIO(pendingQueue, outgoingQueue, cnxn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sendThread.getZkState().isConnected()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.findSendablePacket(outgoingQueue, cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.enableWrite();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        selected.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;testableCloseSocket() called&quot;</span>);</span><br><span class="line">        ((SocketChannel)<span class="keyword">this</span>.sockKey.channel()).socket().close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">disableWrite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i &amp; -<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.sockKey.interestOps();</span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sockKey.interestOps(i | <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enableReadWriteOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sockKey.interestOps(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Selector <span class="title">getSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.selector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sock = (SocketChannel)<span class="keyword">this</span>.sockKey.channel();</span><br><span class="line">        <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.createBB();</span><br><span class="line">            ByteBuffer pbb = p.bb;</span><br><span class="line">            sock.write(pbb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="（4）SendThread"><a href="#（4）SendThread" class="headerlink" title="（4）SendThread"></a>（4）SendThread</h4><p>SendThread是客户端ClientCnxn内部一个核心的I/O调度线程，维护了客户端与服务端之间的会话生命周期，通过在一定的周期频率内向服务端发送一个PING包来实现心跳检测。会话周期内一旦TCP连接断开，就会自动且透明化的完成重连操作。</p><p>管理了客户端所有请求发送和响应接收操作，将上层客户端API操作转换为相应的请求协议并发送到服务端，完成对同步调用的返回和异步调用的回调。还负责将来自服务端的事件传递给EventThread处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastPingSentNs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientCnxnSocket clientCnxnSocket;</span><br><span class="line">    <span class="keyword">private</span> Random r = <span class="keyword">new</span> Random(System.nanoTime());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstConnect = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> InetSocketAddress rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> minPingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> maxPingRwTimeout = <span class="number">60000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RETRY_CONN_MSG = <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取响应信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">        BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">        ReplyHeader replyHdr = <span class="keyword">new</span> ReplyHeader();</span><br><span class="line">        replyHdr.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">        <span class="comment">// 请求和响应序号为负值的几种特殊情况，-1为通知，-2为ping请求，-4权限</span></span><br><span class="line">        <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got ping response for sessionid: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; after &quot;</span> + (System.nanoTime() - <span class="keyword">this</span>.lastPingSentNs) / <span class="number">1000000L</span> + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (replyHdr.getErr() == Code.AUTHFAILED.intValue()) &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got auth sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got notification sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建监听事件，将响应内容反序列化</span></span><br><span class="line">            WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">            event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="comment">// 如果相对路径不为空，处理下路径</span></span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String serverPath = event.getPath();</span><br><span class="line">                <span class="keyword">if</span> (serverPath.compareTo(ClientCnxn.<span class="keyword">this</span>.chrootPath) == <span class="number">0</span>) &#123;</span><br><span class="line">                    event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; ClientCnxn.<span class="keyword">this</span>.chrootPath.length()) &#123;</span><br><span class="line">                    event.setPath(serverPath.substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Got server path &quot;</span> + event.getPath() + <span class="string">&quot; which is too short for chroot path &quot;</span> + ClientCnxn.<span class="keyword">this</span>.chrootPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// WatcherEvent再封装为WatchedEvent，并加入eventThread队列</span></span><br><span class="line">            WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">            <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                ClientCnxn.LOG.debug(<span class="string">&quot;Got &quot;</span> + we + <span class="string">&quot; for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(we);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.clientTunneledAuthenticationInProgress()) &#123;</span><br><span class="line">            <span class="comment">// 开启SASL</span></span><br><span class="line">            GetSASLRequest request = <span class="keyword">new</span> GetSASLRequest();</span><br><span class="line">            request.deserialize(bbia, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.respondToServer(request.getToken(), ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非特殊情况</span></span><br><span class="line">            ClientCnxn.Packet packet;</span><br><span class="line">            <span class="comment">// 锁住响应队列，移出Packet</span></span><br><span class="line">            <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.pendingQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Nothing in the queue, but got &quot;</span> + replyHdr.getXid());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                packet = (ClientCnxn.Packet)ClientCnxn.<span class="keyword">this</span>.pendingQueue.remove();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 响应序号和请求序号不匹配，抛出异常</span></span><br><span class="line">                <span class="keyword">if</span> (packet.requestHeader.getXid() != replyHdr.getXid()) &#123;</span><br><span class="line">                    packet.replyHeader.setErr(Code.CONNECTIONLOSS.intValue());</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xid out of order. Got Xid &quot;</span> + replyHdr.getXid() + <span class="string">&quot; with err &quot;</span> + replyHdr.getErr() + <span class="string">&quot; expected Xid &quot;</span> + packet.requestHeader.getXid() + <span class="string">&quot; for a packet with details: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将响应反序列化出的header信息塞入Packet对象</span></span><br><span class="line">                packet.replyHeader.setXid(replyHdr.getXid());</span><br><span class="line">                packet.replyHeader.setErr(replyHdr.getErr());</span><br><span class="line">                packet.replyHeader.setZxid(replyHdr.getZxid());</span><br><span class="line">                <span class="keyword">if</span> (replyHdr.getZxid() &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.lastZxid = replyHdr.getZxid();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// response反序列化塞入Packet对象</span></span><br><span class="line">                <span class="keyword">if</span> (packet.response != <span class="keyword">null</span> &amp;&amp; replyHdr.getErr() == <span class="number">0</span>) &#123;</span><br><span class="line">                    packet.response.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    ClientCnxn.LOG.debug(<span class="string">&quot;Reading reply sessionid:0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, packet:: &quot;</span> + packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 最终注册下Watch等</span></span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.finishPacket(packet);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SendThread(ClientCnxnSocket clientCnxnSocket) &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-SendThread()&quot;</span>));</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket = clientCnxnSocket;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">States <span class="title">getZkState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ClientCnxnSocket <span class="title">getClientCnxnSocket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.clientCnxnSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">primeConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Socket connection established to &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, initiating session&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.isFirstConnect = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">long</span> sessId = ClientCnxn.<span class="keyword">this</span>.seenRwServerBefore ? ClientCnxn.<span class="keyword">this</span>.sessionId : <span class="number">0L</span>;</span><br><span class="line">        ConnectRequest conReq = <span class="keyword">new</span> ConnectRequest(<span class="number">0</span>, ClientCnxn.<span class="keyword">this</span>.lastZxid, ClientCnxn.<span class="keyword">this</span>.sessionTimeout, sessId, ClientCnxn.<span class="keyword">this</span>.sessionPasswd);</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.disableAutoWatchReset) &#123;</span><br><span class="line">                List&lt;String&gt; dataWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getDataWatches();</span><br><span class="line">                List&lt;String&gt; existWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getExistWatches();</span><br><span class="line">                List&lt;String&gt; childWatches = ClientCnxn.<span class="keyword">this</span>.zooKeeper.getChildWatches();</span><br><span class="line">                <span class="keyword">if</span> (!dataWatches.isEmpty() || !existWatches.isEmpty() || !childWatches.isEmpty()) &#123;</span><br><span class="line">                    Iterator&lt;String&gt; dataWatchesIter = <span class="keyword">this</span>.prependChroot(dataWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; existWatchesIter = <span class="keyword">this</span>.prependChroot(existWatches).iterator();</span><br><span class="line">                    Iterator&lt;String&gt; childWatchesIter = <span class="keyword">this</span>.prependChroot(childWatches).iterator();</span><br><span class="line">                    <span class="keyword">long</span> setWatchesLastZxid = ClientCnxn.<span class="keyword">this</span>.lastZxid;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(dataWatchesIter.hasNext() || existWatchesIter.hasNext() || childWatchesIter.hasNext()) &#123;</span><br><span class="line">                        List&lt;String&gt; dataWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; existWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        List&lt;String&gt; childWatchesBatch = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">                        String watch;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> batchLength = <span class="number">0</span>; batchLength &lt; <span class="number">131072</span>; batchLength += watch.length()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (dataWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)dataWatchesIter.next();</span><br><span class="line">                                dataWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (existWatchesIter.hasNext()) &#123;</span><br><span class="line">                                watch = (String)existWatchesIter.next();</span><br><span class="line">                                existWatchesBatch.add(watch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!childWatchesIter.hasNext()) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                watch = (String)childWatchesIter.next();</span><br><span class="line">                                childWatchesBatch.add(watch);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        SetWatches sw = <span class="keyword">new</span> SetWatches(setWatchesLastZxid, dataWatchesBatch, existWatchesBatch, childWatchesBatch);</span><br><span class="line">                        RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">                        h.setType(<span class="number">101</span>);</span><br><span class="line">                        h.setXid(-<span class="number">8</span>);</span><br><span class="line">                        ClientCnxn.Packet packet = <span class="keyword">new</span> ClientCnxn.Packet(h, <span class="keyword">new</span> ReplyHeader(), sw, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">                        ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(packet);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Iterator var22 = ClientCnxn.<span class="keyword">this</span>.authInfo.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var22.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet((RequestHeader)<span class="keyword">null</span>, (ReplyHeader)<span class="keyword">null</span>, conReq, (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>, ClientCnxn.<span class="keyword">this</span>.readOnly));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ClientCnxn.AuthData id = (ClientCnxn.AuthData)var22.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.outgoingQueue.addFirst(<span class="keyword">new</span> ClientCnxn.Packet(<span class="keyword">new</span> RequestHeader(-<span class="number">4</span>, <span class="number">100</span>), (ReplyHeader)<span class="keyword">null</span>, <span class="keyword">new</span> AuthPacket(<span class="number">0</span>, id.scheme, id.data), (Record)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.enableReadWriteOnly();</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">            ClientCnxn.LOG.debug(<span class="string">&quot;Session establishment request sent on &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">prependChroot</span><span class="params">(List&lt;String&gt; paths)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.chrootPath != <span class="keyword">null</span> &amp;&amp; !paths.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.size(); ++i) &#123;</span><br><span class="line">                String clientPath = (String)paths.get(i);</span><br><span class="line">                String serverPath;</span><br><span class="line">                <span class="keyword">if</span> (clientPath.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    serverPath = ClientCnxn.<span class="keyword">this</span>.chrootPath + clientPath;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                paths.set(i, serverPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run()调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastPingSentNs = System.nanoTime();</span><br><span class="line">        <span class="comment">// 序号固定为-2</span></span><br><span class="line">        RequestHeader h = <span class="keyword">new</span> RequestHeader(-<span class="number">2</span>, <span class="number">11</span>);</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.queuePacket(h, (ReplyHeader)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (Record)<span class="keyword">null</span>, (AsyncCallback)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>, (WatchRegistration)<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始连接，run()调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startConnect</span><span class="params">(InetSocketAddress addr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">false</span>;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CONNECTING;</span><br><span class="line">        <span class="keyword">this</span>.setName(<span class="keyword">this</span>.getName().replaceAll(<span class="string">&quot;\\(.*\\)&quot;</span>, <span class="string">&quot;(&quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort() + <span class="string">&quot;)&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="comment">// SASL开启时，实例化客户端</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient = <span class="keyword">new</span> ZooKeeperSaslClient(SaslServerPrincipal.getServerPrincipal(addr));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LoginException var3) &#123;</span><br><span class="line">                ClientCnxn.LOG.warn(<span class="string">&quot;SASL configuration failed: &quot;</span> + var3 + <span class="string">&quot; Will continue connection to Zookeeper server without SASL authentication, if Zookeeper server allows it.&quot;</span>);</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.AuthFailed, (String)<span class="keyword">null</span>));</span><br><span class="line">                <span class="keyword">this</span>.saslLoginFailed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.logStartConnect(addr);</span><br><span class="line">        <span class="comment">// 注册并连接Socket</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.connect(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logStartConnect</span><span class="params">(InetSocketAddress addr)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="string">&quot;Opening socket connection to server &quot;</span> + addr;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg = msg + <span class="string">&quot;. &quot;</span> + ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getConfigStatus();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ClientCnxnSocket构建会话和Thread，更新几个参数属性</span></span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.introduce(<span class="keyword">this</span>, ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">        <span class="keyword">long</span> lastPingRwServer = Time.currentElapsedTime();</span><br><span class="line">        <span class="keyword">int</span> MAX_SEND_PING_INTERVAL = <span class="keyword">true</span>;</span><br><span class="line">        InetSocketAddress serverAddress = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态存活一直循环</span></span><br><span class="line">        <span class="keyword">while</span>(ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Socket还未连接上，则更具</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.clientCnxnSocket.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// 当前非首次连接就休眠等待(0到1000的随机数)，等待连接建立</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.isFirstConnect) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep((<span class="keyword">long</span>)<span class="keyword">this</span>.r.nextInt(<span class="number">1000</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">                            ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var10);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果已经结束则跳出循环</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing || !ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取服务器地址</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.rwServerAddress != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        serverAddress = <span class="keyword">this</span>.rwServerAddress;</span><br><span class="line">                        <span class="keyword">this</span>.rwServerAddress = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        serverAddress = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">1000L</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 调用startConnect建立连接</span></span><br><span class="line">                    <span class="keyword">this</span>.startConnect(serverAddress);</span><br><span class="line">                    <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> to;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// 当前已连接</span></span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> sendAuthEvent = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getSaslState() == SaslState.INITIAL) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.initialize(ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (SaslException var9) &#123;</span><br><span class="line">                                ClientCnxn.LOG.error(<span class="string">&quot;SASL authentication with Zookeeper Quorum member failed: &quot;</span> + var9);</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        KeeperState authState = ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.getKeeperState();</span><br><span class="line">                        <span class="keyword">if</span> (authState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (authState == KeeperState.AuthFailed) &#123;</span><br><span class="line">                                ClientCnxn.<span class="keyword">this</span>.state = States.AUTH_FAILED;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (authState == KeeperState.SaslAuthenticated) &#123;</span><br><span class="line">                                sendAuthEvent = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (sendAuthEvent) &#123;</span><br><span class="line">                            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, authState, (String)<span class="keyword">null</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.readTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 当前还未连接</span></span><br><span class="line">                    to = ClientCnxn.<span class="keyword">this</span>.connectTimeout - <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 会话超时</span></span><br><span class="line">                <span class="keyword">if</span> (to &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    String warnInfo = <span class="string">&quot;Client session timed out, have not heard from server in &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getIdleRecv() + <span class="string">&quot;ms for sessionid 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId);</span><br><span class="line">                    ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionTimeoutException(warnInfo);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 已连接则定时发送Ping</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isConnected()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> timeToNextPing = ClientCnxn.<span class="keyword">this</span>.readTimeout / <span class="number">2</span> - <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() - (<span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &gt; <span class="number">1000</span> ? <span class="number">1000</span> : <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (timeToNextPing &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.clientCnxnSocket.getIdleSend() &lt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (timeToNextPing &lt; to) &#123;</span><br><span class="line">                            to = timeToNextPing;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendPing();</span><br><span class="line">                        <span class="keyword">this</span>.clientCnxnSocket.updateLastSend();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// CONNECTED_READ_ONLY状态，更新to</span></span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state == States.CONNECTEDREADONLY) &#123;</span><br><span class="line">                    <span class="keyword">long</span> now = Time.currentElapsedTime();</span><br><span class="line">                    <span class="keyword">int</span> idlePingRwServer = (<span class="keyword">int</span>)(now - lastPingRwServer);</span><br><span class="line">                    <span class="keyword">if</span> (idlePingRwServer &gt;= <span class="keyword">this</span>.pingRwTimeout) &#123;</span><br><span class="line">                        lastPingRwServer = now;</span><br><span class="line">                        idlePingRwServer = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">this</span>.pingRwTimeout = Math.min(<span class="number">2</span> * <span class="keyword">this</span>.pingRwTimeout, <span class="number">60000</span>);</span><br><span class="line">                        <span class="keyword">this</span>.pingRwServer();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    to = Math.min(to, <span class="keyword">this</span>.pingRwTimeout - idlePingRwServer);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用底层传输接口</span></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.doTransport(to, ClientCnxn.<span class="keyword">this</span>.pendingQueue, ClientCnxn.<span class="keyword">this</span>.outgoingQueue, ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.closing) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ClientCnxn.LOG.isDebugEnabled()) &#123;</span><br><span class="line">                        ClientCnxn.LOG.debug(<span class="string">&quot;An exception was thrown while closing send thread for session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()) + <span class="string">&quot; : &quot;</span> + var11.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionExpiredException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.SessionTimeoutException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.EndOfStreamException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage() + <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> ClientCnxn.RWServerFoundException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var11 <span class="keyword">instanceof</span> SocketException) &#123;</span><br><span class="line">                    ClientCnxn.LOG.info(<span class="string">&quot;Socket error occurred: &#123;&#125;: &#123;&#125;&quot;</span>, serverAddress, var11.getMessage());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Session 0x&#123;&#125; for server &#123;&#125;, unexpected error&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()), serverAddress, <span class="string">&quot;, closing socket connection and attempting reconnect&quot;</span>, var11&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.cleanup();</span><br><span class="line">                <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateNow();</span><br><span class="line">                <span class="keyword">this</span>.clientCnxnSocket.updateLastSendAndHeard();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环结束，终止状态</span></span><br><span class="line">        <span class="keyword">this</span>.cleanup();</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.close();</span><br><span class="line">        <span class="comment">// 若此时状态还是存活，发送断开连接事件</span></span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.state.isAlive()) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Disconnected, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZooTrace.logTraceMessage(ClientCnxn.LOG, ZooTrace.getTextTraceLevel(), <span class="string">&quot;SendThread exited loop for session: 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pingRwServer</span><span class="params">()</span> <span class="keyword">throws</span> ClientCnxn.RWServerFoundException, UnknownHostException </span>&#123;</span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line">        InetSocketAddress addr = ClientCnxn.<span class="keyword">this</span>.hostProvider.next(<span class="number">0L</span>);</span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;Checking server &quot;</span> + addr + <span class="string">&quot; for being r/w. Timeout &quot;</span> + <span class="keyword">this</span>.pingRwTimeout);</span><br><span class="line">        Socket sock = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sock = <span class="keyword">new</span> Socket(addr.getHostName(), addr.getPort());</span><br><span class="line">            sock.setSoLinger(<span class="keyword">false</span>, -<span class="number">1</span>);</span><br><span class="line">            sock.setSoTimeout(<span class="number">1000</span>);</span><br><span class="line">            sock.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">            sock.getOutputStream().write(<span class="string">&quot;isro&quot;</span>.getBytes());</span><br><span class="line">            sock.getOutputStream().flush();</span><br><span class="line">            sock.shutdownOutput();</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(sock.getInputStream()));</span><br><span class="line">            result = br.readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConnectException var21) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var22) &#123;</span><br><span class="line">            ClientCnxn.LOG.warn(<span class="string">&quot;Exception while seeking for r/w server &quot;</span> + var22.getMessage(), var22);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sock.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var20) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var20);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var19) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, var19);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;rw&quot;</span>.equals(result)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pingRwTimeout = <span class="number">100</span>;</span><br><span class="line">            <span class="keyword">this</span>.rwServerAddress = addr;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.RWServerFoundException(<span class="string">&quot;Majority server found at &quot;</span> + addr.getHostName() + <span class="string">&quot;:&quot;</span> + addr.getPort());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.cleanup();</span><br><span class="line">        Iterator var2;</span><br><span class="line">        ClientCnxn.Packet p;</span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.pendingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.pendingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                    ClientCnxn.<span class="keyword">this</span>.pendingQueue.clear();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(ClientCnxn.<span class="keyword">this</span>.outgoingQueue) &#123;</span><br><span class="line">            var2 = ClientCnxn.<span class="keyword">this</span>.outgoingQueue.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">                p = (ClientCnxn.Packet)var2.next();</span><br><span class="line">                ClientCnxn.<span class="keyword">this</span>.conLossPacket(p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.outgoingQueue.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnected</span><span class="params">(<span class="keyword">int</span> _negotiatedSessionTimeout, <span class="keyword">long</span> _sessionId, <span class="keyword">byte</span>[] _sessionPasswd, <span class="keyword">boolean</span> isRO)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout = _negotiatedSessionTimeout;</span><br><span class="line">        <span class="keyword">if</span> (ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, KeeperState.Expired, (String)<span class="keyword">null</span>));</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEventOfDeath();</span><br><span class="line">            String warnInfo = <span class="string">&quot;Unable to reconnect to ZooKeeper service, session 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot; has expired&quot;</span>;</span><br><span class="line">            ClientCnxn.LOG.warn(warnInfo);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClientCnxn.SessionExpiredException(warnInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ClientCnxn.<span class="keyword">this</span>.readOnly &amp;&amp; isRO) &#123;</span><br><span class="line">                ClientCnxn.LOG.error(<span class="string">&quot;Read/write client got connected to read-only server&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.readTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.connectTimeout = ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout / ClientCnxn.<span class="keyword">this</span>.hostProvider.size();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.hostProvider.onConnected();</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionId = _sessionId;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.sessionPasswd = _sessionPasswd;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.state = isRO ? States.CONNECTEDREADONLY : States.CONNECTED;</span><br><span class="line">            ClientCnxn var10000 = ClientCnxn.<span class="keyword">this</span>;</span><br><span class="line">            var10000.seenRwServerBefore |= !isRO;</span><br><span class="line">            ClientCnxn.LOG.info(<span class="string">&quot;Session establishment complete on server &quot;</span> + <span class="keyword">this</span>.clientCnxnSocket.getRemoteSocketAddress() + <span class="string">&quot;, sessionid = 0x&quot;</span> + Long.toHexString(ClientCnxn.<span class="keyword">this</span>.sessionId) + <span class="string">&quot;, negotiated timeout = &quot;</span> + ClientCnxn.<span class="keyword">this</span>.negotiatedSessionTimeout + (isRO ? <span class="string">&quot; (READ-ONLY mode)&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            KeeperState eventState = isRO ? KeeperState.ConnectedReadOnly : KeeperState.SyncConnected;</span><br><span class="line">            ClientCnxn.<span class="keyword">this</span>.eventThread.queueEvent(<span class="keyword">new</span> WatchedEvent(EventType.None, eventState, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ClientCnxn.<span class="keyword">this</span>.state = States.CLOSED;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.wakeupCnxn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testableCloseSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.testableCloseSocket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">clientTunneledAuthenticationInProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ZooKeeperSaslClient.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.saslLoginFailed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient == <span class="keyword">null</span> ? <span class="keyword">true</span> : ClientCnxn.<span class="keyword">this</span>.zooKeeperSaslClient.clientTunneledAuthenticationInProgress();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendPacket</span><span class="params">(ClientCnxn.Packet p)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientCnxnSocket.sendPacket(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="（5）EventThread"><a href="#（5）EventThread" class="headerlink" title="（5）EventThread"></a>（5）EventThread</h4><p>EventThread是ClientCnxn的内部类，负责客户端的事件处理，并触发客户端注册的Watcher监听。EventThread中有一个waitingEvents队列，用于临时存放那些需要被触发的Object，包括客户端注册的Watcher和异步接口中注册的回调器 AsyncCallback。</p><p>EventThread会不断从waitingEvents中取出Object，识别出其具体类型，并分别调用process和processResult接口方法来实现对事件的触发和回调。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EventThread线程不断的从waitingEvents这个队列中取出Object，识别出其具体类型Watcher或者AsyncCallback，并分别调用process和processResult接口方法来实现对事件的触发和回调。</span></span><br><span class="line"><span class="comment">// watcher就是数据变更通知</span></span><br><span class="line"><span class="comment">// AsyncCallback是ZooKeeper客户端的API命令中的异步API，ZooKeeper客户端的API，创建节点、删除节点、检测节点是否存在、权限控制、获取子节点、获取数据内容、设置权限、设置数据内容都有相应的异步方式，有StringCallback、VoidCallback、StatCallback、ACLCallback、ChildrenCallback、Children2Callback、DataCallback七种</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventThread</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">    <span class="comment">//队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;Object&gt; waitingEvents = <span class="keyword">new</span> LinkedBlockingQueue();</span><br><span class="line">    <span class="comment">//这实际上是队列中的会话状态，直到EventThread事件线程实际处理该事件并将其交给watcher为止。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> KeeperState sessionState;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> wasKilled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">    EventThread() &#123;</span><br><span class="line">        <span class="keyword">super</span>(ClientCnxn.makeThreadName(<span class="string">&quot;-EventThread&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.sessionState = KeeperState.Disconnected;</span><br><span class="line">        <span class="keyword">this</span>.wasKilled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将WatchedEvent加入到waitingEvents队列中</span></span><br><span class="line">    <span class="comment">//在SendThread线程的readResponse(ByteBuffer incomingBuffer)读取从服务器端的response</span></span><br><span class="line">    <span class="comment">//如果是事件，则解析反序列化还原成WatchedEvent，调用该方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getType() != EventType.None || <span class="keyword">this</span>.sessionState != event.getState()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sessionState = event.getState();</span><br><span class="line">            ClientCnxn.WatcherSetEventPair pair = <span class="keyword">new</span> ClientCnxn.WatcherSetEventPair(ClientCnxn.<span class="keyword">this</span>.watcher.materialize(event.getState(), event.getType(), event.getPath()), event);</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(pair);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queuePacket</span><span class="params">(ClientCnxn.Packet packet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isRunning) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.processEvent(packet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.waitingEvents.add(packet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEventOfDeath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingEvents.add(ClientCnxn.<span class="keyword">this</span>.eventOfDeath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressFBWarnings(&#123;&quot;JLM_JSR166_UTILCONCURRENT_MONITORENTER&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.isRunning = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//一直循环，从waitingEvents队列中取出WatchedEvent或者Packet</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                Object event = <span class="keyword">this</span>.waitingEvents.take();</span><br><span class="line">                <span class="keyword">if</span> (event == ClientCnxn.<span class="keyword">this</span>.eventOfDeath) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wasKilled = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//处理event</span></span><br><span class="line">                    <span class="keyword">this</span>.processEvent(event);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.wasKilled) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>.waitingEvents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.waitingEvents.isEmpty()) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.isRunning = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException var5) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Event thread exiting due to interruption&quot;</span>, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClientCnxn.LOG.info(<span class="string">&quot;EventThread shut down for session: 0x&#123;&#125;&quot;</span>, Long.toHexString(ClientCnxn.<span class="keyword">this</span>.getSessionId()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//watcher监听事件</span></span><br><span class="line">            <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ClientCnxn.WatcherSetEventPair) &#123;</span><br><span class="line">                <span class="comment">// each watcher will process the event</span></span><br><span class="line">                ClientCnxn.WatcherSetEventPair pair = (ClientCnxn.WatcherSetEventPair)event;</span><br><span class="line">                <span class="comment">//循环watcher集合，调用watcher的回调方法(WatchedEvent event)处理该事件</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">                    Watcher watcher = (Watcher)var3.next();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//还记得Watcher接口中对于watcher实现类都要实现的一个process(WatchedEvent event)方法，就是这个</span></span><br><span class="line">                        watcher.process(pair.event);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                        ClientCnxn.LOG.error(<span class="string">&quot;Error while calling watcher &quot;</span>, var11);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//异步回调</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                ClientCnxn.Packet p = (ClientCnxn.Packet)event;</span><br><span class="line">                <span class="comment">//ResultCode服务器端响应码，常见码如下</span></span><br><span class="line">                <span class="comment">//0：接口调用成功 -4客户端与服务器端连接已断开</span></span><br><span class="line">                <span class="comment">//-110指定节点已存在 -112会话已过期</span></span><br><span class="line">                <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">                String clientPath = p.clientPath;</span><br><span class="line">                <span class="keyword">if</span> (p.replyHeader.getErr() != <span class="number">0</span>) &#123;</span><br><span class="line">                    rc = p.replyHeader.getErr();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ClientCnxn.LOG.warn(<span class="string">&quot;Somehow a null cb got to EventThread!&quot;</span>);</span><br><span class="line">                &#125; </span><br><span class="line"><span class="comment">//如果是exists/setData/setAcl命令异步方式的服务器端响应</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!(p.response <span class="keyword">instanceof</span> ExistsResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetDataResponse) &amp;&amp; !(p.response <span class="keyword">instanceof</span> SetACLResponse)) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//getData命令异步方式的服务器异步响应</span></span><br><span class="line">                    <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetDataResponse) &#123;</span><br><span class="line">                        DataCallback cbxxxx = (DataCallback)p.cb;</span><br><span class="line">                        GetDataResponse rspxxx = (GetDataResponse)p.response;</span><br><span class="line"><span class="comment">//rc==0表示接口调用成功</span></span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, rspxxx.getData(), rspxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxx.processResult(rc, clientPath, p.ctx, (<span class="keyword">byte</span>[])<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">//getACL命令异步方式的服务器异步响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetACLResponse) &#123;</span><br><span class="line">                        ACLCallback cbxxxxx = (ACLCallback)p.cb;</span><br><span class="line">                        GetACLResponse rspxxxx = (GetACLResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, rspxxxx.getAcl(), rspxxxx.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildren命令的服务器响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildrenResponse) &#123;</span><br><span class="line">                        ChildrenCallback cbxxxxxx = (ChildrenCallback)p.cb;</span><br><span class="line">                        GetChildrenResponse rspxxxxx = (GetChildrenResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, rspxxxxx.getChildren());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//getChildren命令异步方式的服务器异步响应，与上面的区别在与stat信息更新</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildren2Response) &#123;</span><br><span class="line">                        Children2Callback cbxxxxxxx = (Children2Callback)p.cb;</span><br><span class="line">                        GetChildren2Response rsp = (GetChildren2Response)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, rsp.getChildren(), rsp.getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbxxxxxxx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//create命令异步方式的服务器异步响应</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> CreateResponse) &#123;</span><br><span class="line">                        StringCallback cb = (StringCallback)p.cb;</span><br><span class="line">                        CreateResponse rspx = (CreateResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, ClientCnxn.<span class="keyword">this</span>.chrootPath == <span class="keyword">null</span> ? rspx.getPath() : rspx.getPath().substring(ClientCnxn.<span class="keyword">this</span>.chrootPath.length()));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx, (String)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">    <span class="comment">//MultiResponse</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> MultiResponse) &#123;</span><br><span class="line">                        MultiCallback cbx = (MultiCallback)p.cb;</span><br><span class="line">                        MultiResponse rspxx = (MultiResponse)p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                            List&lt;OpResult&gt; results = rspxx.getResultList();</span><br><span class="line">                            <span class="keyword">int</span> newRc = rc;</span><br><span class="line">                            Iterator var9 = results.iterator();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">                                OpResult result = (OpResult)var9.next();</span><br><span class="line">                                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ErrorResult &amp;&amp; Code.OK.intValue() != (newRc = ((ErrorResult)result).getErr())) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            cbx.processResult(newRc, clientPath, p.ctx, results);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cbx.processResult(rc, clientPath, p.ctx, (List)<span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.cb <span class="keyword">instanceof</span> VoidCallback) &#123;</span><br><span class="line">                        VoidCallback cbxx = (VoidCallback)p.cb;</span><br><span class="line">                        cbxx.processResult(rc, clientPath, p.ctx);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    StatCallback cbxxx = (StatCallback)p.cb;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> ExistsResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((ExistsResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetDataResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetDataResponse)p.response).getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetACLResponse) &#123;</span><br><span class="line">                            cbxxx.processResult(rc, clientPath, p.ctx, ((SetACLResponse)p.response).getStat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cbxxx.processResult(rc, clientPath, p.ctx, (Stat)<span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">            ClientCnxn.LOG.error(<span class="string">&quot;Caught unexpected throwable&quot;</span>, var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>参考：</p><p>🔗 《从Paxos到Zookeeper-分布式一致性原理与实践》</p>]]></content>
    
    
    <summary type="html">内容来自《从Paxos到Zookeeper-分布式一致性原理与实践》，内容包括：一次会话的创建过程、服务器地址列表、ClientCnxn网络I/O（Packet、outgoingQueue和pendingQueue、ClientCnxnSocket、SendThread、EventThread）等。</summary>
    
    
    
    <category term="技术文档" scheme="http://linyishui.top/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    
    <category term="distributed" scheme="http://linyishui.top/tags/distributed/"/>
    
    <category term="zookeeper" scheme="http://linyishui.top/tags/zookeeper/"/>
    
  </entry>
  
</feed>
