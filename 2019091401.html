<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad%20playstation.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig%20Dug.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad%20playstation.png">
  <link rel="mask-icon" href="/images/gamepad%20playstation.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CMa+Shan+Zheng:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"linyishui.top","root":"/","images":"/images","scheme":"Pisces","version":"8.6.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="简单整理SQL规范和优化相关内容，包括：SQL规范，SQL常见优化项，优化案例，Oracle的STA优化。">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL规范和优化（持续更新）">
<meta property="og:url" content="http://linyishui.top/2019091401.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="简单整理SQL规范和优化相关内容，包括：SQL规范，SQL常见优化项，优化案例，Oracle的STA优化。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc1.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc2.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc3.png">
<meta property="og:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc4.png">
<meta property="article:published_time" content="2019-09-14T06:40:30.000Z">
<meta property="article:modified_time" content="2022-01-06T02:11:02.000Z">
<meta property="article:author" content="Lys">
<meta property="article:tag" content="updating">
<meta property="article:tag" content="sql">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="oracle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc1.png">


<link rel="canonical" href="http://linyishui.top/2019091401.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://linyishui.top/2019091401.html","path":"2019091401.html","title":"SQL规范和优化（持续更新）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SQL规范和优化（持续更新） | 俺的部落格</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">俺的部落格</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">俺寻思俺需要记点东西</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
        <li class="menu-item menu-item-tools"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>工具</a></li>
        <li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书架</a></li>
        <li class="menu-item menu-item-movies"><a href="/movies/" rel="section"><i class="fa fa-video fa-fw"></i>剧院</a></li>
        <li class="menu-item menu-item-games"><a href="/games/" rel="section"><i class="fa fa-gamepad fa-fw"></i>游戏</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL%E8%A7%84%E8%8C%83%E5%92%8C%E4%BC%98%E5%8C%96"><span class="nav-text">SQL规范和优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-SQL%E8%A7%84%E8%8C%83"><span class="nav-text">第一节 SQL规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-text">1.1 命名规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%A0%BC%E5%BC%8F%E8%A7%84%E8%8C%83"><span class="nav-text">1.2 格式规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83"><span class="nav-text">1.3 设计规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E8%AF%AD%E6%B3%95%E8%A7%84%E8%8C%83"><span class="nav-text">1.4 语法规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89select-%E6%A3%80%E6%9F%A5"><span class="nav-text">（1）select 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89from-%E6%A3%80%E6%9F%A5"><span class="nav-text">（2）from 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89where-%E6%A3%80%E6%9F%A5"><span class="nav-text">（3）where 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89group-by-%E6%A3%80%E6%9F%A5"><span class="nav-text">（4）group by 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89order-by-%E6%A3%80%E6%9F%A5"><span class="nav-text">（5）order by 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%886%EF%BC%89limit-%E6%A3%80%E6%9F%A5"><span class="nav-text">（6）limit 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%887%EF%BC%89Union-%E6%A3%80%E6%9F%A5"><span class="nav-text">（7）Union 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%888%EF%BC%89%E5%85%BC%E5%AE%B9%E6%80%A7%E6%A3%80%E6%9F%A5"><span class="nav-text">（8）兼容性检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E7%B4%A2%E5%BC%95%E8%A7%84%E8%8C%83"><span class="nav-text">1.5 索引规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-%E7%B4%A2%E5%BC%95%E5%B1%9E%E6%80%A7"><span class="nav-text">1.5.1 索引属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="nav-text">1.5.1 前缀索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-3-%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E9%A1%BA%E5%BA%8F"><span class="nav-text">1.5.3 复合索引顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-4-%E6%97%B6%E9%97%B4%E5%88%97%E7%B4%A2%E5%BC%95"><span class="nav-text">1.5.4 时间列索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-SQL%E4%BC%98%E5%8C%96"><span class="nav-text">第二节 SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%B8%B8%E8%A7%81%E4%BC%98%E5%8C%96%E9%A1%B9"><span class="nav-text">2.1 常见优化项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-text">2.2 优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="nav-text">（1）慢查询优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%85%A2%E6%9F%A5%E8%AF%A2SQL"><span class="nav-text">1.慢查询SQL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-SQL%E5%88%86%E6%9E%90"><span class="nav-text">2.SQL分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-SQL%E6%94%B9%E5%86%99"><span class="nav-text">3.SQL改写</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E4%BC%98%E5%8C%961"><span class="nav-text">改写优化1</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E4%BC%98%E5%8C%962"><span class="nav-text">改写优化2</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%94%B9%E5%86%99%E4%BC%98%E5%8C%963"><span class="nav-text">改写优化3</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83RPC%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E8%B6%85%E6%97%B6"><span class="nav-text">（2）生产环境RPC服务调用超时</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B"><span class="nav-text">1.排查过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84SQL"><span class="nav-text">2.使用到的SQL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3"><span class="nav-text">3.相关文档</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%87%E6%A1%A31"><span class="nav-text">文档1</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%87%E6%A1%A32"><span class="nav-text">文档2</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%87%E6%A1%A33"><span class="nav-text">文档3</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%A4%A7%E8%A1%A8SQL%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C%E8%B6%85%E6%97%B6"><span class="nav-text">（3）大表SQL查询执行超时</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Oracle-STA%E4%BC%98%E5%8C%96SQL"><span class="nav-text">2.3 Oracle STA优化SQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E4%B8%B4%E6%97%B6%E8%A1%A8%E4%BC%98%E5%8C%96"><span class="nav-text">2.4 临时表优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Explain"><span class="nav-text">2.5 Explain</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-text">三. 问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%AD%BB%E9%94%81"><span class="nav-text">3.1 死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6"><span class="nav-text">3.2 等待事件</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lys"
      src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG">
  <p class="site-author-name" itemprop="name">Lys</p>
  <div class="site-description" itemprop="description">记录编程点滴，写点生活中的酸甜</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">330</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">110</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/LAILAIWA" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LAILAIWA" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:linyishui168@outlook.com" title="E-Mail → mailto:linyishui168@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5340162234" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5340162234" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/linyishui618" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;linyishui618" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/13018339/lin-yishui" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;13018339&#x2F;lin-yishui" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/linyishui618" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;linyishui618" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="far fa-smile-wink fa-fw"></i>
      个人
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://music.163.com/#/user/home?id=68425607" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;68425607" rel="noopener" target="_blank">网易云音乐</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/LAILAIWA" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2019091401.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/IMG_0759.JPG">
      <meta itemprop="name" content="Lys">
      <meta itemprop="description" content="记录编程点滴，写点生活中的酸甜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SQL规范和优化（持续更新）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-14 14:40:30" itemprop="dateCreated datePublished" datetime="2019-09-14T14:40:30+08:00">2019-09-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-01-06 10:11:02" itemprop="dateModified" datetime="2022-01-06T10:11:02+08:00">2022-01-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/" itemprop="url" rel="index"><span itemprop="name">技术文档</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>38k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>35 分钟</span>
    </span>
</div>

            <div class="post-description">简单整理SQL规范和优化相关内容，包括：SQL规范，SQL常见优化项，优化案例，Oracle的STA优化。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="SQL规范和优化"><a href="#SQL规范和优化" class="headerlink" title="SQL规范和优化"></a>SQL规范和优化</h1><h2 id="第一节-SQL规范"><a href="#第一节-SQL规范" class="headerlink" title="第一节 SQL规范"></a>第一节 SQL规范</h2><h3 id="1-1-命名规范"><a href="#1-1-命名规范" class="headerlink" title="1.1 命名规范"></a>1.1 命名规范</h3><p>表和视图的命名，长度不超过 30 个字符 。</p>
<p>表名及字段名设置要合理，不能使用MySQL的关键字，如desc, order, status, group等。</p>
<p>设置lower_case_table_names = 1表名不区分大小写。</p>
<p>对象前缀命名原则：</p>
<table>
<thead>
<tr>
<th align="left">对象类型</th>
<th align="left">对象前缀</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">表（table）</td>
<td align="left">t</td>
<td align="left">t_module_name</td>
</tr>
<tr>
<td align="left">临时表（temporary table）</td>
<td align="left">tmp</td>
<td align="left">tmp_module_name</td>
</tr>
<tr>
<td align="left">视图（view）</td>
<td align="left">v</td>
<td align="left">v_表名</td>
</tr>
<tr>
<td align="left">非唯一索引（ index）</td>
<td align="left">idx</td>
<td align="left">idx_表名 _每列首字母</td>
</tr>
<tr>
<td align="left">唯一索引（unique index）</td>
<td align="left">uk</td>
<td align="left">uk_表名 _每列首字母</td>
</tr>
<tr>
<td align="left">主键（primary key）</td>
<td align="left">pk</td>
<td align="left">pk_表名</td>
</tr>
<tr>
<td align="left">过程（procedure）</td>
<td align="left">p</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">函数（function）</td>
<td align="left">f</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="1-2-格式规范"><a href="#1-2-格式规范" class="headerlink" title="1.2 格式规范"></a>1.2 格式规范</h3><p>略。</p>
<h3 id="1-3-设计规范"><a href="#1-3-设计规范" class="headerlink" title="1.3 设计规范"></a>1.3 设计规范</h3><p>通用：</p>
<ul>
<li>尽量不要用 char 类型，用 varchar 类型代替（可变）。</li>
<li>字段建议定义为 not null，并且指定默认值，如果列值存储了大量的NULL，会影响索引的稳定性。。</li>
<li>禁止使用外键，外键约束应该在应用层处理。建议在 ER 图里保留外键。</li>
<li>字段的备注要能明确该字段的作用，尤其是某些表示状态的字段，要显式的写出该字段所有可能的状态数值以及该数值的含义。</li>
<li>不建议使用Text数据类型，一方面由于传输大量的数据包可能会超过max_allowed_packet设置导致程序报错，另一方面表上的DML操作都会变的很慢，建议采用es或者对象存储OSS来存储和检索。</li>
</ul>
<p>MySQL：</p>
<ul>
<li>使用 InnoDB存储引擎，可以通过参数default_storage_engine控制。</li>
<li>字符集统一使用 UTF8MB4 。</li>
<li>所有表都必须有主键。</li>
<li>不涉及分库分表的表选用 auto_increment 列做主键，主键类型使用无符号整型；涉及到要做分库分表的表用有序uuid做主键。</li>
<li>主键之外，应增加代表业务规则的唯一索引，但不建议直接将其作为主键。</li>
<li>禁止使用 enum/set/bool 类型， 尽量不使用 text/blobs 等大字段类型 。</li>
<li>禁止使用浮点类型 FLOAT 和 DOUBLE。</li>
<li>对较长的字符型字段建立索引时，应使用前缀索引。</li>
</ul>
<p>Oracle：</p>
<ul>
<li>建议表和索引的数据分不同表空间存储。</li>
<li>原则上每个表都应该有主键。</li>
<li>优先使用业务主键，在业务主键超过3个字段时考虑使用逻辑主键，把业务主键建成唯一约束。</li>
<li>不建议在分区表上创建全局索引，原则上一律使用 local索引。</li>
</ul>
<p>建表的时候主键id带有AUTO_INCREMENT属性，而且AUTO_INCREMENT=1，在InnoDB内部是通过一个系统全局变量dict_sys.row_id来计数，row_id是一个8字节的bigint unsigned，InnoDB在设计时只给row_id保留了6个字节的长度，这样row_id取值范围就是 0 到 2^48^ - 1，如果id的值达到了最大值，下一个值就从0开始继续循环递增，在代码中禁止指定主键id值插入。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--新插入的id值会从10001开始，这是不对的，应该从1开始。</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> booking( `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键id&#x27;</span>,......) engine <span class="operator">=</span> InnoDB auto_increment <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--指定了id值插入，后续自增就会从该值开始+1，索引禁止指定id值插入。</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> booking(id, book_sn) <span class="keyword">values</span>(<span class="number">1234551121</span>, <span class="string">&#x27;N12121&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="1-4-语法规范"><a href="#1-4-语法规范" class="headerlink" title="1.4 语法规范"></a>1.4 语法规范</h3><h4 id="（1）select-检查"><a href="#（1）select-检查" class="headerlink" title="（1）select 检查"></a>（1）select 检查</h4><ul>
<li><p><strong>禁止 select * 这样的代码 ，必须将字段名一一列出</strong>。</p>
</li>
<li><p><strong>尽量避免在 select 后使用自定义函数</strong> ：SQL返回多少行，那么UDF函数就会被调用多少次，非常影响性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--getOrderNo是用户自定义一个函数用户来根据order_sn来获取订单编号</span></span><br><span class="line"><span class="keyword">select</span> id, payment_id, order_sn, getOrderNo(order_sn) <span class="keyword">from</span> payment_transaction <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-10-01 10:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-02 10:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>避免查询 text 类型字段</strong> ：如果select出现text类型的字段，就会消耗大量的网络和IO带宽，由于返回的内容过大超过max_allowed_packet设置会导致程序报错，需要评估谨慎使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--表request_log的中content是text类型。</span></span><br><span class="line"><span class="keyword">select</span> user_id, content, status, url, type <span class="keyword">from</span> request_log <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="number">32121</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>谨慎使用 group_concat</strong> ：gorup_concat是一个字符串聚合函数，会影响SQL的响应时间，如果返回的值过大超过了max_allowed_packet设置会导致程序报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> batch_id, group_concat(name) <span class="keyword">from</span> buffer_batch <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-10-01 10:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-02 10:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>内联子查询</strong> ：在select后面有子查询的情况称为内联子查询，SQL返回多少行，子查询就需要执行过多少次，严重影响SQL性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,(<span class="keyword">select</span> rule_name <span class="keyword">from</span> member_rule limit <span class="number">1</span>) <span class="keyword">as</span> rule_name, member_id, member_type, member_name, status  <span class="keyword">from</span> member_info m <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-09-02 10:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-01 10:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>……</p>
</li>
</ul>
<h4 id="（2）from-检查"><a href="#（2）from-检查" class="headerlink" title="（2）from 检查"></a>（2）from 检查</h4><ul>
<li><p><strong>当 SQL涉及到多个表时， 必须为每个字段指定表名前缀</strong>。</p>
</li>
<li><p><strong>定义表和子查询的别名时不能重名</strong>。</p>
</li>
<li><p><strong>尽量避免表关联</strong> ：在MySQL中不建议使用Left Join，即使ON过滤条件列索引，一些情况也不会走索引，导致大量的数据行被扫描，SQL性能变得很差，同时要清楚ON和Where的区别。应避免带 in 的子查询，尽量改写成 join？没必要的时候不要做外连接，内连接效率比外连接高 。外连接一律用 left join，禁止使用 right join。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.member_id,a.create_time,b.active_time <span class="keyword">FROM</span> operation_log a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> member_info b <span class="keyword">ON</span> a.member_id <span class="operator">=</span> b.member_id <span class="keyword">where</span>  b.`status` <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> a.create_time <span class="keyword">between</span> <span class="string">&#x27;2020-10-01 00:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-30 00:00:00&#x27;</span> limit <span class="number">100</span>, <span class="number">0</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>避免子查询</strong> ：由于MySQL的基于成本的优化器CBO对子查询的处理能力比较弱，不建议使用子查询，可以改写成 Inner Join</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b.member_id,b.member_type, a.create_time,a.device_model <span class="keyword">from</span> member_operation_log a <span class="keyword">inner</span> <span class="keyword">join</span> (<span class="keyword">select</span> member_id,member_type <span class="keyword">from</span> member_base_info <span class="keyword">where</span> `status` <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-10-01 00:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-30 00:00:00&#x27;</span>) <span class="keyword">as</span> b <span class="keyword">on</span> a.member_id <span class="operator">=</span> b.member_id;</span><br></pre></td></tr></table></figure></li>
<li><p>……</p>
</li>
</ul>
<h4 id="（3）where-检查"><a href="#（3）where-检查" class="headerlink" title="（3）where 检查"></a>（3）where 检查</h4><ul>
<li><p><strong>where条件列上禁止使用函数和表达式 ，也要避免数据类型的隐式转换。</strong></p>
</li>
<li><p>使用 like进行模糊查询时， %不要放在首位 ，因为会限制对索引的使用 。<br>例如 <code>like &#39;abc%&#39;</code> 可以走索引，而 <code>like &#39;%abc&#39;</code> 或者 <code>&#39;%abc%&#39;</code> 都不会走索引。</p>
</li>
<li><p><strong>索引列被运算</strong> ：当一个字段被索引，同时出现where条件后面，是不能进行任何运算，会导致索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--device_no列上有索引，由于使用了ltrim函数导致索引失效</span></span><br><span class="line"><span class="keyword">select</span> id, name , phone, address, device_no <span class="keyword">from</span> users <span class="keyword">where</span> ltrim(device_no) <span class="operator">=</span> <span class="string">&#x27;Hfs1212121&#x27;</span>;</span><br><span class="line"><span class="comment">--balance列有索引,由于做了运算导致索引失效</span></span><br><span class="line"><span class="keyword">select</span> account_no, balance <span class="keyword">from</span> accounts <span class="keyword">where</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="operator">=</span> <span class="number">10000</span> <span class="keyword">and</span> status <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>类型转换</strong> ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--user_id是bigint类型，传入varchar值发生了隐式类型转换，可以走索引。</span></span><br><span class="line"><span class="keyword">select</span> id, name , phone, address, device_no <span class="keyword">from</span> users <span class="keyword">where</span> user_id <span class="operator">=</span> <span class="string">&#x27;23126&#x27;</span>;</span><br><span class="line"><span class="comment">--card_no是varchar(20)，传入int值是无法走索引</span></span><br><span class="line"><span class="keyword">select</span> id, name , phone, address, device_no <span class="keyword">from</span> users <span class="keyword">where</span> card_no <span class="operator">=</span> <span class="number">2312612121</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>列字符集</strong> ：从MySQL 5.6开始建议所有对象字符集应该使用用utf8mb4，包括MySQL实例字符集，数据库字符集，表字符集，列字符集。避免在关联查询Join时字段字符集不匹配导致索引失效，同时目前只有utf8mb4支持emoji表情存储。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">character_set_server  <span class="operator">=</span>  utf8mb4    #数据库实例字符集</span><br><span class="line">character_set_connection <span class="operator">=</span> utf8mb4  #连接字符集</span><br><span class="line">character_set_database <span class="operator">=</span> utf8mb4    #数据库字符集</span><br><span class="line">character_set_results <span class="operator">=</span> utf8mb4     #结果集字符集</span><br></pre></td></tr></table></figure></li>
<li><p>……</p>
</li>
</ul>
<h4 id="（4）group-by-检查"><a href="#（4）group-by-检查" class="headerlink" title="（4）group by 检查"></a>（4）group by 检查</h4><ul>
<li><p><strong>前缀索引</strong>：group by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--device_no字段类型varchar(200)，创建了前缀索引。</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> users <span class="keyword">add</span> index idx_device_no(device_no(<span class="number">64</span>));</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> device_no, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> users <span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-10-01 00:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-10-30 00:00:00&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> device_no;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>函数运算</strong>：假设需要统计某月每天的新增用户量，参考如下SQL语句，虽然可以走create_time的索引，但是不能消除排序，可以考虑冗余一个字段stats_date date类型来解决这种问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> DATE_FORMAT(create_time, <span class="string">&#x27;%Y-%m-%d&#x27;</span>), <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> users <span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-09-01 00:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-09-30 23:59:59&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> DATE_FORMAT(create_time, <span class="string">&#x27;%Y-%m-%d&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>……</p>
</li>
</ul>
<h4 id="（5）order-by-检查"><a href="#（5）order-by-检查" class="headerlink" title="（5）order by 检查"></a>（5）order by 检查</h4><ul>
<li>避免不必要的排序 。order by、 group by、 distinct、 union等操作都有可能排序。<br>MySQL中 使用 group by 时， 默认会进行排序， 如果不需要排序 ，可以使用 order by null。</li>
<li><strong>前缀索引</strong>：order by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</li>
<li><strong>字段顺序</strong>：排序字段顺序，asc/desc升降要跟索引保持一致，充分利用索引的有序性来消除排序带来的CPU开销。</li>
<li>……</li>
</ul>
<h4 id="（6）limit-检查"><a href="#（6）limit-检查" class="headerlink" title="（6）limit 检查"></a>（6）limit 检查</h4><ul>
<li><strong>limit m,n要慎重</strong> ：对于limit m, n分页查询，越往后面翻页即m越大的情况下SQL的耗时会越来越长，对于这种应该先取出主键id，然后通过主键id跟原表进行Join关联查询。</li>
<li>……</li>
</ul>
<h4 id="（7）Union-检查"><a href="#（7）Union-检查" class="headerlink" title="（7）Union 检查"></a>（7）Union 检查</h4><ul>
<li>合并多个表的数据时，如果不需要去除重复数据，应使用 union all 而不是 union 。union需要做排序和去重操作，效率不如 union all。</li>
</ul>
<h4 id="（8）兼容性检查"><a href="#（8）兼容性检查" class="headerlink" title="（8）兼容性检查"></a>（8）兼容性检查</h4><p>同时支持MySQL和Oracle：</p>
<ul>
<li>对于单行注释应使用 <code>--</code> 方式 。</li>
<li>对于字符串应该使用单引号括起来。MySQL还支持双引号的方式，但 Oracle不支持。</li>
<li>尽量避免使用 full join。MySQL还不支持 full join。</li>
<li>避免在 group by和 having子句中使用列的别名。Oracle不支持这种语法。</li>
<li>from子句中的子查询要定义别名。MySQL中这个别名是必须要有的。</li>
</ul>
<h3 id="1-5-索引规范"><a href="#1-5-索引规范" class="headerlink" title="1.5 索引规范"></a>1.5 索引规范</h3><h4 id="1-5-1-索引属性"><a href="#1-5-1-索引属性" class="headerlink" title="1.5.1 索引属性"></a>1.5.1 索引属性</h4><p>索引基数指的是被索引的列唯一值的个数，唯一值越多接近表的count(*)说明索引的选择率越高，通过索引扫描的行数就越少，性能就越高，例如主键id的选择率是100%，在MySQL中尽量所有的update都使用主键id去更新，因为id是聚集索引存储着整行数据，不需要回表，性能是最高的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> member_info;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">148416</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.35</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> member_base_info;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span>            <span class="operator">|</span> Non_unique <span class="operator">|</span> Key_name                   <span class="operator">|</span> Seq_in_index <span class="operator">|</span> Column_name       <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> <span class="keyword">Cardinality</span> <span class="operator">|</span> Sub_part <span class="operator">|</span> Packed <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Index_type <span class="operator">|</span> Comment <span class="operator">|</span> Index_comment <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> member_info <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>                    <span class="operator">|</span>            <span class="number">1</span> <span class="operator">|</span> id                <span class="operator">|</span> A         <span class="operator">|</span>      <span class="number">131088</span> <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span>      <span class="operator">|</span> BTREE      <span class="operator">|</span>         <span class="operator">|</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> member_info <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> uk_member_id               <span class="operator">|</span>            <span class="number">1</span> <span class="operator">|</span> member_id         <span class="operator">|</span> A         <span class="operator">|</span>      <span class="number">131824</span> <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span>      <span class="operator">|</span> BTREE      <span class="operator">|</span>         <span class="operator">|</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> member_info <span class="operator">|</span>          <span class="number">1</span> <span class="operator">|</span> idx_create_time            <span class="operator">|</span>            <span class="number">1</span> <span class="operator">|</span> create_time       <span class="operator">|</span> A         <span class="operator">|</span>        <span class="number">6770</span> <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span>      <span class="operator">|</span> BTREE      <span class="operator">|</span>         <span class="operator">|</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="comment">--Table：表名</span></span><br><span class="line"><span class="comment">--Non_unique ：是否为unique index，0-是，1-否。</span></span><br><span class="line"><span class="comment">--Key_name：索引名称</span></span><br><span class="line"><span class="comment">--Seq_in_index：索引中的顺序号，单列索引-都是1；复合索引-根据索引列的顺序从1开始递增。</span></span><br><span class="line"><span class="comment">--Column_name：索引的列名</span></span><br><span class="line"><span class="comment">--Collation：排序顺序，如果没有指定asc/desc，默认都是升序ASC。</span></span><br><span class="line"><span class="comment">--Cardinality：索引基数-索引列唯一值的个数。</span></span><br><span class="line"><span class="comment">--sub_part：前缀索引的长度；例如index (member_name(10)，长度就是10。</span></span><br><span class="line"><span class="comment">--Packed：索引的组织方式，默认是NULL。</span></span><br><span class="line"><span class="comment">--Null：YES:索引列包含Null值；&#x27;&#x27;:索引不包含Null值。</span></span><br><span class="line"><span class="comment">--Index_type：默认是BTREE，其他的值FULLTEXT，HASH，RTREE。</span></span><br><span class="line"><span class="comment">--Comment：在索引列中没有被描述的信息，例如索引被禁用。</span></span><br><span class="line"><span class="comment">--Index_comment：创建索引时的备注。</span></span><br></pre></td></tr></table></figure>



<h4 id="1-5-1-前缀索引"><a href="#1-5-1-前缀索引" class="headerlink" title="1.5.1 前缀索引"></a>1.5.1 前缀索引</h4><p>对于变长字符串类型varchar(m)，为了减少key_len，可以考虑创建前缀索引，但是前缀索引不能消除group by， order by带来排序开销。如果字段的实际最大值比m小很多，建议缩小字段长度。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> member_info <span class="keyword">add</span> index idx_member_name_part(member_name(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>



<h4 id="1-5-3-复合索引顺序"><a href="#1-5-3-复合索引顺序" class="headerlink" title="1.5.3 复合索引顺序"></a>1.5.3 复合索引顺序</h4><p>有很多人喜欢在创建复合索引的时候，总以为前导列一定是唯一值多的列，例如索引 <code>index idx_create_time_status(create_time, status)</code>，这个索引往往是无法命中，因为扫描的IO次数太多，总体的cost的比全表扫描还大，CBO最终的选择是走 <code>full table scan</code>。</p>
<p>MySQL遵循的是索引最左匹配原则，对于复合索引，从左到右依次扫描索引列，到遇到第一个范围查询（&gt;=, &gt;,&lt;, &lt;=, between ….. and ….）就停止扫描，索引正确的索引顺序应该是 <code>index idx_status_create_time(status, create_time)</code> 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> account_no, balance <span class="keyword">from</span> accounts <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">&#x27;2020-09-01 00:00:00&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-09-30 23:59:59&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="1-5-4-时间列索引"><a href="#1-5-4-时间列索引" class="headerlink" title="1.5.4 时间列索引"></a>1.5.4 时间列索引</h4><p>对于默认字段 <code>created_at(create_time)</code>、<code>updated_at(update_time)</code> 这种默认就应该创建索引，这一般来说是默认的规则。</p>
<h2 id="第二节-SQL优化"><a href="#第二节-SQL优化" class="headerlink" title="第二节 SQL优化"></a>第二节 SQL优化</h2><p>SQL优化方向：</p>
<ul>
<li><strong>减少数据访问次数：</strong>设置合理的字段类型，使用压缩，通过索引访问减少磁盘IO。</li>
<li><strong>返回更少的数据：</strong>只返回需要的字段，分页处理，减少磁盘IO和网络IO。</li>
<li><strong>减少交互次数：</strong>批量DML操作、函数存储等减少数据连接次数。</li>
<li><strong>减少CPU开销：</strong>尽量减少数据库排序操作以及全表查询，减少CPU内存占用。</li>
<li><strong>利用更多资源：</strong>使用表分区，增加并行操作，更大限度利用CPU资源。</li>
</ul>
<p>SQL执行顺序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">DISTINCT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="operator">&lt;</span>left_table<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>join_type<span class="operator">&gt;</span> <span class="keyword">JOIN</span> <span class="operator">&lt;</span>right_table<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">ON</span> <span class="operator">&lt;</span>join_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">&lt;</span>where_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>group_by_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="operator">&lt;</span>having_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>order_by_condition<span class="operator">&gt;</span></span><br><span class="line">LIMIT <span class="operator">&lt;</span>limit_number<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><strong>FROM</strong>：选取表，将多个表数据通过笛卡尔积变成一个表</li>
<li><strong>ON</strong>：对笛卡尔积的虚表进行筛选</li>
<li><strong>JOIN</strong>：指定join，用于添加数据到on之后的虚表中，例如left join会将左表的剩余数据添加到虚表中</li>
<li><strong>WHERE</strong>：对上述虚表进行筛选</li>
<li><strong>GROUP BY</strong>：分组聚合</li>
<li><strong>HAVING</strong>：对分组后的结果进行聚合筛选</li>
<li><strong>SELECT</strong>：返回的单列必须在group by子句中，聚合函数除外</li>
<li><strong>DISTINCT</strong>：数据除重</li>
<li><strong>ORDER BY</strong>： 排序</li>
<li><strong>LIMIT</strong>：行数限制</li>
</ol>
<h3 id="2-1-常见优化项"><a href="#2-1-常见优化项" class="headerlink" title="2.1 常见优化项"></a>2.1 常见优化项</h3><ol>
<li><p><strong>对常用于where和order等地方的属性列创建<a href="../2019042401.html" title="Title">索引</a>，避免全表扫描，提高查询效率。</strong></p>
<p>以下写法可能会导致查询不走索引，而进行全表扫描，下列总结不一定准确涵盖，有时因为如索引字段重复数据太多等原因也会导致SQL不走索引，具体情况需要具体分析，且不要提前做优化，开发首先的优先级应该保证进度按时完成，尽量不要先把重心提前放到这些地方。</p>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">用法</th>
<th align="left">说明</th>
<th align="left">代替用法</th>
</tr>
</thead>
<tbody><tr>
<td align="center">select *</td>
<td align="left">无法使用索引</td>
<td align="left">标明具体返回属性</td>
</tr>
<tr>
<td align="center">where xx != 或 &lt;&gt;</td>
<td align="left">无法使用索引</td>
<td align="left">使用 &gt; 或用 union all 来代替</td>
</tr>
<tr>
<td align="center">where xx is (not) null</td>
<td align="left">无法使用索引</td>
<td align="left">where xx = 0(不一定都支持)</td>
</tr>
<tr>
<td align="center">where xx or …</td>
<td align="left">无法使用索引</td>
<td align="left">用 union all 来代替</td>
</tr>
<tr>
<td align="center">where xx in/not in …</td>
<td align="left">无法使用索引</td>
<td align="left">between，exists或join替换in，用not exists替代not in</td>
</tr>
<tr>
<td align="center">where xx like …</td>
<td align="left">模糊查询无法使用索引</td>
<td align="left">避免字段前%，可以使用字段后%，考虑使用全文检索</td>
</tr>
<tr>
<td align="center">where 使用局部变量</td>
<td align="left">无法使用索引</td>
<td align="left">如：select id from t where num=@num 改为强制索引：select id from t with(index(索引名)) where num=@num</td>
</tr>
<tr>
<td align="center">where 表达式运算</td>
<td align="left">无法使用索引</td>
<td align="left">如：select id from t where num/2=100 应改为: select id from t where num=100*2</td>
</tr>
<tr>
<td align="center">where 函数操作</td>
<td align="left">无法使用索引</td>
<td align="left">如：select id from t where substring(name,1,3)=’abc’ 和 select id from t where datediff(day,createdate,’2005-11-30’)=0–’2005-11-30’生成的id  应改为: select id from t where name like ‘abc%’  和 select id from t where createdate&gt;=’2005-11-30’ and createdate&lt;’2005-12-1’</td>
</tr>
<tr>
<td align="center">若索引字段是组合索引</td>
<td align="left">只能使用索引中的第一个字段作为条件，否则不会使用索引，尽量让字段顺序和索引顺序保持一致</td>
<td align="left">select col1 from table where key_part2=1 and key_part3=2</td>
</tr>
<tr>
<td align="center">隐式类型转换</td>
<td align="left">索引对应字段类型为varchar，但给定值为数值</td>
<td align="left">select col1 from table where col_varchar=123;</td>
</tr>
</tbody></table>
<ol start="2">
<li><p><strong>避免使用in或not in</strong></p>
<ul>
<li><p>如果是连续数值，可以用between代替：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">AND</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>如果是子查询，可以使用exists代替in：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> num <span class="keyword">from</span> a <span class="keyword">where</span> num <span class="keyword">in</span>(<span class="keyword">select</span> num <span class="keyword">from</span> b);</span><br><span class="line"># 替换为： </span><br><span class="line"><span class="keyword">select</span> num <span class="keyword">from</span> a <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> b <span class="keyword">where</span> num<span class="operator">=</span>a.num);</span><br></pre></td></tr></table></figure></li>
<li><p>使用EXISTS时，如果连接列(id)上建立了索引，那么查询Class_B时不用查询实际的表，只需查索引就可以了。只要查到一行数据满足条件就会终止查询，不用像使用IN时一样扫描全表。在这一点上NOT EXISTS也一样。</p>
</li>
</ul>
</li>
</ol>
<ol start="3">
<li><strong>存储数字值时尽量使用数字类型的字段</strong>：若用字符类型来存储数字值，相比数字类型会降低查询和连接的性能，字符比较相比数字比较要慢，并一定程度上增加存储开销。</li>
</ol>
<ol start="4">
<li><strong>尽可能的使用 varchar/nvarchar 代替 char/nchar</strong>：变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</li>
</ol>
<ol start="5">
<li><strong>尽量使用表变量来代替临时表</strong>：如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。</li>
</ol>
<ol start="6">
<li><p><strong>避免频繁创建和删除临时表，以减少系统表资源的消耗</strong></p>
<p>适当地使用临时表，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使用导出表。</p>
<p>使用临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。 </p>
<p>如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。 </p>
</li>
<li><p><strong>尽量避免使用游标，因为游标的效率较差。</strong></p>
<p>使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。 </p>
<p>与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。 </p>
</li>
</ol>
<ol start="8">
<li><p><strong>尽量避免使用游标，因为游标的效率较差</strong>：使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。 </p>
</li>
<li><p><strong>减少访问数据库的次数</strong>：数据库在每次执行前可能会做一些默认工作，如果不影响开发进度，尽量对数据的一次访问就取出所要数据。 </p>
</li>
<li><p><strong>字段Column前加表名</strong>：减少因为防止歧义而进行解析所消耗的时间。</p>
</li>
<li><p><strong>用EXISTS替换DISTINCT</strong>：减少因为防止歧义而进行解析所消耗的时间。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(低效): <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> DEPT_NO,DEPT_NAME <span class="keyword">FROM</span> DEPT D , EMP E <span class="keyword">WHERE</span> D.DEPT_NO <span class="operator">=</span> E.DEPT_NO </span><br><span class="line">(高效): <span class="keyword">SELECT</span> DEPT_NO,DEPT_NAME <span class="keyword">FROM</span> DEPT D <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> ( <span class="keyword">SELECT</span> ‘X<span class="string">&#x27; FROM EMP E WHERE E.DEPT_NO = D.DEPT_NO);</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>Oracle中尽量用全大写</strong>：Oracle总是先解析SQL语句，把小写的字母转换成大写的再执行。 </p>
</li>
<li><p><strong>用&gt;=替代&gt;</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">高效：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> EMP <span class="keyword">WHERE</span> DEPTNO <span class="operator">&gt;=</span><span class="number">4</span> </span><br><span class="line">低效: <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> EMP <span class="keyword">WHERE</span> DEPTNO <span class="operator">&gt;</span><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>两者的区别在于，前者DBMS将直接跳到第一个DEPT等于4的记录而后者将首先定位到DEPTNO=3的记录并且向前扫描到第一个DEPT大于3的记录。</p>
</li>
<li><p><strong>模糊查询</strong></p>
<ul>
<li>尽量只在字段后使用 <code>abc%</code> ，避免在字段前使用 <code>%abc%</code> 。</li>
<li>使用MySQL内置函数 <code>INSTR(str,substr)</code> 来匹配，作用类似于java中的 <code>indexOf()</code> ，查询字符串出现的角标位置。</li>
<li>使用FullText全文索引，用 match against 检索。</li>
<li>数据量较大的情况，建议引用ElasticSearch、solr，亿级数据量检索速度秒级。</li>
<li>表数据量较少，直接用 <code>like &#39;%xx%&#39;</code> 。</li>
</ul>
</li>
<li><p><strong>优化GROUP BY</strong></p>
<p>提高GROUP BY 语句的效率，可以通过将不需要的记录在GROUP BY 之前过滤掉。下面两个查询返回相同结果但第二个明显就快了许多。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">低效: <span class="keyword">SELECT</span> JOB , <span class="built_in">AVG</span>(SAL) <span class="keyword">FROM</span> EMP <span class="keyword">GROUP</span> JOB <span class="keyword">HAVING</span> JOB <span class="operator">=</span> ‘PRESIDENT<span class="string">&#x27; OR JOB = ‘MANAGER&#x27;</span> </span><br><span class="line">高效: <span class="keyword">SELECT</span> JOB , <span class="built_in">AVG</span>(SAL) <span class="keyword">FROM</span> EMP <span class="keyword">WHERE</span> JOB <span class="operator">=</span> ‘PRESIDENT<span class="string">&#x27; OR JOB = ‘MANAGER&#x27;</span> <span class="keyword">GROUP</span> JOB</span><br></pre></td></tr></table></figure></li>
<li><p><strong>优化ORDER BY</strong></p>
<p>order by 条件要与where中条件一致，否则order by不会利用索引进行排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 不走age索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">order</span> <span class="keyword">by</span> age;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 走age索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">order</span> <span class="keyword">by</span> age;</span><br></pre></td></tr></table></figure>

<p>数据库执行顺序：</p>
<ul>
<li>根据where条件和统计信息生成执行计划，得到数据。</li>
<li>将得到的数据排序。当执行处理数据（order by）时，数据库会先查看第一步的执行计划，看order by 的字段是否在执行计划中利用了索引。如果是，则可以利用索引顺序而直接取得已经排好序的数据。如果不是，则重新进行排序操作。</li>
<li>返回排序后的数据。</li>
</ul>
<p>当order by 中的字段出现在where条件中时，才会利用索引而不再二次排序，更准确的说，order by 中的字段在执行计划中利用了索引时，不用排序操作。</p>
<p>这个结论不仅对order by有效，对其他需要排序的操作也有效。比如group by 、union 、distinct等。</p>
</li>
<li><p><strong>避免使用耗费资源的操作</strong>：带有DISTINCT,UNION,MINUS,INTERSECT,ORDER BY的SQL语句会启动SQL引擎执行耗费资源的排序(SORT)功能。DISTINCT需要一次排序操作，而其他的至少需要执行两次排序。通常，带有 UNION, MINUS , INTERSECT的SQL语句都可以用其他方式重写。如果你的数据库的SORT_AREA_SIZE调配得好。使用UNION , MINUS, INTERSECT也是可以考虑的, 毕竟它们的可读性很强。</p>
</li>
<li><p><strong>两表关联小表在前，大表在后</strong></p>
</li>
<li><p><strong>子查询优化</strong></p>
<p>子查询可以分为关联子查询（Correlated Subquery）和非关联子查询（Non-correlated Subquery）。</p>
<ul>
<li><p><strong>非关联子查询</strong>： 非关联即先执行内层查询，再执行外层查询，如下所示。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_count, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> custdist</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">     <span class="keyword">SELECT</span> c_custkey, <span class="built_in">count</span>(o_orderkey) <span class="keyword">AS</span> c_count</span><br><span class="line">     <span class="keyword">FROM</span> CUSTOMER</span><br><span class="line">     <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> ORDERS <span class="keyword">ON</span> c_custkey <span class="operator">=</span> o_custkey</span><br><span class="line">     <span class="keyword">AND</span> o_comment <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%pending%deposits%&#x27;</span></span><br><span class="line">     <span class="keyword">GROUP</span> <span class="keyword">BY</span> c_custkey</span><br><span class="line">     ) c_orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c_count</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> custdist <span class="keyword">DESC</span>, c_count <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>标量子查询</strong>：输出只有一个结果值的子查询，可以作为条件或属性出现在WHERE子句或SELECT子句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_custkey</span><br><span class="line"><span class="keyword">FROM</span> CUSTOMER</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">1000000</span> <span class="operator">&lt;</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(o_totalprice)</span><br><span class="line">    <span class="keyword">FROM</span> ORDERS</span><br><span class="line">    <span class="keyword">WHERE</span> o_custkey <span class="operator">=</span> c_custkey  <span class="comment">-- Correlated!</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> o_orderkey, (</span><br><span class="line">    <span class="keyword">SELECT</span> c_name</span><br><span class="line">    <span class="keyword">FROM</span> CUSTOMER</span><br><span class="line">    <span class="keyword">WHERE</span> c_custkey <span class="operator">=</span> o_custkey  <span class="comment">-- Correlated!</span></span><br><span class="line">) <span class="keyword">AS</span> c_name <span class="keyword">FROM</span> ORDERS</span><br></pre></td></tr></table></figure></li>
<li><p><strong>存在性检测子查询</strong>：特指 EXISTS 的子查询，返回一个布尔值。如果出现在 WHERE 中，这就是我们熟悉的 Semi-Join。当然，它可能出现在任何可以放布尔值的地方。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--Semi-Join</span></span><br><span class="line"><span class="keyword">SELECT</span> c_custkey</span><br><span class="line"><span class="keyword">FROM</span> CUSTOMER</span><br><span class="line"><span class="keyword">WHERE</span> c_nationkey <span class="operator">=</span> <span class="number">86</span> <span class="keyword">AND</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ORDERS</span><br><span class="line">    <span class="keyword">WHERE</span> o_custkey <span class="operator">=</span> c_custkey  <span class="comment">-- Correlated!</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li><p><strong>集合比较子查询</strong>：特指 IN、SOME、ANY 的查询，返回一个布尔值，常用的形式有：x = SOME(Q) （等价于 x IN Q）或 X &lt;&gt; ALL(Q)（等价于 x NOT IN Q）。同上，它可能出现在任何可以放布尔值的地方。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_name</span><br><span class="line"><span class="keyword">FROM</span> CUSTOMER</span><br><span class="line"><span class="keyword">WHERE</span> c_nationkey <span class="operator">&lt;&gt;</span> <span class="keyword">ALL</span> (<span class="keyword">SELECT</span> s_nationkey <span class="keyword">FROM</span> SUPPLIER)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/60380557" title="Title">去关联化</a>，测试执行标量子查询示例1，可以发现子查询是挂在filter下的，实际执行时就会变成查询执行器调用表达式执行器，表达式执行器因为子查询再调用查询执行器，当数据比较多时很明显会对效率造成很大的影响。</p>
</blockquote>
<h3 id="2-2-优化案例"><a href="#2-2-优化案例" class="headerlink" title="2.2 优化案例"></a>2.2 优化案例</h3><h4 id="（1）慢查询优化案例"><a href="#（1）慢查询优化案例" class="headerlink" title="（1）慢查询优化案例"></a>（1）慢查询优化案例</h4><p>通过对慢查询的监控告警，经常会发现一些SQL语句where过滤字段都有索引，但是由于SQL写法的问题导致索引失效，下面二个案例解释如何通过SQL改写来查询。可以通过以下SQL来捞取最近5分钟的慢查询进行告警。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> CONCAT( <span class="string">&#x27;# Time: &#x27;</span>, DATE_FORMAT(start_time, <span class="string">&#x27;%y%m%d %H%i%s&#x27;</span>), <span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;# User@Host: &#x27;</span>, user_host, <span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;# Query_time: &#x27;</span>, TIME_TO_SEC(query_time),  <span class="string">&#x27;  Lock_time: &#x27;</span>, TIME_TO_SEC(lock_time), <span class="string">&#x27;  Rows_sent: &#x27;</span>, rows_sent, <span class="string">&#x27;  Rows_examined: &#x27;</span>, rows_examined, <span class="string">&#x27;\n&#x27;</span>, sql_text, <span class="string">&#x27;;&#x27;</span> ) <span class="keyword">FROM</span> mysql.slow_log <span class="keyword">where</span> start_time <span class="keyword">between</span> <span class="built_in">current_timestamp</span> <span class="keyword">and</span> date_add(<span class="built_in">CURRENT_TIMESTAMP</span>,<span class="type">INTERVAL</span> <span class="number">-5</span> <span class="keyword">MINUTE</span>);</span><br></pre></td></tr></table></figure>



<h5 id="1-慢查询SQL"><a href="#1-慢查询SQL" class="headerlink" title="1.慢查询SQL"></a>1.慢查询SQL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> <span class="number">2020</span><span class="number">-10</span><span class="number">-02</span> <span class="number">19</span>:<span class="number">17</span>:<span class="number">23</span> <span class="operator">|</span> w_mini_user[w_mini_user] @ [<span class="number">10.200</span><span class="number">.20</span><span class="number">.11</span>] <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">02</span>   <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>  <span class="operator">|</span>         <span class="number">9</span> <span class="operator">|</span>        <span class="number">443117</span> <span class="operator">|</span> mini_user <span class="operator">|</span>              <span class="number">0</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span> <span class="number">168387936</span> <span class="operator">|</span> <span class="keyword">select</span> id,club_id,reason,status,type,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>) <span class="keyword">or</span> (invite_id<span class="operator">=</span><span class="number">12395</span> <span class="keyword">or</span> applicant_id<span class="operator">=</span><span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>; <span class="operator">|</span> <span class="number">1219921665</span> <span class="operator">|</span></span><br></pre></td></tr></table></figure>

<p>从慢查询slow_log可以看到，执行时间2s，扫描了443117行，只返回了9行，这是不合理的。</p>
<h5 id="2-SQL分析"><a href="#2-SQL分析" class="headerlink" title="2.SQL分析"></a>2.SQL分析</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--原始SQL，频繁访问的接口，目前执行时间2s。</span></span><br><span class="line"><span class="keyword">select</span> id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>) <span class="keyword">or</span> (invite_id<span class="operator">=</span><span class="number">12395</span> <span class="keyword">or</span> app_id<span class="operator">=</span><span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--执行计划</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>        <span class="operator">|</span> type  <span class="operator">|</span> possible_keys                   <span class="operator">|</span> key        <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t_user_msg <span class="operator">|</span> index <span class="operator">|</span> invite_id,app_id,team_id <span class="operator">|</span> created_time <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>从执行计划可以看到，表上有单列索引 <code>invite_id,app_id,team_id,created_time</code>，走的是create_time的索引，而且type=index索引全扫描，因为create_time没有出现在where条件后，只出现在order by后面，只能是type=index，这也预示着表数据量越大该SQL越慢，我们期望是走三个单列索引 <code>invite_id，app_id，team_id</code>，然后type=index_merge操作。</p>
<p>按照常规思路，对于OR条件拆分两部分，分别进行分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>从执行计划看走的是team_id的索引，没有问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>        <span class="operator">|</span> type <span class="operator">|</span> possible_keys        <span class="operator">|</span> key     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+------+----------------------+---------+---------+-------+------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t_user_msg <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> app_id,team_id <span class="operator">|</span> team_id <span class="operator">|</span> <span class="number">8</span>       <span class="operator">|</span> const <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br></pre></td></tr></table></figure>



<p>再看另外一个sql语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span>  <span class="operator">*</span><span class="operator">*</span>(invite_id<span class="operator">=</span><span class="number">12395</span> <span class="keyword">or</span> app_id<span class="operator">=</span><span class="number">12395</span>)<span class="operator">*</span><span class="operator">*</span> <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<p>从执行计划上看，分别走的是invite_id,app_id的单列索引，同时做了index_merge合并操作，也没有问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>        <span class="operator">|</span> type        <span class="operator">|</span> possible_keys           <span class="operator">|</span> key                     <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+-------------+-------------------------+-------------------------+---------+------+------+-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t_user_msg <span class="operator">|</span> index_merge <span class="operator">|</span> invite_id,app_id <span class="operator">|</span> invite_id,app_id <span class="operator">|</span> <span class="number">9</span>,<span class="number">9</span>     <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">union</span>(invite_id,app_id); <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br></pre></td></tr></table></figure>



<p><strong>通过上面的分析，第一部分SQL走的执行计划走team_id索引没问题，第二部分SQL分别走invite_id,app_id索引并且index_merge也没问题，为什么两部分SQL进行OR关联之后走create_time的单列索引呢，不应该是三个单列索引的index_merge吗？</strong></p>
<p><strong>index_merge默认是在优化器选项是开启的，主要是将多个范围扫描的结果集合并成一个，可以通过变量查看。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span><span class="keyword">select</span> @<span class="variable">@optimizer</span>_switch;</span><br><span class="line"><span class="operator">|</span> index_merge<span class="operator">=</span><span class="keyword">on</span>,index_merge_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_sort_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_intersection<span class="operator">=</span><span class="keyword">on</span>,</span><br></pre></td></tr></table></figure>



<p>其他三个字段都传入的是具体的值，而且都走了相应的索引，只能怀疑app_id is not null这个条件影响了CBO对最终执行计划的选择，去掉这个条件来看执行计划，竟然走了三个单列索引且type=index_merge，那下面只要搞定<strong>app_id is not null</strong>这个条件就OK了吧。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span>        <span class="operator">|</span> type        <span class="operator">|</span> possible_keys                   <span class="operator">|</span> key                             <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> Extra                                                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+--------------+-------------+---------------------------------+---------------------------------+---------+------+------+---------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t_user_msg <span class="operator">|</span> index_merge <span class="operator">|</span> invite_id,app_id,teadm_id <span class="operator">|</span> team_id,invite_id,app_id <span class="operator">|</span> <span class="number">8</span>,<span class="number">9</span>,<span class="number">9</span>   <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>   <span class="number">32</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">union</span>(team_id,invite_id,app_id); <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br></pre></td></tr></table></figure>



<h5 id="3-SQL改写"><a href="#3-SQL改写" class="headerlink" title="3.SQL改写"></a>3.SQL改写</h5><p>通过上面分析得知，条件 <code>app_id is not null</code> 影响了CBO的选择，下面进行改造。</p>
<h6 id="改写优化1"><a href="#改写优化1" class="headerlink" title="改写优化1"></a>改写优化1</h6><p>根据SQL开发规范改写，将OR改写成Union All方式即可，最终的SQL如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, ……. <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span> id, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="operator">*</span><span class="operator">*</span><span class="number">1</span> <span class="keyword">and</span> (club_id <span class="keyword">in</span> (<span class="number">5821</span>) <span class="keyword">and</span> applicant_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>)<span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="operator">*</span><span class="operator">*</span><span class="keyword">union</span> <span class="keyword">all</span><span class="operator">*</span><span class="operator">*</span> <span class="keyword">select</span> id, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="operator">*</span><span class="operator">*</span><span class="number">1</span> <span class="keyword">and</span> invitee_id<span class="operator">=</span><span class="string">&#x27;146737&#x27;</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="operator">*</span><span class="operator">*</span><span class="keyword">union</span> <span class="keyword">all</span><span class="operator">*</span><span class="operator">*</span> <span class="keyword">select</span> id, ……. <span class="keyword">from</span>  t_user_msg <span class="keyword">where</span> <span class="operator">*</span><span class="operator">*</span><span class="number">1</span> <span class="keyword">and</span> app_id<span class="operator">=</span><span class="string">&#x27;146737&#x27;</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       ) <span class="keyword">as</span> a <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>一般情况下，Java代码和SQL是分开的，SQL是配置在xml文件中，根据业务需求，除了team_id是必填，其他两个都是可选的，所以这种改写虽然能提高SQL执行效率，但不适合这种业务场景。</p>
<h6 id="改写优化2"><a href="#改写优化2" class="headerlink" title="改写优化2"></a>改写优化2</h6><p>app_id is not null 改写为**IFNULL(app_id, 0) &gt;0)**，最终的SQL为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,team_id,reason,status,type,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> <span class="operator">*</span><span class="operator">*</span>IFNULL(app_id, <span class="number">0</span>) <span class="operator">&gt;</span><span class="number">0</span>)<span class="operator">*</span><span class="operator">*</span>) <span class="keyword">or</span> (invite_id<span class="operator">=</span><span class="number">12395</span> <span class="keyword">or</span> app_id<span class="operator">=</span><span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<h6 id="改写优化3"><a href="#改写优化3" class="headerlink" title="改写优化3"></a>改写优化3</h6><p>将字段app_id bigint(20) DEFAULT NULL，变更为app_id bigint(20) <strong>NOT NULL DEFAULT 0</strong>，同时更新将app_id is null的时候全部更新成0，就可以将条件app_id is not null 转换为app_id &gt; 0，最终的SQL为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,team_id,reason,status,type,created_at,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> <span class="operator">*</span><span class="operator">*</span>app_id <span class="operator">&gt;</span> <span class="number">0</span>)<span class="operator">*</span><span class="operator">*</span>) <span class="keyword">or</span> (invite_id<span class="operator">=</span><span class="number">12395</span> <span class="keyword">or</span> app_id<span class="operator">=</span><span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> limit <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>从执行计划看，两种改写优化方式都走三个单列索引，执行时间从2s降低至10ms，线上采用的是<strong>优化1</strong>的方式，如果一开始能遵循MySQL开发规范就就会避免问题的发生。</p>
<p>上面介绍了SQL规范性检查，表结构检查，索引检查以及通过SQL改写来优化查询，在编写代码的过程，如果能提前做这些规范性检查，评估出自己认为理想的执行计划，然后通过explain解析出MySQL CBO的执行计划，两者做对比分析差异，弄清楚自己的选择和CBO的不同，不但能够编写高质量的SQL，同时也能清楚CBO的工作原理。</p>
<h4 id="（2）生产环境RPC服务调用超时"><a href="#（2）生产环境RPC服务调用超时" class="headerlink" title="（2）生产环境RPC服务调用超时"></a>（2）生产环境RPC服务调用超时</h4><h5 id="1-排查过程"><a href="#1-排查过程" class="headerlink" title="1.排查过程"></a>1.排查过程</h5><p><strong>问题描述：</strong>生产环境反映进行大批量数据转换操作时，流程一直没结束。</p>
<p><strong>排查过程：</strong></p>
<ol>
<li>获取日志后进行分析，发现MQ消息发送频率异常，消息产生速率远远大于处理速率。</li>
<li>程序一直在报RPC调用超时（超时时间5分钟）对应服务是持久层的一个查询SQL。</li>
<li>确认了SQL本身非慢查询，以防万一用Oracle的STA分析了下，没有优化建议。</li>
<li>继续观察日志，发现环境数据操作频繁，怀疑是服务器负载过高，导致某些流程未正常结束，以及数据库是否有较长的等待事件。</li>
<li>查看了下Oracle的会话状态，发现活跃会话数有近400个，平时在30左右。</li>
<li>查到一些会话有等待事件且等待时间很长，查出阻塞的SQL相关信息，确认等待原因为 <code>cursor: pin S wait on X</code>（有300多个）和 <code>PGA memory operation</code> （2个）。</li>
<li>发现所有会话都在等待一个SQL，正好是超时的服务接口对应的一个查询。所有等待事件的来源是 <code>PGA memory operation</code> 。</li>
<li>查阅该事件相关文档。</li>
<li>导出对应时间段的AWR报告，分析得到数据库服务器的负载过高，大部分信息和上文排查内容一致，无法定位到具体问题，转交由DBA处理。</li>
</ol>
<h5 id="2-使用到的SQL"><a href="#2-使用到的SQL" class="headerlink" title="2.使用到的SQL"></a>2.使用到的SQL</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"># 查询等待事件</span><br><span class="line"><span class="keyword">select</span> inst_id,event,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> gv$session_wait</span><br><span class="line"><span class="keyword">where</span> wait_class <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;Idle&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> inst_id, event <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span> <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"># 活跃的会话信息</span><br><span class="line"><span class="keyword">SELECT</span> b.inst_id,b.sid oracleID,</span><br><span class="line">       b.username 登录Oracle用户名,</span><br><span class="line">       b.serial#,</span><br><span class="line">       spid 操作系统ID,</span><br><span class="line">       paddr,</span><br><span class="line">       sql_text 正在执行的<span class="keyword">SQL</span>,</span><br><span class="line">       sql_fulltext,</span><br><span class="line">       b.machine 计算机名,</span><br><span class="line">       b.EVENT,</span><br><span class="line">       <span class="string">&#x27;alter system kill session &#x27;&#x27;&#x27;</span><span class="operator">||</span>b.sid<span class="operator">||</span><span class="string">&#x27;,&#x27;</span><span class="operator">||</span>b.serial#<span class="operator">||</span><span class="string">&#x27;&#x27;&#x27;;&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> gv$process a, gv$session b, gv$<span class="keyword">sql</span> c</span><br><span class="line"><span class="keyword">WHERE</span> a.addr <span class="operator">=</span> b.paddr</span><br><span class="line">   <span class="keyword">AND</span> b.sql_hash_value <span class="operator">=</span> c.hash_value</span><br><span class="line">   <span class="keyword">and</span> a.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> b.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> c.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> b.status<span class="operator">=</span><span class="string">&#x27;ACTIVE&#x27;</span>;</span><br><span class="line">   </span><br><span class="line"># 对应等待事件的会话信息</span><br><span class="line"><span class="keyword">SELECT</span> b.inst_id,b.sid oracleID,</span><br><span class="line">       b.username 登录Oracle用户名,</span><br><span class="line">       b.serial#,</span><br><span class="line">       spid 操作系统ID,</span><br><span class="line">       paddr,</span><br><span class="line">       sql_text 正在执行的<span class="keyword">SQL</span>,</span><br><span class="line">       sql_fulltext,</span><br><span class="line">       b.machine 计算机名,</span><br><span class="line">       b.EVENT,</span><br><span class="line">       c.SQL_ID,</span><br><span class="line">       c.CHILD_NUMBER</span><br><span class="line"><span class="keyword">FROM</span> gv$process a, gv$session b, gv$<span class="keyword">sql</span> c</span><br><span class="line"><span class="keyword">WHERE</span> a.addr <span class="operator">=</span> b.paddr</span><br><span class="line">   <span class="keyword">AND</span> b.sql_hash_value <span class="operator">=</span> c.hash_value</span><br><span class="line">	 <span class="keyword">order</span> <span class="keyword">by</span> b.sid</span><br><span class="line"><span class="keyword">and</span> event <span class="keyword">like</span> <span class="string">&#x27;%s wait for x%&#x27;</span></span><br><span class="line">   <span class="keyword">and</span> a.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> b.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> c.inst_id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dba_hist_active_sess_history <span class="keyword">where</span> event <span class="operator">=</span><span class="string">&#x27;cursor: pin S wait on X&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 根据时间统计会话数</span><br><span class="line"><span class="keyword">select</span> to_char(ash.sample_time, <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) SAMPLE_TIME,<span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line"><span class="keyword">from</span> dba_hist_active_sess_history ash</span><br><span class="line"><span class="keyword">where</span> ash.instance_number<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="keyword">and</span> ash.wait_class <span class="operator">&lt;&gt;</span> <span class="string">&#x27;Idle&#x27;</span>  <span class="comment">/* 非空闲回话 **/</span></span><br><span class="line"> <span class="keyword">and</span> ash.sample_time <span class="keyword">between</span> sysdate <span class="number">-1</span><span class="operator">/</span><span class="number">2</span> <span class="keyword">and</span> sysdate</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> SAMPLE_TIME</span><br><span class="line"> <span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">1</span> </span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> SAMPLE_TIME;</span><br><span class="line"></span><br><span class="line"># 查看某个时间节点<span class="keyword">SQL</span>执行情况</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">   to_char(ash.sample_time, <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) SAMPLE_TIME</span><br><span class="line">   ,ash.sql_id</span><br><span class="line">   ,ash.event</span><br><span class="line">   ,<span class="built_in">count</span>(<span class="operator">*</span>) CNT <span class="comment">/* SQL的数量 **/</span></span><br><span class="line">   ,TRUNC(<span class="built_in">SUM</span>(TIME_WAITED) <span class="operator">/</span> <span class="number">1000000</span>,<span class="number">2</span>) SECONDS_IN_WAIT <span class="comment">/* SQL的等待时间 **/</span></span><br><span class="line">   ,<span class="built_in">SUM</span>(to_number(<span class="built_in">CAST</span>(ash.sample_time <span class="keyword">AS</span> <span class="type">DATE</span>)<span class="operator">-</span>ash.sql_exec_start) <span class="operator">*</span><span class="number">24</span><span class="operator">*</span><span class="number">60</span><span class="operator">*</span><span class="number">60</span> ) SECONDS_IN_EXECUTE <span class="comment">/* SQL的执行时间 **/</span></span><br><span class="line"><span class="keyword">from</span> dba_hist_active_sess_history ash</span><br><span class="line"><span class="keyword">where</span> ash.instance_number<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="keyword">and</span> ash.wait_class <span class="operator">&lt;&gt;</span> <span class="string">&#x27;Idle&#x27;</span></span><br><span class="line"> <span class="keyword">and</span> to_char(ash.sample_time,<span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) <span class="operator">=</span> <span class="string">&#x27;2021-04-21 15:11:16&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> ash.sample_time,ash.sql_id,ash.event</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> CNT <span class="keyword">desc</span>,SAMPLE_TIME,<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  to_char(ash.sample_time, <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) SAMPLE_TIME</span><br><span class="line"> ,ash.event</span><br><span class="line"> ,ash.sql_id </span><br><span class="line"> ,ash.blocking_inst_id</span><br><span class="line"> ,ash.blocking_session</span><br><span class="line"> ,ash.blocking_session_serial#</span><br><span class="line"> ,<span class="built_in">count</span>(<span class="operator">*</span>) cnt</span><br><span class="line"><span class="keyword">from</span> dba_hist_active_sess_history ash </span><br><span class="line"><span class="keyword">where</span> ash.instance_number<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="keyword">and</span> ash.wait_class <span class="operator">&lt;&gt;</span> <span class="string">&#x27;idle&#x27;</span></span><br><span class="line"> <span class="keyword">and</span> ash.sql_id <span class="operator">=</span> <span class="string">&#x27;4qn8f6ujgjy9f&#x27;</span></span><br><span class="line"> <span class="keyword">and</span> to_char(ash.sample_time,<span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) <span class="operator">=</span> <span class="string">&#x27;2021-04-21 15:11:16&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sample_time,ash.event,ash.sql_id,ash.blocking_inst_id,ash.blocking_session,ash.blocking_session_serial#</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sample_time,<span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"># 分析下<span class="number">4448</span>，<span class="number">58047</span>会话的历史执行情况</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line"> to_char(ash.sample_time, <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) sample_time</span><br><span class="line">,to_char(ash.sql_exec_start,<span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) SQL_START_TIME</span><br><span class="line">,ash.instance_number inst_id</span><br><span class="line">,ash.session_id sid</span><br><span class="line">,ash.session_serial# serial </span><br><span class="line">,ash.blocking_inst_id b_inst_id</span><br><span class="line">,ash.blocking_session b_sid</span><br><span class="line">,ash.blocking_session_serial# b_serial</span><br><span class="line">,ash.sql_id</span><br><span class="line">,ash.event</span><br><span class="line">,to_number(<span class="built_in">CAST</span>(ash.sample_time <span class="keyword">AS</span> <span class="type">DATE</span>)<span class="operator">-</span>ash.sql_exec_start) <span class="operator">*</span><span class="number">24</span><span class="operator">*</span><span class="number">60</span><span class="operator">*</span><span class="number">60</span> SECONDS_IN_EXECUTE</span><br><span class="line">,ash.xid</span><br><span class="line"><span class="keyword">from</span> dba_hist_active_sess_history ash</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line"> <span class="keyword">and</span> ash.instance_number<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="keyword">and</span> ash.session_id <span class="operator">=</span> <span class="number">4448</span></span><br><span class="line"> <span class="keyword">and</span> ash.session_serial# <span class="operator">=</span> <span class="number">58047</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sample_time;</span><br><span class="line"></span><br><span class="line"># 创建STA分析任务</span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">my_task_name varchar2(<span class="number">30</span>);</span><br><span class="line">my_sqltext <span class="type">CLOB</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">my_sqltext :<span class="operator">=</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">            select XXX</span></span><br><span class="line"><span class="string">			from XXX&#x27;</span>;</span><br><span class="line"># 删除 STA</span><br><span class="line"><span class="comment">--dbms_sqltune.drop_tuning_task(task_name =&gt; &#x27;smalltab_inner_bigtab_sql&#x27;);</span></span><br><span class="line"># 创建 STA</span><br><span class="line">my_task_name :<span class="operator">=</span> dbms_sqltune.create_tuning_task(</span><br><span class="line">sql_text <span class="operator">=</span><span class="operator">&gt;</span> my_sqltext,</span><br><span class="line">user_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="built_in">upper</span>(<span class="string">&#x27;XXX&#x27;</span>),</span><br><span class="line"><span class="keyword">scope</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;COMPREHENSIVE&#x27;</span>,</span><br><span class="line">time_limit <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">60</span>,</span><br><span class="line">task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;test_sql_account&#x27;</span>,</span><br><span class="line">description <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;优化smalltab和bigtab连接到的例子&#x27;</span></span><br><span class="line">);</span><br><span class="line"># 执行 STA</span><br><span class="line">dbms_sqltune.execute_tuning_task(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;test_sql_account&#x27;</span>);</span><br><span class="line"></span><br><span class="line">dbms_output.put_line(<span class="string">&#x27;my_task_name=&#x27;</span><span class="operator">||</span>my_task_name);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> OWNER,TASK_ID,TASK_NAME,STATUS <span class="keyword">FROM</span> DBA_ADVISOR_LOG <span class="keyword">WHERE</span> TASK_NAME<span class="operator">=</span><span class="string">&#x27;test_sql_account&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  DBMS_SQLTUNE.EXECUTE_TUNING_TASK( task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;test_sql_account&#x27;</span> );</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"># 查看<span class="keyword">SQL</span> TUNING状态</span><br><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> USER_ADVISOR_TASKS <span class="keyword">WHERE</span>  task_name <span class="operator">=</span> <span class="string">&#x27;test_sql_account&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> DBMS_SQLTUNE.REPORT_TUNING_TASK(<span class="string">&#x27;test_sql_account&#x27;</span>) <span class="keyword">FROM</span> DUAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> v$session;</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="string">&#x27;call sys.dbms_shared_pool.purge(&#x27;&#x27;&#x27;</span><span class="operator">||</span>t.ADDRESS<span class="operator">||</span><span class="string">&#x27;,&#x27;</span><span class="operator">||</span>t.hash_value<span class="operator">||</span><span class="string">&#x27;&#x27;&#x27;,&#x27;&#x27;c&#x27;&#x27;)&#x27;</span></span><br><span class="line">SQL_TEXT,sql_id, address, hash_value, executions, loads, parse_calls, invalidations  </span><br><span class="line"><span class="keyword">from</span> v$<span class="keyword">sql</span> t <span class="keyword">where</span> t.SQL_ID <span class="operator">=</span> <span class="string">&#x27;1uw84jcq6802a&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> sys.dbms_shared_pool.purge(<span class="string">&#x27;000000009C88A8F0,1227751471&#x27;</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"><span class="keyword">call</span> sys.dbms_shared_pool.purge(<span class="string">&#x27;0000000068220548,150339650&#x27;</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"><span class="keyword">call</span> sys.dbms_shared_pool.purge(<span class="string">&#x27;000000009A7D2700,744751178&#x27;</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看等待事件<span class="keyword">cursor</span>: pin S wait <span class="keyword">on</span> X的会话信息</span><br><span class="line"><span class="keyword">select</span> s.inst_id <span class="keyword">as</span> inst,</span><br><span class="line">       s.sid <span class="keyword">as</span> blocked_sid,  <span class="comment">--被阻塞进程</span></span><br><span class="line">       s.username <span class="keyword">as</span> blocked_user,  <span class="comment">--被阻塞用户</span></span><br><span class="line">       sa.sql_id <span class="keyword">as</span> blocked_sql_id,  <span class="comment">--被阻塞sql_id</span></span><br><span class="line">       trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>) <span class="keyword">as</span> blocking_sid, <span class="comment">--阻塞进程</span></span><br><span class="line">       b.username <span class="keyword">as</span> blocking_user,  <span class="comment">--阻塞用户</span></span><br><span class="line">       b.sql_id <span class="keyword">as</span> blocking_sql_id  <span class="comment">--阻塞sql_id</span></span><br><span class="line"><span class="keyword">from</span> gv$session s</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa</span><br><span class="line">  <span class="keyword">on</span> sa.hash_value <span class="operator">=</span> s.p1</span><br><span class="line"><span class="keyword">join</span> gv$session b</span><br><span class="line">  <span class="keyword">on</span> trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>)<span class="operator">=</span>b.sid</span><br><span class="line"> <span class="keyword">and</span> s.inst_id<span class="operator">=</span>b.inst_id</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa2</span><br><span class="line">  <span class="keyword">on</span> b.sql_id<span class="operator">=</span>sa2.sql_id</span><br><span class="line"><span class="keyword">where</span> s.event<span class="operator">=</span><span class="string">&#x27;cursor: pin S wait on X&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> gv$session;</span><br><span class="line"># 阻塞的<span class="keyword">SQL</span>版本、执行和解析数</span><br><span class="line"><span class="keyword">select</span> sql_id,loaded_versions,executions,loads,invalidations,parse_calls</span><br><span class="line"><span class="keyword">from</span> gv$<span class="keyword">sql</span> </span><br><span class="line"><span class="keyword">where</span> sql_id<span class="operator">=</span><span class="string">&#x27;cn7m7t6y5h77g&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h5 id="3-相关文档"><a href="#3-相关文档" class="headerlink" title="3.相关文档"></a>3.相关文档</h5><h6 id="文档1"><a href="#文档1" class="headerlink" title="文档1"></a>文档1</h6><blockquote>
<p>从12.1迁移到12.2后SQL语句执行缓慢等待在”PGA memory operation”和”Acknowledge over PGA limit”(Doc ID 2403920.1)</p>
<p>（内容省略）……</p>
<p><strong>原因：</strong></p>
<p>“PGA memory operation” 只是一个新的等待事件，用来衡量之前版本并未测量的一个等待。该事件较大可能是因为底层硬件出现了CPU或内存的短缺。在12.2.0.1环境中，可用物理内存大小与TABLE ACCESS FULL和MERGE JOIN操作的块大小相比非常低。</p>
<p>“PGA memory operation” is just an new wait event to expose a prior unmeasured wait in earlier versions of the database. High wait times for that event likely mean the underlying OS/hardware is becoming CPU or memory starved. In customer’s 12.2.0.1 environment, the Available Physical Memory size was very low compared to the blocks size of TABLE ACCESS FULL and MERGE JOIN operation. Therefore the overhead of memory resource operation in OS side spent a lot of CPU time.</p>
<p>因此，OS端内存资源操作的开销花费了大量的CPU时间。</p>
<p><strong>解决方案：</strong></p>
<p>有必要增加物理内存大小，或将SQL执行调整到主机服务器有更多可用物理内存的另一时间段。超大内存大小的工作区也可能会提高SQL性能，从而增加会话工作区大小并降低对临时空间的访问。</p>
<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> PGA_AGGREGATE_TARGET <span class="operator">=</span> <span class="number">1500</span>M;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> &quot;_pga_max_size&quot; <span class="operator">=</span> <span class="number">1</span>G;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> &quot;_smm_max_size&quot; <span class="operator">=</span> <span class="number">1048576</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="文档2"><a href="#文档2" class="headerlink" title="文档2"></a>文档2</h6><p>以下内容来自：<a target="_blank" rel="noopener" href="https://cdn.modb.pro/doc/18880">Oracle从 12.1 迁移到 12.2 后 SQL 语句执行缓慢等待在”PGA memory operation”和”Acknowledge over PGA limit” (Doc ID 2403920.1).pdf</a></p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc1.png"></p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc2.png"></p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc3.png"></p>
<p><img src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/content/20210701/OracleDoc4.png"></p>
<h6 id="文档3"><a href="#文档3" class="headerlink" title="文档3"></a>文档3</h6><p>Oracle文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21127313/article/details/71191187">Memory Notification: Library Cache Object loaded into SGA / ORA-600 [KGL-heap-size-exceeded]</a></li>
<li><a target="_blank" rel="noopener" href="https://support.oracle.com/knowledge/Oracle%20Database%20Products/2288973_1.html">ASM session hang waiting for PGA memory operation (Doc ID 2288973.1)</a></li>
</ul>
<p>内容：</p>
<ul>
<li><p><strong>APPLIES TO</strong>：Oracle Database - Enterprise Edition - Version 10.2.0.1 and later<br>Information in this document applies to any platform. <em><strong>Checked for relevance 17-Aug-2014</strong></em></p>
</li>
<li><p><strong>SYMPTOMS</strong>：In alert log there are reported messages like the following: Memory Notification: Library Cache Object loaded into SGA, Heap size <code>&lt;heap size K&gt;</code> exceeds notification threshold (51200K)</p>
</li>
<li><p><strong>CAUSE</strong>：</p>
<p>These are warning messages that are not causing process failure. </p>
<p>They appear as a result of event messaging mechanism and memory manager introduced starting with 10gR2 database release. </p>
<p>As large objects in the shared pool can potentially cause problems this warning threshold was implemented. </p>
<p>Items/SQLs which allocate more space than this warning threshold, outputs a warning to the alert log. </p>
<p>This warning is only to inform that a given heap object exceeds the defined threshold size and a trace file is generated so that a DBA can check potentially expensive - from shared memory point of view - objects. </p>
<p>These are purely warning messages and have no impact on the database functionality, although they are designed to indicate possible tuning opportunities in customers’ applications. </p>
<p>The messages do not imply that an ORA-4031 is about to happen immediately unless the size of shared pool is very small.</p>
</li>
<li><p><strong>SOLUTION</strong>：</p>
<p>A hidden parameter - _kgl_large_heap_warning_threshold - that sets the KGL heap size warning threshold was introduced starting with 10gR2. Warnings are written if heap size in shared pool exceeds this threshold: </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">_kgl</span>_large_heap_warning_threshold =&gt; maximum heap size <span class="keyword">before</span> KGL writes warnings <span class="built_in">to</span> <span class="keyword">the</span> alert <span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p>Besides reducing the heap size from the application code (recommended) one can set _kgl_large_heap_warning_threshold to a reasonable high value or zero to prevent these warning messages. The value needs to be set in bytes. For example:</p>
<p>If using a SPFILE: </p>
<p>=============</p>
<p>(logged in as “/ as sysdba”)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> &quot;_kgl_large_heap_warning_threshold&quot;<span class="operator">=</span><span class="number">83886080</span> <span class="keyword">scope</span><span class="operator">=</span>spfile ; </span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> shutdown immediate</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> startup</span><br></pre></td></tr></table></figure>

<p>If using a PFILE:</p>
<p>============<br>Edit the PFILE and add:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">_kgl_large_heap_warning_threshold</span>=<span class="number">8388608</span></span><br></pre></td></tr></table></figure>

<p>The default threshold in 10.2.0.1 is only 2M. Starting with 10.2.0.2 the threshold was increased to 50MB after regression tests, so this should be a reasonable and recommended value in most cases.</p>
<p>In 12.1.0.2 database release (that includes the fix Bug 15898589 - enhancement to restrict the size of SGA base library cache heaps) an enhancement to restrict the size of SGA base library cache heaps was introduced in order to avoid running out of space inside shared pool and hence ORA-4031 errors. With this fix, a new hidden parameter - _kgl_large_heap_assert_threshold - was also introduced. </p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_kgl_large_heap_assert_threshold =&gt; maximum heap size <span class="built_in">before</span> KGL raises an internal error</span><br></pre></td></tr></table></figure>

<p>Its value represents the maximum heap size before raising the ORA-600 internal error like:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORA-<span class="number">00600</span>: internal error <span class="selector-tag">code</span>, arguments: <span class="selector-attr">[KGL-heap-size-exceeded]</span>, <span class="selector-attr">[0x7FF91F844240]</span>, <span class="selector-attr">[6]</span>, <span class="selector-attr">[532279608]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span>, <span class="selector-attr">[]</span></span><br></pre></td></tr></table></figure>

<p>To check current value of the parameters, one can run the following query:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">nam.ksppinm NAME,</span><br><span class="line">nam.ksppdesc DESCRIPTION,</span><br><span class="line">val.KSPPSTVL</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">x$ksppi nam,</span><br><span class="line">x$ksppsv val</span><br><span class="line"><span class="keyword">where</span> nam.indx <span class="operator">=</span> val.indx <span class="keyword">and</span> nam.ksppinm <span class="keyword">like</span> <span class="string">&#x27;%kgl_large_heap_%_threshold%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>For example in 12.1.0.2 the default values for the two parameters are:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> nam.ksppinm NAME,</span><br><span class="line">      nam.ksppdesc DESCRIPTION,</span><br><span class="line">      val.KSPPSTVL</span><br><span class="line"><span class="keyword">from</span> x$ksppi nam,  x$ksppsv val</span><br><span class="line"><span class="keyword">where</span> nam.indx <span class="operator">=</span> val.indx <span class="keyword">and</span> nam.ksppinm <span class="keyword">like</span><span class="string">&#x27;%kgl_large_heap_%_threshold%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">\<span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">DESCRIPTION</span><br><span class="line">\<span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">KSPPSTVL</span><br><span class="line">\<span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">_kgl_large_heap_warning_threshold</span><br><span class="line">maximum heap size before KGL writes warnings <span class="keyword">to</span> the alert log</span><br><span class="line"><span class="number">52428800</span></span><br><span class="line"></span><br><span class="line">_kgl_large_heap_assert_threshold</span><br><span class="line">maximum heap size before KGL raises an internal error</span><br><span class="line"><span class="number">524288000</span></span><br></pre></td></tr></table></figure>

<p>Please be aware that by setting _kgl_large_heap_warning_threshold to 0 in 12.1.0.2 it is caused the problem described in:</p>
</li>
<li><p>MORE：</p>
<p>Bug 22330282 - “Heap size 0K exceeds notification threshold” alert messages when “_kgl_large_heap_warning_threshold” is set to 0 (<a target="_blank" rel="noopener" href="https://support.oracle.com/epmos/faces/DocumentDisplay?parent=DOCUMENT&sourceId=330239.1&id=22330282.8">Document: 22330282.8</a>)</p>
<p>To fix this problem either:</p>
<p>==&gt; Apply <a target="_blank" rel="noopener" href="https://support.oracle.com/epmos/faces/ui/patch/PatchDetail.jspx?parent=DOCUMENT&sourceId=330239.1&patchId=22330282">Patch 22330282</a> or open a backport request with Oracle Support if the patch is not available for your database release and/or platform.</p>
<p>or</p>
<p>==&gt; Either of following options may workaround the issue:<br>a. Set _kgl_large_heap_warning_threshold to a very large value.<br>b. Set both _kgl_large_heap_warning_threshold and _kgl_large_heap_assert_threshold to zero.</p>
<p>NOTE: In 11.2.0.4 or 12.1.0.1 in order to have the _kgl_large_heap_assert_threshold parameter available and avoid the Bug 22330282, apply [Patch Bug 22330282](<a target="_blank" rel="noopener" href="https://support.oracle.com/epmos/faces/ui/patch/PatchDetail.jspx?parent=DOCUMENT&amp;sourceId=330239.1&amp;patchId=Bug">https://support.oracle.com/epmos/faces/ui/patch/PatchDetail.jspx?parent=DOCUMENT&amp;sourceId=330239.1&amp;patchId=Bug</a> 22330282) or open a backport request with Oracle Support if the patch is not available for your database release and/or platform.</p>
</li>
</ul>
<p>参考内容：</p>
<p>🔗 <a target="_blank" rel="noopener" href="http://www.dba-oracle.com/t_cursor_pin_wait_on_x.htm">cursor: pin S wait on X</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://oracleblog.org/working-case/a-case-of-cursor-pin-s-wait-on-x/">记一次cursor pin s wait on X的处理</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://database.51cto.com/art/201910/604490.htm">详解Oracle数据库硬解析、软解析、软软解析联系与区别</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://blog.pythian.com/cursor-pin-s-wait-on-x-in-the-top-5-wait-events/">CURSOR: PIN S WAIT ON X IN THE TOP 5 WAIT EVENTS</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56563180/ora-00600-arguments-kgl-heap-size-exceeded">ORA-00600 , Arguments: [KGL-heap-size-exceeded]</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="http://oraclewizard.com/2018/02/25/pga-memory-operation-events/">PGA Memory Operation Events</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://asktom.oracle.com/pls/apex/asktom.search?tag=concurrency-wait-event">Concurrency Wait Event</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/shelly01-zhou/p/9006192.html">oracle性能优化之awr分析</a></p>
<h4 id="（3）大表SQL查询执行超时"><a href="#（3）大表SQL查询执行超时" class="headerlink" title="（3）大表SQL查询执行超时"></a>（3）大表SQL查询执行超时</h4><p><strong>问题描述：</strong>生产环境大批量数据转换，数据未能转换成功，MQ队列堆积了大量消息。</p>
<p><strong>排查过程：</strong></p>
<ol>
<li>数据转换通过MQ消息触发，所以首先排查消息队列，发现堆积了很多消息，三天前的任务还未被处理掉。</li>
<li>排查日志发现有多个SQL一直在执行超时，大大降低了消息的消费速度，导致数据一直不能被成功处理。</li>
<li>现场测试环境未能复现相同问题，Oracle版本分别为19c和12c。</li>
<li>排查Oracle等待事件定位到latch: cache buffers chains，等待的SQL与超时的SQL刚好匹配。产生该事件的原因主要是低效的SQL。</li>
<li>生产环境排查确认有命中索引，PLSQL中单独执行能很快返回。</li>
<li>获取相应时段的AWR报告，按1小时或半小时，获取超时SQL的执行计划。</li>
<li>DBA协助优化SQL，用hint语法优化not exists和in改为表关联。现场直接实验发现问题解决。</li>
</ol>
<h3 id="2-3-Oracle-STA优化SQL"><a href="#2-3-Oracle-STA优化SQL" class="headerlink" title="2.3 Oracle STA优化SQL"></a>2.3 Oracle STA优化SQL</h3><p>SQL Tuning Advisor，可以从四个角度给出SQL的优化建议：</p>
<ul>
<li>为统计信息丢失或失效的对象收集统计信息；</li>
<li>考虑优化器的任何数据偏差、复杂谓词或失效的统计信息；</li>
<li>重新构建 SQL 以优化性能；</li>
<li>提出新索引建议。</li>
</ul>
<p>简单使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 声明优化任务，单引号中的单引号要转义，&#x27;&#x27;a&#x27;&#x27;双单引号代替</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">my_task_name VARCHAR2(<span class="number">30</span>);</span><br><span class="line">my_sqltext  <span class="type">CLOB</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">my_sqltext :<span class="operator">=</span> <span class="string">&#x27;select xxx from xxx&#x27;</span>;</span><br><span class="line">my_task_name :<span class="operator">=</span> DBMS_SQLTUNE.CREATE_TUNING_TASK(</span><br><span class="line">sql_text    <span class="operator">=</span><span class="operator">&gt;</span> my_sqltext,</span><br><span class="line">user_name   <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;xxx&#x27;</span>,  <span class="comment">--表示语句由哪个数据库用户执行</span></span><br><span class="line"><span class="keyword">scope</span>       <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;COMPREHENSIVE&#x27;</span>,</span><br><span class="line">time_limit  <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">30</span>,</span><br><span class="line">task_name   <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;tuning_sql_test&#x27;</span>,</span><br><span class="line">description <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;tuning&#x27;</span>);</span><br><span class="line">DBMS_SQLTUNE.EXECUTE_TUNING_TASK( task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;tuning_sql_test&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 上面是传入文本的方式，还可以根据sql_id来创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取sql_id</span></span><br><span class="line"><span class="keyword">select</span> sql_id,sql_text <span class="keyword">from</span> v$sqlarea <span class="keyword">where</span> sql_text <span class="keyword">like</span> <span class="string">&#x27;%bigtab%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 声明优化任务</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">my_task_name VARCHAR2(<span class="number">30</span>);</span><br><span class="line">sql_id VARCHAR2(<span class="number">30</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">sql_id :<span class="operator">=</span> <span class="string">&#x27;&amp;sqlid&#x27;</span>;</span><br><span class="line">my_task_name :<span class="operator">=</span> DBMS_SQLTUNE.CREATE_TUNING_TASK(</span><br><span class="line">sql_id  <span class="operator">=</span><span class="operator">&gt;</span> sql_id,</span><br><span class="line"><span class="keyword">scope</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;comprehensive&#x27;</span>,</span><br><span class="line">time_limit<span class="operator">=</span><span class="operator">&gt;</span><span class="number">60</span>,</span><br><span class="line">task_name<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;tuning_sql_test&#x27;</span>,</span><br><span class="line">description <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;Tuning Task&#x27;</span>);</span><br><span class="line">DBMS_SQLTUNE.EXECUTE_TUNING_TASK(<span class="string">&#x27;tuning_sql_test&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行创建的优化任务</span></span><br><span class="line"><span class="keyword">exec</span> dbms_sqltune.execute_tuning_task(<span class="string">&#x27;tuning_sql_test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看任务状态</span></span><br><span class="line"><span class="keyword">SELECT</span> task_name,status <span class="keyword">FROM</span> USER_ADVISOR_TASKS <span class="keyword">WHERE</span> task_name <span class="operator">=</span><span class="string">&#x27;tuning_sql_test&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看优化建议</span></span><br><span class="line"><span class="keyword">select</span> DBMS_SQLTUNE.REPORT_TUNING_TASK( <span class="string">&#x27;tuning_sql_test&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除优化任务</span></span><br><span class="line"><span class="keyword">exec</span> dbms_sqltune.drop_tuning_task(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;tuning_sql_test&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>分析结果：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">GENERAL INFORMATION SECTION</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Tuning Task Name   : tuning_sql_test</span><br><span class="line">Tuning Task Owner  : XXX</span><br><span class="line">Workload Type      : Single SQL Statement</span><br><span class="line">Execution Count    : 2</span><br><span class="line">Current Execution  : EXEC_38176</span><br><span class="line">Execution Type     : TUNE SQL</span><br><span class="line">Scope              : COMPREHENSIVE</span><br><span class="line">Time Limit(seconds): 30</span><br><span class="line">Completion Status  : COMPLETED</span><br><span class="line">Started at         : XXX</span><br><span class="line">Completed at       : XXX</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Schema Name: XXX</span><br><span class="line">SQL ID     : 8jzqw0sc2w7dx</span><br><span class="line">SQL Text   : select XXX from XXX</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">FINDINGS SECTION (2 findings)</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">1- Index Finding (see explain plans section below)</span><br><span class="line">--------------------------------------------------</span><br><span class="line">  通过创建一个或多个索引可以改进此语句的执行计划。</span><br><span class="line"></span><br><span class="line">  Recommendation (estimated benefit: 99.71%)</span><br><span class="line">  ------------------------------------------</span><br><span class="line">  - 考虑运行可以改进物理方案设计的访问指导或者创建推荐的索引。</span><br><span class="line">    create index XXX.IDX$$_8F240001 on</span><br><span class="line">    XXX.XXX(<span class="string">&quot;column_a&quot;</span>,<span class="string">&quot;column_b&quot;</span>,<span class="string">&quot;column_c&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Rationale</span><br><span class="line">  ---------</span><br><span class="line">    创建推荐的索引可以显著地改进此语句的执行计划。但是, 使用典型的 SQL 工作量运行 <span class="string">&quot;访问指导&quot;</span></span><br><span class="line">    可能比单个语句更可取。通过这种方法可以获得全面的索引建议案, 包括计算索引维护的开销和附加的空间消耗。</span><br><span class="line"></span><br><span class="line">2- Restructure SQL finding (see plan 1 in explain plans section)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">  在执行计划的行 ID 2 处发现开销很大的笛卡尔积操作。</span><br><span class="line"></span><br><span class="line">  Recommendation</span><br><span class="line">  --------------</span><br><span class="line">  - 考虑从此语句中移去断开连接的表或视图, 或者添加引用它的联接条件。</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">EXPLAIN PLANS SECTION</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">1- Original</span><br><span class="line">-----------</span><br><span class="line">Plan hash value: 87783638</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line">|<span class="string">Id</span>|<span class="string"> Operation                         </span>|<span class="string"> Name    </span>|<span class="string"> Rows </span>|<span class="string">Bytes</span>|<span class="string">Cost (%CPU)</span>|<span class="string">   Time   </span>|</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line">|<span class="string"> 0</span>|<span class="string">SELECT STATEMENT                   </span>|<span class="string">         </span>|<span class="string">   1  </span>|<span class="string"> 127 </span>|<span class="string"> 1769 (1)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string"> 1</span>|<span class="string">SORT ORDER BY                      </span>|<span class="string">         </span>|<span class="string">   1  </span>|<span class="string"> 127 </span>|<span class="string"> 1769 (1)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string"> 2</span>|<span class="string">MERGE JOIN OUTER                   </span>|<span class="string">         </span>|<span class="string">   1  </span>|<span class="string"> 127 </span>|<span class="string"> 1768 (1)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string">*3</span>|<span class="string">TABLE ACCESS BY INDEX ROWID BATCHED</span>|<span class="string"> XXX     </span>|<span class="string">   1  </span>|<span class="string"> 113 </span>|<span class="string"> 1767 (1)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string">*4</span>|<span class="string">INDEX RANGE SCAN                   </span>|<span class="string"> IDX_XXX </span>|<span class="string"> 20627</span>|<span class="string">     </span>|<span class="string"> 106  (0)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string"> 5</span>|<span class="string">BUFFER SORT                        </span>|<span class="string">         </span>|<span class="string">   1  </span>|<span class="string"> 14  </span>|<span class="string"> 2   (50)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string"> 6</span>|<span class="string">TABLE ACCESS BY INDEX ROWID        </span>|<span class="string"> XXX     </span>|<span class="string">   1  </span>|<span class="string"> 14  </span>|<span class="string"> 1    (0)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">|<span class="string">*7</span>|<span class="string">INDEX UNIQUE SCAN                  </span>|<span class="string"> IDX_XXX </span>|<span class="string">   1  </span>|<span class="string">     </span>|<span class="string"> 0    (0)  </span>|<span class="string"> 00:00:01 </span>|</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line"> </span><br><span class="line">   3 - filter(<span class="string">&quot;A&quot;</span>.<span class="string">&quot;column_c&quot;</span>&gt;=20210720.1054 AND <span class="string">&quot;A&quot;</span>.<span class="string">&quot;column_b&quot;</span>=1 AND </span><br><span class="line">              <span class="string">&quot;A&quot;</span>.<span class="string">&quot;column_d&quot;</span><span class="variable">&lt;=20210720.155735)</span></span><br><span class="line"><span class="variable">   4 - access(&quot;A&quot;.&quot;column_a&quot;=&#x27; &#x27; AND &quot;A&quot;.&quot;column_e&quot;&gt;</span>=0)</span><br><span class="line">   7 - access(<span class="string">&quot;B&quot;</span>.<span class="string">&quot;column_a&quot;</span>(+)=&#x27; &#x27;)</span><br><span class="line"></span><br><span class="line">2- Using New Indices</span><br><span class="line">--------------------</span><br><span class="line">Plan hash value: 1238368121</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line">|<span class="string">Id</span>|<span class="string"> Operation                         </span>|<span class="string"> Name         </span>|<span class="string"> Rows </span>|<span class="string">Bytes</span>|<span class="string">Cost (%CPU)</span>|<span class="string"> Time   </span>|</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line">|<span class="string"> 0</span>|<span class="string"> SELECT STATEMENT                  </span>|<span class="string">              </span>|<span class="string">    1 </span>|<span class="string"> 127 </span>|<span class="string">   5 (20)  </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string"> 1</span>|<span class="string"> SORT ORDER BY                     </span>|<span class="string">              </span>|<span class="string">    1 </span>|<span class="string"> 127 </span>|<span class="string">   5 (20)  </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string"> 2</span>|<span class="string"> MERGE JOIN OUTER                  </span>|<span class="string">              </span>|<span class="string">    1 </span>|<span class="string"> 127 </span>|<span class="string">   4 (0)   </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string">*3</span>|<span class="string">TABLE ACCESS BY INDEX ROWID BATCHED</span>|<span class="string"> XXX          </span>|<span class="string">    1 </span>|<span class="string"> 113 </span>|<span class="string">   3 (0)   </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string">*4</span>|<span class="string"> INDEX RANGE SCAN                  </span>|<span class="string">IDX$$_8F240001</span>|<span class="string">    1 </span>|<span class="string">     </span>|<span class="string">   2 (0)   </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string"> 5</span>|<span class="string"> BUFFER SORT                       </span>|<span class="string">              </span>|<span class="string">    1 </span>|<span class="string"> 14  </span>|<span class="string">   2 (50)  </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string"> 6</span>|<span class="string"> TABLE ACCESS BY INDEX ROWID       </span>|<span class="string"> XXX          </span>|<span class="string">    1 </span>|<span class="string"> 14  </span>|<span class="string">   1 (0)   </span>|<span class="string">00:00:01</span>|</span><br><span class="line">|<span class="string">*7</span>|<span class="string"> INDEX UNIQUE SCAN                 </span>|<span class="string"> IDX_XXX      </span>|<span class="string">    1 </span>|<span class="string">     </span>|<span class="string">   0 (0)   </span>|<span class="string">00:00:01</span>|</span><br><span class="line">-----------------------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line"> </span><br><span class="line">   3 - filter(<span class="string">&quot;A&quot;</span>.<span class="string">&quot;column_e&quot;</span>&gt;=0 AND <span class="string">&quot;A&quot;</span>.<span class="string">&quot;column_d&quot;</span><span class="variable">&lt;=20210720.155735)</span></span><br><span class="line"><span class="variable">   4 - access(&quot;A&quot;.&quot;column_a&quot;=&#x27; &#x27; AND &quot;A&quot;.&quot;column_b&quot;=1 AND &quot;A&quot;.&quot;column_c&quot;&gt;</span>=20210720.1054)</span><br><span class="line">   7 - access(<span class="string">&quot;B&quot;</span>.<span class="string">&quot;column_a&quot;</span>(+)=&#x27; &#x27;)</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>



<h3 id="2-4-临时表优化"><a href="#2-4-临时表优化" class="headerlink" title="2.4 临时表优化"></a>2.4 临时表优化</h3><p>参考：<a href="../2021082701.html" title="Title">MySql临时表</a></p>
<h3 id="2-5-Explain"><a href="#2-5-Explain" class="headerlink" title="2.5 Explain"></a>2.5 Explain</h3><p>参考：<a href="../2021101401.html" title="Title">执行计划</a></p>
<h2 id="三-问题排查"><a href="#三-问题排查" class="headerlink" title="三. 问题排查"></a>三. 问题排查</h2><h3 id="3-1-死锁"><a href="#3-1-死锁" class="headerlink" title="3.1 死锁"></a>3.1 死锁</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 查看死锁是否存在</span><br><span class="line"><span class="keyword">select</span> username,lockwait,status,machine,program,sid <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object);</span><br><span class="line"></span><br><span class="line"># 查看死锁的语句</span><br><span class="line"><span class="keyword">select</span> sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> <span class="keyword">where</span> hash_value <span class="keyword">in</span> </span><br><span class="line">(<span class="keyword">select</span> sql_hash_value <span class="keyword">from</span> v$session <span class="keyword">where</span> sid <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> session_id <span class="keyword">from</span> v$locked_object));</span><br><span class="line"> </span><br><span class="line"># 查找死锁的进程：</span><br><span class="line">sqlplus &quot;/as sysdba&quot; (sys<span class="operator">/</span>change_on_install)</span><br><span class="line"><span class="keyword">SELECT</span> s.username,l.OBJECT_ID,l.SESSION_ID,s.SERIAL#,</span><br><span class="line">l.ORACLE_USERNAME,l.OS_USER_NAME,l.PROCESS </span><br><span class="line"><span class="keyword">FROM</span> V$LOCKED_OBJECT l,V$SESSION S <span class="keyword">WHERE</span> l.SESSION_ID<span class="operator">=</span>S.SID;</span><br></pre></td></tr></table></figure>





<h3 id="3-2-等待事件"><a href="#3-2-等待事件" class="headerlink" title="3.2 等待事件"></a>3.2 等待事件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 查询等待的事件</span><br><span class="line"><span class="keyword">select</span> inst_id,event,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> gv$session_wait</span><br><span class="line"><span class="keyword">where</span> wait_class <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;Idle&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> inst_id, event <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span> <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"># 查询等待事件在执行的<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> b.inst_id,b.sid oracleID,</span><br><span class="line">       b.username 登录Oracle用户名,</span><br><span class="line">       b.serial#,</span><br><span class="line">       spid 操作系统ID,</span><br><span class="line">       paddr,</span><br><span class="line">       sql_text 正在执行的<span class="keyword">SQL</span>,</span><br><span class="line">       sql_fulltext,</span><br><span class="line">       b.machine 计算机名,</span><br><span class="line">       b.EVENT,</span><br><span class="line">       c.SQL_ID,</span><br><span class="line">       c.CHILD_NUMBER</span><br><span class="line"><span class="keyword">FROM</span> gv$process a, gv$session b, gv$<span class="keyword">sql</span> c</span><br><span class="line"><span class="keyword">WHERE</span> a.addr <span class="operator">=</span> b.paddr</span><br><span class="line">   <span class="keyword">AND</span> b.sql_hash_value <span class="operator">=</span> c.hash_value</span><br><span class="line"><span class="keyword">and</span> event <span class="keyword">like</span> <span class="string">&#x27;%pin S wait on X%&#x27;</span></span><br><span class="line">   <span class="keyword">and</span> a.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> b.inst_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">   <span class="keyword">and</span> c.inst_id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 查询阻塞与被阻塞的<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> s.inst_id <span class="keyword">as</span> inst,</span><br><span class="line">       s.sid <span class="keyword">as</span> blocked_sid,</span><br><span class="line">       s.username <span class="keyword">as</span> blocked_user,</span><br><span class="line">       sa.sql_id <span class="keyword">as</span> blocked_sql_id,</span><br><span class="line">       trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>) <span class="keyword">as</span> blocking_sid,</span><br><span class="line">       b.username <span class="keyword">as</span> blocking_user,</span><br><span class="line">       b.sql_id <span class="keyword">as</span> blocking_sql_id</span><br><span class="line"><span class="keyword">from</span> gv$session s</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa</span><br><span class="line">  <span class="keyword">on</span> sa.hash_value <span class="operator">=</span> s.p1</span><br><span class="line"><span class="keyword">join</span> gv$session b</span><br><span class="line">  <span class="keyword">on</span> trunc(s.p2<span class="operator">/</span><span class="number">4294967296</span>)<span class="operator">=</span>b.sid</span><br><span class="line"> <span class="keyword">and</span> s.inst_id<span class="operator">=</span>b.inst_id</span><br><span class="line"><span class="keyword">join</span> gv$sqlarea sa2</span><br><span class="line">  <span class="keyword">on</span> b.sql_id<span class="operator">=</span>sa2.sql_id</span><br><span class="line"><span class="keyword">where</span> s.event <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> s.event <span class="operator">&lt;&gt;</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 根据SQL_ID查看<span class="keyword">SQL</span>内容</span><br><span class="line"><span class="keyword">select</span> sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> <span class="keyword">where</span> sql_id<span class="operator">=</span><span class="string">&#x27;f5qdnpakv26q8&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 查看会话信息</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session <span class="keyword">WHERE</span> OSUSER <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session <span class="keyword">WHERE</span> prev_sql_id <span class="operator">=</span> <span class="string">&#x27;f5qdnpakv26q8&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$session <span class="keyword">WHERE</span> sql_id <span class="operator">=</span> <span class="string">&#x27;f5qdnpakv26q8&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 查看VERSION_COUNT不正常的<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> inst_id,con_id,sql_id,version_count <span class="keyword">from</span> gv$sqlarea <span class="keyword">where</span> version_count <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"># 查看数据库模式</span><br><span class="line"><span class="keyword">select</span> sys_context(<span class="string">&#x27;USERENV&#x27;</span>,<span class="string">&#x27;CON_NAME&#x27;</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>





<hr>
<p>参考：</p>
<p>🔗 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/nEmN4S9JOTVGj5IHyfNtCw" title="Title">工作以来总结的大厂SQL调优姿势</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/54607717" title="Title">where子句的优化</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/60380557" title="Title">SQL子查询的优化</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/exe19/p/5786806.html" title="Title">要提高SQL查询效率where语句条件的先后次序应如何写</a></p>
<p>🔗 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6897837587042402318#heading-5">5分钟快速掌握阿里内部MySQL性能优化的核心技术</a></p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2020021801.html" rel="bookmark">Oralce和MySql笔记（持续更新）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021101401.html" rel="bookmark">执行计划（更新中）</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021121801.html" rel="bookmark">海量数据处理</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021121201.html" rel="bookmark">优化分页查询</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2020092401.html" rel="bookmark">SqlLoader</a></div>
    </li>
  </ul>


    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Lys
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://linyishui.top/2019091401.html" title="SQL规范和优化（持续更新）">http://linyishui.top/2019091401.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/updating/" rel="tag"><i class="fa fa-tag"></i> updating</a>
              <a href="/tags/sql/" rel="tag"><i class="fa fa-tag"></i> sql</a>
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
              <a href="/tags/oracle/" rel="tag"><i class="fa fa-tag"></i> oracle</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019091301.html" rel="prev" title="垃圾收集器（三）内存分配与回收策略">
                  <i class="fa fa-chevron-left"></i> 垃圾收集器（三）内存分配与回收策略
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019091501.html" rel="next" title="正则表达式 <整>">
                  正则表达式 <整> <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lys</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">3.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">53:11</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"LAILAIWA/LAILAIWA.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>



</body>
</html>
