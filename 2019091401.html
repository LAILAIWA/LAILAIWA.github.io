<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/Dig Dug.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/gamepad playstation.png?v=5.1.4">


  <link rel="mask-icon" href="/images/gamepad playstation.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="updating,sql,mysql,oracle,">





  <link rel="alternate" href="/atom.xml" title="俺的部落格" type="application/atom+xml">






<meta name="description" content="简单整理SQL规范和优化相关内容。">
<meta name="keywords" content="updating,sql,mysql,oracle">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL规范和优化&lt;整&gt;（持续更新）">
<meta property="og:url" content="http://linyishui.top/2019091401.html">
<meta property="og:site_name" content="俺的部落格">
<meta property="og:description" content="简单整理SQL规范和优化相关内容。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-04-20T07:08:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL规范和优化&lt;整&gt;（持续更新）">
<meta name="twitter:description" content="简单整理SQL规范和优化相关内容。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linyishui.top/2019091401.html">





  <title>SQL规范和优化<整>（持续更新） | 俺的部落格</整></title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z0L5T0JQG7"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Z0L5T0JQG7');
    }
  </script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a73137787baf0001a5bc4063855efe8a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">俺的部落格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">俺寻思俺需要记点东西</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linyishui.top/2019091401.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="林沂水">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="俺的部落格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SQL规范和优化<整>（持续更新）</整></h1>
        

        <div class="post-meta">
          
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-14T14:40:30+08:00">
                2019-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人记录/" itemprop="url" rel="index">
                    <span itemprop="name">个人记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,524
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19
                </span>
              
            </div>
          

          
              <div class="post-description">
                  简单整理SQL规范和优化相关内容。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="SQL规范和优化"><a href="#SQL规范和优化" class="headerlink" title="SQL规范和优化"></a>SQL规范和优化</h1><h2 id="第一节-SQL规范"><a href="#第一节-SQL规范" class="headerlink" title="第一节 SQL规范"></a>第一节 SQL规范</h2><h3 id="1-1-命名规范"><a href="#1-1-命名规范" class="headerlink" title="1.1 命名规范"></a>1.1 命名规范</h3><p>表和视图的命名，长度不超过 30 个字符 。</p>
<p>表名及字段名设置要合理，不能使用MySQL的关键字，如desc, order, status, group等。</p>
<p>设置lower_case_table_names = 1表名不区分大小写。</p>
<p>对象前缀命名原则：</p>
<table>
<thead>
<tr>
<th style="text-align:left">对象类型</th>
<th style="text-align:left">对象前缀</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">表（table）</td>
<td style="text-align:left">t</td>
<td style="text-align:left">t_module_name</td>
</tr>
<tr>
<td style="text-align:left">临时表（temporary table）</td>
<td style="text-align:left">tmp</td>
<td style="text-align:left">tmp_module_name</td>
</tr>
<tr>
<td style="text-align:left">视图（view）</td>
<td style="text-align:left">v</td>
<td style="text-align:left">v_表名</td>
</tr>
<tr>
<td style="text-align:left">非唯一索引（ index）</td>
<td style="text-align:left">idx</td>
<td style="text-align:left">idx_表名 _每列首字母</td>
</tr>
<tr>
<td style="text-align:left">唯一索引（unique index）</td>
<td style="text-align:left">uk</td>
<td style="text-align:left">uk_表名 _每列首字母</td>
</tr>
<tr>
<td style="text-align:left">主键（primary key）</td>
<td style="text-align:left">pk</td>
<td style="text-align:left">pk_表名</td>
</tr>
<tr>
<td style="text-align:left">过程（procedure）</td>
<td style="text-align:left">p</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">函数（function）</td>
<td style="text-align:left">f</td>
</tr>
</tbody>
</table>
<h3 id="1-2-格式规范"><a href="#1-2-格式规范" class="headerlink" title="1.2 格式规范"></a>1.2 格式规范</h3><p>略。</p>
<h3 id="1-3-设计规范"><a href="#1-3-设计规范" class="headerlink" title="1.3 设计规范"></a>1.3 设计规范</h3><p>通用：</p>
<ul>
<li>尽量不要用 char 类型，用 varchar 类型代替（可变）。</li>
<li>字段建议定义为 not null，并且指定默认值，如果列值存储了大量的NULL，会影响索引的稳定性。。</li>
<li>禁止使用外键，外键约束应该在应用层处理。建议在 ER 图里保留外键。</li>
<li>字段的备注要能明确该字段的作用，尤其是某些表示状态的字段，要显式的写出该字段所有可能的状态数值以及该数值的含义。</li>
<li>不建议使用Text数据类型，一方面由于传输大量的数据包可能会超过max_allowed_packet设置导致程序报错，另一方面表上的DML操作都会变的很慢，建议采用es或者对象存储OSS来存储和检索。</li>
</ul>
<p>MySQL：</p>
<ul>
<li>使用 InnoDB存储引擎，可以通过参数default_storage_engine控制。</li>
<li>字符集统一使用 UTF8MB4 。</li>
<li>所有表都必须有主键。</li>
<li>不涉及分库分表的表选用 auto_increment 列做主键，主键类型使用无符号整型；涉及到要做分库分表的表用有序uuid做主键。</li>
<li>主键之外，应增加代表业务规则的唯一索引，但不建议直接将其作为主键。</li>
<li>禁止使用 enum/set/bool 类型， 尽量不使用 text/blobs 等大字段类型 。</li>
<li>禁止使用浮点类型 FLOAT 和 DOUBLE。</li>
<li>对较长的字符型字段建立索引时，应使用前缀索引。</li>
</ul>
<p>Oracle：</p>
<ul>
<li>建议表和索引的数据分不同表空间存储。</li>
<li>原则上每个表都应该有主键。</li>
<li>优先使用业务主键，在业务主键超过3个字段时考虑使用逻辑主键，把业务主键建成唯一约束。</li>
<li>不建议在分区表上创建全局索引，原则上一律使用 local索引。</li>
</ul>
<p>建表的时候主键id带有AUTO_INCREMENT属性，而且AUTO_INCREMENT=1，在InnoDB内部是通过一个系统全局变量dict_sys.row_id来计数，row_id是一个8字节的bigint unsigned，InnoDB在设计时只给row_id保留了6个字节的长度，这样row_id取值范围就是 0 到 2^48^ - 1，如果id的值达到了最大值，下一个值就从0开始继续循环递增，在代码中禁止指定主键id值插入。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--新插入的id值会从10001开始，这是不对的，应该从1开始。</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> booking( <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键id'</span>,......) <span class="keyword">engine</span> = <span class="keyword">InnoDB</span> auto_increment = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--指定了id值插入，后续自增就会从该值开始+1，索引禁止指定id值插入。</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> booking(<span class="keyword">id</span>, book_sn) <span class="keyword">values</span>(<span class="number">1234551121</span>, <span class="string">'N12121'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="1-4-语法规范"><a href="#1-4-语法规范" class="headerlink" title="1.4 语法规范"></a>1.4 语法规范</h3><h4 id="（1）select-检查"><a href="#（1）select-检查" class="headerlink" title="（1）select 检查"></a>（1）select 检查</h4><ul>
<li><p><strong>禁止 select * 这样的代码 ，必须将字段名一一列出</strong>。</p>
</li>
<li><p><strong>尽量避免在 select 后使用自定义函数</strong> ：SQL返回多少行，那么UDF函数就会被调用多少次，非常影响性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--getOrderNo是用户自定义一个函数用户来根据order_sn来获取订单编号</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, payment_id, order_sn, getOrderNo(order_sn) <span class="keyword">from</span> payment_transaction <span class="keyword">where</span> <span class="keyword">status</span> = <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">'2020-10-01 10:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-10-02 10:00:00'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免查询 text 类型字段</strong> ：如果select出现text类型的字段，就会消耗大量的网络和IO带宽，由于返回的内容过大超过max_allowed_packet设置会导致程序报错，需要评估谨慎使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--表request_log的中content是text类型。</span></span><br><span class="line"><span class="keyword">select</span> user_id, <span class="keyword">content</span>, <span class="keyword">status</span>, <span class="keyword">url</span>, <span class="keyword">type</span> <span class="keyword">from</span> request_log <span class="keyword">where</span> user_id = <span class="number">32121</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>谨慎使用 group_concat</strong> ：gorup_concat是一个字符串聚合函数，会影响SQL的响应时间，如果返回的值过大超过了max_allowed_packet设置会导致程序报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> batch_id, <span class="keyword">group_concat</span>(<span class="keyword">name</span>) <span class="keyword">from</span> buffer_batch <span class="keyword">where</span> <span class="keyword">status</span> = <span class="number">0</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">'2020-10-01 10:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-10-02 10:00:00'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内联子查询</strong> ：在select后面有子查询的情况称为内联子查询，SQL返回多少行，子查询就需要执行过多少次，严重影响SQL性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,(<span class="keyword">select</span> rule_name <span class="keyword">from</span> member_rule <span class="keyword">limit</span> <span class="number">1</span>) <span class="keyword">as</span> rule_name, member_id, member_type, member_name, <span class="keyword">status</span>  <span class="keyword">from</span> member_info m <span class="keyword">where</span> <span class="keyword">status</span> = <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">'2020-09-02 10:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-10-01 10:00:00'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>……</p>
</li>
</ul>
<h4 id="（2）from-检查"><a href="#（2）from-检查" class="headerlink" title="（2）from 检查"></a>（2）from 检查</h4><ul>
<li><p><strong>当 SQL涉及到多个表时， 必须为每个字段指定表名前缀</strong>。</p>
</li>
<li><p><strong>定义表和子查询的别名时不能重名</strong>。</p>
</li>
<li><p><strong>尽量避免表关联</strong> ：在MySQL中不建议使用Left Join，即使ON过滤条件列索引，一些情况也不会走索引，导致大量的数据行被扫描，SQL性能变得很差，同时要清楚ON和Where的区别。应避免带 in 的子查询，尽量改写成 join？没必要的时候不要做外连接，内连接效率比外连接高 。外连接一律用 left join，禁止使用 right join。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.member_id,a.create_time,b.active_time <span class="keyword">FROM</span> operation_log a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> member_info b <span class="keyword">ON</span> a.member_id = b.member_id <span class="keyword">where</span>  b.<span class="string">`status`</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> a.create_time <span class="keyword">between</span> <span class="string">'2020-10-01 00:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-10-30 00:00:00'</span> <span class="keyword">limit</span> <span class="number">100</span>, <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>避免子查询</strong> ：由于MySQL的基于成本的优化器CBO对子查询的处理能力比较弱，不建议使用子查询，可以改写成 Inner Join</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b.member_id,b.member_type, a.create_time,a.device_model <span class="keyword">from</span> member_operation_log a <span class="keyword">inner</span> <span class="keyword">join</span> (<span class="keyword">select</span> member_id,member_type <span class="keyword">from</span> member_base_info <span class="keyword">where</span> <span class="string">`status`</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">'2020-10-01 00:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-10-30 00:00:00'</span>) <span class="keyword">as</span> b <span class="keyword">on</span> a.member_id = b.member_id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>……</p>
</li>
</ul>
<h4 id="（3）where-检查"><a href="#（3）where-检查" class="headerlink" title="（3）where 检查"></a>（3）where 检查</h4><ul>
<li><p><strong>where条件列上禁止使用函数和表达式 ，也要避免数据类型的隐式转换。</strong></p>
</li>
<li><p>使用 like进行模糊查询时， %不要放在首位 ，因为会限制对索引的使用 。<br>例如 <code>like &#39;abc%&#39;</code> 可以走索引，而 <code>like &#39;%abc&#39;</code> 或者 <code>&#39;%abc%&#39;</code> 都不会走索引。</p>
</li>
<li><p><strong>索引列被运算</strong> ：当一个字段被索引，同时出现where条件后面，是不能进行任何运算，会导致索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--device_no列上有索引，由于使用了ltrim函数导致索引失效</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> , phone, address, device_no <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">ltrim</span>(device_no) = <span class="string">'Hfs1212121'</span>;</span><br><span class="line"><span class="comment">--balance列有索引,由于做了运算导致索引失效</span></span><br><span class="line"><span class="keyword">select</span> account_no, balance <span class="keyword">from</span> accounts <span class="keyword">where</span> balance + <span class="number">100</span> = <span class="number">10000</span> <span class="keyword">and</span> <span class="keyword">status</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>类型转换</strong> ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--user_id是bigint类型，传入varchar值发生了隐式类型转换，可以走索引。</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> , phone, address, device_no <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> user_id = <span class="string">'23126'</span>;</span><br><span class="line"><span class="comment">--card_no是varchar(20)，传入int值是无法走索引</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> , phone, address, device_no <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> card_no = <span class="number">2312612121</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>列字符集</strong> ：从MySQL 5.6开始建议所有对象字符集应该使用用utf8mb4，包括MySQL实例字符集，数据库字符集，表字符集，列字符集。避免在关联查询Join时字段字符集不匹配导致索引失效，同时目前只有utf8mb4支持emoji表情存储。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">character_set_server  =  utf8mb4    #数据库实例字符集</span><br><span class="line">character_set_connection = utf8mb4  #连接字符集</span><br><span class="line">character_set_database = utf8mb4    #数据库字符集</span><br><span class="line">character_set_results = utf8mb4     #结果集字符集</span><br></pre></td></tr></table></figure>
</li>
<li><p>……</p>
</li>
</ul>
<h4 id="（4）group-by-检查"><a href="#（4）group-by-检查" class="headerlink" title="（4）group by 检查"></a>（4）group by 检查</h4><ul>
<li><p><strong>前缀索引</strong>：group by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--device_no字段类型varchar(200)，创建了前缀索引。</span></span><br><span class="line">mysql&gt; alter table users add index idx_device_no(device_no(64));</span><br><span class="line"></span><br><span class="line">mysql&gt; select device_no, count(*) from users where create_time between '2020-10-01 00:00:00' and '2020-10-30 00:00:00' group by device_no;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>函数运算</strong>：假设需要统计某月每天的新增用户量，参考如下SQL语句，虽然可以走create_time的索引，但是不能消除排序，可以考虑冗余一个字段stats_date date类型来解决这种问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">DATE_FORMAT</span>(create_time, <span class="string">'%Y-%m-%d'</span>), <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> create_time <span class="keyword">between</span> <span class="string">'2020-09-01 00:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-09-30 23:59:59'</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">DATE_FORMAT</span>(create_time, <span class="string">'%Y-%m-%d'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>……</p>
</li>
</ul>
<h4 id="（5）order-by-检查"><a href="#（5）order-by-检查" class="headerlink" title="（5）order by 检查"></a>（5）order by 检查</h4><ul>
<li>避免不必要的排序 。order by、 group by、 distinct、 union等操作都有可能排序。<br>MySQL中 使用 group by 时， 默认会进行排序， 如果不需要排序 ，可以使用 order by null。</li>
<li><strong>前缀索引</strong>：order by后面的列有索引，索引可以消除排序带来的CPU开销，如果是前缀索引，是不能消除排序的。</li>
<li><strong>字段顺序</strong>：排序字段顺序，asc/desc升降要跟索引保持一致，充分利用索引的有序性来消除排序带来的CPU开销。</li>
<li>……</li>
</ul>
<h4 id="（6）limit-检查"><a href="#（6）limit-检查" class="headerlink" title="（6）limit 检查"></a>（6）limit 检查</h4><ul>
<li><strong>limit m,n要慎重</strong> ：对于limit m, n分页查询，越往后面翻页即m越大的情况下SQL的耗时会越来越长，对于这种应该先取出主键id，然后通过主键id跟原表进行Join关联查询。</li>
<li>……</li>
</ul>
<h4 id="（7）Union-检查"><a href="#（7）Union-检查" class="headerlink" title="（7）Union 检查"></a>（7）Union 检查</h4><ul>
<li>合并多个表的数据时，如果不需要去除重复数据，应使用 union all 而不是 union 。union需要做排序和去重操作，效率不如 union all。</li>
</ul>
<h4 id="（8）兼容性检查"><a href="#（8）兼容性检查" class="headerlink" title="（8）兼容性检查"></a>（8）兼容性检查</h4><p>同时支持MySQL和Oracle：</p>
<ul>
<li>对于单行注释应使用 <code>--</code> 方式 。</li>
<li>对于字符串应该使用单引号括起来。MySQL还支持双引号的方式，但 Oracle不支持。</li>
<li>尽量避免使用 full join。MySQL还不支持 full join。</li>
<li>避免在 group by和 having子句中使用列的别名。Oracle不支持这种语法。</li>
<li>from子句中的子查询要定义别名。MySQL中这个别名是必须要有的。</li>
</ul>
<h3 id="1-5-索引规范"><a href="#1-5-索引规范" class="headerlink" title="1.5 索引规范"></a>1.5 索引规范</h3><h4 id="1-5-1-索引属性"><a href="#1-5-1-索引属性" class="headerlink" title="1.5.1 索引属性"></a>1.5.1 索引属性</h4><p>索引基数指的是被索引的列唯一值的个数，唯一值越多接近表的count(*)说明索引的选择率越高，通过索引扫描的行数就越少，性能就越高，例如主键id的选择率是100%，在MySQL中尽量所有的update都使用主键id去更新，因为id是聚集索引存储着整行数据，不需要回表，性能是最高的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select count(*) from member_info;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|   148416 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.35</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> member_base_info;</span><br><span class="line">+<span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| Table            | Non_unique | Key_name                   | Seq_in_index | Column_name       | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</span><br><span class="line">+<span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| member_info |          <span class="number">0</span> | PRIMARY                    |            <span class="number">1</span> | <span class="keyword">id</span>                | A         |      <span class="number">131088</span> | <span class="literal">NULL</span>     | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| member_info |          <span class="number">0</span> | uk_member_id               |            <span class="number">1</span> | member_id         | A         |      <span class="number">131824</span> | <span class="literal">NULL</span>     | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| member_info |          <span class="number">1</span> | idx_create_time            |            <span class="number">1</span> | create_time       | A         |        <span class="number">6770</span> | <span class="literal">NULL</span>     | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">+<span class="comment">------------------+------------+----------------------------+--------------+-------------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="comment">--Table：表名</span></span><br><span class="line"><span class="comment">--Non_unique ：是否为unique index，0-是，1-否。</span></span><br><span class="line"><span class="comment">--Key_name：索引名称</span></span><br><span class="line"><span class="comment">--Seq_in_index：索引中的顺序号，单列索引-都是1；复合索引-根据索引列的顺序从1开始递增。</span></span><br><span class="line"><span class="comment">--Column_name：索引的列名</span></span><br><span class="line"><span class="comment">--Collation：排序顺序，如果没有指定asc/desc，默认都是升序ASC。</span></span><br><span class="line"><span class="comment">--Cardinality：索引基数-索引列唯一值的个数。</span></span><br><span class="line"><span class="comment">--sub_part：前缀索引的长度；例如index (member_name(10)，长度就是10。</span></span><br><span class="line"><span class="comment">--Packed：索引的组织方式，默认是NULL。</span></span><br><span class="line"><span class="comment">--Null：YES:索引列包含Null值；'':索引不包含Null值。</span></span><br><span class="line"><span class="comment">--Index_type：默认是BTREE，其他的值FULLTEXT，HASH，RTREE。</span></span><br><span class="line"><span class="comment">--Comment：在索引列中没有被描述的信息，例如索引被禁用。</span></span><br><span class="line"><span class="comment">--Index_comment：创建索引时的备注。</span></span><br></pre></td></tr></table></figure>
<h4 id="1-5-1-前缀索引"><a href="#1-5-1-前缀索引" class="headerlink" title="1.5.1 前缀索引"></a>1.5.1 前缀索引</h4><p>对于变长字符串类型varchar(m)，为了减少key_len，可以考虑创建前缀索引，但是前缀索引不能消除group by， order by带来排序开销。如果字段的实际最大值比m小很多，建议缩小字段长度。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> member_info <span class="keyword">add</span> <span class="keyword">index</span> idx_member_name_part(member_name(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>
<h4 id="1-5-3-复合索引顺序"><a href="#1-5-3-复合索引顺序" class="headerlink" title="1.5.3 复合索引顺序"></a>1.5.3 复合索引顺序</h4><p>有很多人喜欢在创建复合索引的时候，总以为前导列一定是唯一值多的列，例如索引 <code>index idx_create_time_status(create_time, status)</code>，这个索引往往是无法命中，因为扫描的IO次数太多，总体的cost的比全表扫描还大，CBO最终的选择是走 <code>full table scan</code>。</p>
<p>MySQL遵循的是索引最左匹配原则，对于复合索引，从左到右依次扫描索引列，到遇到第一个范围查询（&gt;=, &gt;,&lt;, &lt;=, between ….. and ….）就停止扫描，索引正确的索引顺序应该是 <code>index idx_status_create_time(status, create_time)</code> 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> account_no, balance <span class="keyword">from</span> accounts <span class="keyword">where</span> <span class="keyword">status</span> = <span class="number">1</span> <span class="keyword">and</span> create_time <span class="keyword">between</span> <span class="string">'2020-09-01 00:00:00'</span> <span class="keyword">and</span> <span class="string">'2020-09-30 23:59:59'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="1-5-4-时间列索引"><a href="#1-5-4-时间列索引" class="headerlink" title="1.5.4 时间列索引"></a>1.5.4 时间列索引</h4><p>对于默认字段 <code>created_at(create_time)</code>、<code>updated_at(update_time)</code> 这种默认就应该创建索引，这一般来说是默认的规则。</p>
<h2 id="第二节-SQL优化"><a href="#第二节-SQL优化" class="headerlink" title="第二节 SQL优化"></a>第二节 SQL优化</h2><h3 id="2-X-优化案例"><a href="#2-X-优化案例" class="headerlink" title="2.X 优化案例"></a>2.X 优化案例</h3><p>通过对慢查询的监控告警，经常会发现一些SQL语句where过滤字段都有索引，但是由于SQL写法的问题导致索引失效，下面二个案例解释如何通过SQL改写来查询。可以通过以下SQL来捞取最近5分钟的慢查询进行告警。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">CONCAT</span>( <span class="string">'# Time: '</span>, <span class="keyword">DATE_FORMAT</span>(start_time, <span class="string">'%y%m%d %H%i%s'</span>), <span class="string">'\n'</span>, <span class="string">'# User@Host: '</span>, user_host, <span class="string">'\n'</span>, <span class="string">'# Query_time: '</span>, TIME_TO_SEC(query_time),  <span class="string">'  Lock_time: '</span>, TIME_TO_SEC(lock_time), <span class="string">'  Rows_sent: '</span>, rows_sent, <span class="string">'  Rows_examined: '</span>, rows_examined, <span class="string">'\n'</span>, sql_text, <span class="string">';'</span> ) <span class="keyword">FROM</span> mysql.slow_log <span class="keyword">where</span> start_time <span class="keyword">between</span> <span class="keyword">current_timestamp</span> <span class="keyword">and</span> <span class="keyword">date_add</span>(<span class="keyword">CURRENT_TIMESTAMP</span>,<span class="built_in">INTERVAL</span> <span class="number">-5</span> <span class="keyword">MINUTE</span>);</span><br></pre></td></tr></table></figure>
<h4 id="（1）慢查询SQL"><a href="#（1）慢查询SQL" class="headerlink" title="（1）慢查询SQL"></a>（1）慢查询SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| 2020-10-02 19:17:23 | w_mini_user[w_mini_user] @ [10.200.20.11] | 00:00:02   | 00:00:00  |         9 |        443117 | mini_user |              0 |         0 | 168387936 | <span class="keyword">select</span> <span class="keyword">id</span>,club_id,reason,<span class="keyword">status</span>,<span class="keyword">type</span>,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>) <span class="keyword">or</span> (invite_id=<span class="number">12395</span> <span class="keyword">or</span> applicant_id=<span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>; | 1219921665 |</span><br></pre></td></tr></table></figure>
<p>从慢查询slow_log可以看到，执行时间2s，扫描了443117行，只返回了9行，这是不合理的。</p>
<h4 id="（2）SQL分析"><a href="#（2）SQL分析" class="headerlink" title="（2）SQL分析"></a>（2）SQL分析</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--原始SQL，频繁访问的接口，目前执行时间2s。</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,team_id,reason,<span class="keyword">status</span>,<span class="keyword">type</span>,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>) <span class="keyword">or</span> (invite_id=<span class="number">12395</span> <span class="keyword">or</span> app_id=<span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--执行计划</span></span><br><span class="line">+<span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line">| id | select_type | table        | type  | possible_keys                   | key        | key_len | ref  | rows | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_user_msg | index | invite_id,app_id,team_id | created_time | 5       | NULL |   10 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------------+-------+---------------------------------+------------+---------+------+------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>从执行计划可以看到，表上有单列索引 <code>invite_id,app_id,team_id,created_time</code>，走的是create_time的索引，而且type=index索引全扫描，因为create_time没有出现在where条件后，只出现在order by后面，只能是type=index，这也预示着表数据量越大该SQL越慢，我们期望是走三个单列索引 <code>invite_id，app_id，team_id</code>，然后type=index_merge操作。</p>
<p>按照常规思路，对于OR条件拆分两部分，分别进行分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> app_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>从执行计划看走的是team_id的索引，没有问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| id | select_type | table        | type | possible_keys        | key     | key_len | ref   | rows | Extra                       |</span><br><span class="line">+<span class="comment">----+-------------+--------------+------+----------------------+---------+---------+-------+------+-----------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_user_msg | ref  | app_id,team_id | team_id | 8       | const |   30 | Using where; Using filesort |</span><br></pre></td></tr></table></figure>
<p>再看另外一个sql语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span>  **(invite_id=<span class="number">12395</span> <span class="keyword">or</span> app_id=<span class="number">12395</span>)** <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>从执行计划上看，分别走的是invite_id,app_id的单列索引，同时做了index_merge合并操作，也没有问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| id | select_type | table        | type        | possible_keys           | key                     | key_len | ref  | rows | Extra                                                             |</span><br><span class="line">+<span class="comment">----+-------------+--------------+-------------+-------------------------+-------------------------+---------+------+------+-------------------------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id | invite_id,app_id | 9,9     | NULL |    2 | Using union(invite_id,app_id); Using where; Using filesort |</span><br></pre></td></tr></table></figure>
<p><strong>通过上面的分析，第一部分SQL走的执行计划走team_id索引没问题，第二部分SQL分别走invite_id,app_id索引并且index_merge也没问题，为什么两部分SQL进行OR关联之后走create_time的单列索引呢，不应该是三个单列索引的index_merge吗？</strong></p>
<p><strong>index_merge默认是在优化器选项是开启的，主要是将多个范围扫描的结果集合并成一个，可以通过变量查看。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt;select @@optimizer_switch;</span><br><span class="line">| index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,</span><br></pre></td></tr></table></figure>
<p>其他三个字段都传入的是具体的值，而且都走了相应的索引，只能怀疑app_id is not null这个条件影响了CBO对最终执行计划的选择，去掉这个条件来看执行计划，竟然走了三个单列索引且type=index_merge，那下面只要搞定<strong>app_id is not null</strong>这个条件就OK了吧。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| id | select_type | table        | type        | possible_keys                   | key                             | key_len | ref  | rows | Extra                                                                     |</span><br><span class="line">+<span class="comment">----+-------------+--------------+-------------+---------------------------------+---------------------------------+---------+------+------+---------------------------------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t_user_msg | index_merge | invite_id,app_id,teadm_id | team_id,invite_id,app_id | 8,9,9   | NULL |   32 | Using union(team_id,invite_id,app_id); Using where; Using filesort |</span><br></pre></td></tr></table></figure>
<h4 id="（3）SQL改写"><a href="#（3）SQL改写" class="headerlink" title="（3）SQL改写"></a>（3）SQL改写</h4><p>通过上面分析得知，条件 <code>app_id is not null</code> 影响了CBO的选择，下面进行改造。</p>
<h5 id="改写优化1"><a href="#改写优化1" class="headerlink" title="改写优化1"></a>改写优化1</h5><p>根据SQL开发规范改写，将OR改写成Union All方式即可，最终的SQL如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> **<span class="number">1</span> <span class="keyword">and</span> (club_id <span class="keyword">in</span> (<span class="number">5821</span>) <span class="keyword">and</span> applicant_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)**</span><br><span class="line">        **<span class="keyword">union</span> all** <span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> **<span class="number">1</span> <span class="keyword">and</span> invitee_id=<span class="string">'146737'</span>**</span><br><span class="line">        **<span class="keyword">union</span> all** <span class="keyword">select</span> <span class="keyword">id</span>, ……. <span class="keyword">from</span>  t_user_msg <span class="keyword">where</span> **<span class="number">1</span> <span class="keyword">and</span> app_id=<span class="string">'146737'</span>**</span><br><span class="line">       ) <span class="keyword">as</span> a <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>一般情况下，Java代码和SQL是分开的，SQL是配置在xml文件中，根据业务需求，除了team_id是必填，其他两个都是可选的，所以这种改写虽然能提高SQL执行效率，但不适合这种业务场景。</p>
<h5 id="改写优化2"><a href="#改写优化2" class="headerlink" title="改写优化2"></a>改写优化2</h5><p>app_id is not null 改写为<strong>IFNULL(app_id, 0) &gt;0)</strong>，最终的SQL为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,team_id,reason,<span class="keyword">status</span>,<span class="keyword">type</span>,created_time,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> **<span class="keyword">IFNULL</span>(app_id, <span class="number">0</span>) &gt;<span class="number">0</span>)**) <span class="keyword">or</span> (invite_id=<span class="number">12395</span> <span class="keyword">or</span> app_id=<span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h5 id="改写优化3"><a href="#改写优化3" class="headerlink" title="改写优化3"></a>改写优化3</h5><p>将字段app_id bigint(20) DEFAULT NULL，变更为app_id bigint(20) <strong>NOT NULL DEFAULT 0</strong>，同时更新将app_id is null的时候全部更新成0，就可以将条件app_id is not null 转换为app_id &gt; 0，最终的SQL为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,team_id,reason,<span class="keyword">status</span>,<span class="keyword">type</span>,created_at,invite_id,falg_admin,file_id <span class="keyword">from</span> t_user_msg <span class="keyword">where</span> <span class="number">1</span> <span class="keyword">and</span> (team_id <span class="keyword">in</span> (<span class="number">3212</span>) <span class="keyword">and</span> **app_id &gt; <span class="number">0</span>)**) <span class="keyword">or</span> (invite_id=<span class="number">12395</span> <span class="keyword">or</span> app_id=<span class="number">12395</span>) <span class="keyword">order</span> <span class="keyword">by</span> created_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>从执行计划看，两种改写优化方式都走三个单列索引，执行时间从2s降低至10ms，线上采用的是<strong>优化1</strong>的方式，如果一开始能遵循MySQL开发规范就就会避免问题的发生。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面介绍了SQL规范性检查，表结构检查，索引检查以及通过SQL改写来优化查询，在编写代码的过程，如果能提前做这些规范性检查，评估出自己认为理想的执行计划，然后通过explain解析出MySQL CBO的执行计划，两者做对比分析差异，弄清楚自己的选择和CBO的不同，不但能够编写高质量的SQL，同时也能清楚CBO的工作原理。</p>
<hr>
<p>参考：</p>
<p>🔗 <a href="https://mp.weixin.qq.com/s/nEmN4S9JOTVGj5IHyfNtCw" title="Title" target="_blank" rel="noopener">敖丙工作以来总结的大厂SQL调优姿势</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    林沂水
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://linyishui.top/2019091401.html" title="SQL规范和优化<整>（持续更新）">http://linyishui.top/2019091401.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    
      <div>
         ﻿<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      </div>
    
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/updating/" rel="tag"># updating</a>
          
            <a href="/tags/sql/" rel="tag"># sql</a>
          
            <a href="/tags/mysql/" rel="tag"># mysql</a>
          
            <a href="/tags/oracle/" rel="tag"># oracle</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019091301.html" rel="next" title="垃圾收集器（三）内存分配与回收策略">
                <i class="fa fa-chevron-left"></i> 垃圾收集器（三）内存分配与回收策略
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019091501.html" rel="prev" title="正则表达式 <整>">
                正则表达式 <整> <i class="fa fa-chevron-right"></i>
              </整></a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
     <div class="comments" id="comments">
       

<script src="https://utteranc.es/client.js" repo="LAILAIWA/LAILAIWA.github.io" issue-term="pathname" label="💬Comments" theme="github-light" crossorigin="anonymous" async>
</script>



     </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://pic-1258215793.cos.ap-shanghai.myqcloud.com/cover/riho_yoshioka1.jpg" alt="林沂水">
            
              <p class="site-author-name" itemprop="name">林沂水</p>
              <p class="site-description motion-element" itemprop="description">记录编程点滴，写点生活中的酸甜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">307</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/LAILAIWA" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:linyishui168@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/linyishui618" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/linyishui618" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/u/5340162234" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo.com"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          

          <div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("07/26/2018 00:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒";
}
function setzero(i) {
    if (i<10) {
        i="0" + i
    };
    return i;
}
show_date_time();
</script>  
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL规范和优化"><span class="nav-text">SQL规范和优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一节-SQL规范"><span class="nav-text">第一节 SQL规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-命名规范"><span class="nav-text">1.1 命名规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-格式规范"><span class="nav-text">1.2 格式规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-设计规范"><span class="nav-text">1.3 设计规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-语法规范"><span class="nav-text">1.4 语法规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）select-检查"><span class="nav-text">（1）select 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）from-检查"><span class="nav-text">（2）from 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）where-检查"><span class="nav-text">（3）where 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（4）group-by-检查"><span class="nav-text">（4）group by 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（5）order-by-检查"><span class="nav-text">（5）order by 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（6）limit-检查"><span class="nav-text">（6）limit 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（7）Union-检查"><span class="nav-text">（7）Union 检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（8）兼容性检查"><span class="nav-text">（8）兼容性检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-索引规范"><span class="nav-text">1.5 索引规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-索引属性"><span class="nav-text">1.5.1 索引属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-前缀索引"><span class="nav-text">1.5.1 前缀索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-3-复合索引顺序"><span class="nav-text">1.5.3 复合索引顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-4-时间列索引"><span class="nav-text">1.5.4 时间列索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二节-SQL优化"><span class="nav-text">第二节 SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-X-优化案例"><span class="nav-text">2.X 优化案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）慢查询SQL"><span class="nav-text">（1）慢查询SQL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）SQL分析"><span class="nav-text">（2）SQL分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）SQL改写"><span class="nav-text">（3）SQL改写</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#改写优化1"><span class="nav-text">改写优化1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#改写优化2"><span class="nav-text">改写优化2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#改写优化3"><span class="nav-text">改写优化3</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">林沂水</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
   

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
